[
    {
        "content": "<p>I am developing an application with the new roc compiler.  I have some type modules that call common utility functions (i.e. different type modules reusing the same common functions).  this seems to make <code>roc test</code> unhappy.  is this by design?  these are all pure functions</p>",
        "id": 571149939,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769821685
    },
    {
        "content": "<p><code>roc test</code> shouldn't be unhappy about anything... have you found a bug?</p>",
        "id": 571149997,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769821725
    },
    {
        "content": "<p>i feel like I'm Doing It Wrong, but i've tried all kinds of things.  let's say I have parse.roc with some pure functions defined, that take strings and return numbers.  then a type module like Wager, that has a parse method (or function) which calls functions defined in parse.roc (ignore capitalization issues; i have been trying all kinds of different module organizations).  what's the simplest thing that definitely should work?</p>",
        "id": 571150244,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769821909
    },
    {
        "content": "<p>the parse utility functions do things like parse_u32('1234') =&gt; U32 (let's say)    and then Wager or several other types in different modules need to call parse_u32 on different things</p>",
        "id": 571150317,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769821984
    },
    {
        "content": "<p>this \"parse utility file\" has a few objectives: includes unit tests; is importable or callable from other files; these other files should have unit tests as well.</p>",
        "id": 571150466,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769822073
    },
    {
        "content": "<p>what's good new compiler application to reference?  i have been using <code>basic-cli</code> (migrate-zig-compiler) but this is showing more platform-style organization</p>",
        "id": 571150650,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769822215
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>$ roc example_app.roc\ndbg: Ok([1])\ndbg: Ok([1, 2, 3])\ndbg: Err(NotANumber)\ndbg: Err(NotANumber)\ndbg: Ok([4, 2])\n$ roc test Parser.roc --verbose\nAll (4) tests passed in 37.1 ms.\nPASS: Parser.roc:24\nPASS: Parser.roc:25\nPASS: Parser.roc:26\nPASS: Parser.roc:27\n</code></pre></div>\n<h2>Parser.roc</h2>\n<div class=\"codehilite\"><pre><span></span><code># a Roc type module includes a single nominal type\nParser := {}.{\n\n    # this is an function associated with the Parser type\n    # e.g. &quot;12&quot; -&gt; [1,2]\n    parse_digits : Str -&gt; Try(List(U8), [NotANumber])\n    parse_digits = |str| {\n        bytes = Str.to_utf8(str)\n        bytes.fold(Ok([]), |acc, byte| {\n            match acc {\n                Err(e) =&gt; Err(e)\n                Ok(digits) =&gt; {\n                    if &#39;0&#39; &lt;= byte and byte &lt;= &#39;9&#39; {\n                        Ok(List.append(digits, byte - &#39;0&#39;))\n                    } else {\n                        Err(NotANumber)\n                    }\n                }\n            }\n        })\n    }\n}\n\nexpect Parser.parse_digits(&quot;12&quot;) == Ok([1,2])\nexpect Parser.parse_digits(&quot;abc&quot;) == Err(NotANumber)\nexpect Parser.parse_digits(&quot;123&quot;) == Ok([1,2,3])\nexpect Parser.parse_digits(&quot;1234&quot;) == Ok([1,2,3,4])\n</code></pre></div>\n<h2>example_app.roc</h2>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst&quot; }\n\nimport pf.Stdout\nimport Parser\n\nmain! = |_args| {\n    dbg Parser.parse_digits(&quot;1&quot;)\n    dbg Parser.parse_digits(&quot;123&quot;)\n    dbg Parser.parse_digits(&quot;NotADigit&quot;)\n    dbg Parser.parse_digits(&quot;0.1&quot;)\n    dbg Parser.parse_digits(&quot;42&quot;)\n    Ok({})\n}\n</code></pre></div>",
        "id": 571152054,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769823434
    },
    {
        "content": "<p>This should help!  Taking rhe dogs for a walk rn ...</p>",
        "id": 571152262,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769823627
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"780900\">Rick Hull</span> <a href=\"#narrow/channel/231634-beginners/topic/new.20compiler.3A.20.60roc.20test.60.20with.20common.20util.20functions/near/571150650\">said</a>:</p>\n<blockquote>\n<p>what's good new compiler application to reference?  i have been using <code>basic-cli</code> (migrate-zig-compiler) but this is showing more platform-style organization</p>\n</blockquote>\n<p>There isn't any examples or documentation yet -- aside from the bits and pieces in the <code>langref/</code> ... the new compiler isn't a very friendly place for beginners right now and there are unimplemented or buggy things lurking around every corner.</p>",
        "id": 571152448,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769823767
    },
    {
        "content": "<p>The more we try and build real things though we can find the issues and fix them one by one... so it's very helpful when people try things out and report any issues or questions.</p>",
        "id": 571152511,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769823820
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"515757\">@Luke Boswell</span> big help, thanks!   we (me and claude) were using [].{...}    not {}.{...}    what are the implications?</p>",
        "id": 571153544,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769824827
    },
    {
        "content": "<p>Both should work...</p>",
        "id": 571153571,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769824853
    },
    {
        "content": "<p><code>[]</code> is an empty tag union, <code>{}</code> is an empty record, both are zero sized types.</p>",
        "id": 571153626,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769824898
    },
    {
        "content": "<p>i think we found a bug, but compiler is like 10 days old; continuing to test and narrow down; will get the latest nightly</p>",
        "id": 571153806,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769825108
    },
    {
        "content": "<p>For now:</p>\n<blockquote>\n<p>The bug is precisely: inside a {}.{...} type method at comptime, once a different method<br>\n   is called on one parameter (e.g. a.to_u64()), subsequent access to the other parameter<br>\n  (b) loses scope. to_str doesn't trigger it — likely because it's the same builtin method<br>\n   called on both, so the comptime evaluator doesn't context-switch the same way.</p>\n</blockquote>\n<p>grabbing a newer compiler to retest</p>",
        "id": 571153877,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769825183
    },
    {
        "content": "<p><a href=\"https://gist.github.com/rickhull/289ef29265d182ada8accc81957fd93a\">https://gist.github.com/rickhull/289ef29265d182ada8accc81957fd93a</a> # latest roc-nightly</p>",
        "id": 571154214,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769825557
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"780900\">Rick Hull</span> <a href=\"#narrow/channel/231634-beginners/topic/new.20compiler.3A.20.60roc.20test.60.20with.20common.20util.20functions/near/571154214\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://gist.github.com/rickhull/289ef29265d182ada8accc81957fd93a\">https://gist.github.com/rickhull/289ef29265d182ada8accc81957fd93a</a> # latest roc-nightly</p>\n</blockquote>\n<p>looks like a bug to me, can you make a GH issue?</p>",
        "id": 571154499,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769825852
    },
    {
        "content": "<p>we were able to repro a segfault repeatedly, at address 0xblahblah, supposedly ASCII 'tosh'; unable to repro for now</p>",
        "id": 571155712,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769826972
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>● Bash(roc test src/ParseUtil.roc --verbose 2&gt;&amp;1)\n  ⎿  Error: Exit code 139\n\n     Segmentation fault (SIGSEGV) in the Roc compiler.\n     Fault address: 0x74736f68\n\n     Please report this issue at: https://github.com/roc-lang/roc/issues\n\n● THERE IT IS! The segfault! When Value.parse_sexp (a type method) calls tokenize (a\n  module-level function with fold) at comptime IN THE SAME FILE, it segfaults!\n\n  But wait - spike/Value.roc works with the exact same structure. Let me compare the two\n  more carefully:\n</code></pre></div>\n<div class=\"codehilite\"><pre><span></span><code>● This is a deep compiler bug. For now, we have a working version in spike/Value.roc and\n  the copy in ParseUtil_minimal.roc. The full ParseUtil.roc segfaults for reasons we\n  haven&#39;t identified yet.\n\n  Summary for you: We&#39;ve hit a Roc compiler bug that causes segfaults when type methods\n  call module-level functions at comptime. We&#39;ve identified that fold-based tokenize works\n   (avoiding for/var), but there&#39;s still a segfault in the full ParseUtil that doesn&#39;t\n  occur in the minimal spike/Value.roc version. We have working code we can build from,\n  but debugging the compiler bug itself would require more investigation.\n</code></pre></div>",
        "id": 571155893,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769827203
    },
    {
        "content": "<p>it looks like there are 3 bugs, and initial suspicion is that they are all specific to <code>roc test</code></p>",
        "id": 571156788,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769828328
    },
    {
        "content": "<p>If you log a GH issue with the files to minimally reproduce, that would be helpful.</p>",
        "id": 571156849,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769828396
    },
    {
        "content": "<p>It should be easy enough to fix I think. I'm looking at some other bugs rn</p>",
        "id": 571156869,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769828417
    },
    {
        "content": "<p><code>roc test</code> hasn't had any love in months</p>",
        "id": 571156898,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769828441
    },
    {
        "content": "<p>It hasn't been upgraded to use the new coordinator, so that could be related here</p>",
        "id": 571156946,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769828483
    },
    {
        "content": "<p>Questions about the single-nominal-type-per-file syntax:</p>\n<ol>\n<li>Is it fair to treat <code>Builtin.roc</code> as sort of a bible for this pattern, other than the special <code>ProvidedByCompiler</code> constructor?</li>\n<li>Are multiple top-level type declarations (or nominal type declarations) intended to be a compile error now?</li>\n</ol>",
        "id": 571158232,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1769830005
    },
    {
        "content": "<p>I'm wondering if a windows-specific bug I'm running into working on the glue command is actually a case of 2 not being treated as a compile error when it should be an error.</p>",
        "id": 571158292,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1769830046
    },
    {
        "content": "<p>I recently added the error for not having a top level nominal type... I dont think I added one for multiple top level nominal types.</p>",
        "id": 571158801,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769830652
    },
    {
        "content": "<p>It should be an error</p>",
        "id": 571158813,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769830666
    },
    {
        "content": "<p>I would say Builtin.roc is probable the best example, aside from the annotation only parts the compiler implements internally</p>",
        "id": 571158838,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769830695
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/issues/9117\">https://github.com/roc-lang/roc/issues/9117</a><br>\n<a href=\"https://github.com/roc-lang/roc/issues/9118\">https://github.com/roc-lang/roc/issues/9118</a><br>\n<a href=\"https://github.com/roc-lang/roc/issues/9119\">https://github.com/roc-lang/roc/issues/9119</a></p>",
        "id": 571159167,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769831021
    },
    {
        "content": "<p>For reference type modules should be named with an uppercase, like <code>Bug3.roc</code> not <code>bug3.roc</code> -- and match the name of the type they exposing</p>",
        "id": 571159262,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769831143
    },
    {
        "content": "<p>See <a href=\"https://github.com/roc-lang/roc/blob/main/langref/modules.md\">https://github.com/roc-lang/roc/blob/main/langref/modules.md</a></p>",
        "id": 571159288,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769831180
    },
    {
        "content": "<p>this was just iterating on getting a minimal repro, not necessarily realistic; would it matter here?</p>",
        "id": 571159329,
        "sender_full_name": "Rick Hull",
        "timestamp": 1769831236
    },
    {
        "content": "<p>The compiler shouldn't segfault, and should give helpful error messages... so if we find any situation where it doesn't that's a bug</p>",
        "id": 571159370,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769831288
    },
    {
        "content": "<p>I thought I'd mention that in case it unblocks you</p>",
        "id": 571159403,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1769831312
    },
    {
        "content": "<p>I'm not sure how I would go about reproducing it, but without the error for multiple type declarations in a file, we get fun stack corruption on windows. Might be worth figuring out how to avoid that even if we won't hit this specific case any more.</p>",
        "id": 571160690,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1769832412
    }
]
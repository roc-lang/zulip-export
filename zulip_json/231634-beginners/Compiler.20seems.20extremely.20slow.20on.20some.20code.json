[
    {
        "content": "<p>The following <code>main.roc</code> code takes forever to compile, using all my CPU. It's been running for well over 10 minutes, I don't understand why. I tried removing almost everything and adding one piece at a time, and it just gets slower and slower. So I'm guessing the full code will eventually finish compiling one day, but perhaps not today. Any idea what's going on? Sorry if the code is really ugly, I'm a pebble (=a little Roc newbie).</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">app</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nv\">main</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nv\">cli</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"nv\">platform</span><span class=\"w\"> </span><span class=\"s\">\"https://github.com/roc-lang/basic-cli/releases/download/0.12.0/Lb8EgiejTUzbggO2HVVuPJFkwvvsfW6LojkLR20kTVE.tar.br\"</span><span class=\"w\"> </span><span class=\"p\">}</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">cli.Stdout</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">cli.Task</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">cli.Arg</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">cli.File</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">cli.Utc</span>\n\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day01</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day02</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day03</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day04</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day05</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day06</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day07</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day08</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day09</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day10</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day11</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day12</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day13</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day14</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day15</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day16</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day17</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day18</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day19</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day20</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day21</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day22</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day23</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day24</span>\n<span class=\"kn\">import</span><span class=\"w\"> </span><span class=\"nc\">Day25</span>\n\n<span class=\"nv\">dataPath</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"s\">\"data/day$(if day &lt; 10 then \"</span><span class=\"mi\">0</span><span class=\"s\">\" else \"\")$(Num.toStr day).txt\"</span>\n\n<span class=\"nv\">loadData</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"nv\">dataPath</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">File</span><span class=\"nf\">.</span><span class=\"nv\">readUtf8</span><span class=\"err\">!</span>\n\n<span class=\"nv\">solutions</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day01</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day01</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day02</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day02</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day03</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day03</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day04</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day04</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day05</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day05</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day06</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day06</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day07</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day07</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day08</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day08</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day09</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day09</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day10</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day10</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day11</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day11</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day12</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day12</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day13</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day13</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day14</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day14</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day15</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day15</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day16</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day16</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day17</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day17</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day18</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day18</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day19</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day19</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day20</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day20</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day21</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day21</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day22</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day22</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day23</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day23</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day24</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day24</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"kt\">Day25</span><span class=\"nf\">.</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Day25</span><span class=\"nf\">.</span><span class=\"nv\">part2</span><span class=\"p\">),</span>\n<span class=\"p\">]</span>\n\n<span class=\"nv\">runSolution</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">solution</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">index</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">input</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"s\">\"Part $(Num.toStr index):\"</span>\n<span class=\"w\">    </span><span class=\"nv\">startTime</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"kt\">Utc</span><span class=\"nf\">.</span><span class=\"nv\">now</span><span class=\"err\">!</span>\n<span class=\"w\">    </span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nv\">solution</span><span class=\"w\"> </span><span class=\"nv\">input</span>\n<span class=\"w\">    </span><span class=\"nv\">endTime</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"kt\">Utc</span><span class=\"nf\">.</span><span class=\"nv\">now</span><span class=\"err\">!</span>\n<span class=\"w\">    </span><span class=\"nv\">delta</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"kt\">Utc</span><span class=\"nf\">.</span><span class=\"nv\">deltaAsMillis</span><span class=\"w\"> </span><span class=\"nv\">startTime</span><span class=\"w\"> </span><span class=\"nv\">endTime</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Num</span><span class=\"nf\">.</span><span class=\"nv\">toStr</span>\n<span class=\"w\">    </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"s\">\"$(result) ($(delta)ms)\"</span>\n\n<span class=\"nv\">checkDay</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"nf\">||</span><span class=\"w\"> </span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"w\"> </span><span class=\"kr\">then</span><span class=\"w\"> </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">err</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">InvalidDay</span><span class=\"w\"> </span><span class=\"s\">\"Must be between 1 and 25\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kr\">else</span><span class=\"w\"> </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">ok</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n\n<span class=\"nv\">runDay</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">dayArg</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"kt\">Str</span><span class=\"nf\">.</span><span class=\"nv\">toU64</span><span class=\"w\"> </span><span class=\"nv\">dayArg</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">fromResult</span><span class=\"err\">!</span>\n<span class=\"w\">    </span><span class=\"nv\">checkDay</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nv\">day</span>\n<span class=\"w\">    </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"s\">\"Day $(Num.toStr day)\"</span>\n<span class=\"w\">    </span><span class=\"nv\">input</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nv\">loadData</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nv\">day</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">part2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">get</span><span class=\"w\"> </span><span class=\"nv\">solutions</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">day</span><span class=\"w\"> </span><span class=\"nf\">-</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">fromResult</span><span class=\"err\">!</span>\n<span class=\"w\">    </span><span class=\"nv\">runSolution</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nv\">part1</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"nv\">input</span>\n<span class=\"w\">    </span><span class=\"nv\">runSolution</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nv\">part2</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"nv\">input</span>\n\n<span class=\"kr\">main </span><span class=\"nf\">=</span>\n<span class=\"w\">    </span><span class=\"nv\">args</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"kt\">Arg</span><span class=\"nf\">.</span><span class=\"nv\">list</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"w\">    </span><span class=\"nv\">daysStr</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">len</span><span class=\"w\"> </span><span class=\"nv\">args</span><span class=\"w\"> </span><span class=\"nf\">&lt;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"kr\">then</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">range</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nv\">start</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"kt\">At</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">end</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"kt\">At</span><span class=\"w\"> </span><span class=\"mi\">25</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">map</span><span class=\"w\"> </span><span class=\"kt\">Num</span><span class=\"nf\">.</span><span class=\"nv\">toStr</span><span class=\"w\"> </span><span class=\"kr\">else</span><span class=\"w\"> </span><span class=\"nv\">args</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">dropFirst</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nv\">daysStr</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">map</span><span class=\"w\"> </span><span class=\"nv\">runDay</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">reverse</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">sequence</span><span class=\"err\">!</span>\n<span class=\"w\">    </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">ok</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n</code></pre></div>\n<p>Every <code>DayXX.roc</code> file contains the same thing:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"kn\">module</span><span class=\"w\"> </span><span class=\"err\">[</span><span class=\"nc\">part1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">part2</span><span class=\"p\">]</span>\n<span class=\"nv\">part1</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">input</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"s\">\"Part 1 not implemented\"</span>\n<span class=\"nv\">part2</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">input</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"s\">\"Part 2 not implemented\"</span>\n</code></pre></div>",
        "id": 454798716,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722251493
    },
    {
        "content": "<p>Are you importing/ingesting file bytes? i.e. like this <a href=\"https://www.roc-lang.org/examples/IngestFiles/README.html\">https://www.roc-lang.org/examples/IngestFiles/README.html</a></p>",
        "id": 454799428,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722251604
    },
    {
        "content": "<p>We have a known LLVM bug that makes that ultra slow -- here is the PR to fix <a href=\"https://github.com/roc-lang/roc/pull/6832\">https://github.com/roc-lang/roc/pull/6832</a></p>",
        "id": 454799539,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722251623
    },
    {
        "content": "<p>Ah thanks, yes my code does contain<code>File.readUtf8!</code>, is that what you mean?</p>",
        "id": 454799769,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722251656
    },
    {
        "content": "<p>No, <code>File.readUtf8</code> should be fine</p>",
        "id": 454799910,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722251680
    },
    {
        "content": "<p>My code also uses <code>Utc.now!</code>, maybe that's related?</p>",
        "id": 454800160,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722251718
    },
    {
        "content": "<blockquote>\n<p>I'm a pebble (=a little Roc newbie) </p>\n</blockquote>\n<p>I love this, <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 454800577,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722251816
    },
    {
        "content": "<p>Basically the code takes some days as command line arguments (e.g., <code>roc main.roc 1 2 3</code>), and for each day it loads the corresponding <code>data/dayXX.txt</code> file, and it runs DayXX.part1 and DayXX.part2, times them, and prints the results along with the times.</p>",
        "id": 454800756,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722251879
    },
    {
        "content": "<p>I'm not seeing anything that looks obviously wrong</p>",
        "id": 454801101,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722251972
    },
    {
        "content": "<p>So the I/O operations involved are <code>Arg.list</code>, <code>Stdout.line</code>, <code>Utc.now</code>, and <code>File.readUtf8</code>.</p>",
        "id": 454801378,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722252041
    },
    {
        "content": "<p>I suspect we have a bug somewhere related to composing a lot of Tasks in a program</p>",
        "id": 454801492,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252085
    },
    {
        "content": "<p>Like we a hitting an edge case or something that is blowing up the code gen</p>",
        "id": 454801560,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252114
    },
    {
        "content": "<p>It could maybe be related to all  the refcounting and other fixes that Brendan fixed recently. All available on the TESTING nightly and basic-cli 0.13.0 if you would like to test that</p>",
        "id": 454801757,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252172
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/stream/231634-beginners/topic/Compiler.20seems.20extremely.20slow.20on.20some.20code/near/454801101\">said</a>:</p>\n<blockquote>\n<p>I'm not seeing anything that looks obviously wrong</p>\n</blockquote>\n<p>If you want to test this, you can remove all the <code>import DayXX</code>, and replace the definition of <code>solutions</code> with this:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">solutions</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nf\">\\</span><span class=\"nv\">i</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nv\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">i</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nv\">i</span><span class=\"p\">),</span>\n<span class=\"p\">]</span>\n</code></pre></div>\n<p>Then run <code>roc main.roc 1</code></p>\n<p>For me, it's still super slow.</p>",
        "id": 454801786,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722252184
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/stream/231634-beginners/topic/Compiler.20seems.20extremely.20slow.20on.20some.20code/near/454801757\">said</a>:</p>\n<blockquote>\n<p>It could maybe be related to all  the refcounting and other fixes that Brendan fixed recently. All available on the TESTING nightly and basic-cli 0.13.0 if you would like to test that</p>\n</blockquote>\n<p>Ah yes, thanks, I'll give this a shot.</p>",
        "id": 454801886,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722252213
    },
    {
        "content": "<p>Ah, ok... so if you run <code>roc check</code> you will see there are issues</p>",
        "id": 454802163,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252278
    },
    {
        "content": "<p>check exits earlier in the compiler pipeline so its giving us the problem reports, whereras build is getting stuck trying to resolve stuff that is definitely broken.</p>",
        "id": 454802351,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252332
    },
    {
        "content": "<p>I think you just need to add an <code>import cli.Task exposing [Task]</code> and that will fix your issue here</p>",
        "id": 454802449,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252355
    },
    {
        "content": "<p>Or maybe not...</p>",
        "id": 454802658,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252407
    },
    {
        "content": "<p>The only issues reported by <code>roc check</code> were warnings about the fact that <code>part1 = \\input -&gt; \"not implemented\"</code> does not use the variable <code>input</code>. I replaced this with <code>part1 = \\_ -&gt; \"not implemented\"</code> and now <code>roc check</code> gives me no warning or errors.</p>",
        "id": 454802916,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722252454
    },
    {
        "content": "<p>I'm using <code>roc nightly pre-release, built from commit 070d14a on Sat Jul 13 09:01:57 UTC 2024</code></p>",
        "id": 454802998,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722252472
    },
    {
        "content": "<p>I also tried to change the import as you said, but it didn't fix the issue. I'll try basic-cli 0.13, as you suggested (probably tomorrow because it's pretty late here in Auckland). Cheers!</p>",
        "id": 454803378,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722252596
    },
    {
        "content": "<p>So this kind of issue isn't totally uncommon. I find it's almost always trying to do some kind of alias or type analysis on broken code and stuck in a loop. So I find going through and adding type annotations to \"pin\" the types can help the compiler tell me where the issue is</p>",
        "id": 454803614,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722252659
    },
    {
        "content": "<p>Yeah, so there's definitely a bug in here somewhere related to composition of Tasks. It may be related to unifying error tags, or the way we are desugaring the <code>!</code>, or some other bug. I spent a while trying to minify it, but haven't been able to isolate it.</p>\n<p>This is what I was using... basically just added type annotations. </p>\n<div class=\"codehilite\"><pre><span></span><code>app [main] { cli: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/0.13.0/nW9yMRtZuCYf1Oa9vbE5XoirMwzLbtoSgv7NGhUlqYA.tar.br&quot; }\n\nimport cli.Stdout\nimport cli.Task\nimport cli.Arg\nimport cli.File\nimport cli.Utc\nimport cli.Task exposing [Task]\n\ndataPath : U64 -&gt; Str\ndataPath = \\day -&gt;\n    &quot;data/day$(if day &lt; 10 then &quot;0&quot; else &quot;&quot;)$(Num.toStr day).txt&quot;\n\nloadData : U64 -&gt; Task Str _\nloadData = \\day -&gt;\n    day\n    |&gt; dataPath\n    |&gt; File.readUtf8\n    |&gt; Task.mapErr UnableToReadFile\n\nsolutions : List (Str -&gt; Str, Str -&gt; Str)\nsolutions = [\n    (\\i -&gt; i,\\i -&gt; i),\n]\n\nrunSolution : (Str -&gt; Str), U64, Str -&gt; Task {} []_\nrunSolution = \\solution, index, input -&gt;\n    Stdout.line! &quot;Part $(Num.toStr index):&quot;\n    startTime = Utc.now!\n    result = solution input\n    endTime = Utc.now!\n    delta = Utc.deltaAsMillis startTime endTime |&gt; Num.toStr\n    Stdout.line! &quot;$(result) ($(delta)ms)&quot;\n\ncheckDay : U64 -&gt; Task {} [InvalidDay Str]_\ncheckDay = \\day -&gt;\n    if day &lt; 1 || day &gt; 25 then Task.err (InvalidDay &quot;Must be between 1 and 25&quot;) else Task.ok {}\n\nrunDay : Str -&gt; Task {} []_\nrunDay = \\dayArg -&gt;\n    day = Str.toU64 dayArg |&gt; Task.fromResult!\n    checkDay! day\n    Stdout.line! &quot;Day $(Num.toStr day)&quot;\n    input = loadData! day\n    (part1, part2) = List.get solutions (day - 1) |&gt; Task.fromResult!\n    runSolution! part1 1 input\n    runSolution! part2 2 input\n\nmain =\n    args = Arg.list! {}\n    daysStr = if List.len args &lt; 2 then List.range { start: At 1, end: At 25 } |&gt; List.map Num.toStr else args |&gt; List.dropFirst 1\n    _ = daysStr |&gt; List.map runDay |&gt; List.reverse |&gt; Task.sequence!\n    Task.ok {}\n</code></pre></div>",
        "id": 454811693,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722254130
    },
    {
        "content": "<p>Just to clarify this, no matter the result of any extra analysis done here, this is definitely a compiler bug as well.</p>",
        "id": 454873417,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1722268395
    },
    {
        "content": "<p>I'm not sure I found the root of the problem... but I certainly a fix. </p>\n<p>I suspected the <code>Task.sequence</code> as I haven't really seen that used much. </p>\n<p>I applied <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span>'s <code>Task.loop</code> implementation on the Task as builtin branch and this runs really nicely.</p>",
        "id": 455056047,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722325609
    },
    {
        "content": "<p>I'll see if the same fix also works with current basic-cli.</p>\n<p>I'm not sure we want to make another intermediate release, I think I'd rather just upgrade to builtin-task.</p>",
        "id": 455056302,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722325723
    },
    {
        "content": "<p>Yes also works on basic-cli</p>",
        "id": 455057111,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722326035
    },
    {
        "content": "<p>Here is a draft PR with the fix <a href=\"https://github.com/roc-lang/basic-cli/pull/236\">https://github.com/roc-lang/basic-cli/pull/236</a></p>",
        "id": 455057650,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722326244
    },
    {
        "content": "<p>If anyone would like this, you can build from source by cloning basic-cli on that branch, and then just <code>roc build.roc</code> will do the rest. Just remember to reference the platform using a local relative path instead of a URL.</p>",
        "id": 455057822,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722326310
    },
    {
        "content": "<p>I just tested, it works fine indeed, thanks again. Note, I did not have to compile from source, I just copied the definition of <code>sequence</code> from the PR into my file and used that instead of <code>Task.sequence</code>. In case anyone else wants to go that route:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">sequence</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">taskList</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">loop</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">taskList</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">withCapacity</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">len</span><span class=\"w\"> </span><span class=\"nv\">taskList</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"p\">(</span><span class=\"nv\">tasks</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">values</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">        </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">tasks</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">            </span><span class=\"p\">[</span><span class=\"nv\">task</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nf\">..</span><span class=\"w\"> </span><span class=\"kr\">as</span><span class=\"w\"> </span><span class=\"nv\">rest</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">                </span><span class=\"nv\">value</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nv\">task</span><span class=\"err\">!</span>\n<span class=\"w\">                </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">ok</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">Step</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">rest</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"nf\">.</span><span class=\"nv\">append</span><span class=\"w\"> </span><span class=\"nv\">values</span><span class=\"w\"> </span><span class=\"nv\">value</span><span class=\"p\">))</span>\n\n<span class=\"w\">            </span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">                </span><span class=\"kt\">Task</span><span class=\"nf\">.</span><span class=\"nv\">ok</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">Done</span><span class=\"w\"> </span><span class=\"nv\">values</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 455059368,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722326697
    },
    {
        "content": "<p>Oh nice. Was that modifying the version in your cache?</p>",
        "id": 455059629,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722326748
    },
    {
        "content": "<p>I'm sorry, I'm not sure I understand your question. What is the cache you are referring to? I only edited <code>main.roc</code> and added the <code>sequence</code> def there. I had to revert to basic-cli 0.12 because I was getting this error with 0.13:</p>\n<div class=\"codehilite\"><pre><span></span><code>roc_app_binary(18551,0x7ff844aa6fc0) malloc: *** error for object 0x7fb44c905b78: pointer being freed was not allocated\nroc_app_binary(18551,0x7ff844aa6fc0) malloc: *** set a breakpoint in malloc_error_break to debug\n</code></pre></div>",
        "id": 455064958,
        "sender_full_name": "Aurélien Geron",
        "timestamp": 1722328282
    },
    {
        "content": "<p>Oh ok. That also works too. </p>\n<p>I was talking about editing the platform implementation in the downloaded files. When you use a URL package roc downloads and put the .roc files into your .cache folder. So, you might also be able to patch it there. I think the check against files hashing correctly is only at the time when it's first downloaded and put in .cache</p>",
        "id": 455067593,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722328897
    }
]
[
    {
        "content": "<p>Like many others, I'm back for AOC after a while of not using roc. I'm going through Richard's gist:</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] {\n    cli: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.1-test/7iDKk44no3gF9Nrh2VyF8Y5yvy1jUBhrbhHURN1WQptB.tar.zst&quot;\n}\n\nimport cli.Stdout\n\nmain! = |_| {\n    Stdout.line!(&quot;Hello, World!&quot;)\n    Ok({})\n}\n</code></pre></div>\n<p>I get the following error:</p>\n<div class=\"codehilite\"><pre><span></span><code>error: Failed to extract platform spec from app file: error.NotAppFile\n</code></pre></div>\n<p>Does anyone have the same issue? Or am I doing something wrong?</p>",
        "id": 561034202,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764538093
    },
    {
        "content": "<p>Are you running roc built from source? <code>zig build roc</code>?</p>",
        "id": 561034415,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764538284
    },
    {
        "content": "<p>No, latest release: <code>Roc compiler version release-fast-77e8bbc1\n</code></p>",
        "id": 561034457,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764538326
    },
    {
        "content": "<p>I just built from source: <code>Roc compiler version debug-2ac12ee6</code>. Still happening there unfortunately. What is weird is that it worked before. I then made some change (idk what exactly anymore) which would be a compiler error, but instead gave the error above. But after undoing the change, the above error stays. Is there some caching in place in a config or shared folder anywhere?</p>",
        "id": 561251736,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764615565
    },
    {
        "content": "<p>On what OS are you?</p>",
        "id": 561253002,
        "sender_full_name": "Anton",
        "timestamp": 1764615995
    },
    {
        "content": "<p>MacOS arm64</p>",
        "id": 561253131,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764616033
    },
    {
        "content": "<p>I'm able to reproduce it</p>",
        "id": 561254071,
        "sender_full_name": "Anton",
        "timestamp": 1764616348
    },
    {
        "content": "<p>Ah good first news! Not just my laptop being weird then. Hope the example helps with debugging the compiler!<br>\nIn the meantime, do you have a workaround?</p>",
        "id": 561254911,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764616605
    },
    {
        "content": "<p>Yes, use roc build from source (zig build roc) and this roc source code:</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.1-test/7iDKk44no3gF9Nrh2VyF8Y5yvy1jUBhrbhHURN1WQptB.tar.zst&quot; }\n\nimport pf.Stdout\n\nmain! : List(Str) =&gt; Try({}, [Exit(I32)])\nmain! = |_args| {\n    Stdout.line!(&quot;Hello Roc!&quot;)\n\n    Ok({})\n}\n</code></pre></div>",
        "id": 561255155,
        "sender_full_name": "Anton",
        "timestamp": 1764616670
    },
    {
        "content": "<p>It seems like the header being multiline caused the issue</p>",
        "id": 561255778,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764616852
    },
    {
        "content": "<p>Thanks for helping out!</p>",
        "id": 561255821,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764616866
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"497765\">Kilian Vounckx</span> <a href=\"#narrow/channel/231634-beginners/topic/New.20Compiler.3A.20error.3F/near/561255778\">said</a>:</p>\n<blockquote>\n<p>It seems like the header being multiline caused the issue</p>\n</blockquote>\n<p>Can you make a github issue for that?</p>",
        "id": 561256423,
        "sender_full_name": "Anton",
        "timestamp": 1764617062
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/issues/8533\">Done</a>!</p>",
        "id": 561256944,
        "sender_full_name": "Kilian Vounckx",
        "timestamp": 1764617233
    },
    {
        "content": "<blockquote>\n<p>Is there some caching in place in a config or shared folder anywhere?</p>\n</blockquote>\n<p>Yes, there is a roc cache -- when you first run an app, the roc cli links the pre-built host library from the platform with an interpreter shim into an executable and caches that. From then on whenever you \"run\" a roc app that uses the same platform you will be using a cached executable -- and just the Roc app parts will be recompiled and then interpreted.</p>",
        "id": 561266565,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764620473
    },
    {
        "content": "<p>There is a <code>--no-cache</code> flag you can give roc to not use the cache and force a re-link of that interpreted host.</p>",
        "id": 561266714,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764620530
    },
    {
        "content": "<p>Hi, I was also playing around with the the Roc compiler built from source (<code>Roc compiler version debug-3df2aab6</code>). I was following Richard's gist and tried this program:</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.1-test/7iDKk44no3gF9Nrh2VyF8Y5yvy1jUBhrbhHURN1WQptB.tar.zst&quot; }\n\nimport pf.Stdout\nimport pf.Stdin\n\nmain! = |_args| {\n    Stdout.line!(&quot;What&#39;s your name?&quot;)\n    name = Stdin.line!()\n    Stdout.line!(&quot;Hello, ${name}!&quot;)\n}\n</code></pre></div>\n<p>Doing so gave this:</p>\n<div class=\"codehilite\"><pre><span></span><code>-- TYPE MISMATCH ---------------------------------\n\nThis expression is used in an unexpected way:\n  ┌─ main.roc:6:1\n  │\n6 │ main! = |_args| {\n  │ ^^^^^\n\nIt has the type:\n    List(Str) =&gt; {  }\n\nBut the type annotation says it should have the type:\n    List(Str) =&gt; Try({  }, [Exit(I32)])\n\nFound 1 error(s) and 0 warning(s) for main.roc.\nWhat&#39;s your name?\nYanni\nHello, Yanni!\n\nRoc crashed: Error evaluating from shared memory: TypeMismatch\n</code></pre></div>\n<p>So I added <code>Ok({})</code> at the end of <code>main!</code> and the error disappeared but I am now seeing this and I am not sure if its expected:</p>\n<div class=\"codehilite\"><pre><span></span><code>What&#39;s your name?\nYanni\nHello, Yanni!\nerror(gpa): memory address 0x105820000 leaked:\nUnable to print stack trace: Unable to open debug info: MissingDebugInfo\n</code></pre></div>\n<p>(The status code is okay) - is this due to how I am building the compiler? Though I saw something similar with the release of the new compiler</p>",
        "id": 561535123,
        "sender_full_name": "Yanni Papandreou",
        "timestamp": 1764716058
    },
    {
        "content": "<p>I suspect this is fixed in <a href=\"https://github.com/lukewilliamboswell/roc-platform-template-zig/pull/13\">https://github.com/lukewilliamboswell/roc-platform-template-zig/pull/13</a></p>",
        "id": 561535820,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764716411
    },
    {
        "content": "<p>That looks like a memory leak in the platform host</p>",
        "id": 561535847,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764716426
    },
    {
        "content": "<p>If you are open to building the platform from source and testing to confirm, that would be amazing</p>",
        "id": 561535970,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764716479
    },
    {
        "content": "<p>Happy to try this out - I'm a bit new to Roc so not sure the workflow for building a platform from source? I have cloned the roc repo and can build the compiler using the nix devshell. I see instructions here <a href=\"https://github.com/lukewilliamboswell/roc-platform-template-zig/tree/main\">https://github.com/lukewilliamboswell/roc-platform-template-zig/tree/main</a> for building the platform - I'm guessing I should get the latest from the PR branch, build then somehow use this in the program above instead?</p>",
        "id": 561537134,
        "sender_full_name": "Yanni Papandreou",
        "timestamp": 1764717088
    },
    {
        "content": "<p>I just marged that PR so from main branch should be fine</p>",
        "id": 561537289,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764717165
    },
    {
        "content": "<p>To build it just use <code>zig build native</code> -- <code>zig build</code> will also work but that will also build all the cross-compiled objects which you dont need</p>",
        "id": 561537343,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764717195
    },
    {
        "content": "<p>I probably need to update that URL</p>",
        "id": 561537353,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764717201
    },
    {
        "content": "<p>Then in your app you can use a relative path to the platform/main.roc file instead of a URL</p>",
        "id": 561537393,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764717221
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281383\">@Richard Feldman</span> I haven't made a new build/release yet -- I can do that now</p>",
        "id": 561537409,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764717234
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"515757\">@Luke Boswell</span> thanks - will try now :)</p>",
        "id": 561537786,
        "sender_full_name": "Yanni Papandreou",
        "timestamp": 1764717365
    },
    {
        "content": "<p>Give me 2secs I'll have a URL for you instead of needing to build from source</p>",
        "id": 561537998,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764717501
    },
    {
        "content": "<p>Give this a try</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.2/2q3DaiQx3nYLwKbwwVbPrBeRhbxrWuYZxnPpYfJrdQJF.tar.zst&quot; }\n</code></pre></div>",
        "id": 561538199,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764717615
    },
    {
        "content": "<p>Thanks Luke, using that I see:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ ./zig-out/bin/roc --no-cache main.roc\nWhat&#39;s your name?\nYanni\nHello, Yanni!\nerror(gpa): memory address 0x103940000 leaked:\nUnable to print stack trace: Unable to open debug info: MissingDebugInfo\n\nerror: Memory leak detected!\n</code></pre></div>\n<p>for reference this is the program:</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.2/2q3DaiQx3nYLwKbwwVbPrBeRhbxrWuYZxnPpYfJrdQJF.tar.zst&quot; }\n\nimport pf.Stdout\nimport pf.Stdin\n\nmain! = |_args| {\n    Stdout.line!(&quot;What&#39;s your name?&quot;)\n    name = Stdin.line!()\n    Stdout.line!(&quot;Hello, ${name}!&quot;)\n    Ok({})\n}\n</code></pre></div>\n<p>so the error message changed a bit and I get an status code of 1 instead of 0..</p>",
        "id": 561538747,
        "sender_full_name": "Yanni Papandreou",
        "timestamp": 1764717889
    },
    {
        "content": "<p>ok great, I can reproduce the leak! I'll look into it</p>",
        "id": 561538879,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764717957
    },
    {
        "content": "<p>thanks Luke!</p>",
        "id": 561538908,
        "sender_full_name": "Yanni Papandreou",
        "timestamp": 1764717978
    },
    {
        "content": "<p>I'm in the middle of a big refactor rn, but should be able to look at it in a few hours</p>",
        "id": 561539072,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764718072
    },
    {
        "content": "<p>Thanks, no rush at all!</p>",
        "id": 561539648,
        "sender_full_name": "Yanni Papandreou",
        "timestamp": 1764718392
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"931804\">Yanni Papandreou</span> <a href=\"#narrow/channel/231634-beginners/topic/New.20Compiler.3A.20error.3F/near/561538747\">said</a>:</p>\n<blockquote>\n<p>Thanks Luke, using that I see:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ ./zig-out/bin/roc --no-cache main.roc\nWhat&#39;s your name?\nYanni\nHello, Yanni!\nerror(gpa): memory address 0x103940000 leaked:\nUnable to print stack trace: Unable to open debug info: MissingDebugInfo\n\nerror: Memory leak detected!\n</code></pre></div>\n<p>for reference this is the program:</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.2/2q3DaiQx3nYLwKbwwVbPrBeRhbxrWuYZxnPpYfJrdQJF.tar.zst&quot; }\n\nimport pf.Stdout\nimport pf.Stdin\n\nmain! = |_args| {\n    Stdout.line!(&quot;What&#39;s your name?&quot;)\n    name = Stdin.line!()\n    Stdout.line!(&quot;Hello, ${name}!&quot;)\n    Ok({})\n}\n</code></pre></div>\n<p>so the error message changed a bit and I get an status code of 1 instead of 0..</p>\n</blockquote>\n<p>New release with the fix for this</p>\n<p><a href=\"https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/tag/0.3\">https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/tag/0.3</a></p>\n<p><span class=\"user-mention\" data-user-id=\"281383\">@Richard Feldman</span> if you wanted to update your URL in the notes</p>",
        "id": 561543797,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764721131
    },
    {
        "content": "<p>thanks - url updated!</p>",
        "id": 561548180,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764724704
    }
]
[
    {
        "content": "<p>Are there some ambitions (or maybe even examples) to allow writing single page web apps in Roc? I suppose since it aims at the low-level platforms, this would require compiling to WASM and some JS-based interop to manipulate the DOM.</p>",
        "id": 484177872,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732480129
    },
    {
        "content": "<p>There is an example WIP virtual dom implementation at <a href=\"https://github.com/roc-lang/roc/tree/main/examples/virtual-dom-wip\"><code>examples/virtual-dom-wip</code> but</a> that <span class=\"user-mention\" data-user-id=\"431893\">@Brian Carroll</span> was working on. That work was blocked due to some type analysis issues in the compiler. Roc has evolved a lot since then, and maybe this project could continue now I'm not sure. </p>\n<p>I think it would definitely be feasible to do client side SPAs using roc.</p>",
        "id": 484179184,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732481447
    },
    {
        "content": "<p>Perfect! Thanks, I'll take a look at that and prospectively help.</p>",
        "id": 484242773,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732525760
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"782019\">Antonin Komenda</span> has marked this topic as resolved.</p>",
        "id": 484242809,
        "sender_full_name": "Notification Bot",
        "timestamp": 1732525772
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"782019\">Antonin Komenda</span> has marked this topic as unresolved.</p>",
        "id": 484363415,
        "sender_full_name": "Notification Bot",
        "timestamp": 1732558404
    },
    {
        "content": "<p>I've tried to compile <a href=\"https://github.com/lukewilliamboswell/roc-experiment-js-dom\">https://github.com/lukewilliamboswell/roc-experiment-js-dom</a>. The example with writing to the console works nicely. The inner_html example, however, throws a pretty cryptic error during compilation:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ RUST_BACKTRACE=full roc build --target wasm32 --no-link --output app.o examples/inner_html.roc\nthread &#39;main&#39; panicked at crates/compiler/gen_llvm/src/llvm/build.rs:5748:19:\nError in alias analysis: error in module ModName(&quot;UserApp&quot;), function definition FuncName(&quot;\\x11\\x00\\x00\\x00\\x00\\x00\\x00\\x80\\\\\\x85\\xd0w0\\xa31\\x8e&quot;), definition of value binding ValueId(16): expected type &#39;union { (((), (heap_cell,)),), ((),) }&#39;, found type &#39;()&#39;\nstack backtrace:\n   0:     0x57c016b90c2b - &lt;unknown&gt;\n   1:     0x57c015e13980 - &lt;unknown&gt;\n   2:     0x57c016b8c493 - &lt;unknown&gt;\n   3:     0x57c016b909c4 - &lt;unknown&gt;\n   4:     0x57c016b92520 - &lt;unknown&gt;\n   5:     0x57c016b9223f - &lt;unknown&gt;\n   6:     0x57c016b92a3e - &lt;unknown&gt;\n   7:     0x57c016b92942 - &lt;unknown&gt;\n   8:     0x57c016b91126 - &lt;unknown&gt;\n   9:     0x57c016b926a4 - &lt;unknown&gt;\n  10:     0x57c015d08e75 - &lt;unknown&gt;\n  11:     0x57c016370646 - &lt;unknown&gt;\n  12:     0x57c01636a438 - &lt;unknown&gt;\n  13:     0x57c01601bffd - &lt;unknown&gt;\n  14:     0x57c01601fddf - &lt;unknown&gt;\n  15:     0x57c01601ef85 - &lt;unknown&gt;\n  16:     0x57c016143952 - &lt;unknown&gt;\n  17:     0x57c015fe3769 - &lt;unknown&gt;\n  18:     0x57c015fd6073 - &lt;unknown&gt;\n  19:     0x57c015fd6093 - &lt;unknown&gt;\n  20:     0x57c016b821aa - &lt;unknown&gt;\n  21:     0x57c015fe99a5 - &lt;unknown&gt;\n  22:     0x70e672e34e08 - &lt;unknown&gt;\n  23:     0x70e672e34ecc - __libc_start_main\n  24:     0x57c015da6e6e - &lt;unknown&gt;\n  25:                0x0 - &lt;unknown&gt;\n</code></pre></div>",
        "id": 484363421,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732558405
    },
    {
        "content": "<p>Are you using the latest nightly?</p>",
        "id": 484376222,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732563359
    },
    {
        "content": "<p>I suspect that's the issue Sam recently fixed with try. Otherwise I may have pushed it in a broken state. I can check later.</p>",
        "id": 484381873,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732565552
    },
    {
        "content": "<p>Hmm, I thought that yes, but maybe not:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ yay -S roc-nightly-bin\n[...]\nloading packages...\nresolving dependencies...\nlooking for conflicting packages...\n\nPackage (2)            Old Version  New Version  Net Change\n\nroc-nightly-bin        20241120-6   20241126-6     0,00 MiB\nroc-nightly-bin-debug  20241120-6   20241126-6     0,00 MiB\n\nTotal Installed Size:  93,29 MiB\nNet Upgrade Size:       0,00 MiB\n\n:: Proceed with installation? [Y/n]\n(2/2) checking keys in keyring                                                                                                                [---------------------------------------------------------------------------------------] 100%\n(2/2) checking package integrity                                                                                                              [---------------------------------------------------------------------------------------] 100%\n(2/2) loading package files                                                                                                                   [---------------------------------------------------------------------------------------] 100%\n(2/2) checking for file conflicts                                                                                                             [---------------------------------------------------------------------------------------] 100%\n:: Processing package changes...\n(1/2) upgrading roc-nightly-bin                                                                                                               [---------------------------------------------------------------------------------------] 100%\n(2/2) upgrading roc-nightly-bin-debug                                                                                                         [---------------------------------------------------------------------------------------] 100%\n:: Running post-transaction hooks...\n(1/3) Arming ConditionNeedsUpdate...\n(2/3) Refreshing PackageKit...\n(3/3) Checking which packages need to be rebuilt\n$ roc version\nroc nightly pre-release, built from commit 8dbc909 on Fr 15 Nov 2024 09:02:07 UTC\n</code></pre></div>",
        "id": 484463489,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732611989
    },
    {
        "content": "<p>There has been a breaking change so nightlies will be on hold for a couple more days until everything is updated but you can download a TESTING release from the <a href=\"https://github.com/roc-lang/roc/releases\">assets here</a> to get the latest updates.</p>",
        "id": 484468406,
        "sender_full_name": "Anton",
        "timestamp": 1732613541
    },
    {
        "content": "<p>With the TESTING release the <code>inner_html</code> example works nicely!<br>\n<a href=\"/user_uploads/22008/gz-RgwdJsmQ2X8ztACNKOI7h/image.png\">image.png</a><br>\nThanks <span aria-label=\"ok\" class=\"emoji emoji-1f44c\" role=\"img\" title=\"ok\">:ok:</span></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/gz-RgwdJsmQ2X8ztACNKOI7h/image.png\" title=\"image.png\"><img data-original-dimensions=\"798x637\" src=\"/user_uploads/thumbnail/22008/gz-RgwdJsmQ2X8ztACNKOI7h/image.png/840x560.webp\"></a></div>",
        "id": 484599010,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732656336
    },
    {
        "content": "<p>A related question, how to debug a platform. I am also playing with the <code>roc-htmx-playground</code> (I am still deciding whether to go elm+roc, htmx+roc or WASM+roc)... and I am getting:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ DB_PATH=test.db roc run --linker=legacy src/main.roc\nListening on &lt;http://127.0.0.1:8000&gt;\n2024-11-27T11:24:25Z Get /\n2024-11-27T11:24:25Z Get /bootstrap.min.css\n2024-11-27T11:24:25Z Get /styles.css\n2024-11-27T11:24:25Z Get /bootstrap.bundle.min.js\n2024-11-27T11:24:25Z Get /htmx.min.js\n2024-11-27T11:24:25Z Get /site.js\n2024-11-27T11:24:27Z Get /treeview\n2024-11-27T11:24:27Z Get /bigTask\n2024-11-27T11:24:29Z Get /bigTask?page=2&amp;items=25\n2024-11-27T11:24:31Z Get /bigTask?page=3&amp;items=25\n2024-11-27T11:24:33Z Get /bigTask?page=4&amp;items=25\n2024-11-27T11:24:34Z Get /bigTask?page=2&amp;items=25\nmalloc(): unaligned tcache chunk detected\n</code></pre></div>\n<p>I've updated the playground to current Roc (I've tested the TESTING version as well, but the problem is still there): <a href=\"https://github.com/lukewilliamboswell/roc-htmx-playground/pull/9\">https://github.com/lukewilliamboswell/roc-htmx-playground/pull/9</a></p>\n<p>I also debugged it to the platform (the Roc part of the playground works fine)... But in the platform I would appreciate some help how to efficiently debug such thing in Rust. Maybe priting all malloc()s... or <code>strace</code> or something  similar?</p>",
        "id": 484698508,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732706977
    },
    {
        "content": "<p>Can you run it with Valgrind? That may help.</p>",
        "id": 484752723,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732723216
    },
    {
        "content": "<p>I was not able to crash it, but I found these:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ DB_PATH=test.db valgrind src/main\n==3385473== Memcheck, a memory error detector\n==3385473== Copyright (C) 2002-2024, and GNU GPL&#39;d, by Julian Seward et al.\n==3385473== Using Valgrind-3.24.0 and LibVEX; rerun with -h for copyright info\n==3385473== Command: src/main\n==3385473==\n==3385473== posix_memalign() invalid size value: 0\n==3385473==    at 0x484CA38: posix_memalign (vg_replace_malloc.c:2226)\n==3385473==    by 0x273990: rust_main (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x48D5E07: (below main) (libc_start_call_main.h:58)\n==3385473==\nListening on &lt;http://127.0.0.1:8000&gt;\n2024-11-28T09:40:05Z Get /\n2024-11-28T09:40:06Z Get /bootstrap.min.css\n2024-11-28T09:40:06Z Get /bootstrap.bundle.min.js\n2024-11-28T09:40:06Z Get /styles.css\n2024-11-28T09:40:06Z Get /htmx.min.js\n2024-11-28T09:40:06Z Get /site.js\n2024-11-28T09:40:06Z Get /favicon.ico\n404 NotFound /favicon.ico\n2024-11-28T09:40:07Z Get /bigTask\n2024-11-28T09:40:10Z Get /bigTask?page=2&amp;items=25\n==3385473== Thread 20 tokio-runtime-w:\n==3385473== Invalid read of size 8\n==3385473==    at 0x222789: decrement_refcounted_ptr_8 (roc_app:0)\n==3385473==    by 0x22277D: ??? (roc_app:0)\n==3385473==    by 0x229287: ??? (roc_app:0)\n==3385473==    by 0x1C0D18: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3385473==    by 0x1ECAD1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3385473==    by 0x218289: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3385473==    by 0x1E7D02: _158_3fe74881edf546beefa6734056b1899c37505b1c34fcce49bbd7b44b157595 (roc_app:0)\n==3385473==    by 0x22C6CD: roc__forHost_2_caller (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x29A7ED: tokio::runtime::task::raw::poll (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E762D: std::sys_common::backtrace::__rust_begin_short_backtrace (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E736E: core::ops::function::FnOnce::call_once{{vtable.shim}} (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E3ADA: call_once&lt;(), dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: call_once&lt;(), alloc::boxed::Box&lt;dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: std::sys::pal::unix::thread::Thread::new::thread_start (thread.rs:108)\n==3385473==  Address 0x77720a0 is 0 bytes inside a block of size 32 free&#39;d\n==3385473==    at 0x48478EF: free (vg_replace_malloc.c:989)\n==3385473==    by 0x2227CA: decrement_refcounted_ptr_8 (roc_app:0)\n==3385473==    by 0x22277D: ??? (roc_app:0)\n==3385473==    by 0x1A20BA: Controllers.BigTask_15_36cf1b423d96d0d1f556ed298e83394497cd597c20b08eba5512c2685cd67751 (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x1C46BD: Task_46_c436285c5b59d7df49ab96ad8476bdb7c10421fe2225ff48721cb48682ff451 (roc_app:0)\n==3385473==    by 0x1CCDFE: Task_46_28ea24f1682fb667c3fb23a9dbc02f29e624f88b5aca38a345144704a3139a (roc_app:0)\n==3385473==    by 0x1FF9B2: Task_46_ee6d8d949dc3617ea48fd44bd0c8f21be51d3676b1b3bdfdfcf8f559e4e0272f (roc_app:0)\n==3385473==    by 0x222172: Task_46_1f3cd98ac177094c9632f9c81aa71556d2feacfd911d3d139427ec94325c8 (roc_app:0)\n==3385473==    by 0x1C0D04: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3385473==    by 0x1ECAD1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3385473==    by 0x218289: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3385473==    by 0x1E7D02: _158_3fe74881edf546beefa6734056b1899c37505b1c34fcce49bbd7b44b157595 (roc_app:0)\n==3385473==  Block was alloc&#39;d at\n==3385473==    at 0x48447A8: malloc (vg_replace_malloc.c:446)\n==3385473==    by 0x2B074D: &lt;roc_std::roc_str::RocStr as core::convert::From&lt;&amp;str&gt;&gt;::from (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x29A5CA: tokio::runtime::task::raw::poll (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E762D: std::sys_common::backtrace::__rust_begin_short_backtrace (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E736E: core::ops::function::FnOnce::call_once{{vtable.shim}} (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E3ADA: call_once&lt;(), dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: call_once&lt;(), alloc::boxed::Box&lt;dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: std::sys::pal::unix::thread::Thread::new::thread_start (thread.rs:108)\n==3385473==    by 0x494439C: start_thread (pthread_create.c:447)\n==3385473==    by 0x49C92A3: clone (clone.S:100)\n==3385473==\n==3385473== Invalid write of size 8\n==3385473==    at 0x2227AA: decrement_refcounted_ptr_8 (roc_app:0)\n==3385473==    by 0x22277D: ??? (roc_app:0)\n==3385473==    by 0x229287: ??? (roc_app:0)\n==3385473==    by 0x1C0D18: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3385473==    by 0x1ECAD1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3385473==    by 0x218289: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3385473==    by 0x1E7D02: _158_3fe74881edf546beefa6734056b1899c37505b1c34fcce49bbd7b44b157595 (roc_app:0)\n==3385473==    by 0x22C6CD: roc__forHost_2_caller (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x29A7ED: tokio::runtime::task::raw::poll (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E762D: std::sys_common::backtrace::__rust_begin_short_backtrace (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E736E: core::ops::function::FnOnce::call_once{{vtable.shim}} (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E3ADA: call_once&lt;(), dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: call_once&lt;(), alloc::boxed::Box&lt;dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: std::sys::pal::unix::thread::Thread::new::thread_start (thread.rs:108)\n==3385473==  Address 0x77720a0 is 0 bytes inside a block of size 32 free&#39;d\n==3385473==    at 0x48478EF: free (vg_replace_malloc.c:989)\n==3385473==    by 0x2227CA: decrement_refcounted_ptr_8 (roc_app:0)\n==3385473==    by 0x22277D: ??? (roc_app:0)\n==3385473==    by 0x1A20BA: Controllers.BigTask_15_36cf1b423d96d0d1f556ed298e83394497cd597c20b08eba5512c2685cd67751 (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x1C46BD: Task_46_c436285c5b59d7df49ab96ad8476bdb7c10421fe2225ff48721cb48682ff451 (roc_app:0)\n==3385473==    by 0x1CCDFE: Task_46_28ea24f1682fb667c3fb23a9dbc02f29e624f88b5aca38a345144704a3139a (roc_app:0)\n==3385473==    by 0x1FF9B2: Task_46_ee6d8d949dc3617ea48fd44bd0c8f21be51d3676b1b3bdfdfcf8f559e4e0272f (roc_app:0)\n==3385473==    by 0x222172: Task_46_1f3cd98ac177094c9632f9c81aa71556d2feacfd911d3d139427ec94325c8 (roc_app:0)\n==3385473==    by 0x1C0D04: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3385473==    by 0x1ECAD1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3385473==    by 0x218289: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3385473==    by 0x1E7D02: _158_3fe74881edf546beefa6734056b1899c37505b1c34fcce49bbd7b44b157595 (roc_app:0)\n==3385473==  Block was alloc&#39;d at\n==3385473==    at 0x48447A8: malloc (vg_replace_malloc.c:446)\n==3385473==    by 0x2B074D: &lt;roc_std::roc_str::RocStr as core::convert::From&lt;&amp;str&gt;&gt;::from (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x29A5CA: tokio::runtime::task::raw::poll (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E762D: std::sys_common::backtrace::__rust_begin_short_backtrace (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E736E: core::ops::function::FnOnce::call_once{{vtable.shim}} (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3385473==    by 0x2E3ADA: call_once&lt;(), dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: call_once&lt;(), alloc::boxed::Box&lt;dyn core::ops::function::FnOnce&lt;(), Output=()&gt;, alloc::alloc::Global&gt;, alloc::alloc::Global&gt; (boxed.rs:2022)\n==3385473==    by 0x2E3ADA: std::sys::pal::unix::thread::Thread::new::thread_start (thread.rs:108)\n==3385473==    by 0x494439C: start_thread (pthread_create.c:447)\n==3385473==    by 0x49C92A3: clone (clone.S:100)\n==3385473==\n</code></pre></div>\n<p>Looks like a premature <code>free()</code>?</p>",
        "id": 484879001,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732787326
    },
    {
        "content": "<p>Could you make an issue for this (with the valgrind output) <span class=\"user-mention\" data-user-id=\"782019\">@Antonin Komenda</span>?</p>",
        "id": 484900748,
        "sender_full_name": "Anton",
        "timestamp": 1732793760
    },
    {
        "content": "<p>Sure, and is it problem of the basic-webserver platform or Roc?</p>",
        "id": 484900988,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732793839
    },
    {
        "content": "<p>I've never seen the <code>posix_memalign</code> on Roc, let's put it on basic-webserver for now</p>",
        "id": 484901297,
        "sender_full_name": "Anton",
        "timestamp": 1732793937
    },
    {
        "content": "<p>I have my suspicions... we might fix it in the upgrade to purity inference by coincidence. Also I think were using glue that probably needs to be updated/rolled by hand. </p>\n<p>It'd be nice to find the issues and resolve them with basic-cli though. So I've held off launching into that upgrade.</p>",
        "id": 484901928,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732794151
    },
    {
        "content": "<p>Yeah, this suggests that we are allocating something with the wrong size. Allocate something with no size, attempt to read a refcount from it (invalid read cause didn't allocate space for a recount), attempt to write refcount to it (invalid write).</p>",
        "id": 484949218,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732809170
    },
    {
        "content": "<p>Also, posix_memalign is just fancy aligned malloc</p>",
        "id": 484949472,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732809256
    },
    {
        "content": "<p>My first guess is allocating a <code>Box {}</code> is not adding on the refcount.</p>",
        "id": 484949586,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732809288
    },
    {
        "content": "<p>If we run Valgrind in a debug build of the platform and make sure to use the legacy linker, should pinpoint a lot more</p>",
        "id": 484951689,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732810013
    },
    {
        "content": "<p>How to do an appropriate debug build? I've tried <code>roc build --profiling --linker=legacy src/main.roc</code>, but the Valgrind output looks the same.</p>",
        "id": 484952756,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732810384
    },
    {
        "content": "<p>Looks like roc-htmx-playground is using an <a href=\"https://github.com/lukewilliamboswell/roc-htmx-playground/blob/ac05d427bbafc499035e90fb401cd354c05975da/src/main.roc#L2C5-L2C138\">old version of basic-webserver</a>. I recommend trying to upgrade that to the latest main of basic-webserver (in combination with roc TESTING), to do a local platform import use <code>{ pf: platform \"path-to-basic-ws/platform/main.roc\" }</code>.</p>",
        "id": 484955022,
        "sender_full_name": "Anton",
        "timestamp": 1732811250
    },
    {
        "content": "<p>As build command you'll want to use:</p>\n<div class=\"codehilite\"><pre><span></span><code>roc --build-host --suppress-build-host-warning  build --linker=legacy src/main.roc\n</code></pre></div>",
        "id": 484955182,
        "sender_full_name": "Anton",
        "timestamp": 1732811299
    },
    {
        "content": "<p>I've already ported the roc-htmx-playground to new Roc and platform: <a href=\"https://github.com/lukewilliamboswell/roc-htmx-playground/pull/9\">https://github.com/lukewilliamboswell/roc-htmx-playground/pull/9</a></p>",
        "id": 484955343,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732811377
    },
    {
        "content": "<p>In that case, I recommend using a local version of basic-webserver 0.9.0. So:</p>\n<div class=\"codehilite\"><pre><span></span><code>git clone https://github.com/roc-lang/basic-webserver.git\ncd basic-webserver\n</code></pre></div>\n<p>In that folder modify <code>build.roc</code> by removing <code>--release</code> <a href=\"https://github.com/roc-lang/basic-webserver/blob/dee0bfcda04ba51076a1e99a57243b37792f5a55/build.roc#L103\">here</a>.</p>\n<p>Then:</p>\n<div class=\"codehilite\"><pre><span></span><code># use latest nightly roc, not TESTING\nroc build.roc\n</code></pre></div>\n<p>Then you'll want to use that built platform by modifying <a href=\"https://github.com/lukewilliamboswell/roc-htmx-playground/blob/cfb452f792fc2ce68343557da64ed4505fb11c49/src/main.roc#L2\">this url</a> to a path; like <code>{ pf: platform \"some_path/basic-webserver/platform/main.roc\" }</code>.</p>\n<p>that should hopefully improve your valgrind output</p>",
        "id": 484956883,
        "sender_full_name": "Anton",
        "timestamp": 1732811970
    },
    {
        "content": "<p>Do we need to pass a flag with roc build.roc to get a debug build of the platform? Worth checking it's not building a release build by default.</p>",
        "id": 484973401,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732820048
    },
    {
        "content": "<p>It is building a release build by default which is why I said:</p>\n<blockquote>\n<p>In that folder modify <code>build.roc</code> by removing <code>--release</code> <a href=\"https://github.com/roc-lang/basic-webserver/blob/dee0bfcda04ba51076a1e99a57243b37792f5a55/build.roc#L103\">here</a>.</p>\n</blockquote>\n<p>Can you clarify if you mean something else?</p>",
        "id": 484973736,
        "sender_full_name": "Anton",
        "timestamp": 1732820287
    },
    {
        "content": "<blockquote>\n<p>Do we need to pass a flag with roc build.roc</p>\n</blockquote>\n<p>That flag got removed, perhaps because it did not work without --release at the time</p>",
        "id": 484973806,
        "sender_full_name": "Anton",
        "timestamp": 1732820349
    },
    {
        "content": "<p>Nw, i missed that you said that.</p>",
        "id": 484973809,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732820352
    },
    {
        "content": "<p>Should optimize be removed for buildStubAppLib to get better valgrind output or will it not matter?</p>\n<div class=\"codehilite\"><pre><span></span><code>|&gt; Cmd.exec  [&quot;build&quot;, &quot;--lib&quot;, &quot;platform/libapp.roc&quot;, &quot;--output&quot;, stubLibPath, &quot;--optimize&quot;]\n</code></pre></div>",
        "id": 484973977,
        "sender_full_name": "Anton",
        "timestamp": 1732820418
    },
    {
        "content": "<p>That's just for the roc part, and I dont think it will change much much for this debugging.</p>",
        "id": 484974397,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732820615
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"361169\">Anton</span> <a href=\"#narrow/channel/231634-beginners/topic/client-side.20web.20in.20Roc/near/484956883\">said</a>:</p>\n<blockquote>\n<p>In that case, I recommend using a local version of basic-webserver 0.9.0. So:</p>\n<div class=\"codehilite\"><pre><span></span><code>git clone https://github.com/roc-lang/basic-webserver.git\ncd basic-webserver\n</code></pre></div>\n<p>In that folder modify <code>build.roc</code> by removing <code>--release</code> <a href=\"https://github.com/roc-lang/basic-webserver/blob/dee0bfcda04ba51076a1e99a57243b37792f5a55/build.roc#L103\">here</a>.</p>\n<p>Then:</p>\n<div class=\"codehilite\"><pre><span></span><code># use latest nightly roc, not TESTING\nroc build.roc\n</code></pre></div>\n<p>Then you'll want to use that built platform by modifying <a href=\"https://github.com/lukewilliamboswell/roc-htmx-playground/blob/cfb452f792fc2ce68343557da64ed4505fb11c49/src/main.roc#L2\">this url</a> to a path; like <code>{ pf: platform \"some_path/basic-webserver/platform/main.roc\" }</code>.</p>\n<p>that should hopefully improve your valgrind output</p>\n</blockquote>\n<p>I was able to build the platform, but the build does not contain a <code>.o</code> so the playground compains:</p>\n<div class=\"codehilite\"><pre><span></span><code>roc build --build-host --suppress-build-host-warning --linker=legacy src/main.roc\nüî® Building host ...\nld: cannot find src/../../basic-webserver/platform/linux-x64.o: No such file or directory\nthread &#39;main&#39; panicked at crates/compiler/build/src/program.rs:1058:17:\nnot yet implemented: linker failed with exit code Some(1)\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre></div>\n<p>I've got there only <code>libapp.so</code> and <code>linux-x64.a</code>.</p>",
        "id": 485079628,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732880058
    },
    {
        "content": "<p>Did I mess up something in the platform build?</p>",
        "id": 485081962,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732880896
    },
    {
        "content": "<p>I also experienced the same on macOS on Apple Silicon.</p>",
        "id": 485083959,
        "sender_full_name": "Anthony Bullard",
        "timestamp": 1732881662
    },
    {
        "content": "<p>Hmm, can you share the output of <code>ar -t linux-x64.a</code> in the platform folder?</p>",
        "id": 485087762,
        "sender_full_name": "Anton",
        "timestamp": 1732883041
    },
    {
        "content": "<p>Here: </p>\n<div class=\"codehilite\"><pre><span></span><code>ar -t linux-x64.a &gt; ~/desktop/ar.output\n</code></pre></div>\n<p><a href=\"/user_uploads/22008/rKy4Msfg1FhMGHvR23BnZgCi/ar.output\">ar.output</a></p>",
        "id": 485092548,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732884593
    },
    {
        "content": "<p>Thanks, can you share the output of <code>roc version</code>?</p>",
        "id": 485093748,
        "sender_full_name": "Anton",
        "timestamp": 1732884994
    },
    {
        "content": "<p><code>roc nightly pre-release, built from commit 8dbc909 on Fr 15 Nov 2024 09:02:07 UTC</code></p>",
        "id": 485093924,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732885069
    },
    {
        "content": "<p>It should be searching for the .a file, this could be <a href=\"https://github.com/roc-lang/roc/blob/1c9dc56fdefd5532ede2c034e69d50b81705cfbb/crates/compiler/build/src/link.rs#L448\">the problematic line</a>, it may just need to use the <code>prebuilt_static_library</code> function instead. <span class=\"user-mention\" data-user-id=\"515757\">@Luke Boswell</span> may have some useful input as well.</p>\n<p>Can you file an issue for this?</p>\n<p>If you're up for it you can try that function change yourself, build roc with <code>cargo build --release --bin roc</code>, the binary will then be in <code>./target/release/roc</code>. To use that version of roc with your project you'll also need to switch to basic-webserver 0.10.0</p>",
        "id": 485096172,
        "sender_full_name": "Anton",
        "timestamp": 1732885860
    },
    {
        "content": "<p>Reported here: <a href=\"https://github.com/roc-lang/roc/issues/7271\">https://github.com/roc-lang/roc/issues/7271</a></p>\n<p>I'll try to hotfix it in Roc later.</p>",
        "id": 485099931,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1732887128
    },
    {
        "content": "<p>You shouldn't be using the <code>--build-host</code> flag, that is only intended for internal tests now. I think I've found the issue with the above, and it's caused by using that flag. Specifically <a href=\"https://github.com/roc-lang/roc/blob/a9682517093f1e8cdd75572269e5acdcadbb45cf/crates/compiler/build/src/program.rs#L1095\">at this point </a> if you are interested.</p>",
        "id": 485165750,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732917620
    },
    {
        "content": "<p>So you've built the platform correctly, you know this because you can see the <code>linux-x64.a</code> etc files in <code>platform/</code>.</p>",
        "id": 485165856,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732917691
    },
    {
        "content": "<p>So now in your app, you should be able to build it using <code>roc build linker=legacy </code>src/main.roc``</p>",
        "id": 485165959,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732917742
    },
    {
        "content": "<p>Hmm, I am getting:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ roc build --linker=legacy src/main.roc\nld: /tmp/roc_app43ZQ1f.o: in function `roc_fx_sqliteExecute_fastcc_wrapper&#39;:\nbuiltins-host:(.text+0xfef2c): undefined reference to `roc_fx_sqliteExecute&#39;\nthread &#39;main&#39; panicked at crates/compiler/build/src/program.rs:1058:17:\nnot yet implemented: linker failed with exit code Some(1)\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre></div>",
        "id": 485629393,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733147604
    },
    {
        "content": "<p>I can try to reproduce this later</p>",
        "id": 485631048,
        "sender_full_name": "Anton",
        "timestamp": 1733148088
    },
    {
        "content": "<p>Thanks a lot (not critical on my side :]). Do I at least get the error correctly: does it mean the built platform is not compatible with the Roc part of the platform?</p>",
        "id": 485631660,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733148256
    },
    {
        "content": "<p>With respect to the sqlite effects?</p>",
        "id": 485631782,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733148296
    },
    {
        "content": "<blockquote>\n<p>does it mean the built platform is not compatible with the Roc part of the platform?</p>\n</blockquote>\n<p>Good catch, yes, this may just be a function name that changed from one version to another</p>",
        "id": 485633094,
        "sender_full_name": "Anton",
        "timestamp": 1733148695
    },
    {
        "content": "<p><code>roc_fx_sqliteExecute</code> is in the linux-x64.a of basic-webserver (0.10.0).<br>\nCan you share your code <span class=\"user-mention\" data-user-id=\"782019\">@Antonin Komenda</span>?</p>",
        "id": 485690703,
        "sender_full_name": "Anton",
        "timestamp": 1733166240
    },
    {
        "content": "<p>This is my <code>basic-webserver</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ git st\nOn branch main\nYour branch is up to date with &#39;origin/main&#39;.\n\nChanges not staged for commit:\n  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)\n  (use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)\n        modified:   build.roc\n        modified:   examples/todos.roc\n        modified:   platform/Url.roc\n\nno changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)\n$ git diff\ndiff --git a/build.roc b/build.roc\nindex 3b63032..4746c49 100644\n--- a/build.roc\n+++ b/build.roc\n@@ -1,5 +1,6 @@\n app [main] {\n-    cli: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/0.17.0/lZFLstMUCUvd5bjnnpYromZJXkQUrdhbva4xdBInicE.tar.br&quot;,\n+    #cli: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/0.17.0/lZFLstMUCUvd5bjnnpYromZJXkQUrdhbva4xdBInicE.tar.br&quot;,\n+    cli: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/0.16.0/O00IPk-Krg_diNS2dVWlI0ZQP794Vctxzv0ha96mK0E.tar.br&quot;,\n }\n\n import cli.Cmd\n@@ -100,7 +101,7 @@ cargoBuildHost =\n     info! &quot;Building rust host ...&quot;\n\n     &quot;cargo&quot;\n-        |&gt; Cmd.exec [&quot;build&quot;, &quot;--release&quot;]\n+        |&gt; Cmd.exec [&quot;build&quot;]\n         |&gt; Task.mapErr! ErrBuildingHostBinaries\n\n copyHostLib : OSAndArch, Str -&gt; Task {} _\ndiff --git a/examples/todos.roc b/examples/todos.roc\nindex bbf9bd4..73bf2df 100644\n--- a/examples/todos.roc\n+++ b/examples/todos.roc\n@@ -32,7 +32,7 @@ respond = \\req, _ -&gt;\n             req.url\n             |&gt; Url.fromStr\n             |&gt; Url.path\n-            |&gt; Str.splitOn &quot;/&quot;\n+            |&gt; Str.split &quot;/&quot;\n\n         # Route to handler based on url path\n         when splitUrl is\ndiff --git a/platform/Url.roc b/platform/Url.roc\nindex 817bd31..16c9865 100644\n--- a/platform/Url.roc\n+++ b/platform/Url.roc\n@@ -439,7 +439,7 @@ query = \\@Url urlStr -&gt;\n queryParams : Url -&gt; Dict Str Str\n queryParams = \\url -&gt;\n     query url\n-    |&gt; Str.splitOn &quot;&amp;&quot;\n+    |&gt; Str.split &quot;&amp;&quot;\n     |&gt; List.walk (Dict.empty {}) \\dict, pair -&gt;\n         when Str.splitFirst pair &quot;=&quot; is\n             Ok { before, after } -&gt; Dict.insert dict before after\n</code></pre></div>",
        "id": 485697224,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733168664
    },
    {
        "content": "<p>And this the playground:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ git st\nOn branch main\nYour branch is up to date with &#39;origin/main&#39;.\n\nChanges not staged for commit:\n  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)\n  (use &quot;git restore &lt;file&gt;...&quot; to discard changes in working directory)\n        modified:   src/Helpers.roc\n        modified:   src/Models/BigTask.roc\n        modified:   src/Sql/Session.roc\n        modified:   src/main.roc\n\nno changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)\n$ git diff\ndiff --git a/src/Helpers.roc b/src/Helpers.roc\nindex ed6ebee..f30a50e 100644\n--- a/src/Helpers.roc\n+++ b/src/Helpers.roc\n@@ -39,7 +39,7 @@ decodeFormValues = \\body -&gt;\n\n parseQueryParams : Str -&gt; Result (Dict Str Str) _\n parseQueryParams = \\url -&gt;\n-    when Str.splitOn url &quot;?&quot; is\n+    when Str.split url &quot;?&quot; is\n         [_, queryPart] -&gt; queryPart |&gt; Str.toUtf8 |&gt; Http.parseFormUrlEncoded\n         parts -&gt; Err (InvalidQuery (Inspect.toStr parts))\n\ndiff --git a/src/Models/BigTask.roc b/src/Models/BigTask.roc\nindex 336472b..15e6e52 100644\n--- a/src/Models/BigTask.roc\n+++ b/src/Models/BigTask.roc\n@@ -41,7 +41,7 @@ parseDate = \\date -&gt;\n     isTwoChars = \\str -&gt; List.len (Str.toUtf8 str) == 2\n\n     # Format: yyyy-mm-dd\n-    when Str.splitOn date &quot;-&quot; is\n+    when Str.split date &quot;-&quot; is\n         [&quot;&quot;] -&gt; Ok NotSet\n         [yyyy, mm, dd] if isFourChars yyyy &amp;&amp; isTwoChars mm &amp;&amp; isTwoChars dd -&gt;\n             when (Str.toI64 yyyy, Str.toI64 mm, Str.toI64 dd) is\ndiff --git a/src/Sql/Session.roc b/src/Sql/Session.roc\nindex 608a495..ce8df9b 100644\n--- a/src/Sql/Session.roc\n+++ b/src/Sql/Session.roc\n@@ -32,7 +32,7 @@ parse = \\req -&gt;\n     when req.headers |&gt; List.keepIf \\reqHeader -&gt; reqHeader.name == &quot;cookie&quot; is\n         [reqHeader] -&gt;\n             reqHeader.value\n-            |&gt; Str.splitOn &quot;=&quot;\n+            |&gt; Str.split &quot;=&quot;\n             |&gt; List.get 1\n             |&gt; Result.try Str.toI64\n             |&gt; Result.mapErr \\_ -&gt; InvalidSessionCookie\ndiff --git a/src/main.roc b/src/main.roc\nindex bb91e83..0c810f5 100644\n--- a/src/main.roc\n+++ b/src/main.roc\n@@ -1,5 +1,6 @@\n app [Model, server] {\n-    pf: platform &quot;https://github.com/roc-lang/basic-webserver/releases/download/0.10.0/BgDDIykwcg51W8HA58FE_BjdzgXVk--ucv6pVb_Adik.tar.br&quot;,\n+    # pf: platform &quot;https://github.com/roc-lang/basic-webserver/releases/download/0.10.0/BgDDIykwcg51W8HA58FE_BjdzgXVk--ucv6pVb_Adik.tar.br&quot;,\n+    pf: platform &quot;../../basic-webserver/platform/main.roc&quot;,\n     html: &quot;https://github.com/Hasnep/roc-html/releases/download/v0.6.0/IOyNfA4U_bCVBihrs95US9Tf5PGAWh3qvrBN4DRbK5c.tar.br&quot;,\n }\n\n@@ -75,7 +76,7 @@ handleReq = \\req -&gt;\n         req.url\n         |&gt; Url.fromStr\n         |&gt; Url.path\n-        |&gt; Str.splitOn &quot;/&quot;\n+        |&gt; Str.split &quot;/&quot;\n         |&gt; List.dropFirst 1\n\n     when (req.method, urlSegments) is\n</code></pre></div>",
        "id": 485697348,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733168734
    },
    {
        "content": "<p>I.e. both are <code>main</code>s with the changes to build the platform and then use the locally built platform (and the <code>splitOn</code>/<code>split</code> \"backport\")</p>",
        "id": 485697484,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733168781
    },
    {
        "content": "<p>If I try to build the <code>basic-webserver</code> with the cli 0.17.0, I get:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ roc build.roc\n\n‚îÄ‚îÄ NOT EXPOSED in .../lZFLstMUCUvd5bjnnpYromZJXkQUrdhbva4xdBInicE/Arg/Help.roc ‚îÄ\n\nThe Str module does not expose `splitOn`:\n\n342‚îÇ      |&gt; Str.splitOn &quot;\\n&quot;\n             ^^^^^^^^^^^\n\nDid you mean one of these?\n\n    Str.split\n    Str.splitLast\n    Str.splitFirst\n    Str.isEmpty\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\n1 error and 0 warnings found in 87 ms\n.\n\nYou can run the program anyway with roc run build.roc\n</code></pre></div>\n<p>as I am using the non-TESTING Roc, as you suggested before.</p>",
        "id": 485698457,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733169229
    },
    {
        "content": "<p>You must be using an older nightly, splitOn is a newer API.</p>",
        "id": 485702169,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1733170815
    },
    {
        "content": "<p>Aah, even older... okok, I'll try. Sorry, I didn't get that, I though only non-TESTING.</p>",
        "id": 485790047,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733216086
    },
    {
        "content": "<p>or could I use the nightly Roc from yesterday maybe?</p>",
        "id": 485810275,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733221270
    },
    {
        "content": "<p>yes, that one has the new Str.splitOn API</p>",
        "id": 485811723,
        "sender_full_name": "Anton",
        "timestamp": 1733221648
    },
    {
        "content": "<p>Hmm, still the problem with the sqliteExecure fx:</p>\n<div class=\"codehilite\"><pre><span></span><code>$ roc build --linker=legacy src/main.roc\nld: /tmp/roc_appLCFstE.o: in function `roc_fx_sqliteExecute_fastcc_wrapper&#39;:\nbuiltins-host:(.text+0xfe40c): undefined reference to `roc_fx_sqliteExecute&#39;\nthread &#39;main&#39; panicked at crates/compiler/build/src/program.rs:1058:17:\nnot yet implemented: linker failed with exit code Some(1)\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre></div>\n<p>I've updated Roc, the basic-webserver and the playground, the <code>split/splitOn</code> is ok now.</p>",
        "id": 485859267,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733234307
    },
    {
        "content": "<p>I'll try to check the intermediate .o files whether/why not the function is really there</p>",
        "id": 485859469,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733234351
    },
    {
        "content": "<p>I've extracted the <code>linux-x64.a</code> to object files and grepped out the <code>fx_sqlite</code> functions and got only:</p>\n<div class=\"codehilite\"><pre><span></span><code>host-6d734d3ba16fa1e3.host.6db8a1e53cb1cd2b-cgu.0.rcgu.o\n0000000000000000 T roc_fx_sqliteBind\n0000000000000000 T roc_fx_sqliteColumns\n0000000000000000 T roc_fx_sqliteColumnValue\n0000000000000000 T roc_fx_sqlitePrepare\n0000000000000000 T roc_fx_sqliteReset\n0000000000000000 T roc_fx_sqliteStep\n</code></pre></div>",
        "id": 485863299,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733235255
    },
    {
        "content": "<p>So I really do not have the <code>...Execute</code> there. Any suggestions? Or maybe a pointer where is the host object built?</p>",
        "id": 485863484,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733235307
    },
    {
        "content": "<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> this what I get after extracting the linux-x64.a for <a href=\"http://BgDDIykwcg51W8HA58FE_BjdzgXVk--ucv6pVb_Adik.tar.br\">BgDDIykwcg51W8HA58FE_BjdzgXVk--ucv6pVb_Adik.tar.br</a> :</p>\n<div class=\"codehilite\"><pre><span></span><code>‚ùØ strings host-b1c017c9b46813ae.host.faf5bafe4a7818bd-cgu.0.rcgu.o | grep fx_sqlite\n.rela.text.roc_fx_sqliteExecute\n.gcc_except_table.roc_fx_sqliteExecute\n.rela.rodata.roc_fx_sqliteExecute\n</code></pre></div>",
        "id": 485875084,
        "sender_full_name": "Anton",
        "timestamp": 1733238030
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>$ strings host-6d734d3ba16fa1e3.host.6db8a1e53cb1cd2b-cgu.0.rcgu.o | grep fx_sqlite\n.rela.text.roc_fx_sqliteReset\n.rela.text.roc_fx_sqliteColumns\n.gcc_except_table.roc_fx_sqliteColumns\n.rela.text.roc_fx_sqliteStep\n.rela.text.roc_fx_sqliteColumnValue\n.gcc_except_table.roc_fx_sqliteColumnValue\n.rela.rodata.roc_fx_sqliteColumnValue\n.rela.text.roc_fx_sqlitePrepare\n.gcc_except_table.roc_fx_sqlitePrepare\n.rela.text.roc_fx_sqliteBind\n.gcc_except_table.roc_fx_sqliteBind\n.rela.rodata.roc_fx_sqliteBind\n</code></pre></div>",
        "id": 485875663,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733238163
    },
    {
        "content": "<p>Should we have the hashes the same? Or they are local to the build?</p>",
        "id": 485875772,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733238194
    },
    {
        "content": "<p>I'm not sure about those hashes, but are you also using <a href=\"http://BgDDIykwcg51W8HA58FE_BjdzgXVk--ucv6pVb_Adik.tar.br\">BgDDIykwcg51W8HA58FE_BjdzgXVk--ucv6pVb_Adik.tar.br</a> ?</p>",
        "id": 485876178,
        "sender_full_name": "Anton",
        "timestamp": 1733238302
    },
    {
        "content": "<p>That <a href=\"http://tar.br\">tar.br</a> comes from <a href=\"https://github.com/roc-lang/basic-webserver/releases/tag/0.10.0\">https://github.com/roc-lang/basic-webserver/releases/tag/0.10.0</a></p>",
        "id": 485876356,
        "sender_full_name": "Anton",
        "timestamp": 1733238341
    },
    {
        "content": "<p>nono, I am building the platform locally... that's all because I want the non<code>--release</code> build of the platform to pinpoint the malloc problem I am triggering from the playground</p>",
        "id": 485876551,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733238380
    },
    {
        "content": "<p>Can you try setting <code>CARGO_BUILD_TARGET=x86_64-unknown-linux-musl </code> when you build basic-webserver, that's what I use to build the release</p>",
        "id": 485878632,
        "sender_full_name": "Anton",
        "timestamp": 1733238851
    },
    {
        "content": "<p>that actually worked <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<p>however the valgrind output is pretty the same <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> </p>\n<div class=\"codehilite\"><pre><span></span><code>==3181233== Memcheck, a memory error detector\n==3181233== Copyright (C) 2002-2024, and GNU GPL&#39;d, by Julian Seward et al.\n==3181233== Using Valgrind-3.24.0 and LibVEX; rerun with -h for copyright info\n==3181233== Command: src/main\n==3181233==\n==3181233== posix_memalign() invalid size value: 0\n==3181233==    at 0x484CA38: posix_memalign (vg_replace_malloc.c:2226)\n==3181233==    by 0x5C0080: aligned_malloc (alloc.rs:102)\n==3181233==    by 0x5C0080: alloc (alloc.rs:22)\n==3181233==    by 0x5C0080: __rdl_alloc (alloc.rs:394)\n==3181233==    by 0x5EAADA: alloc::alloc::alloc (alloc.rs:100)\n==3181233==    by 0x27069F: roc_host::roc::call_roc_init (roc.rs:1001)\n==3181233==    by 0x60CF3B: roc_host::http_server::start (http_server.rs:25)\n==3181233==    by 0x27C615: rust_main (lib.rs:8)\n==3181233==    by 0x26F996: main (lib.rs:3)\n==3181233==\nListening on &lt;http://127.0.0.1:8000&gt;\n2024-12-03T15:20:39Z GET /\n2024-12-03T15:20:39Z GET /styles.css\n2024-12-03T15:20:40Z GET /bootstrap.bundle.min.js\n2024-12-03T15:20:40Z GET /bootstrap.min.css\n2024-12-03T15:20:40Z GET /htmx.min.js\n2024-12-03T15:20:40Z GET /site.js\n2024-12-03T15:20:40Z GET /favicon.ico\n404 NotFound /favicon.ico\n2024-12-03T15:20:41Z GET /bigTask\n2024-12-03T15:20:44Z GET /bigTask?page=2&amp;items=25\n==3181233== Thread 18 tokio-runtime-w:\n==3181233== Invalid read of size 8\n==3181233==    at 0x265499: decrement_refcounted_ptr_8 (roc_app:0)\n==3181233==    by 0x26548D: ??? (roc_app:0)\n==3181233==    by 0x26B11B: ??? (roc_app:0)\n==3181233==    by 0x1FC1A9: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3181233==    by 0x225CA1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3181233==    by 0x25A208: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3181233==    by 0x21F082: _158_3fe74881edf546beefa6734056b1899c37505b1c34fcce49bbd7b44b157595 (roc_app:0)\n==3181233==    by 0x26F94D: roc__forHost_2_caller (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3181233==    by 0x270F64: roc_host::roc::call_roc_respond (roc.rs:1086)\n==3181233==    by 0x28AC84: roc_host::http_server::call_roc (http_server.rs:62)\n==3181233==    by 0x28BB14: roc_host::http_server::handle_req::{{closure}}::{{closure}} (http_server.rs:110)\n==3181233==    by 0x60DAE4: &lt;tokio::runtime::blocking::task::BlockingTask&lt;T&gt; as core::future::future::Future&gt;::poll (task.rs:42)\n==3181233==  Address 0x7549610 is 0 bytes inside a block of size 32 free&#39;d\n==3181233==    at 0x48478EF: free (vg_replace_malloc.c:989)\n==3181233==    by 0x26FA02: roc_dealloc (roc.rs:34)\n==3181233==    by 0x2654DA: decrement_refcounted_ptr_8 (roc_app:0)\n==3181233==    by 0x26548D: ??? (roc_app:0)\n==3181233==    by 0x1DFA60: Controllers.BigTask_15_36cf1b423d96d0d1f556ed298e83394497cd597c20b08eba5512c2685cd67751 (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3181233==    by 0x20012F: Task_46_c436285c5b59d7df49ab96ad8476bdb7c10421fe2225ff48721cb48682ff451 (roc_app:0)\n==3181233==    by 0x2088CC: Task_46_28ea24f1682fb667c3fb23a9dbc02f29e624f88b5aca38a345144704a3139a (roc_app:0)\n==3181233==    by 0x23DD1D: Task_46_ee6d8d949dc3617ea48fd44bd0c8f21be51d3676b1b3bdfdfcf8f559e4e0272f (roc_app:0)\n==3181233==    by 0x2652E6: Task_46_1f3cd98ac177094c9632f9c81aa71556d2feacfd911d3d139427ec94325c8 (roc_app:0)\n==3181233==    by 0x1FC195: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3181233==    by 0x225CA1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3181233==    by 0x25A208: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3181233==  Block was alloc&#39;d at\n==3181233==    at 0x48447A8: malloc (vg_replace_malloc.c:446)\n==3181233==    by 0x26F9B2: roc_alloc (roc.rs:19)\n==3181233==    by 0x5A075E: roc_std::roc_list::RocList&lt;T&gt;::elems_with_capacity (roc_list.rs:89)\n==3181233==    by 0x5A0E7F: roc_std::roc_list::RocList&lt;T&gt;::extend_from_slice (roc_list.rs:371)\n==3181233==    by 0x5A0BAC: roc_std::roc_list::RocList&lt;T&gt;::from_slice (roc_list.rs:312)\n==3181233==    by 0x59FE98: roc_std::roc_str::RocStr::from_slice_unchecked (roc_str.rs:76)\n==3181233==    by 0x5A0074: &lt;roc_std::roc_str::RocStr as core::convert::From&lt;&amp;str&gt;&gt;::from (roc_str.rs:704)\n==3181233==    by 0x27D23A: &lt;T as core::convert::Into&lt;U&gt;&gt;::into (mod.rs:759)\n==3181233==    by 0x60C2E6: roc_host::roc_http::RequestToAndFromHost::from_reqwest (roc_http.rs:30)\n==3181233==    by 0x28AB6C: roc_host::http_server::call_roc (http_server.rs:60)\n==3181233==    by 0x28BB14: roc_host::http_server::handle_req::{{closure}}::{{closure}} (http_server.rs:110)\n==3181233==    by 0x60DAE4: &lt;tokio::runtime::blocking::task::BlockingTask&lt;T&gt; as core::future::future::Future&gt;::poll (task.rs:42)\n==3181233==\n==3181233== Invalid write of size 8\n==3181233==    at 0x2654BA: decrement_refcounted_ptr_8 (roc_app:0)\n==3181233==    by 0x26548D: ??? (roc_app:0)\n==3181233==    by 0x26B11B: ??? (roc_app:0)\n==3181233==    by 0x1FC1A9: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3181233==    by 0x225CA1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3181233==    by 0x25A208: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3181233==    by 0x21F082: _158_3fe74881edf546beefa6734056b1899c37505b1c34fcce49bbd7b44b157595 (roc_app:0)\n==3181233==    by 0x26F94D: roc__forHost_2_caller (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3181233==    by 0x270F64: roc_host::roc::call_roc_respond (roc.rs:1086)\n==3181233==    by 0x28AC84: roc_host::http_server::call_roc (http_server.rs:62)\n==3181233==    by 0x28BB14: roc_host::http_server::handle_req::{{closure}}::{{closure}} (http_server.rs:110)\n==3181233==    by 0x60DAE4: &lt;tokio::runtime::blocking::task::BlockingTask&lt;T&gt; as core::future::future::Future&gt;::poll (task.rs:42)\n==3181233==  Address 0x7549610 is 0 bytes inside a block of size 32 free&#39;d\n==3181233==    at 0x48478EF: free (vg_replace_malloc.c:989)\n==3181233==    by 0x26FA02: roc_dealloc (roc.rs:34)\n==3181233==    by 0x2654DA: decrement_refcounted_ptr_8 (roc_app:0)\n==3181233==    by 0x26548D: ??? (roc_app:0)\n==3181233==    by 0x1DFA60: Controllers.BigTask_15_36cf1b423d96d0d1f556ed298e83394497cd597c20b08eba5512c2685cd67751 (in /home/gree/workspace/roc-htmx-playground/src/main)\n==3181233==    by 0x20012F: Task_46_c436285c5b59d7df49ab96ad8476bdb7c10421fe2225ff48721cb48682ff451 (roc_app:0)\n==3181233==    by 0x2088CC: Task_46_28ea24f1682fb667c3fb23a9dbc02f29e624f88b5aca38a345144704a3139a (roc_app:0)\n==3181233==    by 0x23DD1D: Task_46_ee6d8d949dc3617ea48fd44bd0c8f21be51d3676b1b3bdfdfcf8f559e4e0272f (roc_app:0)\n==3181233==    by 0x2652E6: Task_46_1f3cd98ac177094c9632f9c81aa71556d2feacfd911d3d139427ec94325c8 (roc_app:0)\n==3181233==    by 0x1FC195: Task_53_b7f067e6f5939fbe06dd68ed4b36fad898cbfd8ef8d993964d5cd10b12ac3ec (roc_app:0)\n==3181233==    by 0x225CA1: Task_96_38ac12d038fd8df52070eb8edb3aab96b2fa7b50fc7a9367255428634fa0264e (roc_app:0)\n==3181233==    by 0x25A208: Task_46_5e6d2773e4caec97557de41edef7addcc8c8bc472f779d224a7d61166dbaabe (roc_app:0)\n==3181233==  Block was alloc&#39;d at\n==3181233==    at 0x48447A8: malloc (vg_replace_malloc.c:446)\n==3181233==    by 0x26F9B2: roc_alloc (roc.rs:19)\n==3181233==    by 0x5A075E: roc_std::roc_list::RocList&lt;T&gt;::elems_with_capacity (roc_list.rs:89)\n==3181233==    by 0x5A0E7F: roc_std::roc_list::RocList&lt;T&gt;::extend_from_slice (roc_list.rs:371)\n==3181233==    by 0x5A0BAC: roc_std::roc_list::RocList&lt;T&gt;::from_slice (roc_list.rs:312)\n==3181233==    by 0x59FE98: roc_std::roc_str::RocStr::from_slice_unchecked (roc_str.rs:76)\n==3181233==    by 0x5A0074: &lt;roc_std::roc_str::RocStr as core::convert::From&lt;&amp;str&gt;&gt;::from (roc_str.rs:704)\n==3181233==    by 0x27D23A: &lt;T as core::convert::Into&lt;U&gt;&gt;::into (mod.rs:759)\n==3181233==    by 0x60C2E6: roc_host::roc_http::RequestToAndFromHost::from_reqwest (roc_http.rs:30)\n==3181233==    by 0x28AB6C: roc_host::http_server::call_roc (http_server.rs:60)\n==3181233==    by 0x28BB14: roc_host::http_server::handle_req::{{closure}}::{{closure}} (http_server.rs:110)\n==3181233==    by 0x60DAE4: &lt;tokio::runtime::blocking::task::BlockingTask&lt;T&gt; as core::future::future::Future&gt;::poll (task.rs:42)\n==3181233==\n</code></pre></div>",
        "id": 485880519,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733239307
    },
    {
        "content": "<p>I left some more comments <a href=\"https://github.com/roc-lang/basic-webserver/issues/81\">on the issue</a>, but we'll have to wait until a specialist can look at it.</p>",
        "id": 485888900,
        "sender_full_name": "Anton",
        "timestamp": 1733241320
    },
    {
        "content": "<p>I see. Thanks!</p>",
        "id": 485889131,
        "sender_full_name": "Antonin Komenda",
        "timestamp": 1733241367
    }
]
[
    {
        "content": "<p>I tried to get acquainted with the new compiler, new syntax, and the language in general. I've been able to run this (yay!) with <code>roc build</code> (<code>@5f964dcd</code>):</p>\n<div class=\"codehilite\" data-code-language=\"roc\"><pre><span></span><code>app [main!] { pf: platform \"https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.5/BJBzo2SR2o5w3StmubGWvnPHq6hfePMaNWy5MwkPuZUs.tar.zst\" }\n\nimport pf.Stdout\nimport pf.Arg exposing [Arg]\n\n# main! : List Arg =&gt; Try {}\nmain! = |_args| {\n    Stdout.line!(\"Hello, World!\")\n    dbg 5-&gt;calc()\n    Stdout.line!(\"${calc(7).to_str()}\")\n    Ok({})\n}\n\ncalc = |n| n + 1\n</code></pre></div>\n<p>trying to set up the LSP in helix however, I get a crash when viewing this file:</p>\n<div class=\"codehilite\"><pre><span></span><code>thread 27907 panic: Arrays out of sync:\n type_nodes=17\n  region_nodes=38\n\n/home/lukas/code/30software/roc/src/check/Check.zig:255:28: 0x4be3638 in copyVar (mod.zig)\n            std.debug.panic(\n                           ^\n/home/lukas/code/30software/roc/src/check/Check.zig:1260:57: 0x4965ed8 in checkPlatformRequirements (mod.zig)\n            const copied_required_var = try self.copyVar(required_type_var, platform_env, required_type.region);\n                                                        ^\n/home/lukas/code/30software/roc/src/compile/compile_build.zig:683:46: 0x4a76d82 in checkPlatformRequirements (mod.zig)\n        try checker.checkPlatformRequirements(platform_root_env, &amp;platform_to_app_idents);\n                                             ^\n/home/lukas/code/30software/roc/src/compile/compile_build.zig:586:43: 0x4a7bfa5 in build (mod.zig)\n        try self.checkPlatformRequirements();\n                                          ^\n/home/lukas/code/30software/roc/src/lsp/syntax.zig:88:18: 0x4dfecec in check (mod.zig)\n        env.build(absolute_path) catch |err| {\n                 ^\n/home/lukas/code/30software/roc/src/lsp/server.zig:236:63: 0x4e061d7 in runSyntaxCheck (mod.zig)\n            const publish_sets = try self.syntax_checker.check(uri, if (doc) |d| d.text else null, root_path);\n                                                              ^\n/home/lukas/code/30software/roc/src/lsp/server.zig:225:32: 0x4e06bce in onDocumentChanged (mod.zig)\n            self.runSyntaxCheck(uri) catch |err| {\n                               ^\n/home/lukas/code/30software/roc/src/lsp/handlers/did_open.zig:44:35: 0x4a2666d in call (mod.zig)\n            self.onDocumentChanged(uri);\n                                  ^\n/home/lukas/code/30software/roc/src/lsp/server.zig:176:24: 0x4832b25 in handleNotification (mod.zig)\n                handler(self, params) catch |err| {\n                       ^\n/home/lukas/code/30software/roc/src/lsp/server.zig:149:44: 0x4833850 in handlePayload (mod.zig)\n                try self.handleNotification(method, obj.get(\\params\\&quot;));\\\n                                           ^\n/home/lukas/code/30software/roc/src/lsp/server.zig:114:31: 0x4833ec3 in processNextMessage (mod.zig)\n            self.handlePayload(payload) catch |err| {\n                              ^\n/home/lukas/code/30software/roc/src/lsp/server.zig:100:47: 0x48341a4 in run (mod.zig)\n            while (try self.processNextMessage()) {}\n                                              ^\n/home/lukas/code/30software/roc/src/lsp/server.zig:312:19: 0x4834b40 in runWithStdIo (mod.zig)\n    try server.run();\n                  ^\n/home/lukas/code/30software/roc/src/lsp/mod.zig:10:28: 0x4834ffd in runWithStdIo (mod.zig)\n    try server.runWithStdIo(allocator, debug);\n                           ^\n/home/lukas/code/30software/roc/src/cli/main.zig:766:61: 0x4893ac9 in mainArgs (main.zig)\n        .experimental_lsp =&gt; |lsp_args| try lsp.runWithStdIo(allocs.gpa, .{\n                                                            ^\n/home/lukas/code/30software/roc/src/cli/main.zig:643:13: 0x4895408 in main (main.zig)\n    mainArgs(&amp;allocs, args) catch |err| {\n            ^\n/usr/lib/zig/std/start.zig:627:37: 0x4895a01 in main (std.zig)\n            const result = root.main() catch |err| {\n                                    ^\n/usr/lib/zig/libc/musl/src/env/__libc_start_main.c:95:7: 0x9723e9b in libc_start_main_stage2 (/usr/lib/zig/libc/musl/src/env/__libc_start_main.c)\n exit(main(argc, argv, envp));\n      ^\n???:?:?: 0x9702149 in ??? (???)\nUnwind error at address `exe:0x9702149` (error.MissingFDE), trace may be incomplete\n</code></pre></div>\n<p>This is the LSP communication to that point:</p>\n<div class=\"codehilite\"><pre><span></span><code>2026-01-09T19:36:48.612 helix_core::syntax [INFO] Skipping syntax config for &#39;roc&#39; because the parser&#39;s shared library does not exist\n2026-01-09T19:36:48.613 helix_lsp::transport [INFO] roc-lsp -&gt; {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;initialize&quot;,&quot;params&quot;:{&quot;capabilities&quot;:{&quot;general&quot;:{&quot;positionEncodings&quot;:[&quot;utf-8&quot;,&quot;utf-32&quot;,&quot;utf-16&quot;]},&quot;textDocument&quot;:{&quot;codeAction&quot;:{&quot;codeActionLiteralSupport&quot;:{&quot;codeActionKind&quot;:{&quot;valueSet&quot;:[&quot;&quot;,&quot;quickfix&quot;,&quot;refactor&quot;,&quot;refactor.extract&quot;,&quot;refactor.inline&quot;,&quot;refactor.rewrite&quot;,&quot;source&quot;,&quot;source.organizeImports&quot;]}},&quot;dataSupport&quot;:true,&quot;disabledSupport&quot;:true,&quot;isPreferredSupport&quot;:true,&quot;resolveSupport&quot;:{&quot;properties&quot;:[&quot;edit&quot;,&quot;command&quot;]}},&quot;completion&quot;:{&quot;completionItem&quot;:{&quot;deprecatedSupport&quot;:true,&quot;insertReplaceSupport&quot;:true,&quot;resolveSupport&quot;:{&quot;properties&quot;:[&quot;documentation&quot;,&quot;detail&quot;,&quot;additionalTextEdits&quot;]},&quot;snippetSupport&quot;:true,&quot;tagSupport&quot;:{&quot;valueSet&quot;:[1]}},&quot;completionItemKind&quot;:{}},&quot;formatting&quot;:{&quot;dynamicRegistration&quot;:false},&quot;hover&quot;:{&quot;contentFormat&quot;:[&quot;markdown&quot;]},&quot;inlayHint&quot;:{&quot;dynamicRegistration&quot;:false},&quot;publishDiagnostics&quot;:{&quot;tagSupport&quot;:{&quot;valueSet&quot;:[1,2]},&quot;versionSupport&quot;:true},&quot;rename&quot;:{&quot;dynamicRegistration&quot;:false,&quot;honorsChangeAnnotations&quot;:false,&quot;prepareSupport&quot;:true},&quot;signatureHelp&quot;:{&quot;signatureInformation&quot;:{&quot;activeParameterSupport&quot;:true,&quot;documentationFormat&quot;:[&quot;markdown&quot;],&quot;parameterInformation&quot;:{&quot;labelOffsetSupport&quot;:true}}}},&quot;window&quot;:{&quot;workDoneProgress&quot;:true},&quot;workspace&quot;:{&quot;applyEdit&quot;:true,&quot;configuration&quot;:true,&quot;didChangeConfiguration&quot;:{&quot;dynamicRegistration&quot;:false},&quot;didChangeWatchedFiles&quot;:{&quot;dynamicRegistration&quot;:true,&quot;relativePatternSupport&quot;:false},&quot;executeCommand&quot;:{&quot;dynamicRegistration&quot;:false},&quot;fileOperations&quot;:{&quot;didRename&quot;:true,&quot;willRename&quot;:true},&quot;inlayHint&quot;:{&quot;refreshSupport&quot;:false},&quot;symbol&quot;:{&quot;dynamicRegistration&quot;:false},&quot;workspaceEdit&quot;:{&quot;documentChanges&quot;:true,&quot;failureHandling&quot;:&quot;abort&quot;,&quot;normalizesLineEndings&quot;:false,&quot;resourceOperations&quot;:[&quot;create&quot;,&quot;rename&quot;,&quot;delete&quot;]},&quot;workspaceFolders&quot;:true}},&quot;clientInfo&quot;:{&quot;name&quot;:&quot;helix&quot;,&quot;version&quot;:&quot;25.07.1&quot;},&quot;processId&quot;:27898,&quot;rootPath&quot;:&quot;/home/lukas/code/30software/roc&quot;,&quot;rootUri&quot;:&quot;file:///home/lukas/code/30software/roc&quot;,&quot;workspaceFolders&quot;:[{&quot;name&quot;:&quot;roc&quot;,&quot;uri&quot;:&quot;file:///home/lukas/code/30software/roc&quot;}]},&quot;id&quot;:0}\n2026-01-09T19:36:48.619 helix_lsp::transport [ERROR] roc-lsp err &lt;- &quot;roc-lsp logging to /tmp/roc-lsp-debug.log\\n&quot;\n2026-01-09T19:36:48.622 helix_lsp::transport [INFO] roc-lsp &lt;- {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:0,&quot;result&quot;:{&quot;capabilities&quot;:{&quot;positionEncoding&quot;:&quot;utf-16&quot;,&quot;textDocumentSync&quot;:{&quot;openClose&quot;:true,&quot;change&quot;:2}},&quot;serverInfo&quot;:{&quot;name&quot;:&quot;roc-lsp&quot;,&quot;version&quot;:&quot;0.1&quot;}}}\n2026-01-09T19:36:48.622 helix_lsp::transport [INFO] roc-lsp -&gt; {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;initialized&quot;,&quot;params&quot;:{}}\n2026-01-09T19:36:48.622 helix_lsp::transport [INFO] roc-lsp -&gt; {&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;textDocument/didOpen&quot;,&quot;params&quot;:{&quot;textDocument&quot;:{&quot;languageId&quot;:&quot;roc&quot;,&quot;text&quot;:&quot;app [main!] { pf: platform \\&quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.5/BJBzo2SR2o5w3StmubGWvnPHq6hfePMaNWy5MwkPuZUs.tar.zst\\&quot; }\\n\\nimport pf.Stdout\\nimport pf.Arg exposing [Arg]\\n\\n# main! : List Arg =&gt; Try {}\\nmain! = |_args| {\\n\\tStdout.line!(\\&quot;Hello, World!\\&quot;)\\n\\tdbg 5-&gt;calc()\\n\\tStdout.line!(\\&quot;${calc(7).to_str()}\\&quot;)\\n\\tOk({})\\n}\\n\\ncalc = |n| n + 1\\n&quot;,&quot;uri&quot;:&quot;file:///home/lukas/code/30software/roc/test.roc&quot;,&quot;version&quot;:0}}}\n2026-01-09T19:36:48.836 helix_lsp::transport [ERROR] roc-lsp err &lt;- &quot;thread 27907 panic: Arrays out of sync:\\n&quot;\n[…rest of above stack trace]\n</code></pre></div>\n<p>Is this a bug in the LSP, nonsense in my attempt at writing roc, or do I need to do some special setup to make the LSP work?</p>\n<p>If the first, how can I debug it further?<br>\nThanks in advance :)</p>",
        "id": 567243459,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1767985126
    },
    {
        "content": "<p>I noticed your using version 0.5 of the platform, does it still happen with the latest which I think is 0.6?</p>",
        "id": 567257850,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1767990637
    },
    {
        "content": "<p>Either way you have definitely found a bug, if you wouldn't mind making a GH issue that'd be good <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 567257934,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1767990678
    },
    {
        "content": "<p>Alrighty, will check with 0.6. thanks for the quick reaction. :)<br>\nBefore reporting I'll move around a bit in gdb which I finally managed to set up</p>",
        "id": 567258201,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1767990800
    },
    {
        "content": "<p>Yep, same behavior with</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst&quot; }\n</code></pre></div>\n<p>(note to self: timestamp <code>2026-01-09T21:36:45.221</code> in helix logs)</p>",
        "id": 567258758,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1767991029
    },
    {
        "content": "<p>I know that feature is super early. We haven't touched it in a while and I don't think we ever got any integration tests for it, so it definitely needs some love.</p>",
        "id": 567258901,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1767991094
    },
    {
        "content": "<p>Though that bug is deep in Check which should be quite reliable so I'm guessing some simple is broken here, like how its wired up to the existing compiler pipeline or something.</p>",
        "id": 567259176,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1767991223
    },
    {
        "content": "<p>No worries, I got that from the <code>experimental</code>. I figured it might be in a „it works but only on tuesdays and for even-length input messages“ kinda situation where I just would've had to know what knobs to turn. happy to report anything</p>",
        "id": 567259236,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1767991250
    },
    {
        "content": "<p>Wanted to give debugging this myself a shot (via <code>zig build roc &amp;&amp; ./zig-out/bin/roc experimental-lsp &lt; crash.lsp</code>), but  I struggle in two orthogonal ways:</p>\n<ol>\n<li><code>gdb</code> gets symbols (i.e., correctly shows function names in <code>bt</code>), but has no line info. Am I missing gdb config or a build flag?</li>\n<li>building roc takes quite a bit of time, e.g.  addidng a <code>self.debugAssertArraysInSync()</code> somewhere in <code>Check.zig</code> triggers a rebuild taking <em>~1m25s</em> on my machine. That's a bit too long of a loop for printf debugging. A big chunk of that seems to be building interpreter shims for all sorts of platforms (arm,  wasm, …) and linking in general. Is there any way I can restrict what gets build, are there any other knobs I can turn, or is my machine just too slow (<code>i7-8650U</code>)? I haven't found  any cross-compilation related build flag in <code>zig build --help</code>.</li>\n</ol>\n<p>Perhaps I'm missing an obviously better workflow here.</p>",
        "id": 567410087,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1768158386
    },
    {
        "content": "<p>To give some detail regarding the missing line info: zig itself properly reports lines in the <code>panic</code>:</p>\n<div class=\"codehilite\"><pre><span></span><code> ./zig-out/bin/roc experimental-lsp --debug-build --debug-transport --debug-syntax --debug-server &lt; crash.lsp\nroc-lsp logging to /tmp/roc-lsp-debug.log\nContent-Length: 177\n\n{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:0,&quot;result&quot;:{&quot;capabilities&quot;:{&quot;positionEncoding&quot;:&quot;utf-16&quot;,&quot;textDocumentSync&quot;:{&quot;openClose&quot;:true,&quot;change&quot;:2}},&quot;serverInfo&quot;:{&quot;name&quot;:&quot;roc-lsp&quot;,&quot;version&quot;:&quot;0.1&quot;}}}thread 203073 panic: [PRE check platform reqs] Arrays out of sync:\n type_nodes=0\n  region_nodes=38\n\n/home/lukas/code/30software/roc/src/check/Check.zig:255:28: 0x4965751 in checkPlatformRequirements (mod.zig)\n            std.debug.panic(\n                           ^\n[…]\n</code></pre></div>\n<p>but when I start this via <code>gdb ./zig-out/bin/roc</code>, I get:</p>\n<div class=\"codehilite\"><pre><span></span><code>Reading symbols from ./zig-out/bin/roc...\n(gdb) run experimental-lsp &lt; crash.lsp\nStarting program: /home/lukas/code/30software/roc/zig-out/bin/roc experimental-lsp &lt; crash.lsp\n[New LWP 203790]\n[LWP 203790 exited]\nContent-Length: 177\n\n{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:0,&quot;result&quot;:{&quot;capabilities&quot;:{&quot;positionEncoding&quot;:&quot;utf-16&quot;,&quot;textDocumentSync&quot;:{&quot;openClose&quot;:true,&quot;change&quot;:2}},&quot;serverInfo&quot;:{&quot;name&quot;:&quot;roc-lsp&quot;,&quot;version&quot;:&quot;0.1&quot;}}}thread 203685 panic: [PRE check platform reqs] Arrays out of sync:\n type_nodes=0\n  region_nodes=38\n\n[…backtrace from zig panic…]\n(gdb) f 7\n#7  0x0000000004965752 in Check.checkPlatformRequirements (self=0x7ffffffece60, platform_env=0x7ffff62e4f20, platform_to_app_idents=0x7ffffffee1d8)\n(gdb) list\n39      }\n40\n41      void __restore_sigs(void *set)\n42      {\n43              __syscall(SYS_rt_sigprocmask, SIG_SETMASK, set, 0, _NSIG/8);\n44      }\n</code></pre></div>\n<p>which is clearly not the source. I don't know how this is supposed to work under the hood, I'm just used to it „just working“ in the <code>gcc -g</code> world.</p>",
        "id": 567410744,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1768159169
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/channel/231634-beginners/topic/.60roc.20experimental-lsp.60.20crashes.3B.20bug.20in.20LSP.20or.20my.20code.3F/near/567257934\">said</a>:</p>\n<blockquote>\n<p>Either way you have definitely found a bug, if you wouldn't mind making a GH issue that'd be good <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>\n</blockquote>\n<p><a href=\"https://github.com/roc-lang/roc/issues/8995\">https://github.com/roc-lang/roc/issues/8995</a> now exists</p>",
        "id": 567411944,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1768160667
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"1006888\">@Lukas Juhrich</span>, looks like Richard fixed your issue :)<br>\nWe rarely use gdb so I'm not sure what's going wrong there.</p>\n<blockquote>\n<p>A big chunk of that seems to be building interpreter shims for all sorts of platforms (arm, wasm, …)</p>\n</blockquote>\n<p>Interesting, do you happen to know if this is necessary <span class=\"user-mention\" data-user-id=\"515757\">@Luke Boswell</span>?</p>",
        "id": 567542310,
        "sender_full_name": "Anton",
        "timestamp": 1768226640
    },
    {
        "content": "<p>Yes it's necessary to build the roc cli. Until we have the llvm backend we currently pre-built the interpreter into a shim and use that for <code>roc build</code>.</p>",
        "id": 567631488,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1768247770
    },
    {
        "content": "<p>So instead of linking the app which has been lowered to an object file with the host, we give the app in a serialised IR to our interpreter shim, and the platform host doesn't see anything different from a real compiled app.</p>",
        "id": 567631750,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1768247868
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/channel/231634-beginners/topic/.60roc.20experimental-lsp.60.20crashes.3B.20bug.20in.20LSP.20or.20my.20code.3F/near/567631750\">said</a>:</p>\n<blockquote>\n<p>So instead of linking the app which has been lowered to an object file with the host, we give the app in a serialised IR to our interpreter shim</p>\n</blockquote>\n<p>Oh, so because I can do cross compilation a la <code>roc build --target=&lt;something else&gt;</code>, by default we ship all the other shims, because I might build for arm even though I am on x86_64? Pretty cool that <code>roc build</code> supports cross compilation ootb like that.</p>\n<p>However,  but wouldn't it technically be possible to disable the cross compilation targets and just not build the <code>n-1</code> other shims?</p>",
        "id": 567649553,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1768254584
    },
    {
        "content": "<p>Yeah we could not build these and embed them in the cli binary -- which would disable <code>roc build</code>. Or only build for the current native machine and embed just that -- which would prevent cross-compilation. </p>\n<p>If it's not a major issue -- I'd prefer to leave it as is for now, as we are close enough to having an LLVM backend and removing all these shims anyway.</p>",
        "id": 567654854,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1768257100
    },
    {
        "content": "<p>I very strongly think we should consider cross compilation mandatory</p>",
        "id": 567655122,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1768257234
    },
    {
        "content": "<p>Yeah I was just thinking some kind of debug build flag here to speed up the loop for debugging things</p>",
        "id": 567655194,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1768257274
    },
    {
        "content": "<p>it's a major selling point of Go, and we've done a lot of work to make it possible; it would be a real shame to miss out on it at the very end by not including a few kilobytes of shims <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 567655215,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1768257286
    },
    {
        "content": "<p>oh sure, for debugging it's fine <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>",
        "id": 567655278,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1768257320
    },
    {
        "content": "<p>Oh, of course, I was only talking about a local debug build and trying to understand things, not suggesting anything else. Thanks for all the clarification!</p>",
        "id": 567695024,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1768287573
    }
]
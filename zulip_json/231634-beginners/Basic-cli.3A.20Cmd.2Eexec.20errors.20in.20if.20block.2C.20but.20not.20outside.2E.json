[
    {
        "content": "<p>So I've encountered what appears to be a bug in the <code>basic-cli</code> platform. I have an if block, in which I follow two nearly identical code paths depending on weather a file exists. I call <code>Cmd.exec! \"nano\" [\"filename.txt\"]</code>, and then continue with my program when the editor exits. </p>\n<p>This works fine, if I do not check for the file's existence ahead of time. However if I place the <code>Cmd.exec</code> call inside an if block, I get a <code>CmdError ExecutableFileBusy</code> error after the exec task completes.</p>\n<p>Code is below (note that the bugged version is uncommented, however the commented out code works):</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">main</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">    </span><span class=\"nv\">isFile</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">Path</span><span class=\"p\">.</span><span class=\"nx\">isFile</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">Path</span><span class=\"p\">.</span><span class=\"nx\">fromStr</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"o\">|&gt;</span><span class=\"w\"> </span><span class=\"nx\">Task</span><span class=\"p\">.</span><span class=\"nx\">attempt</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"nx\">res</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">when</span><span class=\"w\"> </span><span class=\"nx\">res</span><span class=\"w\"> </span><span class=\"o\">is</span>\n<span class=\"w\">                </span><span class=\"nx\">Ok</span><span class=\"w\"> </span><span class=\"nx\">bool</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Task</span><span class=\"p\">.</span><span class=\"nx\">ok</span><span class=\"w\"> </span><span class=\"nx\">bool</span>\n<span class=\"w\">                </span><span class=\"nx\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Task</span><span class=\"p\">.</span><span class=\"nx\">ok</span><span class=\"w\"> </span><span class=\"nx\">Bool</span><span class=\"p\">.</span><span class=\"nx\">false</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nx\">isFile</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"nx\">Stdout</span><span class=\"p\">.</span><span class=\"nx\">line</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"config file found\"</span>\n<span class=\"w\">        </span><span class=\"nx\">Cmd</span><span class=\"p\">.</span><span class=\"nx\">exec</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"nano\"</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"config.rvn\"</span><span class=\"p\">]</span>\n<span class=\"w\">        </span><span class=\"nv\">contents</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">File</span><span class=\"p\">.</span><span class=\"nx\">readUtf8</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span>\n<span class=\"w\">        </span><span class=\"nx\">Stdout</span><span class=\"p\">.</span><span class=\"nx\">line</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"file contents: $(contents)\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"nx\">Stdout</span><span class=\"p\">.</span><span class=\"nx\">line</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"config file not found\"</span>\n<span class=\"w\">        </span><span class=\"nx\">File</span><span class=\"p\">.</span><span class=\"nx\">writeUtf8</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span><span class=\"w\"> </span><span class=\"nx\">configTemplate</span>\n<span class=\"w\">        </span><span class=\"nx\">Cmd</span><span class=\"p\">.</span><span class=\"nx\">exec</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"nano\"</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"config.rvn\"</span><span class=\"p\">]</span>\n<span class=\"w\">        </span><span class=\"nv\">contents</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">File</span><span class=\"p\">.</span><span class=\"nx\">readUtf8</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span>\n<span class=\"w\">        </span><span class=\"nx\">Stdout</span><span class=\"p\">.</span><span class=\"nx\">line</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"file contents: $(contents)\"</span>\n\n<span class=\"c1\"># main =</span>\n<span class=\"c1\">#     File.writeUtf8! \"config.rvn\" configTemplate</span>\n<span class=\"c1\">#     Cmd.exec! \"nano\" [\"config.rvn\"]</span>\n<span class=\"c1\">#     contents = File.readUtf8! \"config.rvn\"</span>\n<span class=\"c1\">#     Stdout.line! \"file contents: $(contents)\"</span>\n</code></pre></div>\n<p>The bug happens for both basic-cli <code>v0.10.0</code> and <code>v0.11.0</code>.</p>",
        "id": 440658123,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1716664854
    },
    {
        "content": "<p>I'm guessing Path.isFile isn't finished with the file handle before the Cmd.exec runs. What happens if you add a small sleep in there?</p>",
        "id": 440658545,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716665264
    },
    {
        "content": "<p>Good question... I'll check. I should also note that the following works:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">main</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">    </span><span class=\"nx\">createFileIfNone</span><span class=\"o\">!</span>\n<span class=\"w\">    </span><span class=\"nx\">File</span><span class=\"p\">.</span><span class=\"nx\">writeUtf8</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span><span class=\"w\"> </span><span class=\"nx\">configTemplate</span>\n<span class=\"w\">    </span><span class=\"nx\">Cmd</span><span class=\"p\">.</span><span class=\"nx\">exec</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"nano\"</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"config.rvn\"</span><span class=\"p\">]</span>\n<span class=\"w\">    </span><span class=\"nv\">contents</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">File</span><span class=\"p\">.</span><span class=\"nx\">readUtf8</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span>\n<span class=\"w\">    </span><span class=\"nx\">Stdout</span><span class=\"p\">.</span><span class=\"nx\">line</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"s\">\"file contents: $(contents)\"</span>\n\n<span class=\"nv\">createFileIfNone</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">    </span><span class=\"nv\">isFile</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">Path</span><span class=\"p\">.</span><span class=\"nx\">isFile</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">Path</span><span class=\"p\">.</span><span class=\"nx\">fromStr</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"o\">|&gt;</span><span class=\"w\"> </span><span class=\"nx\">Task</span><span class=\"p\">.</span><span class=\"nx\">attempt</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"nx\">res</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">when</span><span class=\"w\"> </span><span class=\"nx\">res</span><span class=\"w\"> </span><span class=\"o\">is</span>\n<span class=\"w\">                </span><span class=\"nx\">Ok</span><span class=\"w\"> </span><span class=\"nx\">bool</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Task</span><span class=\"p\">.</span><span class=\"nx\">ok</span><span class=\"w\"> </span><span class=\"nx\">bool</span>\n<span class=\"w\">                </span><span class=\"nx\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Task</span><span class=\"p\">.</span><span class=\"nx\">ok</span><span class=\"w\"> </span><span class=\"nx\">Bool</span><span class=\"p\">.</span><span class=\"nx\">false</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nx\">isFile</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"nx\">File</span><span class=\"p\">.</span><span class=\"nx\">writeUtf8</span><span class=\"w\"> </span><span class=\"s\">\"config.rvn\"</span><span class=\"w\"> </span><span class=\"nx\">configTemplate</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"nx\">Task</span><span class=\"p\">.</span><span class=\"nx\">ok</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n</code></pre></div>",
        "id": 440658745,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1716665465
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/basic-cli/blob/592a4a950e16c09c205e298f272381102f49f756/platform/src/lib.rs#L502\">https://github.com/roc-lang/basic-cli/blob/592a4a950e16c09c205e298f272381102f49f756/platform/src/lib.rs#L502</a></p>",
        "id": 440658822,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716665530
    },
    {
        "content": "<p>Here'd the specific implementation of that Path.isFile effect</p>",
        "id": 440658834,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716665549
    },
    {
        "content": "<p>I’m computer right now so can’t test sleep immediately, but I should also mention, even in the bugged code, File.write successfully creates the file, and nano is able to open the newly created file.</p>",
        "id": 440659096,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1716665806
    },
    {
        "content": "<p>Interesting. Seems a bit strange. Maybe we could provide more context back in the error. Worth looking into as well. Or adding some dbg statements in the platform.</p>",
        "id": 440659241,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716665932
    },
    {
        "content": "<p>Ok, yes, adding a 1ms sleep does resolve the issue. Interesting, because I put the sleep immediately before <code>Cmd.exec</code>, and after <code>File.writeUtf8</code>.</p>",
        "id": 440661756,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1716668678
    },
    {
        "content": "<p>So file.write does not conflict with the exec command, and regardless of how I write this code, nano always successfully opens the file: </p>\n<ul>\n<li>if the file does not exist and I do not create file before launching nano</li>\n<li>if the file does not exist and I do create the file</li>\n<li>if the file does exist</li>\n</ul>\n<p>However, if I call exec inside of the if block, after nano exits, I see that the roc program crashed. But no crash occurs if</p>\n<ul>\n<li>I do not check for the file, but always create a new file</li>\n<li>I do not check for the file, but always launch the editor</li>\n<li>I do check for the file, but put the exec call outside the conditional block</li>\n<li>I do check for the file, and the exec call is inside the if block, but a 1ms sleep immediately precedes exec.</li>\n</ul>",
        "id": 440662188,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1716669149
    }
]
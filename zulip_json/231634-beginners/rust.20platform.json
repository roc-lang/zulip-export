[
    {
        "content": "<p>Hi, I'm new here and started playing around with the example rust-platform. I am getting a compiler error now. I know that I broke the platform by changing the <code>rust-platform/main.roc</code> file. Is it expected that I get</p>\n<blockquote>\n<p>An internal compiler expectation was broken.<br>\nThis is definitely a compiler bug.<br>\nPlease file an issue here: <a href=\"https://github.com/roc-lang/roc/issues/new/choose\">https://github.com/roc-lang/roc/issues/new/choose</a></p>\n</blockquote>\n<p>in this case or should I actually report?</p>",
        "id": 439673522,
        "sender_full_name": "Max",
        "timestamp": 1716236637
    },
    {
        "content": "<p>It's hard to answer your question without more context. Are you able to share the error message? It may already be a known issue.</p>",
        "id": 439685490,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716241452
    },
    {
        "content": "<p>Sure. I would give more details when filing an issue, but I can of course also do that here :) I forked and committed my changes: <a href=\"https://github.com/roc-lang/roc/compare/main...mx-ws:roc:main\">https://github.com/roc-lang/roc/compare/main...mx-ws:roc:main</a></p>\n<p>Basically I just played with the requires of the platform, changed main to mai, then did not provide it and changed types. Here is the output of <code>RUST_BACKTRACE=full roc rocLovesRust.roc</code> inside the <code>platform-switching</code> directory:</p>\n<div class=\"codehilite\"><pre><span></span><code>mxw@MacBook-Pro platform-switching % RUST_BACKTRACE=full roc rocLovesRust.roc\nAn internal compiler expectation was broken.\nThis is definitely a compiler bug.\nPlease file an issue here: https://github.com/roc-lang/roc/issues/new/choose\nthread &#39;main&#39; panicked at crates/compiler/module/src/symbol.rs:153:13:\nident_string&#39;s IdentIds did not contain an entry for 1 in module 17\nstack backtrace:\n   0:        0x104f4c54c - __mh_execute_header\n   1:        0x10439d4cc - __mh_execute_header\n   2:        0x104f48530 - __mh_execute_header\n   3:        0x104f4c344 - __mh_execute_header\n   4:        0x104f4da60 - __mh_execute_header\n   5:        0x104f4d75c - __mh_execute_header\n   6:        0x104f4e064 - __mh_execute_header\n   7:        0x104f4de40 - __mh_execute_header\n   8:        0x104f4c9e4 - __mh_execute_header\n   9:        0x104f4dbd4 - __mh_execute_header\n  10:        0x1066297dc - __ZN4llvm15SmallVectorBaseIyE8grow_podEPvmm\n  11:        0x104a8dde4 - __mh_execute_header\n  12:        0x104d914a4 - __mh_execute_header\n  13:        0x104d55914 - __mh_execute_header\n  14:        0x10459ea7c - __mh_execute_header\n  15:        0x10468f608 - __mh_execute_header\n  16:        0x1045573c0 - __mh_execute_header\n  17:        0x1045356c4 - __mh_execute_header\n  18:        0x1045356e8 - __mh_execute_header\n  19:        0x104f405e8 - __mh_execute_header\n  20:        0x10455a52c - __mh_execute_header\n</code></pre></div>",
        "id": 439686876,
        "sender_full_name": "Max",
        "timestamp": 1716242144
    },
    {
        "content": "<p>Ideally roc should give a nice error instead of crashing. Though this is a more advanced use case because you are doing platform development.</p>\n<p>There's not a lot of documentation, so it's harder to get started developing platforms.</p>\n<p>Just wondering what your objective is here?</p>",
        "id": 439697611,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716246782
    },
    {
        "content": "<p>If you change the type on mainForHost back to Str I think it should work for you</p>",
        "id": 439698071,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716247016
    },
    {
        "content": "<p>The host is still expecting a RocStr from roc. If you want to change that you will need to change the API in <code>lib.rs</code></p>",
        "id": 439698239,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1716247091
    },
    {
        "content": "<p>My long/midterm goal would be that I can compile code at runtime as some kind of service. Say I expect the User to give me a string that compiles as a roc program. I would want to define a type <code>Html</code> and require the Users program to provide a<code>html: Html</code>. Here I feel like I have to decide whether I want to deal with the <code>Html</code> type in the platform I'm writing (I haven't looked into this) or if this is possible from roc. I hoped for the latter, so my naive idea would be that I still require <code>html: Html</code>. But in order that my platform just has to deal with a String, I would write a function <code>htmlToString: Html -&gt; String</code> und have <code>mainForHost: String</code> and <code>mainForHost = htmlToString html</code>.</p>",
        "id": 439746993,
        "sender_full_name": "Max",
        "timestamp": 1716275731
    },
    {
        "content": "<p>Yeah, you definitely should be able to do that</p>",
        "id": 440296686,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1716461497
    },
    {
        "content": "<p>In your simple example with <code>Bool</code>, you have</p>\n<div class=\"codehilite\"><pre><span></span><code>mainForHost : Bool\n</code></pre></div>\n<p>This is the wrong type. Should be <code>Str</code> still.</p>\n<p>That may be the root cause of the crash. Not fully sure though.</p>",
        "id": 440297017,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1716461630
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/stream/231634-beginners/topic/rust.20platform/near/440296686\">schrieb</a>:</p>\n<blockquote>\n<p>Yeah, you definitely should be able to do that</p>\n</blockquote>\n<p>You are right, I just compiled with <code>main: Bool</code> and <code>mainToHost: Str</code> and it worked! I was sure I already tried that without success, but I must have just done a mistake there =)</p>\n<p>I still filed the issue in case we don't want that compiler error. But very happy to know I will be able to do what I was hoping to =)</p>",
        "id": 440570886,
        "sender_full_name": "Max",
        "timestamp": 1716581364
    }
]
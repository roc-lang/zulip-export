[
    {
        "content": "<p>I have encountered a crash (Segmentation fault) in my program which I suppose is a stack overflow.</p>\n<p>There is a recursive function which returns a <code>Result</code>. Superficially, it looks like tail recursion, but really because of the backpassing I think it isn't, because the recursive call happens in a callback.</p>\n<p>I have reduced it to this contrived example:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">app</span><span class=\"w\"> </span><span class=\"s\">\"test\"</span>\n<span class=\"w\">    </span><span class=\"nv\">packages</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nv\">pf</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"s\">\"https://github.com/roc-lang/basic-cli/releases/download/0.7.0/bkGby8jb0tmZYsy2hg1E_B2QrCgcSTxdUlHtETwm5m4.tar.br\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"nv\">imports</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nv\">pf</span><span class=\"nf\">.</span><span class=\"kt\">Stdout</span><span class=\"p\">]</span>\n<span class=\"w\">    </span><span class=\"nv\">provides</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nv\">main</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"nv\">to</span><span class=\"w\"> </span><span class=\"nv\">pf</span>\n\n<span class=\"kr\">main </span><span class=\"nf\">=</span>\n<span class=\"w\">    </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">        </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"kt\">Bool</span><span class=\"nf\">.</span><span class=\"nv\">false</span><span class=\"w\"> </span><span class=\"kr\">then</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"nf\">==</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"kr\">then</span>\n<span class=\"w\">            </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"kt\">FiveIsForbidden</span>\n<span class=\"w\">        </span><span class=\"kr\">else</span>\n<span class=\"w\">            </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">x</span>\n\n<span class=\"w\">    </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">        </span><span class=\"nv\">dbg</span><span class=\"w\"> </span><span class=\"nv\">count</span>\n<span class=\"w\">        </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"kt\">Bool</span><span class=\"nf\">.</span><span class=\"nv\">false</span><span class=\"w\"> </span><span class=\"kr\">then</span><span class=\"w\"> </span><span class=\"err\">#</span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">==</span><span class=\"w\"> </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"kr\">then</span>\n<span class=\"w\">            </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">count</span>\n<span class=\"w\">        </span><span class=\"kr\">else</span>\n<span class=\"w\">            </span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">&lt;-</span><span class=\"w\"> </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span>\n<span class=\"w\">            </span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">&lt;-</span><span class=\"w\"> </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span>\n<span class=\"w\">            </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"w\">    </span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">        </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"w\"> </span><span class=\"s\">\"Ok\"</span>\n<span class=\"w\">        </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"w\"> </span><span class=\"s\">\"Err\"</span>\n</code></pre></div>\n<p>The function is supposed to loop until a result is found (<code>count == 1000</code>) or until an error occurs (<code>x == 5</code>). If neither happens (<code>Bool.false</code>) then it will crash.</p>\n<p>What would be an idiomatic way to solve this with tail recursion? I suppose there is no other equivalent to a <code>while</code> loop.</p>\n<p>(There are multiple <code>Result.try</code> lines so I would like to avoid the nested <code>when</code> indentation levels.)</p>",
        "id": 410483822,
        "sender_full_name": "mkrieger1",
        "timestamp": 1703888352
    },
    {
        "content": "<p>Instead of using Result.try, you could put the two results in a tuple and then pattern match on the case where both are Ok, and do the tail recursion there.</p>",
        "id": 410486746,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1703890742
    },
    {
        "content": "<p>Oh no wait, the checks are chained, you can't do that!</p>",
        "id": 410486791,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1703890797
    },
    {
        "content": "<p>You're going to need to get a result as an intermediate value and then match on it so that the recursion is not in a callback.</p>",
        "id": 410487064,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1703890925
    },
    {
        "content": "<p>All \"looping\" in a pure functional language is necessarily recursive. If you wanted a for loop then there's almost certainly a function you can use in it's place- <code>map</code>, <code>keepIf</code>, <code>walk</code>, etc. I would assume that the standard library is implemented with loops because you can't actually tell how they're implemented while using it, and loops are faster, but some other pure FP languages without performance as a key goal will use recursion.<br>\nWith that in mind, if you want a while loop then you're correct in assuming you need recursion- that's the only way to loop. You're also correct in assuming that a function must be tail recursive in order to make it a viable solution, without tail call optimization a pure function pl would be a potato.</p>\n<p>Tail call optimization can only occur if the final expression is the recursive call*. The final expression in your step function isn't the recursive call, it's this (which I have desugared because that makes it a bit more obvious)-</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">  </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<p>So while evaluating this function, the program will need to remember the call stack to evaluate the <code>Result.try</code> statements. If you want it to be tail recursive you could write something more like this</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"kt\">Int</span><span class=\"w\"> </span><span class=\"nv\">a</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">Int</span><span class=\"w\"> </span><span class=\"nv\">a</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"kt\">FiveIsForbidden</span><span class=\"p\">]</span>\n<span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">  </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">x</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">    </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"kt\">Bool</span><span class=\"nf\">.</span><span class=\"nv\">false</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"kt\">FiveIsForbidden</span>\n<span class=\"w\">    </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">x</span>\n\n<span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"kt\">Nat</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"kt\">Nat</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"kt\">FiveIsForbidden</span><span class=\"p\">]</span>\n<span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">  </span><span class=\"nv\">dbg</span><span class=\"w\"> </span><span class=\"nv\">count</span>\n<span class=\"w\">  </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">    </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"kt\">Bool</span><span class=\"nf\">.</span><span class=\"nv\">false</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">count</span>\n<span class=\"w\">    </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">      </span><span class=\"nv\">secondCheckResult</span><span class=\"w\"> </span><span class=\"nf\">=</span>\n<span class=\"w\">        </span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">&lt;-</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">firstCheck</span>\n\n<span class=\"w\">      </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">secondCheckResult</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">        </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nv\">secondCheckResult</span>\n<span class=\"w\">        </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">          </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"kr\">main </span><span class=\"nf\">=</span>\n<span class=\"w\">  </span><span class=\"nv\">output</span><span class=\"w\"> </span><span class=\"nf\">=</span>\n<span class=\"w\">    </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">      </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"s\">\"Ok\"</span>\n<span class=\"w\">      </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"s\">\"Err\"</span>\n<span class=\"w\">  </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"w\"> </span><span class=\"nv\">output</span>\n</code></pre></div>\n<p>I've changed some stylistic stuff because Roc is fun like that but the key here is that now the recursive <code>step (secondCheck + 1)</code> is the final expression in the function. When we go to evaluate this function, we can now forget the call stack and just evaluate <code>step (secondCheck + 1)</code>, hence we can optimize it into a loop.</p>\n<p>If you want a better understanding of tail call optimization (and you're okay with a bit of scheme) the Structure and Interpretation of Computer Programs (SICP) has a really good explanation of tail call optimization in <a href=\"https://web.mit.edu/6.001/6.037/sicp.pdf\">Chapter 1.2.1</a>.</p>\n<p>*technically Roc has \"tail recursion modulo cons\" which means that you can do some operations after the recursive call and it will still tail call optimize, but it's easier to understand if we just assume it isn't.</p>",
        "id": 410487151,
        "sender_full_name": "Fletch Canny",
        "timestamp": 1703890997
    },
    {
        "content": "<p>We have a bug currently that leads to allocating stack space in tail recursive functions.</p>",
        "id": 410487550,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703891331
    },
    {
        "content": "<p>So tail recursive functions can still stack overflow. Not sure this is what is being hit here, would need to dig in more. But often that leads to a segfault</p>",
        "id": 410487688,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703891452
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/stream/231634-beginners/topic/Tail.20recursion.20and.20Result.2Etry/near/410487550\">said</a>:</p>\n<blockquote>\n<p>We have a bug currently that leads to allocating stack space in tail recursive functions.</p>\n</blockquote>\n<p>Yeah when I run the program it just crashes with no output lol. Does the \"modulo cons\" part of Rocs tail call optimization include this case? I don't fully understand that aspect of it yet. Seeing as Roc's <code>List</code> is an array I find it unlikely that it literally only works for <code>List.append</code>.</p>",
        "id": 410487719,
        "sender_full_name": "Fletch Canny",
        "timestamp": 1703891486
    },
    {
        "content": "<p>Or I guess cons would be <code>List.prepend</code>, which makes even less sense</p>",
        "id": 410487798,
        "sender_full_name": "Fletch Canny",
        "timestamp": 1703891551
    },
    {
        "content": "<p>IIUC, The cons stuff isn't for list at all. Just tags and other constructors of that sense</p>",
        "id": 410487969,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703891728
    },
    {
        "content": "<p>Doesn't apply to lists cause they aren't recursive types</p>",
        "id": 410487985,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703891749
    },
    {
        "content": "<p>Oh so it's for recursive types, like <code>List</code> in every other <code>ML</code>. Makes sense.</p>",
        "id": 410488050,
        "sender_full_name": "Fletch Canny",
        "timestamp": 1703891789
    },
    {
        "content": "<p>Yep</p>",
        "id": 410488054,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703891796
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"569850\">Fletch Canny</span> <a href=\"#narrow/stream/231634-beginners/topic/Tail.20recursion.20and.20Result.2Etry/near/410487151\">said</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"w\">    </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">      </span><span class=\"nv\">secondCheckResult</span><span class=\"w\"> </span><span class=\"nf\">=</span>\n<span class=\"w\">        </span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">&lt;-</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">firstCheck</span>\n\n<span class=\"w\">      </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">secondCheckResult</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">        </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nv\">secondCheckResult</span>\n<span class=\"w\">        </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">          </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>Nice, so I think I <em>can</em> use <code>Result.try</code> for the first <em>n</em>â€“1 results and only have to use <code>when</code> for the last one.</p>",
        "id": 410488077,
        "sender_full_name": "mkrieger1",
        "timestamp": 1703891829
    },
    {
        "content": "<p>Can someone add the segfaulting example to <a href=\"https://github.com/roc-lang/roc/issues/6213\">https://github.com/roc-lang/roc/issues/6213</a></p>\n<p>I'll test if it is the same issue when I have time.</p>",
        "id": 410488305,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703892046
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span>  I don't think what I described is a bug in Roc, it's a bug in my program (or are you saying that my original code <em>shouldn't</em> segfault?)</p>",
        "id": 410488416,
        "sender_full_name": "mkrieger1",
        "timestamp": 1703892152
    },
    {
        "content": "<p>Oh, cause backpassing it isn't actually tail recursive is it?</p>",
        "id": 410488474,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703892222
    },
    {
        "content": "<p>If that is the case, then definitely not the bug</p>",
        "id": 410488483,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703892235
    },
    {
        "content": "<p>Just was confused</p>",
        "id": 410488532,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1703892251
    },
    {
        "content": "<p>But maybe such an example can be considered as \"gotcha\" for <a class=\"stream-topic\" data-stream-id=\"304902\" href=\"/#narrow/stream/304902-show-and-tell/topic/article.20about.20looping.20in.20Roc\">#show and tell &gt; article about looping in Roc</a></p>",
        "id": 410488721,
        "sender_full_name": "mkrieger1",
        "timestamp": 1703892433
    },
    {
        "content": "<p>Or maybe the stdlib could have something like <a href=\"https://www.roc-lang.org/packages/basic-cli/Task#loop\">https://www.roc-lang.org/packages/basic-cli/Task#loop</a> but without <code>Task</code>.</p>",
        "id": 410489176,
        "sender_full_name": "mkrieger1",
        "timestamp": 1703892857
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/stream/231634-beginners/topic/Tail.20recursion.20and.20Result.2Etry/near/410488474\">said</a>:</p>\n<blockquote>\n<p>Oh, cause backpassing it isn't actually tail recursive is it?</p>\n</blockquote>\n<p>Yeah I don't see how you could TCO when the recursive call is in a lambda. That would be mutually recursive TCO. Sounds like a mess, so I doubt that it's a bug that Roc doesn't.</p>",
        "id": 410490606,
        "sender_full_name": "Fletch Canny",
        "timestamp": 1703893976
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"672355\">mkrieger1</span> <a href=\"#narrow/stream/231634-beginners/topic/Tail.20recursion.20and.20Result.2Etry/near/410489176\">said</a>:</p>\n<blockquote>\n<p>Or maybe the stdlib could have something like <a href=\"https://www.roc-lang.org/packages/basic-cli/Task#loop\">https://www.roc-lang.org/packages/basic-cli/Task#loop</a> but without <code>Task</code>.</p>\n</blockquote>\n<p>I tried it:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">loop</span><span class=\"w\"> </span><span class=\"nf\">:</span>\n<span class=\"w\">    </span><span class=\"nv\">state</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">state</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"kt\">Continue</span><span class=\"w\"> </span><span class=\"nv\">state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Break</span><span class=\"w\"> </span><span class=\"nv\">done</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"nv\">err</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"nv\">done</span><span class=\"w\"> </span><span class=\"nv\">err</span>\n<span class=\"nv\">loop</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"nv\">init</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"nv\">state</span>\n\n<span class=\"w\">    </span><span class=\"nv\">recurse</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">        </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">            </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"nv\">e</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"nv\">e</span>\n<span class=\"w\">            </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">Break</span><span class=\"w\"> </span><span class=\"nv\">v</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">v</span>\n<span class=\"w\">            </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">Continue</span><span class=\"w\"> </span><span class=\"nv\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nv\">step</span><span class=\"w\"> </span><span class=\"nv\">s</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"nv\">recurse</span>\n\n<span class=\"w\">    </span><span class=\"nv\">recurse</span><span class=\"w\"> </span><span class=\"nv\">init</span>\n</code></pre></div>\n<p>Then the above example would look like:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"kr\">main </span><span class=\"nf\">=</span>\n<span class=\"w\">    </span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nf\">=</span><span class=\"w\"> </span><span class=\"nv\">loop</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"nf\">\\</span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">        </span><span class=\"nv\">dbg</span><span class=\"w\"> </span><span class=\"nv\">count</span>\n<span class=\"w\">        </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">            </span><span class=\"mi\">1000</span><span class=\"w\"> </span><span class=\"kr\">if</span><span class=\"w\"> </span><span class=\"kt\">Bool</span><span class=\"nf\">.</span><span class=\"nv\">false</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">                </span><span class=\"kt\">Break</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Ok</span>\n<span class=\"w\">            </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">                </span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">&lt;-</span><span class=\"w\"> </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">count</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span>\n<span class=\"w\">                </span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">&lt;-</span><span class=\"w\"> </span><span class=\"nv\">canFail</span><span class=\"w\"> </span><span class=\"nv\">firstCheck</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"nf\">.</span><span class=\"nv\">try</span>\n<span class=\"w\">                </span><span class=\"kt\">Continue</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">secondCheck</span><span class=\"w\"> </span><span class=\"nf\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nf\">|&gt;</span><span class=\"w\"> </span><span class=\"kt\">Ok</span>\n\n<span class=\"w\">    </span><span class=\"nv\">when</span><span class=\"w\"> </span><span class=\"nv\">result</span><span class=\"w\"> </span><span class=\"nv\">is</span>\n<span class=\"w\">        </span><span class=\"kt\">Ok</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"w\"> </span><span class=\"s\">\"Ok\"</span>\n<span class=\"w\">        </span><span class=\"kt\">Err</span><span class=\"w\"> </span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">Stdout</span><span class=\"nf\">.</span><span class=\"nv\">line</span><span class=\"w\"> </span><span class=\"s\">\"Err\"</span>\n</code></pre></div>",
        "id": 410493282,
        "sender_full_name": "mkrieger1",
        "timestamp": 1703895723
    },
    {
        "content": "<p>I really like how Roc makes the connection between imperative loops and <code>walk</code> much more obvious. Structural sum types are so awesome.</p>",
        "id": 410493546,
        "sender_full_name": "Fletch Canny",
        "timestamp": 1703895852
    }
]
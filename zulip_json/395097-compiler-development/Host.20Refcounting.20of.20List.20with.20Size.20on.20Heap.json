[
    {
        "content": "<p>So one piece that is gonna be more annoying to design around is the host language specific libraries. One important piece of this change is that knowledge around refcounting is even more ingrained into the handling of a list. My thought is to essentially add a trait (rust)/comptime function (zig) (will need to be generated by glue) on each roc type to specify if it is refcounted or not. It will also contain an inc and dec function. This is definitely a case where it will suck to duplicate this logic into each host language. It would be nicer if roc could expose the inc and dec functions for every single type exposed via the host api (just to makes sure the function is always correct), but that is probably a lot more work to enable.</p>\n<p>Note: lists in host specific libraries should really know about this anyway. It is required if you ever want to properly interact with a list of refcounted roc things instead of simply deallocate it.</p>\n<p>Any general thoughts on this?</p>\n<p>Relatedly, once we have explicit allocators, a drop function in rust won't be possible anymore. All drops will need the allocator passed in, which is incompatible with rusts drop api.</p>\n<p>Part of me thinks that it may be worth analyzing the host api and exposing all of the primitives from roc to the host. That way the logic is all centralized in roc. Don't need to expose all functions, but the complex underlying pieces around refcounting and getting access to the data.</p>",
        "id": 431538049,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712327910
    },
    {
        "content": "<p>I hit this cause freeing a list now requires knowing whether or not the elements in the list are refcounted.</p>",
        "id": 431538141,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712327939
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/stream/395097-compiler-development/topic/Host.20Refcounting/near/431538049\">said</a>:</p>\n<blockquote>\n<p>Relatedly, once we have explicit allocators, a drop function in rust won't be possible anymore. All drops will need the allocator passed in, which is incompatible with rusts drop api.</p>\n</blockquote>\n<p>that's a great point - they should probably all be <code>ManuallyDrop</code> anyway</p>",
        "id": 431578735,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1712340083
    },
    {
        "content": "<p>but exposing <code>dealloc</code> methods for convenience, which accept an allocator</p>",
        "id": 431578810,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1712340112
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/stream/395097-compiler-development/topic/Host.20Refcounting/near/431538049\">said</a>:</p>\n<blockquote>\n<p>My thought is to essentially add a trait (rust)/comptime function (zig) (will need to be generated by glue) on each roc type to specify if it is refcounted or not. It will also contain an inc and dec function.</p>\n</blockquote>\n<p>couldn't the inc/dec functions always be there, but sometimes be no-ops?</p>",
        "id": 431578948,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1712340158
    },
    {
        "content": "<p>It's fine if the functions are always there, but not particularly useful. We need to know if the elements are refcounted. So it would then be inc, dec, and is_refcounted on every type.</p>",
        "id": 431579445,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712340340
    },
    {
        "content": "<p>Is the element type is refcounted, we have to store the full list length on the heap so that a seamless slice can free the elements in the underlying list.</p>",
        "id": 431579560,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712340378
    },
    {
        "content": "<p>Cause the slice may not reference all elements.</p>",
        "id": 431579661,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712340417
    },
    {
        "content": "<p>Instead of changing all lists to have space to store the full list length on the heap, only lists with refcounted elements are changed.</p>",
        "id": 431579746,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712340452
    },
    {
        "content": "<p>Huh, I don't think rust can do what I wanted without an unstable feature. I was thinking of essentially:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"nb\">Drop</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>\n<span class=\"k\">where</span>\n<span class=\"w\">    </span><span class=\"n\">T</span>: <span class=\"nc\">RocRefcounted</span><span class=\"p\">,</span>\n<span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"c1\">// impl with refcounting.</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"nb\">Drop</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>\n<span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"c1\">// impl without refcounting.</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 431582164,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712341493
    },
    {
        "content": "<p>There is a way to make this work in stable rust, but it is definitely odd... <a href=\"https://github.com/dtolnay/case-studies/blob/master/autoref-specialization/README.md\">https://github.com/dtolnay/case-studies/blob/master/autoref-specialization/README.md</a></p>",
        "id": 431585307,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712342858
    },
    {
        "content": "<p>If I understand correctly, which I totally might not, the autoref thing doesn't work generic types that implement other traits. So it wouldn't work with <code>RocList&lt;T&gt;</code>.</p>\n<p>So I guess my current proposal here to simply get something in is:<br>\n1) Add a <code>RocRefcounted</code> trait</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">RocRefcounted</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">inc</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">n</span>: <span class=\"kt\">usize</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span> <span class=\"nf\">dec</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"k\">fn</span> <span class=\"nf\">is_refcounted</span><span class=\"p\">()</span><span class=\"w\"> </span>-&gt; <span class=\"kt\">bool</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>2) Force all list element types to implement the trait</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span> <span class=\"nc\">RocList</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>\n<span class=\"k\">where</span>\n<span class=\"w\">    </span><span class=\"n\">T</span>: <span class=\"nc\">RocRefcounted</span>\n<span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>3) Use a macro to implement <code>RocRefcounted</code> as a no-op for all of the stardard rust types (integers mostly, but anything that might be in a <code>RocList</code> that is part of the rust std).</p>\n<p>4) Write implementations of <code>RocRefcounted</code> for the types in <code>roc_std</code> (<code>RocStr</code>, <code>RocList</code>, etc)</p>\n<p>5) Update <code>RustGlue.roc</code> to generate an implementation for all generated types.</p>\n<p>6) With <code>RocRefcounted</code> implemented everywhere, types will be usable with <code>RocList</code> and <code>RocList</code> will be able to proper deal with all refcounting and deallocation stuff.</p>",
        "id": 431590814,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712345201
    },
    {
        "content": "<p>This is what requiring <code>RocRefcounted</code> looks like: <a href=\"https://github.com/roc-lang/roc/commit/05fb172348b9520a8500ed5ca618d9423068dc41\">https://github.com/roc-lang/roc/commit/05fb172348b9520a8500ed5ca618d9423068dc41</a></p>\n<p>I am not exactly a fan, but it seems to be the most practical solution currently....</p>\n<p>Ideas very welcome.</p>",
        "id": 431623919,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712364752
    },
    {
        "content": "<p>Oh, also with this change, only 19 failing tests in the full test_gen for llvm:</p>\n<div class=\"codehilite\"><pre><span></span><code>1277 tests run: 1258 passed, 19 failed, 19 skipped\n</code></pre></div>\n<p>Still probably many memory leaks/mistakes/other bugs...and two other backends, but almost to parity for llvm backend.</p>",
        "id": 431623977,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712364827
    },
    {
        "content": "<p>Progress... <span aria-label=\"hundred\" class=\"emoji emoji-1f4af\" role=\"img\" title=\"hundred\">:hundred:</span>% passing test-gen-llvm</p>\n<div class=\"codehilite\"><pre><span></span><code>Summary [ 167.284s] 1277 tests run: 1277 passed, 19 skipped\n</code></pre></div>\n<p>Still need to:</p>\n<ol>\n<li>Update <code>RustGlue.roc</code> to generate  <code>RocRefcounted</code> for all types. Still kinda want a different solution than <code>RocRefcounted</code>, but it works.</li>\n<li>Make sure all the examples work without memory leaks.</li>\n<li>Update the dev backend</li>\n<li>Update the wasm backend</li>\n</ol>",
        "id": 431805063,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712515346
    },
    {
        "content": "<p>Will be interesting once I have this wired up E2E and can actually measure the perf difference for something like <code>Dict Str U64</code>. Should be huge!</p>",
        "id": 431805112,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712515419
    },
    {
        "content": "<p>So I just manually did some wiring up to get the examples working and make it so that I can test the perf gains.</p>\n<p>Wrote a really simple app. Just counts word occurrences in text. The text is 43MB. I basically wrote an implementation of this blog: <a href=\"https://benhoyt.com/writings/count-words/\">https://benhoyt.com/writings/count-words/</a> in roc. Though I skipped the lowercasing and I didn't try to optimize it at all.</p>\n<p>Anyway....the perf diff:</p>\n<p>Current main: 59min<br>\nThis branch: 1.6s</p>\n<p>So ~2,200 times faster.</p>\n<p>For more reasonable perf rough benchmark, I ran an equivalent go and python implementation. For this test though, I removed the sorting (we have a bug that hurts sorting perf). Just counting and printing. Loading the file in bulk in all languages. So pretty apples to apples...we do eh, ok-ish.</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">Benchmark 1: ./count-go</span>\n<span class=\"go\">  Time (mean ± σ):     348.6 ms ±   3.4 ms    [User: 366.8 ms, System: 47.4 ms]</span>\n<span class=\"go\">  Range (min … max):   344.4 ms … 353.6 ms    10 runs</span>\n\n<span class=\"go\">Benchmark 2: ./count-roc</span>\n<span class=\"go\">  Time (mean ± σ):     769.8 ms ±   7.0 ms    [User: 746.0 ms, System: 19.5 ms]</span>\n<span class=\"go\">  Range (min … max):   760.3 ms … 782.5 ms    10 runs</span>\n\n<span class=\"go\">Benchmark 3: python /tmp/count.py</span>\n<span class=\"go\">  Time (mean ± σ):      1.026 s ±  0.030 s    [User: 0.930 s, System: 0.085 s]</span>\n<span class=\"go\">  Range (min … max):    0.991 s …  1.086 s    10 runs</span>\n\n<span class=\"go\">Summary</span>\n<span class=\"go\">  './count-go' ran</span>\n<span class=\"go\">    2.21 ± 0.03 times faster than './count-roc'</span>\n<span class=\"go\">    2.94 ± 0.09 times faster than 'python /tmp/count.py'</span>\n</code></pre></div>\n<p>Haven't done any analysis as to why we are 2.2x slower than Go. Might be a bad implementation of <code>splitWhiteSpace</code> on my part (probably this I think I am doing extra unicode verification that is costing, why a builtin may be needed here). Might be needing borrow inference to get some refcounting out of hot loops. Might be other dictionary perf issues.</p>\n<p>We do at least use way less memory:<br>\nRoc: 85MB<br>\nGo: 213MB<br>\nPython: 588MB</p>",
        "id": 431994479,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712588771
    },
    {
        "content": "<p><a href=\"/user_uploads/22008/jvwp4NJW8i74f0tJD39ge1qi/Screenshot-2024-04-08-at-11.07.27AM.png\">Screenshot-2024-04-08-at-11.07.27AM.png</a><br>\n<span aria-label=\"rolling on the floor laughing\" class=\"emoji emoji-1f923\" role=\"img\" title=\"rolling on the floor laughing\">:rolling_on_the_floor_laughing:</span></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/jvwp4NJW8i74f0tJD39ge1qi/Screenshot-2024-04-08-at-11.07.27AM.png\" title=\"Screenshot-2024-04-08-at-11.07.27AM.png\"><img src=\"/user_uploads/22008/jvwp4NJW8i74f0tJD39ge1qi/Screenshot-2024-04-08-at-11.07.27AM.png\"></a></div>",
        "id": 431994905,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1712588856
    },
    {
        "content": "<p>amazing work <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span>!!!!</p>",
        "id": 431995313,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1712588921
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span> do you have borrow inference far enough on a branch that we could try it with this?</p>",
        "id": 431995480,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1712588956
    },
    {
        "content": "<p>maybe? there are bugs but maybe it works for some examples</p>",
        "id": 431996781,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1712589174
    },
    {
        "content": "<p>I don't think it would help yet cause it wouldn't work on Dict. Cause Dict is not a List, it is a container that holds a List. So far it is just implemented for raw Lists and Strs.</p>",
        "id": 431998414,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712589475
    },
    {
        "content": "<p>So got a bit of a breakdown of the perf (all precentages are of total execution time for the program):</p>\n<ul>\n<li>~50%: Dict.update for counting (11% of that is refcounting that might get removed with borrow inference)</li>\n<li>~35%: spent walking the string and figuring out word splitting. This is a char at a time checking whitespace and then doing sublist to use seamless slices. Intermediate state is just <code>(Dict Str U64, [Valid U64, InValid])</code>. The Valid invalid is used to track word status and indices. (2.5% is refcounting)</li>\n<li>~10%: spent in <code>Str.fromUtf8</code>. So that is the extra validation cost.</li>\n<li>~ 5%: spent just loading the file into memory on the rust side.</li>\n</ul>",
        "id": 432040805,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712600525
    },
    {
        "content": "<p>In case I am missing something and there is a better way to do this. Here is the current impl to count words</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>countWords impl</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Elixir\"><pre><span></span><code><span class=\"n\">countWords</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">List</span><span class=\"w\"> </span><span class=\"nc\">U8</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Dict</span><span class=\"w\"> </span><span class=\"nc\">Str</span><span class=\"w\"> </span><span class=\"nc\">U64</span>\n<span class=\"n\">countWords</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">countsFinal</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">validFinal</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">        </span><span class=\"nc\">List</span><span class=\"o\">.</span><span class=\"n\">walkWithIndex</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nc\">Dict</span><span class=\"o\">.</span><span class=\"n\">empty</span><span class=\"w\"> </span><span class=\"p\">{},</span><span class=\"w\"> </span><span class=\"nc\">InValid</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"p\">(</span><span class=\"n\">counts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">lastValid</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">char</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">isWhiteSpace</span><span class=\"w\"> </span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"n\">then</span>\n<span class=\"w\">                </span><span class=\"ow\">when</span><span class=\"w\"> </span><span class=\"n\">lastValid</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">                    </span><span class=\"nc\">Valid</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                        </span><span class=\"c1\"># get work i (inclusive) to index (exclusive)</span>\n<span class=\"w\">                        </span><span class=\"n\">wordUtf8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">List</span><span class=\"o\">.</span><span class=\"n\">sublist</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"ss\">start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">}</span>\n<span class=\"w\">                        </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Str</span><span class=\"o\">.</span><span class=\"n\">fromUtf8</span><span class=\"w\"> </span><span class=\"n\">wordUtf8</span><span class=\"w\"> </span><span class=\"o\">|&gt;</span><span class=\"w\"> </span><span class=\"n\">unwrap</span>\n<span class=\"w\">                        </span><span class=\"n\">countsUpdated</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">                            </span><span class=\"nc\">Dict</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">counts</span><span class=\"w\"> </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">present</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                                </span><span class=\"ow\">when</span><span class=\"w\"> </span><span class=\"n\">present</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">                                    </span><span class=\"nc\">Present</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                                        </span><span class=\"nc\">Present</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">                                    </span><span class=\"nc\">Missing</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                                        </span><span class=\"nc\">Present</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">                        </span><span class=\"p\">(</span><span class=\"n\">countsUpdated</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">InValid</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"nc\">InValid</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                        </span><span class=\"p\">(</span><span class=\"n\">counts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">InValid</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"k\">else</span>\n<span class=\"w\">                </span><span class=\"ow\">when</span><span class=\"w\"> </span><span class=\"n\">lastValid</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">                    </span><span class=\"nc\">Valid</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                        </span><span class=\"p\">(</span><span class=\"n\">counts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">Valid</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"nc\">InValid</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                        </span><span class=\"p\">(</span><span class=\"n\">counts</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nc\">Valid</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"p\">)</span>\n\n<span class=\"w\">    </span><span class=\"ow\">when</span><span class=\"w\"> </span><span class=\"n\">validFinal</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">        </span><span class=\"nc\">Valid</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">            </span><span class=\"n\">wordUtf8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">List</span><span class=\"o\">.</span><span class=\"n\">sublist</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"ss\">start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nc\">List</span><span class=\"o\">.</span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nc\">Str</span><span class=\"o\">.</span><span class=\"n\">fromUtf8</span><span class=\"w\"> </span><span class=\"n\">wordUtf8</span><span class=\"w\"> </span><span class=\"o\">|&gt;</span><span class=\"w\"> </span><span class=\"n\">unwrap</span>\n<span class=\"w\">            </span><span class=\"nc\">Dict</span><span class=\"o\">.</span><span class=\"n\">update</span><span class=\"w\"> </span><span class=\"n\">countsFinal</span><span class=\"w\"> </span><span class=\"n\">word</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">present</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                </span><span class=\"ow\">when</span><span class=\"w\"> </span><span class=\"n\">present</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">                    </span><span class=\"nc\">Present</span><span class=\"w\"> </span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                        </span><span class=\"nc\">Present</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"nc\">Missing</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">                        </span><span class=\"nc\">Present</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">        </span><span class=\"nc\">InValid</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">            </span><span class=\"n\">countsFinal</span>\n\n\n\n<span class=\"n\">isWhiteSpace</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s1\">' '</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">14</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s1\">'</span><span class=\"se\">\\n</span><span class=\"s1\">'</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s1\">'</span><span class=\"se\">\\r</span><span class=\"s1\">'</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s1\">'</span><span class=\"se\">\\t</span><span class=\"s1\">'</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">char</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">13</span>\n\n<span class=\"n\">unwrap</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"ow\">when</span><span class=\"w\"> </span><span class=\"n\">res</span><span class=\"w\"> </span><span class=\"n\">is</span>\n<span class=\"w\">        </span><span class=\"nc\">Ok</span><span class=\"w\"> </span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">x</span>\n<span class=\"w\">        </span><span class=\"nc\">Err</span><span class=\"w\"> </span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">crash</span><span class=\"w\"> </span><span class=\"s2\">\"failed to unwrap $(Inspect.toStr e)\"</span>\n</code></pre></div>\n</div></div>",
        "id": 432041288,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712600685
    },
    {
        "content": "<p>Just an update on status of implementation:</p>\n<p>llvm -&gt; looks all good e2e (need to double check potential mem leaks)<br>\ndev -&gt; not implemented<br>\nwasm -&gt; not implemented</p>\n<p>RustGlue.roc -&gt; needs update to generate <code>RocRefcounted</code> for all types (probably the biggest part of this work if I implement it for every single type, could leave some of it as todo and still merge the PR)</p>",
        "id": 432385665,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712717596
    },
    {
        "content": "<p>Down to 47 failing dev wasm tests. Most (if I'm lucky, all) because I haven't updated the auto generated refcounting.</p>\n<p>Dev...may be a rougher lift. I have been updating it along with wasm, but it has many more failures, 204. All sig aborts. My gut feeling is that some of the auto generated reference counting function pointers are broken/done wrong. So anytime zig tries to increment a refcount of an element in a list it is crashing.</p>",
        "id": 432808003,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712881435
    },
    {
        "content": "<p>In an interesting turn of events, I update the autogenerated refcounting functions and the test numbers essentially switched between wasm and dev</p>\n<p>wasm: 229 failing<br>\ndev: 45 failing</p>\n<p>IIUC, most of the wasm tests are failing in roc's wasm interpreter. Not sure if I am revealing an interpreter bug or if this is a bug in my code gen. Theoretically the new functions are just calling into zig. So feels strange that they would be wrong. But I easily could have mis-wired something</p>\n<p>Most wasm errors look like this now:</p>\n<div class=\"codehilite\"><pre><span></span><code>panicked at &#39;index out of bounds: the len is 1254 but the index is 1254&#39;, crates/wasm_module/src/lib.rs:460:34\n</code></pre></div>",
        "id": 433010911,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712978361
    },
    {
        "content": "<p>That particular line of code is in <code>trace_live_functions</code> which is used for dead code elimination. It's possible to turn off DCE using the DEBUG_SETTINGS struct <a href=\"https://github.com/roc-lang/roc/blob/main/crates/wasm_module/src/lib.rs#L912\">here</a>.</p>",
        "id": 435054384,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1713900631
    },
    {
        "content": "<p>That particular error means that it's trying to trace a function call but the function index is out of bounds, so the function doesn't exist, or the index is wrong somehow.</p>",
        "id": 435054892,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1713900840
    },
    {
        "content": "<p>Thanks for the info. Will take a look</p>",
        "id": 435056583,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1713901448
    },
    {
        "content": "<p>I am looking at this PR a bit again. One thing I am unsure of that maybe <span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span> or <span class=\"user-mention\" data-user-id=\"431893\">@Brian Carroll</span> know. For the refcounting function code gen. I can generate a symbol for a proc. (In this case a proc to decrement the elements in a list). Do we have a way to load that symbol into a pointer for passing to zig?</p>\n<p>context: <a href=\"https://github.com/roc-lang/roc/blob/46be989f5b42a59a331f1f63b150088735c86723/crates/compiler/mono/src/code_gen_help/refcount.rs#L1019-L1032\">https://github.com/roc-lang/roc/blob/46be989f5b42a59a331f1f63b150088735c86723/crates/compiler/mono/src/code_gen_help/refcount.rs#L1019-L1032</a></p>\n<p>I know both dev backends have ways to do this, but not sure if anything is actually exposed such that I could do that here. Maybe I just need to somehow give the function symbol a pointer layout?</p>",
        "id": 449697647,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720375425
    },
    {
        "content": "<p>I think we only do that for lowlevels so it's baked into the backends, not something we can currently do in mono</p>",
        "id": 449699952,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1720376506
    },
    {
        "content": "<p>Ok</p>",
        "id": 449700143,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720376595
    },
    {
        "content": "<p>I should be fine to add it as a low level?</p>",
        "id": 449700158,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720376603
    },
    {
        "content": "<p>Just function symbol arg to pointer?</p>",
        "id": 449700191,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720376622
    },
    {
        "content": "<p>Or I guess I could make this whole chunk of list recounting code call a low-level that the backends deal with</p>",
        "id": 449700299,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720376654
    },
    {
        "content": "<p>yea some <code>ToFunctionPointer</code> should be fine</p>",
        "id": 449700313,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1720376664
    },
    {
        "content": "<p>If this is for decrementing elements of lists then we should know the type of those elements at compile time in mono, so we should know what function to call. So why is it a function pointer at runtime and not just a call to a known function?</p>",
        "id": 449702557,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720378255
    },
    {
        "content": "<p>Only cause the logic is complex enough now that I didn't want to port it all to mono. Instead just passing off to the zig builtin</p>",
        "id": 449702619,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720378317
    },
    {
        "content": "<p>OK</p>",
        "id": 449702719,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720378387
    },
    {
        "content": "<p>Where's the logic now?</p>",
        "id": 449702742,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720378421
    },
    {
        "content": "<p>On main, it is written in mono (and I guess duplicated in zig). With this branch, it become more complex so I want to have one source of truth in zig if possible.</p>",
        "id": 449702919,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720378506
    },
    {
        "content": "<p>OK. Well we do already have lowlevels for casting integer to pointer and back. But I don't think we have a lowlevel for function pointers because they were always known at compile time.</p>",
        "id": 449703066,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720378553
    },
    {
        "content": "<p>But as you mentioned, the wasm dev backend does pass function indices to Zig already.<br>\n<a href=\"https://github.com/roc-lang/roc/blob/main/crates/compiler/gen_wasm/src/backend.rs#L2103-L2134\">This</a> seems like a good place to refer to.</p>",
        "id": 449704194,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720378865
    },
    {
        "content": "<p>Thanks</p>",
        "id": 449704354,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720378903
    },
    {
        "content": "<p>hey <span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span>, do you recall symbols from <code>debug_symbol</code> in the dev backend need to be freed? My understanding was that it generates a unique symbol just with whatever name as like a prefix, so freeing shouldn't be needed. But maybe I am incorrect about how that is implemented.</p>",
        "id": 449735801,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720395690
    },
    {
        "content": "<p>Also, one thing that really confuses me with <code>list-size-on-heap</code> is that a lot of the newly failing gen_dev tests are not even touching lists and the refcount path. I don't know what I broke, but really feels like I may have accidentally modify something unrelated to lists for that backend (same for gen_wasm) I guess. Hopefully, that means the fix is unrelated and pretty minor. The fact that llvm is 100% working only gen_wasm/gen_dev have issues definitely a tad annoying. Want to get this merged for people to be able to use it.</p>",
        "id": 449738006,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720396340
    },
    {
        "content": "<p>I decided to open a Draft PR for the list size on heap work(<a href=\"https://github.com/roc-lang/roc/issues/6894\">#6894</a>). If anyone has time to look over the code changes in <code>gen_dev</code>, <code>gen_wasm</code> or <code>mono/code_gen_help</code>, it would be much appreciated. Given the PR is passing for the llvm backend, it suggests that the issues I am still hitting are coming from those folders. Extra eyes to leave comments, attempt to debug, or give general suggestions of code I should check over again would be quite helpful.</p>\n<p>Hopefully I can figure out the last chunk of issues and finally get this submitted. It is a huge perf gain for any lists of refcounted types.</p>",
        "id": 450563389,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720645172
    },
    {
        "content": "<p>Oh! Just had a big breakthrough on wasm. I was generating a bunch of direct refcounting functions when I needed indirect ones!. Changing over fixed a number of tests. That said, also revealed some incorrect args I need to update.</p>",
        "id": 450598955,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720657595
    },
    {
        "content": "<p>Eh, less big than I thought, but still a chunk better. That said, there is definitely a DCE bug. approximately 120 tests fail with DCE enabled. I assume it is related to passing function pointers to zig and those being DCE'd when they shouldn't be.</p>",
        "id": 450600628,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720658066
    },
    {
        "content": "<p>Hmm, for wasm it seems that some indirect refcounting function my not be getting added to the function table in general. (No idea why currently). As such, we end up passing an incorrect function pointer around. Maybe it is related to the nested nature (like outer function getting added but not inner or something similar)</p>",
        "id": 450604266,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720660926
    },
    {
        "content": "<p>Ok. Can confirm issue is caused by indirect helper procs calling direct helper procs. Wasm backend is only emitting one of these procs and not the other. I attempted to naively recursively generate helper procs, but that clearly isn't correct. Some functions are generating forever.</p>",
        "id": 450606158,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720662682
    },
    {
        "content": "<p>Hmm, we also seem to have a chicken and egg problem. Even if I explicitly generate the element helper procs when generating the list helper procs, they won't be known when generating the helper procs. This is because the helper procs are taken from the code generator. So they don't exist when building the helper procs themselves. Only when generating the main procs.</p>",
        "id": 450613514,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720667400
    },
    {
        "content": "<p>I think I fixed one of the main recursion cases leaded to inner procs not actually being generated. Down from 200ish dev wasm failures to 50ish.</p>\n<p>Most failures still look to be due to missing helper procs leading to index out of bounds when trying to load a proc...not sure why at this point though.</p>",
        "id": 450616637,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720669751
    },
    {
        "content": "<p>Oh haha, actually those issues were due to forgetting to pass an arg to the function. Not sure why it manifested that way. Down to 18 gen wasm tests failing.</p>",
        "id": 450618211,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720670886
    },
    {
        "content": "<p>Sounds like good progress!<br>\nI will have a look in a couple of hours.<br>\nWhat do you mean by \"<em>indirect</em> ref counting function\"?</p>",
        "id": 450619328,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720671659
    },
    {
        "content": "<p>Indirect: take a pointer to the thing to refcount and call the direct refcounting function</p>",
        "id": 450620384,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720672269
    },
    {
        "content": "<p>Essentially all the refcount functions we pass to zig are indirect.</p>",
        "id": 450620392,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720672289
    },
    {
        "content": "<p>So at this point, the failures are down to two types:</p>\n<ol>\n<li>cases where the refcounting proc I am trying to load a function pointer to isn't found and we panic on an unwrap.</li>\n<li><code>gen_refcount</code> functions that are no longer correct in how they load the rc. Cause lists with refcounted elements are now <code>|size|rc|elements ...|</code>. So <code>gen_refcount</code> is loading the size on heap instead of the rc.</li>\n</ol>",
        "id": 450620643,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720672526
    },
    {
        "content": "<p>So for the gen_refcount tests. All of the the sizes on heap never actually get initialized. So, by zeroing out the the allocation with <code>calloc</code> instead of <code>malloc</code>, all of the lists end up having their refcount read as <code>Constant</code> cause it is reading the 0 size on heap. I guess I can special case that. Definitely a bit jank, but should be consistent and a good test.</p>",
        "id": 450621567,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720673043
    },
    {
        "content": "<p>Ok, fixed all the <code>gen_refcount</code> tests to recognize when the load the size on heap (it's always positive) and if so load the value after it as the refcount.</p>",
        "id": 450623131,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720674353
    },
    {
        "content": "<p>Oh wow, down to 2 in gen wasm. Both due to not having a matching refcount proc for a layout. Though for 1, I think the layouts are the same, it's just that they have to be check recursively to be known equal. I'm not sure why this ends up happening.  Like they have different internal InLayouts, but the runtime reprs of those InLayouts are the same. So the types really are the same.</p>",
        "id": 450625382,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720676084
    },
    {
        "content": "<p>So yeah, we have 1 test where we request 1 refcount layout, but the function takes a different layout (that I'm pretty sure is equavalent:</p>\n<div class=\"codehilite\"><pre><span></span><code>[crates/compiler/gen_wasm/src/backend.rs:2123:25] self.layout_interner.runtime_representation(inner) = Union(\n    NonRecursive(\n        [\n            [\n                InLayout(STR),\n                InLayout(\n                    27,\n                ),\n            ],\n            [\n                InLayout(\n                    30,\n                ),\n                InLayout(UNIT),\n            ],\n        ],\n    ),\n)\n[crates/compiler/gen_wasm/src/backend.rs:2123:25] layout_repr = Union(\n    NonRecursive(\n        [\n            [\n                InLayout(STR),\n                InLayout(\n                    29,\n                ),\n            ],\n            [\n                InLayout(\n                    32,\n                ),\n                InLayout(UNIT),\n            ],\n        ],\n    ),\n)\n</code></pre></div>\n<p>Then we have a test where we are generating the correct refcount function, but it seems to be missing when we try to loading it. Maybe it just isn't being registered in the wasm backend for some reason... There is a function of the same name with a different layout for this second test. Given this is for a recursive tag, I think that function is for refcounting the inner elements. So I think that is why it has the same name.</p>",
        "id": 450628240,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720678046
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> it's awesome seeing your progress with this. Hype for the extra <span aria-label=\"racecar\" class=\"emoji emoji-1f3ce\" role=\"img\" title=\"racecar\">:racecar:</span> boost.</p>",
        "id": 450829158,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720738299
    },
    {
        "content": "<p>fingers crossed that I can actually close it out. Really hoping that ironing out wasm (which is more debuggable) will pave the path for fixing the dev backend as well.</p>",
        "id": 450829392,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720738352
    },
    {
        "content": "<p>Should <code>List.map*</code> take ownership of the input lists?</p>\n<p>I guess the theory is that if:</p>\n<ol>\n<li>one of the lists has the same element size as the output element size</li>\n<li>That list has a refcount of 1</li>\n</ol>\n<p>The zig builtin could reuse that allocation instead of allocating an output list.</p>\n<p>Currently we don't do any of these sort of optimizations. On top of that, except for maybe <code>List.map</code> (the single element version) I would assume they would be exceptionally rare to trigger.</p>\n<p>Just realizing that we have to pass in way more args if <code>List.map*</code> are also responsible for free every single list that is passed in.</p>",
        "id": 450831261,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720738966
    },
    {
        "content": "<p>Hmm...actually with I'm a bit confused. Setting it to <code>Borrowed</code> or <code>Owned</code> doesn't seem to chaing our recfcount codegen...something feels off here. Either way, it seems to be <code>Borrowed</code> The lists are passed in and then decrefed after the call....</p>",
        "id": 450837994,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720743032
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span> do you know where we ensure that closure passed to <code>List.map*</code> have the correct borrow signiture? As in, I noticed that in one <code>List.map2</code> case, the closure was dealing with incrementing the element refcount, but in another <code>List.map</code> case, the closure was not dealing with incrementing the refcount.</p>\n<p>I definitely prefer for the closure to assume it is borrowing all args and be required to increment the refcount if the arg is used, but I'm not sure where this logic lives.</p>\n<p>To get concrete, these are the examples: The first test here the <code>List.map</code> closure does not  increment the refcount. In the second case, the closure is incrementing the refcount.</p>",
        "id": 450845771,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720746922
    },
    {
        "content": "<p>Lol, forgot to post the link: <a href=\"https://github.com/roc-lang/roc/blob/d4880cc438decdbe1bb5588706e682ff33daa24f/crates/compiler/test_gen/src/gen_refcount.rs#L127-L167\">https://github.com/roc-lang/roc/blob/d4880cc438decdbe1bb5588706e682ff33daa24f/crates/compiler/test_gen/src/gen_refcount.rs#L127-L167</a></p>",
        "id": 450847517,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720747717
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap/near/450831261\">said</a>:</p>\n<blockquote>\n<p>Should <code>List.map*</code> take ownership of the input lists?</p>\n<p>I guess the theory is that if:</p>\n<ol>\n<li>one of the lists has the same element size as the output element size</li>\n<li>That list has a refcount of 1</li>\n</ol>\n<p>The zig builtin could reuse that allocation instead of allocating an output list.</p>\n<p>Currently we don't do any of these sort of optimizations. On top of that, except for maybe <code>List.map</code> (the single element version) I would assume they would be exceptionally rare to trigger.</p>\n</blockquote>\n<p>I'd like to do it for single-element <code>List.map</code> for that reason, but I agree that for the others it's not likely to come up</p>",
        "id": 450859493,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720753144
    },
    {
        "content": "<p>but as an example, a common thing is to <code>List.map</code> to transform a list of strings into other strings</p>",
        "id": 450859592,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720753178
    },
    {
        "content": "<p>Also, don't know if it was <span class=\"user-mention\" data-user-id=\"431893\">@Brian Carroll</span>, <span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span>, or someone else. But many thanks to whoever made <code>gen_refcount</code> for the wasm backend. Very useful for adding extra test cases and debugging my changes.</p>",
        "id": 450865785,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720755226
    },
    {
        "content": "<p>That was me. Glad you like it!</p>",
        "id": 450880769,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720762271
    },
    {
        "content": "<p>Also, periodic reminder that we have a HTML page in <code>test_gen/</code> that can load the Wasm file for a test into the browser so we can use their debug tools. Whenever I had a really hard Wasm bug, it always ended up being helpful.</p>",
        "id": 450882397,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1720763354
    },
    {
        "content": "<blockquote>\n<p>do you know where we ensure that closure passed to <code>List.map*</code> have the correct borrow signiture</p>\n</blockquote>\n<p>hmm, should we maybe just move that over to roc itself finally? then lambda sets (or whatever else we use) will just handle that automatically</p>",
        "id": 450928878,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1720779014
    },
    {
        "content": "<p>because the actual answer is that I may have missed that in the recent borrow inference changes (and none of our test cases catch that?!)</p>",
        "id": 450928987,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1720779052
    },
    {
        "content": "<p>I'd still rather not add special syntax for that <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 450941230,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720782431
    },
    {
        "content": "<p>I know it would make this sort of thing nicer, but I think if it's exposed in syntax then there will be requests for moving it to userspace</p>",
        "id": 450941319,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720782461
    },
    {
        "content": "<p>syntax for what? I'm not proposing syntax?</p>",
        "id": 450980482,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1720791925
    },
    {
        "content": "<p>we can write <code>List.map</code> in pure roc in the standard library. There is a minor performance hit (or there was, years ago now) but it really simplifies the backends</p>",
        "id": 450980667,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1720791966
    },
    {
        "content": "<p>oh nm I misunderstood</p>",
        "id": 450993299,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720794704
    },
    {
        "content": "<p>Ah, so move <code>List.map</code> into roc and let roc generate recounting for calling and what not automatically. That said, any other zig builtin that take lambdas may still hit this. Like sort with </p>\n<p>Also, I'm gonna guess that this was broken before your recent change, but I can double check.</p>",
        "id": 451007851,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720797657
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281543\">Folkert de Vries</span> <a href=\"#narrow/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap/near/450980667\">said</a>:</p>\n<blockquote>\n<p>we can write <code>List.map</code> in pure roc in the standard library. There is a minor performance hit (or there was, years ago now) but it really simplifies the backends</p>\n</blockquote>\n<p>I could see doing this for now, and then in the future finding a way to improve the perf (e.g. optimizations that apply to that roc code, maybe introducing a new builtins-only primitive that can speed it up, etc.)</p>",
        "id": 451008427,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720797775
    },
    {
        "content": "<p>Yeah, I guess we want the inplace optimization, so moving to roc maybe doesn't make sense. We will just end up moving it back out eventually.</p>",
        "id": 451079039,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720819993
    },
    {
        "content": "<p>I guess it could be represented in pure roc if we add a built-in to check the uniqueness. If unique, can read and write directly to the single list</p>",
        "id": 451079192,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720820051
    },
    {
        "content": "<p>So actually that sounds fine</p>",
        "id": 451079200,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720820055
    },
    {
        "content": "<p>Yeah, probably gonna move it to full roc.</p>",
        "id": 451079224,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720820068
    },
    {
        "content": "<p>Moved <code>List.map*</code> to roc and fixed a refcounting bug in dev_wasm.<br>\nI also added new tests (so that has increased the number of failing tests), but currently at:</p>\n<ul>\n<li>llvm -&gt; 100% functional (had a few temporary breaks)</li>\n<li>dev wasm -&gt; 2 failing: both due to <code>\"WebAssembly 'unreachable' instruction at file offset 0x...</code>. Maybe related to dec functions passed into <code>List.decref</code> for non-refcounted types?</li>\n<li>dev native -&gt; 37 failing: No idea why...just sigabrts.</li>\n<li>regular tests (all the non-backend tests) -&gt; 2 failing: Both due to needing to update <code>RustGlue.roc</code> to generate the <code>RocRefcounted</code> trait.</li>\n</ul>",
        "id": 451101456,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720831066
    },
    {
        "content": "<p>dev wasm at 100% passing!</p>",
        "id": 451104059,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720832027
    },
    {
        "content": "<p>yooooooo</p>",
        "id": 451104673,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720832233
    },
    {
        "content": "<p>this is so exciting! <span aria-label=\"heart eyes\" class=\"emoji emoji-1f60d\" role=\"img\" title=\"heart eyes\">:heart_eyes:</span></p>",
        "id": 451104702,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720832244
    },
    {
        "content": "<p>dev native 100% passing!</p>",
        "id": 451107930,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720834129
    },
    {
        "content": "<p>So now all that is left is updating <code>RustGlue.roc</code>. Should be easy but tedious.</p>",
        "id": 451108036,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720834229
    },
    {
        "content": "<p>Wow, moving quickly</p>",
        "id": 451108790,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720834913
    },
    {
        "content": "<p>Looks like there is also some sort of memory issue in <code>parser-movies-csv.roc</code> on linux</p>",
        "id": 451112857,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720836880
    },
    {
        "content": "<p>looks like we have some invalid writes during <code>decrement_refcounted_ptr_8</code>. Probably means I am either treating something like a list when I shouldn't or the reverse.</p>",
        "id": 451114968,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720838396
    },
    {
        "content": "<p>Ah wait, might actually be use after free. So bad refcounting.</p>",
        "id": 451115166,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720838464
    },
    {
        "content": "<p>Anyway, guess that also needs to be fixed</p>",
        "id": 451115179,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720838477
    },
    {
        "content": "<p>Cool, just a minor mistake in <code>List.sublist</code> leading to a use after free. All good now.</p>",
        "id": 451119820,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720841630
    },
    {
        "content": "<p>CI is green!!!</p>\n<p>So that means all that is left is:</p>\n<ol>\n<li>update glue and re-enable the 2 failing glue tests</li>\n<li>Maybe do something about <code>-ld_classic</code>. Cause I think for many people with updated macs, they will need that flag. (EDIT: might need to do something like this where we query xcode version: <a href=\"https://github.com/godotengine/godot/pull/83088/files\">https://github.com/godotengine/godot/pull/83088/files</a>)</li>\n</ol>",
        "id": 451123846,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720844763
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> just curious if you have any thoughts about <code>-ld_classic</code> and macos versioning.</p>",
        "id": 451123866,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720844794
    },
    {
        "content": "<p>Glue generation is not very robust for refcounting (mostly unimplemented) and I haven't dealt with <code>-ld_classic</code>, but I think <a href=\"https://github.com/roc-lang/roc/issues/6894\">#6894</a> is technically mergable now (minus whichever test I just broke...).</p>",
        "id": 451132539,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720852244
    },
    {
        "content": "<blockquote>\n<p>might need to do something like this where we query xcode version</p>\n</blockquote>\n<p>Yeah, I would use the same approach, add <code>-ld_classic</code> for xcode 15 and up</p>",
        "id": 451186327,
        "sender_full_name": "Anton",
        "timestamp": 1720883577
    },
    {
        "content": "<p>So with this change, it mostly doesn't affect the ecosystem. That said, it will subtly break a few effects in various platforms. Anything with refcounted things in lists will now be incorrect. So <code>dirList</code> in <code>basic-cli</code> and <code>basic-webserver</code>. Also <code>sqliteExecute</code> in <code>basic-webserver</code>. Both take/return nested lists.</p>\n<p>So they will need glue regenerated. Or, at a minimum some copy over the new <code>roc_std/</code> and potentially do a tiny bit of manual tweaking.</p>",
        "id": 451198461,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720889965
    },
    {
        "content": "<p>My thought is that we should merge this and follow quickly with updates to <code>basic-cli</code> and <code>basic-webserver</code>.</p>\n<p>Given the small amount of effects that it will affect, I am not too worried about just getting this in. We can post an announcement that warns users of the breaking change and asks them to stay on an older version of nightlies (if they run into it) until these platforms are updates.</p>",
        "id": 451198930,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720890179
    },
    {
        "content": "<blockquote>\n<p>My thought is that we should merge this and follow quickly with updates to <code>basic-cli</code> and <code>basic-webserver</code>.</p>\n</blockquote>\n<p>Yeah, we can hold off on uploading new nightlies until the new releases are ready. I can make the releases a top priority on monday.</p>",
        "id": 451203387,
        "sender_full_name": "Anton",
        "timestamp": 1720892401
    },
    {
        "content": "<p>Hopefully updating plays smoothly. If not, let me know. Most likely issues are with things missing the <code>RocRefcounted</code> trait.</p>",
        "id": 451203523,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720892484
    },
    {
        "content": "<p>Ok, I'm happy with <a href=\"https://github.com/roc-lang/roc/issues/6894\">#6894</a>.</p>\n<p>Glue could be updated more, but I am fine with leaving complex uncommon types with some unimplement RocRefcounted methods.</p>",
        "id": 451210891,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720896330
    },
    {
        "content": "<p>Can we lump the breaking change in with the refactor host and task as builtin PRs? Then all the breaking changes are in one release</p>",
        "id": 451219983,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720900655
    },
    {
        "content": "<p>As far as I know those changes are gtg right?</p>",
        "id": 451220051,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720900706
    },
    {
        "content": "<p>We could delay nightlies for that grouping together. Sure.</p>\n<p>I just want to get this in before anything else moves too much. Don't want it to live too long and get stale.</p>",
        "id": 451220077,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720900745
    },
    {
        "content": "<p>Totally.</p>",
        "id": 451220123,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720900799
    },
    {
        "content": "<p>Also, the glue code gen package is kind of the source for a bunch of platforms which have build scripts. So we can update there and it should be straightforward to update the others.</p>",
        "id": 451220252,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720900850
    },
    {
        "content": "<p>I can update the code gen package in a few hours time, and I'll update the refactor host PRs with the latest glue and align and test with your branch.</p>",
        "id": 451220626,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720901025
    },
    {
        "content": "<p>Yeah, I updated glue bar some more complex recounting that I don't think any platform uses.</p>",
        "id": 451220635,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901030
    },
    {
        "content": "<p>The glue code gen package literally just delivers a vendored roc_std and zig builtins for now.</p>",
        "id": 451220713,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720901089
    },
    {
        "content": "<p>Ah, I see. Makes sense</p>",
        "id": 451220744,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901112
    },
    {
        "content": "<p>ooo, this means we can pass allocation size to roc_dealloc, right?</p>",
        "id": 451220752,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720901117
    },
    {
        "content": "<p>because now even slices know it</p>",
        "id": 451220832,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720901140
    },
    {
        "content": "<p>Yeah, I think we could.</p>",
        "id": 451220844,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901144
    },
    {
        "content": "<p>niiiiice</p>",
        "id": 451220847,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720901148
    },
    {
        "content": "<p>that means Rust hosts will be able to use the global allocator for dealloc!</p>",
        "id": 451220894,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720901165
    },
    {
        "content": "<p>which requires being passed that size</p>",
        "id": 451220918,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720901182
    },
    {
        "content": "<p>that will be valuable for rust hosts that aren't just using malloc/free</p>",
        "id": 451220964,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720901218
    },
    {
        "content": "<p>Actually, no, this still doesn't fix it.</p>",
        "id": 451221221,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901333
    },
    {
        "content": "<p>Cause it is number of refcounted elements rather than total allocation size.</p>",
        "id": 451221248,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901357
    },
    {
        "content": "<p>ah ok</p>",
        "id": 451221711,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720901542
    },
    {
        "content": "<p>So will older basic-cli work with these changes? I think not</p>",
        "id": 451221719,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720901561
    },
    {
        "content": "<p>Thought: <br>\nPass in an optional to alloc/dealloc size. If it is none, the allocator can allocate a bit of extra space to store the size.</p>",
        "id": 451221889,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901640
    },
    {
        "content": "<p>Old basic CLI will work with size on heap except for dirList. I think that is the only effect that will break</p>",
        "id": 451221980,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901690
    },
    {
        "content": "<p>This change only affects lists of refcounted things (list list, list str, dict str, set str).</p>",
        "id": 451222070,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720901746
    },
    {
        "content": "<p>I'll see if it breaks the roc build scripts, but it sounds like it wont which makes things easier. </p>\n<p>I definitely would prefer we keep the current 0.12.0 basic-cli release (even if it stays in pre-release), and jump to 0.13 with this update, builtin task, and refactor host.</p>",
        "id": 451222493,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720901968
    },
    {
        "content": "<p>Is there any chance we could make another branch on roc that includes both this and task as builtin changes?</p>",
        "id": 451222747,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720902064
    },
    {
        "content": "<p>Personally, I would just merge them into main, main is unstable and that is fine. If we need, we can delay nightlies or explicitly tell users to pin to the nightly from yesterday until everything else is ready.</p>",
        "id": 451225029,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720903340
    },
    {
        "content": "<p>yeah I think it's fine to merge now and disable nightlies temporarily</p>",
        "id": 451226463,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720904787
    },
    {
        "content": "<p>that way nobody who happens to try out roc for the first time has a bad experience</p>",
        "id": 451226652,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720904980
    },
    {
        "content": "<p>(and based on multiple people joining Zulip daily, people trying out Roc every day seems to be a thing that now happens!)</p>",
        "id": 451226734,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1720905027
    },
    {
        "content": "<ul>\n<li>roc <a href=\"https://github.com/lukewilliamboswell/roc/releases/tag/glue-0.2\">glue package</a> release</li>\n<li><a href=\"https://github.com/lukewilliamboswell/roc-glue-code-gen/releases/download/0.4.0/E6x8uVSMI0YQ9CgpMww6Cj2g3BlN1lV8H04UEZh_-QA.tar.br\">roc-glue-code-gen</a> release</li>\n<li><a href=\"https://github.com/lukewilliamboswell/roc-wasm4/pull/27\">roc-wasm4</a> updated</li>\n</ul>",
        "id": 451331751,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720943851
    },
    {
        "content": "<p>For roc-wasm4 -- I had to downgrade back to zig 0.11.0 from 0.12.0. I started trying to update the builtins to 0.13.0 and thought I might contribute that back but got stuck on some non-trivial things I wasn't sure how to change. I could get through the many </p>\n<div class=\"codehilite\"><pre><span></span><code>package/zig-builtins/str.zig:1946:9: note: consider using &#39;const&#39;\npackage/zig-builtins/str.zig:1962:9: error: local variable is never mutated\n</code></pre></div>\n<p>But things like below seemed too important and so I stopped.</p>\n<div class=\"codehilite\"><pre><span></span><code>package/zig-builtins/dec.zig:317:62: error: expected error union type, found &#39;u128&#39;\n        const self_u128 = @as(u128, @intCast(@abs(self_i128) catch {\n</code></pre></div>\n<p><a href=\"/user_uploads/22008/cz66Pe__2BaddgfCugszz8ht/Screenshot-2024-07-14-at-18.00.15.png\">Screenshot-2024-07-14-at-18.00.15.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/cz66Pe__2BaddgfCugszz8ht/Screenshot-2024-07-14-at-18.00.15.png\" title=\"Screenshot-2024-07-14-at-18.00.15.png\"><img src=\"/user_uploads/22008/cz66Pe__2BaddgfCugszz8ht/Screenshot-2024-07-14-at-18.00.15.png\"></a></div><p>I would really like it if we could upgrade roc to 0.12.0 or 0.13.0 soon. <span aria-label=\"pray\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"pray\">:pray:</span></p>",
        "id": 451332081,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944118
    },
    {
        "content": "<p>Probably depends on updating inkwell and llvm</p>",
        "id": 451332300,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944281
    },
    {
        "content": "<p>Should be quite doable though</p>",
        "id": 451332306,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944291
    },
    {
        "content": "<p>Also, how do I fix this?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">[</span><span class=\"n\">E0277</span><span class=\"p\">]:</span><span class=\"w\"> </span><span class=\"nc\">the</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Header</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocRefcounted</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">satisfied</span>\n<span class=\"w\">   </span><span class=\"o\">-</span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">crates</span><span class=\"o\">/</span><span class=\"n\">roc_host</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">760</span><span class=\"p\">:</span><span class=\"mi\">14</span>\n<span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"mi\">760</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">headers</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocList</span><span class=\"o\">&lt;</span><span class=\"n\">Header</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"o\">|</span><span class=\"w\">              </span><span class=\"o\">^^^^^^^^^^^^^^^</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RocRefcounted</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">implemented</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">Header</span><span class=\"err\">`</span>\n<span class=\"w\">    </span><span class=\"o\">|</span>\n<span class=\"w\">    </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">help</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">the</span><span class=\"w\"> </span><span class=\"n\">following</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"w\"> </span><span class=\"n\">types</span><span class=\"w\"> </span><span class=\"n\">implement</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RocRefcounted</span><span class=\"err\">`</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"p\">()</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"p\">)</span>\n<span class=\"w\">              </span><span class=\"p\">(</span><span class=\"n\">A</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">B</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">E</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">G</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">H</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"mi\">29</span><span class=\"w\"> </span><span class=\"n\">others</span>\n<span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">required</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">bound</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RocList</span><span class=\"err\">`</span>\n</code></pre></div>",
        "id": 451332417,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944364
    },
    {
        "content": "<p>Header is </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[repr(C)]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Header</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">key</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocStr</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocStr</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 451332460,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944416
    },
    {
        "content": "<p>Is there a way to auto derive like we would in Roc?</p>",
        "id": 451332476,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944429
    },
    {
        "content": "<p>Glue should generate correctly for that type</p>",
        "id": 451332610,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944545
    },
    {
        "content": "<p>Anyway, it should be super simple for that type </p>\n<p>Recounted true<br>\nInc increments both strings<br>\nDec decrements both strings</p>",
        "id": 451332638,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944580
    },
    {
        "content": "<p>There is no glue in basic-cli anymore... so I had a crack </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">roc_std</span><span class=\"p\">::</span><span class=\"n\">RocRefcounted</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Header</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">inc</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">key</span><span class=\"p\">.</span><span class=\"n\">inc</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">.</span><span class=\"n\">inc</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">dec</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">key</span><span class=\"p\">.</span><span class=\"n\">dec</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">.</span><span class=\"n\">dec</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">is_refcounted</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kc\">true</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I think I figured it out</p>",
        "id": 451332703,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944608
    },
    {
        "content": "<p>Theoretically it could auto derive, but I don't know how to write an auto derive macro in rust</p>",
        "id": 451332713,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944621
    },
    {
        "content": "<p>Thank you rust-analyser</p>",
        "id": 451332714,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944623
    },
    {
        "content": "<p>Yeah, perfect impl</p>",
        "id": 451332740,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944639
    },
    {
        "content": "<p>And we've killed RocDict?</p>",
        "id": 451332743,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944643
    },
    {
        "content": "<p>I think you may have mentioned it before, the plan is to do them later?</p>",
        "id": 451332761,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944670
    },
    {
        "content": "<p>It was being used in <code>roc_fx_envDict</code></p>",
        "id": 451332774,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944693
    },
    {
        "content": "<p>The <code>roc_std</code> type was totally wrong and dict changed a lot (plus is mildly complex)</p>",
        "id": 451332776,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944697
    },
    {
        "content": "<p>My current thought is pass in a list of tuples and have roc turn it into a dict</p>",
        "id": 451332794,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720944718
    },
    {
        "content": "<p>Ok, I'll switch it to a <code>RocList&lt;(RocStr, RocStr)&gt;</code> I guess</p>",
        "id": 451332854,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944741
    },
    {
        "content": "<p>Ok, I've got basic-cli working again</p>",
        "id": 451333044,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720944913
    },
    {
        "content": "<p>I'll see if I can make a pre-release by cross-compiling from my mac</p>",
        "id": 451333329,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720945059
    },
    {
        "content": "<p>Because it's broken, we have to manually step through the build steps by hand</p>",
        "id": 451333389,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720945087
    },
    {
        "content": "<p>Though I'm not sure if we need the prebuilt surgical host's for CI to pass on main roc. I think we do which could be a challenge</p>",
        "id": 451333457,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720945190
    },
    {
        "content": "<p>I don't think the main roc repo tests depended on anything in basic cli that broke.</p>",
        "id": 451333561,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720945246
    },
    {
        "content": "<p>Curious... I can run basic scripts, but the build.roc script in basic cli isn't happy using the current 0.12.0</p>\n<div class=\"codehilite\"><pre><span></span><code>$ roc build.roc\nroc_app_binary(53940,0x201c58c00) malloc: *** error for object 0x60000348f698: pointer being freed was not allocated\nroc_app_binary(53940,0x201c58c00) malloc: *** set a breakpoint in malloc_error_break to debug\n</code></pre></div>",
        "id": 451333825,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720945513
    },
    {
        "content": "<p>NVM -- figured that out. PEBKAC</p>",
        "id": 451334115,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720945789
    },
    {
        "content": "<ul>\n<li>basic-cli <a href=\"https://github.com/roc-lang/basic-cli/pull/194\">refactor-host branch</a> now includes the updates for latest roc. <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span>  </li>\n</ul>\n<p>CI is failing because it needs a pre-release of basic-cli to pass. </p>\n<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> I added a new file in this PR called <code>jump-start.sh</code> which enables us to build basic-cli locally from a breaking change in roc.</p>",
        "id": 451335802,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720947179
    },
    {
        "content": "<p><span aria-label=\"sad\" class=\"emoji emoji-2639\" role=\"img\" title=\"sad\">:sad:</span> </p>\n<div class=\"codehilite\"><pre><span></span><code>$ roc --prebuilt-platform examples/args.roc div -n 5 -d 20\nroc_app_binary(61803,0x201c58c00) malloc: Heap corruption detected, free list is damaged at 0x60000229c110\n*** Incorrect guard value: 185616897523983\nroc_app_binary(61803,0x201c58c00) malloc: *** set a breakpoint in malloc_error_break to debug\n</code></pre></div>",
        "id": 451336408,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720947722
    },
    {
        "content": "<p>For some reason, the args example is broken</p>",
        "id": 451336462,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720947742
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> or if anyone else would like to reproduce this, you just need to checkout the <a href=\"https://github.com/roc-lang/basic-cli/pull/194\">refactor-host</a> branch on basic-cli, then run <code>bash jump-start.sh</code>, and then  <code>roc --prebuilt-platform examples/args.roc div -n 5 -d 20</code>.</p>",
        "id": 451336750,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720947999
    },
    {
        "content": "<p>I've staged the update for <a href=\"https://github.com/lukewilliamboswell/basic-ssg/pull/5\">basic-ssg</a> and tested locally with everything looking good. However, if the above arg issue is serious and we need to regenerate/change roc_std then I will have to do another release so I'll just wait to see how we go with basic-cli.</p>",
        "id": 451338284,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720949317
    },
    {
        "content": "<p>I think this may be something we missed </p>\n<div class=\"codehilite\"><pre><span></span><code>error[E0599]: no method named `inc` found for struct `RocResult` in the current scope\n</code></pre></div>",
        "id": 451345479,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720954985
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>error[E0277]: the trait bound `SQLiteBindings: RocRefcounted` is not satisfied\n</code></pre></div>",
        "id": 451347114,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1720956975
    },
    {
        "content": "<p>Oh, looks like there may be some missed updates on initializing lists in RocRefcounted</p>",
        "id": 451368393,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720976580
    },
    {
        "content": "<p>Ah, specifically with <code>elems_with_capacity</code></p>",
        "id": 451368527,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720976726
    },
    {
        "content": "<p>hmm, nvm, that looks correct</p>",
        "id": 451368601,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720976782
    },
    {
        "content": "<p>Probably need to run things with valgrind and debug. Trying to fix my linux machine. Broke it yesterday with an update</p>",
        "id": 451370111,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720978521
    },
    {
        "content": "<p>So will debug more later, but looks like we have a refcounting bug that is leading to use after free. Maybe in List.walkTry? Maybe in somt other builtin running before the call to List.walkTry. That or I missed that heapsize offset somewhere.</p>",
        "id": 451386898,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1720997039
    },
    {
        "content": "<blockquote>\n<p>and jump to 0.13 with this update, builtin task, and refactor host.</p>\n</blockquote>\n<p>Would bundling all of them not make debugging much harder because there are many more possible causes for a bug?</p>",
        "id": 451467830,
        "sender_full_name": "Anton",
        "timestamp": 1721040467
    }
]
[
    {
        "content": "<p>right now all the zig builtins live in <code>crates/</code> which makes them inaccessible to the zig compiler...should we to move them to <code>src/builtins</code> or something?</p>",
        "id": 519271689,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747707622
    },
    {
        "content": "<p>I would just fork and split</p>",
        "id": 519271740,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747707648
    },
    {
        "content": "<p>They have to change anyway due to zig version and new API with explicit function pointers passed in</p>",
        "id": 519271786,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747707672
    },
    {
        "content": "<p>And yeah, sec/builtins sounds like a good dir for it</p>",
        "id": 519271967,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747707737
    },
    {
        "content": "<p>cool, sounds good! <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 519272882,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747708138
    },
    {
        "content": "<p>it'll also need quite a rewrite with all of the new syntax</p>",
        "id": 519275135,
        "sender_full_name": "Anthony Bullard",
        "timestamp": 1747709075
    },
    {
        "content": "<p>Is this something I can help with? Do we have something minimal like Bool or maybe Str we need?</p>",
        "id": 519276181,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747709516
    },
    {
        "content": "<p>sure! Here's a WIP PR with just that change: <a href=\"https://github.com/roc-lang/roc/pull/7802\">https://github.com/roc-lang/roc/pull/7802</a></p>",
        "id": 519276701,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747709738
    },
    {
        "content": "<p>if you want to try to get it updated and tests passing, that would be awesome! <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 519276720,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747709750
    },
    {
        "content": "<p><code>Str</code> would be enough for hello world, but probably at that point you've gotten all the hard parts anyway <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 519277787,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747710175
    },
    {
        "content": "<p>We're not doing the shared memory buffer thing anymore with <code>expect</code> right?</p>",
        "id": 519279285,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747710820
    },
    {
        "content": "<p>You've copied the the builtins verbatim and we can cut out things we don't need right?</p>",
        "id": 519279324,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747710841
    },
    {
        "content": "<p>yes and yes!</p>",
        "id": 519279688,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747710989
    },
    {
        "content": "<p><code>expect</code> will just work the same way <code>dbg</code> does, where the host exposes a function for \"this gets called whenever an inline <code>expect</code> fails, and it's up to the host to decide what to do with that\"</p>",
        "id": 519279756,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747711023
    },
    {
        "content": "<p>I've got the tests passing now... but it's not really being used anywhere yet so it's hard to know if it's all ok. </p>\n<p>Are we still planning on compiling the builtins to bitcode and then linking with our code gen somehow? I'm interested to know whats next from here... would this PR be good to merge like this and we'll start using it sometime, somehow.</p>",
        "id": 519303659,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747723566
    },
    {
        "content": "<p>yeah we'll still need to compile them to bitcode so LLVM can import them</p>",
        "id": 519361528,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747740906
    },
    {
        "content": "<p>but for now, the interpreter needs them in a general \"just import them and start using them directly\" sense</p>",
        "id": 519361569,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747740920
    },
    {
        "content": "<p>very cool! <span class=\"user-mention\" data-user-id=\"515757\">@Luke Boswell</span> looks like CI is still failing on a bunch of missing doc comments <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 519381843,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747746896
    },
    {
        "content": "<p>I think this <code>typos</code> check is getting a bit carried away... </p>\n<div class=\"codehilite\"><pre><span></span><code>error: `numer` should be `number`\n  --&gt; ./src/builtins/dec.zig:797:56\n    |\n797 |         sr = 1 + N_UDWORD_BITS + denom_leading_zeros - numer_hi_leading_zeros;\n    |                                                        ^^^^^\n    |\n</code></pre></div>",
        "id": 519484194,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747780051
    },
    {
        "content": "<p>Or another example from CI failure</p>\n<div class=\"codehilite\"><pre><span></span><code>error: `fo` should be `of`, `for`, `do`, `go`, `to`\n  --&gt; ./src/builtins/str.zig:1198:34\n     |\n1198 |     const fo = RocStr.fromSlice(&quot;fo&quot;);\n     |                                  ^^\n     |\n</code></pre></div>",
        "id": 519484568,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747780228
    },
    {
        "content": "<p>There must be a config we're missing somewhere</p>",
        "id": 519484594,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747780244
    },
    {
        "content": "<p>What is unfortunate about this PR, is that they are all new files... so it's hard to see the individual changes from the originals.</p>",
        "id": 519494813,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747786787
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"281383\">@Richard Feldman</span> <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> I have found an issue I think with our builtins. We're now running the zig tests on Windows ARM.</p>\n<blockquote>\n<p>The test is being run on Windows with ARM64 architecture, but the inline assembly code in <code>main.zig</code> is written for x86_64 architecture (using registers like <code>%rcx</code>, <code>%rdx</code>, etc. which are specific to x86_64).</p>\n</blockquote>\n<p>I'm thinking of asking Claude for help making an implementation, or maybe stubbing it out for ARM. I'm not really sure here. Another option is to ignore the tests on Windows ARM... <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 519496227,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747787745
    },
    {
        "content": "<p>what are we using that for again? setjmp/longjmp?</p>",
        "id": 519496341,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747787811
    },
    {
        "content": "<p>and yeah I think Claude 3.7 Sonnet has a reasonable chance of translating it if it's pretty small, although at that point we do need to be pretty confident that our tests are exercising it sufficiently <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 519496407,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747787870
    },
    {
        "content": "<p>Yes, and yeah it's tiny</p>",
        "id": 519496485,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747787909
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Zig\"><pre><span></span><code><span class=\"kr\">comptime</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">builtin</span><span class=\"p\">.</span><span class=\"n\">os</span><span class=\"p\">.</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">windows</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">builtin</span><span class=\"p\">.</span><span class=\"n\">target</span><span class=\"p\">.</span><span class=\"n\">cpu</span><span class=\"p\">.</span><span class=\"n\">arch</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">x86_64</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">asm</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\.global windows_longjmp;</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\windows_longjmp:</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x00(%rcx), %rdx</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x08(%rcx), %rbx</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  # note 0x10 is not used yet!</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x18(%rcx), %rbp</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x20(%rcx), %rsi</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x28(%rcx), %rdi</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x30(%rcx), %r12</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x38(%rcx), %r13</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x40(%rcx), %r14</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x48(%rcx), %r15</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  # restore stack pointer</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x10(%rcx), %rsp</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  # load jmp address</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq 0x50(%rcx), %r8</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  # set up return value</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %rbx, %rax</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0x60(%rcx), %xmm6</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0x70(%rcx), %xmm7</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0x80(%rcx), %xmm8</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0x90(%rcx), %xmm9</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0xa0(%rcx), %xmm10</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0xb0(%rcx), %xmm11</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0xc0(%rcx), %xmm12</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0xd0(%rcx), %xmm13</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0xe0(%rcx), %xmm14</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu 0xf0(%rcx), %xmm15</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  jmp *%r8</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\.global windows_setjmp;</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\windows_setjmp:</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %rdx, 0x00(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %rbx, 0x08(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  # note 0x10 is not used yet!</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %rbp, 0x18(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %rsi, 0x20(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %rdi, 0x28(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %r12, 0x30(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %r13, 0x38(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %r14, 0x40(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %r15, 0x48(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  # the stack location right after the windows_setjmp call</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  leaq 0x08(%rsp), %r8</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %r8, 0x10(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq (%rsp), %r8</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movq %r8, 0x50(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm6,  0x60(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm7,  0x70(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm8,  0x80(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm9,  0x90(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm10, 0xa0(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm11, 0xb0(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm12, 0xc0(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm13, 0xd0(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm14, 0xe0(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  movdqu %xmm15, 0xf0(%rcx)</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  xorl %eax, %eax</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\  ret</span>\n<span class=\"w\">            </span><span class=\"sh\">\\\\</span>\n<span class=\"w\">        </span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 519496496,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747787931
    },
    {
        "content": "<p>worth a try I guess!</p>",
        "id": 519497089,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747788381
    },
    {
        "content": "<p>could also ask a new Claude chat afterwards to review the generated code, look for problems etc</p>",
        "id": 519497120,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747788413
    },
    {
        "content": "<p>No real luck unfortunately... I've got an ARM and x86 Windows machines, I might compile something and objdump that to see what zig does for setjmp and longjmp and use that asm as inspiration for our implementation. </p>\n<p>I've added a test for setjmp and longjmp that seems to be working well on all the non-Windows machines, but fails on Windows... so I'm also guessing our existing Windows impl may not be right either.</p>\n<p>Should be able to look at this sometime later in the week.</p>",
        "id": 519502041,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747791419
    },
    {
        "content": "<p>I feel like we shouldn't need those anymore</p>",
        "id": 519504094,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747792683
    },
    {
        "content": "<p>That sounds much easier... I'm not sure where we used it tbh</p>",
        "id": 519504721,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747792999
    },
    {
        "content": "<p>if I remember right, we needed them so that if a <code>crash</code> happens in a <code>roc test</code> test, we can turn that into a failed test rather than taking out the entire <code>roc test</code> run</p>",
        "id": 519508630,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747795363
    },
    {
        "content": "<p>not sure how else we'd handle that scenario other than something really heavyweight liek spawning separate OS threads or processes <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 519508670,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747795398
    },
    {
        "content": "<p>Sure, but it can be in the platform instead of in the builtins</p>",
        "id": 519508893,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795546
    },
    {
        "content": "<p>Or we can do other hacks when <code>roc_crash</code> is called.</p>",
        "id": 519508981,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795578
    },
    {
        "content": "<p>hm, does that help us? <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 519509117,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747795673
    },
    {
        "content": "<p>I guess the compiler itself can use libc's <code>setjmp</code> and <code>longjmp</code> maybe</p>",
        "id": 519509178,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747795694
    },
    {
        "content": "<p>Yeah</p>",
        "id": 519509248,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795743
    },
    {
        "content": "<p>Or if the crash is always put at the end of a test, we might be able to set a global and the just return from the crash....but that depends on a lot of things.</p>",
        "id": 519509421,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795826
    },
    {
        "content": "<p>And maybe would break things</p>",
        "id": 519509439,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795845
    },
    {
        "content": "<p>Oh wait, we'll be running the the interpreter for most tests, right? So like probably can just have it set state and then return.</p>",
        "id": 519509479,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795877
    },
    {
        "content": "<p>Idk...just ideas</p>",
        "id": 519509493,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795892
    },
    {
        "content": "<p>I'm just not a fan of having that code in the bultins</p>",
        "id": 519509508,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747795906
    },
    {
        "content": "<p>The <code>roc test</code> use case is really fuzzy for me. Would it be possible to step through it in a few dot points? </p>\n<ul>\n<li><code>roc test</code> from the cli</li>\n<li>compile app.roc into machine code test exectuable, linking with builtins (bitcode) </li>\n<li>run each test in sequence (or a single test with an argument) by calling the test executable in a child process</li>\n<li>it the test crashes record it as a failure</li>\n</ul>\n<p>^^ is this even remotely close?</p>",
        "id": 519511177,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747796972
    },
    {
        "content": "<p>Oh wait, I was thinking of our internal unit tests, not <code>roc test</code></p>",
        "id": 519511495,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797180
    },
    {
        "content": "<p>In my imagining here.. the <code>roc_crashed</code> implementation just returns from the process with a non-zero exit code</p>",
        "id": 519511523,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747797187
    },
    {
        "content": "<p>For <code>roc test</code>, I 100% think we should use subprocesses</p>",
        "id": 519511550,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797228
    },
    {
        "content": "<p>2 main reasons:</p>\n<ol>\n<li>It allows us to have parallelism configs</li>\n<li>It means we can clean up memory leaks from crashes and not have cascading memory failures.</li>\n</ol>",
        "id": 519511903,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797443
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> your not worried about spawning processes being heavyweight which I think Richard was referring to?</p>",
        "id": 519512089,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747797566
    },
    {
        "content": "<p>For tests, not really. Tests run on the human scale. Humans are slow.</p>",
        "id": 519512236,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797657
    },
    {
        "content": "<p>And you don't need a process per test, you can group things.</p>",
        "id": 519512299,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797712
    },
    {
        "content": "<p>So it will be amortized</p>",
        "id": 519512305,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797717
    },
    {
        "content": "<p>Also... the primary dev loop can probably use the interpreter for running tests. So I can imagine <code>roc test</code>  uses that, and <code>roc test --opt full</code> compiles a test exectuable using llvm and then runs the tests.</p>",
        "id": 519512518,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747797875
    },
    {
        "content": "<p>Probably compiles a shared library for the llvm case, but yeah</p>",
        "id": 519512571,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797924
    },
    {
        "content": "<p>Oh, actually, for roc, we probably don't even need full process, I think we can just use threads. They just need separate memory allocators. A gpa per thread.</p>",
        "id": 519512644,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747797963
    },
    {
        "content": "<p>Cause roc can't segfaults or crash except via <code>roc_crash</code> and <code>roc_expect_failed</code> and we can handle those cleanly.</p>",
        "id": 519512682,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798005
    },
    {
        "content": "<p>Only need a process if you are afraid of real segfaults and crashes (which correct roc code should never do and in tests, we can make memory allocation failures be treated like crashes)</p>",
        "id": 519512743,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798054
    },
    {
        "content": "<p>It's beautiful...</p>",
        "id": 519512807,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747798090
    },
    {
        "content": "<p>Only exception is stack overflows.....oh....I guess we need procresses to handle stack overflows</p>",
        "id": 519512811,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798096
    },
    {
        "content": "<p>Cause those will kill a full procress</p>",
        "id": 519512821,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798108
    },
    {
        "content": "<p>And can still exist in valid roc code</p>",
        "id": 519512830,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798118
    },
    {
        "content": "<p>Didn't we plan to leave those... and just have a timer or interrupt to check if it's still going</p>",
        "id": 519512866,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747798158
    },
    {
        "content": "<p>Not infinite loops, but stack overflows which I think kill the full process....though maybe they just kill a single thread....need to test</p>",
        "id": 519512899,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798199
    },
    {
        "content": "<p>So you fork one child process, which then runs everything in threads. If any of them stack overflow you can recover and report it.</p>",
        "id": 519513032,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747798276
    },
    {
        "content": "<p>Yeah, stack overflow kills full processes, so we need process isolation to catch them</p>",
        "id": 519513066,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798315
    },
    {
        "content": "<p>And yeah we could do that, but then you don't know which test led to the overflow (also, I guess the interpreter can catch what would ne stack overflows and report them directly)</p>",
        "id": 519513147,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798355
    },
    {
        "content": "<p>If you had a write only log each time you started/completed a test or ran the tests one at a time or something you could maybe report which one is the issue (or narrow it down)</p>",
        "id": 519513202,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747798416
    },
    {
        "content": "<p><img alt=\":nod-yes:\" class=\"emoji\" src=\"https://avatars.zulip.com/22008/emoji/images/a8fe64af.gif\" title=\"nod-yes\"></p>",
        "id": 519513283,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798454
    },
    {
        "content": "<p>Frankly, I'm really not to worried about the cost of processes. So I would vote for starting simple first.</p>",
        "id": 519513312,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798476
    },
    {
        "content": "<p>Just use process isolation for catching issues and improve with thread strategies later if it actually has issues.</p>",
        "id": 519513348,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798510
    },
    {
        "content": "<p>Spawning a process takes a few millisecond generally. And the single process can then run many tests only needing to relaunch on a stack overflow.</p>",
        "id": 519513496,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747798610
    },
    {
        "content": "<p>Well we've come a long way around... but I'm reasonably convinced we don't need setjmp and longjmp in the builtins anymore. We can add it back easily enough if that changes. Simplest way forward to land this PR and the builtins is just to remove it.</p>",
        "id": 519513553,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747798657
    },
    {
        "content": "<p>I like the idea of the platform (or test implementation) handling everything through our nice clean host ABI interface instead</p>",
        "id": 519513629,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747798696
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/channel/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler/near/519484594\">said</a>:</p>\n<blockquote>\n<p>There must be a config we're missing somewhere</p>\n</blockquote>\n<p>It's <a href=\"https://github.com/roc-lang/roc/blob/main/typos.toml\">typos.toml</a> at the root of the repo.</p>",
        "id": 519562030,
        "sender_full_name": "Anton",
        "timestamp": 1747818780
    },
    {
        "content": "<p>Yeah I played with that a bit but ended up just renaming things</p>",
        "id": 519573452,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747822269
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/channel/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler/near/519513147\">said</a>:</p>\n<blockquote>\n<p>And yeah we could do that, but then you don't know which test led to the overflow (also, I guess the interpreter can catch what would ne stack overflows and report them directly)</p>\n</blockquote>\n<p>our greenthreads approach can do that!</p>",
        "id": 519592197,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747828395
    },
    {
        "content": "<p>we'd have a global segfault handler, but it would be able to tell from the address of the segfault which guard page (on which greenthread) caused the fault, which in turn would tell us which test overflowed its stack</p>",
        "id": 519592464,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747828464
    },
    {
        "content": "<p>I think it would be really great to pursue that approach, because it's something we know we want to get working anyway for Roc hosts</p>",
        "id": 519592560,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747828490
    },
    {
        "content": "<p>and this is a way we could unblock getting it really working and robust right now</p>",
        "id": 519592592,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747828498
    },
    {
        "content": "<p>because we could set up tests in our code base where we:</p>\n<ul>\n<li>build a dylib (from a separate source file) that exposes a function which follows the new <code>host_abi.zig</code> type (e.g. varargs of pointers)</li>\n<li><code>dlopen</code> that dylib</li>\n<li>spawn a new greenthread</li>\n<li>call the function in the dylib</li>\n</ul>",
        "id": 519593645,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747828809
    },
    {
        "content": "<p>at that point, we can have different dylib source code files which simulate different conditions in a test, e.g.</p>\n<ul>\n<li>stack overflow</li>\n<li><code>crash</code></li>\n<li><code>dbg</code></li>\n<li><code>expect</code> failed</li>\n</ul>\n<p>and then we can make tests which verify that we're doing things like capturing <code>dbg</code> and failed <code>epxect</code>s, recovering from <code>crash</code> and stack overflows, etc.</p>",
        "id": 519594034,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747828920
    },
    {
        "content": "<p>and since they're green threads, we definitely wouldn't need setjmp/longjmp because all we'd do when one of them stack overflows or crashes is to just have them yield</p>",
        "id": 519594228,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747828973
    },
    {
        "content": "<p>and then the caller can say \"cool, all the memory in the arena we gave them is now garbage and we can reset the arena for another test, and all the stack memory we gave them in the greenthread is also garbage and can be reused for another greenthread too\"</p>",
        "id": 519594360,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747829017
    },
    {
        "content": "<p>in other words, the cleanup is just \"those resources are available for something else now\"</p>",
        "id": 519594390,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747829026
    },
    {
        "content": "<p>I don't think we should use arenas for tests</p>",
        "id": 519633133,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747839011
    },
    {
        "content": "<p>But otherwise, yeah, agree</p>",
        "id": 519633183,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747839023
    },
    {
        "content": "<p>We should not use arenas cause we don't know what code the user is testing and if it will actually run on arenas<br>\n If the tests lead to tons of reallocations, they might oom with arenas, but work fine with a standard allocator. I think we likely want a standard allocator per thread.</p>",
        "id": 519633708,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747839153
    },
    {
        "content": "<p>That said, I do think the test platform could be a lot simpler than a full green thread platform.. cause it only has compute heavy work and no async requests to wait on. So it really just needs a process per core and a single fake stack per process to avoid stack overflows. Then would just hot loop perform compute for tests.</p>",
        "id": 519635764,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747839637
    },
    {
        "content": "<p>But we could still build out a full green thread base if we prefer, just to really push and build out the primitives.</p>",
        "id": 519635910,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747839673
    },
    {
        "content": "<p>Oh, other big opportunity. Tests have no inputs, can we make the interpreter able to just run them. No dylib or linking at all, and smarter debug info around things like stack overflows and maybe eventually other things?</p>",
        "id": 519637516,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747840057
    },
    {
        "content": "<p>yeah I think so!</p>",
        "id": 519692749,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747857936
    },
    {
        "content": "<p>and yeah I agree about greenthreads not being strictly a requirement here, but it seems to me like:</p>\n<ul>\n<li>greenthreads are something we know we want</li>\n<li>this is a way we can start getting them in place and tested across targets that is totally unblocked</li>\n<li>they check all the boxes in terms of what we need for tests (stack overflow handling etc)</li>\n</ul>",
        "id": 519693062,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747858026
    },
    {
        "content": "<p>Yep</p>",
        "id": 519722243,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747872537
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> do you have any interest in trying that out, based on the greenthread code you've already done? I think you're the foremost expert in greenthreads right now! <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 519723069,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747873095
    },
    {
        "content": "<p>Yes, though not sure I have the time currently</p>",
        "id": 519724263,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747873892
    },
    {
        "content": "<p>cool cool!</p>",
        "id": 519724733,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747874249
    },
    {
        "content": "<p>Do the green threads thing work for Windows?</p>",
        "id": 519743466,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747887243
    },
    {
        "content": "<p>I'm just wondering if it's similar i.e. with dlopen and a dynamic library</p>",
        "id": 519743481,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747887261
    },
    {
        "content": "<p>Maybe we need to start with a subprocess anyway</p>",
        "id": 519743488,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1747887275
    },
    {
        "content": "<p>Green threads should work on windows the same as Linux</p>",
        "id": 519746288,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747889345
    },
    {
        "content": "<p>Only place they won't work is wasm</p>",
        "id": 519746298,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747889353
    },
    {
        "content": "<p>All they are is a chunk of memory for a call stack and a tiny bit of assembly to jump into it</p>",
        "id": 519746326,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1747889378
    },
    {
        "content": "<p>I remember looking into wasm and concluding it was possible but required getting JS involved behind the scenes</p>",
        "id": 519806778,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1747912049
    },
    {
        "content": "<p>You can compile green threads into a state machine, similar to what happens with rust futures or Quasar from the Java world</p>",
        "id": 520483552,
        "sender_full_name": "Joshua Warner",
        "timestamp": 1748273987
    },
    {
        "content": "<p>I feel like that would just be for cooperative green threads</p>",
        "id": 520484300,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1748274210
    },
    {
        "content": "<p>But don't actually know for sure</p>",
        "id": 520484348,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1748274221
    },
    {
        "content": "<p>By cooperative, do you mean non-preemptable?</p>",
        "id": 520484507,
        "sender_full_name": "Joshua Warner",
        "timestamp": 1748274263
    },
    {
        "content": "<p>Yes</p>",
        "id": 520484567,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1748274285
    },
    {
        "content": "<p>The compiler can always do things like insert yields at the start of recursive functions (and loops), so if you want it to be preemptable, it can be made so.</p>",
        "id": 520484617,
        "sender_full_name": "Joshua Warner",
        "timestamp": 1748274304
    },
    {
        "content": "<p>Yeah, but that tends not to work well in practice. I mean it isn't terrible or anything, but after years of trying to avoid it, go added preemption. Either you have too much overhead or you risk getting stuck in a single rogue thread (even if not fully stuck, you often can get locked in major latency ruining and CPU unfair splits)</p>",
        "id": 520485043,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1748274459
    },
    {
        "content": "<p>Yeah there's definitely a bunch of overhead in adding yields all over the place - but my point was just that it's possible to \"compile-in\" pre-emptability; it doesn't actually have to be a native property of the system you're running on</p>",
        "id": 520485639,
        "sender_full_name": "Joshua Warner",
        "timestamp": 1748274656
    },
    {
        "content": "<p>That can be made lower overhead by not yielding if it hasn't been over some configurable amount of \"time\" (e.g. a count of candidate yields passed, or an approximate instruction count, etc)</p>",
        "id": 520485979,
        "sender_full_name": "Joshua Warner",
        "timestamp": 1748274798
    },
    {
        "content": "<p>Yep</p>",
        "id": 520491734,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1748276850
    }
]
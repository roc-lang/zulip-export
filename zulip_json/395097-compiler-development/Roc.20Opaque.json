[
    {
        "content": "<p>When dealing with \"Model\" types in apis, the standard way to interact with them is essentially to pass a box to the host.</p>\n<p>This is seen in the host api as <code>Box a</code>.<br>\nCurrently glue does not really support this correctly and we have to modify the api to make glue happily generate. Generally by temporarily changing the type to <code>Box {}</code>. This will lead to glue generating <code>RocBox&lt;{}&gt;</code>.</p>\n<p>This type mostly works, but can not actually free the underlying roc allocation (the host doesn't know how).</p>\n<hr>\n<p>I think we can give a nicer (though not perfect) story to this case.<br>\nWe can make glue specially handle <code>Box typevar</code> such that it will generate what I am calling \"Roc Opaque\".</p>\n<p>\"Roc Opaque\" will work very similar to \"RocBox&lt;{}&gt;\". It will have an explicit <code>inc</code> and <code>dec</code> function that can be called. That said, it will recognize that only roc can free the underlying type. As such, it will panic if the type is decremented enough such that it would be freed.</p>\n<hr>\n<p>This gets us 3 things:</p>\n<ol>\n<li>No weird work around needed to run glue on apis with <code>Box a</code>. It just works and generates <code>RocOpaque</code>.</li>\n<li>No need to design model apis such that we have to pass in and get back the model on every call. You can do:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">roc_init</span><span class=\"p\">();</span>\n<span class=\"k\">while</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">roc_update</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">inputs</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">model</span><span class=\"p\">.</span><span class=\"n\">inc</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">roc_render</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"c1\">// render out</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<ol start=\"3\">\n<li>The explicit panic on freeing the <code>RocOpaque</code> ensures that platforms are written correctly instead of accidentally leaking the model. (of course at the end of the app, a model can be explicitly forgotten instead of freed).</li>\n</ol>\n<p>Thoughts?</p>",
        "id": 432388295,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1712718442
    },
    {
        "content": "<p>makes sense to me! <span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span> any thoughts?</p>",
        "id": 432480145,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1712747867
    }
]
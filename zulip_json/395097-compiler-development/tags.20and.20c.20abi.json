[
    {
        "content": "<p>I think I just realized part of the reason we have been having some any issues with tags being passed between rust and roc. Especially around types like <code>RocResult&lt;U64, ()&gt;</code>. We have been representing tag types roc in llvm and that is leading to them being passed incorrectly.</p>\n<p>We represent that type as <code>[0xi64, 1xi64, 1xi8, 7xi8]</code>. That is <code>0xi64</code> to get the alignment correct. <code>1xi64</code> as the payload. <code>1xi8</code> as the tag, and <code>7xi8</code> as the padding.</p>\n<p>The padding being represented in the type messes up c-abi. Let's ignore the <code>0xi64</code> for now, llvm doesn't actually admit anything for it to my knowledge.</p>\n<p><code>1xi64, 1xi8</code> and <code>1xi64, 1xi8, 7xi8</code> are not compatible when it comes to c-abi. <code>1xi64, 1xi8</code> will be passed in two register. <code>1xi64, 1xi8, 7xi8</code> will be passed on the stack due to containing too many values to be passed in registers. So here and likely a few other places, we need to remove the explicit padding from our types. This will also be important in the rust glue. Representing padding explicitly is not valid and will change the c-abi of a type.</p>",
        "id": 470770367,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726528447
    },
    {
        "content": "<p>TLDR, we need to change our tag representation and it should fix some bugs we have been hitting</p>",
        "id": 470770432,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726528468
    },
    {
        "content": "<p>Makes sense why we have been hitting so many confusing bugs since we change to tasks everywhere a lot more. <code>Task SomeType {}</code> that is being passed incorrectly via c-abi currently.</p>",
        "id": 470770663,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726528556
    },
    {
        "content": "<p>This is at least the core of the fix: <a href=\"https://github.com/roc-lang/roc/pull/7084\">https://github.com/roc-lang/roc/pull/7084</a></p>\n<p>I am still seeing issues with nqueens in false interpreter, but I'm not sure the cause at this point. Assuming this passes tests, I think it should be good to merge.</p>",
        "id": 470779471,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726531997
    },
    {
        "content": "<p>Oh, I see the next issue:<br>\nFor <code>u8, u8</code> which is what is generated by <code>Task U8 {}</code>, Rust is packing both <code>u8</code> into a single register <code>w0</code>. Roc is expecting them to be put in two registers, <code>w0</code> and <code>w1</code>....not sure why yet</p>",
        "id": 470780709,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726532436
    },
    {
        "content": "<p>Hmm, maybe it is due to representing the type as <code>{ [1xi8], i8}</code> in llvm instead of <code>{i8, i8}</code>. Not sure the best way to fix that....</p>",
        "id": 470781381,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726532659
    },
    {
        "content": "<p>Guess I need to mess around more</p>",
        "id": 470781503,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726532681
    },
    {
        "content": "<p>Even if I change rust to use a <code>[1xi8]</code>, it still seems to be packing everything into a single register while llvm with roc is not.... This may be a case where we need more special handling cause llvm doesn't fully handle abi......</p>",
        "id": 470790477,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726534720
    },
    {
        "content": "<p>Luckily an easy workaround is just to make the type bigger <code>Task U64 {}</code> works fine and doesn't pack into a single register, but I should try to figure out a more proper fix.</p>",
        "id": 470790838,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726534869
    },
    {
        "content": "<p>Oh, I think we may be using llvm cc instead of the c calling convention here.</p>",
        "id": 470791040,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726534970
    },
    {
        "content": "<p>Cause it is faster to pass in two regs than pack into one and unpack on the other side</p>",
        "id": 470791065,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726534986
    },
    {
        "content": "<p>hmm...but we set the call conv to c. So that shouldn't be it. But maybe we need to manually deal with something here. Not fully sure.</p>",
        "id": 470791396,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726535125
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"515757\">@Luke Boswell</span>, I think <a href=\"https://github.com/roc-lang/roc/pull/7084\">https://github.com/roc-lang/roc/pull/7084</a> fixes your issues with <a href=\"https://github.com/roc-lang/basic-webserver/pull/72\">https://github.com/roc-lang/basic-webserver/pull/72</a></p>",
        "id": 470793820,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726536134
    },
    {
        "content": "<p>I thought at some point <span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span> and I were looking at an ABI issue and concluded that maybe we couldn't have a <code>RocResult</code> abstraction in Rust and instead needed to have glue generate a tag union every time, but I don't remember what the details were anymore <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 470793955,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1726536216
    },
    {
        "content": "<p>I can think of 2 issues:</p>\n<ol>\n<li>It would be incorrect in the case where there is no err type (as in <code>[]</code> for the err type instead of <code>{}</code>). Cause there will be no tag in that case.</li>\n<li>It will be incorrect if the tag has more than 255 variants.</li>\n</ol>",
        "id": 470794150,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726536301
    },
    {
        "content": "<p>But neither of those should apply here.</p>",
        "id": 470794169,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726536309
    },
    {
        "content": "<p>For the issue of <code>Result U8 {}</code> being passed in a single register by rust, but two registers by our llvm ir (at least that is what looks to be happening from what I can tell), it may be a case that we need to manually pack certain types when sending things over c abi.</p>",
        "id": 470794709,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726536520
    },
    {
        "content": "<p>So we may need to convert the llvm type from <code>{[1xi8], i8}</code> to <code>i16</code>. Same with any other cases that the c abi would pack into a single register.</p>",
        "id": 470794954,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726536591
    },
    {
        "content": "<p>But that is just a guess from what seems to be happening</p>",
        "id": 470795014,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726536603
    },
    {
        "content": "<p>Nice work Brendan!</p>",
        "id": 470796852,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1726536990
    },
    {
        "content": "<p>Yeah, it looks like we don't handle these for aggregate types:</p>\n<blockquote>\n<p>Types less than or equal to 8 bytes are returned in x0.<br>\nTypes less than or equal to 16 bytes are returned in x0 and x1, with x0 containing the lower-order 8 bytes.</p>\n</blockquote>",
        "id": 470797585,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726537259
    },
    {
        "content": "<p>So more c call conv cases that aren't covered by llvm and we need to do manually.</p>",
        "id": 470797697,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726537282
    },
    {
        "content": "<p>I'll fix this in a different PR. How things are wired currently, this feels like more of a hassle to fix than I want to deal with at this exact moment. Nothing specifically, hard, but a solid bit of wiring.</p>",
        "id": 470800731,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726538364
    },
    {
        "content": "<p>How this impacts things in practice: Anything that returned from the host, is less than 9 bytes, and is a <code>Task SomeOk SomeErr</code>, probably won't work (at least not on all architectures). Also, if it is less than 17 bytes, it may have issues but that is less likely to be problematic.</p>\n<p>So <code>Task U8 {}</code> fails for example, but can be worked around in rust by changing the type to <code>RocResult&lt;u64, ()&gt;</code>.</p>\n<p>This is a pre-existing bug, just made obvious and much more common by the Task as builtin PR.</p>",
        "id": 470801332,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726538602
    },
    {
        "content": "<p>great find! <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 470801920,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1726538814
    },
    {
        "content": "<p>I guess sending enumerations to the host would run into this</p>",
        "id": 470801954,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1726538834
    },
    {
        "content": "<p>because they're <code>U8</code> under the hood</p>",
        "id": 470801964,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1726538840
    },
    {
        "content": "<p>I can have a closer look tonight. This is awesome. Looking forward to JWT in basic-webserver <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 470802127,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1726538900
    },
    {
        "content": "<p>Yeah, this will be hit my anything that is a return type from the host and is an aggregate type under 9/17 bytes depending on the architecture. So a <code>{ a: U8, b: U8}</code> would also hit this.</p>",
        "id": 470802275,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1726538969
    },
    {
        "content": "<p>Looks like it's working <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> -- just testing on that JWT PR for basic-webserver</p>",
        "id": 470923177,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1726565224
    }
]
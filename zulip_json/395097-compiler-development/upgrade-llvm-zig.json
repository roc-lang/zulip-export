[
    {
        "content": "<p>I managed to learn just enough nix to update the flakes and get a dev shell set up with the correct dependencies for llvm17 and zig12, I pushed it to <a href=\"https://github.com/roc-lang/roc/tree/llvm17-zig12\">the llvm17-zig12 branch</a>.</p>",
        "id": 453602243,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721800519
    },
    {
        "content": "<p>Actually... maybe not. I'm close though</p>",
        "id": 453602573,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721800745
    },
    {
        "content": "<p>Should we go straight for llvm18 and zig13?</p>",
        "id": 453605048,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721801842
    },
    {
        "content": "<p>They are both out, right?</p>",
        "id": 453605071,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721801849
    },
    {
        "content": "<p>Yeah, I looked at that. The only thing I wasn't 100% on was inkwell</p>",
        "id": 453605085,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721801865
    },
    {
        "content": "<p>If we pin to tag 0.4.0 then it looks like that includes 17, but 18 is still sitting in a CI branch and I'm guessing not ready</p>",
        "id": 453605148,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721801898
    },
    {
        "content": "<p>inkwell github says it support llvm 18</p>",
        "id": 453605151,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721801900
    },
    {
        "content": "<p>I know it in the README, but I couldn't make cargo happy. It was saying it didn't exist</p>",
        "id": 453605282,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721801947
    },
    {
        "content": "<p>Ah, I see, that is master. 0.4.0 is only to llvm 17</p>",
        "id": 453605351,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721801965
    },
    {
        "content": "<p>I'm currently fumbling around trying to understand the differences between rust's llvm-sys, and why is needs a very specific binary to check the llvm version. That binary isn't provided in the newer <a href=\"https://search.nixos.org/packages?channel=24.05&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=llvmPackages_18.clang\">llvmPackages_18.clangUseLLVM</a></p>",
        "id": 453605773,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721802086
    },
    {
        "content": "<p>Yeah, looks like they have everything update for 18, but haven't cut a release yet</p>",
        "id": 453605778,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721802089
    },
    {
        "content": "<p>Honestly, I would just pin the release to a git commit for now, update to llvm18 and avoid the need for two separate updates.</p>",
        "id": 453605908,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721802129
    },
    {
        "content": "<p>Or fork and tag in a fork. I know we've done this before, not sure the exact mechanism though.</p>",
        "id": 453606008,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721802157
    },
    {
        "content": "<p>I know the zig upgrade to 12/13 was quite painless before the recent refcount changes. I can motor through to bulk of that, but there's some low level stuff I can't fixup. One example was we are using overflow flag from a builtin (I think) and it's no longer available in the later versions.</p>",
        "id": 453606315,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721802244
    },
    {
        "content": "<p>I spent a bit of time trying to update our builtins for the roc-wasm4 stuff, and that was the point I got stuck and deferred for a laterday.</p>",
        "id": 453606416,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721802281
    },
    {
        "content": "<p>I figure, first stop is just getting our nix dependencies happy and working from there. </p>\n<p>I don't have any experience with these kind of upgrades... just learning as I go</p>",
        "id": 453606619,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721802334
    },
    {
        "content": "<p>Can we just track master maybe, and as we get closer we can pin to a specific tag, or maybe a later release?</p>",
        "id": 453607759,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721802644
    },
    {
        "content": "<p>From the llvm-sys crate docs</p>\n<blockquote>\n<p>llvm-sys requires a copy of <code>llvm-config</code> corresponding to the desired version of LLVM to build: <code>llvm-config</code> allows it to probe what libraries need to be linked and what compiler options are required.</p>\n</blockquote>\n<blockquote>\n<p>Binary distributions of LLVM (including the official release packages) generally<strong>do not</strong> include a copy of <code>llvm-config</code>, making them unsuited to use for building programs with <code>llvm-sys</code>. Known exceptions (that <em>do</em> include a copy of <code>llvm-config</code>) include:<br>\n* Official Debian/Ubuntu packages from <a href=\"https://apt.llvm.org/\">apt.llvm.org</a><br>\n* Arch Linux's <a href=\"https://archlinux.org/packages/extra/x86_64/llvm/\"><code>llvm</code></a> package</p>\n</blockquote>\n<blockquote>\n<p>If a suitable binary package is not available for your platform, compiling from source is usually the best option. See <a href=\"https://crates.io/crates/llvm-sys#compiling-llvm\">Compiling LLVM in this document</a> for details.</p>\n</blockquote>\n<p>How would we work around this if nix doesn't provide that binary?</p>",
        "id": 453608648,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721802914
    },
    {
        "content": "<blockquote>\n<p>Can we just track master maybe, and as we get closer we can pin to a specific tag, or maybe a later release?</p>\n</blockquote>\n<p>Yeah, I think that's fine. At a minimum it's fine for local testing</p>",
        "id": 453609101,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721803075
    },
    {
        "content": "<blockquote>\n<p>How would we work around this if nix doesn't provide that binary?</p>\n</blockquote>\n<p>Should be part of the llvm nix package I believe</p>",
        "id": 453609169,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721803096
    },
    {
        "content": "<p>nvm, I was using the wrong nix package and output. It's <strong>llvmPackages_18.libllvm.dev</strong> not <strong>llvmPackages_18.clangUseLLVM.out</strong></p>",
        "id": 453609488,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721803266
    },
    {
        "content": "<p>Great, now Im through to actual roc code issues.</p>",
        "id": 453609555,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721803313
    },
    {
        "content": "<p>There isn't a nix package for zig 13 yet. But I'll just leave it as 12 for now as they are very similar, and it should be really easy to upgrade when there is a release.</p>",
        "id": 453609904,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721803505
    },
    {
        "content": "<p>Ah, then I guess you have to use llvm17. I think our version of llvm has to match zigs....though it may be fine if our version of llvm is newer than zigs. Cause llvm probably can load old llvm ir.</p>",
        "id": 453609976,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1721803551
    },
    {
        "content": "<p>Also pushed to a new branch that is less confusing <a href=\"https://github.com/roc-lang/roc/tree/upgrade-llvm-zig\">https://github.com/roc-lang/roc/tree/upgrade-llvm-zig</a></p>",
        "id": 453610055,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721803575
    },
    {
        "content": "<p>I forgot about that</p>",
        "id": 453610098,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721803602
    },
    {
        "content": "<p>Ok, based on my 2 minutes research... We have zig producing LLVM bitcode. Zig 12 produces LLVM 17.0.6, so I think we should keep them paired just in case.</p>",
        "id": 453610852,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721804038
    },
    {
        "content": "<blockquote>\n<p><code>Cause llvm probably can load old llvm ir.</code> </p>\n</blockquote>\n<p>does this help? <a href=\"https://releases.llvm.org/18.1.0/docs/ReleaseNotes.html#changes-to-the-llvm-ir\">https://releases.llvm.org/18.1.0/docs/ReleaseNotes.html#changes-to-the-llvm-ir</a></p>",
        "id": 453611688,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721804415
    },
    {
        "content": "<p>I just search all of the builtins bitcode <code>.ll</code> files and none of these are used. So maybe we should be fine.</p>",
        "id": 453611899,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721804519
    },
    {
        "content": "<p>Ok, so back to a happy place. <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<p>I've got to the following point;</p>\n<ul>\n<li>Updated flakes to give us llvm 18, and zig 13 (also added zls 13) </li>\n<li>I switched to using the zig and zls overlays which look to build from source, so we can get any version we want much easier.</li>\n</ul>\n<p>Now I'm up to cargo build crashing at the builtins, which is because of the obvious changes between zig versions.</p>",
        "id": 453622479,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721807834
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"666594\">@John Murray</span>  -- it's been a while, but wondering if you would be able to skim through my flake changes and let me know if there is anything I've probably broken?? <a href=\"https://github.com/roc-lang/roc/tree/upgrade-llvm-zig\">https://github.com/roc-lang/roc/tree/upgrade-llvm-zig</a></p>",
        "id": 453622684,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721807902
    },
    {
        "content": "<p>zig 13 is on the latest nix unstable which we can easily use by updating to a more recent commit <a href=\"https://github.com/roc-lang/roc/blob/d5db3137a3d8da46f92c31b6bf088bc495f759c2/flake.nix#L5\">here</a>. It's just called zig, not zig_0_13. I'd prefer to use that over the overlay because it's less complex.</p>",
        "id": 453648353,
        "sender_full_name": "Anton",
        "timestamp": 1721814519
    },
    {
        "content": "<p>Ok, sounds good. </p>\n<p>What is the difference between a release like <code>24.05</code> and <code>unstable</code>? Is it like tracking main but we can still pin to a specific commit? With the intention to switch to a release later when it's available.</p>",
        "id": 453674778,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721822542
    },
    {
        "content": "<blockquote>\n<p>Is it like tracking main but we can still pin to a specific commit?</p>\n</blockquote>\n<p>Yes, exactly. I think the main benefit of using e.g. 24.05 is better caching and build times.</p>",
        "id": 453676021,
        "sender_full_name": "Anton",
        "timestamp": 1721822867
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> -- I had a crack at switching back to using the unstable branch. I had a few issues though. For some reason that <code>llvm_18</code> package doesn't include the same folder structure. It doesn't include a <code>/lib</code>, and it's missing <code>lld</code>. I've just left it using zig-overlay for now.</p>",
        "id": 454143028,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1721958708
    },
    {
        "content": "<p>It has multiple outputs, I would try <code>llvm_18.dev</code> or <code>llvm_18.lib</code></p>",
        "id": 454150846,
        "sender_full_name": "Basile Henry",
        "timestamp": 1721962123
    },
    {
        "content": "<p>Quick update on this. </p>\n<p>To get the compiler compiling, all we needed to do was comment out a few calls to different LLVM optimisation passes, as these are no longer exposed in the new Inkwell API. I ran the gen-llvm tests and had only 1 failure. Our examples seems to run fine. But I think we should investigate what impact the API change has, and if we need to do something differently to turn optimisations on, or if it's just on by default now. </p>\n<p>The next issue with this change is that zig has changed it's cli arguments, and the <code>--mod</code> and <code>--deps</code> arguments are no longer available. We used these to pass in the zig builtins \"glue\" code for each of the platform's hosts. </p>\n<p>Thanks to <span class=\"user-mention\" data-user-id=\"453714\">@Ryan Barth</span> who helped me come up with a really simple way to workaround this issue. I had been exploring using zig packages, and build scripts and all kinds of things but thankfully these aren't necessary. </p>\n<p>We can simply use a bash script and copy the zig src files into the platform directories. There doesn't need to be any big changes, and this also plays nicely with the refactor host PR. We can gitignore the copied files, and when the script re-runs it will overwrite these.</p>\n<p>So I'm just working on making this script and having it called once before the tests are run. Then we should be able to run the full test suite and see if anything breaks.</p>",
        "id": 454547309,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722127330
    },
    {
        "content": "<p>Ok, so I think I have all of the fiddly and tedious bits out of the way. We've upgraded the test platforms, zig builtins etc. </p>\n<p>I've left the CI parts to work through with Anton later, as we may want to do things differently -- but that should be really straightforward I think.</p>\n<p>I'm only seeing 1 test failure when running gen-test-llvm, <code>num_to_str_f32</code> -- I'm thinking this will be a simple fix, but haven't really looked at the IR or anything yet. (not that I know what I'm looking for <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span> )</p>\n<div class=\"codehilite\"><pre><span></span><code>---- gen_num::num_to_str_f32 stdout ----\nthread &#39;gen_num::num_to_str_f32&#39; panicked at crates/compiler/test_gen/src/helpers/llvm.rs:575:13:\nassertion `left == right` failed: LLVM test failed\n  left: &quot;340282350000000000000000000000000000000&quot;\n right: &quot;340282346638528860000000000000000000000&quot;\n\n\nfailures:\n    gen_num::num_to_str_f32\n\ntest result: FAILED. 1293 passed; 1 failed; 17 ignored; 0 measured; 0 filtered out; finished in 612.91s\n</code></pre></div>\n<p>The only other tests that are failing now are in <code>roc_glue</code> which all look to be related to the same issue. I think its related to zig builtin linking -- maybe zig changed the way it does things or something about remove dead code maybe.</p>\n<div class=\"codehilite\"><pre><span></span><code>$ ./target/debug/roc build crates/glue/tests/fixtures/basic-record/app.roc\n🔨 Rebuilding platform...\nUndefined symbols for architecture arm64:\n  &quot;_roc_getppid&quot;, referenced from:\n      _roc_builtins.utils.expect_failed_start_shared_file in roc_appNDMFxA.o\n      _roc_builtins.utils.read_env_shared_buffer in roc_appNDMFxA.o\n  &quot;_roc_mmap&quot;, referenced from:\n      _roc_builtins.utils.expect_failed_start_shared_file in roc_appNDMFxA.o\n      _roc_builtins.utils.read_env_shared_buffer in roc_appNDMFxA.o\n  &quot;_roc_shm_open&quot;, referenced from:\n      _roc_builtins.utils.expect_failed_start_shared_file in roc_appNDMFxA.o\n      _roc_builtins.utils.read_env_shared_buffer in roc_appNDMFxA.o\nld: symbol(s) not found for architecture arm64\ncrates/glue/tests/fixtures/basic-record/app: is already signed\nthread &#39;main&#39; panicked at crates/compiler/build/src/program.rs:1031:17:\nnot yet implemented: gracefully handle `ld` (or `zig` in the case of wasm with --optimize) returning exit code Some(1)\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre></div>",
        "id": 454580377,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722151779
    },
    {
        "content": "<p>Also, I would appreciate assistance from anyone with rust or LLVM knowledge to look at the changes in <code>crates/compiler/gen_llvm/src/llvm/build.rs</code> and help me investigate what the changes mean. </p>\n<p>I think <a href=\"https://releases.llvm.org/17.0.1/docs/ReleaseNotes.html#changes-to-llvm-infrastructure\">this is the relevant part</a> of the release notes. </p>\n<blockquote>\n<ul>\n<li>The legacy optimization pipeline (<code>PassManagerBuilder.h</code>) has been removed. See the <a href=\"https://llvm.org/docs/NewPassManager.html\">new pass manager docs</a> for how to use the new pass manager APIs.</li>\n</ul>\n</blockquote>",
        "id": 454580710,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722152053
    },
    {
        "content": "<p>I bet that zig changed there float printing algorim and how it rounds</p>",
        "id": 454580935,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1722152386
    },
    {
        "content": "<p>So I bet the test case is incorrect now.</p>",
        "id": 454580936,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1722152396
    },
    {
        "content": "<p>What a guess. Looks like your correct <span aria-label=\"smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"smile\">:smile:</span></p>\n<h2>0.11.0</h2>\n<div class=\"codehilite\"><pre><span></span><code>$ zig build run\nAll your 340282346638528860000000000000000000000 are belong to us.\nRun `zig build test` to run the tests.\n</code></pre></div>\n<h2>0.13.0</h2>\n<div class=\"codehilite\"><pre><span></span><code>(nix:nix-shell-env) 192-168-1-103:zig-test-13 luke$ zig build-exe src/main.zig &amp;&amp; ./main\nAll your 340282350000000000000000000000000000000 are belong to us.\n</code></pre></div>",
        "id": 454597015,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722162866
    },
    {
        "content": "<p>I work with floats a lot in ml....that just looked correct to be the minimum length float that still would parse back to the original value</p>",
        "id": 454633865,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1722184199
    },
    {
        "content": "<blockquote>\n<p>Also, I would appreciate assistance from anyone with rust or LLVM knowledge to look at the changes</p>\n</blockquote>\n<p>I would try to find other rust projects that use inkwell and that have already performed this update to the new pass manager.</p>",
        "id": 454774325,
        "sender_full_name": "Anton",
        "timestamp": 1722245102
    },
    {
        "content": "<p>Thanks to <span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span> we're down to one issue blocking a run at CI now I think -- just the \"Undefined symbols for architecture arm64\" thing above which I haven't looked into yet.</p>\n<p>We got the optimisation passes back (or at least hacked in) and working for llvm, and fixed the <code>gen_num::num_to_str_f32</code> test.</p>",
        "id": 455206066,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722368586
    },
    {
        "content": "<p>Ok, 100% tests are <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span>  passing on my mac <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 455283086,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722401451
    },
    {
        "content": "<p>I might give CI a run just to see if everything passes there too. </p>\n<p>Still need to cleanup the LLVM stuff, mostly ripping out the unused things, and also fixing up the pointer types which are giving us a warning now -- but should be pretty straight forward.</p>",
        "id": 455283385,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722401560
    },
    {
        "content": "<p>We are still using the zig and zls overlays... I couldn't get the nixpkgs thing working when I tried. I might defer changing that back to someone who knows what they are doing.</p>",
        "id": 455283732,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722401696
    },
    {
        "content": "<p>Also, there are documentation and various references to the old LLVM 16 which need to be updated</p>",
        "id": 455283913,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722401759
    },
    {
        "content": "<p>Ok, CI fails with this. Which I think means I've done something wrong in <code>nix/builder.nix</code> </p>\n<div class=\"codehilite\"><pre><span></span><code>$ nix build\nwarning: Git tree &#39;/Users/luke/Documents/GitHub/roc&#39; is dirty\nwarning: input &#39;rust-overlay&#39; has an override for a non-existent input &#39;flake-utils&#39;\nerror: builder for &#39;/nix/store/gi3j8vs8qq54zy5vv0zji6h2l6cdrqsv-roc_cli-0.0.1.drv&#39; failed with exit code 101;\n       last 25 log lines:\n       &gt;    Compiling roc_bitcode_bc v0.0.1 (/private/tmp/nix-build-roc_cli-0.0.1.drv-0/source/crates/compiler/builtins/bitcode/bc)\n       &gt;    Compiling packed_struct v0.10.1\n       &gt;    Compiling inkwell v0.4.0 (https://github.com/TheDan64/inkwell?rev=89e06af#89e06af9)\n       &gt; error: No suitable version of LLVM was found system-wide or pointed\n       &gt;               to by LLVM_SYS_180_PREFIX.\n       &gt;\n</code></pre></div>\n<p><code>nix develop</code> work for me, so it's just a nix setup thing.</p>",
        "id": 455286040,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722402790
    },
    {
        "content": "<p>I think I (actually Claude) found a solution.</p>",
        "id": 455288125,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722404150
    },
    {
        "content": "<p>Awesome thing about the llvm 18 upgrade. Nice perf gain:</p>\n<div class=\"codehilite\"><pre><span></span><code>Summary\n  ./cc-fluxsort ran\n    1.20 ± 0.02 times faster than ./roc-builtinsort-new\n    1.36 ± 0.02 times faster than ./cc-quadsort\n    1.64 ± 0.02 times faster than ./roc-builtinsort-old\n</code></pre></div>\n<p>Not quite up to speed with raw c++ on m1 mac, but now in the same ballpark.</p>",
        "id": 455543313,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1722484745
    },
    {
        "content": "<p>I think we also just run more passes now maybe? anyway that is really nice</p>",
        "id": 455576376,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1722497924
    },
    {
        "content": "<p>(deleted)</p>",
        "id": 456244994,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722731519
    },
    {
        "content": "<p>Update with this PR. </p>\n<p>It's passing all tests on macos in the nix shell for me locally. I've kicked off CI to see if it passes there too. </p>\n<p>Our CI machines don't have ZIG 13 and LLVM 18 installed, so I expect the non-nix machines to fail.</p>\n<p>I've cleaned up all of the LLVM issues, and updated the stray references to LLVM 16 -- there's some work here to upgrade the CI machines and build scripts. I don't think I can make progress this part without Anton.</p>\n<p>There is one blocking issue on linux that needs further investigation. Unfortunately, I don't think I can make much progress to investigate this. It looks to be related to absolute relocations in the surgical linker. <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> and I thought we fixed it by adding an llvm <code>globaldce</code> pass, but it's still an issue.</p>\n<div class=\"codehilite\"><pre><span></span><code>___________\nThe roc command:\n\n  &quot;/home/lb-dev/Documents/Github/roc/target/release/roc --max-threads=1 /home/lb-dev/Documents/Github/roc/examples/helloWorld.roc --&quot;\n\nhad unexpected stderr:\n\n  The surgical linker currently has issue #3609 and would fail linking your app.\nPlease use `--linker=legacy` to avoid the issue for now.\n\n___________\n</code></pre></div>\n<p><strong>TLDR</strong> - we're really close, one linux surgical linker issue and then just CI admin to go. <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 456262994,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722742579
    },
    {
        "content": "<p>New linux specific issue</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;cli_run::expects_dev_and_test&#39; panicked at crates/cli/tests/cli_run.rs:153:13:\n\n___________\nThe roc command:\n\n  &quot;/home/lb-dev/Documents/Github/roc/target/debug/roc dev --max-threads=1 /home/lb-dev/Documents/Github/roc/crates/cli/tests/expects/expects.roc --&quot;\n\nhad unexpected stderr:\n\n  🔨 Rebuilding platform...\nthread 220007 panic: cast causes pointer to be null\n/nix/store/5yk32f31879lfsnyv0yhl0af0v2dz9dz-zig-0.13.0/lib/zig/std/start.zig:497:40: 0x55555560ee46 in main (host)\n    return callMainWithArgs(@as(usize, @intCast(c_argc)), @as([*][*:0]u8, @ptrCast(c_argv)), envp);\n                                       ^\n???:?:?: 0x7ffff7df214d in ??? (libc.so.6)\nUnwind information for `libc.so.6:0x7ffff7df214d` was not available, trace may be incomplete\n\n\n___________\n</code></pre></div>",
        "id": 456299376,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722766829
    },
    {
        "content": "<p>I think I found the issue -- hard to know until I get the changes across to my linux machine and run a full test suite. But basically zig is stricter now with exporting symbols I think -- and the ABI of those symbols. So you can't have a host with signature <code>pub fn main() !void {</code> any longer, it needs to be <code>pub export fn main() u8</code> to link correctly with the roc side.</p>",
        "id": 456305286,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722769113
    },
    {
        "content": "<p>I've got most of the CI tests passing on macos/linux now. </p>\n<p>I'm down to the wasm repl tests and we've got a bunch of errors like</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at crates/repl_wasm/src/repl.rs:265:86:\ncalled `Result::unwrap()` on an `Err` value: ParseError { offset: 469912, message: &quot;Unknown relocation type 0x b&quot; }\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre></div>\n<p>I haven't figured out where this is coming from.</p>\n<p>My best guess is that zig 13 behaves differently -- and the way are using zig to build the test platform, get wasi-libc, and linking things together needs to be investigated. </p>\n<p>I've tested the cli repl manually and it looks like there is no issue. I haven't figured out how to spool up a wasm repl to test that manually. </p>\n<p>I can repro the test failures locally in nix using <code>bash crates/repl_test/test_wasm.sh</code>.</p>",
        "id": 456434626,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1722831509
    },
    {
        "content": "<p>Lots of progress <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> I'll try to install the CI dependencies today</p>",
        "id": 456478339,
        "sender_full_name": "Anton",
        "timestamp": 1722846681
    },
    {
        "content": "<p>zig 13 and llvm 18 have been installed on all machines</p>",
        "id": 456656570,
        "sender_full_name": "Anton",
        "timestamp": 1722877898
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>Run curl.exe -f -L -O -H &quot;Authorization: token ***&quot; https://github.com/roc-lang/llvm-package-windows/releases/download/v18.1.8/LLVM-18.1.8-win64.7z\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\ncurl: (22) The requested URL returned error: 404\n</code></pre></div>\n<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> -- when you get some time, can you please load LLVM 18 for windows onto <code>roc-lang/llvm-package-windows</code>.</p>",
        "id": 467702525,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1725503686
    },
    {
        "content": "<p>I commented all the jobs out in CI manager (GH workflows) except the nix-linux-x64 and nix-macos-apple-silicon jobs. I just want to see if we can get this PR to pass all the tests on those first and add the others back once we know it's working correctly.</p>",
        "id": 467705877,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1725505264
    },
    {
        "content": "<p>I've spent some time looking at this PR today. I merged main, and ran through the tests and pushed to see how it runs against CI.</p>\n<p>My conclusion is that we should wait until after the build-host PR lands before trying to land this. There are issues that affect both, and fixing them over there first, and then merging will be much simpler.</p>",
        "id": 467706937,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1725505820
    },
    {
        "content": "<blockquote>\n<p>can you please load LLVM 18 for windows onto <code>roc-lang/llvm-package-windows</code></p>\n</blockquote>\n<p><a href=\"https://github.com/roc-lang/llvm-package-windows/releases/tag/v18.1.8\">Done</a></p>",
        "id": 468133351,
        "sender_full_name": "Anton",
        "timestamp": 1725615159
    },
    {
        "content": "<p>Just merged main, and ran a full test using nix on macos and linux with both passing.</p>\n<div class=\"codehilite\"><pre><span></span><code>$ nix develop\n$ cargo test --release\n</code></pre></div>",
        "id": 475504155,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1728374943
    },
    {
        "content": "<p>Ok, merged main in... let's see how CI fairs. It's looking pretty good <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 482048153,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1731449333
    },
    {
        "content": "<p>We talked about making a zig package in <a href=\"#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/481816535\">https://roc.zulipchat.com/#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/481816535</a> <span class=\"user-mention\" data-user-id=\"477725\">@Jasper Woudenberg</span> </p>\n<p>I think this is a great idea, though we can probably live with my workaround for the purpose of landing this change. Essentially, I've made a rust crate that copies the zig glue files into each of the test platforms once per test run. It works, but it would be nice to use the zig ecosystem properly and cleanup these zig test platforms (and also improve the zig platform dev experience).</p>",
        "id": 482048676,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1731449571
    },
    {
        "content": "<p>Everything is <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> for me locally on my mac.</p>\n<p>I think all that's left to land this is some code review, minor cleanup, and fixing the GH actions (making sure the zig 13, llvm deps are correct etc).</p>",
        "id": 482056698,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1731453616
    },
    {
        "content": "<p>I'll check it out :)</p>",
        "id": 482131030,
        "sender_full_name": "Anton",
        "timestamp": 1731491554
    },
    {
        "content": "<p>Ok, I've got this PR <span aria-label=\"check\" class=\"emoji emoji-2705\" role=\"img\" title=\"check\">:check:</span> on both apple silicon macos, and x64 linux running in Nix. I think we are on the home stretch. <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 485177199,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732927159
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> we need to merge the latest changes. </p>\n<p>I haven't got around to investigating why the nix CI's are failing tests now. I thought they were good. </p>\n<p>I'm expecting the only failure that should remain is <code>CI manager / start-ubuntu-x86-64-tests / test zig, rust, wasm...</code> that looks to be failing with this which needs investigation.</p>\n<div class=\"codehilite\"><pre><span></span><code>+ zig test -target wasm32-wasi-musl -O ReleaseFast src/main.zig --test-cmd ../../../../target/release/roc_wasm_interp --test-cmd-bin\nthread &#39;main&#39; panicked at crates/wasm_interp/src/wasi.rs:142:26:\nnot yet implemented: WASI fd_fdstat_get([I32(2), I32(16777168)])\n</code></pre></div>",
        "id": 488528628,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1733963208
    },
    {
        "content": "<p>I'm still messing around with basic-cli and basic-webserver, just wanted to give you an update</p>",
        "id": 488528677,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1733963238
    },
    {
        "content": "<p>Did we leave in some sort of debug printing that might call <code>fd_fdstat_get</code>?</p>",
        "id": 488529026,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733963445
    },
    {
        "content": "<p>Accidentally compiling it into the zig bitcode for wasm?</p>",
        "id": 488529061,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733963464
    },
    {
        "content": "<p>Oh, also looks like we have special cased <code>stdout</code> for <code>fd_fdstat_get</code>, but don't have anything for <code>stderr</code>. So if it isn't an accidental extra debug print, looks easy to add the functionality.</p>",
        "id": 488529247,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733963571
    },
    {
        "content": "<p>don't see any debug prints. Let me try to push a fix</p>",
        "id": 488529794,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733963885
    },
    {
        "content": "<p>Ok. Pushed a handful of changes. I'm hopeful</p>",
        "id": 488535058,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733967550
    },
    {
        "content": "<p>Benchmarks are failing in a way that doesn't make sense to me: <a href=\"https://github.com/roc-lang/roc/actions/runs/12288409183/job/34292167154?pr=6921\">https://github.com/roc-lang/roc/actions/runs/12288409183/job/34292167154?pr=6921</a></p>",
        "id": 488537575,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733969371
    },
    {
        "content": "<p>It is failing in a function that no longer exists on the branch somehow:</p>\n<div class=\"codehilite\"><pre><span></span><code>cannot find `glue.zig`. Check the source code in find_zig_glue_path() to show all the paths I tried.\nLocation: crates/compiler/build/src/link.rs:95:5\n</code></pre></div>",
        "id": 488537592,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733969392
    },
    {
        "content": "<p>oh, it's in <code>bench-folder-main</code>...that makes sense</p>",
        "id": 488537696,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733969466
    },
    {
        "content": "<p>So now <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 488537827,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733969578
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> any idea for <a href=\"https://github.com/roc-lang/roc/actions/runs/12288516921/job/34292459513?pr=6921\">https://github.com/roc-lang/roc/actions/runs/12288516921/job/34292459513?pr=6921</a></p>\n<div class=\"codehilite\"><pre><span></span><code>  zig build ir -Drelease=true failed with:\n\n    ir\n  +- install generated to builtins-host.ll\n     +- zig build-obj builtins-host ReleaseFast native-macos failure\n  error: error: CacheUnavailable\n</code></pre></div>\n<p>looks to only happen for nix macos on CI. Note, zig cache dir is now <code>.zig-cache</code></p>",
        "id": 488543152,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733973395
    },
    {
        "content": "<p>Normally I just restart the runs when this happens and it fixes itself</p>",
        "id": 488545834,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1733975355
    },
    {
        "content": "<p>I've seen it multiple times in a row now, but hopefully goes away</p>",
        "id": 488545873,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733975394
    },
    {
        "content": "<p>Ah that's a pain</p>",
        "id": 488545922,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1733975404
    },
    {
        "content": "<p>Yeah, seems to be hit 100% of the time on the mac builder during <code>nix-build</code></p>",
        "id": 488548360,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733977079
    },
    {
        "content": "<p>Also, I'm hopeful that's soon to be the last error...but hitting relocation issues in wasm and benchmarking issue due to glue.zig being removed. I think I have a fix for both, but hard to say.</p>",
        "id": 488549634,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733977707
    },
    {
        "content": "<p>I have been poking at this for a while and am not having luck.</p>\n<p><code>nix-build</code> on apple silicon is failing with: <a href=\"https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069385?pr=6921\">https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069385?pr=6921</a></p>\n<div class=\"codehilite\"><pre><span></span><code>   zig build ir -Drelease=true failed with:\n\n    ir\n  +- install generated to builtins-host.ll\n     +- zig build-obj builtins-host ReleaseFast native-macos failure\n  error: error: CacheUnavailable\n</code></pre></div>\n<p>I can't repro locallly. Probably related to <a href=\"https://github.com/ziglang/zig/issues/20501\">https://github.com/ziglang/zig/issues/20501</a></p>\n<hr>\n<p>the benchmark job is failing due to main being unable to find <code>glue.zig</code>: <a href=\"https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069754?pr=6921\">https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069754?pr=6921</a></p>\n<p>I get that we removed the file, but there are multiple search paths in find glue and I'm pretty sure it should be finding the file.</p>\n<hr>\n<p>Lastly, <code>wasm_test_platform.wasm</code> is broken with the new version of zig building it. I have no idea why, but it is now emitting new types of relocations we don't support. I tried toggling PIC related flags and thought I had figured it out, but it is still broken. I can repro this one locally, but have not found a fix.</p>\n<p><a href=\"https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298070201?pr=6921\">https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298070201?pr=6921</a></p>\n<hr>\n<p>Overall, feels close, but it is hard to tell if these issues will be minor flag changes or major drags to figure out.</p>",
        "id": 488559489,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733984038
    },
    {
        "content": "<p>I think this will fix the benchmarking issue. It needs to land in main such that the main reference loaded for benchmarking is correct:<br>\n<a href=\"https://github.com/roc-lang/roc/pull/7349\">https://github.com/roc-lang/roc/pull/7349</a></p>",
        "id": 488563777,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1733986568
    },
    {
        "content": "<p>So ended up not fully fixing the benchmarking issue. Realized that the current failure is due to all benchmarks running in the context of the new nix flake. This means that all benchmarks are trying to run with zig 0.13.0. Given main is only at zig 0.11.0 this breaks. I don't think this is worth fixing now though (just think it is too much hassle for something that only matter every zig upgrade). So I think once the other two issues are fixed, we should land this PR with the benchmark failing.</p>",
        "id": 488744798,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734051144
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> when you get the chance can you look at the macos failure with the unavailable cache? I feel like you will be most likely to figure out how to workaround that.</p>",
        "id": 488744971,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734051294
    },
    {
        "content": "<p>I'm digging into gen-wasm issue now. <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span></p>",
        "id": 488746643,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734052287
    },
    {
        "content": "<p>I think gen wasm should be fixed now</p>",
        "id": 488750149,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734054666
    },
    {
        "content": "<p>So if we can fix the mac cache issue, I think we can land</p>",
        "id": 488750156,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734054679
    },
    {
        "content": "<p>Figured out the mac cache issue <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> </p>\n<p>That said, turns out that wasm isn't fully fixed. Still has 1 test failing after the previous fix.</p>",
        "id": 488756545,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734059410
    },
    {
        "content": "<p>Which test?</p>",
        "id": 488757115,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734059876
    },
    {
        "content": "<p>linking_with_dce</p>",
        "id": 488757168,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734059889
    },
    {
        "content": "<p>reverting the platform change fixes it</p>",
        "id": 488757409,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060115
    },
    {
        "content": "<p>So <span aria-label=\"fingers crossed\" class=\"emoji emoji-1f91e\" role=\"img\" title=\"fingers crossed\">:fingers_crossed:</span> that this next ci run passes everything but benchmarking</p>",
        "id": 488757516,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060171
    },
    {
        "content": "<p>I thought I had to change that for zig 13, maybe that was only required in another platform -- or a specific OS/Arch</p>",
        "id": 488757523,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734060181
    },
    {
        "content": "<p>I mean... I think it should be required</p>",
        "id": 488757554,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060215
    },
    {
        "content": "<p>Actually, I guess not. Cause zig is controlling the main. There is no c main needed, right?</p>",
        "id": 488757583,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060241
    },
    {
        "content": "<p>So I think for anything wasi, this should be fine</p>",
        "id": 488757644,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060260
    },
    {
        "content": "<p>I guess for anything called into by js, it is probably required to do things differently</p>",
        "id": 488757654,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060277
    },
    {
        "content": "<p>I suspect it may be something like we build <code>wasm_linking_test_host.zig</code> using zig cli into an object and not a static library.</p>",
        "id": 488757851,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734060438
    },
    {
        "content": "<p>in this case, we build it into an exe</p>",
        "id": 488757975,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060503
    },
    {
        "content": "<p>so that is probably why <code>main() !void</code> is allowed</p>",
        "id": 488757987,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060516
    },
    {
        "content": "<p>Yeah, something like that. It's building into an object file <code>build-obj</code>, and then into an exe using <code>build-exe</code> in two steps. I suspect where we build a static library zig doesn't like the <code>!void</code></p>",
        "id": 488758106,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734060606
    },
    {
        "content": "<p>Digging into that stuff was hella confusing, the combination of different options, exporting vs not exporting, static library vs exectuable, zig 0.11 vs zig .13.</p>",
        "id": 488758190,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734060691
    },
    {
        "content": "<p>makes sense. Expects to follow c-abi cause static lib is not expected to have a main</p>",
        "id": 488758192,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734060693
    },
    {
        "content": "<p>All the wasm tests pass for me locally.</p>",
        "id": 488758365,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734060810
    },
    {
        "content": "<p>I'm going to read through all the changes and see if we've missed anything obvious</p>",
        "id": 488758484,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734060911
    },
    {
        "content": "<p>I haven't found anything blocking... </p>\n<p>there was one TODO left where we verify the LLVM IR, should we measure the impact on performance?  </p>\n<p>we need to verify/test some of the building from source README changes, like is the llvm-18 package available on fedora etc</p>\n<p>The <code>sort</code> -&gt; <code>instertion</code> change in <code>crates/compiler/builtins/benchmark-dec.zig</code> may have broken things, but I guess we can fix this in a follow up and also resolve the issue preventing the benchmark CI runner from completing.</p>",
        "id": 488759830,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734061981
    },
    {
        "content": "<p>Also, just making notes here to summarise as that PR is so massive my browser struggles to find things</p>",
        "id": 488759962,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734062061
    },
    {
        "content": "<p>We did it <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span> </p>\n<p><a href=\"/user_uploads/22008/SkBTLYv50IalttO6aYLqGCk3/Screenshot-2024-12-13-at-15.09.49.png\">Screenshot 2024-12-13 at 15.09.49.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/SkBTLYv50IalttO6aYLqGCk3/Screenshot-2024-12-13-at-15.09.49.png\" title=\"Screenshot 2024-12-13 at 15.09.49.png\"><img data-original-dimensions=\"1936x950\" src=\"/user_uploads/thumbnail/22008/SkBTLYv50IalttO6aYLqGCk3/Screenshot-2024-12-13-at-15.09.49.png/840x560.webp\"></a></div>",
        "id": 488761300,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734063005
    },
    {
        "content": "<blockquote>\n<p>there was one TODO left where we verify the LLVM IR, should we measure the impact on performance?</p>\n</blockquote>\n<p>I think it is fine to leave in the todo for now. I added more color in the PR.</p>",
        "id": 488761321,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734063025
    },
    {
        "content": "<p>let's merge this!</p>",
        "id": 488761347,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734063039
    },
    {
        "content": "<p><a href=\"/user_uploads/22008/bRXsPV8uOQ73f028sAjp8Ve5/Screenshot-2024-12-13-at-15.11.18.png\">Screenshot 2024-12-13 at 15.11.18.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/bRXsPV8uOQ73f028sAjp8Ve5/Screenshot-2024-12-13-at-15.11.18.png\" title=\"Screenshot 2024-12-13 at 15.11.18.png\"><img data-original-dimensions=\"1490x218\" src=\"/user_uploads/thumbnail/22008/bRXsPV8uOQ73f028sAjp8Ve5/Screenshot-2024-12-13-at-15.11.18.png/840x560.webp\"></a></div>",
        "id": 488761393,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734063088
    },
    {
        "content": "<p><span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 488761471,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734063133
    },
    {
        "content": "<p>Looks like it is time to brush off my static Roc branch</p>",
        "id": 488761523,
        "sender_full_name": "Ryan Barth",
        "timestamp": 1734063198
    },
    {
        "content": "<p>Don't need to ask me twice <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span> </p>\n<p>Thank you <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> <span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> <span class=\"user-mention\" data-user-id=\"461444\">@Sam Mohr</span> <span class=\"user-mention\" data-user-id=\"281543\">@Folkert de Vries</span> for all the work to land this. </p>\n<p>For anyone interested, this change ;</p>\n<ul>\n<li>unlocks some performance gains for roc</li>\n<li>enables fully statically linked roc cli binaries </li>\n<li>enables roc to produce statically linked binaries</li>\n<li>enables us to build a roc_std zig package for all the platforms</li>\n</ul>",
        "id": 488761614,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734063258
    },
    {
        "content": "<p>We also may have broken some things or made a typo in the building from source documentation, so if you are able to do that (especially any non-nix users on different os/arch's) and can report any success/failures, that would be really helpful. </p>\n<p>Also apologies in advance <span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> if our scripts for making a release are broken at all, I'm pretty sure they're all good, but I couldn't fully check them. I figure we can give it a test run with the prerelease for the new PI basic-cli</p>",
        "id": 488762673,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734063970
    },
    {
        "content": "<p>That static linking could be really nice for weird deployments!</p>",
        "id": 488765938,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1734066087
    },
    {
        "content": "<p>I'm thankful to the people that did real work on this and made me look like I did something <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 488766363,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1734066274
    },
    {
        "content": "<p>Moral support counts <span aria-label=\"blush\" class=\"emoji emoji-1f60a\" role=\"img\" title=\"blush\">:blush:</span></p>",
        "id": 488766382,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734066301
    },
    {
        "content": "<p>Was the inline expect change part of this PR? Or how is it possible to static link a roc binaries with an inline expect?</p>",
        "id": 488779100,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1734074118
    },
    {
        "content": "<p>inline expects are not emitted in output object files or libaries</p>",
        "id": 488779494,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734074301
    },
    {
        "content": "<p>They are only emitted when running with <code>roc main.roc</code> or <code>roc dev main.roc</code></p>",
        "id": 488779523,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734074320
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/channel/395097-compiler-development/topic/upgrade-llvm-zig/near/488762673\">said</a>:</p>\n<blockquote>\n<p>We also may have broken some things or made a typo in the building from source documentation, so if you are able to do that (especially any non-nix users on different os/arch's) and can report any success/failures, that would be really helpful.</p>\n</blockquote>\n<p>Linux x86_64 checking in (Arch BTW). Successfully compiled roc with llvm 18.1.8 and zig 0.13.0 <span aria-label=\"sign of the horns\" class=\"emoji emoji-1f918\" role=\"img\" title=\"sign of the horns\">:sign_of_the_horns:</span> . Got a mostly passing test suite. It hung with</p>\n<div class=\"codehilite\"><pre><span></span><code>test cli_tests::test_platform_simple_zig::module_params_multiline_pattern has been running for over 60 seconds\n</code></pre></div>\n<p>I also had a few</p>\n<div class=\"codehilite\"><pre><span></span><code>test cli_tests::test_platform_basic_cli::combine_tasks_with_record_builder ... ignored, broken when running in nix CI, TODO replace with a zig test platform\n</code></pre></div>\n<p>despite not using nix.</p>",
        "id": 488783821,
        "sender_full_name": "Ryan Barth",
        "timestamp": 1734076442
    }
]
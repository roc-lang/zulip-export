[
    {
        "content": "<p>I need a hand figuring out this valgrind failure:<br>\n<a href=\"https://github.com/roc-lang/roc/actions/runs/21645888338/job/62398322030?pr=9083\">https://github.com/roc-lang/roc/actions/runs/21645888338/job/62398322030?pr=9083</a></p>\n<p>The claim from claude is that this is related to a DWARF generation bug that loses the function names.<br>\nI thought this was related to or triggered by compiling the new glue platform as part of the build. If I understand right, that should be impossible now on the branch, because now it 'should' be using the committed glue host lib for musl. I may be misunderstanding the Zig build system, and I feel like I definitely don't understand the problem causing the '???' function names in valgrind.</p>",
        "id": 571955548,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1770222189
    },
    {
        "content": "<p>I have also had issues with <code>???</code> in the past but I forgot how I solved that. Are you able to reproduce the valgrind error locally?</p>",
        "id": 571962132,
        "sender_full_name": "Anton",
        "timestamp": 1770223903
    },
    {
        "content": "<p>It looks like it's reproducing locally with: <br>\n<code>zig build -Doptimize=ReleaseFast -Dcpu=x86_64_v3 -Dtarget=x86_64-linux-musl</code><br>\n<code>./ci/custom_valgrind.sh ./zig-out/bin/roc --no-cache test/str/app.roc</code></p>",
        "id": 571968423,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1770225565
    },
    {
        "content": "<p>Great, I recommend starting with giving that to Claude and see if it can fix it.</p>",
        "id": 571971248,
        "sender_full_name": "Anton",
        "timestamp": 1770226360
    },
    {
        "content": "<p>I can continue doing that <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>. It was pointing to a Zig bug and suggesting broader valgrind suppression, so that made me think I should ask here. I don't feel qualified to say whether the stuff it wants to add to the valgrind suppression is reasonable or not.</p>",
        "id": 572014513,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1770240996
    },
    {
        "content": "<p>Can you paste Claude's justification for the suppression here?</p>",
        "id": 572312741,
        "sender_full_name": "Anton",
        "timestamp": 1770364638
    },
    {
        "content": "<p>So, initially it was suggesting object-based suppression since there was no debug info to allow function-based. That seems completely unworkable, as far as actually using valgrind to catch errors goes. It seems like it's just a way to subvert CI.</p>\n<p>It seems like part of the issue may be the specific build config used by the snap version of valgrind. Switching off of the snap build of valgrind to either the older version from apt or a built-from-source version allows using function-based suppression for the original musl alloc thing I was running into, which claude claims (and I believe) is a false positive.</p>\n<p>On a recent, default-configuration build of valgrind, <a href=\"https://github.com/roc-lang/roc/actions/runs/21753513461/job/62757950165?pr=9083\">used in the most recent build</a> on the <code>giesch/roc-glue</code> branch, we're getting a new valgrind failure that seems like an actual error (not related to basic musl behavior).</p>\n<p>The context I'm hoping to gain by asking here is how to dig into valgrind errors in the compiler, or the history of working around this apparent Zig DWARF bug. It would also help to know if ubuntu 22 or the specific version of valgrind is important. I don't get these valgrind errors on my local ubuntu-24-based OS with a recent default valgrind. I'm fuzzy on the details, but it seems possible that there's some kind of mismatch between the recent valgrind and the older kernel version.</p>",
        "id": 572429876,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1770398535
    },
    {
        "content": "<blockquote>\n<p>On a recent, default-configuration build of valgrind</p>\n</blockquote>\n<p>With \"default-configuration\" do you mean the way we currently use it <a href=\"https://github.com/roc-lang/roc/blob/3d0fdde9ae6ffb5ef411f8c8c2fc2cdce22a74fe/.github/workflows/ci_zig.yml#L209\">on CI on the main branch</a>?</p>",
        "id": 572439525,
        "sender_full_name": "Anton",
        "timestamp": 1770401800
    },
    {
        "content": "<blockquote>\n<p>I don't get these valgrind errors on my local ubuntu-24-based OS with a recent default valgrind.</p>\n</blockquote>\n<p>You do need the same flags to build Roc as on CI, just <code>zig build roc</code> can yield different results. And, yes ubuntu and valgrind version matter. Anyway, I will try to reproduce this on my machine, and take a look</p>",
        "id": 572440228,
        "sender_full_name": "Anton",
        "timestamp": 1770402061
    },
    {
        "content": "<p>Hmm <code>./zig-out/bin/snapshot --debug --verbose</code> is not giving me any output...</p>",
        "id": 572444593,
        "sender_full_name": "Anton",
        "timestamp": 1770403761
    },
    {
        "content": "<p>I do get all debug output on macos using your branch, very strange <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 572445370,
        "sender_full_name": "Anton",
        "timestamp": 1770404065
    },
    {
        "content": "<p>I need to go, I can pick up on Monday. Are you getting any output with <code>./zig-out/bin/snapshot --debug --verbose</code>? If not, it makes sense that you are not seeing the valgrind errors.</p>",
        "id": 572445617,
        "sender_full_name": "Anton",
        "timestamp": 1770404154
    },
    {
        "content": "<p>By 'default configuration', I mean passing no arguments to 'configure' when building valgrind from source (which that particular commit did in CI). The build (of valgrind) used by snap has some level of customization. The lack of debug info seems unique to ubuntu 22 as far as I can tell.</p>",
        "id": 572445626,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1770404157
    },
    {
        "content": "<p>It sounds like maybe we need to set <code>omit_frame_pointer = false</code> in the <code>ReleaseFast</code> build used by valgrind in CI? But that would also be kind of cheating CI, maybe.</p>",
        "id": 572448613,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1770405268
    },
    {
        "content": "<p>It looks like this is the configuration used by snap, but I'm not sure what commit would end up being used by ubuntu 22:<br>\n<a href=\"https://github.com/ralight/valgrind-snap/blob/main/snap/snapcraft.yaml\">https://github.com/ralight/valgrind-snap/blob/main/snap/snapcraft.yaml</a></p>",
        "id": 572453093,
        "sender_full_name": "Dan G Knutson",
        "timestamp": 1770407272
    },
    {
        "content": "<p><del>Building with <code>zig build snapshot -Doptimize=ReleaseFast -Dfuzz -Dsystem-afl=false -Dcpu=x86_64_v3 -Dtarget=x86_64-linux-musl</code> results in no output when running <code>./zig-out/bin/snapshot --debug --verbose</code>. But I do see the expected output when building with <code>zig build snapshot</code>. So valgrind is not the issue here, I'm looking into a fix...</del></p>",
        "id": 572737809,
        "sender_full_name": "Anton",
        "timestamp": 1770633755
    },
    {
        "content": "<p><del>This also happens on the main branch.</del></p>",
        "id": 572738886,
        "sender_full_name": "Anton",
        "timestamp": 1770634017
    },
    {
        "content": "<p>Ok that was just: \"Zig's std.log.debug is <strong>compiled out</strong> in ReleaseFast builds.\" <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 572740444,
        "sender_full_name": "Anton",
        "timestamp": 1770634385
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"430894\">Dan G Knutson</span> <a href=\"#narrow/channel/395097-compiler-development/topic/Valgrind.20failure.20on.20musl/near/571968423\">said</a>:</p>\n<blockquote>\n<p>It looks like it's reproducing locally with: <br>\n<code>zig build -Doptimize=ReleaseFast -Dcpu=x86_64_v3 -Dtarget=x86_64-linux-musl</code><br>\n<code>./ci/custom_valgrind.sh ./zig-out/bin/roc --no-cache test/str/app.roc</code></p>\n</blockquote>\n<p>I was able to reproduce this on the main branch as well.</p>",
        "id": 572794333,
        "sender_full_name": "Anton",
        "timestamp": 1770647225
    },
    {
        "content": "<p>Adding <code>-Dstrip=false</code> during the build gives a clean trace.</p>",
        "id": 572798476,
        "sender_full_name": "Anton",
        "timestamp": 1770648063
    },
    {
        "content": "<p>That specific valgrind error was indeed a false positive, pushing a fix soon...</p>",
        "id": 572800670,
        "sender_full_name": "Anton",
        "timestamp": 1770648489
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/pull/9167\">PR#9167</a></p>",
        "id": 572827762,
        "sender_full_name": "Anton",
        "timestamp": 1770654292
    },
    {
        "content": "<p>Fixed in <a href=\"https://github.com/roc-lang/roc/pull/9169\">PR#9169</a> <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 572858399,
        "sender_full_name": "Anton",
        "timestamp": 1770662015
    },
    {
        "content": "<p>I'll merge the fix into your branch tomorrow <span class=\"user-mention\" data-user-id=\"430894\">@Dan G Knutson</span>, I want to get <a href=\"https://github.com/roc-lang/roc/issues/9167\">#9167</a> on main first so I don't make a mess of the branches.</p>",
        "id": 572858766,
        "sender_full_name": "Anton",
        "timestamp": 1770662132
    }
]
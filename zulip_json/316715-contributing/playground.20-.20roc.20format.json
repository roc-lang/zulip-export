[
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/issues/8229\">#8229</a> is a draft implementation of <code>QUERY_FORMATTED</code>. The current playground wasm version on main seems to not be compatible with the current roc-playground, and I have no experience debugging this. So I was not able to test my code in the roc-playground. I could use some hints on what to do.<br>\nShould there be any special data structure? I currently just have the formatted string directly as data in the JSON.</p>",
        "id": 536319149,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756246270
    },
    {
        "content": "<p>The current playground is compatible with the roc-playground...</p>",
        "id": 536319210,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756246309
    },
    {
        "content": "<p>We have an e2e integration test, <code>zig build playground-test -- --verbose</code> is what I usually run</p>",
        "id": 536319243,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756246326
    },
    {
        "content": "<p>That uses a WASM VM in zig to exercise the WASM interface</p>",
        "id": 536319269,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756246351
    },
    {
        "content": "<p>So I would expect to see that integration test updated also with the new API <code>QUERY_FORMATTED</code> etc.</p>\n<p>Then I usually head over to roc-playground and update it over there - to use the new API</p>",
        "id": 536319341,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756246390
    },
    {
        "content": "<p>5 messages were moved here from <a class=\"stream-topic\" data-stream-id=\"316715\" href=\"/#narrow/channel/316715-contributing/topic/Worklog.20.28Draft.20PRs.20and.20coordination.29/with/536254916\">#contributing &gt; Worklog (Draft PRs and coordination)</a> by <span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span>.</p>",
        "id": 536319489,
        "sender_full_name": "Notification Bot",
        "timestamp": 1756246494
    },
    {
        "content": "<p>When I build a release for the roc-playground I also prefer <code>-Doptimize=ReleaseSmall</code> to get a smaller WASM binary, though it's not necessary for testing locally or anything.</p>",
        "id": 536319609,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756246569
    },
    {
        "content": "<p>playground-test works fine, with my small additional test for the formatter. Put plugging it to roc-playground it crashes on the RESET command, which I think should not be affected by my changes.</p>",
        "id": 536323520,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756248980
    },
    {
        "content": "<p>I'll have a look</p>",
        "id": 536324685,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756249803
    },
    {
        "content": "<p>I pushed a commit that fixes the RESET issue</p>",
        "id": 536332182,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756255821
    },
    {
        "content": "<p>Thanks for the help Luke, I think <a href=\"https://github.com/roc-lang/roc/issues/8229\">#8229</a> is ready for review. <a href=\"https://github.com/roc-lang/roc-playground/pull/13\">roc-playground#13</a> adds a formatted tab including an apply button (with a log of help from Claude, my web development is very rusty).</p>",
        "id": 536382729,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756287527
    },
    {
        "content": "<p>I don't love the formatted code being in another tab</p>",
        "id": 536387760,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289481
    },
    {
        "content": "<p>I kind of assumed it would operate on the editor view</p>",
        "id": 536387801,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289499
    },
    {
        "content": "<p>Maybe with a keybinding or possibly (with a delay) after you finished typing.</p>",
        "id": 536387881,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289536
    },
    {
        "content": "<p>I'm not sure though</p>",
        "id": 536387937,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289561
    },
    {
        "content": "<p><a href=\"/user_uploads/22008/uZBk54uOyMH2heX-oTPHsIj1/Screenshot-2025-08-27-at-20.13.03.png\">Screenshot 2025-08-27 at 20.13.03.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/uZBk54uOyMH2heX-oTPHsIj1/Screenshot-2025-08-27-at-20.13.03.png\" title=\"Screenshot 2025-08-27 at 20.13.03.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1966x754\" src=\"/user_uploads/thumbnail/22008/uZBk54uOyMH2heX-oTPHsIj1/Screenshot-2025-08-27-at-20.13.03.png/840x560.webp\"></a></div>",
        "id": 536388022,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289600
    },
    {
        "content": "<p>For debugging formatting, a separate tab could be valuable, but as a regular user, you want it to apply on the main editor. Perhaps it's time to split for these use cases?</p>",
        "id": 536388074,
        "sender_full_name": "Anton",
        "timestamp": 1756289618
    },
    {
        "content": "<p>Maybe we leave it as is for now... its primary usefulness is debugging rn</p>\n<p>I've got plans to add more functionality like writing and running apps in future, but we're not quite there yet with the platforms.</p>",
        "id": 536388440,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289778
    },
    {
        "content": "<p>We can also play around with it easily enough now we have the core functionality wired in and working well.</p>",
        "id": 536388608,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289844
    },
    {
        "content": "<p>Oh, I just saw the apply to button...</p>",
        "id": 536388707,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289883
    },
    {
        "content": "<p>and I've noticed we have a memory leak if we click around a bunch it crashes <span aria-label=\"rip\" class=\"emoji emoji-1faa6\" role=\"img\" title=\"rip\">:rip:</span></p>",
        "id": 536388842,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756289943
    },
    {
        "content": "<p>To repro click the \"Apply to\" button like 20 times<br>\n<a href=\"/user_uploads/22008/C2yF1hJkvf0xi7ZSFl-8XvYh/Screenshot-2025-08-27-at-20.20.20.png\">Screenshot 2025-08-27 at 20.20.20.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/C2yF1hJkvf0xi7ZSFl-8XvYh/Screenshot-2025-08-27-at-20.20.20.png\" title=\"Screenshot 2025-08-27 at 20.20.20.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1310x324\" src=\"/user_uploads/thumbnail/22008/C2yF1hJkvf0xi7ZSFl-8XvYh/Screenshot-2025-08-27-at-20.20.20.png/840x560.webp\"></a></div>",
        "id": 536389136,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756290046
    },
    {
        "content": "<p>If anyone has ideas for how we could detect or prevent this kind of issue in our WASM e2e test I'd love to hear about it. </p>\n<p>I've spent ages trying to setup a realistic integration test, but this kind of thing keeps sneaking through.</p>",
        "id": 536389337,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756290120
    },
    {
        "content": "<p>Where is the current integration test?</p>",
        "id": 536389718,
        "sender_full_name": "Anton",
        "timestamp": 1756290276
    },
    {
        "content": "<p><code>test/playground-integration</code></p>",
        "id": 536389759,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756290295
    },
    {
        "content": "<p>Hmm, I can't find a test folder in the repo</p>",
        "id": 536390240,
        "sender_full_name": "Anton",
        "timestamp": 1756290463
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/blob/main/test/playground-integration/main.zig\">https://github.com/roc-lang/roc/blob/main/test/playground-integration/main.zig</a></p>",
        "id": 536391587,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756291052
    },
    {
        "content": "<p>Oh, it's in the roc repo</p>",
        "id": 536393239,
        "sender_full_name": "Anton",
        "timestamp": 1756291709
    },
    {
        "content": "<p>I also thought about adding just an apply button, but I thought for debugging it's good to see what is happening first.</p>\n<p>The button currently is just available when you are on the formatting tab, but we could make it available all the time, and probably just do something when there are no AST errors. Also what's your favorite format code key binding?</p>",
        "id": 536394626,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756292262
    },
    {
        "content": "<p>I think a button in the editor side could be more visible</p>",
        "id": 536403452,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756295847
    },
    {
        "content": "<p>For keybinding... we probably don't need anything -- I was just thinking out loud earlier</p>",
        "id": 536403589,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1756295899
    },
    {
        "content": "<p>A keybinding actually sounds good to me, we could use that as the sole trigger to avoid accumulating a bunch of buttons over time</p>",
        "id": 536403847,
        "sender_full_name": "Anton",
        "timestamp": 1756295995
    },
    {
        "content": "<p>I pushed some changes that make the format code button always work when there is no parse error (otherwise it would remove code). It's not next to the share link button. The formatted tab is still visible for debugging.</p>",
        "id": 536404559,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756296239
    },
    {
        "content": "<p>With only keybinding the problem is always discoverability, but I think I could add one.</p>",
        "id": 536404818,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756296343
    },
    {
        "content": "<p>We could add \"format with Ctrl+Something\" below the editor or a button or hover effect to show all shortcuts.</p>",
        "id": 536405354,
        "sender_full_name": "Anton",
        "timestamp": 1756296570
    },
    {
        "content": "<p>I chose Ctrl+Shift+F for now, it's hard to find something that is not used by the browser or codemirror. Feel free to change it or add some mac specific one. For now I think it's good to have the button and the binding.</p>",
        "id": 536415694,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756299815
    },
    {
        "content": "<p>I finally had time to look at the memory leak. I think it's the FixedBufferAllocator, that only actually frees part of the buffer, if the most recent allocation is freed. I could not find out so far which allocation is not freed in order, but I don't think we can guarantee the free order if the js-host is in control of part of it? I tried to use the <code>wasm_allocator</code> instead but this also didn't work.</p>\n<p>I would like to clean up some code there anyway, so maybe I figure something out, but it would be nice if anyone with more knowledge about wasm and allocators could have a look.</p>",
        "id": 537539486,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1756926945
    }
]
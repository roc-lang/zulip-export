[
    {
        "content": "<p>so I have a bunch of work on auto-derived Inspect, but I think I should really focus on documentation and FAQs and such this final week before advent of code - is anyone else able to pick that up?</p>",
        "id": 404272951,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701016804
    },
    {
        "content": "<p>I really think it'd help people out a lot to have a reliable <code>dbg</code> for Advent of Code, and this is the only nontrivial blocker to that!</p>",
        "id": 404272994,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701016857
    },
    {
        "content": "<p>What's the current state?</p>",
        "id": 404273573,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701017477
    },
    {
        "content": "<p>it's partially implemented on a branch, but getting an error in tests</p>",
        "id": 404274671,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701018424
    },
    {
        "content": "<p>if you're interested in it, I'd be happy to chat about it and get you up to speed! <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 404276535,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701020206
    },
    {
        "content": "<p>I have a lot of random stuff I want to get to, but this seems more important</p>",
        "id": 404279517,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701022587
    },
    {
        "content": "<p>What is the best way to start understanding a bug with an error like:</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;gen_abilities::inspect_bool&#39; panicked at &#39;assertion failed: `(left == right)`\n  left: `0`,\n right: `1`: (LambdaSet([], ^&lt;2128&gt;), Func([&lt;260&gt;EmptyRecord,], &lt;2130=263&gt;LambdaSet([], ^&lt;2128&gt;), &lt;264&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;3300&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;3301&gt;)))&#39;, crates/compiler/mono/src/ir.rs:6129:9\n</code></pre></div>\n<p>or</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;gen_abilities::inspect_num&#39; panicked at &#39;No lambda set at region 2 found&#39;, crates/compiler/types/src/subs.rs:6087:5\n</code></pre></div>",
        "id": 404522850,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701136171
    },
    {
        "content": "<p>Usually this means the specialization of an ability member for a specific type is missing or under defined. Do you what a lambda region is?</p>",
        "id": 404526064,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701137759
    },
    {
        "content": "<p>I do not know what a lambda region is. Have not interacted with them before.</p>",
        "id": 404526269,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701137866
    },
    {
        "content": "<p>Also, at least for a type like <code>Bool.Bool</code> where the inspector just generates a direct call to the immediate <code>Inspect.bool</code>, I don't see a location where were are doing anything complex within the derive code for inspect itself. Totally see how dict, list, record, etc are complex and could hit bigger issues, but unsure why something like just <code>Bool.Bool</code> would hit some sort of issue.</p>",
        "id": 404527118,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701138319
    },
    {
        "content": "<p>what‚Äôs the definition of inspect for Bool?</p>",
        "id": 404528694,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139111
    },
    {
        "content": "<p>On mobile so I‚Äôll take a deeper look later and explain lambda regions but I can explain broad details</p>",
        "id": 404528799,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139181
    },
    {
        "content": "<p>in ability type definition: <code>bool : Bool -&gt; Inspector f where f implements InspectFormatter</code></p>\n<p>With <code>Inspector</code> as <code>Inspector f := f -&gt; f where f implements InspectFormatter</code></p>\n<p>Specific <code>bool</code> impl it should be using:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">dbgBool</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">Bool</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Inspector</span><span class=\"w\"> </span><span class=\"nx\">DbgFormatter</span>\n<span class=\"nv\">dbgBool</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"nx\">b</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nx\">b</span><span class=\"w\"> </span><span class=\"k\">then</span>\n<span class=\"w\">        </span><span class=\"nx\">f0</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nx\">custom</span>\n<span class=\"w\">        </span><span class=\"nx\">dbgWrite</span><span class=\"w\"> </span><span class=\"nx\">f0</span><span class=\"w\"> </span><span class=\"s\">\"true\"</span>\n<span class=\"w\">    </span><span class=\"k\">else</span>\n<span class=\"w\">        </span><span class=\"nx\">f0</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nx\">custom</span>\n<span class=\"w\">        </span><span class=\"nx\">dbgWrite</span><span class=\"w\"> </span><span class=\"nx\">f0</span><span class=\"w\"> </span><span class=\"s\">\"false\"</span>\n</code></pre></div>",
        "id": 404529045,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701139311
    },
    {
        "content": "<p>Oh, and I guess <code>custom</code> just expose the opaque wrapper:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">custom</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nf\">(f -&gt; f) -&gt;</span><span class=\"w\"> </span><span class=\"nx\">Inspector</span><span class=\"w\"> </span><span class=\"nx\">f</span><span class=\"w\"> </span><span class=\"nx\">where</span><span class=\"w\"> </span><span class=\"nx\">f</span><span class=\"w\"> </span><span class=\"nx\">implements</span><span class=\"w\"> </span><span class=\"nx\">InspectFormatter</span>\n<span class=\"nv\">custom</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">@Inspector</span>\n</code></pre></div>",
        "id": 404529227,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701139363
    },
    {
        "content": "<p>what‚Äôs the definition of dbgWrite?</p>",
        "id": 404529537,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139451
    },
    {
        "content": "<p>Just string concat:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">dbgWrite</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">DbgFormatter</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">Str</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">DbgFormatter</span>\n<span class=\"nv\">dbgWrite</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"nx\">@DbgFormatter</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nx\">data</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"nx\">added</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"nx\">@DbgFormatter</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nv\">data</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">Str</span><span class=\"p\">.</span><span class=\"nx\">concat</span><span class=\"w\"> </span><span class=\"nx\">data</span><span class=\"w\"> </span><span class=\"nx\">added</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 404529609,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701139474
    },
    {
        "content": "<p>Hm that‚Äôs weird</p>",
        "id": 404529705,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139504
    },
    {
        "content": "<p>Okay i‚Äôll take a deeper look when off mobile. do you have a branch?</p>",
        "id": 404529743,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139516
    },
    {
        "content": "<p>in the meantime, here is the description of a lambda set region: <a href=\"https://github.com/roc-lang/roc/blob/main/crates/compiler/solve/docs/ambient_lambda_set_specialization.md#some-definitions\">https://github.com/roc-lang/roc/blob/main/crates/compiler/solve/docs/ambient_lambda_set_specialization.md#some-definitions</a></p>",
        "id": 404529954,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139570
    },
    {
        "content": "<p>It‚Äôs usually missing when a specialization function corresponding to the same arrow as defined in an ability member is missing. But the specialization here seems to have three arrows, like the ability member</p>",
        "id": 404530056,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139607
    },
    {
        "content": "<p>Been adding to <code>inspect-derive</code>.</p>\n<p>The test is run with <code>cargo test -p test_gen -- inspect_bool</code></p>",
        "id": 404530145,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701139638
    },
    {
        "content": "<p>Was trying to fix bool or num tests before turning to the derive implementations that actually generate code rather than just call an existing function.</p>",
        "id": 404530271,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701139682
    },
    {
        "content": "<p>you might also want to run with ROC_TRACE_COMPACTION=1. It will show some useful specialization traces</p>",
        "id": 404530418,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701139712
    },
    {
        "content": "<p>Looking at the compaction, the main thing I derive is that the failing match looks to be for <code>Inspect.init</code>. That is the function that generates the initial formatter.</p>",
        "id": 404538202,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701142611
    },
    {
        "content": "<p>Given the uitest</p>\n<div class=\"codehilite\"><pre><span></span><code>app &quot;test&quot; provides [main] to &quot;./platform&quot;\n\nmain =\n    Inspect.toInspector Bool.true |&gt; Inspect.apply (Inspect.init {}) |&gt; Inspect.toDbgStr\n#   ^^^^^^^^^^^^^^^^^^^ Inspect#Inspect.toInspector(32): Bool -[[]]-&gt; Inspector DbgFormatter\n</code></pre></div>\n<p>we have the trace</p>\n<div class=\"codehilite\"><pre><span></span><code>===lambda set compaction===\n  concrete type: Opaque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;)\n  step 1:\n    uls_a = { LambdaSet([] + (&lt;2710&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;):`Inspect.init`:1), ^&lt;2709&gt;),LambdaSet([] + (&lt;2699&gt;Op\naque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;):`Inspect.bool`:2), ^&lt;2694&gt;),LambdaSet([] + (&lt;2706&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;2679\n&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;):`Inspect.bool`:1), ^&lt;2688&gt;) }\n  step 2:\n    uls_a&#39; = { LambdaSet([] + (&lt;2710&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;):`Inspect.init`:1), ^&lt;2709&gt;),LambdaSet([] + (&lt;2699&gt;O\npaque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;):`Inspect.bool`:2), ^&lt;2694&gt;),LambdaSet([] + (&lt;2706&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;267\n9&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;):`Inspect.bool`:1), ^&lt;2688&gt;) }\n  step 3:\n      SKIP\n      =  Func([&lt;74&gt;EmptyRecord,], &lt;2711=77&gt;LambdaSet([], ^&lt;2709&gt;), &lt;78&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;))\n\n      SKIP\n      =  Func([&lt;2682&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;),], &lt;2693=2685&gt;LambdaSet([], ^&lt;2694&gt;), &lt;2682&gt;Opaque(`Inspect.DbgForm\natter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;))\n\n      SKIP\n      =  Func([&lt;2704&gt;Opaque(`Bool.Bool`, [], &lt;2697&gt;[&#39;False&#39; , &#39;True&#39; , ]&lt;Any(92)&gt;),], &lt;2690=2703&gt;LambdaSet([], ^&lt;2688&gt;), &lt;2702&gt;Opaque(`Inspect.Inspector`, [2692, 2693], &lt;\n2694&gt;Func([&lt;2682&gt;Opaque(`Inspect.DbgFormatter`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;),], &lt;2693=2685&gt;LambdaSet([], ^&lt;2694&gt;), &lt;2682&gt;Opaque(`Inspect.DbgFormatte\nr`, [], &lt;2679&gt;{ &#39;data&#39; : Apply(`Str.Str`, []), }&lt;115&gt;))))\n</code></pre></div>",
        "id": 404551612,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701150750
    },
    {
        "content": "<p>The skips are suspicious</p>",
        "id": 404551618,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701150756
    },
    {
        "content": "<p>The specialization is getting marked as \"Drop\" because it hits this branch: <a href=\"https://github.com/roc-lang/roc/blob/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/solve/src/specialize.rs#L669\">https://github.com/roc-lang/roc/blob/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/solve/src/specialize.rs#L669</a></p>",
        "id": 404552149,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151121
    },
    {
        "content": "<p>But why? We are specializing DbgFormatter, which is an opaque type.</p>",
        "id": 404552161,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151134
    },
    {
        "content": "<p>It's because this condition isn't met: <a href=\"https://github.com/roc-lang/roc/blob/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/solve/src/specialize.rs#L669\">https://github.com/roc-lang/roc/blob/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/solve/src/specialize.rs#L669</a></p>",
        "id": 404552178,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151150
    },
    {
        "content": "<p>I'm not sure why <a href=\"https://github.com/roc-lang/roc/blob/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/solve/src/ability.rs#L1509\">https://github.com/roc-lang/roc/blob/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/solve/src/ability.rs#L1509</a><br>\nlists Inspect in there. I don't think Inspect declares any opaque types that must be derived but cannot list the abilities they need derived.</p>",
        "id": 404552391,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151251
    },
    {
        "content": "<p>If we remove that, we get a uitest that looks good</p>\n<div class=\"codehilite\"><pre><span></span><code>app &quot;test&quot; provides [main] to &quot;./platform&quot;\n\nmain =\n    Inspect.toInspector Bool.true |&gt; Inspect.apply (Inspect.init {}) |&gt; Inspect.toDbgStr\n#   ^^^^^^^^^^^^^^^^^^^ Inspect#Inspect.toInspector(32): Bool -[[Inspect.dbgBool(43)]]-&gt; Inspector DbgFormatter\n</code></pre></div>",
        "id": 404552527,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151290
    },
    {
        "content": "<p>And the gen test fails, but it runs correctly and shows the expected output.</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;gen_abilities::inspect_bool&#39; panicked at &#39;assertion failed: `(left == right)`\n  left: `&quot;true, false&quot;`,\n right: `&quot;Bool.true, Bool.false&quot;`: LLVM test failed&#39;, crates/compiler/test_gen/src/helpers/llvm.rs:631:13\n</code></pre></div>",
        "id": 404552729,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151342
    },
    {
        "content": "<p>As a side note, I would put all of the inspect gen tests into a <code>mod inspect</code> like is done for hash, encode, decode, etc. It helps a lot with navigating the file.</p>",
        "id": 404552879,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151396
    },
    {
        "content": "<p>Or split them out into separate module files.</p>",
        "id": 404552905,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151404
    },
    {
        "content": "<p>thanks!</p>",
        "id": 404553103,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701151486
    },
    {
        "content": "<p>Also, I highly recommend adding uitests of the form I described under <a href=\"https://github.com/roc-lang/roc/tree/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/uitest/tests/ability/specialize\">https://github.com/roc-lang/roc/tree/d478ec56da88268dd39752c73d42c2f60a20ef38/crates/compiler/uitest/tests/ability/specialize</a>. It helps a lot in catching the specialization issues at the source.</p>",
        "id": 404553198,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151549
    },
    {
        "content": "<p>And, adding mono tests as well as gen tests. The mono tests will also catch things early on. If mono succeeds, codegen very likely will</p>",
        "id": 404553294,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701151577
    },
    {
        "content": "<p>Gotta love when this fails:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">custom</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">@Inspector</span>\n</code></pre></div>\n<p>but this works:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">custom</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"nx\">fn</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">@Inspector</span><span class=\"w\"> </span><span class=\"nx\">fn</span>\n</code></pre></div>",
        "id": 404710294,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701202412
    },
    {
        "content": "<p>what's the error</p>",
        "id": 404710500,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701202487
    },
    {
        "content": "<p>that's a known problem, right?</p>",
        "id": 404710762,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701202598
    },
    {
        "content": "<p>like how you can't do <code>mainForHost = main</code> if <code>main</code> is a function, you have to do <code>mainForHost = \\arg -&gt; main arg</code></p>",
        "id": 404710794,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701202620
    },
    {
        "content": "<p><code>custom = @Inspector</code> is sugar though</p>",
        "id": 404710821,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701202637
    },
    {
        "content": "<p>For the latter</p>",
        "id": 404711848,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701202983
    },
    {
        "content": "<p>It won't generate specializations correct as only <code>custom = @Inspector</code></p>",
        "id": 404715627,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701204605
    },
    {
        "content": "<p>Anyway, I think I have autoderived inspect working now. Not wired to <code>dbg</code>, but otherwise working.</p>",
        "id": 404716284,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701204905
    },
    {
        "content": "<p>Just for context, for specialization, errors look like:</p>\n<div class=\"codehilite\"><pre><span></span><code>‚îÄ‚îÄ PROC SPECIALIZATION NOT DEFINED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n\nin toInspector_[A 2] : ({Str, Str}) -&gt; {Str, Str} ((niche {}))\n\n0‚îÇ  procedure `#Derived.toInspector_[A 2]` (`#Derived.tag`):\n1‚îÇ&gt;     let `#Derived_gen.0` : {Str, Str} = CallByName `Inspect.custom` `#Derived.tag`;\n2‚îÇ      ret `#Derived_gen.0`;\n\nNo specialization\n\ncustom : ({Str, Str}) -&gt; {Str, Str} ((niche {}))\n\nwas found\n\nThe following specializations of Inspect.custom were built:custom : () -&gt;\n{} ((niche {}))\n\ncustom : () -&gt; {} ((niche {}))\n\ncustom : () -&gt; {} ((niche {}))&#39;, crates/compiler/test_mono/src/tests.rs:177:5\n</code></pre></div>",
        "id": 404717887,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701205458
    },
    {
        "content": "<p>yooooooo, amazing <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span>!!! <span aria-label=\"heart eyes\" class=\"emoji emoji-1f60d\" role=\"img\" title=\"heart eyes\">:heart_eyes:</span> <span aria-label=\"heart eyes\" class=\"emoji emoji-1f60d\" role=\"img\" title=\"heart eyes\">:heart_eyes:</span> <span aria-label=\"heart eyes\" class=\"emoji emoji-1f60d\" role=\"img\" title=\"heart eyes\">:heart_eyes:</span></p>",
        "id": 404717970,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701205501
    },
    {
        "content": "<p>thank you so much!</p>",
        "id": 404717977,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701205504
    },
    {
        "content": "<p>NGL that <code>PROC SPECIALIZATION NOT DEFINED</code> error looks like magic to me.</p>",
        "id": 404718458,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701205744
    },
    {
        "content": "<p>Also, I think the plan is to submit <a href=\"https://github.com/roc-lang/roc/issues/5775\">#5775</a>, make another PR for dbg changes, and then add some post fixes as needed.</p>",
        "id": 404719409,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701206264
    },
    {
        "content": "<p>I'll review this tonight. Do you guys mind holding off merging until I have a chance to look at this?</p>",
        "id": 404725245,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701208221
    },
    {
        "content": "<p>totally fine. Thanks</p>",
        "id": 404726080,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701208572
    },
    {
        "content": "<p>Also, looks like I still have a few minor issues to figure out.</p>",
        "id": 404726273,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701208663
    },
    {
        "content": "<p>Wouldn't mind some help with them if you have any ideas. Just updated tests to show the errors:</p>\n<p>The two issues seem to be:</p>\n<ol>\n<li><code>Frac a</code> is not turning into a concrete type. Instead, inspect is finding <code>a</code> as the inner type and failing. So something is missing here that should end up selecting <code>Dec</code>. Can repro by running <code>cargo test -p test_gen -- gen_abilities::inspect::num</code>.</li>\n<li><code>List *</code> doesn't work, but we would want it to still be able to output <code>[]</code>.  Currently we get <code>unspecialized lambda sets left over during resolution</code> probably from the elem to inspector function iiuc. Can repro by running <code>cargo test -p test_gen -- gen_abilities::inspect::list</code>.</li>\n</ol>",
        "id": 404727339,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701209022
    },
    {
        "content": "<p>(1) Is probably because Frac is missing in the switch here <a href=\"https://github.com/roc-lang/roc/blob/3eb6f9179752a12622813d985f90b297d7baec81/crates/compiler/derive_key/src/inspect.rs#L186-L208\">https://github.com/roc-lang/roc/blob/3eb6f9179752a12622813d985f90b297d7baec81/crates/compiler/derive_key/src/inspect.rs#L186-L208</a></p>",
        "id": 404729727,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701210125
    },
    {
        "content": "<p>Regarding (2), this is a bit of a problem. In the future I'd like to get rid of that panic and instead have the \"unspecialized...\" thing return an error function, because if the type variable is unbound, we know that the specialization function will never be called. But as you've noticed, in the meantime it finds actual errors. So I am inclined to say that debugging a list with non concrete type should not be supported for now, or we should generate the synthetic error function only in non-debug builds.</p>",
        "id": 404730101,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701210346
    },
    {
        "content": "<p>(1) I don't think it is Frac missing in the switch. Num and Integer are also not in the switch, but they work just fine. Frac is a wrapping type, so we want to unwrap it and get to the underlying Dec/F32/F64. Unspecified number types work because when we unwrap, it results in an I64. For Frac, it should unwrap to Dec by default if the type is unspecfied. So I think this is an issue with default number handling logic elsewhere.</p>",
        "id": 404734606,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701212526
    },
    {
        "content": "<p>For (2), sounds reasonable to ignore for now. Long term can either pipeline through a nicer error or a special exception.</p>",
        "id": 404734835,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701212603
    },
    {
        "content": "<p>Regarding 1, Num and Integer work fine because if has a type variable, then either (1) the type variable is bound to a type variable that implements the ability, (2) the type variable is concrete, or (3) the number is a ranged number, the logic for which is implemented <a href=\"https://github.com/roc-lang/roc/blob/6c72bf9bf77c016428aaaad187e817dfb99d9eda/crates/compiler/derive_key/src/inspect.rs#L171-L173\">https://github.com/roc-lang/roc/blob/6c72bf9bf77c016428aaaad187e817dfb99d9eda/crates/compiler/derive_key/src/inspect.rs#L171-L173</a>.</p>",
        "id": 404736055,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701213281
    },
    {
        "content": "<p>So what you want is to check if it's a Frac with an unbound type variable (FlexVar - Rigid means it's a bug, because it's trying to specialize a generalized type, which is nonsense). In that case, you know it will compile to the default Dec, so you can use the Dec specialization.</p>",
        "id": 404736155,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701213349
    },
    {
        "content": "<p>That makes sense. will test</p>",
        "id": 404736246,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701213392
    },
    {
        "content": "<p>Ok. Fixed.</p>",
        "id": 404736904,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701213772
    },
    {
        "content": "<p>all tests passed locally for me. So hopefully ci will be all good too.</p>",
        "id": 404737783,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701214219
    },
    {
        "content": "<p>Interesting wasm failure. Is this a case where we are passing a wrapping type to NumToStr, but it has the same underlying layout as a Numeric Type. As such, it theoretically can just be treated as the underlying numeric type? Not exactly sure the correct fix on the wasm side, but I assume it is something like instead of checking if the type is valid, check if the underlying layout is valid.</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;gen_abilities::inspect::list&#39; panicked at &#39;NumToStr is not defined for LambdaSet(LambdaSet { set: [( 15.295, [InLayout(DEC)])], args: [InLayout(25)], ret: InLayout(25), representation: InLayout(DEC), full_layout: InLayout(81) })&#39;, crates/compiler/gen_wasm/src/low_level.rs:2272:18\n</code></pre></div>",
        "id": 404742800,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701216902
    },
    {
        "content": "<p>So yeah, using the runtime representation is a fix in the wasm backend. That said, I wonder if that means tons of low levels for wasm should be using the runtime representation to extract the inner layout from lambdasets. For now, just changing the single location to fix a test, but feels like probably a symptom of a bigger issue.</p>",
        "id": 404745801,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701218383
    },
    {
        "content": "<p>For using <code>Inspect</code> with <code>dbg</code>. That will need to be handled at the mono or higher level, correct? Cause <code>dbg</code> no longer has enough information to just be dealt with by the backends. Instead, <code>dbg val</code> essentially has to desugar into <code>Inspect.inspect val |&gt; Inspect.toDbgStr |&gt; roc_dbg</code>, right? Then that new set of commands will get lowered by the backends.</p>",
        "id": 404747024,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701218880
    },
    {
        "content": "<p>yeah exactly <span aria-label=\"100\" class=\"emoji emoji-1f4af\" role=\"img\" title=\"100\">:100:</span></p>",
        "id": 404747200,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701218944
    },
    {
        "content": "<p>At what level do we normally desugar these things? Any specific code location? I assume either can or mono somewhere.</p>",
        "id": 404747779,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701219152
    },
    {
        "content": "<p>Maybe even when converting between the two</p>",
        "id": 404747797,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701219161
    },
    {
        "content": "<p>I'd do it in <code>can</code> and then add a <code>LowLevel</code> op for <code>RocDbg</code></p>",
        "id": 404747862,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701219194
    },
    {
        "content": "<p>as for where to do it, we already desugar <code>dbg</code> <a href=\"https://github.com/roc-lang/roc/blob/eeab701df36975c30abf80145a8705e6bc7cfa8e/crates/compiler/can/src/operator.rs#L92\">here</a> - so I'd modify that!</p>",
        "id": 404748042,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701219256
    },
    {
        "content": "<p>Oh, should debug still automatically add on <code>[examples/helloWorld.roc 7:9]</code>, I guess that is not covered by inspect. Though in a number of platforms, I assume it is not wanted. Maybe dbg should pass two strings, location and message?</p>",
        "id": 404748510,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701219443
    },
    {
        "content": "<p>I like that idea! <span aria-label=\"100\" class=\"emoji emoji-1f4af\" role=\"img\" title=\"100\">:100:</span></p>",
        "id": 404748613,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701219482
    },
    {
        "content": "<p>What is the difference between the <code>Expr</code> and <code>ValueDef</code> forms of <code>Dbg</code>?</p>",
        "id": 404750896,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701220258
    },
    {
        "content": "<p>hm, that I'm not sure</p>",
        "id": 404751202,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701220404
    },
    {
        "content": "<p>The <code>Expr</code> version sounds like elm‚Äôs <code>Debug.log</code> which returns the value it logs. I thought <code>dbg</code> couldn‚Äôt do that but I‚Äôd love it if it did <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>",
        "id": 404753243,
        "sender_full_name": "Agus Zubiaga",
        "timestamp": 1701221128
    },
    {
        "content": "<p>It‚Äôs very nice when you have some code already written and want to ‚Äúsprinkle‚Äù some logging for debug purposes</p>",
        "id": 404753444,
        "sender_full_name": "Agus Zubiaga",
        "timestamp": 1701221203
    },
    {
        "content": "<p>So it looks like the expression version is actually our:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nx\">dbg</span><span class=\"w\"> </span><span class=\"s\">\"some value\"</span>\n</code></pre></div>\n<p>It just also includes a continuation that is really what is returned:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nx\">dbg</span><span class=\"w\"> </span><span class=\"s\">\"some value\"</span>\n\n<span class=\"nx\">continuation</span>\n</code></pre></div>\n<p>I don't think the valuedef is ever actually used.</p>",
        "id": 404753760,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701221328
    },
    {
        "content": "<p>Aside, I guess since desugaring still generates an <code>Expr</code>, I have to actually make an expr that is <code>Expr::LowLevelDbg</code>.</p>",
        "id": 404753991,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701221415
    },
    {
        "content": "<p>That version would just be used for actually calling <code>roc_dbg</code> in the host.</p>",
        "id": 404754022,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701221433
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"489294\">Agus Zubiaga</span> <a href=\"#narrow/stream/316715-contributing/topic/auto-derived.20Inspect/near/404753243\">said</a>:</p>\n<blockquote>\n<p>The <code>Expr</code> version sounds like elm‚Äôs <code>Debug.log</code> which returns the value it logs. I thought <code>dbg</code> couldn‚Äôt do that but I‚Äôd love it if it did <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span></p>\n</blockquote>\n<p>yeah the idea is to add support for that!</p>\n<p>I just wanted to start with the \"statement\" version because I know from Elm that if that doesn't exist, people will do <code>_ = dbg ...</code> and I wanted to see if there was still demand for the other style if we had the statement version</p>",
        "id": 404760322,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701224055
    },
    {
        "content": "<p>turns out yes <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 404760341,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701224065
    },
    {
        "content": "<p>Yeah, I also like the statement version. Both are nice in different situations.</p>",
        "id": 404762064,
        "sender_full_name": "Agus Zubiaga",
        "timestamp": 1701224826
    },
    {
        "content": "<p>For dbg, do we want to attempt to wire through a file name or should we just give a module name (or other I guess)?</p>",
        "id": 404763277,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701225345
    },
    {
        "content": "<p>I think filename is nicest if possible</p>",
        "id": 404769765,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701228232
    },
    {
        "content": "<p>I mean we currently use filename, just need to figure out wiring it through differently. Cause now we need it at compile time instead of runtime.</p>",
        "id": 404775960,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701230543
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> <a href=\"#narrow/stream/316715-contributing/topic/auto-derived.20Inspect/near/404745801\">said</a>:</p>\n<blockquote>\n<p>I wonder if that means tons of low levels for wasm should be using the runtime representation to extract the inner layout from lambdasets.</p>\n</blockquote>\n<p>No, there are only 5 existing low-level ops that can actually take lambdasets as operands in the first place! It's just <code>List.map</code> and the other \"higher order low levels\". In the wasm backend, those lambda sets are converted to their runtime representations <a href=\"https://github.com/roc-lang/roc/blob/main/crates/compiler/gen_wasm/src/low_level.rs#L2426\">here</a>.</p>",
        "id": 404802569,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1701242929
    },
    {
        "content": "<p>Apart from low-levels, there are about 4 or 5 other places where it's needed. Converting IR symbol layout to WasmLayout, inserting data into structs, etc.</p>",
        "id": 404805516,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1701244181
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281383\">Richard Feldman</span> <a href=\"#narrow/stream/316715-contributing/topic/auto-derived.20Inspect/near/404760341\">said</a>:</p>\n<blockquote>\n<p>turns out yes <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>\n</blockquote>\n<p>If I understand correctly that means behaving like dbg! In rust where I get the value back out so I can just add the debug macro into a bigger expression. Yeah I'm a big fan of that. I'd extra love it if I didn't need to add parentheses cause that is cumbersome in rust because I'm potentially wrapping a huge chunk of code</p>",
        "id": 404878612,
        "sender_full_name": "Pearce Keesling",
        "timestamp": 1701268258
    },
    {
        "content": "<p>yeah I think <code>|&gt; dbg</code> should let you avoid parens!</p>",
        "id": 404887673,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701270335
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"431893\">Brian Carroll</span> <a href=\"#narrow/stream/316715-contributing/topic/auto-derived.20Inspect/near/404802569\">said</a>:</p>\n<blockquote>\n<p>No, there are only 5 existing low-level ops that can actually take lambdasets as operands in the first place! It's just <code>List.map</code> and the other \"higher order low levels\". In the wasm backend, those lambda sets are converted to their runtime representations <a href=\"https://github.com/roc-lang/roc/blob/main/crates/compiler/gen_wasm/src/low_level.rs#L2426\">here</a>.</p>\n</blockquote>\n<p>I wonder if that means requiring this change was caused by a bug elsewhere.<br>\n<a href=\"https://github.com/roc-lang/roc/pull/5775/commits/248976d632b0827032171ba00b8372dbd59a39c0\">https://github.com/roc-lang/roc/pull/5775/commits/248976d632b0827032171ba00b8372dbd59a39c0</a></p>\n<p>Somehow the inspect ability lead to a lambdaset getting past to Num.toStr in the wasm backend. The Lambdaset was just a Dec under the hood.</p>",
        "id": 404904053,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701275081
    },
    {
        "content": "<p>I would assume it happened during the codegen of this ability impl function:<br>\n<a href=\"https://github.com/roc-lang/roc/blob/ead90313d89e8939549732136d536f301e522a16/crates/compiler/builtins/roc/Inspect.roc#L339-L342\">https://github.com/roc-lang/roc/blob/ead90313d89e8939549732136d536f301e522a16/crates/compiler/builtins/roc/Inspect.roc#L339-L342</a></p>",
        "id": 404904635,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701275257
    },
    {
        "content": "<p>That seems like a bug. A lambda set should never compile to a Dec</p>",
        "id": 404909329,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701276690
    },
    {
        "content": "<p>And a lambda set should never be an argument to Num.toStr</p>",
        "id": 404909391,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701276705
    },
    {
        "content": "<p>Lambda sets should compile to an int, struct, or union. And they should only appear where function types are expected</p>",
        "id": 404909568,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701276738
    },
    {
        "content": "<p>if you revert that change what tests fail?</p>",
        "id": 404909678,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701276777
    },
    {
        "content": "<p><code>gen_abilities::inspect::list</code> and <code>gen_abilities::inspect::num</code>, but only for <code>test-gen-wasm</code></p>",
        "id": 404910086,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701276911
    },
    {
        "content": "<p>Not sure why, but the incorrect parameters only happen with the dev wasm backend.</p>",
        "id": 404910204,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701276957
    },
    {
        "content": "<p>The llvm backend uses <code>match layout_interner.get_repr(num_layout)</code> without handling lambasets and just works. So maybe the wasm backend has a bug with mapping layouts to args?</p>",
        "id": 404910474,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701277025
    },
    {
        "content": "<p>Do you know what particular case in <code>inspect::num</code>?</p>",
        "id": 404912605,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701277589
    },
    {
        "content": "<p>I'll try this actually</p>",
        "id": 404912650,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701277605
    },
    {
        "content": "<p>I am not sure, but I recall it resolving to a Dec. So probably Dec or Frac case of some sort.</p>",
        "id": 404914933,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701278332
    },
    {
        "content": "<p>For symbols like <code>roc_alloc</code> in the llvm backend, where do the external function headers for them get defined. Searched around a bit, but not finding it except for testing.</p>\n<p>Trying to do <code>let function = self.module.get_function(\"roc_dbg\").unwrap();</code>, but unwrapping will result in a None.</p>",
        "id": 404916697,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701278881
    },
    {
        "content": "<p>I don't this is a backend bug. This is a bug in the code generation</p>",
        "id": 404917012,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701278952
    },
    {
        "content": "<p>With this diff</p>\n<div class=\"codehilite\"><pre><span></span><code>diff --git a/crates/compiler/mono/src/layout/intern.rs b/crates/compiler/mono/src/layout/intern.rs\nindex 9891c59f2..138d602cb 100644\n--- a/crates/compiler/mono/src/layout/intern.rs\n+++ b/crates/compiler/mono/src/layout/intern.rs\n@@ -341,9 +341,10 @@ pub trait LayoutInterner&lt;&#39;a&gt;: Sized {\n                 }\n                 doc\n             }\n-            LambdaSet(lambda_set) =&gt; {\n-                self.to_doc(lambda_set.runtime_representation(), alloc, seen_rec, parens)\n-            }\n+            LambdaSet(lambda_set) =&gt; alloc\n+                .text(&quot;LambdaSet(&quot;)\n+                .append(self.to_doc(lambda_set.runtime_representation(), alloc, seen_rec, parens))\n+                .append(&quot;)&quot;),\n             RecursivePointer(rec_layout) =&gt; {\n                 if seen_rec.contains(&amp;rec_layout) {\n                     alloc.text(&quot;*self&quot;)\ndiff --git a/crates/compiler/test_gen/src/gen_abilities.rs b/crates/compiler/test_gen/src/gen_abilities.rs\nindex 2bc4791b7..4d099c386 100644\n--- a/crates/compiler/test_gen/src/gen_abilities.rs\n+++ b/crates/compiler/test_gen/src/gen_abilities.rs\n@@ -2222,21 +2222,7 @@ mod inspect {\n             app &quot;test&quot; provides [main] to &quot;./platform&quot;\n\n             main = [\n-                Inspect.inspect 0,              # Num a\n                 Inspect.inspect 1u8,            # U8\n-                Inspect.inspect 2i8,            # I8\n-                Inspect.inspect 3u16,           # U16\n-                Inspect.inspect 4i16,           # I16\n-                Inspect.inspect 5u32,           # U32\n-                Inspect.inspect 6i32,           # I32\n-                Inspect.inspect 7u64,           # U64\n-                Inspect.inspect 8i64,           # I64\n-                Inspect.inspect 9u128,          # U128\n-                Inspect.inspect 10i128,         # I128\n-                Inspect.inspect 0.5,            # Frac a\n-                Inspect.inspect 1.5f32,         # F32\n-                Inspect.inspect 2.2f64,         # F64\n-                Inspect.inspect (1.1dec + 2.2), # Dec\n             ] |&gt; List.map Inspect.toDbgStr |&gt; Str.joinWith &quot;, &quot;\n             &quot;#\n             ),\n</code></pre></div>",
        "id": 404917096,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701278984
    },
    {
        "content": "<p>And this invocation</p>\n<div class=\"codehilite\"><pre><span></span><code>‚ùØ ROC_PRINT_IR_AFTER_RESET_REUSE=1 ROC_CHECK_MONO_IR=1 cargo test-gen-wasm inspect::num\n</code></pre></div>",
        "id": 404917134,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701278997
    },
    {
        "content": "<p>There's stuff like this</p>\n<div class=\"codehilite\"><pre><span></span><code>procedure : `Inspect.256` Str\nprocedure = `Inspect.256` (`Inspect.f0`: Str, `Inspect.num`: LambdaSet(U8)):\n    let `Inspect.318` : Str = CallByName `Num.toStr` `Inspect.num`;\n    let `Inspect.317` : Str = CallByName `Inspect.dbgWrite` `Inspect.f0` `Inspect.318`;\n    ret `Inspect.317`;\n</code></pre></div>",
        "id": 404917270,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701279035
    },
    {
        "content": "<p>The initial generator of the inspector looks right</p>\n<div class=\"codehilite\"><pre><span></span><code>procedure : `Inspect.inspect` Str\nprocedure = `Inspect.inspect` (`Inspect.val`: U8):\n    let `Inspect.312` : LambdaSet(U8) = CallByName `Inspect.dbgU8` `Inspect.val`;\n    let `Inspect.309` : {} = Struct {};\n    let `Inspect.308` : Str = CallByName `Inspect.dbgInit` `Inspect.309`;\n    let `Inspect.307` : Str = CallByName `Inspect.256` `Inspect.308` `Inspect.312`;\n    ret `Inspect.307`;\n</code></pre></div>",
        "id": 404917374,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701279074
    },
    {
        "content": "<p>But that <code>Inspect.256</code> is definitely wrong, which I think you're right is that <code>dbg*</code> function</p>",
        "id": 404917592,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701279155
    },
    {
        "content": "<p>It's almost certainly a problem in the chosen specialization, since after the specialization is applied it's not type-checked again</p>",
        "id": 404917645,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701279178
    },
    {
        "content": "<p>First signs of life:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>cargo<span class=\"w\"> </span>run<span class=\"w\"> </span>examples/platform-switching/main.roc\n<span class=\"w\">    </span>Finished<span class=\"w\"> </span>dev<span class=\"w\"> </span><span class=\"o\">[</span>unoptimized<span class=\"w\"> </span>+<span class=\"w\"> </span>debuginfo<span class=\"o\">]</span><span class=\"w\"> </span>target<span class=\"o\">(</span>s<span class=\"o\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"m\">0</span>.50s\n<span class=\"w\">     </span>Running<span class=\"w\"> </span><span class=\"sb\">`</span>target/debug/roc<span class=\"w\"> </span>examples/platform-switching/main.roc<span class=\"sb\">`</span>\nüî®<span class=\"w\"> </span>Rebuilding<span class=\"w\"> </span>platform...\n<span class=\"o\">[</span>TODO:<span class=\"w\"> </span>add<span class=\"w\"> </span>filepath<span class=\"w\"> </span>here<span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">{</span>num:<span class=\"w\"> </span><span class=\"m\">32</span>,<span class=\"w\"> </span>str:<span class=\"w\"> </span><span class=\"s2\">\"test\"</span><span class=\"o\">}</span>\nWhich<span class=\"w\"> </span>platform<span class=\"w\"> </span>am<span class=\"w\"> </span>I<span class=\"w\"> </span>running<span class=\"w\"> </span>on<span class=\"w\"> </span>now?\n</code></pre></div>",
        "id": 404927335,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701282674
    },
    {
        "content": "<p>Also, in all of our platform switching examples, <code>roc_panic</code> is technically wrong. It only works with small strings cause it assume a <code>char*</code>. instead of a <code>RocStr*</code>.</p>",
        "id": 404927861,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701282876
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/issues/6116\">#6116</a> is a first pass at creating a PR for dbg using inspect.</p>\n<p>It is still missing a lot, but is nearly at a place where we could submit it just to enable a better version of <code>dbg</code> for advent of code. At a minimum, I need to update all the platforms to include <code>roc_dbg</code>, but I listed a number of other goals in the PR. Not sure how many we will get to, but I think even without the extra goals, it should be submittable soon.</p>\n<p>Also, a first pass on review comments would be nice.</p>",
        "id": 404978214,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701305192
    },
    {
        "content": "<p>Ok. So I think this is at a state where I want to submit it and do anything else in a follow up PR (sans fixing tests). That way, it hopefully can be merged tomorrow and ready for advent of code on friday.</p>\n<p>There are still a number of changes listed in the PR and a suggestion by Ayaz that I want to make, but I want to push that all to follow ups in order to get this in.</p>",
        "id": 405046511,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701326922
    },
    {
        "content": "<p>related:</p>\n<ul>\n<li>basic cli update: <a href=\"https://github.com/roc-lang/basic-cli/pull/138\">https://github.com/roc-lang/basic-cli/pull/138</a></li>\n<li>basic webserver update: <a href=\"https://github.com/roc-lang/basic-webserver/pull/13\">https://github.com/roc-lang/basic-webserver/pull/13</a></li>\n</ul>",
        "id": 405046894,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701327035
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span>, if you get the chance, can you merge and cut a release for those 2 PRs? Basic CLI being the more important one for advent of code. Should be fine to cut a release before the new roc version is out.</p>",
        "id": 405047356,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701327173
    },
    {
        "content": "<p>Massive effort Brendan!! This will be such a nice improvement for everyone, even if most people never see this work. <span aria-label=\"octopus\" class=\"emoji emoji-1f419\" role=\"img\" title=\"octopus\">:octopus:</span></p>",
        "id": 405050429,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701328054
    },
    {
        "content": "<p>Can I get a review on <a href=\"https://github.com/roc-lang/roc/issues/6116\">#6116</a> to submit it? All test are green now (had to disable 2 that have unrelated bugs to be fixed later related to wrong exit codes)</p>",
        "id": 405147368,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701359846
    },
    {
        "content": "<p>As a note, though the PR is large, it is mostly fluff from platform changes to <code>roc_dbg</code> and <code>roc_panic</code>. The <code>crates/compiler</code> folder being the main changes that matter.</p>",
        "id": 405151832,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701361030
    },
    {
        "content": "<p>Ok, now we just need to cut new releases of platforms that will be used with AOC such that they have a <code>roc_dbg</code> impl.</p>",
        "id": 405219060,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701383292
    },
    {
        "content": "<p>amazing work <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span>!!!</p>",
        "id": 405219121,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701383324
    },
    {
        "content": "<blockquote>\n<p>related:</p>\n<ul>\n<li>basic cli update: <a href=\"https://github.com/roc-lang/basic-cli/pull/138\">https://github.com/roc-lang/basic-cli/pull/138</a></li>\n<li>basic webserver update: <a href=\"https://github.com/roc-lang/basic-webserver/pull/13\">https://github.com/roc-lang/basic-webserver/pull/13</a></li>\n</ul>\n</blockquote>\n<p>This two PRs are both ultra simple if someone wants to review and merge them. For basic-cli and basic-webserver.</p>",
        "id": 405219457,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701383477
    },
    {
        "content": "<p>also in order to get the new basic-cli into the tutorial, we need to double check that it still works after the breaking <code>Stdin</code> change</p>",
        "id": 405219810,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701383648
    },
    {
        "content": "<p>If we need anything updated I have time today to do that. Should I test basic-cli with a branch?</p>",
        "id": 405219862,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701383680
    },
    {
        "content": "<p>yeah sounds good <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span></p>",
        "id": 405219976,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701383742
    },
    {
        "content": "<p>that would be great, thank you <span class=\"user-mention\" data-user-id=\"515757\">@Luke Boswell</span>!</p>",
        "id": 405219997,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701383754
    },
    {
        "content": "<p>With what was just merged and the new compiler, basic-cli should just work with dbg.</p>",
        "id": 405220220,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701383861
    },
    {
        "content": "<p>So I think we just need to cut a new release (and update the examples in the repo to use the new release).</p>",
        "id": 405220303,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701383895
    },
    {
        "content": "<p>Oh, and update any examples for AOC to the new release as well.</p>",
        "id": 405220320,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701383905
    },
    {
        "content": "<p>I think we need Anton to be able to cut a new release?</p>",
        "id": 405220459,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701383995
    },
    {
        "content": "<p>So is that a release of basic-cli or just a nightly?</p>",
        "id": 405220546,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701384024
    },
    {
        "content": "<p>both</p>",
        "id": 405220914,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701384199
    },
    {
        "content": "<p>Cause the platform now has a <code>roc_dbg</code> that needs to be available.</p>",
        "id": 405221045,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701384247
    },
    {
        "content": "<p>We have a bug with <code>dbg</code> for opaque types. That should probably be resolved before cutting a new nightly. I don't think this blocks platform release, but the platform releases should stay in testing until we have a new nightly.</p>",
        "id": 405222785,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701385014
    },
    {
        "content": "<p>So for the opaque bug, it is an issue with not creating a correct specialization when dealing with inspect an opaque value with an automatically derived impl.</p>\n<p>Essentially, <code>Inspect.opaque</code> is a <code>* -&gt; Inspector f</code>, but we need to specialize it to the opaque type. So for <code>Utc := ...</code> we want the final version of the function to be <code>Utc -&gt; Inspector f</code>. I think that specialized version is not being generating and we are hitting issues. That is at least my guess.</p>",
        "id": 405224361,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701385671
    },
    {
        "content": "<p>I tried to write a manual impl:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">toInspector</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"err\">\\</span><span class=\"nx\">u</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span>\n<span class=\"w\">    </span><span class=\"nx\">fmt</span><span class=\"w\"> </span><span class=\"o\">&lt;-</span><span class=\"w\"> </span><span class=\"nx\">Inspect</span><span class=\"p\">.</span><span class=\"nx\">custom</span>\n<span class=\"w\">    </span><span class=\"nx\">Inspect</span><span class=\"p\">.</span><span class=\"nx\">opaque</span><span class=\"w\"> </span><span class=\"nx\">u</span>\n<span class=\"w\">    </span><span class=\"o\">|&gt;</span><span class=\"w\"> </span><span class=\"nx\">Inspect</span><span class=\"p\">.</span><span class=\"nx\">apply</span><span class=\"w\"> </span><span class=\"nx\">fmt</span>\n</code></pre></div>\n<p>This maybe gives a clearer error:</p>\n<div class=\"codehilite\"><pre><span></span><code>This value is a declared specialization of type:\n\n    * -&gt; Inspector f where f implements InspectFormatter\n\nBut the type annotation on toInspector says it must match:\n\n    val -&gt;\n    Inspector f where val implements Inspect, f implements InspectFormatter\n</code></pre></div>\n<p>The function has to be explicitly typed to avoid the error:</p>\n<div class=\"codehilite\"><pre><span></span><code>toInspector : Utc -&gt; Inspect.Inspector f where f implements Inspect.InspectFormatter\n</code></pre></div>",
        "id": 405224605,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701385789
    },
    {
        "content": "<p>So maybe I can change the auo derivation to add a type and that will fix the issue.</p>",
        "id": 405224677,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701385809
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"454654\">@Ayaz Hafiz</span> any chance you can take a look at this? Repro is just to try and run <code>dbg</code> on an <code>opaque</code> type that doesn't implement <code>Inspect</code> at all. So something like:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nx\">Op</span><span class=\"w\"> </span><span class=\"o\">:=</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n\n<span class=\"nx\">dbg</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">@Op</span><span class=\"w\"> </span><span class=\"p\">{})</span>\n</code></pre></div>",
        "id": 405259512,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701399959
    },
    {
        "content": "<p>I get the feeling it is probably a simple fix but I am not following it fully.</p>",
        "id": 405259629,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701399994
    },
    {
        "content": "<p>What branch is this on?</p>",
        "id": 405264892,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701402048
    },
    {
        "content": "<p>main</p>",
        "id": 405264981,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701402117
    },
    {
        "content": "<p>Where is the initial bug report?</p>",
        "id": 405265055,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701402145
    },
    {
        "content": "<p>I havent made an Issue for it</p>",
        "id": 405265069,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701402156
    },
    {
        "content": "<p>I can if that helps</p>",
        "id": 405265073,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701402160
    },
    {
        "content": "<p>Can you share it with me?</p>",
        "id": 405265074,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701402162
    },
    {
        "content": "<p>Maybe just a repro here</p>",
        "id": 405265090,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701402174
    },
    {
        "content": "<p>Does it fail with \"expected to know a specialization for <code>#UserApp.Op</code>#<code>Inspect.toInspector</code>, but it wasn't found\"?</p>",
        "id": 405265128,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701402198
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>$ roc dev examples/platform-switching/rocLovesZig.roc\nAn internal compiler expectation was broken.\nThis is definitely a compiler bug.\nPlease file an issue here: https://github.com/roc-lang/roc/issues/new/choose\nthread &#39;&lt;unnamed&gt;&#39; panicked at &#39;expected to know a specialization for `17.IdentId(1)`#`15.IdentId(32)`, but it wasn&#39;t found&#39;, /Users/luke/Documents/GitHub/roc/crates/compiler/solve/src/specialize.rs:744:33\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\n</code></pre></div>",
        "id": 405265256,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701402262
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code># examples/platform-switching/rocLovesZig.roc\napp &quot;rocLovesZig&quot;\n    packages { pf: &quot;zig-platform/main.roc&quot; }\n    imports []\n    provides [main] to pf\n\nmain =\n    dbg (@Op {})\n\n    &quot;Roc &lt;3 Zig!\\n&quot;\n\nOp := {}\n</code></pre></div>",
        "id": 405265274,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701402280
    },
    {
        "content": "<p>Created an issue for this <a href=\"https://github.com/roc-lang/roc/issues/6127\">https://github.com/roc-lang/roc/issues/6127</a></p>",
        "id": 405265677,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701402375
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/pull/6128\">https://github.com/roc-lang/roc/pull/6128</a> should take care of it</p>",
        "id": 405273010,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701404645
    },
    {
        "content": "<p>I left a detailed explanation of the issue.</p>",
        "id": 405273050,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701404669
    },
    {
        "content": "<p>Super easy review to add inspect to most of the opaque types in basic-cli: <a href=\"https://github.com/roc-lang/basic-cli/pull/139\">https://github.com/roc-lang/basic-cli/pull/139</a></p>",
        "id": 405297706,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701415843
    },
    {
        "content": "<p>It's failing CI: <code>Only builtin abilities can be derived.</code><br>\nThat suggests it's using the previous version of the compiler?</p>",
        "id": 405299042,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1701416310
    },
    {
        "content": "<p>We need to cut a nightly release before updating the platforms after Ayaz's change.</p>",
        "id": 405300008,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1701416517
    },
    {
        "content": "<p>Ah, ok. Didn't think about that.</p>",
        "id": 405301633,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701417063
    },
    {
        "content": "<p>Guess it can wait</p>",
        "id": 405301646,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701417068
    },
    {
        "content": "<p>I'll get started on releasing all the things :p</p>",
        "id": 405327641,
        "sender_full_name": "Anton",
        "timestamp": 1701425126
    },
    {
        "content": "<p>Thanks for getting this out <span aria-label=\"thank you\" class=\"emoji emoji-1f64f\" role=\"img\" title=\"thank you\">:thank_you:</span></p>",
        "id": 405386109,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701444457
    },
    {
        "content": "<p>Thanks for getting it all ready :)</p>",
        "id": 405391019,
        "sender_full_name": "Anton",
        "timestamp": 1701446048
    },
    {
        "content": "<p>yeah it's really great that people today have been able to use it to get unblocked from <code>dbg</code> bugs - huge thanks to both of you for shipping it in time! <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 405401372,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701449613
    },
    {
        "content": "<p>I currently don't get any output from dbg when I am running a test. Is there some flag I need to enable for that to happen? The results appear just fine in an actual run</p>",
        "id": 405402036,
        "sender_full_name": "Pearce Keesling",
        "timestamp": 1701449826
    },
    {
        "content": "<p>Hmm, I wonder which <code>roc_dbg</code> that hooks into. I guess whichever one the compiler itself exposes. I guess we need to update that.</p>",
        "id": 405402246,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701449896
    },
    {
        "content": "<p>When running a test, do you mean <code>roc test myfile.roc</code>?</p>",
        "id": 405402278,
        "sender_full_name": "Anton",
        "timestamp": 1701449906
    },
    {
        "content": "<p>I think <code>roc build myfile.roc</code> will still drop dbg like it used to before the new dbg</p>",
        "id": 405402396,
        "sender_full_name": "Anton",
        "timestamp": 1701449947
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"361169\">Anton</span> <a href=\"#narrow/stream/316715-contributing/topic/auto-derived.20Inspect/near/405402278\">said</a>:</p>\n<blockquote>\n<p>When running a test, do you mean <code>roc test myfile.roc</code>?</p>\n</blockquote>\n<p>Yeah exactly</p>",
        "id": 405403723,
        "sender_full_name": "Pearce Keesling",
        "timestamp": 1701450243
    },
    {
        "content": "<p>Can you make an issue and share your code there <span class=\"user-mention\" data-user-id=\"492563\">@Pearce Keesling</span>?</p>",
        "id": 405405616,
        "sender_full_name": "Anton",
        "timestamp": 1701450835
    },
    {
        "content": "<p>Sure thing <span aria-label=\"thumbs up\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"thumbs up\">:thumbs_up:</span> . I do need to verify that I actually understand the issue though. I noticed just now when I was running the test that it marked it as a \"warning\" which makes me think it is interpreting stderr output as warning on a test?</p>",
        "id": 405406347,
        "sender_full_name": "Pearce Keesling",
        "timestamp": 1701451073
    },
    {
        "content": "<blockquote>\n<p>that it marked it as a \"warning\"</p>\n</blockquote>\n<p>I'm not sure what you mean here, can you be more specific?</p>",
        "id": 405408880,
        "sender_full_name": "Anton",
        "timestamp": 1701451844
    },
    {
        "content": "<p>I'm seeing</p>\n<div class=\"codehilite\"><pre><span></span><code>Undefined symbols for architecture arm64:\n  &quot;_roc_dbg&quot;, referenced from:\n      _#UserApp_determineCalibration_3bbacd33228bca14fe5573efe7278cde33c78fe9028ba98810cff368dece in roc_appGIhqSC.o\nld: symbol(s) not found for architecture arm64\n</code></pre></div>\n<p>with basic-cli 0.6.2. Is there a blocker here?</p>",
        "id": 405449764,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1701471051
    },
    {
        "content": "<p>I think <code>roc_dbg</code> is in 0.7</p>",
        "id": 405450131,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701471251
    },
    {
        "content": "<p><a class=\"stream-topic\" data-stream-id=\"397893\" href=\"/#narrow/stream/397893-announcements/topic/basic-cli.200.2E7.2E0\">#announcements &gt; basic-cli 0.7.0</a></p>",
        "id": 405450169,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701471286
    },
    {
        "content": "<p>So 1 thing I think we missed with <code>dbg</code> that might be quite nice. Do we also want to send the source to the platform. So we send location in the form <code>path:line</code>, the src, and the dbg str. As a result, this:</p>\n<div class=\"codehilite\"><pre><span></span><code>#App.roc\nx = 27\ndbg x\n</code></pre></div>\n<p>as:</p>\n<div class=\"codehilite\"><pre><span></span><code>[path/App.roc:2] x = 27\n</code></pre></div>\n<p>Thoughts? The one pain about this is it requires adding one more parameter to all <code>roc_debug</code> impls and it is another breaking change that requires some update shuffling.</p>\n<p>Currently, we already have location, so we can get <code>[path/App.roc:2] 27</code> without the context of the src.</p>",
        "id": 405480476,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701487426
    },
    {
        "content": "<p>With the source add, our debug would be able to print exactly like rust.</p>",
        "id": 405480528,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701487454
    },
    {
        "content": "<p>I love that idea! <span aria-label=\"smiley\" class=\"emoji emoji-1f603\" role=\"img\" title=\"smiley\">:smiley:</span></p>",
        "id": 405480619,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701487523
    },
    {
        "content": "<p>I definitely think it's worth the breaking change assuming we like the idea, although we don't need to rush it out this time <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 405480670,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701487543
    },
    {
        "content": "<p>So I may have just implemented it and that is why I asked... <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 405481509,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701487798
    },
    {
        "content": "<p>haha awesome!</p>",
        "id": 405482515,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701488103
    },
    {
        "content": "<p>yeah let's try it!</p>",
        "id": 405482525,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701488107
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>[../roc-basic-cli/examples/time.roc:12] (x * 2) = 44\n</code></pre></div>",
        "id": 405489713,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701490934
    },
    {
        "content": "<p>and it works <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 405489763,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701490947
    },
    {
        "content": "<p>This is pretty cool. Question, will this print the entire expression always? What if it‚Äôs multiline?</p>",
        "id": 405490416,
        "sender_full_name": "Agus Zubiaga",
        "timestamp": 1701491310
    },
    {
        "content": "<p>The current setup I have is to just grab the entire condition region, so yes.</p>",
        "id": 405490695,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701491596
    },
    {
        "content": "<p>Would be up to the platform currently to elide or do something fancier</p>",
        "id": 405490702,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701491609
    },
    {
        "content": "<p>Not exactly the prettiest:</p>\n<div class=\"codehilite\"><pre><span></span><code>[../roc-basic-cli/examples/time.roc:13] (x\n        *\n        2) = 44\n</code></pre></div>\n<p>Which to be fair is exactly what rust does;</p>\n<div class=\"codehilite\"><pre><span></span><code>[crates/compiler/can/src/operator.rs:661] arena.alloc(Loc {\n        value: LowLevelDbg(arena.alloc(format!(&quot;{}:{}&quot;, module_path,\n                    line_col.line)), arena.alloc(dbg_src), dbg_str,\n            desugared_continuation),\n        region: loc_expr.region,\n    }) = // Elide for brevty\n</code></pre></div>",
        "id": 405491382,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701491924
    },
    {
        "content": "<p>We just need to clean up our paths eventually.</p>",
        "id": 405491451,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701491940
    },
    {
        "content": "<blockquote>\n<p>I definitely think it's worth the breaking change assuming we like the idea, although we don't need to rush it out this time <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n</blockquote>\n<p>We can bundle this breaking change with the one for the simple-c-abi branch</p>",
        "id": 405518184,
        "sender_full_name": "Anton",
        "timestamp": 1701510635
    },
    {
        "content": "<p>So one thing I realized though haven't done yet....I can technically make this a non breaking change by putting the args in a weird order.</p>",
        "id": 405546412,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701533259
    },
    {
        "content": "<p>The args are currently <code>(loc, msg)</code> If I make the new args be <code>(loc, msg, src)</code>, all of the old functions will just access the first two args and ignore the third. They would have the exact same behaviour as current.</p>",
        "id": 405546570,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701533403
    },
    {
        "content": "<p>could do that for now and then switch the order to a more logical one when doing the breaking abi change</p>",
        "id": 405546659,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701533464
    },
    {
        "content": "<p>That said, currently on the branch, the args are in the order <code>(loc, src, msg)</code> cause I like that order better. This could be merged without totally breaking dbg, but with non-updated platforms, the dbg statements would be useless. For:</p>\n<div class=\"codehilite\"><pre><span></span><code>x = 3\ndbg x\n</code></pre></div>\n<p>It would print</p>\n<div class=\"codehilite\"><pre><span></span><code>[some/file:1] x\n</code></pre></div>",
        "id": 405546799,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701533602
    },
    {
        "content": "<p>I think <a href=\"https://github.com/roc-lang/roc/issues/6143\">#6143</a> is ready for review. Should be passing tests now, we'll see if all of CI is green in a bit. <span class=\"user-mention\" data-user-id=\"281383\">@Richard Feldman</span></p>\n<p>Would you prefer for me to reorder all the args to <code>(loc, msg, src)</code> such that current platforms with the old version of <code>roc_dbg</code> just keep working instead of printing out as I mentioned in the comment directly above this? Or should I just leave it as is accepting the mildly breaking change until other platforms are updated?</p>",
        "id": 405567780,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1701552117
    },
    {
        "content": "<p>I think reordering for backwards compatibility is worth it for now, to avoid disrupting advent of code <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 405568165,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1701552492
    }
]
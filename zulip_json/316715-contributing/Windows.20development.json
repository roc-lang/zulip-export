[
    {
        "content": "<p>Hi I'm a hobby windows developer and I'd love to help out here if I can. I'm happy to look at good first issues having coded for a few years but never contributed before! My WSL2 roc install didn't fully work and so I saw this thread and was hopeful of trying the Windows build instead. cargo build failed for me on my Windows 10.0.19044.1889 initially until I realised I needed to install Zig. It now builds as far as roc_builtins and is now erroring on \"No suitable version of LLVM was found system-wide or pointed to by LLVM_SYS_130_PREFIX. Consider using <code>llvmenv</code> to compile an appropriate copy of LLVM, and refer to the llvm-sys documentation for more information.\" and wondering if you can suggest what \"appropriate LLVM\" would be to install to get past that or if I've missed some other step? Or, I'm also happy to persevere with linux instead if that would be more appropriate.</p>",
        "id": 296579228,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662036743
    },
    {
        "content": "<p>more people trying out windows and seeing what fails is really helpful. For llvm, the <code>BUILDING_FROM_SOURCE.md</code> has a section \"llvm installation on windows\" that you can follow</p>",
        "id": 296579965,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662036992
    },
    {
        "content": "<p>based on experience, make sure that the path you install it at does not include any spaces</p>",
        "id": 296580030,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662037014
    },
    {
        "content": "<p>the tooling does not seem to handle those well</p>",
        "id": 296580078,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662037028
    },
    {
        "content": "<p>missing from that document is setting that you need to set this variable <code>$Env:LLVM_SYS_130_PREFIX=\"C:\\foo\\bar\\LLVM-13.0.0-win64\"</code> (note no bin on the end, it must point to the folder with the llvm things)</p>",
        "id": 296580476,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662037150
    },
    {
        "content": "<p>OK great thanks I somehow missed the windows section as I skimmed that doc looking for instructions earlier - will give that and your notes a try!</p>",
        "id": 296580605,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662037199
    },
    {
        "content": "<p>that should get you a working <code>cargo build</code> I think, and you can run some of our examples that have a zig platform</p>",
        "id": 296580690,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662037217
    },
    {
        "content": "<p>other platform languages we have not tried (may be fun to see if e.g. rust works, or maybe it needs a bit of work with file names and extensions in some places)</p>",
        "id": 296580821,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662037252
    },
    {
        "content": "<p>and many tests and examples seem to segfault</p>",
        "id": 296580870,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662037264
    },
    {
        "content": "<p>if you are able to get a debugger to work on our binaries, that would be amazing</p>",
        "id": 296580939,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662037280
    },
    {
        "content": "<p>I'm more used to \"dbg!\" than debugger but see how I go later.</p>\n<p>For now it looks like I had debug tools and VS 2019 installed, so I updated those, installed LLVM directly under C to avoid spaces in path, added that to environment path and the LLVM_SYS_130_PREFIX pointing to the root llvm folder...<br>\n...and cargo build worked!</p>\n<p>So I tried these tests:</p>\n<ul>\n<li>\n<p>cargo run repl worked except thread 'main' has overflowed its stack when I entered \"hello, world\"</p>\n</li>\n<li>\n<p>cd to /target/debug and ran roc run ../../examples/hello-world/main.roc and I get a clang error: unsupported option '-fPIC' for target 'x86_64-pc-windows-msvc' ', crates\\compiler\\build\\src\\link.rs:1310:27</p>\n</li>\n</ul>\n<p>which seems like an unsupported windows flag? I quickly tried commenting that flag out of <a href=\"http://link.rs\">link.rs</a> and rebuilding and got more errors so assume that's not an obvious fix</p>\n<ul>\n<li>roc run ../../examples/algorithms/fibonacci.roc<br>\nC:\\ProgramData\\chocolatey\\lib\\zig\\tools\\zig-windows-x86_64-0.9.1\\lib\\std\\os.zig:73:25: error: container 'std.c' has no member called 'CLOCK'pub const CLOCK = system.CLOCK;<br>\n                        ^<br>\n', crates\\compiler\\build\\src\\link.rs:1310:27</li>\n</ul>\n<p>But I can get the basic zig example to work: <a href=\"https://ziglang.org/documentation/0.9.1/#Hello-World\">https://ziglang.org/documentation/0.9.1/#Hello-World</a></p>\n<p>Are these the kind of errors it should have at this stage, or do you think there are other steps I need to do first?</p>",
        "id": 296597322,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662042449
    },
    {
        "content": "<p>and sorry meant to say cargo check is fine, but cargo test errors at below:</p>\n<p>error: failed to run custom build command for <code>wasm3-sys v0.5.0 (https://github.com/roc-lang/wasm3-rs?rev=f0f807d1fc0a50d1d68e5799e54ee62c05af00f5#f0f807d1)</code></p>\n<p>Caused by:<br>\n  process didn't exit successfully: <code>H:\\Development\\roc\\target\\debug\\build\\wasm3-sys-45856a24a6e97685\\build-script-build</code> (exit code: 101)  <br>\n  --- stderr<br>\n  thread 'main' panicked at 'Unable to generate bindings: Error { kind: NotFound, message: \"program not found\" }', C:\\Users\\&lt;redacted&gt;\\.cargo\\git\\checkouts\\wasm3-rs-50bf15e0ec9610c1\\f0f807d\\wasm3-sys\\build.rs:68:35</p>",
        "id": 296599121,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662042983
    },
    {
        "content": "<p><code>cargo install bindgen</code> for that last one</p>",
        "id": 296607678,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662045361
    },
    {
        "content": "<p>for the zig clock thing, I have a PR that fixes it for the benchmarks platform <a href=\"https://github.com/roc-lang/roc/pull/3936\">https://github.com/roc-lang/roc/pull/3936</a></p>",
        "id": 296607957,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662045423
    },
    {
        "content": "<p>hello world uses a C platform. I wonder if maybe on windows we should use zig as the C compiler?</p>",
        "id": 296608124,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662045460
    },
    {
        "content": "<p><code>cargo run examples/platform-switching/zig-platform/rocLovesZig.roc</code> should work btw</p>",
        "id": 296608283,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662045493
    },
    {
        "content": "<p>and then yes, we get lots of random segfaults (reported as stack overflows or other stuff) currently</p>",
        "id": 296608369,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662045518
    },
    {
        "content": "<p>the challenge will be to track those down, none of us have real developing native apps on windows experience</p>",
        "id": 296608456,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662045540
    },
    {
        "content": "<p>so we don't currently have the tooling/know-how to debug the problems</p>",
        "id": 296608510,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662045553
    },
    {
        "content": "<p>OK sorry I obviously missed that bindgen step too! - yes that worked and cargo test got through a lot more tests although crashed on a few at the end with link.exe existing code 1120 on roc_editor, roc_repository, test_derive roc_load_internal, roc_highlight, roc_glue (more out of terminal limit).<br>\nI tried applying the 6 file updates from pull 3936 but after cargo build, cargo run examples/benchmark/platform/main.roc seemed to work but did nothing until cancelled after a few minutes of inactivity, unless it takes longer than few mins to run?<br>\nUnderstand for hello world - I don't know really, but as zig seems to work it gets my vote<br>\nAnd yes rocLovesZig works!<br>\nAnd I see I get it now, I don't have much native Windows app experience either - I just use it as my main OS, but I'll look into setting up debugging and help where I can - and I can see if I can pick my .Net colleagues brains every now and then.<br>\nThanks so much for your patience and help, it's an interesting project and I look forward to contrinuting more usefully as I learn! Will turn in now and take another look tomorrow after work.</p>",
        "id": 296649539,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662048736
    },
    {
        "content": "<p><code>main.roc</code> is the platform file, you should run the app module <code>rocLovesZig.roc</code></p>",
        "id": 296652506,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662049693
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/pull/3948\">https://github.com/roc-lang/roc/pull/3948</a> has a fix that hopefully fixes some tests on windows. It has a command to run some tests. Can someone on windows run those tests and report  the results?</p>",
        "id": 296673476,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662056237
    },
    {
        "content": "<p>failures:</p>\n<p>---- gen_num::to_i32_checked_larger_width_signed_fits_pos stdout ----<br>\nthread 'gen_num::to_i32_checked_larger_width_signed_fits_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d8a95aa8, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13<br>\nnote: run with <code>RUST_BACKTRACE=1</code> environment variable to display a backtrace</p>\n<p>---- gen_num::to_i32_checked_larger_width_signed_fits_neg stdout ----<br>\nthread 'gen_num::to_i32_checked_larger_width_signed_fits_neg' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d3a30a88, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_i32_checked_larger_width_signed_oob_pos stdout ----<br>\nthread 'gen_num::to_i32_checked_larger_width_signed_oob_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d0cbb4c8, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_i32_checked_larger_width_unsigned_fits_pos stdout ----<br>\nthread 'gen_num::to_i32_checked_larger_width_unsigned_fits_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d0cb8a88, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_i32_checked_larger_width_unsigned_oob_pos stdout ----<br>\nthread 'gen_num::to_i32_checked_larger_width_unsigned_oob_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d3a334c8, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_i32_checked_larger_width_signed_oob_neg stdout ----<br>\nthread 'gen_num::to_i32_checked_larger_width_signed_oob_neg' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198cfef49b8, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_i32_checked_same_width_unsigned_fits stdout ----<br>\nthread 'gen_num::to_i32_checked_same_width_unsigned_fits' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198cd4297a0, llvm_type: \"i32\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_i32_checked_same_width_unsigned_oob stdout ----<br>\nthread 'gen_num::to_i32_checked_same_width_unsigned_oob' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d07254c0, llvm_type: \"i32\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_larger_width_signed_fits_pos stdout ----<br>\nthread 'gen_num::to_u32_checked_larger_width_signed_fits_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d7875cc8, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_larger_width_signed_oob_neg stdout ----<br>\nthread 'gen_num::to_u32_checked_larger_width_signed_oob_neg' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198cac73d68, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_same_width_signed_oob stdout ----<br>\nthread 'gen_num::to_u32_checked_same_width_signed_oob' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198e187a500, llvm_type: \"i32\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_larger_width_unsigned_oob_pos stdout ----<br>\nthread 'gen_num::to_u32_checked_larger_width_unsigned_oob_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198dfbb3798, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_same_width_signed_fits stdout ----<br>\nthread 'gen_num::to_u32_checked_same_width_signed_fits' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198e1b4fad0, llvm_type: \"i32\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_larger_width_unsigned_fits_pos stdout ----<br>\nthread 'gen_num::to_u32_checked_larger_width_unsigned_fits_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198dfbb76f8, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_larger_width_signed_oob_pos stdout ----<br>\nthread 'gen_num::to_u32_checked_larger_width_signed_oob_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198e1878568, llvm_type: \"i64\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_smaller_width_neg_oob stdout ----<br>\nthread 'gen_num::to_u32_checked_smaller_width_neg_oob' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198cd6001e0, llvm_type: \"i8\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>---- gen_num::to_u32_checked_smaller_width_pos stdout ----<br>\nthread 'gen_num::to_u32_checked_smaller_width_pos' panicked at 'Found IntType(IntType { int_type: Type { address: 0x198d9898fa0, llvm_type: \"i8\" } }) but expected the PointerType variant', C:\\Users\\Richard Feldman\\.cargo\\git\\checkouts\\inkwell-55729a4c43239568\\accd406\\src\\types\\enums.rs:398:13</p>\n<p>failures:<br>\n    gen_num::to_i32_checked_larger_width_signed_fits_neg<br>\n    gen_num::to_i32_checked_larger_width_signed_fits_pos<br>\n    gen_num::to_i32_checked_larger_width_signed_oob_neg<br>\n    gen_num::to_i32_checked_larger_width_signed_oob_pos<br>\n    gen_num::to_i32_checked_larger_width_unsigned_fits_pos<br>\n    gen_num::to_i32_checked_larger_width_unsigned_oob_pos<br>\n    gen_num::to_i32_checked_same_width_unsigned_fits<br>\n    gen_num::to_i32_checked_same_width_unsigned_oob<br>\n    gen_num::to_u32_checked_larger_width_signed_fits_pos<br>\n    gen_num::to_u32_checked_larger_width_signed_oob_neg<br>\n    gen_num::to_u32_checked_larger_width_signed_oob_pos<br>\n    gen_num::to_u32_checked_larger_width_unsigned_fits_pos<br>\n    gen_num::to_u32_checked_larger_width_unsigned_oob_pos<br>\n    gen_num::to_u32_checked_same_width_signed_fits<br>\n    gen_num::to_u32_checked_same_width_signed_oob<br>\n    gen_num::to_u32_checked_smaller_width_neg_oob<br>\n    gen_num::to_u32_checked_smaller_width_pos</p>\n<p>test result: FAILED. 149 passed; 17 failed; 0 ignored; 0 measured; 938 filtered out; finished in 22.65s</p>",
        "id": 296692954,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1662063364
    },
    {
        "content": "<p>that was on Windows 11</p>",
        "id": 296692981,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1662063368
    },
    {
        "content": "<p>FYI on Windows 10 I got the same result after pulling 3948 - plus these additional 5 failures:</p>\n<p>---- gen_num::to_f32_from_i64 stdout ----<br>\nthread 'gen_num::to_f32_from_i64' panicked at 'Error loading compiled dylib for test: LoadLibraryExW { source: Os { code: 193, kind: Uncategorized, message: \"%1 is not a valid Win32 application.\" } }', crates\\compiler\\test_gen\\src\\helpers\\llvm.rs:324:23<br>\nnote: run with <code>RUST_BACKTRACE=1</code> environment variable to display a backtrace</p>\n<p>---- gen_num::to_f32_from_f64 stdout ----<br>\nthread 'gen_num::to_f32_from_f64' panicked at 'Error loading compiled dylib for test: LoadLibraryExW { source: Os { code: 193, kind: Uncategorized, message: \"%1 is not a valid Win32 application.\" } }', crates\\compiler\\test_gen\\src\\helpers\\llvm.rs:324:23</p>\n<p>---- gen_num::to_f32_from_f32 stdout ----<br>\nthread 'gen_num::to_f32_from_f32' panicked at 'Error loading compiled dylib for test: LoadLibraryExW { source: Os { code: 193, kind: Uncategorized, message: \"%1 is not a valid Win32 application.\" } }', crates\\compiler\\test_gen\\src\\helpers\\llvm.rs:324:23</p>\n<p>---- gen_num::to_f32_from_i16 stdout ----<br>\nthread 'gen_num::to_f32_from_i16' panicked at 'Error loading compiled dylib for test: LoadLibraryExW { source: Os { code: 193, kind: Uncategorized, message: \"%1 is not a valid Win32 application.\" } }', crates\\compiler\\test_gen\\src\\helpers\\llvm.rs:324:23</p>\n<p>---- gen_num::to_f32_from_i128 stdout ----<br>\nthread 'gen_num::to_f32_from_i128' panicked at 'Error loading compiled dylib for test: LoadLibraryExW { source: Os { code: 193, kind: Uncategorized, message: \"%1 is not a valid Win32 application.\" } }', crates\\compiler\\test_gen\\src\\helpers\\llvm.rs:324:23</p>",
        "id": 296841836,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662132077
    },
    {
        "content": "<p>Aaand just tried running the test a few more times and those extra 5 no longer error!</p>",
        "id": 296843234,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662132496
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281543\">Folkert de Vries</span> <a href=\"#narrow/stream/316715-contributing/topic/Windows.20development/near/296580939\">said</a>:</p>\n<blockquote>\n<p>if you are able to get a debugger to work on our binaries, that would be amazing</p>\n</blockquote>\n<p>I've just experimented after googling debugging .EXEs <a href=\"https://devblogs.microsoft.com/visualstudio/how-to-debug-and-profile-any-exe-with-visual-studio/\">https://devblogs.microsoft.com/visualstudio/how-to-debug-and-profile-any-exe-with-visual-studio/</a> and ran a simple example through the Visual Studio 2019 debugger by debugging the '/target/debug/roc.exe' with 'repl' argument - since the repl always stack overflows for me after any command. The exception breakpoint stopped at the next statement to execute on 'roc\\crates\\compiler\\constrain\\src\\expr.rs' at 'pub fn constrain_expr(' with this call stack... frankly I'm a bit out of my depth here - but happy to keep plugging away tomorrow onwards in the absence of anyone with more experience - if you have ideas on what I can look for</p>\n<blockquote>\n<p>roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 174    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 362    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 389    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 389    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_field(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_types::subs::Variable field_var, roc_region::all::Loc&lt;enum$&lt;roc_can::expr::Expr&gt;&gt; * loc_expr) Line 1980    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 205    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 389    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_def(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_can::def::Def * def, enum$&lt;roc_can::constraint::Constraint&gt; body_con) Line 2623  Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 1037   Unknown<br>\n    [Inline Frame] roc.exe!roc_constrain::expr::constrain_when_branch_help(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region when_branch, roc_can::expr::WhenBranch * expr_expected, roc_constrain::expr::constrain_expr::closure_env$5) Line 1869    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_expr(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_region::all::Region expr, enum$&lt;roc_can::expr::Expr&gt; * expected, enum$&lt;roc_can::expected::Expected&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;) Line 804    Unknown<br>\n    roc.exe!roc_constrain::expr::constrain_function_def(roc_can::constraint::Constraints * constraints, roc_constrain::expr::Env * env, roc_can::expr::Declarations * declarations, unsigned __int64 index, roc_collections::soa::Index&lt;roc_region::all::Loc&lt;roc_can::expr::FunctionDef&gt;&gt; function_def_index, enum$&lt;roc_can::constraint::Constraint&gt; body_con) Line 1561    Unknown<br>\n    [Inline Frame] roc.exe!roc_constrain::expr::constrain_decls(roc_can::constraint::Constraints * constraints, roc_module::symbol::ModuleId home, roc_can::expr::Declarations * declarations) Line 2065    Unknown<br>\n    roc.exe!roc_constrain::module::constrain_module(roc_can::constraint::Constraints * constraints, alloc::vec::Vec&lt;tuple$&lt;roc_region::all::Loc&lt;roc_module::symbol::Symbol&gt;,roc_region::all::Loc&lt;enum$&lt;roc_types::types::Type&gt;&gt;&gt;,alloc::alloc::Global&gt; symbols_from_requires, roc_can::abilities::IAbilitiesStore&lt;roc_can::abilities::Pending&gt; * abilities_store, roc_can::expr::Declarations * declarations, roc_module::symbol::ModuleId home) Line 18    Unknown<br>\n    roc.exe!roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:canonicalize_and_constrain(bumpalo::Bump * arena, roc_module::symbol::ModuleIds * module_ids, roc_module::symbol::IdentIdsByModule dep_idents, roc_collections::vec_set::VecSet&lt;roc_module::symbol::Symbol&gt; exposed_symbols, std::collections:<span aria-label=\"hash\" class=\"emoji emoji-0023-20e3\" role=\"img\" title=\"hash\">:hash:</span><span aria-label=\"map\" class=\"emoji emoji-1f5fa\" role=\"img\" title=\"map\">:map:</span>:HashMap&lt;roc_module::symbol::Symbol,roc_types::types::Alias,core:<span aria-label=\"hash\" class=\"emoji emoji-0023-20e3\" role=\"img\" title=\"hash\">:hash:</span>:BuildHasherDefault&lt;wyhash::traits::WyHash&gt;&gt; aliases, roc_can::abilities::IAbilitiesStore&lt;roc_can::abilities::Pending&gt; imported_abilities_state, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:ParsedModule parsed, bool skip_constraint_gen) Line 4594 Unknown<br>\n    roc.exe!roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:run_task(enum$&lt;roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:BuildTask&gt; task, bumpalo::Bump * arena, ref$&lt;std::path::Path&gt;) Line 5415   Unknown<br>\n    roc.exe!roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:worker_task_step(bumpalo::Bump * worker_arena, crossbeam_deque::deque::Worker&lt;enum$&lt;roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:BuildTask&gt;&gt; * worker, crossbeam_deque::deque::Injector&lt;enum$&lt;roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:BuildTask&gt;&gt; * injector, slice$&lt;crossbeam_deque::deque::Stealer&lt;enum$&lt;roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:BuildTask&gt;&gt;&gt; worker_msg_rx, crossbeam_channel::channel::Receiver&lt;roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:WorkerMsg&gt; * msg_tx, crossbeam_channel::channel::Sender&lt;enum$&lt;roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:Msg&gt;&gt; *) Line 1881   Unknown<br>\n    roc.exe!roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:load_single_threaded(bumpalo::Bump * arena, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:LoadStart load_start, roc_can::module::ExposedByModule exposed_types, roc_target::TargetInfo cached_subs, std::collections:<span aria-label=\"hash\" class=\"emoji emoji-0023-20e3\" role=\"img\" title=\"hash\">:hash:</span><span aria-label=\"map\" class=\"emoji emoji-1f5fa\" role=\"img\" title=\"map\">:map:</span>:HashMap&lt;roc_module::symbol::ModuleId,tuple$&lt;roc_types::subs::Subs,alloc::vec::Vec&lt;tuple$&lt;roc_module::symbol::Symbol,roc_types::subs::Variable&gt;,alloc::alloc::Global&gt;&gt;,core:<span aria-label=\"hash\" class=\"emoji emoji-0023-20e3\" role=\"img\" title=\"hash\">:hash:</span>:BuildHasherDefault&lt;wyhash::traits::WyHash&gt;&gt; render, roc_reporting::report::RenderTarget exec_mode, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:ExecutionMode) Line 1542 Unknown<br>\n    roc.exe!roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:load(bumpalo::Bump * arena, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:LoadStart load_start, roc_can::module::ExposedByModule exposed_types, std::collections:<span aria-label=\"hash\" class=\"emoji emoji-0023-20e3\" role=\"img\" title=\"hash\">:hash:</span><span aria-label=\"map\" class=\"emoji emoji-1f5fa\" role=\"img\" title=\"map\">:map:</span>:HashMap&lt;roc_module::symbol::ModuleId,tuple$&lt;roc_types::subs::Subs,alloc::vec::Vec&lt;tuple$&lt;roc_module::symbol::Symbol,roc_types::subs::Variable&gt;,alloc::alloc::Global&gt;&gt;,core:<span aria-label=\"hash\" class=\"emoji emoji-0023-20e3\" role=\"img\" title=\"hash\">:hash:</span>:BuildHasherDefault&lt;wyhash::traits::WyHash&gt;&gt; cached_subs, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:LoadConfig load_config) Line 1459  Unknown<br>\n    roc.exe!roc_load::load(bumpalo::Bump * arena, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:LoadStart load_start, roc_can::module::ExposedByModule exposed_types, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:LoadConfig load_config) Line 32   Unknown<br>\n    roc.exe!roc_load::load_and_monomorphize_from_str(bumpalo::Bump * arena, std::path::PathBuf filename, str src_dir, std::path::PathBuf exposed_types, roc_can::module::ExposedByModule load_config, roc_load_internal:<span aria-label=\"file\" class=\"emoji emoji-1f4c4\" role=\"img\" title=\"file\">:file:</span>:LoadConfig) Line 93  Unknown<br>\n    roc.exe!roc_repl_eval::gen::compile_to_mono(bumpalo::Bump * arena, str palette, roc_target::TargetInfo) Line 57 Unknown<br>\n    roc.exe!roc_repl_cli::gen_and_eval_llvm(str target, target_lexicon::triple::Triple opt_level, roc_mono::ir::OptLevel) Line 305  Unknown<br>\n    roc.exe!roc_repl_cli::eval_and_format(str) Line 367 Unknown<br>\n    roc.exe!roc_repl_cli::main() Line 433   Unknown<br>\n    roc.exe!roc::main() Line 176    Unknown<br>\n    roc.exe!core::ops::function::FnOnce::call_once&lt;enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt; (<em>)(),tuple$&lt;&gt;&gt;(enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt;(</em>)()) Line 227   Unknown<br>\n    roc.exe!std::sys_common::backtrace::__rust_begin_short_backtrace&lt;enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt; (<em>)(),enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt;&gt;(enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt;(</em>)() f) Line 122  Unknown<br>\n    roc.exe!std::rt::lang_start::closure$0&lt;enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt;&gt;(std::rt::lang_start::closure_env$0&lt;enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt;&gt; *) Line 145 Unknown<br>\n    [Inline Frame] roc.exe!core::ops::function::impls::impl$2::call_once() Line 259 Unknown<br>\n    [Inline Frame] roc.exe!std::panicking::try::do_call() Line 492  Unknown<br>\n    [Inline Frame] roc.exe!std::panicking::try() Line 456   Unknown<br>\n    [Inline Frame] roc.exe!std::panic::catch_unwind() Line 137  Unknown<br>\n    [Inline Frame] roc.exe!std::rt::lang_start_internal::closure$2() Line 128   Unknown<br>\n    [Inline Frame] roc.exe!std::panicking::try::do_call() Line 492  Unknown<br>\n    [Inline Frame] roc.exe!std::panicking::try() Line 456   Unknown<br>\n    [Inline Frame] roc.exe!std::panic::catch_unwind() Line 137  Unknown<br>\n    roc.exe!std::rt::lang_start_internal() Line 128 Unknown<br>\n    roc.exe!std::rt::lang_start&lt;enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt;&gt;(enum$&lt;core::result::Result&lt;tuple$&lt;&gt;,std::io::error::Error&gt;, 1, 18446744073709551615, Err&gt;(*)() main, __int64 argc, unsigned char * * argv) Line 144  Unknown<br>\n    [External Code]</p>\n</blockquote>",
        "id": 296859592,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662137856
    },
    {
        "content": "<p>based on that output it might actually be a stack overflow</p>",
        "id": 296863284,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662139183
    },
    {
        "content": "<p>meaning we'd need to increase how much stack space is allowed</p>",
        "id": 296863313,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662139194
    },
    {
        "content": "<p>for those number errors, I kind of need a full backtrace</p>",
        "id": 296863428,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662139224
    },
    {
        "content": "<p>so <code>$env:RUST_BACKTRACE=1</code> or something and then run just one of the failing tests again</p>",
        "id": 296863484,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662139248
    },
    {
        "content": "<p>another one, Could someone on windows try <a href=\"https://github.com/roc-lang/roc/pull/3950\">https://github.com/roc-lang/roc/pull/3950</a> with cargo test-gen-llvm gen_dict and report any errors</p>",
        "id": 296868363,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662141001
    },
    {
        "content": "<p>running it now...</p>",
        "id": 296871105,
        "sender_full_name": "Anton",
        "timestamp": 1662141962
    },
    {
        "content": "<p><a href=\"/user_uploads/22008/nawE10Tg9ykFpufJC-0MTyYb/test_gen_llvm_logs.txt\">test_gen_llvm_logs.txt</a></p>",
        "id": 296871700,
        "sender_full_name": "Anton",
        "timestamp": 1662142191
    },
    {
        "content": "<p>maybe try just one of them?</p>",
        "id": 296872174,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662142362
    },
    {
        "content": "<p>there is a lot of noise</p>",
        "id": 296872184,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662142366
    },
    {
        "content": "<p><code>gen_dict::insert_all_prefer_first</code> maybe</p>",
        "id": 296872205,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662142380
    },
    {
        "content": "<p>and we made some improvements to installing the dependencies on windows. <a href=\"https://github.com/roc-lang/roc/pull/3953\">https://github.com/roc-lang/roc/pull/3953</a> please leave a review comment if you have further suggestions</p>",
        "id": 296876101,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662143892
    },
    {
        "content": "<p>I replied with my test results in pull/3948 &amp; pull/3950</p>",
        "id": 296950719,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662189496
    },
    {
        "content": "<p>thanks! I made some changes to 3948, can you try it again?</p>",
        "id": 296973718,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662201774
    },
    {
        "content": "<p>yup the 3948 tests all pass for me now!<br>\ncargo test-gen-llvm gen_num::to_<br>\ntest result: ok. 166 passed; 0 failed; 0 ignored; 0 measured; 944 filtered out; finished in 137.87s</p>",
        "id": 297007328,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662219211
    },
    {
        "content": "<p>another set of fixes <a href=\"https://github.com/roc-lang/roc/pull/3965\">https://github.com/roc-lang/roc/pull/3965</a></p>\n<p>based on the llvm IR gen, <code>cargo test-gen-llvm gen_num</code> should now be able to run all tests. please report any that fail</p>",
        "id": 297122081,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662311183
    },
    {
        "content": "<p>Almost! but fails for me on looks like just the last 2 asserts of these 2 tests with exactly the same error like this but different test name...<br>\nnum_to_str_f32<br>\nnum_to_str_f64</p>\n<p>Caused by:<br>\n  process didn't exit successfully: <code>H:\\Development\\roc\\target\\debug\\deps\\test_gen-981323e19142b58c.exe gen_num::num_to_str_f64 --exact --nocapture</code> (exit code: 0xc0000374, STATUS_HEAP_CORRUPTION)</p>\n<ul>\n<li>The terminal process \"C:\\Users\\neil.IBC\\.cargo\\bin\\cargo.exe 'test', '--package', 'test_gen', '--test', 'test_gen', '--features', 'gen-llvm', '--', 'gen_num::num_to_str_f64', '--exact', '--nocapture'\" terminated with exit code: 3221226356.</li>\n</ul>\n<p>Also - I asume it's expected for most tests to say 'warning: ignoring debug info with an invalid version (0) in app'?</p>",
        "id": 297205780,
        "sender_full_name": "Swiftaff",
        "timestamp": 1662375580
    },
    {
        "content": "<p>ok, those test failures make sense</p>",
        "id": 297206410,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662375813
    },
    {
        "content": "<p>for some reason that we don't yet understand, whenever we return a pointer from roc to rust, that segfaults on windows</p>",
        "id": 297206457,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662375834
    },
    {
        "content": "<p>and re the \"warning: ignoring ...\" that is something thatLLVM prints and I don't know why. Kind of hoping it goes away with zig 0.10</p>",
        "id": 297206531,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662375860
    },
    {
        "content": "<p>Richard and I got the llvm gen tests to work <a href=\"https://github.com/roc-lang/roc/pull/4003\">https://github.com/roc-lang/roc/pull/4003</a> by just ignoring 3 tests (they all use roc_panic, so something is up there)</p>",
        "id": 298055319,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662758567
    },
    {
        "content": "<p>and by leaking memory allocated in a DLL (not 100% sure what's going on there, but this at least makes the tests run)</p>",
        "id": 298055367,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662758586
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span>  that means that the windows CI can not only build, but also run some tests (gen for llvm and wasm, and also parse and format tests already work)</p>",
        "id": 298055478,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1662758635
    },
    {
        "content": "<p>For the tests that should panic and fail, I bet it's a problem with the setjmp/longjmp stuff. We had to patch that when making it work for M1 a few months ago as well.</p>",
        "id": 298058237,
        "sender_full_name": "Ayaz Hafiz",
        "timestamp": 1662760015
    },
    {
        "content": "<p>lots of the panics do work though... <span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span></p>",
        "id": 298067947,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1662766067
    },
    {
        "content": "<p>er, lots of the tests with panics</p>",
        "id": 298067953,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1662766072
    },
    {
        "content": "<p>Awesome, I hope to tackle the lld-link build issue on the windows CI machine today, after that I'll add testing.</p>",
        "id": 298093697,
        "sender_full_name": "Anton",
        "timestamp": 1662793913
    },
    {
        "content": "<p>if someone on windows wants to run this <a href=\"/user_uploads/22008/dugLlWisr24VPcJsplFG6MxN/app.exe\">app.exe</a> and see what happens, that might be helpful. I expect it to crash, but hopefully it tells more than wine does</p>",
        "id": 299470431,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663530356
    },
    {
        "content": "<p>it's the current state of the surgical linker on windows with a trivial (non-roc) app and host.</p>",
        "id": 299470503,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663530409
    },
    {
        "content": "<p>it's close to working, but not quite there yet and now we're in the tedious debugging  phase</p>",
        "id": 299470515,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663530428
    },
    {
        "content": "<div class=\"codehilite\"><pre><span></span><code>PS C:\\Users\\Brian\\Downloads&gt; .\\app.exe\nProgram &#39;app.exe&#39; failed to run: The specified executable is not a valid application for this OS platform.At line:1\nchar:1\n+ .\\app.exe\n+ ~~~~~~~~~.\nAt line:1 char:1\n+ .\\app.exe\n+ ~~~~~~~~~\n    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException\n    + FullyQualifiedErrorId : NativeCommandFailed\n</code></pre></div>",
        "id": 299471832,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663531531
    },
    {
        "content": "<p>If I run it in a <code>cmd</code> shell rather than Powershell, I get a popup window saying \"This app can't run on your PC. To find a version for your PC, check with the software publisher\"</p>",
        "id": 299472012,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663531692
    },
    {
        "content": "<p>well...</p>",
        "id": 299472198,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663531872
    },
    {
        "content": "<p>x86_64 machine running Windows 11 Home, version 21H2, build 22000.856</p>",
        "id": 299472199,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663531873
    },
    {
        "content": "<p>thanks for trying, but the error message quality here is not great ...</p>",
        "id": 299472229,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663531916
    },
    {
        "content": "<p>Yep</p>",
        "id": 299472286,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663531938
    },
    {
        "content": "<p>must mean something is malformed in practice. the .exe is syntactically valid, but semantically something must be fundamentally wrong</p>",
        "id": 299472308,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663531973
    },
    {
        "content": "<p>yeah</p>",
        "id": 299472334,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663531995
    },
    {
        "content": "<p>ok, seems like I can make some progress by using a host.exe that we did not touch (i.e. we didn't reserve any sections in it)</p>",
        "id": 299472855,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663532462
    },
    {
        "content": "<p>I then remove the references to the dylib, and get</p>\n<div class=\"codehilite\"><pre><span></span><code>wine: Unhandled page fault on execute access to 0000000100003A20 at address 0000000100003A20 (thread 002b), starting debugger...\nUnhandled exception: page fault on execute access to 0x100003a20 in 64-bit code (0x0000000100003a20).\nRegister dump:\n rip:0000000100003a20 rsp:000000000112f9f8 rbp:000000000112fa20 eflags:00010246 (  R- --  I  Z- -P- )\n rax:0000000000000001 rbx:0000000000000001 rcx:000000000000002a rdx:00000000011313f0\n rsi:00000000012d0810 rdi:0000000000000067  r8:00000000012d0810  r9:0000000000000020 r10:0000000000000003\n r11:0000000000000246 r12:0000000000000000 r13:0000000000000000 r14:00000000011313f0 r15:0000000000000001\n</code></pre></div>\n<p>which I'm pretty sure is because the function that the app is supposed to expose to the host is not hooked up correctly</p>",
        "id": 299472890,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663532517
    },
    {
        "content": "<p>so it's trying to execute stuff on a page that is not executable</p>",
        "id": 299472948,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663532541
    },
    {
        "content": "<p>does <a href=\"/user_uploads/22008/bII1RnQnDevFOoyOtCqb_MMD/hostapp.exe\">hostapp.exe</a> do anything more interesting? based on the debugger it gets past the calls to our dynamic functions, but then runs into a page that is not marked as executable ?!</p>",
        "id": 299474856,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663534354
    },
    {
        "content": "<p>No output at all but it returns an error code, which apparently you can retrieve by printing an env variable</p>\n<div class=\"codehilite\"><pre><span></span><code>C:\\Users\\Brian\\Downloads&gt;.\\hostapp.exe\n\nC:\\Users\\Brian\\Downloads&gt;echo %ERRORLEVEL%\n-1073741819\n</code></pre></div>",
        "id": 299475432,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663534859
    },
    {
        "content": "<p>it is supposed to return a non-standard error code</p>",
        "id": 299475538,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663534933
    },
    {
        "content": "<p>so I think that's good?</p>",
        "id": 299475547,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663534949
    },
    {
        "content": "<p>it should return <code>192u8</code> though</p>",
        "id": 299475609,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663535042
    },
    {
        "content": "<p>yeah that number is way too big I think</p>",
        "id": 299475651,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663535066
    },
    {
        "content": "<p>not sure what the problem could be at this point though</p>",
        "id": 299475708,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663535122
    },
    {
        "content": "<p>I guess this is where a debugger would be helpful?</p>",
        "id": 299476222,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663535662
    },
    {
        "content": "<p>Yeah this runs in Visual Studio debugger, whereas app.exe didn't.</p>\n<div class=\"codehilite\"><pre><span></span><code>Exception thrown at 0x00007FF600001AA6 in hostapp.exe: 0xC0000005: Access violation executing location 0x00007FF600001AA6.\n</code></pre></div>\n<p>Call stack:</p>\n<div class=\"codehilite\"><pre><span></span><code>    Name    Language\n    00007ff600001aa6()  Unknown\n    hostapp.exe!00007ff61c7b1062()  Unknown\n    hostapp.exe!00007ff61c7b146a()  Unknown\n    hostapp.exe!00007ff61c7b14c6()  Unknown\n    kernel32.dll!00007fff41e654e0() Unknown\n    ntdll.dll!00007fff42e0485b()    Unknown\n</code></pre></div>",
        "id": 299476654,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663536033
    },
    {
        "content": "<p>So I guess there are no debug symbols in the file?</p>",
        "id": 299476669,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663536052
    },
    {
        "content": "<p>right, I can add them add them though</p>",
        "id": 299476747,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663536136
    },
    {
        "content": "<p>I can see the disassembly, and look at those locations in the call stack.<br>\nthe one where it throws only shows ??? for the disassembly but the other two in hostapp.exe look like normal x64 assembly code</p>",
        "id": 299476818,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663536219
    },
    {
        "content": "<p>so I guess it jumped somewhere invalid</p>",
        "id": 299476824,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663536230
    },
    {
        "content": "<p><a href=\"/user_uploads/22008/mxCjS9MnSLvzqjZ-YqO3r69b/hostapp.exe\">hostapp.exe</a> </p>\n<p>for me it now  shows</p>\n<div class=\"codehilite\"><pre><span></span><code>Segmentation fault at address 0x10005c3e6\n???:?:?: 0x10005c3e6 in ??? (???)\n/home/folkertdev/Downloads/zig-linux-x86_64-0.9.1/lib/std/start.zig:558:29: 0x1400039ee in std.start.callMain (host.obj)\nthread 43 panic: reached unreachable code\n/home/folkertdev/Downloads/zig-linux-x86_64-0.9.1/lib/std/os/windows.zig:114:33: 0x14003face in std.os.windows.OpenFile (host.obj)\nPanicked during a panic. Aborting.\nwine: Unhandled exception 0x80000003 in thread 2b at address 000000014000217A (thread 002b), starting debugger...\n0x000000014000217a std.os.abort+0xa in hostapp: int $3\n</code></pre></div>",
        "id": 299476929,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663536317
    },
    {
        "content": "<p>In visual studio I get the same as before. Call stack is still hex addresses, not proper names.</p>",
        "id": 299477254,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663536645
    },
    {
        "content": "<p>but call stack is now deeper</p>",
        "id": 299477261,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663536654
    },
    {
        "content": "<p>6 hostapp frames instead of 3</p>",
        "id": 299477284,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1663536681
    },
    {
        "content": "<p>but, the problem to me seems to be outside of main</p>",
        "id": 299477299,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663536712
    },
    {
        "content": "<p>these are the two calls to the linked-in functions</p>\n<div class=\"codehilite\"><pre><span></span><code>   140001ddc:   e8 87 f1 05 00          call   0x140060f68\n   140001de1:   88 45 fd                mov    BYTE PTR [rbp-0x3],al\n   140001de4:   31 c9                   xor    ecx,ecx\n   140001de6:   e8 75 f1 05 00          call   0x140060f60\n   140001deb:   88 c1                   mov    cl,al\n   140001ded:   8a 45 fd                mov    al,BYTE PTR [rbp-0x3]\n   140001df0:   00 c8                   add    al,cl\n</code></pre></div>",
        "id": 299477406,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663536837
    },
    {
        "content": "<p>hmm, <code>0x10005c3e6</code> is outside of the actual text section</p>",
        "id": 299477663,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663537050
    },
    {
        "content": "<p>or is it?  I mean the address in <code>Segmentation fault at address 0x10005c3e6</code></p>\n<div class=\"codehilite\"><pre><span></span><code>SECTION HEADER #1\n               .text name\n               5bfda virtual size\n                1000 virtual address\n               5c000 size of raw data\n                 400 file pointer to raw data\n                   0 file pointer to relocation table\n                   0 file pointer to line numbers\n                   0 number of relocations\n                   0 number of line numbers\n            60000020 flags\n                       CNT_CODE\n                       MEM_EXECUTE\n                       MEM_READ\n</code></pre></div>",
        "id": 299477764,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663537145
    },
    {
        "content": "<p>hmm that does not even make sense, because the whole app is loaded at <code>0x140000000</code></p>",
        "id": 299477875,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663537250
    },
    {
        "content": "<p>ah, progress. There is a problem with calling the functions that originally came from the dynamic lib. When I add a branch (switching on a random number to fool the optimizer) and the functions are not called, the program runs correctly</p>",
        "id": 299478594,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663537934
    },
    {
        "content": "<p>so it must be that I don't actually understand (fully) how to fix the calls</p>",
        "id": 299478610,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663537967
    },
    {
        "content": "<p>I got this to work</p>\n<div class=\"codehilite\"><pre><span></span><code>&gt; wine64 hostapp.exe\nHello, 42!\n</code></pre></div>\n\n<p>it links these zig objects</p>\n<div class=\"codehilite\" data-code-language=\"Zig\"><pre><span></span><code><span class=\"c1\">// host</span>\n<span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">@import</span><span class=\"p\">(</span><span class=\"s\">\"std\"</span><span class=\"p\">);</span><span class=\"w\"></span>\n\n<span class=\"kr\">extern</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"n\">double</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"n\">callconv</span><span class=\"p\">(.</span><span class=\"n\">C</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"p\">;</span><span class=\"w\"></span>\n\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"n\">io</span><span class=\"p\">.</span><span class=\"n\">getStdOut</span><span class=\"p\">().</span><span class=\"n\">writer</span><span class=\"p\">();</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">try</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"p\">.</span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"Hello, {}!</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">.{</span><span class=\"n\">double</span><span class=\"p\">()});</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Zig\"><pre><span></span><code><span class=\"c1\">// app</span>\n<span class=\"kr\">export</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"n\">double</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"></span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">42</span><span class=\"p\">;</span><span class=\"w\"></span>\n<span class=\"p\">}</span><span class=\"w\"></span>\n</code></pre></div>\n<p>with the surgical linking approach and IT WORKS!</p>",
        "id": 299518779,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663574471
    },
    {
        "content": "<p>(the only cheaty bit is that I copied the app assembly manually, but that is acceptable for now I think)</p>",
        "id": 299520124,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663575055
    },
    {
        "content": "<p>code <a href=\"https://github.com/roc-lang/roc/pull/4065\">https://github.com/roc-lang/roc/pull/4065</a></p>",
        "id": 299525534,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1663577608
    },
    {
        "content": "<p>wooooooooo!!!!!!</p>",
        "id": 299570506,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1663596082
    },
    {
        "content": "<p>I'm hitting </p>\n<div class=\"codehilite\"><pre><span></span><code>warning: `roc_linker` (lib) generated 2 warnings\n    Finished dev [unoptimized + debuginfo] target(s) in 1.65s\n     Running `target\\debug\\roc.exe .\\examples\\platform-switching\\rocLovesZig.roc`\n🔨 Rebuilding platform...\nwarning: ignoring debug info with an invalid version (0) in app\nthread &#39;&lt;unnamed&gt;&#39; panicked at &#39;Failed to rebuild host.zig - stderr of the `zig` command was:\nerror(compilation): clang failed with stderr: zig: error: unable to make temporary file: No such file or directory\n\nerror(compilation): clang failed with stderr: zig: error: unable to make temporary file: No such file or directory\n\nerror(compilation): clang failed with stderr: zig: error: unable to make temporary file: No such file or directory\n...\nerror(compilation): C:\\Users\\folkert\\Downloads\\zig-windows-x86_64-0.9.1\\lib\\libc\\mingw\\math\\x86\\remquo.S:1:1: unable to build C object: clang exit\ned with code 1\nerror(compilation): C:\\Users\\folkert\\Downloads\\zig-windows-x86_64-0.9.1\\lib\\libc\\mingw\\math\\x86\\truncf.S:1:1: unable to build C object: clang exit\ned with code 1\n</code></pre></div>\n<p>on windows. It feels familiar, but I don't remember how to fix it</p>",
        "id": 301742734,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1664576185
    },
    {
        "content": "<p>Something with the zig cache folder?</p>",
        "id": 301746105,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1664577930
    },
    {
        "content": "<p>Could someone on windows run on the <code>refine-relocation-location</code> branch</p>\n<div class=\"codehilite\"><pre><span></span><code>cargo run -- --linker=surgical crates/cli_testing_examples/platform-switching/rocLovesZig.roc\n</code></pre></div>\n\n<p>I _think_ this should work. On my machine using this <code>cargo run</code> fails, but manually running the produced executable succeeds.</p>\n<p>I get a mingw error here </p>\n<p><a href=\"https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-crt/crt/pseudo-reloc.c#L195\">https://github.com/Alexpux/mingw-w64/blob/master/mingw-w64-crt/crt/pseudo-reloc.c#L195</a></p>\n<p>this is very odd, maybe something is wrong with the <code>memexec</code> crate but <span class=\"user-mention\" data-user-id=\"431893\">@Brian Carroll</span>  and I verified on one point that it worked on his machine.</p>",
        "id": 304805981,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666115442
    },
    {
        "content": "<p>it does actually work when you explicitly pass <code>--linker=legacy</code>, so I guess there is still a bug in the surgical linker somewhere that neither wine nor a windows shell catches, but mingw does</p>",
        "id": 304806707,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666115672
    },
    {
        "content": "<p>I will run it on my machine later, but need to go out for a couple of hours now.</p>",
        "id": 304809644,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666116673
    },
    {
        "content": "<p>I get this error when I run it. <a href=\"https://gist.github.com/lukewilliamboswell/73b63b05c2d9c4387ff79f10d1440000\">error.log</a></p>",
        "id": 304827795,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1666122033
    },
    {
        "content": "<p>hmm, yes, can you try commenting this <code>-fPIE</code> line?</p>\n<div class=\"codehilite\"><pre><span></span><code>    if let Some(shared_lib_path) = shared_lib_path {\n        command.args(&amp;[\n            &quot;build-exe&quot;,\n            // &quot;-fPIE&quot;, PIE seems to fail on windows\n</code></pre></div>\n<p>in <code>crates/compiler/build/src/link.rs</code></p>",
        "id": 304841581,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666127477
    },
    {
        "content": "<p>I'm pretty sure <code>PIE</code> is just not a thing on windows, the C compiler just won't do it</p>",
        "id": 304841636,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666127502
    },
    {
        "content": "<p>Even without PIE, I still get</p>\n<div class=\"codehilite\"><pre><span></span><code>&#39;called `Result::unwrap()` on an `Err` value: Any { .. }&#39;, crates\\cli\\src\\build.rs:307:46\n</code></pre></div>",
        "id": 304843563,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666128428
    },
    {
        "content": "<p>As well as the <code>-fPIE</code> I also tried getting rid of <code>-pie</code>, which could be unrelated and just sound similar! But same panic.</p>",
        "id": 304843648,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666128477
    },
    {
        "content": "<p>Yeah from Googling around it seems that Windows achieves position independence by doing relocations when the executable is loaded.</p>",
        "id": 304844597,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666128849
    },
    {
        "content": "<p>FYI <code>cargo build --release --locked</code> works now and gives me a working <code>roc</code>.</p>",
        "id": 304844745,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1666128936
    },
    {
        "content": "<p>I'm not sure if that is revelant information, but trying to use <code>roc run</code> on <code>helloWorld.roc</code> gives me this <a href=\"https://gist.github.com/lukewilliamboswell/054cf640b5d28fcf8e9b4ea3ec41eb9c\">error.log gist</a></p>",
        "id": 304845192,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1666129146
    },
    {
        "content": "<p><code>roc repl</code> seems to be working ok.<br>\n<a href=\"/user_uploads/22008/B-2bn96TZUPapOfOHWgpYG4J/Screenshot-2022-10-19-084846.jpg\">Screenshot-2022-10-19-084846.jpg</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/B-2bn96TZUPapOfOHWgpYG4J/Screenshot-2022-10-19-084846.jpg\" title=\"Screenshot-2022-10-19-084846.jpg\"><img src=\"/user_uploads/22008/B-2bn96TZUPapOfOHWgpYG4J/Screenshot-2022-10-19-084846.jpg\"></a></div>",
        "id": 304846569,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1666129753
    },
    {
        "content": "<p>only zig platforms would work right now</p>",
        "id": 304849429,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666131027
    },
    {
        "content": "<p>for rust I think we'd need some compiler infra (cause some C is involved there), but also the cli platform is not currently written to be usable on windows, so that would need some work I'd guess (don't know how platform-specific it really is)</p>",
        "id": 304849506,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666131077
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"431893\">@Brian Carroll</span> does it now show more than that? that panic is when the host rebuild thread failed, that is a weird error in this case</p>",
        "id": 304849640,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666131141
    },
    {
        "content": "<p>and the problem I was having indeed seems like something with program loading that mingw does not do in my case. I suspect something in the binary is not quite right for that to work. But it does work in wine/powershell so most of the structure of the binary is correct</p>",
        "id": 304849816,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666131234
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281543\">Folkert de Vries</span> <a href=\"#narrow/stream/316715-contributing/topic/Windows.20development/near/304849640\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"431893\">Brian Carroll</span> does it now show more than that? that panic is when the host rebuild thread failed, that is a weird error in this case</p>\n</blockquote>\n<p>Yeah tons more. I skipped as I thought it was the same as others had posted but apparently it's not. The first few lines mention a directory that doesn't exist, that Zig seems to be trying to write a temporary file into. But I don't know where that would be. Maybe the zig cache?<br>\n<a href=\"/user_uploads/22008/K5WnOjZqfMy9XoMPwYyMQCAM/errors.tmp\">errors.tmp</a></p>",
        "id": 304888895,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666161737
    },
    {
        "content": "<p>No, if I delete <code>crates\\cli_testing_examples\\platform-switching\\zig-platform\\zig-cache</code> and rerun the <code>cargo run</code> command, it is recreated with stuff inside it.</p>",
        "id": 304890811,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666162778
    },
    {
        "content": "<p>yes this is because of that <code>-fPIE</code> flag</p>",
        "id": 304918862,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666174334
    },
    {
        "content": "<p>or it should be... it is for me</p>",
        "id": 304918923,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666174365
    },
    {
        "content": "<p>Hmmm... I'm on your branch, which has that commented out already, but I still get the error.<br>\nHere is the output of <code>dbg!(&amp;command)</code>. You can see there is no <code>-fPIE</code>.</p>\n<div class=\"codehilite\"><pre><span></span><code>[crates\\compiler\\build\\src\\link.rs:236] &amp;command = &quot;zig&quot; &quot;build-exe&quot; &quot;crates\\\\cli_testing_examples\\\\platform-switching\\\\zig-platform\\\\libapp.obj&quot; &quot;C:\\\\Users\\\\Brian\\\\Documents\\\\GitHub\\\\roc\\\\target\\\\debug\\\\lib\\\\builtins-windows-x86_64.obj&quot; &quot;crates\\\\cli_testing_examples\\\\platform-switching\\\\zig-platform\\\\host.zig&quot; &quot;-femit-bin=crates\\\\cli_testing_examples\\\\platform-switching\\\\zig-platform\\\\dynhost.exe&quot; &quot;--pkg-begin&quot; &quot;str&quot; &quot;C:\\\\Users\\\\Brian\\\\Documents\\\\GitHub\\\\roc\\\\target\\\\debug\\\\lib\\\\str.zig&quot; &quot;--pkg-end&quot; &quot;--library&quot; &quot;c&quot; &quot;-dynamic&quot; &quot;-target&quot; &quot;x86_64-windows-gnu&quot;\n</code></pre></div>",
        "id": 304941718,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666182588
    },
    {
        "content": "<p>hmm, that is very strange</p>",
        "id": 304946023,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666183132
    },
    {
        "content": "<p>and I guess using <code>roc build</code> instead produces the same thing?</p>",
        "id": 304946124,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666183162
    },
    {
        "content": "<p>yes</p>",
        "id": 304946676,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666183333
    },
    {
        "content": "<p>so what if you just run the zig command, that still fails?</p>",
        "id": 304947482,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666183600
    },
    {
        "content": "<p>in your own shell I mean</p>",
        "id": 304947513,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666183611
    },
    {
        "content": "<p>That works yeah! I had to put quotes around the path to <code>dynhost.exe</code> but when I did, no crash output</p>\n<div class=\"codehilite\"><pre><span></span><code>zig build-exe crates\\cli_testing_examples\\platform-switching\\zig-platform\\libapp.obj C:\\Users\\Brian\\Documents\\GitHub\\roc\\target\\debug\\lib\\builtins-windows-x86_64.obj crates\\cli_testing_examples\\platform-switching\\zig-platform\\host.zig -femit-bin=&quot;crates\\cli_testing_examples\\platform-switching\\zig-platform\\dynhost.exe&quot; --pkg-begin str C:\\Users\\Brian\\Documents\\GitHub\\roc\\target\\debug\\lib\\str.zig --pkg-end --library c -dynamic -target x86_64-windows-gnu\n</code></pre></div>",
        "id": 305007540,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666201123
    },
    {
        "content": "<p>so, the way we build up the <code>Command</code> is the problem here? can you play around with that a bit maybe?</p>",
        "id": 305008108,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666201314
    },
    {
        "content": "<p>Ok. I can have a look tomorrow morning</p>",
        "id": 305039613,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666212438
    },
    {
        "content": "<p>I don't think it's about how we build the command. I got it to work once and now it works every time. It's like some file or directory was created and now that it's there, everything is fine. But I don't know where! I have tried deleting libapp.obj and dynhost.exe but it still works fine.</p>",
        "id": 305084449,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666245781
    },
    {
        "content": "<p>The original error mentioned something about Zig trying to write a temporary file somewhere so I also deleted the zig-cache but that didn't reproduce the error either</p>",
        "id": 305084468,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666245795
    },
    {
        "content": "<p>OK if I delete Zig's global cache dir and retry the <code>cargo run</code> command, it crashes.</p>",
        "id": 305084849,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666245974
    },
    {
        "content": "<p>I found and deleted it like this:</p>\n<div class=\"codehilite\"><pre><span></span><code>PS C:\\Users\\Brian&gt; zig env\n{\n &quot;zig_exe&quot;: &quot;C:\\\\Users\\\\Brian\\\\zig-windows-x86_64-0.9.1\\\\zig.exe&quot;,\n &quot;lib_dir&quot;: &quot;C:\\\\Users\\\\Brian\\\\zig-windows-x86_64-0.9.1\\\\lib&quot;,\n &quot;std_dir&quot;: &quot;C:\\\\Users\\\\Brian\\\\zig-windows-x86_64-0.9.1\\\\lib\\\\std&quot;,\n &quot;global_cache_dir&quot;: &quot;C:\\\\Users\\\\Brian\\\\AppData\\\\Local\\\\zig&quot;,\n &quot;version&quot;: &quot;0.9.1&quot;\n}\nPS C:\\Users\\Brian&gt; del &quot;C:\\\\Users\\\\Brian\\\\AppData\\\\Local\\\\zig&quot;\n</code></pre></div>",
        "id": 305084969,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666246049
    },
    {
        "content": "<p>ok, that's wild</p>",
        "id": 305090391,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666249272
    },
    {
        "content": "<p>and then adding some quotes to the command somehow fixes that?</p>",
        "id": 305090430,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666249285
    },
    {
        "content": "<p>btw when it works, what does <code>roc run</code> do?</p>",
        "id": 305090475,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666249309
    },
    {
        "content": "<p>No, when I let Rust do the command there is never any issue with quotes. Only when I manually enter the command into PowerShell I need to quote the dynhost.exe path or it gets upset about the <code>.exe</code>.<br>\nSo I think we can forget about the quotes issue.</p>",
        "id": 305113071,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666259129
    },
    {
        "content": "<p>If you delete the zig global cache do you see the same thing?</p>",
        "id": 305113294,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666259222
    },
    {
        "content": "<p>yes, actually</p>",
        "id": 305114886,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666259851
    },
    {
        "content": "<p>so the way to fix that is to run in your own shell literally the thing that the rust program runs, and then it works?!</p>",
        "id": 305114948,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666259873
    },
    {
        "content": "<p>Apparently, yeah! Not the slickest solution <span aria-label=\"joy\" class=\"emoji emoji-1f602\" role=\"img\" title=\"joy\">:joy:</span></p>",
        "id": 305126778,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666263874
    },
    {
        "content": "<p>I wonder if there's some environment variables that are different when Rust runs it</p>",
        "id": 305126851,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1666263908
    },
    {
        "content": "<p>could it be the same mingw thing?</p>",
        "id": 305129807,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666265208
    },
    {
        "content": "<p>hmm, running the zig command by itself does not fix compilation for me. That's unfortunate because now nothing works...</p>",
        "id": 305208190,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666289118
    },
    {
        "content": "<p>in fact, the zig just errors because it can't find certain dlls</p>",
        "id": 305208237,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666289133
    },
    {
        "content": "<p>I think I figured out the cause: the local <code>zig-cache</code> and the global one got out of sync.</p>",
        "id": 305343614,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666355802
    },
    {
        "content": "<p>which you can fix by removing both and then re-building</p>",
        "id": 305343638,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666355809
    },
    {
        "content": "<p>so idk, maybe either one of them got corrupted on your system (maybe using a newer/older zig version?) and then you get that error</p>",
        "id": 305343737,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1666355836
    },
    {
        "content": "<p>does someone know how to get the equivalent of <code>~/.cargo</code> on windows? I tried some stuff with <code>%HOMEPATH%</code> but that does not get expanded</p>",
        "id": 309048640,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1668104142
    },
    {
        "content": "<p>Try <code>%APPDATA%</code>. I think it usually expands to <code>c:\\Users\\Username\\Appdata\\Roaming</code></p>",
        "id": 309049898,
        "sender_full_name": "Brian Carroll",
        "timestamp": 1668104517
    },
    {
        "content": "<p>$home</p>",
        "id": 309127860,
        "sender_full_name": "Salman Shaik",
        "timestamp": 1668141015
    },
    {
        "content": "<p>how do I remove this prefix here</p>\n<div class=\"codehilite\"><pre><span></span><code>use std::path::Path;\n\nfn main() {\n  let path = Path::new(&quot;\\\\\\\\?\\\\C:\\\\Users\\\\folkert\\\\Documents\\\\GitHub\\\\roc\\\\target\\\\debug\\\\roc.exe&quot;);\n\ndbg!(path.starts_with(&quot;\\\\\\\\?\\\\&quot;));\n\n}\n</code></pre></div>\n<p>paths on windows: maddening</p>",
        "id": 309272580,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1668208659
    },
    {
        "content": "<p>that debug print returns false by the way</p>",
        "id": 309272588,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1668208668
    },
    {
        "content": "<p>because the fun thing is, such paths don't actually work in powershell</p>",
        "id": 309272753,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1668208799
    },
    {
        "content": "<p>seems like there is just no good way to do this? <a href=\"https://stackoverflow.com/questions/50322817/how-do-i-remove-the-prefix-from-a-canonical-windows-path\">https://stackoverflow.com/questions/50322817/how-do-i-remove-the-prefix-from-a-canonical-windows-path</a></p>",
        "id": 309273214,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1668209126
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> this breaks any use of the <code>utils::get_lib_path</code> function, because these paths are just unusable when doing a <code>Command</code></p>",
        "id": 309273346,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1668209265
    },
    {
        "content": "<p>I have a super hacky fix here <a href=\"https://github.com/roc-lang/roc/compare/csv-parser-zig\">https://github.com/roc-lang/roc/compare/csv-parser-zig</a></p>",
        "id": 309275077,
        "sender_full_name": "Folkert de Vries",
        "timestamp": 1668210700
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> or anyone... </p>\n<p>Just testing a new build of Windows and have discovered that building with <code>--optimize</code> is now failing with non-zero exit code. Did we make any changes that might be related? </p>\n<p>I'm guessing the llvm-zig upgrade is up there as a candidate. I don't suppose anyone else is using Windows and would have noticed.</p>\n<div class=\"codehilite\"><pre><span></span><code>PS C:\\Users\\bosyl\\Documents\\GitHub\\roc-ray&gt; .\\windows\\bin\\roc.exe build --no-link --output=app.obj .\\examples\\basic-shapes.roc\n0 errors and 0 warnings found in 535 ms while successfully building:\n\n    app.obj\nPS C:\\Users\\bosyl\\Documents\\GitHub\\roc-ray&gt; .\\windows\\bin\\roc.exe build --no-link --optimize --output=app.obj .\\examples\\basic-shapes.roc\n</code></pre></div>",
        "id": 490265997,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1734755696
    },
    {
        "content": "<p>Yeah, I would guess the zig and llvm upgrade</p>",
        "id": 490270778,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1734760817
    }
]
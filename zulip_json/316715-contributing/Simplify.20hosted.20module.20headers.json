[
    {
        "content": "<p>We have simplified the syntax for app modules and interface modules, but we didn't get to the other module types yet. Currently the hosted module header is</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">hosted</span><span class=\"w\"> </span><span class=\"kt\">Host</span>\n<span class=\"w\">    </span><span class=\"nv\">exposes</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nf\">...</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"nv\">imports</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nf\">...</span><span class=\"p\">]</span>\n</code></pre></div>\n<p>In the style of interface modules, we should move to</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">hosted</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nf\">...</span><span class=\"p\">]</span>\n</code></pre></div>\n<p>where the [...] is the \"exposes\" list, and we use import statements like every other module type</p>",
        "id": 492246989,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228420
    },
    {
        "content": "<p>We will have updated every module header except for platform modules, and I'm not sure how to reduce those</p>",
        "id": 492247139,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228538
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">platform</span><span class=\"w\"> </span><span class=\"s\">\"cli\"</span>\n<span class=\"w\">    </span><span class=\"nv\">requires</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nv\">main</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"w\"> </span><span class=\"kt\">Arg</span><span class=\"nf\">.</span><span class=\"kt\">Arg</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"kt\">Exit</span><span class=\"w\"> </span><span class=\"kt\">I32</span><span class=\"w\"> </span><span class=\"kt\">Str</span><span class=\"p\">]</span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"nv\">exposes</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nf\">...</span><span class=\"p\">]</span>\n<span class=\"w\">    </span><span class=\"nv\">packages</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"w\">    </span><span class=\"nv\">imports</span><span class=\"w\"> </span><span class=\"p\">[]</span>\n<span class=\"w\">    </span><span class=\"nv\">provides</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nv\">main_for_host</span><span class=\"err\">!</span><span class=\"p\">]</span>\n</code></pre></div>",
        "id": 492247177,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228574
    },
    {
        "content": "<p>This is the current one for <code>basic-cli</code> with the exposes section elided</p>",
        "id": 492247188,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228588
    },
    {
        "content": "<p>We can remove the \"cli\" name, remove \"imports\" in favor of import statements, and combine the two \"requires\" sections, but it seems not reducible after that</p>",
        "id": 492247301,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228701
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">platform</span>\n<span class=\"w\">    </span><span class=\"nv\">requires</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nv\">main</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"w\"> </span><span class=\"kt\">Arg</span><span class=\"nf\">.</span><span class=\"kt\">Arg</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"kt\">Exit</span><span class=\"w\"> </span><span class=\"kt\">I32</span><span class=\"w\"> </span><span class=\"kt\">Str</span><span class=\"p\">]</span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"nv\">exposes</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nf\">...</span><span class=\"p\">]</span>\n<span class=\"w\">    </span><span class=\"nv\">packages</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"w\">    </span><span class=\"nv\">provides</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nv\">main_for_host</span><span class=\"err\">!</span><span class=\"p\">]</span>\n</code></pre></div>",
        "id": 492247332,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228721
    },
    {
        "content": "<p>I think removing the words would just get confusing, but maybe there's something I'm missing</p>",
        "id": 492247349,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228749
    },
    {
        "content": "<p>The one other option I can consider for that one is to put everything in a single record for visual consistency with all other module types only having one or two sets of fields:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">platform</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nv\">requires</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nv\">main</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"kt\">List</span><span class=\"w\"> </span><span class=\"kt\">Arg</span><span class=\"nf\">.</span><span class=\"kt\">Arg</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"kt\">Result</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"kt\">Exit</span><span class=\"w\"> </span><span class=\"kt\">I32</span><span class=\"w\"> </span><span class=\"kt\">Str</span><span class=\"p\">]</span><span class=\"nv\">_</span><span class=\"w\"> </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"nv\">exposes</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nf\">...</span><span class=\"p\">],</span>\n<span class=\"w\">    </span><span class=\"nv\">packages</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"p\">{},</span>\n<span class=\"w\">    </span><span class=\"nv\">provides</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nv\">main_for_host</span><span class=\"err\">!</span><span class=\"p\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 492247440,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228841
    },
    {
        "content": "<p>Thoughts?</p>",
        "id": 492247459,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736228863
    },
    {
        "content": "<p>When you are changing this both headers, could you consider the problem, that it is not possible to import the <code>requires</code> symbols in any other module of the platform. Especially not in the hosted module. One consequence is, that it is impossible to have effects that have a <code>Model</code>as argument or return type.</p>\n<p>For example, it is impossible for an platform to implement an STM as discussed in <a href=\"#narrow/channel/304641-ideas/topic/STM.20.28software.20transactional.20memory.29.20builtin\">this thread</a>. It would need effects like<br>\n<code>get_model_for_reading! : {} =&gt; Model</code> or <code>do_stuff_with_Model! : (Model =&gt; a) =&gt; a</code>. But currently, it is impossible for the hosted module to import the Model-symbol.</p>\n<p>So my question is, could/should the hosted module header also have something like an <code>requires</code> argument? Or should the <code>requires</code> feature be redesigned in a way, that solves that problem? (and therefore would need a different header)</p>",
        "id": 492257611,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736236016
    },
    {
        "content": "<p>I can understand wanting there to be platform functions that can access the <code>requires</code> types, but I don't think it's viable for the hosted module to send <code>Model</code> to the host.</p>",
        "id": 492262286,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736238171
    },
    {
        "content": "<p>FFI needs to send/receive statically-sized types, and Model changes depending on the user's code outside of the platform</p>",
        "id": 492262377,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736238217
    },
    {
        "content": "<p>Currently, we compile the platform before even sending it to the user as a code archive via GH releases, so there's not a performant way to make a dynamically-sized value available to the host</p>",
        "id": 492262555,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736238283
    },
    {
        "content": "<p>That said, we <em>could</em> make it available but not allow sending it over the FFI boundary, instead requiring the platform to serialize/deserialize to and from <code>List U8</code></p>",
        "id": 492262866,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736238408
    },
    {
        "content": "<p>But then we're promoting low-perf behavior, right?</p>",
        "id": 492262938,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736238430
    },
    {
        "content": "<p>Would love to hear a lower-level expertised opinion on this</p>",
        "id": 492262982,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736238452
    },
    {
        "content": "<p>To send a <code>Model</code> to the host, you have to box it. Its the same thing  you have to do, when you use the <code>Model</code> in the exported functions. So an effect would actually look like <code>get_model_with_lock : {} =&gt; Box Model</code> and afterwords there could be another effect like <code>release_lock : [Commit (Box Model), Rollback] =&gt; {}</code> . In this example, the host would not need to do anything with the Model, just return the pointer. And the Roc part of the platform could provide a function like <code>call_with_model : (Model -&gt; a) =&gt; a</code> that internally calls this both functions. But this function would also need access the the <code>requires</code> part from the header.</p>\n<p>(I think I highjacked your topic.  If you think, that my posts are off topic, you could move them.)</p>",
        "id": 492269744,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736241131
    },
    {
        "content": "<p>Nah, they're on topic enough. I don't expect much resistance to aligning the format of the <code>hosted</code> module header to the standard <code>module</code> header, and this discussion could help us align the <code>hosted</code> and <code>platform</code> headers</p>",
        "id": 492271074,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736241613
    },
    {
        "content": "<p>So anyway, the <code>Box</code> approach makes sense, thanks for outlining that to me.</p>",
        "id": 492271548,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736241805
    },
    {
        "content": "<p>I believe there was recent discussion surrounding the desire for type variables in <code>requires</code> types, but we can't do it if we want all types used in the program to be concrete for runtime</p>",
        "id": 492272115,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736241995
    },
    {
        "content": "<p>As long as <code>requires</code> types like <code>Model</code> need to be concrete, then what you're suggesting makes sense</p>",
        "id": 492272184,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242020
    },
    {
        "content": "<p>There was a spitball idea maybe 6-8 months ago from Richard to use modules params in the <code>platform</code> module to define the host functions, rendering the <code>hosted</code> module type redundant</p>",
        "id": 492272408,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242092
    },
    {
        "content": "<p>Since module params may be going the way of the dodo, I don't think it's wise for us to assume we'll have them long-term</p>",
        "id": 492272460,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242118
    },
    {
        "content": "<p>But something is of intrigue there: for each platform, the following things need to be done only once:</p>\n<ul>\n<li>request a list of <code>requires</code> types and values/functions that are passed to the host via the <code>provides</code> clause<ul>\n<li>write the <code>provides</code> functions using the <code>requires</code> entities</li>\n</ul>\n</li>\n<li>set a list of required packages (e.g. <code>roc-json</code>, <code>weaver</code>, etc.) for the platform</li>\n<li>define a list of functions that are translated to FFI with the host</li>\n<li>expose a list of modules for app authors to use from the platform</li>\n</ul>",
        "id": 492273002,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242311
    },
    {
        "content": "<p>In theory, all of these could be done in one, big module, but that would probably lead to having a <em>really</em> big module for mature platforms</p>",
        "id": 492273109,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242342
    },
    {
        "content": "<p>Though as you point out, the current <code>hosted</code> module separation prevents platform authors from being able to access <code>requires</code> entities</p>",
        "id": 492273178,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242377
    },
    {
        "content": "<p>I think we should either:</p>\n<ul>\n<li>combine <code>platform</code> and <code>hosted</code> into a single module type (leads to bigger modules, but simplifies Roc a bit)</li>\n<li>add the <code>requires</code> clause to <code>hosted</code> modules as well, and give errors when <code>platform</code> and <code>hosted</code> disagree on the contents of the <code>requires</code> clauses</li>\n</ul>",
        "id": 492273518,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242495
    },
    {
        "content": "<p>There is another problem, with a combined <code>platform</code> and <code>hosted</code> modules. It is currently impossible to import stuff from it. For an platform to export something to the app, it has to be inside another module, so it can be imported with <code>import pf.Module</code>. If the exported functions would live inside the platform-module, they could not be used be an app or any other Module provided by the platform.</p>",
        "id": 492274047,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736242706
    },
    {
        "content": "<p>I'd vote for the first one because it seems simpler, and I'm not convinced it'll be that much of a problem for big platforms to have everything in a single file since you tend to only have a couple functions that glue <code>requires</code> to <code>provides</code>, and the FFI definitions are only type signatures, not function bodies</p>",
        "id": 492274066,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242715
    },
    {
        "content": "<p><del>you can import <code>Stdout</code> from the <code>platform</code> module</del></p>",
        "id": 492274140,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242745
    },
    {
        "content": "<p>Oh, I see</p>",
        "id": 492274164,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736242754
    },
    {
        "content": "<p>A solution we could push is to combine the two modules and require the <code>platform</code> module to be named <code>Platform.roc</code> or something like that. And then everyone can always just <code>import Platform exposing [...]</code></p>",
        "id": 492275912,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736243459
    },
    {
        "content": "<p>Maybe the way, stuff gets passed around between the app and the platform has to be rethinked <span aria-label=\"grinning\" class=\"emoji emoji-1f600\" role=\"img\" title=\"grinning\">:grinning:</span> </p>\n<p>If you do, another (off topic) issue is, how a platform-Module can define, that something is exported to the app or exported only to other modules inside the platform. In my previous example, the platform only wants to export <code>call_with_model</code>. But the hosted-module exports <code>get_model_with_lock</code> and <code>release_lock</code>. How can the platform make sure, that the app can not import this effects directly? I think, basic-cli and basic-webserver use Modules with an <code>Internal</code>-Prefix. But If I understand it correct, then an app could import the stuff from the <code>Internal</code>-Modules as well.</p>\n<p>An example where this is a problem is the current version of the kingfisher platform. The <a href=\"https://github.com/ostcar/kingfisher/blob/d7ff00af22ba69f330a8f098b29b518d85ef0d1f/platform/Host.roc#L10\">hosted module exports <code>save_event!</code></a> . But the app is only allowed to use it in a write request as defined <a href=\"https://github.com/ostcar/kingfisher/blob/d7ff00af22ba69f330a8f098b29b518d85ef0d1f/platform/Http.roc#L77-L80\">here</a>. If an app just imports <code>pf.Host</code> and uses this functions, all guaranties of the platform are off.</p>\n<p>Go solves the problem with an <a href=\"https://www.bytesizego.com/blog/golang-internal-package\"><code>internal</code> directory</a>. Maybe Roc could forbid apps to import stuff from the <code>hosted</code> (or combined <code>hosted</code> and <code>platform</code>) module and also forbid apps import from Modules, when the Name starts with <code>Internal</code>.</p>",
        "id": 492276688,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736243760
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"461444\">Sam Mohr</span> <a href=\"#narrow/channel/316715-contributing/topic/Simplify.20hosted.20module.20headers/near/492275912\">said</a>:</p>\n<blockquote>\n<p>A solution we could push is to combine the two modules and require the <code>platform</code> module to be named <code>Platform.roc</code> or something like that. And then everyone can always just <code>import Platform exposing [...]</code></p>\n</blockquote>\n<p>If this <code>Platform.roc</code>-Module could also export <code>Model</code> then my initial problem would be solved. And if Roc forbids apps to import stuff from the Platform-module, then I would be fully happy <span aria-label=\"innocent\" class=\"emoji emoji-1f607\" role=\"img\" title=\"innocent\">:innocent:</span></p>",
        "id": 492277431,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736244022
    },
    {
        "content": "<p>Note, we should be able to pass a <code>Box a</code> to and from the host just fine. The specific problem is that we need to link the <code>a</code> from two different effects. This is currently done through requires, but it doesn't have to be.</p>",
        "id": 492322511,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736260974
    },
    {
        "content": "<p>For example, it would be easier to deal with basic webserver if the <code>Model</code> as actually <code>model</code>. Then you wouldn't have to worry nexted about type variables and some of the typing conplxity</p>",
        "id": 492322754,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736261046
    },
    {
        "content": "<p>To do this, we just need a way to specify that <code>model</code> from <code>init!</code> and <code>respond!</code> are the same type. The same would apply to many effects.</p>",
        "id": 492322915,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736261108
    },
    {
        "content": "<p>I think this would be far nicer to support in general and would prefer it over requires syntax.</p>",
        "id": 492323002,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736261136
    },
    {
        "content": "<p>Caveat. This only removes the use of requires for types. It would still be needed to pass app functions to the platform unless the platform just imports the app and calls something.</p>",
        "id": 492323196,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736261193
    },
    {
        "content": "<p>Note, we can work around this for platform main functions, but not for effects. For basic webserver <code>init!</code> and <code>respond!</code>, we can instead use a record <code>{ init!, respond! }</code> and use the record to link the type. It would be nicer to also link effect types.</p>",
        "id": 492327087,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736262349
    },
    {
        "content": "<p>Wow. I was fixated on the dogma that <code>Model</code> has to be pass to the platform. Your idea seems much simpler.</p>\n<p>I don't understand how this could work on effects or other exported functions. How could the platform specify, that the argument from <code>do_stuff_with_Model! : (model =&gt; a) =&gt; a</code> is the same as the return value from the provided function <code>init! : {} =&gt; model</code>?</p>",
        "id": 492341833,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736266745
    },
    {
        "content": "<p>Yeah, I'm not sure how we would wire it up, but fundamentally it is just propagating a constraint. (Just have to make that clear to the user and platform author somehow)</p>\n<p>Dumb idea, but it could be a simple as a <code>!</code> suffix links type variables in the platform</p>\n<p>So:<br>\n<code>do_something_with_model! : (model! =&gt; a) =&gt; a</code><br>\nAnd<br>\n<code>init! : {} =&gt; model!</code></p>",
        "id": 492358202,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736272389
    },
    {
        "content": "<p>yeah I like <a href=\"https://package.elm-lang.org/packages/elm/browser/latest/Browser#sandbox\">the way Elm does it</a> and would like for us to do something that too - where it's just normal type variables and that's it</p>",
        "id": 492359405,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736272839
    },
    {
        "content": "<p>e.g.</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">init!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">Request</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">Response</span><span class=\"p\">)))</span>\n</code></pre></div>",
        "id": 492359503,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736272877
    },
    {
        "content": "<p>so in that type, <code>init!</code> returns both the initial model as well as the function which takes the current model and a request and returns the new model and a response</p>",
        "id": 492359714,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736272936
    },
    {
        "content": "<p>although as discussed somewhere else, that would have race condition problems <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 492359789,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736272969
    },
    {
        "content": "<p>if handlers can run concurrently</p>",
        "id": 492359829,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736272985
    },
    {
        "content": "<p>You could do something like this to allow async model updates:</p>\n<div class=\"codehilite\" data-code-language=\"Elm\"><pre><span></span><code><span class=\"nv\">init</span><span class=\"err\">!</span><span class=\"w\"> </span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nv\">model</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"nv\">respond</span><span class=\"err\">!</span><span class=\"nf\">:</span><span class=\"w\">  </span><span class=\"nv\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Request</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">update</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">Response</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"nv\">updateModel</span><span class=\"nf\">:</span><span class=\"w\"> </span><span class=\"nv\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">update</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nv\">model</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 492360571,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736273275
    },
    {
        "content": "<p>Wow, I didn't even read that link</p>",
        "id": 492361743,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736273759
    },
    {
        "content": "<p>yeah in Elm terminology it would be:</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">init!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">model</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">respond!</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">Request</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">Response</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"n\">update!</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 492370025,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736276915
    },
    {
        "content": "<p>Does update need to be effecful?</p>",
        "id": 492370070,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736276931
    },
    {
        "content": "<p>doesn't have to be, but you might want to do logging or something in there</p>",
        "id": 492370122,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736276953
    },
    {
        "content": "<p>Sure</p>",
        "id": 492370133,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736276957
    },
    {
        "content": "<p>it does have to be single-threaded</p>",
        "id": 492370153,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736276964
    },
    {
        "content": "<p>as in, at most one <code>update</code> function is ever running at a time</p>",
        "id": 492370197,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736276987
    },
    {
        "content": "<p>just going through the queue of messages</p>",
        "id": 492370215,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736276997
    },
    {
        "content": "<p>The problem with this approach is you no longer guarantee seeing updates to model before the next request handling happens, but also that's just the case anyway with proper multithreading</p>",
        "id": 492370351,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736277033
    },
    {
        "content": "<p>right</p>",
        "id": 492370366,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277041
    },
    {
        "content": "<p>I think this API is pretty good</p>",
        "id": 492370378,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736277043
    },
    {
        "content": "<p>I definitely think it's good to use normal type variables for this</p>",
        "id": 492370529,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277111
    },
    {
        "content": "<p>So we still don't need to expose model to the host? Is there a use case that would make that desired?</p>",
        "id": 492370539,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736277116
    },
    {
        "content": "<p>I'd love to get rid of the <code>Model</code> concept we have today</p>",
        "id": 492370544,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277119
    },
    {
        "content": "<p>actually it was originally a workaround</p>",
        "id": 492370607,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277128
    },
    {
        "content": "<p>because we didn't have sending closure captures to the host working, and that seemed like a big project</p>",
        "id": 492370649,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277144
    },
    {
        "content": "<p>so Folkert suggested adding this as a workaround to unblock the use cases <span aria-label=\"big smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"big smile\">:big_smile:</span></p>",
        "id": 492370658,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277153
    },
    {
        "content": "<p>That's one more section gone from the platform</p>",
        "id": 492370663,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736277155
    },
    {
        "content": "<p>but it was never intended to be the long-term design</p>",
        "id": 492370690,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277170
    },
    {
        "content": "<p>the other thing is that I suspect this pattern of <code>init!</code> returning the request handler function is going to end up being what every webserver wants to do</p>",
        "id": 492371380,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277448
    },
    {
        "content": "<p>because it's such a convenient way to get environment variables etc. on startup</p>",
        "id": 492371398,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277458
    },
    {
        "content": "<p>and then you just close over them and that's it</p>",
        "id": 492371524,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277494
    },
    {
        "content": "<p>I'm actually not sure if today it might need to use <code>Box</code></p>",
        "id": 492372128,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277770
    },
    {
        "content": "<p>in order to work around current compilation issues, not sure</p>",
        "id": 492372149,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277781
    },
    {
        "content": "<p>we could try it out on <code>basic-webserver</code>, see if it works as-is</p>",
        "id": 492372197,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736277807
    },
    {
        "content": "<p>I cannot see, how this solution would support effects that use model. You would need to define all effects in this init structure.</p>",
        "id": 492377482,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736279865
    },
    {
        "content": "<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span> what effects use Model?</p>",
        "id": 492380371,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736281091
    },
    {
        "content": "<p>Something like <code>save_to_db! : Model =&gt; {}</code> or load_from_db : {} =&gt; Model`</p>",
        "id": 492381324,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736281460
    },
    {
        "content": "<p>Stuff for Kingfisher</p>",
        "id": 492381332,
        "sender_full_name": "Sam Mohr",
        "timestamp": 1736281465
    },
    {
        "content": "<p>ah I see</p>",
        "id": 492382289,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736281886
    },
    {
        "content": "<p>so a tradeoff there is that if you have to represent that using a value that you pass around - e.g. something like:</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">save_to_db!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Db</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">()</span>\n\n<span class=\"n\">load_from_db!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Db</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">model</span>\n</code></pre></div>\n<p>...then it's less convenient in that you have an extra value to pass around, but on the other hand, without that, you wouldn't have a way to simulate database state during tests. You'd have to always the real platform functions</p>",
        "id": 492382943,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736282181
    },
    {
        "content": "<p>as opposed to being able to construct a fake <code>Db</code> and pass it around</p>",
        "id": 492383001,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736282209
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281383\">Richard Feldman</span> <a href=\"#narrow/stream/316715-contributing/topic/Simplify.20hosted.20module.20headers/near/492370025\">said</a>:</p>\n<blockquote>\n<p>yeah in Elm terminology it would be:</p>\n<p><div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">init!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">model</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">respond!</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">Request</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">Response</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"n\">update!</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>What is the benefit of that over just exposing a record of functions to the host?</p>",
        "id": 492390898,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736285517
    },
    {
        "content": "<p>you can read env vars (and similar) and use them in any of the returned functions</p>",
        "id": 492393302,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736286504
    },
    {
        "content": "<p>You can also do that by storing them in model</p>",
        "id": 492396827,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736287938
    },
    {
        "content": "<p>But I guess this would mean that you could avoid storing queries in the model. They are constant after creation. That would simplify all the error managing.</p>",
        "id": 492396925,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736288005
    },
    {
        "content": "<p>yeah exactly</p>",
        "id": 492401156,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1736289927
    },
    {
        "content": "<p>I guess that may be a reasonable api once repeatedly using closures with the platform just works.</p>",
        "id": 492407228,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1736293050
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281383\">Richard Feldman</span> <a href=\"#narrow/stream/316715-contributing/topic/Simplify.20hosted.20module.20headers/near/492382943\">said</a>:</p>\n<blockquote>\n<p>so a tradeoff there is that if you have to represent that using a value that you pass around - e.g. something like:</p>\n<p><div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">save_to_db!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Db</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">()</span>\n\n<span class=\"n\">load_from_db!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Db</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">model</span>\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I don't get it. What is <code>Db model</code>? Is this something <code>Init</code> has to return?</p>",
        "id": 492439313,
        "sender_full_name": "Oskar Hahn",
        "timestamp": 1736315775
    }
]
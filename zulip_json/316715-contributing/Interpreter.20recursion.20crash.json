[
    {
        "content": "<p>So I have been doing a little more investigation into the crash that I encountered yesterday. I had to build the platform shim with debug symbols in order to get a backtrace which required some modifications in <code>cli/main.zig</code> and <code>cli/linker.zig</code>.  It looks like the exception actually occurs in translateTypeVar when we try to access a key in the translate_cache. </p>\n<p>It was a bit difficult getting to this point because I had to manually modify the calls to llvm and lld-link to get a debuggable platform shim. Does it make sense to make this an option in the <code>generatePlatformHostShim</code> function for debugging? I could even see this being valuable for people developing their own platforms for debugging purposes.</p>\n<p>Also I was wondering if this recursive fib test should be put into the snapshot tests folder or be added to one of the test platforms like int or str etc.</p>\n<p><a href=\"/user_uploads/22008/tRqC6wBfvosB3gHELVgH7Mgs/image.png\">image.png</a><br>\n<a href=\"/user_uploads/22008/106S0FiE12VSwHl7DgnC8vgS/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/tRqC6wBfvosB3gHELVgH7Mgs/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1912x134\" src=\"/user_uploads/thumbnail/22008/tRqC6wBfvosB3gHELVgH7Mgs/image.png/840x560.webp\"></a></div><div class=\"message_inline_image\"><a href=\"/user_uploads/22008/106S0FiE12VSwHl7DgnC8vgS/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"586x1452\" src=\"/user_uploads/thumbnail/22008/106S0FiE12VSwHl7DgnC8vgS/image.png/840x560.webp\"></a></div>",
        "id": 560507559,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764211675
    },
    {
        "content": "<p>Sounds like something that would be very useful in future to have</p>",
        "id": 560510873,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764214710
    },
    {
        "content": "<p>Another update. It does actually look like its a stack depth bug. I updated to the latest main branch and the crash location changed but the call stack looks very similar.</p>",
        "id": 560510897,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764214733
    },
    {
        "content": "<p>Does this mean that <code>evalExprMinimal</code> and <code>dispatchBinaryOp</code> should be implemented without recursion so that they do not trigger a stack overflow, or is it better to ignore the problem for now and implement tail call recursion? I think that tail calls would only work in the trivial case like for Fibonacci where there is no more work after the recursive call correct?</p>",
        "id": 560511497,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764215261
    },
    {
        "content": "<p>I'm probably not the best person to comment on that question... but I know that trmc is the plan</p>",
        "id": 560511566,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764215328
    },
    {
        "content": "<p>I thought our interpreter was implemented without recursion though</p>",
        "id": 560511599,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764215357
    },
    {
        "content": "<p>I'm thinking of tail call optimization as something to do in 2026</p>",
        "id": 560511617,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764215369
    },
    {
        "content": "<p>right now I'm trying to focus on what's needed to unblock people doing Advent of Code in Roc if they want to</p>",
        "id": 560511635,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764215385
    },
    {
        "content": "<p>and since we already have <code>for</code> and <code>while</code>, stack-safe recursion isn't a blocker <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 560511666,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764215404
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1001061\">Devin Prothero</span> <a href=\"#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560511497\">said</a>:</p>\n<blockquote>\n<p>Does this mean that <code>evalExprMinimal</code> and <code>dispatchBinaryOp</code> should be implemented without recursion so that they do not trigger a stack overflow</p>\n</blockquote>\n<p>oh you mean recursion in the Zig code!</p>",
        "id": 560511728,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764215459
    },
    {
        "content": "<p>yeah it would be great if they could be stack-safe <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 560511756,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764215477
    },
    {
        "content": "<p>Yeah the zig code for the interpreter is all recursive which causes the stack overflow. It might be a bit difficult to rewrite in a stack safe way since there are multiple mutually recursive functions all interacting. Some kind of state machine with ArrayLists to hold stack frames might make the most sense, but I would have to try it first and see.</p>",
        "id": 560512018,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764215717
    },
    {
        "content": "<p>I have written some toy languages before but usually I would compile to a bytecode and interpret that with a VM rather than directly interpreting expressions so iv'e just been trying to familiarize myself with the code.</p>",
        "id": 560512130,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764215815
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281383\">Richard Feldman</span> <a href=\"#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560511666\">said</a>:</p>\n<blockquote>\n<p>and since we already have <code>for</code> and <code>while</code>, stack-safe recursion isn't a blocker <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>\n</blockquote>\n<p>That makes a lot of sense, I think that is smart since AOC is just around the corner</p>",
        "id": 560512173,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764215852
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560511566\">said</a>:</p>\n<blockquote>\n<p>I'm probably not the best person to comment on that question... but I know that trmc is the plan</p>\n</blockquote>\n<p>Sorry I'm not familiar with trmc what is that?</p>",
        "id": 560512487,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764216093
    },
    {
        "content": "<p><a href=\"https://jfmengels.net/modulo-cons/#tail-recursion-but-modulo-cons\">https://jfmengels.net/modulo-cons/#tail-recursion-but-modulo-cons</a></p>",
        "id": 560512861,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764216415
    },
    {
        "content": "<p>relevant Roc-specific context: <a class=\"stream-topic\" data-stream-id=\"316715\" href=\"/#narrow/channel/316715-contributing/topic/Tail.20Recursion.20Modulo.20Cons/with/356268539\">#contributing &gt; Tail Recursion Modulo Cons</a>  and later <a href=\"https://github.com/roc-lang/roc/pull/5569\">https://github.com/roc-lang/roc/pull/5569</a></p>",
        "id": 560512919,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764216462
    },
    {
        "content": "<p>(and other follow-up PRs)</p>",
        "id": 560512922,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764216468
    },
    {
        "content": "<p>Thanks</p>",
        "id": 560512932,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764216478
    },
    {
        "content": "<p>Richard that zulip chat is a private group DM I think... I can't see it at least</p>",
        "id": 560512957,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764216503
    },
    {
        "content": "<p>oops sorry, fixed the link!</p>",
        "id": 560513113,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764216638
    },
    {
        "content": "<p>Hmm. I wouldn't expect the interpreter to need this at all. I thought the interpreter was a big while loop that runs instructions and then pushes function calls onto the stack. If the interpreter itself is recursive for code execution it may be a general problem in large roc programs even with trmc.</p>",
        "id": 560515248,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1764218200
    },
    {
        "content": "<p>yeah I was confused earlier - this is about our Zig code being recursive</p>",
        "id": 560515351,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764218304
    },
    {
        "content": "<p>instead of stack-safe</p>",
        "id": 560515363,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764218315
    },
    {
        "content": "<p>as I recall I went down a rabbit hole trying to do that at some point and backed off</p>",
        "id": 560515382,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764218339
    },
    {
        "content": "<p>From what I have seen so far it looks like CIR is modeled as an S-Expression so the most natural way to implement the interpreter is recursively. Here is a random example of the simple add test after the canonicalize pass.</p>\n<div class=\"codehilite\" data-code-language=\"Common Lisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">can-ir</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">d-let</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"nv\">p-assign</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">ident</span><span class=\"w\"> </span><span class=\"s\">\"addU8\"</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"nv\">e-lambda</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nv\">args</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">p-assign</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">ident</span><span class=\"w\"> </span><span class=\"s\">\"a\"</span><span class=\"p\">))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">p-assign</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">ident</span><span class=\"w\"> </span><span class=\"s\">\"b\"</span><span class=\"p\">)))</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nv\">e-binop</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">op</span><span class=\"w\"> </span><span class=\"s\">\"add\"</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-lookup-local</span>\n<span class=\"w\">                    </span><span class=\"p\">(</span><span class=\"nv\">p-assign</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">ident</span><span class=\"w\"> </span><span class=\"s\">\"a\"</span><span class=\"p\">)))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-lookup-local</span>\n<span class=\"w\">                    </span><span class=\"p\">(</span><span class=\"nv\">p-assign</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">ident</span><span class=\"w\"> </span><span class=\"s\">\"b\"</span><span class=\"p\">)))))</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"nv\">annotation</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nv\">ty-fn</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">effectful</span><span class=\"w\"> </span><span class=\"nv\">false</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">ty-lookup</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">name</span><span class=\"w\"> </span><span class=\"s\">\"U8\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">builtin</span><span class=\"p\">))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">ty-lookup</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">name</span><span class=\"w\"> </span><span class=\"s\">\"U8\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">builtin</span><span class=\"p\">))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">ty-lookup</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">name</span><span class=\"w\"> </span><span class=\"s\">\"U8\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">builtin</span><span class=\"p\">)))))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">s-expect</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"nv\">e-binop</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">op</span><span class=\"w\"> </span><span class=\"s\">\"eq\"</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nv\">e-call</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-lookup-local</span>\n<span class=\"w\">                    </span><span class=\"p\">(</span><span class=\"nv\">p-assign</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">ident</span><span class=\"w\"> </span><span class=\"s\">\"addU8\"</span><span class=\"p\">)))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-num</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">value</span><span class=\"w\"> </span><span class=\"s\">\"1\"</span><span class=\"p\">))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-num</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">value</span><span class=\"w\"> </span><span class=\"s\">\"2\"</span><span class=\"p\">)))</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nv\">e-num</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">value</span><span class=\"w\"> </span><span class=\"s\">\"3\"</span><span class=\"p\">))))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"nv\">s-expect</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"nv\">e-binop</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">op</span><span class=\"w\"> </span><span class=\"s\">\"eq\"</span><span class=\"p\">)</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nv\">e-call</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-lookup-local</span>\n<span class=\"w\">                    </span><span class=\"p\">(</span><span class=\"nv\">p-assign</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">ident</span><span class=\"w\"> </span><span class=\"s\">\"addU8\"</span><span class=\"p\">)))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-num</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">value</span><span class=\"w\"> </span><span class=\"s\">\"0\"</span><span class=\"p\">))</span>\n<span class=\"w\">                </span><span class=\"p\">(</span><span class=\"nv\">e-num</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">value</span><span class=\"w\"> </span><span class=\"s\">\"10\"</span><span class=\"p\">)))</span>\n<span class=\"w\">            </span><span class=\"p\">(</span><span class=\"nv\">e-num</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">value</span><span class=\"w\"> </span><span class=\"s\">\"10\"</span><span class=\"p\">)))))</span>\n</code></pre></div>\n<p>It seems like the problem arises once the call depth of the roc program reaches some arbitrary number because instructions like <code>e-call</code> and <code>e-binop</code>are intepreted by recursively calling <code>evalExprMinimal</code> and the like. I think that this means <span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> is correct and that even non-recursive code will trigger this crash if you have deep enough function calls.</p>",
        "id": 560517601,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764220304
    },
    {
        "content": "<p>for sure! that's why it should be stack-safe <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 560517656,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764220336
    },
    {
        "content": "<p>the only reason it isn't right now is just the amount of work it would take - although maybe it will turn out we need it for advent of code <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 560517698,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764220368
    },
    {
        "content": "<p>Yeah, I guess the current recursive nodes are not exactly interpreter friendly passed just being a tree walking interpreter</p>",
        "id": 560524100,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1764225454
    },
    {
        "content": "<p>I wonder if we will need to make a flat bytecode for it to work well.</p>",
        "id": 560525630,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1764226426
    },
    {
        "content": "<p>With anything tree, I think it is either expensive (push and popping state for every node), or recursive.</p>\n<p>That said, if we just push state at function call boundaries (and loops), that may be enough</p>",
        "id": 560525844,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1764226536
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1001061\">Devin Prothero</span> <a href=\"#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560507559\">said</a>:</p>\n<blockquote>\n<p>It was a bit difficult getting to this point because I had to manually modify the calls to llvm and lld-link to get a debuggable platform shim. Does it make sense to make this an option in the <code>generatePlatformHostShim</code> function for debugging? I could even see this being valuable for people developing their own platforms for debugging purposes.</p>\n</blockquote>\n<p>Could you share how you got a debuggable build? I'm struggling to find the right build/link options to adjust.</p>",
        "id": 560588847,
        "sender_full_name": "isaactfa",
        "timestamp": 1764247652
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1001404\">isaactfa</span> <a href=\"#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560588847\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"1001061\">Devin Prothero</span> <a href=\"#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560507559\">said</a>:</p>\n<blockquote>\n<p>It was a bit difficult getting to this point because I had to manually modify the calls to llvm and lld-link to get a debuggable platform shim. Does it make sense to make this an option in the <code>generatePlatformHostShim</code> function for debugging? I could even see this being valuable for people developing their own platforms for debugging purposes.</p>\n</blockquote>\n<p>Could you share how you got a debuggable build? I'm struggling to find the right build/link options to adjust.</p>\n</blockquote>\n<p>I had to make quite a few changes to get debugging to work I made a patch file that shows the important stuff tho.</p>\n<p><a href=\"/user_uploads/22008/Gyqt2oGt3Jv4ukoTm63izsJd/debug_platform_builds.patch\">debug_platform_builds.patch</a></p>\n<p>Also I don't know if you are on windows but if you are then I would recommend the RadDebugger because it makes it easy to debug subprocesses. You can just turn on a setting and it will automatically hook into child processes which is important because the interpreter runs as a subprocess.</p>",
        "id": 560660254,
        "sender_full_name": "Devin Prothero",
        "timestamp": 1764271121
    },
    {
        "content": "<p>Thank you!</p>",
        "id": 560717933,
        "sender_full_name": "isaactfa",
        "timestamp": 1764313673
    }
]
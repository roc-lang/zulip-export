[
    {
        "content": "<p>My day01.roc AoC solution works but leaks memory. I minimized it to the following example. It seems the memory leak only manifests if the string literal is top-level (not in main) and if multi-line string literal (<code>\\\\</code> syntax).</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"c1\"># Only multi-line syntax leaks memory</span>\n<span class=\"c1\"># Single-line string literal does not leak memory: \"Very long single-line string does not leak memory \\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\nLLLLLLLLLLLL\"</span>\n<span class=\"c1\"># Multi-line string literal defined in main does not leak memory</span>\n<span class=\"n\">multi_line_constant</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">3</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">4</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">5</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">6</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">7</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">8</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">9</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"n\">a</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"n\">b</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"n\">c</span>\n\n<span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">multi_line_constant</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 562531823,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765217424
    },
    {
        "content": "<p>Is it possible that the concatenation of the parts making the top-level string constant call some functions that allocate memory, and we don’t de-allocate it because it’s assumed top-level constants are from some arena that doesn’t need de-allocating?</p>",
        "id": 562532185,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765217565
    },
    {
        "content": "<p>I opened an issue about it: <a href=\"https://github.com/roc-lang/roc/issues/8592\">https://github.com/roc-lang/roc/issues/8592</a></p>",
        "id": 562533091,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765217906
    },
    {
        "content": "<p>Took me a few hours to get to the bottom of this one, it came up as an issue for me in CI with more test coverage while trying to merge the <code>roc build</code> PR. Anyway should be fixed in <a href=\"https://github.com/roc-lang/roc/pull/8548\">https://github.com/roc-lang/roc/pull/8548</a></p>",
        "id": 562613043,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765265012
    },
    {
        "content": "<p>It was caused by one or more of these issues - a double-decref in <code>list_concat</code> and also a memory leak from <code>findCapturedValue</code></p>",
        "id": 562613193,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765265102
    },
    {
        "content": "<p><a href=\"/user_uploads/22008/IApEKxUkV-fRxdlHc_7WQKIX/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/IApEKxUkV-fRxdlHc_7WQKIX/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"750x500\" src=\"/user_uploads/thumbnail/22008/IApEKxUkV-fRxdlHc_7WQKIX/image.png/840x560.webp\"></a></div>",
        "id": 562722502,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765295388
    }
]
[
    {
        "content": "<p>Hi,</p>\n<p>I've encountered the following  behavior, and before opening an issue I would like to learn what I can do to debug this issue myself.</p>\n<p>Context: in this (already somewhat condensed to the bug) snippet,</p>\n<div class=\"codehilite\" data-code-language=\"roc\"><pre><span></span><code>app [main!] { pf: platform \"https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst\" }\n\nimport pf.Stdout\nprint = Stdout.line!\nmain! = |_| {\n  testVal = \\\\if(equals(1, 333), {ref}, \"nothing\")\n  testVal-&gt;tokenize-&gt;Str.inspect-&gt;print\n\n  Ok({})\n}\n\ntokenize: Str =&gt; Try([Eof, LParen, RParen, StringLit], [UnexpectedToken({message: Str})])\ntokenize = |str| {\n  bytes = str.to_utf8()\n  if bytes.is_empty() {\n    return Ok(Eof())\n  }\n  # bad region wtih type inference side effects for `bytes`\n  _first_byte = match bytes.first() {\n    Err(ListWasEmpty) =&gt; {return Ok(Eof())}\n    Ok(b) =&gt; b\n  }\n  # /bad region\n  _ascii_bytes = bytes-&gt;take_while(|_| True)\n  Err(UnexpectedToken({message: \"unexpected token\"}))\n}\n\ntake_while: List(a), (a -&gt; Bool) =&gt; List(a)\ntake_while = |list, predicate| {\n  var $new = List.with_capacity(list.len())\n  for item in list {\n    if !predicate(item) {\n      return $new\n    }\n    $new = $new.append(item)\n  }\n  $new\n}\n</code></pre></div>\n<p>I get no errors on <code>roc check</code>, but executing it yields</p>\n<div class=\"codehilite\"><pre><span></span><code>Roc crashed: Builtin.Num.U8 does not implement len\n</code></pre></div>\n<p>However, when I comment out the match (“bad region”), I get the expected output</p>\n<div class=\"codehilite\"><pre><span></span><code>Try.Err(UnexpectedToken({ message: &quot;unexpected token&quot; }))\n</code></pre></div>\n<p>Now <em>how would I go about debugging this</em>? Or: how do you do it? I could think of:</p>\n<ul>\n<li>printf-debugging in the parser (which is a bit of a pain because <code>roc build</code> on checking out a new branch takes ~200s on my i7-8650U, and even changing nothing and recompiling takes an identical amount of time)?</li>\n<li>trying to wire up gdb with zig (which I tried for an hour or so and could not make work)?</li>\n<li>being test-driven and adding a snapshot test for this code, hoping to gain insight from the IR?</li>\n<li>giving up and asking an AI</li>\n</ul>\n<p>…nothing of which seems really feasible.<br>\nThank you in advance :)</p>",
        "id": 574889657,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1771576908
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"1006888\">@Lukas Juhrich</span>,<br>\nBased on my first impression I believe this is a bug that AI can handle, I use claude code with opus 4.6 thinking set to high. I recommend running <code>zig build minici</code> to run all tests after the fix is done. The difficult part lies in assessing the quality of the fix. You can check who wrote the code that surrounds the fix and ask them to review it.</p>",
        "id": 574897752,
        "sender_full_name": "Anton",
        "timestamp": 1771579592
    },
    {
        "content": "<p>Hi and thanks for the quick reply,</p>\n<p><span class=\"user-mention silent\" data-user-id=\"361169\">Anton</span> <a href=\"#narrow/channel/463736-bugs/topic/Roc.20crashed.3A.20Builtin.2EU8.20does.20not.20implement.20len.28.29/near/574897752\">said</a>:</p>\n<blockquote>\n<p>Based on my first impression I believe this is a bug that AI can handle,</p>\n</blockquote>\n<p>That would be nice if all I was interested in is a fix, but I would specifically like to do things myself to learn about the compiler. So if we pretend that this fix would be too difficult for AI – what would the strategy then be? Reading the code and tests to understand the pipeline, working test-driven and mainly working with <code>zig build minici</code>?</p>",
        "id": 574902602,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1771581310
    },
    {
        "content": "<blockquote>\n<p>So if we pretend that this fix would be too difficult for AI</p>\n</blockquote>\n<p>I think in this case we either pass the bug on to whomever has the most expertise with that part of the code or ask that person some questions and ask them to review the PR. My belief is that there is no generally applicable strategy in that case, you need to have a deep understanding of how things fit together, what the intended functionality is, and all the trade-offs involved.</p>",
        "id": 574904974,
        "sender_full_name": "Anton",
        "timestamp": 1771582089
    },
    {
        "content": "<p>I would try and reproduce in a snapshot test. <code>zig build snapshot -- path/to/snapshot.md</code></p>\n<p>At first glance it looks either like some kind of type checking issue, or a bug in the interpreter (there are many of these). </p>\n<p>So if we make a snapshot test and it repros then we can narrow it down to the stages type checking or earlier and we will also have good human readable IRs to look at. </p>\n<p>If it doesnt repro there it is most likely in the interpeter, and for that you can use the trace-eval flag maybe, or good old print debugging... which is much quicker when you have agents to assist <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n<p>Aside if you just want to rebuild roc and not all the tools it is much quicker to do <code>zig build roc</code></p>",
        "id": 574929177,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1771590482
    },
    {
        "content": "<p>Actually... we already know it type checks from <code>roc check</code> ... so I would say it's very likely in the interpeter.</p>",
        "id": 574929731,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1771590662
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"515757\">Luke Boswell</span> <a href=\"#narrow/channel/463736-bugs/topic/Roc.20crashed.3A.20Builtin.2EU8.20does.20not.20implement.20len.28.29/near/574929177\">said</a>:</p>\n<blockquote>\n<p>Aside if you just want to rebuild roc and not all the tools it is much quicker to do <code>zig build roc</code></p>\n</blockquote>\n<p>btw, I miswrote earlier, when I said <code>roc build</code> takes that long, I did indeed mean <code>zig build roc</code>  :)</p>\n<p>Thank you all for your input so far</p>",
        "id": 575015482,
        "sender_full_name": "Lukas Juhrich",
        "timestamp": 1771616004
    }
]
[
    {
        "content": "<p>Type checking is failing with this example. Am I missing something or is this a bug?</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">get_greeting</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{}</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"p\">(</span><span class=\"no\">Str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span>\n<span class=\"n\">get_greeting</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"p\">{}</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">match</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"o\">.</span><span class=\"n\">Ok</span><span class=\"p\">(</span><span class=\"no\">List</span><span class=\"o\">.</span><span class=\"n\">first</span><span class=\"p\">(</span><span class=\"o\">[</span><span class=\"s2\">\"hello\"</span><span class=\"o\">]</span><span class=\"p\">)</span><span class=\"sc\">?)</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">Err</span><span class=\"p\">(</span><span class=\"no\">Impossible</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"no\">Stdout</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">(</span><span class=\"n\">get_greeting</span><span class=\"p\">({})</span><span class=\"o\">.</span><span class=\"n\">ok_or</span><span class=\"p\">(</span><span class=\"s2\">\"Error!\"</span><span class=\"p\">))</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I get the following error message:</p>\n<div class=\"codehilite\"><pre><span></span><code>This expression is used in an unexpected way:\n   ┌─ test/fx/question_mark_operator_branching.roc:10:5\n   │\n10 │     match 0 {\n11 │         0 =&gt; Try.Ok(List.first([&quot;hello&quot;])?),\n12 │         _ =&gt; Err(Impossible)\n13 │     }\n\nIt has the type:\n    Try(Str, [Impossible, .._others])\n\nBut the type annotation says it should have the type:\n    Try(Str, [ListWasEmpty])\n</code></pre></div>",
        "id": 561503210,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764704025
    },
    {
        "content": "<p>seems like a bug, I'll look into it!</p>",
        "id": 561512630,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764707270
    },
    {
        "content": "<p>maybe an even simpler test with \"if\" branching is possible. I haven’t checked if it’s \"match\" specific or reproducible with branching in general.</p>",
        "id": 561512862,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764707369
    },
    {
        "content": "<p>it's that we don't have polarity yet (cc <span class=\"user-mention\" data-user-id=\"341568\">@Jared Ramirez</span>, not sure if you've started on that yet!) so it's treating <code>[ListWasEmpty]</code> from <code>List.first</code> as a closed union</p>",
        "id": 561513517,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764707605
    },
    {
        "content": "<p>I can manually annotate all the builtins as open and it should fix it</p>",
        "id": 561513574,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764707631
    },
    {
        "content": "<p>and then can put them back to the current signatures after we add polarity to the type-checker</p>",
        "id": 561513623,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764707651
    },
    {
        "content": "<p>Meanwhile, I’m just going to do a double match to make the type checker happy. Now I’m getting this for my program. Not sure where to start looking at. Any suggestions?</p>\n<div class=\"codehilite\"><pre><span></span><code>❯ roc day02.roc\n\nRoc crashed: e_closure: failed to resolve capture value\n</code></pre></div>",
        "id": 561514609,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764708036
    },
    {
        "content": "<p>I have also seen the \"e_closure\" problem. It occured to me when i tried following:</p>\n<div class=\"codehilite\"><pre><span></span><code>    for line in test_input.split_on(&quot;\\n&quot;) {\n        if line.starts_with(&quot;L&quot;) {\n            val = I64.from_str(line.drop_prefix(&quot;L&quot;))\n            dbg val\n        }\n    }\n</code></pre></div>\n<p>After peeking at your solution i got around that one by moving the <code>line.drop_prefix(\"L\")</code> before the if. So my guess would be that there is some problem using a value in an inner scope which is already captured in an outer scope or something. Not sure how properly describe it.</p>",
        "id": 561517241,
        "sender_full_name": "Hardy",
        "timestamp": 1764709050
    },
    {
        "content": "<p>can you give me a .roc file to repro?</p>",
        "id": 561522735,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764711012
    },
    {
        "content": "<p>doesn't need to be minimal, just something where I can run <code>roc</code> and reproduce it</p>",
        "id": 561522802,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764711028
    },
    {
        "content": "<p>yep, exactly what I was preparing</p>",
        "id": 561522908,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764711051
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/issues/8547\">https://github.com/roc-lang/roc/issues/8547</a></p>",
        "id": 561523500,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764711256
    },
    {
        "content": "<p>Don’t know if Claude root cause analysis is correct, but I figured I’d leave it there for you to judge.</p>",
        "id": 561523720,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764711328
    },
    {
        "content": "<p>thanks! the original error in this thread is fixed now btw</p>",
        "id": 561525447,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764712092
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"479073\">Matthieu Pizenberg</span> <a href=\"#narrow/channel/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching/near/561514609\">said</a>:</p>\n<blockquote>\n<p>Meanwhile, I’m just going to do a double match to make the type checker happy. Now I’m getting this for my program. Not sure where to start looking at. Any suggestions?</p>\n<p><div class=\"codehilite\"><pre><span></span><code>❯ roc day02.roc\n\nRoc crashed: e_closure: failed to resolve capture value\n</code></pre></div><br>\n</p>\n</blockquote>\n<p>I've also been having this issue with closures, got it with this sample program:</p>\n<div class=\"codehilite\"><pre><span></span><code>main! = |args| {\n    identity = |a| a\n    init_try : Try(U32, [SomeError, ..others])\n    init_try = Err(SomeError)\n    final_try = match init_try {\n            Ok(ok) =&gt; Ok(ok)\n            Err(e) =&gt; Err(identity(e))\n    }\n    was_an_error = Try.is_err(final_try)\n\n    Stdout.line!(&quot;final_try is an error: ${was_an_error}&quot;)\n    Ok({})\n\n}\n\n# Error: Roc crashed: e_closure: failed to resolve capture value\n</code></pre></div>\n<p>I tried with Strings and numerics and without type signatures they would crash, with type signatures they can succeed. But when using a Try type this always fails, with or without a type signature or changing the error type to something like [..others] or just SomeError. I also swapped Err(SomeError) with Ok(30) and still get the closure error. Was trying to get a closure like  |_| Exit(101) going.</p>",
        "id": 561548666,
        "sender_full_name": "Edwin Santos",
        "timestamp": 1764725114
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"986975\">@Edwin Santos</span> <span class=\"user-mention\" data-user-id=\"479073\">@Matthieu Pizenberg</span>  this is fixed now!</p>",
        "id": 561554224,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764729937
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281383\">Richard Feldman</span> <a href=\"#narrow/channel/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching/near/561513517\">said</a>:</p>\n<blockquote>\n<p>it's that we don't have polarity yet (cc <span class=\"user-mention silent\" data-user-id=\"341568\">Jared Ramirez</span>, not sure if you've started on that yet!) so it's treating <code>[ListWasEmpty]</code> from <code>List.first</code> as a closed union</p>\n</blockquote>\n<p>i have polarity partially implemented, but there’s still a bit of work until its ready to go</p>",
        "id": 561554316,
        "sender_full_name": "Jared Ramirez",
        "timestamp": 1764730048
    },
    {
        "content": "<p>yeah no rush! modifying the types in <code>Builtin.roc</code> to make the tag unions expicitly open fixed it</p>",
        "id": 561554341,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764730076
    }
]
[
    {
        "content": "<p>Here is the issue with the minimal example <a href=\"https://github.com/roc-lang/roc/issues/8553\">https://github.com/roc-lang/roc/issues/8553</a><br>\nBoth these mains trigger a segfault with the platform used in test/fx/</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_bool</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">].</span><span class=\"n\">sublist</span><span class=\"p\">({</span><span class=\"w\"> </span><span class=\"ss\">start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">].</span><span class=\"n\">sublist</span><span class=\"p\">({</span><span class=\"w\"> </span><span class=\"ss\">start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">})</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">Str</span><span class=\"o\">.</span><span class=\"n\">to_utf8</span><span class=\"p\">(</span><span class=\"s2\">\"11\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">_bool</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">sublist</span><span class=\"p\">({</span><span class=\"w\"> </span><span class=\"ss\">start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">sublist</span><span class=\"p\">({</span><span class=\"w\"> </span><span class=\"ss\">start</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"ss\">len</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">})</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 561590416,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764752022
    },
    {
        "content": "<p>even simpler segfault:</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_bool</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 561631273,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764762881
    },
    {
        "content": "<p>Could reproduce. With \"roc test\", I also get a stack trace, which is pretty helpful.  Source:</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">module</span><span class=\"o\">[]</span>\n<span class=\"n\">expect</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"mi\">1</span><span class=\"o\">]</span>\n</code></pre></div>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>stack trace</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>ez@desktop-nixos ~/c/testing-roc [1]&gt; ~/code/roc/zig-out/bin/roc test<br>\nthread 13052 panic: Use-after-free: incref on already-freed memory<br>\n/home/ez/code/roc/src/builtins/utils.zig:258:13: 0x4bdd9fd in increfRcPtrC (mod.zig)<br>\n            @panic(\"Use-after-free: incref on already-freed memory\");<br>\n            ^<br>\n/home/ez/code/roc/src/builtins/utils.zig:353:24: 0x4984515 in increfDataPtrC (mod.zig)<br>\n    return increfRcPtrC(isizes, inc_amount);<br>\n                       ^<br>\n/home/ez/code/roc/src/eval/StackValue.zig:188:42: 0x45be3d1 in copyToPtr (mod.zig)<br>\n            builtins.utils.increfDataPtrC(alloc_ptr, 1);<br>\n                                         ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:782:30: 0x45c9d6b in pushCopy (mod.zig)<br>\n            try src.copyToPtr(&amp;self.runtime_layout_store, ptr.?, roc_ops);<br>\n                             ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:10661:54: 0x50708f9 in evalLookupLocal (mod.zig)<br>\n                const copy_result = try self.pushCopy(b.value, roc_ops);<br>\n                                                     ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:9000:55: 0x4dee219 in scheduleExprEval (mod.zig)<br>\n                const value = try self.evalLookupLocal(lookup, expected_rt_var, roc_ops);<br>\n                                                      ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:8719:46: 0x4bdf732 in evalWithExpectedType (mod.zig)<br>\n                    try self.scheduleExprEval(&amp;work_stack, &amp;value_stack, eval_item.expr_idx, eval_item.expected_rt_var, roc_ops);<br>\n                                             ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:500:45: 0x4987c1d in eval (mod.zig)<br>\n        return try self.evalWithExpectedType(expr_idx, roc_ops, null);<br>\n                                            ^<br>\n/home/ez/code/roc/src/eval/test_runner.zig:198:49: 0x49cedd9 in eval (mod.zig)<br>\n        const result = try self.interpreter.eval(expr_idx, ops);<br>\n                                                ^<br>\n/home/ez/code/roc/src/eval/test_runner.zig:223:41: 0x478c7e3 in eval_all (mod.zig)<br>\n                const result = self.eval(stmt.s_expect.body) catch |err| {<br>\n                                        ^<br>\n/home/ez/code/roc/src/cli/main.zig:3094:41: 0x47d4b3a in rocTest (main.zig)<br>\n    const summary = test_runner.eval_all() catch |err| {<br>\n                                        ^<br>\n/home/ez/code/roc/src/cli/main.zig:576:41: 0x47f29f2 in mainArgs (main.zig)<br>\n        .test_cmd =&gt; |test_args| rocTest(allocs, test_args),<br>\n                                        ^<br>\n/home/ez/code/roc/src/cli/main.zig:508:13: 0x47f4a63 in main (main.zig)<br>\n    mainArgs(&amp;allocs, args) catch {<br>\n            ^<br>\n/home/ez/opt/zig/lib/std/start.zig:627:37: 0x47f5021 in main (std.zig)<br>\n            const result = root.main() catch |err| {<br>\n                                    ^<br>\n/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c:95:7: 0x945dcc0 in libc_start_main_stage2 (/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c)<br>\n exit(main(argc, argv, envp));<br>\n      ^<br>\n???:?:?: 0x936af89 in ??? (???)<br>\nUnwind error at address <code>exe:0x936af89</code> (error.MissingFDE), trace may be incomplete</p>\n<p>fish: Job 1, '~/code/roc/zig-out/bin/roc test' terminated by signal SIGABRT (Abort)</p>\n</div></div>",
        "id": 561635707,
        "sender_full_name": "Norbert Hajagos",
        "timestamp": 1764764214
    },
    {
        "content": "<p>Ok, Claude found out what seems to be the issue. I’ll prepare a PR.</p>",
        "id": 561651400,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764768481
    },
    {
        "content": "<p>Actually its fix doesn’t work for lists of lists ...</p>",
        "id": 561655124,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764769485
    },
    {
        "content": "<p>No time to continue looking into it today.</p>",
        "id": 561658168,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764770268
    },
    {
        "content": "<p>With a bit of luck, this might be the last blocking bug to be able to solve AoC 2 :)</p>",
        "id": 561716620,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764783578
    },
    {
        "content": "<p><a href=\"/user_uploads/22008/ZjCPOp5QBOKvnFd5xRdb2ijy/BUGFIX_LIST_EQUALITY_UAF.md\">BUGFIX_LIST_EQUALITY_UAF.md</a></p>\n<p>Earlier today, I got claude to be able to fix the simple case for list equality, but it would still fail at nested list equality, so I didn’t make a PR. Here is the report I had, in case it’s of help to anyone giving it another try.</p>",
        "id": 561719744,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764784553
    }
]
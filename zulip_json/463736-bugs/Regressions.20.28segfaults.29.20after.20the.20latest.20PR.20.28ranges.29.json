[
    {
        "content": "<p>It seems like my AoC solution for day 1 is now segfaulting after the ranges PR. Should I look into it or is it something you are aware of already?</p>",
        "id": 562157252,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764957633
    },
    {
        "content": "<p>So the regression is related to the one-liner for my <code>print!</code> function.</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"nb\">print</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">msg</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"o\">.</span><span class=\"n\">split_on</span><span class=\"p\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">for_each!</span><span class=\"p\">(</span><span class=\"no\">Stdout</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Before the latest PR, this works. But after the ranges PR, I now have to write it again with a for loop to not trigger a segfault. <span class=\"user-mention\" data-user-id=\"281383\">@Richard Feldman</span> I believe you had fixed that issue in another PR a few days back. Some of your changes in the range PR might have re-introduced some negative effect on this line.</p>",
        "id": 562159696,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764958662
    },
    {
        "content": "<p>Hum actually it’s not just that. Context matters. I’m looking into it more and trying to make another minimal reproducible example.</p>",
        "id": 562162555,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764959832
    },
    {
        "content": "<p>Ok, this is the weirdest bug I’ve ever seen. Here is my minimal example with a segfault on main (4766997).</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">main!</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"ss\">pf</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">platform</span><span class=\"w\"> </span><span class=\"s2\">\"./platform/main.roc\"</span><span class=\"w\"> </span><span class=\"p\">}</span>\n\n<span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"o\">.</span><span class=\"n\">Stdout</span>\n\n<span class=\"nb\">print</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Str</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"nb\">print</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">msg</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"o\">.</span><span class=\"n\">split_on</span><span class=\"p\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">for_each!</span><span class=\"p\">(</span><span class=\"no\">Stdout</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">)</span>\n\n<span class=\"n\">fnA</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Str</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"p\">(</span><span class=\"no\">I64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span>\n<span class=\"n\">fnA</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">_input</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"no\">Ok</span><span class=\"p\">(</span><span class=\"vg\">$x</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">fnB</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Str</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"p\">(</span><span class=\"no\">I64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span>\n<span class=\"n\">fnB</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">_input</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$y</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"no\">Ok</span><span class=\"p\">(</span><span class=\"vg\">$y</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">run!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nb\">print</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s2\">\"A1: ${fnA(\"</span><span class=\"nb\">test</span><span class=\"s2\">\")?.to_str()}\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">print</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s2\">\"A2: ${fnA(\"</span><span class=\"nb\">test</span><span class=\"s2\">\")?.to_str()}\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"nb\">print</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"s2\">\"A3: ${fnA(\"</span><span class=\"nb\">test</span><span class=\"s2\">\")?.to_str()}\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"no\">Ok</span><span class=\"p\">({})</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_ignore</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">run!</span><span class=\"p\">()</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>If I do any of the following things, there is NO segfault anymore.</p>\n<ul>\n<li>remove the unused function fnB</li>\n<li>remove one of the fnA calls</li>\n<li>replace the vars by constants</li>\n<li>return I64 instead of Try(I64, _)</li>\n</ul>\n<p>This is truly a mystery to me how to minimize this segfault further.</p>",
        "id": 562167206,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764961609
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>❯<span class=\"w\"> </span>roc<span class=\"w\"> </span>test/fx/segfault.roc\nA1:<span class=\"w\"> </span><span class=\"m\">1</span>\nA2:<span class=\"w\"> </span><span class=\"m\">1</span>\nerror:<span class=\"w\"> </span>Child<span class=\"w\"> </span>process<span class=\"w\"> </span>/var/folders/q3/lls0f9bd6x112cdkq8bgjldr0000gn/T/roc-65931/segfault.roc<span class=\"w\"> </span>killed<span class=\"w\"> </span>by<span class=\"w\"> </span>signal:<span class=\"w\"> </span><span class=\"m\">11</span>\nerror:<span class=\"w\"> </span>Child<span class=\"w\"> </span>process<span class=\"w\"> </span>crashed<span class=\"w\"> </span>with<span class=\"w\"> </span>segmentation<span class=\"w\"> </span>fault<span class=\"w\"> </span><span class=\"o\">(</span>SIGSEGV<span class=\"o\">)</span>\n</code></pre></div>",
        "id": 562167636,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1764961792
    },
    {
        "content": "<blockquote>\n<p>This is truly a mystery to me how to minimize this segfault further.</p>\n</blockquote>\n<p>Try getting a stacktrace with gdb: <code>gdb --ex run --ex bt --args roc test/fx/segfault.roc</code> that may get you some extra useful info.</p>",
        "id": 562173300,
        "sender_full_name": "Anton",
        "timestamp": 1764964280
    },
    {
        "content": "<p>I have my OS pretty locked down so that I can safely run <code>codex --yolo</code> or <code>claude --dangerously-skip-permissions</code>. They should be able to find the cause of the segfault in that mode but they don't always find the best fix.</p>",
        "id": 562173806,
        "sender_full_name": "Anton",
        "timestamp": 1764964512
    },
    {
        "content": "<p>I'll take a look!</p>",
        "id": 562174622,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764964892
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/pull/8576\">https://github.com/roc-lang/roc/pull/8576</a> should fix this, although I'm not quite ready to land the PR yet - needs some changes, but if you try that branch it should unblock!</p>",
        "id": 562218068,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764998355
    },
    {
        "content": "<p>Indeed, it fixes the segfault for day 1 :)</p>",
        "id": 562234755,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765018383
    }
]
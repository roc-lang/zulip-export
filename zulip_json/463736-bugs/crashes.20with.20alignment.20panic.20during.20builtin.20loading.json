[
    {
        "content": "<h1>Bug Report: <code>rocn</code> crashes with alignment panic during builtin loading</h1>\n<h2>Summary</h2>\n<p><code>rocn</code> crashes with an alignment panic during builtin module deserialization. The crash occurs before any user code is processed, making it impossible to use <code>rocn</code> with local platforms.</p>\n<h2>Version Info</h2>\n<div class=\"codehilite\"><pre><span></span><code>Roc compiler version debug-bcb502a3\n</code></pre></div>\n<h2>Environment</h2>\n<ul>\n<li><strong>OS</strong>: Ubuntu 24.04.3 LTS</li>\n<li><strong>Kernel</strong>: 6.8.0-71-generic x86_64</li>\n<li><strong>Zig</strong>: snap package 15308</li>\n</ul>\n<h2>Minimal Reproduction</h2>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>mkdir<span class=\"w\"> </span>-p<span class=\"w\"> </span>/tmp/rocn-bug/platform<span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"nb\">cd</span><span class=\"w\"> </span>/tmp/rocn-bug\n\n<span class=\"c1\"># Create minimal platform</span>\ncat<span class=\"w\"> </span>&gt;<span class=\"w\"> </span>platform/main.roc<span class=\"w\"> </span><span class=\"s\">&lt;&lt; 'EOF'</span>\n<span class=\"s\">platform \"\"</span>\n<span class=\"s\">    requires {} { main! : {} =&gt; {} }</span>\n<span class=\"s\">    exposes []</span>\n<span class=\"s\">    packages {}</span>\n<span class=\"s\">    provides { main_for_host!: \"main_for_host\" }</span>\n<span class=\"s\">    targets: {</span>\n<span class=\"s\">        files: \"targets/\",</span>\n<span class=\"s\">        exe: {</span>\n<span class=\"s\">            x64musl: [\"libhost.a\", app],</span>\n<span class=\"s\">        }</span>\n<span class=\"s\">    }</span>\n\n<span class=\"s\">main_for_host! : {} =&gt; I32</span>\n<span class=\"s\">main_for_host! = |{}|</span>\n<span class=\"s\">    main!({})</span>\n<span class=\"s\">    0</span>\n<span class=\"s\">EOF</span>\n\n<span class=\"c1\"># Create minimal app</span>\ncat<span class=\"w\"> </span>&gt;<span class=\"w\"> </span>main.roc<span class=\"w\"> </span><span class=\"s\">&lt;&lt; 'EOF'</span>\n<span class=\"s\">app [main!] { pf: platform \"./platform/main.roc\" }</span>\n\n<span class=\"s\">main! = |{}| {}</span>\n<span class=\"s\">EOF</span>\n\n<span class=\"c1\"># Trigger crash</span>\nrocn<span class=\"w\"> </span>main.roc\n</code></pre></div>\n<h2>Stack Trace</h2>\n<div class=\"codehilite\"><pre><span></span><code>thread panic: incorrect alignment\n/home/nandi/code/roc/src/collections/safe_list.zig:178:45: in deserialize\n    const items_ptr: [*]T = @ptrFromInt(base +% @as(usize, @intCast(self.offset)));\n                            ^\n/home/nandi/code/roc/src/canonicalize/NodeStore.zig:4058:74: in deserialize\n    const deserialized_int128_values = self.int128_values.deserialize(base_addr).*;\n                                                                     ^\n/home/nandi/code/roc/src/canonicalize/ModuleEnv.zig:2262:44: in deserialize\n    .store = self.store.deserialize(base_addr, gpa).*,\n                                   ^\n/home/nandi/code/roc/src/eval/builtin_loading.zig:50:47: in loadCompiledModule\n    const env = try serialized_ptr.deserialize(base_addr, gpa, source, module_name);\n                                              ^\n/home/nandi/code/roc/src/eval/BuiltinModules.zig:57:68: in init\n    var builtin_module = try builtin_loading.loadCompiledModule(allocator,\n        compiled_builtins.builtin_bin, &quot;Builtin&quot;, compiled_builtins.builtin_source);\n                                                                   ^\n/home/nandi/code/roc/src/cli/main.zig:1684:55: in setupSharedMemoryWithModuleEnv\n    var builtin_modules = try eval.BuiltinModules.init(ctx.gpa);\n                                                      ^\n/home/nandi/code/roc/src/cli/main.zig:1244:58: in rocRun\n    const shm_result = try setupSharedMemoryWithModuleEnv(ctx, args.path, args.allow_errors);\n                                                         ^\n</code></pre></div>\n<h2>Analysis</h2>\n<p>The crash occurs in <code>BuiltinModules.init()</code> during deserialization of pre-compiled builtin modules. Specifically, <code>int128_values</code> in the <code>NodeStore</code> has incorrect alignment when being deserialized from the embedded binary.</p>\n<p>This suggests either:</p>\n<ol>\n<li>The <code>compiled_builtins.builtin_bin</code> was compiled with different alignment requirements than the current runtime</li>\n<li>There's a serialization/deserialization mismatch for 128-bit integer types</li>\n<li>The embedded binary is corrupted or incompatible with the current Zig version</li>\n</ol>\n<h2>Workaround</h2>\n<p>None known. The crash occurs before user code is processed, so it affects all uses of <code>rocn</code> with local platforms.</p>",
        "id": 568880000,
        "sender_full_name": "nandi",
        "timestamp": 1768853417
    },
    {
        "content": "<p>what is <code>rocn</code>? <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 568928681,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1768873717
    },
    {
        "content": "<p>its my symlink to new compiler heh i think i was thinking \"roc new\" or something</p>",
        "id": 568928766,
        "sender_full_name": "nandi",
        "timestamp": 1768873787
    },
    {
        "content": "<p>I built again and i think error went away so not sure if this was because stale code or not</p>",
        "id": 568928792,
        "sender_full_name": "nandi",
        "timestamp": 1768873814
    }
]
[
    {
        "content": "<p>Hey all - I've got a real puzzler on my hands. I have been trying to port some old AoC code to the new compiler. However, while the program passes <code>roc build</code>, it crashes before reaching the end of main. However, depending where, and how many <code>dbg</code> statements I place, the crash will occur at different places.</p>\n<p>Also, I get some strange behavior where placing two <code>dbg</code> statements for the same <code>Try</code> value will show as the wrapped value once, and an <code>Ok(...)</code> the next time.</p>\n<p>There is a third issue, which seems unrelated to the <code>dbg</code> issue, in which I can pipe the results of the <code>part1()</code> calculation to <code>Stdout.line!()</code>, but if I save the result of <code>part1()</code> as a value and then call <code>Stdout.line!()</code> on the value in the next line, the program crashes before reaching the <code>Stdout.line!()</code>. </p>\n<p>Finally, the program never finishes executing completely. It will always crash before completing, but depending on how I structure the rest of the code, I may be able to get it to print the result of <code>part1()</code>.</p>",
        "id": 565388815,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766693369
    },
    {
        "content": "<p>I have been trying to minimize this issue, but haven't been able to due so yet.</p>\n<p>(current code coming below)</p>",
        "id": 565388866,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766693447
    },
    {
        "content": "<p>I will give the full code below, but let me start by giving this snippet. Depending on which of these debug statements are uncommented, the program will crash in different modes, and may or may not make it back to main to execute the <code>Stdout.line!()</code> statement in main.</p>\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"c1\">## Solve part 1</span>\n<span class=\"n\">part1</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">Str</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"p\">(</span><span class=\"no\">Str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span>\n<span class=\"n\">part1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">s</span><span class=\"o\">.</span><span class=\"n\">split_on</span><span class=\"p\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"o\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"n\">extract_digits</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"o\">-&gt;</span><span class=\"n\">keep_oks</span><span class=\"p\">(</span><span class=\"n\">compute_calibration</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"c1\"># -&gt;debug() # (1)</span>\n<span class=\"w\">    </span><span class=\"o\">-&gt;</span><span class=\"n\">sum</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"c1\"># -&gt;debug() # (2)</span>\n<span class=\"w\">    </span><span class=\"o\">.</span><span class=\"n\">to_str</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"c1\"># -&gt;debug() # (3)</span>\n<span class=\"w\">    </span><span class=\"o\">-&gt;</span><span class=\"no\">Ok</span>\n<span class=\"w\">    </span><span class=\"c1\"># -&gt;debug() # (4)</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 565388998,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766693699
    },
    {
        "content": "<p><strong>Failure Modes</strong></p>\n<ul>\n<li>All <code>debug</code> statements commented out:<ul>\n<li>The program crashes with the following:</li>\n</ul>\n</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>Roc crashed: Internal error: TypeMismatch in call_invoke_closure continuation\n</code></pre></div>\n<ul>\n<li>Only <code>(1)</code> uncommented, or <code>(1)</code> and <code>(2)</code> uncommnted:<ul>\n<li>crashes with the following:</li>\n</ul>\n</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>thread 43720 panic: reached unreachable code\nUnable to dump stack trace: debug info stripped\nAborted (core dumped)\n</code></pre></div>\n<ul>\n<li>Only <code>(2)</code>, <code>(3)</code>, or <code>(4)</code> uncommented:<ul>\n<li>Same as <em>all</em> commented out</li>\n</ul>\n</li>\n<li>Both <code>(1)</code> and <code>(3)</code> uncommented:<ul>\n<li>Debug <code>(1)</code> prints, but prints an empty list, even though not empty.  Dbg <code>(3)</code> does not print. The function completes successfully, and returns to main, where depending on main, the result may print via <code>Stdout.line!()</code>. Finally, the program crashes with a different error message:</li>\n</ul>\n</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>dbg: []\n209.0\n\nRoc crashed: call_invoke_closure: value_stack empty when popping function\n</code></pre></div>\n<ul>\n<li>Both <code>(1)</code> and <code>(4)</code> uncommented:<ul>\n<li>Debug <code>(1)</code> prints, but prints an empty list, even though not empty. Dbg <code>(4)</code> does not print. The function completes successfully, and returns to main, where depending on main, the result may print via <code>Stdout.line!()</code>. Finally, the program crashes with a different error message:</li>\n</ul>\n</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>dbg: []\n209.0\n\nRoc crashed: non-exhaustive match\n</code></pre></div>\n<ul>\n<li>Dbg <code>(1)</code> uncommented, and both <code>(3)</code> and <code>(4)</code> uncommented:<ul>\n<li>Debug <code>(1)</code> and <code>(3)</code> print, but <code>(1)</code> prints an empty list, even though not empty. Dbg <code>(4)</code> does not print. The function completes successfully, and returns to main, where depending on main, the result may print via <code>Stdout.line!()</code>. Finally, the program crashes with a different error message:</li>\n</ul>\n</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>dbg: []\ndbg: &quot;209.0&quot;\n209.0\n\nRoc crashed: non-exhaustive match\n</code></pre></div>\n<ul>\n<li>In any of the permutations that result in a return to main, IE: <code>(1)</code> and at least one of <code>(3)</code> or <code>(4)</code> uncommented, uncommenting <code>(2)</code> does not change the failure mode. However, instead of <code>dbg</code> <code>(2)</code> printing an integer value, it also prints an empty list as well. So uncommenting all results in the following:</li>\n</ul>\n<div class=\"codehilite\"><pre><span></span><code>dbg: []\ndbg: []\ndbg: &quot;209.0&quot;\n209.0\n\nRoc crashed: non-exhaustive match\n</code></pre></div>",
        "id": 565390228,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766696009
    },
    {
        "content": "<p>Note that <code>debug</code> is defined as:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nv\">debug</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">a</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">a</span>\n<span class=\"nv\">debug</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">v</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">dbg</span><span class=\"w\"> </span><span class=\"nx\">v</span>\n<span class=\"w\">    </span><span class=\"nx\">v</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 565390256,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766696051
    },
    {
        "content": "<p>I'll come back and document some of the other issues later, but for now, here is the full code file:</p>\n<div class=\"codehilite\" data-code-language=\"CoffeeScript\"><pre><span></span><code><span class=\"nx\">app</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"nx\">main</span><span class=\"o\">!</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"nv\">pf</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">platform</span><span class=\"w\"> </span><span class=\"s\">\"https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst\"</span><span class=\"w\"> </span><span class=\"p\">}</span>\n\n<span class=\"nx\">import</span><span class=\"w\"> </span><span class=\"nx\">pf</span><span class=\"p\">.</span><span class=\"nx\">Stdout</span>\n\n<span class=\"nx\">main</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">_args</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nv\">input</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">        </span><span class=\"err\">\\\\</span><span class=\"nx\">two1nine</span>\n<span class=\"w\">        </span><span class=\"err\">\\\\</span><span class=\"nx\">eightwothree</span>\n<span class=\"w\">        </span><span class=\"err\">\\\\</span><span class=\"nx\">abcone2threexyz</span>\n<span class=\"w\">        </span><span class=\"err\">\\\\</span><span class=\"nx\">xtwone3four</span>\n<span class=\"w\">        </span><span class=\"err\">\\\\</span><span class=\"mi\">4</span><span class=\"nx\">nineeightseven2</span>\n<span class=\"w\">        </span><span class=\"err\">\\\\</span><span class=\"nx\">zoneight234</span>\n<span class=\"w\">        </span><span class=\"err\">\\\\</span><span class=\"mi\">7</span><span class=\"nx\">pqrstsixteen</span>\n\n<span class=\"w\">    </span><span class=\"nx\">part1</span><span class=\"p\">(</span><span class=\"nx\">input</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"nf\">-&gt;</span><span class=\"nx\">Stdout</span><span class=\"p\">.</span><span class=\"nx\">line</span><span class=\"o\">!</span><span class=\"p\">()</span>\n\n<span class=\"w\">    </span><span class=\"c1\"># answer1 = part1(input)?-&gt;debug()-&gt;debug()-&gt;debug()</span>\n<span class=\"w\">    </span><span class=\"c1\"># dbg \"answer\"</span>\n<span class=\"w\">    </span><span class=\"c1\"># Stdout.line!(answer1)</span>\n\n<span class=\"w\">    </span><span class=\"nx\">Ok</span><span class=\"p\">({})</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">## Solve part 1</span>\n<span class=\"nv\">part1</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">Str</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Try</span><span class=\"p\">(</span><span class=\"nx\">Str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">_</span><span class=\"p\">)</span>\n<span class=\"nv\">part1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">s</span><span class=\"p\">.</span><span class=\"nx\">split_on</span><span class=\"p\">(</span><span class=\"s\">\"\\n\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"nf\">(extract_digits)</span>\n<span class=\"nf\">    -&gt;</span><span class=\"nx\">keep_oks</span><span class=\"nf\">(compute_calibration)</span>\n<span class=\"nf\">    -&gt;</span><span class=\"nx\">debug</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"c1\"># (1)</span>\n<span class=\"w\">    </span><span class=\"nf\">-&gt;</span><span class=\"nx\">sum</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"c1\"># -&gt;debug() # (2)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"nx\">to_str</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"c1\"># -&gt;debug() # (3)</span>\n<span class=\"w\">    </span><span class=\"nf\">-&gt;</span><span class=\"nx\">Ok</span>\n<span class=\"w\">    </span><span class=\"nf\">-&gt;</span><span class=\"nx\">debug</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"c1\"># (4)</span>\n<span class=\"p\">}</span>\n\n<span class=\"nv\">extract_digits</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">Str</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">List</span><span class=\"p\">(</span><span class=\"nx\">U64</span><span class=\"p\">)</span>\n<span class=\"nv\">extract_digits</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">s</span><span class=\"p\">.</span><span class=\"nx\">to_utf8</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"nx\">keep_if</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"nx\">c</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nx\">c</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"s\">'0'</span><span class=\"w\"> </span><span class=\"o\">and</span><span class=\"w\"> </span><span class=\"nx\">c</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"s\">'9'</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"nx\">c</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"s\">'0'</span><span class=\"p\">).</span><span class=\"nx\">to_u64</span><span class=\"p\">())</span>\n<span class=\"p\">}</span>\n\n<span class=\"nv\">compute_calibration</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">List</span><span class=\"nf\">(U64) -&gt;</span><span class=\"w\"> </span><span class=\"nx\">Try</span><span class=\"p\">(</span><span class=\"nx\">U64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">_</span><span class=\"p\">)</span>\n<span class=\"nv\">compute_calibration</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">digits</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nx\">Ok</span><span class=\"p\">(</span><span class=\"nx\">List</span><span class=\"p\">.</span><span class=\"nx\">first</span><span class=\"p\">(</span><span class=\"nx\">digits</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nx\">List</span><span class=\"p\">.</span><span class=\"nx\">last</span><span class=\"p\">(</span><span class=\"nx\">digits</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">)</span>\n\n<span class=\"c1\">## Solve part 2</span>\n<span class=\"nv\">part2</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">Str</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Try</span><span class=\"p\">(</span><span class=\"nx\">Str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">_</span><span class=\"p\">)</span>\n<span class=\"nv\">part2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">s</span><span class=\"p\">.</span><span class=\"nx\">split_on</span><span class=\"p\">(</span><span class=\"s\">\"\\n\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"nx\">map</span><span class=\"nf\">(extract_text_digits)</span>\n<span class=\"nf\">        -&gt;</span><span class=\"nx\">keep_oks</span><span class=\"nf\">(compute_calibration)</span>\n<span class=\"nf\">        -&gt;</span><span class=\"nx\">debug</span><span class=\"nf\">()</span>\n<span class=\"nf\">        -&gt;</span><span class=\"nx\">sum</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"nx\">to_str</span><span class=\"nf\">()</span>\n<span class=\"nf\">        -&gt;</span><span class=\"nx\">Ok</span>\n<span class=\"p\">}</span>\n\n<span class=\"nv\">extract_text_digits</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">Str</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">List</span><span class=\"p\">(</span><span class=\"nx\">U64</span><span class=\"p\">)</span>\n<span class=\"nv\">extract_text_digits</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">s</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nv\">bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nx\">s</span><span class=\"p\">.</span><span class=\"nx\">to_utf8</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">).</span><span class=\"nx\">to</span><span class=\"p\">(</span><span class=\"nx\">bytes</span><span class=\"p\">.</span><span class=\"nx\">len</span><span class=\"p\">())</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"nx\">fold</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"p\">[],</span>\n<span class=\"w\">            </span><span class=\"o\">|</span><span class=\"nx\">ds</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">i</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"nx\">match</span><span class=\"w\"> </span><span class=\"nx\">bytes</span><span class=\"p\">.</span><span class=\"nx\">drop_first</span><span class=\"p\">(</span><span class=\"nx\">i</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'o'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'n'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'t'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'w'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'o'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'t'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'h'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'r'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'f'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'o'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'u'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'r'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">4</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'f'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'i'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'v'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">5</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'s'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'i'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'x'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">6</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'s'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'v'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'n'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">7</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'i'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'g'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'h'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'t'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">8</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'n'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'i'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'n'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">9</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"s\">'z'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'e'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'r'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">'o'</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"w\">                    </span><span class=\"p\">[</span><span class=\"nx\">d</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">..]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"nx\">d</span><span class=\"w\"> </span><span class=\"o\">&gt;=</span><span class=\"w\"> </span><span class=\"s\">'0'</span><span class=\"w\"> </span><span class=\"o\">and</span><span class=\"w\"> </span><span class=\"nx\">d</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"s\">'9'</span><span class=\"w\"> </span><span class=\"nx\">ds</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">((</span><span class=\"nx\">d</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"s\">'0'</span><span class=\"p\">).</span><span class=\"nx\">to_u64</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"nx\">ds</span>\n<span class=\"w\">                    </span><span class=\"p\">[]</span><span class=\"w\"> </span><span class=\"nf\">=&gt;</span><span class=\"w\"> </span><span class=\"nx\">ds</span>\n<span class=\"w\">                </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">},</span>\n<span class=\"w\">        </span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n\n<span class=\"nv\">keep_oks</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">List</span><span class=\"p\">(</span><span class=\"nx\">a</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">a</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">Try</span><span class=\"p\">(</span><span class=\"nx\">b</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">e</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">List</span><span class=\"p\">(</span><span class=\"nx\">b</span><span class=\"p\">)</span>\n<span class=\"nv\">keep_oks</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">vs</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">f</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">vs</span><span class=\"p\">.</span><span class=\"nx\">fold</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"p\">[],</span>\n<span class=\"w\">        </span><span class=\"o\">|</span><span class=\"nx\">acc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">v</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"nx\">match</span><span class=\"w\"> </span><span class=\"nx\">f</span><span class=\"p\">(</span><span class=\"nx\">v</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"nx\">Ok</span><span class=\"nf\">(u) =&gt;</span><span class=\"w\"> </span><span class=\"nx\">acc</span><span class=\"p\">.</span><span class=\"nx\">append</span><span class=\"p\">(</span><span class=\"nx\">u</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"nx\">Err</span><span class=\"nf\">(_) =&gt;</span><span class=\"w\"> </span><span class=\"nx\">acc</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n\n<span class=\"nv\">sum</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">List</span><span class=\"nf\">(Num) -&gt;</span><span class=\"w\"> </span><span class=\"nx\">Num</span>\n<span class=\"nv\">sum</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">nums</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nx\">nums</span><span class=\"p\">.</span><span class=\"nx\">fold</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">acc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nx\">n</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"nx\">acc</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"nx\">n</span><span class=\"p\">)</span>\n\n<span class=\"nv\">debug</span><span class=\"w\"> </span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"nx\">a</span><span class=\"w\"> </span><span class=\"nf\">-&gt;</span><span class=\"w\"> </span><span class=\"nx\">a</span>\n<span class=\"nv\">debug</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"nx\">v</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nx\">dbg</span><span class=\"w\"> </span><span class=\"nx\">v</span>\n<span class=\"w\">    </span><span class=\"nx\">v</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 565390391,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766696301
    },
    {
        "content": "<p>I'll look into this!</p>",
        "id": 565393263,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1766700503
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"518883\">@Ian McLerran</span> I have a fix in <a href=\"https://github.com/roc-lang/roc/pull/8752/changes\">https://github.com/roc-lang/roc/pull/8752/changes</a> - just cleaning it up now</p>",
        "id": 565397398,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1766708802
    },
    {
        "content": "<p>tl;dr stack corruption in the interpreter - <code>dbg</code> was not really related, it just triggered the bug because involved the stack <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 565397420,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1766708837
    },
    {
        "content": "<p>Ahh, that makes sense! Changing the debug calls just changed the stack, hence the different results.</p>",
        "id": 565399182,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766711794
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"518883\">Ian McLerran</span> has marked this topic as resolved.</p>",
        "id": 565400000,
        "sender_full_name": "Notification Bot",
        "timestamp": 1766713226
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"518883\">Ian McLerran</span> has marked this topic as unresolved.</p>",
        "id": 565403054,
        "sender_full_name": "Notification Bot",
        "timestamp": 1766717814
    },
    {
        "content": "<p>Thanks for tackling this <span class=\"user-mention\" data-user-id=\"281383\">@Richard Feldman</span>! I built off the latest main, and I can see that most of the failure modes are fixed! (I can remove all the debugs, and the program compiles, regardless of whether I print from the pipe, or save the value and print)</p>\n<p>Looks like this code also raises a couple other bugs if I reintroduce some <code>debug()</code> calls:<br>\n1) If I reintroduce <code>(1)</code> and <code>(2)</code>:</p>\n<p>- debug <code>(2)</code> prints an empty list, where it should print the integer value \"209\"<br>\n2) If I reintroduce <code>(2)</code>, <code>(3)</code>, or <code>(4)</code> only:</p>\n<p>- crashes with: <code>Roc crashed: Internal error: TypeMismatch in call_invoke_closure continuation</code></p>",
        "id": 565404022,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1766719127
    },
    {
        "content": "<p>ah interesting! I'll follow up!</p>",
        "id": 565404047,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1766719167
    },
    {
        "content": "<p>Seems like the behavior of this code has changed since 20 days ago. Now when I build, regardless of dbg statements included (or not included), the program will build, but then crashes at run time with:</p>\n<div class=\"codehilite\"><pre><span></span><code>Roc crashed: Error evaluating: NotNumeric\n</code></pre></div>",
        "id": 568033095,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1768409126
    },
    {
        "content": "<p>I will minimize this and make an issue</p>",
        "id": 568036657,
        "sender_full_name": "Anton",
        "timestamp": 1768410041
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/issues/9020\">#9020</a> I have described a workaround there as well</p>",
        "id": 568042875,
        "sender_full_name": "Anton",
        "timestamp": 1768411729
    },
    {
        "content": "<p>Thanks Anton!</p>",
        "id": 568042996,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1768411764
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"361169\">@Anton</span> Great work chopping that thing down! I was trying to do the same but did not get nearly this far! <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 568045883,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1768412698
    },
    {
        "content": "<p>Just looking at your reproduction and work around... I see your repro was using a local closure, and the work around is to move the local closure to a top level closure. </p>\n<p>It looks like the local closure <code>f</code> in your code corresponds to <code>compute_calibration</code> in my code, but in my code, <code>compute_calibration</code> is top level, not local... Seems like there might be something else going on here?</p>",
        "id": 568045903,
        "sender_full_name": "Ian McLerran",
        "timestamp": 1768412703
    },
    {
        "content": "<p>Yeah, it seems like a complex interaction, I have included your original code as well to make sure it works when the issue appears to be fixed.</p>",
        "id": 568055108,
        "sender_full_name": "Anton",
        "timestamp": 1768415701
    }
]
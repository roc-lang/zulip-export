[
    {
        "content": "<p>I have ~1 hour to look into this starting now, so good chance I can't resolve it. Repro:</p>\n<div class=\"codehilite\" data-code-language=\"roc\"><pre><span></span><code>module []\n# happens with strings of length 24 and above\nexpect(\"123456789012345678901234\" != \"\")\n</code></pre></div>\n<p>run <code>roc test</code></p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Error message + stack trace:</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>ez@desktop-nixos ~/c/testing-roc&gt; ~/code/roc/zig-out/bin/roc test<br>\nthread 35891 panic: Use-after-free: decref on already-freed memory<br>\n/home/ez/code/roc/src/builtins/utils.zig:459:13: 0x4e5802c in decref (mod.zig)<br>\n            @panic(\"Use-after-free: decref on already-freed memory\");<br>\n            ^<br>\n/home/ez/code/roc/src/builtins/str.zig:235:40: 0x4bce7a6 in decref (mod.zig)<br>\n            @import(\"utils.zig\").decref(self.getAllocationPtr(), self.capacity_or_alloc_ptr, RocStr.alignment, false, roc_ops);<br>\n                                       ^<br>\n/home/ez/code/roc/src/eval/StackValue.zig:1416:31: 0x497ddf5 in decref (mod.zig)<br>\n                roc_str.decref(ops);<br>\n                              ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:11865:33: 0x4e2c032 in applyContinuation (mod.zig)<br>\n                defer lhs.decref(&amp;self.runtime_layout_store, roc_ops);<br>\n                                ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:8191:71: 0x4bcdd00 in evalWithExpectedType (mod.zig)<br>\n                    const should_continue = try self.applyContinuation(&amp;work_stack, &amp;value_stack, cont, roc_ops);<br>\n                                                                      ^<br>\n/home/ez/code/roc/src/eval/interpreter.zig:492:45: 0x497d91d in eval (mod.zig)<br>\n        return try self.evalWithExpectedType(expr_idx, roc_ops, null);<br>\n                                            ^<br>\n/home/ez/code/roc/src/eval/test_runner.zig:198:49: 0x49bfe29 in eval (mod.zig)<br>\n        const result = try self.interpreter.eval(expr_idx, ops);<br>\n                                                ^<br>\n/home/ez/code/roc/src/eval/test_runner.zig:223:41: 0x4784e13 in eval_all (mod.zig)<br>\n                const result = self.eval(stmt.s_expect.body) catch |err| {<br>\n                                        ^<br>\n/home/ez/code/roc/src/cli/main.zig:3142:41: 0x47cd63a in rocTest (main.zig)<br>\n    const summary = test_runner.eval_all() catch |err| {<br>\n                                        ^<br>\n/home/ez/code/roc/src/cli/main.zig:576:41: 0x47eb492 in mainArgs (main.zig)<br>\n        .test_cmd =&gt; |test_args| rocTest(allocs, test_args),<br>\n                                        ^<br>\n/home/ez/code/roc/src/cli/main.zig:508:13: 0x47ed503 in main (main.zig)<br>\n    mainArgs(&amp;allocs, args) catch {<br>\n            ^<br>\n/home/ez/opt/zig/lib/std/start.zig:627:37: 0x47edac1 in main (std.zig)<br>\n            const result = root.main() catch |err| {<br>\n                                    ^<br>\n/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c:95:7: 0x944204c in libc_start_main_stage2 (/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c)<br>\n exit(main(argc, argv, envp));<br>\n      ^<br>\n???:?:?: 0x934f309 in ??? (???)<br>\nUnwind error at address <code>exe:0x934f309</code> (error.MissingFDE), trace may be incomplete</p>\n<p>fish: Job 1, '~/code/roc/zig-out/bin/roc test' terminated by signal SIGABRT (Abort)</p>\n</div></div>",
        "id": 561255715,
        "sender_full_name": "Norbert Hajagos",
        "timestamp": 1764616831
    },
    {
        "content": "<p>I can fix this, thanks for the repro!</p>",
        "id": 561258144,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764617599
    },
    {
        "content": "<p>Np! Meanwhile expanding my mind about the interpreter so that next time I can fix it too :)</p>",
        "id": 561262033,
        "sender_full_name": "Norbert Hajagos",
        "timestamp": 1764618951
    },
    {
        "content": "<p>I'm pretty sure this is fixed in <a href=\"https://github.com/roc-lang/roc/pull/8527\">https://github.com/roc-lang/roc/pull/8527</a><br>\nIt's the same issue as <a href=\"https://github.com/roc-lang/roc/issues/8525\">https://github.com/roc-lang/roc/issues/8525</a> I think</p>",
        "id": 561264741,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1764619851
    },
    {
        "content": "<p>I know you're on it, but I'm just using this issue to learn. Sharing  this, since first time I used the Zed debugger:<br>\ndefer -ed decref on lhs and rhs: <a href=\"https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11865\">https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11865</a></p>\n<p>looping through the [lhs, rhs] array and decref-ing them.<br>\n<a href=\"https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11962-L11969\">https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11962-L11969</a></p>",
        "id": 561264826,
        "sender_full_name": "Norbert Hajagos",
        "timestamp": 1764619877
    },
    {
        "content": "<p><a href=\"https://github.com/roc-lang/roc/pull/8535\">https://github.com/roc-lang/roc/pull/8535</a> includes a fix for this!</p>",
        "id": 561280458,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764625083
    },
    {
        "content": "<p>it was still reproducing on there</p>",
        "id": 561280501,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764625097
    },
    {
        "content": "<p>so the earlier PRs didn't fix it</p>",
        "id": 561280526,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1764625107
    }
]
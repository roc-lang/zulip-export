[
    {
        "content": "<p>Here is my solution of part 1:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>day 3 part1</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">main!</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"ss\">pf</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">platform</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst\"</span><span class=\"w\"> </span><span class=\"p\">}</span>\n\n<span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"o\">.</span><span class=\"n\">Stdout</span>\n\n<span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"o\">.</span><span class=\"n\">Stdin</span>\n\n<span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">_</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$sum</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$str</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">Stdin</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">()</span>\n\n<span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"vg\">$str</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n\n<span class=\"w\">        </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"vg\">$str</span><span class=\"o\">.</span><span class=\"n\">to_utf8</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">c</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"no\">U8</span><span class=\"o\">.</span><span class=\"n\">to_u64</span><span class=\"p\">(</span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"s1\">'0'</span><span class=\"p\">))</span>\n\n<span class=\"w\">        </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$next_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"w\">        </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"w\">        </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$next_max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">drop_last</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">num</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n\n<span class=\"w\">                </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">num</span>\n\n<span class=\"w\">                </span><span class=\"vg\">$next_max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n\n<span class=\"w\">            </span><span class=\"p\">}</span>\n\n<span class=\"w\">            </span><span class=\"k\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"o\">.</span><span class=\"n\">ok_or</span><span class=\"p\">(</span><span class=\"no\">List</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">line</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"vg\">$next_index</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span>\n\n<span class=\"w\">            </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">next</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"vg\">$next_max</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n\n<span class=\"w\">                </span><span class=\"vg\">$next_max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">next</span>\n\n<span class=\"w\">            </span><span class=\"p\">}</span>\n\n<span class=\"w\">            </span><span class=\"vg\">$next_index</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"vg\">$next_index</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n\n<span class=\"w\">        </span><span class=\"p\">}</span>\n\n<span class=\"w\">        </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"vg\">$next_max</span>\n\n<span class=\"w\">        </span><span class=\"vg\">$sum</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"vg\">$sum</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">result</span>\n\n<span class=\"w\">        </span><span class=\"vg\">$str</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">Stdin</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">()</span>\n\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"no\">Stdout</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">(</span><span class=\"s2\">\"Result: ${$sum.to_str()}\"</span><span class=\"p\">)</span>\n\n<span class=\"w\">    </span><span class=\"no\">Ok</span><span class=\"p\">({})</span>\n\n<span class=\"p\">}</span>\n</code></pre></div>\n</div></div>\n<p>It's quite slow (about 2 and a half minutes on my machine) and I had to overcome the following bugs I found: <a href=\"https://github.com/roc-lang/roc/issues/8662\">#8662</a> <a href=\"https://github.com/roc-lang/roc/issues/8663\">#8663</a> <a href=\"https://github.com/roc-lang/roc/issues/8664\">#8664</a></p>\n<p>Also is a <code>break</code> keyword planned to exit loops early?</p>",
        "id": 563630016,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1765641401
    },
    {
        "content": "<p>Nice, I’m working on mine too :)<br>\nPS, you can do a code block inside of the spoiler block, to have the content formatted correctly</p>",
        "id": 563633329,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765644565
    },
    {
        "content": "<p>Here is my day 3 part 1 too :)</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>day 3 part 1</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<div class=\"codehilite\" data-code-language=\"Ruby\"><pre><span></span><code><span class=\"c1\"># cat ../inputs/XX.txt | roc dayXX.roc</span>\n\n<span class=\"n\">app</span><span class=\"w\"> </span><span class=\"o\">[</span><span class=\"n\">main!</span><span class=\"o\">]</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"ss\">pf</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"n\">platform</span><span class=\"w\"> </span><span class=\"s2\">\"https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst\"</span><span class=\"w\"> </span><span class=\"p\">}</span>\n\n<span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"o\">.</span><span class=\"n\">Stdout</span>\n<span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">pf</span><span class=\"o\">.</span><span class=\"n\">Stdin</span>\n\n<span class=\"n\">demo_input</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">987654321111111</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">811111111111119</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">234234234234278</span>\n<span class=\"w\">    </span><span class=\"p\">\\\\</span><span class=\"mi\">818181911112111</span>\n\n\n<span class=\"n\">main!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">_args</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">match</span><span class=\"w\"> </span><span class=\"n\">run!</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"no\">Ok</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">Ok</span><span class=\"p\">({})</span>\n<span class=\"w\">        </span><span class=\"no\">Err</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">Err</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">run!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">demo_input_lines</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">demo_input</span><span class=\"o\">.</span><span class=\"n\">trim</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">split_on</span><span class=\"p\">(</span><span class=\"s2\">\"</span><span class=\"se\">\\n</span><span class=\"s2\">\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">day_input_lines</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">read_input!</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"no\">Stdout</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">(</span><span class=\"s2\">\"Part 1 (demo): ${part1!(demo_input_lines)?.to_str()}\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"no\">Stdout</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">(</span><span class=\"s2\">\"Part 1: ${part1!(day_input_lines)?.to_str()}\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"c1\">#Stdout.line!(\"Part 2 (demo): ${part2!(demo_input_lines)?.to_str()}\")</span>\n<span class=\"w\">    </span><span class=\"c1\">#Stdout.line!(\"Part 2: ${part2!(day_input_lines)?.to_str()}\")</span>\n<span class=\"w\">    </span><span class=\"no\">Ok</span><span class=\"p\">({})</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\"># Helper function to read input from stdin</span>\n<span class=\"n\">read_input!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">List</span><span class=\"p\">(</span><span class=\"no\">Str</span><span class=\"p\">)</span>\n<span class=\"n\">read_input!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$lines</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">[]</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$continue</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">True</span>\n<span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"vg\">$continue</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">Stdin</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"c1\"># Empty string indicates EOF in this platform</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"s2\">\"\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"vg\">$continue</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">False</span>\n<span class=\"w\">        </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"vg\">$lines</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"vg\">$lines</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">(</span><span class=\"n\">line</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"vg\">$lines</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">part1!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">List</span><span class=\"p\">(</span><span class=\"no\">Str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"p\">(</span><span class=\"no\">U64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span>\n<span class=\"n\">part1!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">input</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$sum</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">input</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"no\">Stdout</span><span class=\"o\">.</span><span class=\"n\">line!</span><span class=\"p\">(</span><span class=\"n\">line</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"c1\"># ASCII digits 0-9 are encoded as bytes 48-57</span>\n<span class=\"w\">        </span><span class=\"n\">digits</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">line</span><span class=\"o\">.</span><span class=\"n\">to_utf8</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">byte</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"mi\">48</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"vg\">$sum</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"vg\">$sum</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">max_two_digits_fast!</span><span class=\"p\">(</span><span class=\"n\">digits</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"no\">Ok</span><span class=\"p\">(</span><span class=\"vg\">$sum</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\"># Complexity O(n^2)</span>\n<span class=\"n\">max_two_digits_naive!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">List</span><span class=\"p\">(</span><span class=\"no\">U8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">U64</span>\n<span class=\"n\">max_two_digits_naive!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">digits</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\"># We make the assumptions that 0 &lt; number of digits &lt; 256</span>\n<span class=\"w\">    </span><span class=\"c1\"># Would be nice to have U64.until also like U8</span>\n<span class=\"w\">    </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">digits</span><span class=\"o\">.</span><span class=\"n\">len</span><span class=\"p\">()</span><span class=\"o\">.</span><span class=\"n\">to_u8_wrap</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"n\">indices</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"no\">U8</span><span class=\"o\">.</span><span class=\"n\">until</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"p\">)</span><span class=\"o\">.</span><span class=\"n\">map</span><span class=\"p\">(</span><span class=\"no\">U8</span><span class=\"o\">.</span><span class=\"n\">to_u64</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">indices</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">d1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"no\">U8</span><span class=\"o\">.</span><span class=\"n\">to_u64</span><span class=\"p\">(</span><span class=\"no\">Try</span><span class=\"o\">.</span><span class=\"n\">ok_or</span><span class=\"p\">(</span><span class=\"no\">List</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"n\">digits</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">i</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">))</span>\n<span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">digits</span><span class=\"o\">.</span><span class=\"n\">drop_first</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">d1</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"o\">.</span><span class=\"n\">to_u64</span><span class=\"p\">()</span>\n<span class=\"w\">            </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"vg\">$max</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\"># Complexity O(2n)</span>\n<span class=\"n\">max_two_digits_fast!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">List</span><span class=\"p\">(</span><span class=\"no\">U8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">U64</span>\n<span class=\"n\">max_two_digits_fast!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">digits</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\"># Start by building a list with the maximum of the rest of the digits</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">_m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">max_rest</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">digits</span><span class=\"o\">.</span><span class=\"n\">fold_rev</span><span class=\"p\">((</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">[]</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">d</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">m</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rest</span><span class=\"p\">)</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">new_max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">new_max</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rest</span><span class=\"o\">.</span><span class=\"n\">append</span><span class=\"p\">((</span><span class=\"n\">d</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">)))</span>\n<span class=\"w\">    </span><span class=\"p\">})</span>\n<span class=\"w\">    </span><span class=\"c1\"># Drop the first element of the max_rest list, since it doesn’t correspond to a pair of digits</span>\n<span class=\"w\">    </span><span class=\"c1\"># Then find the max in the list</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">d1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">max_rest</span><span class=\"o\">.</span><span class=\"n\">drop_first</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"n\">d1</span><span class=\"o\">.</span><span class=\"n\">to_u64</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">d2</span><span class=\"o\">.</span><span class=\"n\">to_u64</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"vg\">$max</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"vg\">$max</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">fold_range</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">U64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">U64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"no\">U64</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">-&gt;</span><span class=\"w\"> </span><span class=\"n\">state</span>\n<span class=\"n\">fold_range</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">start</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">end</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">init</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$acc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">init</span>\n<span class=\"w\">    </span><span class=\"n\">var</span><span class=\"w\"> </span><span class=\"vg\">$i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">start</span>\n<span class=\"w\">    </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"vg\">$i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"k\">end</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"vg\">$acc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">(</span><span class=\"vg\">$acc</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"vg\">$i</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"vg\">$i</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"vg\">$i</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"vg\">$acc</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">part2!</span><span class=\"w\"> </span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"no\">List</span><span class=\"p\">(</span><span class=\"no\">Str</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"no\">Try</span><span class=\"p\">(</span><span class=\"no\">U64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"p\">)</span>\n<span class=\"n\">part2!</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">input</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">part1!</span><span class=\"p\">(</span><span class=\"n\">input</span><span class=\"p\">)</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n</div></div>\n<p>It took 6 min to solve and up to roughly 8GB of ram. What’s (not so) funny to see is how the interpreter slows down little by little while in theory, there is no reason for the slowdown. I mean no reason why processing each line of the puzzle input should take longer and longer with time passing. So I suppose there is something in the interpreter VM which grows linearly with time and that needs to be accessed for every instruction.</p>",
        "id": 563647755,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765661781
    },
    {
        "content": "<p>Here is a video recording of the solution being computed. I cut the video in the middle (where nothing happens) and made it 8x faster than realtime to not bore you. But you can still clearly see how slower the last few lines of the puzzle input are to be processed compared to the first few ones.</p>\n<p><a href=\"/user_uploads/22008/7-VOV9wfNBkETPDuG4QT74cx/roc-day3-part1-8x-short.mp4\">roc-day3-part1-8x-short.mp4</a></p>\n<div class=\"message_inline_image message_inline_video\"><a href=\"/user_uploads/22008/7-VOV9wfNBkETPDuG4QT74cx/roc-day3-part1-8x-short.mp4\" title=\"roc-day3-part1-8x-short.mp4\"><video preload=\"metadata\" src=\"/user_uploads/22008/7-VOV9wfNBkETPDuG4QT74cx/roc-day3-part1-8x-short.mp4\"></video></a></div>",
        "id": 563647850,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765661916
    },
    {
        "content": "<p>Here is my input puzzle in case you want to try to reproduce it exactly.</p>\n<p><a href=\"/user_uploads/22008/klFzxSjfIsJGSoHEci8Muq2M/03.txt\">03.txt</a></p>",
        "id": 563647984,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765662102
    },
    {
        "content": "<p>ok I'm pretty convinced it's worth going back to a dev backend <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 563652298,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765667835
    },
    {
        "content": "<p>what’s a dev backend?</p>",
        "id": 563675097,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765704637
    },
    {
        "content": "<p>Backend in the sense of compiler backend. The part of the compiler that generates the actual machine code. We will use LLVM for this for release builds because it has a lot of optimizations and generates fast code. But it takes forever to generate that code, so in the old Rust compiler there is a dev backend that generates not so optimized code quickly to run during development. The idea was that an interpreter might be better than a dev backend, but as you showed it's slow.</p>",
        "id": 563675345,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1765704975
    },
    {
        "content": "<p>There doesn’t exist an alternative to LLVM specialized for this use case? Focused only on code optimizations that are the most worth it and the least time consuming to get to an executable as fast as possible?</p>",
        "id": 563675652,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765705324
    },
    {
        "content": "<p>Quick search seems to suggest using cranelift for this, as it’s apparently quite fast and supports multiple architectures. Is that what you had in mind?</p>",
        "id": 563676100,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765705925
    },
    {
        "content": "<p>Cranelift is in between llvm and what we already did for the Rust compiler (which can be ported over to Zig) - which is to go straight from our monomorphized IR to machine code</p>",
        "id": 563692653,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765722485
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"281383\">Richard Feldman</span> <a href=\"#narrow/channel/358903-advent-of-code/topic/2025.20Day.203/near/563652298\">said</a>:</p>\n<blockquote>\n<p>ok I'm pretty convinced it's worth going back to a dev backend <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>\n</blockquote>\n<p>Hmmm... Why? For perf?</p>\n<p>Pretty clearly languages have made relatively performant interpretters. I'm sure roc could do this.</p>",
        "id": 563700834,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765731926
    },
    {
        "content": "<p>We currently have a young, likely quite slow interpretter. I mean currently it is a tree walking interpreter that is very unoptimized in how it handles refcounts (and thus allocations)</p>",
        "id": 563700898,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765732012
    },
    {
        "content": "<p>Though I guess if you care maximally about the dev mode experience, it would probably be an interpreter with jit. For fast start and fast peak perf.</p>",
        "id": 563701018,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765732142
    },
    {
        "content": "<p>I guess I just feel that there are likely large well trodden paths to making a way more optimized interpretter.</p>",
        "id": 563701124,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765732256
    },
    {
        "content": "<p>A good metric would be to port the code to equivalent python or pypy or js or lua or etc. See where perf can be and how that compares to a debug build of some compiled language with recounting (might have to manually add in the recounting to some language).</p>",
        "id": 563701243,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765732372
    },
    {
        "content": "<p>Yeah, ported to python or node, this runs in like 60 ms. So I see this as clearly our interpreter is slow, not that we need a dev backend.</p>\n<p>That said, part of building a better interpreter may overlap with dev backend like constructions (e.g. compiling to a monomorphized linear bitcode).</p>",
        "id": 563702345,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765733726
    },
    {
        "content": "<p>yeah like - previously we had a dev backend with zero perf problems for either small or big examples</p>",
        "id": 563702676,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765734140
    },
    {
        "content": "<p>we went with an interpreter this time partly for constant folding but also bc we didn't have any other backend</p>",
        "id": 563702703,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765734177
    },
    {
        "content": "<p>I big reason for the interpreter is for fast startup time without dealing with surgical linker.</p>",
        "id": 563702751,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765734236
    },
    {
        "content": "<p>but it's like - yeah we could try to optimize this interpreter and JIT and all that...but wouldn't it be simpler to go back to the design that had neither slow startup problems in practice nor performance problems once it got running?</p>",
        "id": 563702759,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765734242
    },
    {
        "content": "<blockquote>\n<p>slow startup problems in practice</p>\n</blockquote>\n<p>It will without a surgical linker on all platforms.</p>",
        "id": 563702772,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765734271
    },
    {
        "content": "<p>we don't need to do surgical linking anymore though - the current \"embed the interpreter shim\" design can just as easily do \"embed an even thinner shim that just executes the bytes we give it\"</p>",
        "id": 563702824,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765734323
    },
    {
        "content": "<p>Hmm. Launch the same way a jit would launch a compiled function</p>",
        "id": 563702870,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765734373
    },
    {
        "content": "<p>That is a nice simple idea.</p>",
        "id": 563702875,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765734383
    },
    {
        "content": "<p>Ok yeah, then same cost of one linked unit that is more costly, but it is one off.</p>",
        "id": 563702908,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765734423
    },
    {
        "content": "<p>yeah so in that world, hosts are still pre-linked like they are today</p>",
        "id": 563702917,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765734432
    },
    {
        "content": "<p>You still may want an interpreter on the lowest bitcode that would get converted into dev backend assembly. (and it might be best to start by working towards that).</p>\n<p>The interpreter at that level would make it so you immediately support all platforms (x86, arm, risc5, wasm, etc). Then if you want more perf, you could just nearly 1:1 map from the low level interpreter to assembly.</p>",
        "id": 563703025,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765734558
    },
    {
        "content": "<p>Aside, I had claude hack together some really awful c++ code that is trying to model what debug backend roc would actually run here. Takes ~150ms to run.</p>",
        "id": 563703586,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765735229
    },
    {
        "content": "<p>since we already have something that works (although too slowly) I was thinking we'd do the same progression as last time:</p>\n<ul>\n<li>get monomorphization and llvm working, at which point we have <code>--optimize</code> working for real</li>\n<li>at that point we have all the infray in place for dev backends, so we port them over and we're all set</li>\n</ul>",
        "id": 563703867,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765735464
    },
    {
        "content": "<p>I would advise not just monomorphizing, but also flattening the IR. I think that will make it easier to generate both llvm ir and dev backend  assembly. The flattened IR might also be a better setup for refcounting and some optimizations.</p>",
        "id": 563704384,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765736095
    },
    {
        "content": "<p>And yeah, llvm first sounds totally reasonable</p>",
        "id": 563704396,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765736109
    },
    {
        "content": "<blockquote>\n<p>which is to go straight from our monomorphized IR to machine code</p>\n</blockquote>\n<p>Isn’t that a lot of maintenance to have something running in a few different architectures? I mean I could imagine x86, arm, and RiscV sharing non-negligible shares in a few years. I’m curious, with something like cranelift (Roc IR -&gt; Cranelift IR -&gt; binary) + regular linking but done with good practice (reduce object count, static linking, ...) and a fast linker like mold, how far is this from the targets you have for Roc?</p>",
        "id": 563704714,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765736600
    },
    {
        "content": "<p>\"Sharing non-negligible shares in a few years\"</p>\n<p>What do you mean by this?</p>",
        "id": 563704799,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765736707
    },
    {
        "content": "<p>I mean if like a few years down, we see market shares like 50% / 30% / 20% or similar. No dominant one.</p>",
        "id": 563704831,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765736755
    },
    {
        "content": "<p>I think there is some risk with the long tail of odd variations of arm/risc5 for embedded, but having a dev backend for x86, arm, and risc5 shouldn't particularly be hard.</p>",
        "id": 563704938,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765736865
    },
    {
        "content": "<p>The dev backend in the rust compiler supports x86 and arm already. Not totally filled out, but definitely the core. And we had a separate dev backend for wasm. So many of these things already worked.</p>",
        "id": 563704995,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765736947
    },
    {
        "content": "<p>The core part is that these are dev backends and have essentially no optimizations. They really just dump a handful of raw machine code bytes for any given roc ir node.</p>",
        "id": 563705060,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737022
    },
    {
        "content": "<p>They do have a few minor optimizations, but those are all shared between all backends.</p>",
        "id": 563705095,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737046
    },
    {
        "content": "<p>I suppose there is still things like TCO, in-place memory mutations and others important optimizations like that happening for all backends right?</p>",
        "id": 563705177,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765737143
    },
    {
        "content": "<p>yes</p>",
        "id": 563705184,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737158
    },
    {
        "content": "<p>As I see cranelift, is that it is not particularly compelling for dev builds cause it is not particularly fast at compilation. It is great as a slightly optimize alternative to llvm, but when you really just want to blit out machine code and want to run so fast as to compete with interpreter startup time, it is really slow.</p>\n<p>dev build -&gt; fastest compilation time, compete with optimized interpreters for execution speed<br>\ncranelift -&gt; ok compilation time, rather solid base optimization for execution speed<br>\nllvm -&gt; slow to exceptionally slow compilation time, any execution speed level you want to target</p>",
        "id": 563705343,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737325
    },
    {
        "content": "<p>For linkers, mold is mostly faster for larger link jobs. So for small apps and dev builds it is not a huge help. Even really basic linking tends to really hurt experience for tiny apps. You feel it if every run of the compiler has an extra 500ms to link before execution.</p>",
        "id": 563705478,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737481
    },
    {
        "content": "<p>In my mind, for dev builds we compete with a python like experience. In release builds, we compete with a go like experience.</p>",
        "id": 563705519,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737542
    },
    {
        "content": "<p>I mean in the end as a user, I don’t care if my program takes 50ms or 200ms. It’s cool to have superfast responses technically but yeah user experience mostly feel instantaneous below 0.2s</p>",
        "id": 563705524,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765737549
    },
    {
        "content": "<p>Yeah, but your bar was rightfully somewhere around 200ms. Linking the full dependencies that a platform takes will often push you to 500ms to 1000ms right from the starting point.</p>",
        "id": 563705589,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737628
    },
    {
        "content": "<p>I used to do a lot of image processing and data processing, and was using Rust. And in this context, not compiling in --release mode was not even an option. Because I would get programs like 100x slower in debug builds. So that’s why I’m always suspicious of the actual usefulness of unoptimized compilations.</p>",
        "id": 563705629,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765737675
    },
    {
        "content": "<p>That's totally fair. There are many cases where you always need at least the equivalent of <code>-O</code>.</p>",
        "id": 563705661,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737712
    },
    {
        "content": "<p>One nice thing with roc is that the platform can always be compiled with <code>-O3</code> equivalents. So you get a very python style tradeoff in dev builds. If enough of the heavy lifting is in the platform than roc perf doesn't really matter, it is just glue.</p>",
        "id": 563705707,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737765
    },
    {
        "content": "<p>For cases like you mentioned above in general, our hope is that our release compile times can compete with go/D/other considered fast compiler. Different target for total compilation time, but trying to keep things fast and smooth for you.</p>",
        "id": 563705779,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737856
    },
    {
        "content": "<p>That may be hard when comparing to compilers that do not use LLVM, but as long as we break down our compilation unit to enable more incremental compilation and caching, I'm sure we can manage a lot.</p>",
        "id": 563705845,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765737935
    },
    {
        "content": "<p>In your opinion, how fast could the roc interpreter be, without spending way too much on optimizing it? For reference, I converted my solution to python, doing the same thing, and the python solution took 30ms. (Roc took 6 min).</p>",
        "id": 563707215,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765739928
    },
    {
        "content": "<p>But obv there is the question of is it worth it if a dev backend is the goal? I suppose you still need something to compute all the constants right?</p>",
        "id": 563707359,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765740175
    },
    {
        "content": "<p>I think it definitely should be able to reach a similar speed to python.</p>",
        "id": 563708021,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765741037
    },
    {
        "content": "<p>yeah, but the dev backend approach should be much faster than Python <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 563715160,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765750120
    },
    {
        "content": "<p>For sure. I tried to port this to the old compiler dev backend (but segfault). So instead, old compiler with dev llvm build. Which should be pretty similar. Python takes in the range of 50-60ms. Dev backend executable takes in the range of 10-20ms. </p>\n<p>That said, old compiler takes like 60ms for the frontend to process all of the basic cli roc files and builtins, so that would make us slower than python in total time for this app. Roughly in the same ballpark though.</p>",
        "id": 563717059,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765753076
    },
    {
        "content": "<p>But why is our interpreter so much slower than Python? I feel like there is probably some very low hanging fruit we can get after that will speed our current interpreter up heaps</p>",
        "id": 563717238,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765753291
    },
    {
        "content": "<p>I tried asking Claude to give me a review of the overall architecture of the compiler, which was a very interesting read for me. And then, with that context in mind, asked it if it could assess what are potential issues making this program slow. Here is what it gave me. </p>\n<p><a href=\"/user_uploads/22008/VWaYXmOGlnDmMqzpyT6hvlg2/INTERPRETER_PERFORMANCE_ANALYSIS.md\">INTERPRETER_PERFORMANCE_ANALYSIS.md</a></p>\n<p>I wouldn’t take anything for granted, but with your knowledge of the compiler, you probably can easily distinguish what makes sense or not in its report.</p>",
        "id": 563717808,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765754063
    },
    {
        "content": "<p>I always made the assumptions when writing the roc code that some of the things Richard presented are present. But if things some things like in-place replacement of lists when RC is 1 are not in the interpreter, it could be a high cost for the way I wrote that. Considering the program took 8GB of ram, there is also most likely an issue with not deallocating intermediate values, there might be degradations of the stack or other parts of the interpreter that keep references to things.</p>",
        "id": 563718083,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765754497
    },
    {
        "content": "<p>Yeah these are the kinds of low hanging fruit I'm thinking about...</p>",
        "id": 563718123,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765754559
    },
    {
        "content": "<p>the analysis seems pretty bad to me haha</p>",
        "id": 563718359,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765754825
    },
    {
        "content": "<p>as in, seems like a lot of naive guessing</p>",
        "id": 563718370,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765754844
    },
    {
        "content": "<p>could be that in-place optimizations are not working, but also could be that the analysis isn't aware they exist <span aria-label=\"smile\" class=\"emoji emoji-1f604\" role=\"img\" title=\"smile\">:smile:</span></p>",
        "id": 563718387,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765754883
    },
    {
        "content": "<p>that one's certainly worth looking into though! I forget if in-place is in <code>list.zig</code> or outside it</p>",
        "id": 563718420,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765754923
    },
    {
        "content": "<p>the <code>pushInPlace</code>function in <code>list.zig</code> for example is not used anywhere else in <code>src/</code> than in the <code>list.zig</code> file in its tests. So I suppose the interpreter never does the push in place optimization for example.</p>",
        "id": 563718783,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765755466
    },
    {
        "content": "<p>Yeah I wasn't saying I agree with that analysis... just that the general vibe I have is we have a lot of optimisations we can work through that should speed us up a lot. Like we don't have tail recursion yet the plan is to support TRMC etc</p>",
        "id": 563718870,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765755564
    },
    {
        "content": "<p>What is the appropriate way to instrument the interpreter to add some stderr outputs to the program execution? When I try to add some, the compiler is unhappy because it’s not wasm-compatible.</p>",
        "id": 563719113,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765755938
    },
    {
        "content": "<p>If you do something like <code>!= .freestanding</code> or whatever so it doesn't try to build in the playground you should be fine</p>",
        "id": 563719196,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765756055
    },
    {
        "content": "<p>Here's an example of how the tracing for refcounting is done</p>\n<div class=\"codehilite\" data-code-language=\"Zig\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kr\">comptime</span><span class=\"w\"> </span><span class=\"n\">trace_refcount</span><span class=\"w\"> </span><span class=\"k\">and</span><span class=\"w\"> </span><span class=\"n\">builtin</span><span class=\"p\">.</span><span class=\"n\">os</span><span class=\"p\">.</span><span class=\"n\">tag</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">freestanding</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">stderr_file</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"n\">fs</span><span class=\"p\">.</span><span class=\"n\">File</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">stderr</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kr\">var</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">256</span><span class=\"p\">]</span><span class=\"kt\">u8</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">undefined</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">.</span><span class=\"n\">fmt</span><span class=\"p\">.</span><span class=\"n\">bufPrint</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">buf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"[INTERP] upsertBinding from temp_binds ptr=0x{x}</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">.{</span>\n<span class=\"w\">        </span><span class=\"nb\">@intFromPtr</span><span class=\"p\">(</span><span class=\"n\">binding</span><span class=\"p\">.</span><span class=\"n\">value</span><span class=\"p\">.</span><span class=\"n\">ptr</span><span class=\"p\">),</span>\n<span class=\"w\">    </span><span class=\"p\">})</span><span class=\"w\"> </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"s\">\"[INTERP] upsertBinding</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">stderr_file</span><span class=\"p\">.</span><span class=\"n\">writeAll</span><span class=\"p\">(</span><span class=\"n\">msg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">catch</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 563719254,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765756125
    },
    {
        "content": "<blockquote>\n<p>But why is our interpreter so much slower than Python?</p>\n</blockquote>\n<p>Yeah, we must have a crazy amount of low hanging fruit. That said, we also are a tree walking interpreter which is generally the slowest form of interpreter....but yeah, low hanging fruit too.</p>",
        "id": 563722524,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765760283
    },
    {
        "content": "<p>Looks like a lot of random interpreter overhead in a few methods. Not something like cloning or etc. But also, I don't really know what these methods do</p>\n<p><a href=\"/user_uploads/22008/pQIaMwg0ji2vecnQgZqcujF3/Screenshot-2025-12-14-at-4.59.43PM.png\">Screenshot 2025-12-14 at 4.59.43 PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/pQIaMwg0ji2vecnQgZqcujF3/Screenshot-2025-12-14-at-4.59.43PM.png\" title=\"Screenshot 2025-12-14 at 4.59.43 PM.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2160x1112\" src=\"/user_uploads/thumbnail/22008/pQIaMwg0ji2vecnQgZqcujF3/Screenshot-2025-12-14-at-4.59.43PM.png/840x560.webp\"></a></div>",
        "id": 563722662,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765760424
    },
    {
        "content": "<p>Definitely the first place to look would be applyContinuation which seems to have a lot of cost within itself.</p>",
        "id": 563723032,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765760808
    },
    {
        "content": "<p>Something super off is that like 95+% of the time is system time.</p>",
        "id": 563723077,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765760846
    },
    {
        "content": "<p>So this is almost not running roc code at all, just kernel calls. I guess that could be tons of allocations or copies or something.</p>",
        "id": 563723111,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765760875
    },
    {
        "content": "<blockquote>\n<p>Something super off is that like 95+% of the time is system time.</p>\n</blockquote>\n<p>Yeah, my htop bar was like 90% red instead of being green</p>",
        "id": 563723909,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765761939
    },
    {
        "content": "<p>I think we may call UnifyWithConf 1,022 times per line processed. And I assume it is the same unification every line. So this may be cachable or something that should be calculated ahead of time before running the interpreter at all.</p>",
        "id": 563724479,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765762666
    },
    {
        "content": "<blockquote>\n<p>call UnifyWithConf 1,022 times per line processed</p>\n</blockquote>\n<p>that sounds like a bug</p>",
        "id": 563725775,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765764252
    },
    {
        "content": "<p>Maybe it's something strange we are doing in our runtime evaluation or something related to polymorphism in the interpreter</p>",
        "id": 563726114,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765764759
    },
    {
        "content": "<p>May be related I'm not sure -- but I'm currently investigating an issue with infinite recursion in <code>store.Store.addTypeVar</code> which has come up from cross-module opaque types</p>",
        "id": 563726394,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765765149
    },
    {
        "content": "<p>This is a lot of allocations for 30 seconds</p>\n<p><a href=\"/user_uploads/22008/ZMUr4a-6nP7FELptxc8yRZ32/Screenshot-2025-12-14-at-6.33.01PM.png\">Screenshot 2025-12-14 at 6.33.01 PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/ZMUr4a-6nP7FELptxc8yRZ32/Screenshot-2025-12-14-at-6.33.01PM.png\" title=\"Screenshot 2025-12-14 at 6.33.01 PM.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"752x314\" src=\"/user_uploads/thumbnail/22008/ZMUr4a-6nP7FELptxc8yRZ32/Screenshot-2025-12-14-at-6.33.01PM.png/840x560.webp\"></a></div>",
        "id": 563727057,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765765997
    },
    {
        "content": "<p>This is time spent in the specific function. It does not include time spent in called function/children functions.</p>\n<p><a href=\"/user_uploads/22008/r6DvDQRrZHoZUc_-fQhznaqw/Screenshot-2025-12-14-at-6.34.51PM.png\">Screenshot 2025-12-14 at 6.34.51 PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/r6DvDQRrZHoZUc_-fQhznaqw/Screenshot-2025-12-14-at-6.34.51PM.png\" title=\"Screenshot 2025-12-14 at 6.34.51 PM.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1938x516\" src=\"/user_uploads/thumbnail/22008/r6DvDQRrZHoZUc_-fQhznaqw/Screenshot-2025-12-14-at-6.34.51PM.png/840x560.webp\"></a></div>",
        "id": 563727168,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765766127
    },
    {
        "content": "<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>likely better claude analysis</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>Part 2: What's Built Poorly (Root Causes)</p>\n<p>Problem 1: Per-Composite-Value Heap Allocations (CRITICAL)</p>\n<p>Location: applyContinuation in interpreter.zig</p>\n<p>Every composite value construction allocates temporary arrays that are immediately<br>\n freed:</p>\n<p>tuple_collect (lines 13011-13021):<br>\n var elem_layouts = try self.allocator.alloc(Layout, total_count);<br>\n defer self.allocator.free(elem_layouts);<br>\n var values = try self.allocator.alloc(StackValue, total_count);<br>\n defer self.allocator.free(values);<br>\n var elem_rt_vars = try self.allocator.alloc(types.Var, total_count);<br>\n defer self.allocator.free(elem_rt_vars);<br>\n 3 allocations + 3 frees per tuple</p>\n<p>list_collect (lines 13101-13102):<br>\n var values = try self.allocator.alloc(StackValue, total_count);<br>\n defer self.allocator.free(values);<br>\n 1 allocation + 1 free per list</p>\n<p>record_collect (lines 13206-13215):<br>\n var union_names = AlignedManaged(Ident.Idx, null).init(self.allocator);<br>\n var union_layouts = AlignedManaged(Layout, null).init(self.allocator);<br>\n var union_indices = std.AutoHashMap(u32, usize).init(self.allocator);<br>\n var field_values = try self.allocator.alloc(StackValue, total_field_values);<br>\n 4 allocations + 4 frees per record (plus HashMap internal allocations)</p>\n<p>Impact: A program with 1000 tuples = 3000 malloc + 3000 free syscalls just for tuple<br>\n temporaries.</p>\n<p>Problem 2: Type Translation Allocations (HIGH IMPACT)</p>\n<p>Location: translateTypeVar (line 8536) and gatherTags (line 9008)</p>\n<p>Called 128 times per typical program. Each tag union translation does:</p>\n<p>// In translateTypeVar (line 8590)<br>\n var rt_tag_args = try std.ArrayList(types.Var).initCapacity(self.allocator, 8);<br>\n defer rt_tag_args.deinit(self.allocator);</p>\n<p>var rt_tags = try self.gatherTags(module, tu);  // Another allocation!<br>\n defer rt_tags.deinit(self.allocator);</p>\n<p>// In gatherTags (line 9013)<br>\n var scratch_tags = try std.ArrayList(types.Tag).initCapacity(ctx.allocator, 8);<br>\n // Then appends in a loop - potential reallocs</p>\n<p>2+ allocations per tag union type translation, even for identical types due to per-call<br>\n  ArrayList creation.</p>\n<p>Problem 3: No Arena/Pool Allocator for Evaluation</p>\n<p>The interpreter uses self.allocator (likely GeneralPurposeAllocator or page allocator)<br>\n for all temporary allocations. Each allocation is a potential syscall.</p>\n<p>Missing: An arena allocator that's reset between top-level evaluations, or fixed-size<br>\n scratch buffers for common sizes.</p>\n<p>Problem 4: HashMap in Record Construction</p>\n<p>record_collect creates a fresh std.AutoHashMap for every record:<br>\n var union_indices = std.AutoHashMap(u32, usize).init(self.allocator);<br>\n HashMap has internal bucket arrays - this is expensive for small records.</p>\n<p>Problem 5: Repeated Layout Lookups</p>\n<p>Pattern seen throughout:<br>\n const tuple_layout_idx = try self.runtime_layout_store.putTuple(elem_layouts);<br>\n const tuple_layout = self.runtime_layout_store.getLayout(tuple_layout_idx);<br>\n If putTuple isn't O(1) cached, this is redundant work for identical layouts.</p>\n<p>Problem 6: Value Stack Pop-Then-Copy Pattern</p>\n<p>The continuation pattern requires:<br>\n 1. Evaluate all elements (push to value_stack)<br>\n 2. Pop ALL elements into temporary array<br>\n 3. Copy from temporary array into final composite<br>\n 4. Free temporary array</p>\n<p>This is 2x memory movement vs directly writing to destination.</p>\n<hr>\n<p>Part 3: Potential Fixes (Ranked by Impact)</p>\n<p>Fix 1: Scratch Buffer Pool (HIGH IMPACT)</p>\n<p>Add reusable scratch buffers to Interpreter struct:<br>\n const Interpreter = struct {<br>\n     // ... existing fields<br>\n     scratch_layouts: [64]Layout = undefined,<br>\n     scratch_values: [64]StackValue = undefined,<br>\n     scratch_rt_vars: [64]types.Var = undefined,<br>\n     // ...<br>\n };<br>\n Use for composites with &lt;= 64 elements (vast majority). Only heap-allocate for larger.</p>\n<p>Fix 2: Arena Allocator for Evaluation (HIGH IMPACT)</p>\n<p>Create an arena at evalWithExpectedType entry, pass through context:<br>\n var arena = std.heap.ArenaAllocator.init(self.allocator);<br>\n defer arena.deinit();<br>\n // Use arena.allocator() for all temporary allocations<br>\n Single free at end instead of per-allocation.</p>\n<p>Fix 3: Remove HashMap from record_collect (MEDIUM IMPACT)</p>\n<p>For small records (&lt; 16 fields), use linear search on arrays instead of HashMap.<br>\n Most records are small - HashMap overhead isn't worth it.</p>\n<p>Fix 4: Direct-Write Pattern for Composites (MEDIUM IMPACT)</p>\n<p>Instead of: evaluate all -&gt; pop all -&gt; copy all<br>\n Do: pre-allocate destination -&gt; evaluate directly into slots</p>\n<p>Requires continuation redesign but eliminates temporary arrays entirely.</p>\n<p>Fix 5: Layout Interning (MEDIUM IMPACT)</p>\n<p>Ensure putTuple, putRecord, putList are O(1) lookups for previously-seen layouts.<br>\n Verify with tracy that layout store operations aren't the bottleneck.</p>\n</div></div>",
        "id": 563727986,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765767257
    },
    {
        "content": "<p>yeah those all sound good! <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span></p>",
        "id": 563730301,
        "sender_full_name": "Richard Feldman",
        "timestamp": 1765769594
    },
    {
        "content": "<p>I also am working on a PR to revamp the tracy hooks. Adding tons more, making it work with executables from <code>roc build</code>. Some other improvements.</p>",
        "id": 563730471,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765769703
    },
    {
        "content": "<p>Now with finer grain traces:<br>\n<a href=\"/user_uploads/22008/2YzUiC1Mn_iC-Xd10CzpjU2h/Screenshot-2025-12-14-at-7.52.08PM.png\">Screenshot 2025-12-14 at 7.52.08 PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/2YzUiC1Mn_iC-Xd10CzpjU2h/Screenshot-2025-12-14-at-7.52.08PM.png\" title=\"Screenshot 2025-12-14 at 7.52.08 PM.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1938x638\" src=\"/user_uploads/thumbnail/22008/2YzUiC1Mn_iC-Xd10CzpjU2h/Screenshot-2025-12-14-at-7.52.08PM.png/840x560.webp\"></a></div>",
        "id": 563731936,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765770838
    },
    {
        "content": "<p>Yeah, clearly the issue is allocations. Look at the time spent in the allocator alloc function:</p>\n<p><a href=\"/user_uploads/22008/JYDYkwyX906uZRvTg94XWEkM/Screenshot-2025-12-14-at-8.27.02PM.png\">Screenshot 2025-12-14 at 8.27.02 PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/JYDYkwyX906uZRvTg94XWEkM/Screenshot-2025-12-14-at-8.27.02PM.png\" title=\"Screenshot 2025-12-14 at 8.27.02 PM.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1938x206\" src=\"/user_uploads/thumbnail/22008/JYDYkwyX906uZRvTg94XWEkM/Screenshot-2025-12-14-at-8.27.02PM.png/840x560.webp\"></a></div>",
        "id": 563734318,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765772889
    },
    {
        "content": "<p>This is in a 60s run</p>",
        "id": 563734327,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765772902
    },
    {
        "content": "<p>This is great news!</p>",
        "id": 563736181,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1765774431
    },
    {
        "content": "<p>Haha. I think I just figured out a major part of the issue. Just ran in 5s for me</p>",
        "id": 563736182,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765774433
    },
    {
        "content": "<p>I'm gonna just merge the fix into my tracy pr cause it is allocator related and I fixed it while also adding some more tracy allocator things.</p>",
        "id": 563736228,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765774471
    },
    {
        "content": "<p>Top costs after fix:</p>\n<p><a href=\"/user_uploads/22008/XGUkE6l6PZp1epHaVFVcIh3f/Screenshot-2025-12-14-at-8.58.47PM.png\">Screenshot 2025-12-14 at 8.58.47 PM.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/XGUkE6l6PZp1epHaVFVcIh3f/Screenshot-2025-12-14-at-8.58.47PM.png\" title=\"Screenshot 2025-12-14 at 8.58.47 PM.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1938x892\" src=\"/user_uploads/thumbnail/22008/XGUkE6l6PZp1epHaVFVcIh3f/Screenshot-2025-12-14-at-8.58.47PM.png/840x560.webp\"></a></div>",
        "id": 563736538,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765774740
    },
    {
        "content": "<p>I think with claude's help I see another huge win after this. Hopefully this can get us down to sub 1s here.</p>",
        "id": 563742066,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765779558
    },
    {
        "content": "<p>Crazy how much you can do with very carefully crafted prompts and guiding with claude. I don't fully know this code, but I know a lot about what would definitely be wrong and how to be very specific around what I want.</p>",
        "id": 563742098,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765779598
    },
    {
        "content": "<p>Yay! sub 1s!</p>",
        "id": 563743332,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765780564
    },
    {
        "content": "<p>Will put this in a different PR cause I am less sure it is valid/correct</p>",
        "id": 563743340,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1765780575
    },
    {
        "content": "<p>The improvement is quite amazing for my day03.roc program! Thanks Brendan! Here are my timings:</p>\n<ul>\n<li>old main: 6 min</li>\n<li>PR 8680: 1.5 s</li>\n<li>PR 8681: 500 ms</li>\n</ul>",
        "id": 563790090,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765795911
    },
    {
        "content": "<p>This is quite an extraordinary speedup, almost 1000x. I don’t know if you are interested in looking at another point. I made another benchmark that doesn’t show such a dramatic increase. In that benchmark, the TLDR is:</p>\n<ul>\n<li>old main: 12.5s</li>\n<li>PR 8680: 6.1s</li>\n<li>PR 8681: 3.5s</li>\n</ul>\n<p>For this benchmark, I’ve made a couple of files, one roc file, and one python file, then I have a wrapper python script that run both these benches with input sizes varying from 50 to 6400, with 2x steps. Finally, I’m plotting the timing for all these sizes.</p>\n<p>Here is old main:</p>\n<p><a href=\"/user_uploads/22008/rAxmE9M2li7cicdIn03xD-fU/benchmark_results_e8b2c4d.png\">benchmark_results_e8b2c4d.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/rAxmE9M2li7cicdIn03xD-fU/benchmark_results_e8b2c4d.png\" title=\"benchmark_results_e8b2c4d.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2084x886\" src=\"/user_uploads/thumbnail/22008/rAxmE9M2li7cicdIn03xD-fU/benchmark_results_e8b2c4d.png/840x560.webp\"></a></div><p>Here is PR 8680:</p>\n<p><a href=\"/user_uploads/22008/Tei7M53M0rCiypAQIaEzNUZq/benchmark_results_8680.png\">benchmark_results_8680.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/Tei7M53M0rCiypAQIaEzNUZq/benchmark_results_8680.png\" title=\"benchmark_results_8680.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2084x886\" src=\"/user_uploads/thumbnail/22008/Tei7M53M0rCiypAQIaEzNUZq/benchmark_results_8680.png/840x560.webp\"></a></div><p>And here is PR 8681:</p>\n<p><a href=\"/user_uploads/22008/6r0RzBc5uYUHNz7EvYoSmY8f/benchmark_results_8681.png\">benchmark_results_8681.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/22008/6r0RzBc5uYUHNz7EvYoSmY8f/benchmark_results_8681.png\" title=\"benchmark_results_8681.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"2084x886\" src=\"/user_uploads/thumbnail/22008/6r0RzBc5uYUHNz7EvYoSmY8f/benchmark_results_8681.png/840x560.webp\"></a></div>",
        "id": 563796001,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765797594
    },
    {
        "content": "<p>If you are ok to have a look at these: here are the files I used for it.</p>\n<p><a href=\"/user_uploads/22008/B6ezTi7Q_q2yd0JGmq0i3FcP/run_benchmark.py\">run_benchmark.py</a></p>\n<p><a href=\"/user_uploads/22008/T9WamvGZe1g_Yz2oyBgHDQKH/bench_fold_append.roc\">bench_fold_append.roc</a></p>\n<p><a href=\"/user_uploads/22008/d2F7TS3SMfhEXVxfeD5XmkZL/bench_fold_append.py\">bench_fold_append.py</a></p>",
        "id": 563796240,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765797671
    },
    {
        "content": "<p>Also, not explicitely perf-related, but maybe more a bug for <span class=\"user-mention\" data-user-id=\"281383\">@Richard Feldman</span> but when I run the above script with sizes up to 12800 then I get crash with memory leak detected.</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"go\">Running benchmarks...</span>\n<span class=\"go\">Sizes to test: [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800]</span>\n<span class=\"go\">============================================================</span>\n<span class=\"go\">[1/9] Testing size     50... ✓ Roc: 0.0315s, Python: 0.0124s</span>\n<span class=\"go\">[2/9] Testing size    100... ✓ Roc: 0.0366s, Python: 0.0127s</span>\n<span class=\"go\">[3/9] Testing size    200... ✓ Roc: 0.0472s, Python: 0.0128s</span>\n<span class=\"go\">[4/9] Testing size    400... ✓ Roc: 0.0740s, Python: 0.0130s</span>\n<span class=\"go\">[5/9] Testing size    800... ✓ Roc: 0.1385s, Python: 0.0138s</span>\n<span class=\"go\">[6/9] Testing size   1600... ✓ Roc: 0.3593s, Python: 0.0150s</span>\n<span class=\"go\">[7/9] Testing size   3200... ✓ Roc: 1.1039s, Python: 0.0179s</span>\n<span class=\"go\">[8/9] Testing size   6400... ✓ Roc: 3.6303s, Python: 0.0233s</span>\n<span class=\"go\">[9/9] Testing size  12800... Error running benchmark with size 12800:</span>\n<span class=\"go\">error(gpa): memory address 0x342710000 leaked:</span>\n<span class=\"go\">Unable to print stack trace: Unable to open debug info: MissingDebugInfo</span>\n\n<span class=\"go\">error: Memory leak detected!</span>\n</code></pre></div>",
        "id": 563797615,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765798153
    },
    {
        "content": "<p>I compiled <a href=\"https://github.com/roc-lang/roc/issues/8681\">#8681</a> with ReleaseFast and I don't see any significant speedup. Did not measure it, but it's still several minutes to run. I have a x64 machine, so maybe that's a reason.</p>",
        "id": 563802395,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1765799631
    },
    {
        "content": "<p>M1 Max:<br>\nRun 1: 0.49s user 0.20s system 29% cpu 2.350 total<br>\nRun 2: 0.45s user 0.16s system 74% cpu 0.817 total</p>\n<p>NixOS x86 (AMD 9950X):<br>\nRun 1: 4.32s user 13.01s system 97% cpu 17.816 total<br>\nRun 2: 4.07s user 12.94s system 99% cpu 17.073 total</p>\n<p>Testing more than two runs made no difference on either machine. Used <a href=\"https://github.com/roc-lang/roc/pull/8681\">#8681</a>, ran <code>git clean -dfx</code> before building, built with <code>zig build roc -Doptimize=ReleaseFast</code>. Roc source  and input file from <a href=\"#narrow/channel/358903-advent-of-code/topic/2025.20Day.203/near/563633329\">https://roc.zulipchat.com/#narrow/channel/358903-advent-of-code/topic/2025.20Day.203/near/563633329</a>.</p>",
        "id": 563812141,
        "sender_full_name": "Niclas Ahden",
        "timestamp": 1765802444
    },
    {
        "content": "<p>Found my own speedup (<a href=\"https://github.com/roc-lang/roc/issues/8682\">#8682</a>), now the whole thing runs in under a second for me as well.</p>",
        "id": 563816306,
        "sender_full_name": "Fabian Schmalzried",
        "timestamp": 1765803635
    },
    {
        "content": "<p><del>Using <a href=\"https://github.com/roc-lang/roc/pull/8682\">#8682</a> gave me slower M1 times and faster x86 times:</del></p>\n<p><del>M1 Max:</del><br>\n<del>Run 1: 2.49s user 0.16s system 51% cpu 5.184 total</del><br>\n<del>Run 2: 2.45s user 0.12s system 96% cpu 2.670 total</del></p>\n<p><del>NixOS x86 (AMD 9950X):</del><br>\n<del>Run 1: 2.13s user 0.18s system 79% cpu 2.914 total</del><br>\n<del>Run 2: 2.03s user 0.18s system 99% cpu 2.221 total</del></p>",
        "id": 563822498,
        "sender_full_name": "Niclas Ahden",
        "timestamp": 1765805274
    },
    {
        "content": "<p>You have to rebase it on top of the new main, which has now included <a href=\"https://github.com/roc-lang/roc/issues/8681\">#8681</a> <span class=\"user-mention\" data-user-id=\"524503\">@Niclas Ahden</span> .<br>\nThe PR <a href=\"https://github.com/roc-lang/roc/issues/8682\">#8682</a> branch is based on <a href=\"https://github.com/roc-lang/roc/issues/8680\">#8680</a> not 81, so that may be the slowing you see for the M1 max</p>",
        "id": 563823301,
        "sender_full_name": "Matthieu Pizenberg",
        "timestamp": 1765805468
    },
    {
        "content": "<p>Ah, indeed, thanks! Rebased results:</p>\n<p>M1 Max:<br>\nRun 1: 0.45s user 0.14s system 17% cpu 3.334 total<br>\nRun 2: 0.41s user 0.10s system 83% cpu 0.616 total</p>\n<p>NixOS x86 (AMD 9950X):<br>\nRun 1: 0.46s user 0.15s system 58% cpu 1.028 total<br>\nRun 2: 0.34s user 0.14s system 96% cpu 0.495 total</p>",
        "id": 563824527,
        "sender_full_name": "Niclas Ahden",
        "timestamp": 1765805777
    }
]
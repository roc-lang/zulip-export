[
    {
        "content": "<p>I've been working on a custom Roc platform in Rust, relying heavily on example platforms.  I think I have a decent high-level understanding for how the pieces fit together.  I have a lot of ideas I'm excited to try, but unfortunately my struggles with glue generation have ground my progress to a halt.  Hoping some of the lovely folks in here can help unblock me.</p>\n<p>I've seen from other threads and my own experience that Rust glue generation is a bit broken.  In my case, there were unnecessary <code>Clone</code> derivations and a few other minor issues preventing the generated glue code from compiling, which I was able to fix manually.  But after getting past those errors, I get hit with this cryptic error at point when the platform tries to use the generated struct to read data from the application:</p>\n<div class=\"codehilite\"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at core/src/panicking.rs:221:5:\nunsafe precondition(s) violated: slice::from_raw_parts requires the pointer to be aligned and non-null, and the total size of the slice not to exceed `isize::MAX`\n</code></pre></div>\n<p>I realize that without more context this error probably isn't actionable, so let me back up and show the Roc types I'm trying to generate glue for:</p>\n<div class=\"codehilite\"><pre><span></span><code>GenericEffect : [\n    Single (Bytes =&gt; Bytes),\n    Map GenericEffect (Bytes -&gt; Bytes),\n    Chain GenericEffect GenericEffect,\n    Fork GenericEffect GenericEffect,\n    Parallel GenericEffect,\n    Branch GenericEffect GenericEffect (Bytes -&gt; Bool),\n    Loop GenericEffect GenericEffect (Bytes -&gt; Bool),\n]\n\nBytes : List U8\n</code></pre></div>\n<p>I don't necessarily want to explain what I'm hoping to achieve with this custom platform at the moment, since I'm still in the exploratory phase (but I could if need be).  What I'd like to know for starters is</p>\n<ol>\n<li>Should I be able to generate glue for these types at all?  Or is there something about them that just won't work with glue?</li>\n<li>How would I go about troubleshooting the error above?  I could perhaps put together a reprex repo but if the answer to the above is \"no\" then I wouldn't even bother <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></li>\n</ol>",
        "id": 485029245,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732861206
    },
    {
        "content": "<p>Do you need the platform to call those functions? Maybe if you box them so they're just opaque pointers (with fixed size) on the host side. I didn't think we supported functions crossing the boundary though yet, I thought we needed type erasure for that (which isnt implemented yet).</p>",
        "id": 485031989,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732862922
    },
    {
        "content": "<p>Correct, the application builds up this structure full of functions and hands it off to the platform for execution.  My platform makes the construction and composition of effects very restricted in order to make certain security guarantees and enable debug tooling.</p>\n<p>I can try boxing the functions on the roc side when I have access to a computer.</p>\n<p>In general does everything being passed from roc to the platform need a fixed size?  So is <code>List U8</code> also an issue?</p>",
        "id": 485109703,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732890263
    },
    {
        "content": "<p>Glue has a lot of bugs and limitations currently. Functions are an exceptionally sharp edge.</p>",
        "id": 485147431,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732906232
    },
    {
        "content": "<p>We do plan to restrict the platform API to fixed sized data types. Today, roc will create a size function for anything that is not fixed size, but it isn't aways enough to be useful.</p>",
        "id": 485147536,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732906317
    },
    {
        "content": "<p>I would not expect this platform to work in general. It looks a lot like effect interpreters which are stuck due to compiler bugs. It might end up working out, but I would expect to hit compiler bugs that need to be worked around.</p>",
        "id": 485147666,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732906377
    },
    {
        "content": "<p>Lists have a compile time known size and are totally fine to pass to the platform. A list is the size of 3 pointers.</p>",
        "id": 485147798,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732906445
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"343810\">@Brendan Hansknecht</span> regarding your comment about this looking like effect interpreters, does it make a difference to know that for this platform the effects being handed off to the platform is a one-time transaction?  Like the application essentially is just a DSL for building up an effectful computation that the platform executes.  There's no back and forth between the app and platform.</p>",
        "id": 485174432,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732924746
    },
    {
        "content": "<p>I think the issue is that when you have recursion and captures you are in lambda set territory and those sometimes break.</p>",
        "id": 485174635,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732924890
    },
    {
        "content": "<p>It may work, but when it doesn't we don't have many options available.</p>",
        "id": 485174672,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732924915
    },
    {
        "content": "<p>Also, are you passing these functions across to the host (rust/zig) etc? or do they live purely in the roc side of things (between app and platform)?</p>",
        "id": 485174744,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732924949
    },
    {
        "content": "<p>If you can provide more context I can probably provide more assistance. Even if it's just a fake platform.</p>",
        "id": 485174778,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732924986
    },
    {
        "content": "<p>Sure, I can try to give more context.  With this platform, the Roc API provides constructors for creating effects, but not executing any of them.  The application can't even provide a main function, just a \"main effect\" value.  Custom effects cannot be created by the app author, only selected from the platform library.  The <code>GenericEffect</code> type I showed above isn't exposed to the app author either.  Instead they are given a type-safe wrapper with functions for composing effects and/or doing ad-hoc mapping (pure functions only):</p>\n<div class=\"codehilite\"><pre><span></span><code>Effect a b := GenericEffect\n\nmap : Effect a b, (b -&gt; c) -&gt; Effect a c\nchain : Effect a b, Effect b c -&gt; Effect a c\nfork : Effect a b, Effect a c -&gt; Effect a (b, c)\nparallelize : Effect a b -&gt; Effect (List a) (List b)\nbranch : Effect a b, Effect a c, (a -&gt; bool) -&gt; Effect a (Either b c)\nloop : Effect a a, Effect a b, (a -&gt; bool) -&gt; Effect a b\nfixture : a -&gt; Effect {} a where a implements Encoding\ndiscard : Effect a * -&gt; Effect a {}\n</code></pre></div>\n<p>There are some missing implements Encoding/Decoding annotations above, but this gives a rough idea of the application API.  <code>Effect a b</code> internally manages the <code>GenericEffect</code> (shown earlier) by wrapping any provided functions that operate on <code>a</code> or <code>b</code> with encoders/decoders to keep the host's view of the computation generic (and enable some of the features described below)</p>\n<p>Here's what \"hello world\" might look like:</p>\n<div class=\"codehilite\"><pre><span></span><code>app [main] { pf: platform &quot;platform/main.roc&quot; }\n\nimport pf.Stdout\nimport pf.Effect\n\nmain = Effect.fixture &quot;Hello world!&quot; |&gt; Effect.chain Stdout.line\n</code></pre></div>\n<p>So to answer the question above, yes the host needs to be able to execute the functions defined in Roc, because the application (intentionally) isn't allowed to actually execute anything, other than functions to compose effects.</p>",
        "id": 485176060,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732926114
    },
    {
        "content": "<p>Also <code>Effect.fixture</code> isn't truly an effect (probably needs a better name).  It's just what I'm using for my POC code at the moment because it works nicely with <code>chain</code></p>",
        "id": 485176369,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732926373
    },
    {
        "content": "<p>The big idea is that by giving the platform a highly-structured view of the application, you can get a whole bunch of stuff for free, like automatic state chart documentation; debug instrumentation that allows you to pause, inspect, and modify data at runtime; and interesting security analysis capabilities (e.g., going beyond \"this program has network and disk access\" to \"this program, despite disk and network access, cannot send your personal files to a remote server, because there's no path between the ReadFile effect and HttpPost effect\")</p>",
        "id": 485176782,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732926751
    },
    {
        "content": "<p>That last idea depends on functional purity and tightly controlling the composition and execution of effectful code (and Roc is the only language that I know of that has these critical features!)</p>",
        "id": 485177027,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732926978
    },
    {
        "content": "<p>Ok, I'm not sure I can give you any definitive answers. </p>\n<p>My approach with this kind of thing is to start with the very smallest e2e thing I can think of and build it up bit by bit. So maybe you could try just with:</p>\n<div class=\"codehilite\"><pre><span></span><code>GenericEffect : [\n    Single (Bytes =&gt; Bytes),\n]\n</code></pre></div>\n<p>And see if you can get that working? </p>\n<p>One thing I find that is helpful, is that you can generate the llvm ir with <code>roc build --no-link --emit-llvm-ir path/to/app.roc</code>. That will give you the definitive answer on what roc is generating. I often use this to confirm the FFI is correct.</p>",
        "id": 485177518,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732927491
    },
    {
        "content": "<p>I was able to generate glue using <code>RustGlue.roc</code> and this platform.</p>\n<div class=\"codehilite\"><pre><span></span><code>platform &quot;&quot;\n    requires {} { main! : {} =&gt; _ }\n    exposes []\n    packages {}\n    imports []\n    provides [mainForHost!]\n\nBytes : List U8\n\nGenericEffect : [\n    Single (Bytes =&gt; Bytes),\n]\n\nmainForHost! : {} =&gt; GenericEffect\nmainForHost! = \\{} -&gt; main! {}\n</code></pre></div>",
        "id": 485177708,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732927669
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[repr(C)]</span>\n<span class=\"cp\">#[derive(Debug)]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">RocFunction_67</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">closure_data</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Vec</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">RocFunction_67</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">force_thunk</span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">roc_std</span><span class=\"p\">::</span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">roc_std</span><span class=\"p\">::</span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">roc__mainForHost_0_caller</span><span class=\"p\">(</span><span class=\"n\">arg0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">roc_std</span><span class=\"p\">::</span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure_data</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">roc_std</span><span class=\"p\">::</span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">mem</span><span class=\"p\">::</span><span class=\"n\">MaybeUninit</span><span class=\"p\">::</span><span class=\"n\">uninit</span><span class=\"p\">();</span>\n\n<span class=\"w\">        </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">roc__mainForHost_0_caller</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">arg0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">closure_data</span><span class=\"p\">.</span><span class=\"n\">as_mut_ptr</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"p\">.</span><span class=\"n\">as_mut_ptr</span><span class=\"p\">());</span>\n\n<span class=\"w\">            </span><span class=\"n\">output</span><span class=\"p\">.</span><span class=\"n\">assume_init</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span><span class=\"n\">roc_refcounted_noop_impl</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">RocFunction_67</span><span class=\"p\">);</span>\n\n<span class=\"cp\">#[derive(Clone, )]</span>\n<span class=\"cp\">#[repr(transparent)]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">GenericEffect</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">     </span><span class=\"n\">f0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocFunction_67</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">GenericEffect</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"sd\">/// A tag named ``Single``, with the given payload.</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">Single</span><span class=\"p\">(</span><span class=\"n\">f0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocFunction_67</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Self</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"bp\">Self</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">f0</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"sd\">/// Since `GenericEffect` only has one tag (namely, `Single`),</span>\n<span class=\"w\">    </span><span class=\"sd\">/// convert it to `Single`'s payload.</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">into_Single</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">RocFunction_67</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">f0</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"sd\">/// Since `GenericEffect` only has one tag (namely, `Single`),</span>\n<span class=\"w\">    </span><span class=\"sd\">/// convert it to `Single`'s payload.</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">as_Single</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">RocFunction_67</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">f0</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Debug</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">GenericEffect</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">fmt</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Formatter</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">f</span><span class=\"p\">.</span><span class=\"n\">debug_tuple</span><span class=\"p\">(</span><span class=\"s\">\"GenericEffect::Single\"</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">field</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">f0</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">finish</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">roc_refcounted_noop_impl</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">GenericEffect</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>This is looking positive...</p>",
        "id": 485177778,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732927704
    },
    {
        "content": "<p>Yes, I should have been more clear that the glue generation does succeed, but the generated code doesn't compile</p>",
        "id": 485177800,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732927738
    },
    {
        "content": "<p>Ohk... yeah the generated code is a mess rn. I usually just use it as a general guide</p>",
        "id": 485177821,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732927763
    },
    {
        "content": "<p>Helps me figure out the order and alignment etc</p>",
        "id": 485177828,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732927777
    },
    {
        "content": "<p>So admittedly I don't really understand what I need to look for to fix order/alignment issues <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>.  I saw the <code>DescribeGlue.roc</code> spec for spitting out the types/alignment, but I couldn't do much with that information.  I'm not sure how much I need to understand about FFI in general</p>",
        "id": 485178034,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732927931
    },
    {
        "content": "<p>Sorry for the super vague question <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span></p>",
        "id": 485178162,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732928043
    },
    {
        "content": "<p>I'm not an expert... but me and my buddy Claude stumble through it</p>",
        "id": 485178164,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732928045
    },
    {
        "content": "<p>Having the LLVM IR is super helpful</p>",
        "id": 485178172,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732928057
    },
    {
        "content": "<p>Is there something in particular I should look for in the 13k line LLVM IR output?</p>",
        "id": 485178288,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732928181
    },
    {
        "content": "<p>Yeah, search for the entrypoint... like <code>mainForHost</code> etc</p>",
        "id": 485178308,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732928215
    },
    {
        "content": "<p>For example in the JS DOM experimental platform I have the following...</p>\n<div class=\"codehilite\"><pre><span></span><code>platform &quot;&quot;\n    requires { Model } {\n        init : {} -&gt; Model,\n        update : Model, List U8 -&gt; Action.Action Model,\n        render : Model -&gt; Html.Html Model,\n    }\n    exposes [Html, Action]\n    packages {}\n    imports []\n    provides [initForHost, updateForHost, renderForHost]\n\nimport Html\nimport Html\nimport Action\n\ninitForHost : I32 -&gt; Box Model\ninitForHost = \\_ -&gt; Box.box (init {})\n\nupdateForHost : Box Model, List U8 -&gt; Action.Action (Box Model)\nupdateForHost = \\boxedModel, payload -&gt;\n    Action.map (update (Box.unbox boxedModel) payload) Box.box\n\nrenderForHost : Box Model -&gt; Html.Html Model\nrenderForHost = \\boxedModel -&gt; render (Box.unbox boxedModel)\n</code></pre></div>\n<p>So I can find these in the LLVM</p>\n<div class=\"codehilite\" data-code-language=\"LLVM\"><pre><span></span><code><span class=\"k\">define</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"vg\">@roc__initForHost_1_exposed</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!99</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">entry:</span>\n<span class=\"w\">  </span><span class=\"nv\">%call</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">call</span><span class=\"w\"> </span><span class=\"k\">fastcc</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"vg\">@_initForHost_99aa979e4a9cadd6dbe48ea878ec84acb7696eb93470c375f6893f1da46c3772</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!100</span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv\">%call</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!100</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">define</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"vg\">@roc__initForHost_1_exposed_size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!102</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">entry:</span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"k\">ptrtoint</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"k\">getelementptr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!103</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">define</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">x</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"vg\">@roc__updateForHost_1_exposed</span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!120</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">entry:</span>\n<span class=\"w\">  </span><span class=\"nv\">%result_value</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">alloca</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">x</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!121</span>\n<span class=\"w\">  </span><span class=\"nv\">%load_arg</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">load</span><span class=\"w\"> </span><span class=\"nv\">%list.RocList</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!121</span>\n<span class=\"w\">  </span><span class=\"k\">call</span><span class=\"w\"> </span><span class=\"k\">fastcc</span><span class=\"w\"> </span><span class=\"k\">void</span><span class=\"w\"> </span><span class=\"vg\">@_updateForHost_392aebc0773ca1163ead8eb210e2c2aabca4fe4ded9f2b122a7dab30d082d98b</span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">%list.RocList</span><span class=\"w\"> </span><span class=\"nv\">%load_arg</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv\">%result_value</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!121</span>\n<span class=\"w\">  </span><span class=\"nv\">%load_result</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">load</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">x</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv\">%result_value</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">align</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!121</span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">x</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"nv\">%load_result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!121</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">define</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"vg\">@roc__updateForHost_1_exposed_size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!123</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">entry:</span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"k\">ptrtoint</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"k\">getelementptr</span><span class=\"w\"> </span><span class=\"p\">({</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"m\">1</span><span class=\"w\"> </span><span class=\"k\">x</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"kt\">i8</span><span class=\"w\"> </span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!124</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">define</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"vg\">@roc__renderForHost_1_exposed</span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!183</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">entry:</span>\n<span class=\"w\">  </span><span class=\"nv\">%call</span><span class=\"w\"> </span><span class=\"p\">=</span><span class=\"w\"> </span><span class=\"k\">call</span><span class=\"w\"> </span><span class=\"k\">fastcc</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"vg\">@_renderForHost_eabc27640eff330d625cb2f6435f5dccaec45dd590ad64015fdca105b70</span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">%0</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!184</span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"nv\">%call</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!184</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">define</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"vg\">@roc__renderForHost_1_exposed_size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!186</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"nl\">entry:</span>\n<span class=\"w\">  </span><span class=\"k\">ret</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"k\">ptrtoint</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"k\">getelementptr</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">ptr</span><span class=\"w\"> </span><span class=\"k\">null</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">to</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"nv\">!dbg</span><span class=\"w\"> </span><span class=\"nv nv-Anonymous\">!187</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Which I've then translated to the following...</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">roc_init</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">RocBox</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"cp\">#[link(name = </span><span class=\"s\">\"app\"</span><span class=\"cp\">)]</span>\n<span class=\"w\">    </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// initForHost : I32 -&gt; Model</span>\n<span class=\"w\">        </span><span class=\"cp\">#[link_name = </span><span class=\"s\">\"roc__initForHost_1_exposed\"</span><span class=\"cp\">]</span>\n<span class=\"w\">        </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">caller</span><span class=\"p\">(</span><span class=\"n\">arg_not_used</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">RocBox</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"cp\">#[link_name = </span><span class=\"s\">\"roc__initForHost_1_exposed_size\"</span><span class=\"cp\">]</span>\n<span class=\"w\">        </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">debug_assert_eq!</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">mem</span><span class=\"p\">::</span><span class=\"n\">size_of</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">RocBox</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">caller</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">roc_update</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocBox</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">raw_event</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">glue</span><span class=\"p\">::</span><span class=\"n\">RawAction</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"cp\">#[link(name = </span><span class=\"s\">\"app\"</span><span class=\"cp\">)]</span>\n<span class=\"w\">    </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// updateForHost : Box Model, List U8 -&gt; Action.Action (Box Model)</span>\n<span class=\"w\">        </span><span class=\"cp\">#[link_name = </span><span class=\"s\">\"roc__updateForHost_1_exposed\"</span><span class=\"cp\">]</span>\n<span class=\"w\">        </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">caller</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocBox</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">raw_event</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">RocList</span><span class=\"o\">&lt;</span><span class=\"kt\">u8</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">glue</span><span class=\"p\">::</span><span class=\"n\">RawAction</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"cp\">#[link_name = </span><span class=\"s\">\"roc__updateForHost_1_exposed_size\"</span><span class=\"cp\">]</span>\n<span class=\"w\">        </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">debug_assert_eq!</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">mem</span><span class=\"p\">::</span><span class=\"n\">size_of</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">glue</span><span class=\"p\">::</span><span class=\"n\">RawAction</span><span class=\"o\">&gt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">caller</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">raw_event</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">roc_render</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocBox</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">glue</span><span class=\"p\">::</span><span class=\"n\">Html</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"cp\">#[link(name = </span><span class=\"s\">\"app\"</span><span class=\"cp\">)]</span>\n<span class=\"w\">    </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// renderForHost : Box Model -&gt; Html.Html Model</span>\n<span class=\"w\">        </span><span class=\"cp\">#[link_name = </span><span class=\"s\">\"roc__renderForHost_1_exposed\"</span><span class=\"cp\">]</span>\n<span class=\"w\">        </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">caller</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">RocBox</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">glue</span><span class=\"p\">::</span><span class=\"n\">Html</span><span class=\"p\">;</span>\n\n<span class=\"w\">        </span><span class=\"cp\">#[link_name = </span><span class=\"s\">\"roc__renderForHost_1_exposed_size\"</span><span class=\"cp\">]</span>\n<span class=\"w\">        </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">debug_assert_eq!</span><span class=\"p\">(</span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">mem</span><span class=\"p\">::</span><span class=\"n\">size_of</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">glue</span><span class=\"p\">::</span><span class=\"n\">Html</span><span class=\"o\">&gt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">caller</span><span class=\"p\">(</span><span class=\"n\">model</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 485178461,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732928387
    },
    {
        "content": "<p>Thank you... there's a lot of unfamiliar stuff to digest here, but I'll see if I can use this to make sense of my output and find any clues as to why my app is crashing <span aria-label=\"magnifying glass\" class=\"emoji emoji-1f50d\" role=\"img\" title=\"magnifying glass\">:magnifying_glass:</span></p>",
        "id": 485178764,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732928617
    },
    {
        "content": "<p>Before I get too far with that though, does this Roc type even make sense?</p>\n<div class=\"codehilite\"><pre><span></span><code>Effect a b := GenericEffect\n</code></pre></div>\n<p>Specifically how the type parameters aren't used.  In Rust this is a problem and I'd need to use PhantomData or something, but the Roc compiler doesn't seem to care.  Just want to check that this is expected.</p>",
        "id": 485179301,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732929066
    },
    {
        "content": "<p>I think so, that would be identical to this right?</p>\n<div class=\"codehilite\"><pre><span></span><code>Effect a b := [\n    Single (Bytes =&gt; Bytes),\n    Map (Effect a b) (Bytes -&gt; Bytes),\n    Chain (Effect a b) (Effect a b),\n    Fork (Effect a b) (Effect a b),\n    Parallel (Effect a b),\n    Branch (Effect a b) (Effect a b) (Bytes -&gt; Bool),\n    Loop (Effect a b) (Effect a b) (Bytes -&gt; Bool),\n]\n</code></pre></div>",
        "id": 485179496,
        "sender_full_name": "Luke Boswell",
        "timestamp": 1732929225
    },
    {
        "content": "<p>Not quite.  I had to wrap <code>GenericEffect</code> because it's not possible to name all the type parameters of the inner <code>Effect</code>s if I were to do it in a completely type safe way.  For example:</p>\n<div class=\"codehilite\"><pre><span></span><code>Effect a b ??? := [\n    Single (a =&gt; b)\n    Map (Effect a b) (b -&gt; c)\n    Chain (Effect a b) (Effect a c)\n    ...\n]\n</code></pre></div>",
        "id": 485179795,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732929446
    },
    {
        "content": "<p><code>GenericEffect</code> deals with this problem by wrapping all those functions with encoders/decoders to coerce everything to a single concrete type (<code>Bytes</code>/<code>List U8</code> in my case, but I could just as easily have used <code>Str</code>)</p>",
        "id": 485179883,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732929512
    },
    {
        "content": "<p>I guess I should have clarified up front that <code>a</code> represents the input to the effect, and <code>b</code> represents the output</p>",
        "id": 485180158,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732929745
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"572105\">Tanner Nielsen</span> <a href=\"#narrow/stream/302903-platform-development/topic/Struggling.20with.20glue/near/485174432\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"343810\">Brendan Hansknecht</span> regarding your comment about this looking like effect interpreters, does it make a difference to know that for this platform the effects being handed off to the platform is a one-time transaction?  Like the application essentially is just a DSL for building up an effectful computation that the platform executes.  There's no back and forth between the app and platform.</p>\n</blockquote>\n<p>Is nothing returns a GenericEffect, you may be fine. Not sure.</p>",
        "id": 485189550,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732938309
    },
    {
        "content": "<p>Also, do you need to pass the lambdas to the host for the Generic effect? If you could make that all live in roc, it would make your interaction with glue complexity simpler.</p>",
        "id": 485189694,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732938452
    },
    {
        "content": "<p>The main reason I wanted the lambdas to be executed by the host was so I could do parallelism via Rust threads.  That's not a hard requirement of the platform though, and I guess a single-threaded proof of concept is better than nothing.</p>",
        "id": 485191956,
        "sender_full_name": "Tanner Nielsen",
        "timestamp": 1732940546
    },
    {
        "content": "<p>Makes sense</p>",
        "id": 485198048,
        "sender_full_name": "Brendan Hansknecht",
        "timestamp": 1732946450
    }
]
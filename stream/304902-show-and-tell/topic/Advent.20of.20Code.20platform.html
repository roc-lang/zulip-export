<html>
<head><meta charset="utf-8"><title>Advent of Code platform · show and tell · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/index.html">show and tell</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html">Advent of Code platform</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="481566583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481566583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481566583">(Nov 10 2024 at 14:30)</a>:</h4>
<p>I created the platform, that I will use for AoC this year:</p>
<p><a href="https://github.com/ostcar/roc-aoc-platform">https://github.com/ostcar/roc-aoc-platform</a></p>
<p>The main function has this signature: <code>[Part1, Part2] -&gt; List U8</code>.</p>
<p>The platform statically allocates memory on startup. While Roc is running, there are no allocations. As default, it allocates one GiB of memory, but other sizes can be used via the argument <code>--memory</code>. The platform does not deallocate any memory. Last year, I activated deallocations on day 17, since this was necessary for my solution. It is possible, that I will implement it as well this year. But it will  be optional.</p>
<p>The output of the platform looks like this:</p>
<div class="codehilite"><pre><span></span><code>Part1 in 24.141ms, used 64167756 bytes:
2377

Part2 in 20.347ms, used 64167757 bytes:
71220
</code></pre></div>
<p>I think that the platform is a good example for a zig-platform, since it has a working <code>build.zig</code> file, that creates all files necessary for the surgical linker and the legacy linker for linux and mac (I don't have a mac, so I could only test it with linux, but I should work). The platform does not use C-<code>malloc</code> and fiends, but a zig allocator (but without deallocate at the moment).  As soon as <code>expect</code> works like <code>dbg</code> and does not need <code>shm_open</code>, <code>mmap</code> and <code>getppid</code> anymore, it should be possible to use the platform without libc.</p>



<a name="481567065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481567065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481567065">(Nov 10 2024 at 14:37)</a>:</h4>
<p>Perfect timing! I was just talking to a friend yesterday who's considering doing AoC in Roc this year, just sent them the link to this.</p>
<p>Also excited to take a look at how you did the Zig bits. I'm working on a zig platform on Linux and never got the surgical linker working. Also wanted to take a look at how I might run allocation through a Zig allocator but never felt sure enough of what I was doing to try it out, so will definitly check out how you did it!</p>



<a name="481815633"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481815633" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481815633">(Nov 11 2024 at 21:54)</a>:</h4>
<p>I didn't get the surgical linking to work unfortunately, keep running into an error. I think it's a better error then the one I had before though: previously when using the surgical linker I got a crash when zig host code allocated memory. Now I get a nice error linking to a Roc issue about surgical linking not support absolute relocations. Either way I can use the legacy linker to work around it for now.</p>
<p>I'm liking working with the Zig build system! Wondering if we should set up a Zig package for Roc platform development. It could include <code>roc.Build</code> namespace with Roc-specific build steps, a <code>roc.std</code> for the roc standard library integrations, maybe some comptime helpers for calling host-exposed functions, and a <code>roc.mem</code> with your allocator-for-Roc code.</p>



<a name="481816535"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481816535" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481816535">(Nov 11 2024 at 22:01)</a>:</h4>
<blockquote>
<p>Wondering if we should set up a Zig package for Roc platform development</p>
</blockquote>
<p><a href="https://github.com/lukewilliamboswell/roc-platform-template-zig">https://github.com/lukewilliamboswell/roc-platform-template-zig</a></p>
<p>I've not given it much love recently... but this was the plan <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="481816620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481816620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481816620">(Nov 11 2024 at 22:02)</a>:</h4>
<p>Or do you mean a <code>roc_std</code> like, zig package?</p>



<a name="481820421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481820421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481820421">(Nov 11 2024 at 22:29)</a>:</h4>
<p>I was aware of your zig platform template, it was a great help getting started with my platform work!</p>
<p>Yeah, I meant a package, as in something you could add to the <code>build.zig.zon</code> file of a zig platform to get all the batteries for roc platform development.</p>



<a name="481821771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481821771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481821771">(Nov 11 2024 at 22:39)</a>:</h4>
<p>This is one of the main reasons I'd like to land the <a href="https://github.com/roc-lang/roc/pull/6921">LLVM / Zig 13 upgrade</a>. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="481821848"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481821848" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481821848">(Nov 11 2024 at 22:40)</a>:</h4>
<p>AFAIK you can't use a zig package with <code>0.11.0</code></p>



<a name="481821929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481821929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481821929">(Nov 11 2024 at 22:40)</a>:</h4>
<p>I'm hoping we can land this rebuild host PR soon (like very soon), and then I can merge the latest into that branch and it should be pretty close.</p>



<a name="481823821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481823821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481823821">(Nov 11 2024 at 22:55)</a>:</h4>
<p>It's something we kind of need in the repository for that upgrade. My current workaround, is to copy the builtins into each of the test platforms - once at the start of running the tests. I experimented with a package, but that was deviating a bit from the builtins. </p>
<p>I'm starting to think it might be a good idea to make the builtins depend on a <code>roc_std</code> zig package that lives in the repo, and the test platform also use that, and then also anyone else who is making a zig platform.</p>



<a name="481824308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481824308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481824308">(Nov 11 2024 at 22:59)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> does it sound like a terrible idea to have the builtins and zig test platform use a common zig package for the primitives? Could we separate out all the extra builtin stuff easily enough?</p>



<a name="481825300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481825300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481825300">(Nov 11 2024 at 23:06)</a>:</h4>
<p>I'm super excited about this!</p>
<p>One question: could it lead to versioning issues if zig platforms use one version of the standard library and the applications people write another?</p>



<a name="481826146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481826146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481826146">(Nov 11 2024 at 23:12)</a>:</h4>
<p>It should be fine, as long as the platform uses the correct C-ABI etc</p>



<a name="481832041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481832041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481832041">(Nov 11 2024 at 23:59)</a>:</h4>
<p>I think it would be great for there to be a zig package for all the builtin types.</p>



<a name="481832081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481832081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481832081">(Nov 11 2024 at 23:59)</a>:</h4>
<p>Fully in the zig ecosystem but tied to a roc version for compatibility reasons</p>



<a name="481832224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/481832224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#481832224">(Nov 12 2024 at 00:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="477725">Jasper Woudenberg</span> <a href="#narrow/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/481825300">said</a>:</p>
<blockquote>
<p>I'm super excited about this!</p>
<p>One question: could it lead to versioning issues if zig platforms use one version of the standard library and the applications people write another?</p>
</blockquote>
<p>Yes it could. Your platform version is tied to a range of roc versions. Outside of those versions, it would interact incorrectly and break</p>



<a name="482262326"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482262326" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482262326">(Nov 13 2024 at 21:13)</a>:</h4>
<p>I implemented deallocations. The current default is not to deallocate. Without the argument <code>--deallocate</code>, <code>roc_dealloc</code> is a noop.</p>
<p>I tested the platform on some of my AoC2023 solutions. I am surprised, that there is no real performance boost if deallocations are skipped. In many cases, the solution was even a bit faster with deallocations.</p>



<a name="482265328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482265328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> teskje <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482265328">(Nov 13 2024 at 21:32)</a>:</h4>
<p>Could it be that the os needs to page in less memory when you are using a smaller part of the backing buffer? Like, when you deallocate and then allocate again, you can reuse already paged-in memory whereas when you don't deallocate each allocation might have to page in new memory</p>



<a name="482266357"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482266357" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482266357">(Nov 13 2024 at 21:39)</a>:</h4>
<p>Yeah, it is likely exactly that...or that plus allocator overhead.</p>



<a name="482266410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482266410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482266410">(Nov 13 2024 at 21:39)</a>:</h4>
<p>Cause allocators may start doing smart things but fall back to slower paths if nothing is being freed</p>



<a name="482266528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482266528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482266528">(Nov 13 2024 at 21:40)</a>:</h4>
<p>Also, you still have the full cost of recounting in roc. The recounting will cost much more than the dealloc generally</p>



<a name="482266592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482266592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482266592">(Nov 13 2024 at 21:40)</a>:</h4>
<p>If you preallocated an arena and paged in roughly the memory needed, you should see some gains</p>



<a name="482267633"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482267633" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482267633">(Nov 13 2024 at 21:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482266592">said</a>:</p>
<blockquote>
<p>If you preallocated an arena and paged in roughly the memory needed, you should see some gains</p>
</blockquote>
<p>Thats what I am doing with or without the <code>--deallocate</code>. I am using the page_allocator to get 1GiB of memory and use the FixedBufferAllocator to manage it: <a href="https://github.com/ostcar/roc-aoc-platform/blob/015c80f03680fa708c119db8371b2351649ce8a7/host/host.zig#L31-L33">https://github.com/ostcar/roc-aoc-platform/blob/015c80f03680fa708c119db8371b2351649ce8a7/host/host.zig#L31-L33</a></p>
<p>So I would think, that the os creates all the pages anyway. Or is it smart enough only to give the memory, when it is actually used?</p>



<a name="482267756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482267756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482267756">(Nov 13 2024 at 21:48)</a>:</h4>
<p>I don't think that the roc refcounting could change anything, since roc does not know that roc_dealloc is a noop.</p>



<a name="482268182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482268182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482268182">(Nov 13 2024 at 21:51)</a>:</h4>
<p>I would have guessed, that it could be CPU cache locality. Less memory could mean less cache misses.</p>
<p>The difference was not so big. Maybe with a better benchmark I would get other numbers. I am currently only measuring the time that <code>roc__solutionForHost_1_exposed_generic</code> needs.</p>



<a name="482269690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482269690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482269690">(Nov 13 2024 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> <a href="#narrow/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482267633">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482266592">said</a>:</p>
<blockquote>
<p>If you preallocated an arena and paged in roughly the memory needed, you should see some gains</p>
</blockquote>
<p>Thats what I am doing with or without the <code>--deallocate</code>. I am using the page_allocator to get 1GiB of memory and use the FixedBufferAllocator to manage it: <a href="https://github.com/ostcar/roc-aoc-platform/blob/015c80f03680fa708c119db8371b2351649ce8a7/host/host.zig#L31-L33">https://github.com/ostcar/roc-aoc-platform/blob/015c80f03680fa708c119db8371b2351649ce8a7/host/host.zig#L31-L33</a></p>
<p>So I would think, that the os creates all the pages anyway. Or is it smart enough only to give the memory, when it is actually used?</p>
</blockquote>
<p>Yeah, I'm pretty sure that will lazily load pages on page fault</p>



<a name="482269735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482269735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482269735">(Nov 13 2024 at 22:02)</a>:</h4>
<p>Which, to be fair, is generally the wanted behaviour</p>



<a name="482269882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482269882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482269882">(Nov 13 2024 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> <a href="#narrow/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482267756">said</a>:</p>
<blockquote>
<p>I don't think that the roc refcounting could change anything, since roc does not know that roc_dealloc is a noop.</p>
</blockquote>
<p>We technically could give platforms control over this setting. The compiler currently has an internal config to change recounting to a no-op. That said, with recounting as a no-op, it also breaks uniqueness analysis...so that may actually be even worse for perf.</p>



<a name="482271314"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482271314" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482271314">(Nov 13 2024 at 22:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482269690">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> <a href="#narrow/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482267633">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482266592">said</a>:</p>
<blockquote>
<p>If you preallocated an arena and paged in roughly the memory needed, you should see some gains</p>
</blockquote>
<p>Thats what I am doing with or without the <code>--deallocate</code>. I am using the page_allocator to get 1GiB of memory and use the FixedBufferAllocator to manage it: <a href="https://github.com/ostcar/roc-aoc-platform/blob/015c80f03680fa708c119db8371b2351649ce8a7/host/host.zig#L31-L33">https://github.com/ostcar/roc-aoc-platform/blob/015c80f03680fa708c119db8371b2351649ce8a7/host/host.zig#L31-L33</a></p>
<p>So I would think, that the os creates all the pages anyway. Or is it smart enough only to give the memory, when it is actually used?</p>
</blockquote>
<p>Yeah, I'm pretty sure that will lazily load pages on page fault</p>
</blockquote>
<p>The difference is really small, so I could be mistaken. But it seems, that when I set the hole memory buffer with <code>@memset(buffer, 'x');</code>, then without deallocations is either faster or the same.</p>



<a name="482274172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482274172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482274172">(Nov 13 2024 at 22:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/482266592">said</a>:</p>
<blockquote>
<p>If you preallocated an arena and paged in roughly the memory needed, you should see some gains</p>
</blockquote>
<p>You are right. I tested the difference between preallocated memory and using the zig GeneralPurposeAllocator:</p>
<div class="codehilite"><pre><span></span><code>GPA with deallocation:
2.692s

GPA without deallocation:
440.34ms

Preallocated with deallocation:
18.369ms

Preallocated without deallocation:
13.631ms
</code></pre></div>
<p>The difference is remarkable.</p>



<a name="482284375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482284375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482284375">(Nov 14 2024 at 00:03)</a>:</h4>
<p>Wow, deallocation costs way more than I expected. I wonder how much of that is simply that zig's GPA is pretty bad currently vs would happen with other allocators.</p>



<a name="482284547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482284547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482284547">(Nov 14 2024 at 00:05)</a>:</h4>
<p>Whoa thats surprising!</p>



<a name="482287025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482287025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482287025">(Nov 14 2024 at 00:31)</a>:</h4>
<p><span class="user-mention" data-user-id="496321">@Oskar Hahn</span> are you able to test with something like: <a href="https://github.com/joadnacer/jdz_allocator">https://github.com/joadnacer/jdz_allocator</a></p>
<p>Or I guess with <code>malloc</code> and <code>free</code>?</p>
<p>Both should be more robust allocators than the gpa.</p>



<a name="482326770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482326770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482326770">(Nov 14 2024 at 07:46)</a>:</h4>
<p>I did more testing. It seems, there are many factors that drastically change the numbers. For example, in the middle of my tests, my laptop battery was empty and I plugged in the power cable. This probably disabled some power safe mode in the CPU and the outcome was twice as fast. The following numbers are all with a power cable. I only included one without the cable for comparison. All the tests are with my AoC2023 solution for day 1 part 2. Maybe other solutions would allocate and free memory in a different way.</p>
<p>And please keep in mind, that I have no experience with benchmarks. I probably did many mistakes (for example running the benchmark directly after running <code>zig build</code> with a hot CPU. If you want  to use the numbers, you should rerun them yourself.</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Here are my numbers</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>GPA zig-debug roc-no-optimize deallocate without Power Cabel<br>
2.884s</p>
<p>GPA zig-debug roc-no-optimize deallocate with Power Cabel<br>
1.727s</p>
<p>GPA zig-debug roc-no-optimize no-dealloc<br>
261.733ms</p>
<p>GPA zig-debug roc-optimize deallocate<br>
1.623s</p>
<p>GPA zig-debug roc-optimize no-dealloc<br>
225.813ms</p>
<p>GPA zig-ReleaseSafe roc-no-optimize deallocate<br>
922.863ms</p>
<p>GPA zig-ReleaseSafe roc-no-optimize no-dealloc<br>
18.917ms</p>
<p>GPA zig-ReleaseSafe roc-optimize deallocate<br>
922.98ms</p>
<p>GPA zig-ReleaseSafe roc-optimize no-dealloc<br>
4.586ms</p>
<p>GPA zig-ReleaseFast roc-no-optimize deallocate<br>
905.64ms</p>
<p>GPA zig-ReleaseFast roc-no-optimize no-dealloc<br>
6.787ms</p>
<p>GPA zig-ReleaseFast roc-optimize deallocate<br>
918.644ms</p>
<p>GPA zig-ReleaseFast roc-optimize no-dealloc<br>
4.849ms</p>
<p>c-malloc zig-Debug roc-optimize deallocate<br>
5.078ms</p>
<p>c-malloc zig-Debug roc-optimize no-dealloc<br>
2.451ms</p>
<p>c-malloc zig-ReleaseSafe roc-optimize deallocate<br>
4.758ms</p>
<p>c-malloc zig-ReleaseSafe roc-optimize no-dealloc<br>
2.589ms</p>
<p>c-malloc zig-ReleaseFast roc-optimize deallocate<br>
4.758ms</p>
<p>c-malloc zig-ReleaseFast roc-optimize no-dealloc<br>
2.576ms</p>
<p>fixed-buffer-allocater zig-Debug roc-optimize deallocate<br>
8.057ms</p>
<p>fixed-buffer-allocater zig-Debug roc-optimize no-dealloc<br>
6.31ms</p>
<p>fixed-buffer-allocater zig-ReleaseSafe roc-optimize deallocate<br>
1.829ms</p>
<p>fixed-buffer-allocater zig-ReleaseSafe roc-optimize no-dealloc<br>
1.668ms</p>
<p>fixed-buffer-allocater zig-ReleaseFast roc-optimize deallocate<br>
1.503ms</p>
<p>fixed-buffer-allocater zig-ReleaseFast roc-optimize no-dealloc<br>
1.536ms</p>
<p>jdz_allocator zig-Debug roc-optimize deallocate<br>
25.22ms</p>
<p>jdz_allocator zig-Debug roc-optimize no-dealloc<br>
8.521ms</p>
<p>jdz_allocator zig-ReleaseSafe roc-optimize deallocate<br>
2.671ms</p>
<p>jdz_allocator zig-ReleaseSafe roc-optimize no-dealloc<br>
2.336ms</p>
<p>jdz_allocator zig-ReleaseFast roc-optimize deallocate<br>
2.503ms</p>
<p>jdz_allocator zig-ReleaseFast roc-optimize no-dealloc<br>
2.216ms</p>
</div></div>
<p>Some conclusions are:</p>
<ul>
<li>You should not benchmark the GPA in a Debug build. It has good debugging support and therefore is no fair comparison. </li>
<li>For this benchmark, there where no big difference between ReleaseFast and ReleaseSafe (ReleaseSmall did not build  dynhost).</li>
<li>The GPA is not good when using deallocate.</li>
<li>c-malloc is not a bad choice.</li>
<li>Nothing beats preallocating memory.</li>
</ul>



<a name="482330378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482330378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482330378">(Nov 14 2024 at 08:10)</a>:</h4>
<p>That rough summary and those numbers match pretty close to my mental model</p>



<a name="482330614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482330614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482330614">(Nov 14 2024 at 08:11)</a>:</h4>
<p>There are plans to make gpa performant. I know there is a larger tracking issue on the zig GitHub, but it really is a very primitive allocator currently that is not very fast. Some people suggested renaming it to debug allocator for now, but they decided not to cause the plan is to improve it until  it is a good general purpose allocator. But in zig today gpa is general not great to use except for debugging</p>



<a name="482768253"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482768253" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482768253">(Nov 16 2024 at 13:01)</a>:</h4>
<p>I am currently thinking about the API of the platform. The current version is <code>[Part1, Part2] -&gt; List U8</code>. For this to work, you have to embed the input file into your roc program.</p>
<p>What I am thinking about is to change this to two functions: <code>part1 : Str -&gt; List U8</code> and <code>part2 : Str -&gt; List U8</code>. So the platform would provide the puzzle input to the Roc script.</p>
<p>The platform could either look for an input file next to the Roc script or read from stdin. If you read the FAQ <a href="https://adventofcode.com/2024/about">Can I copy/redistribute part of Advent of Code?</a>, then reading from stdin sounds like the only allowed option if you want to publish your solutions in a repo.</p>
<p>What do you think? If you want to use the platform for AoC, what would be your preference?</p>



<a name="482769043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482769043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482769043">(Nov 16 2024 at 13:13)</a>:</h4>
<p>I'd definitely prefer to read from an input file, you could set up an example repo for cloning that already has a gitignore for input files so they don't get uploaded.</p>



<a name="482786474"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482786474" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482786474">(Nov 16 2024 at 17:08)</a>:</h4>
<p>This is where the fancy solution would be to write a script that steals cookies from the browser and auto downloads the file to an ignored folder. Would open up the login page if the cookies can't be found.</p>



<a name="482787165"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482787165" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482787165">(Nov 16 2024 at 17:18)</a>:</h4>
<p>This seems possible <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> <br>
<a href="https://pypi.org/project/advent-of-code-data/">https://pypi.org/project/advent-of-code-data/</a></p>



<a name="482787485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/482787485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#482787485">(Nov 16 2024 at 17:23)</a>:</h4>
<p>Yeah, <a href="https://github.com/yt-dlp/yt-dlp">yt-dlp</a> made me think of it. They steal cookies from browser to enable downloading videos from patreon among other protected sites</p>



<a name="484986202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484986202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt Harden <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484986202">(Nov 28 2024 at 21:03)</a>:</h4>
<p>Total Roc beginner here. What's the reason for creating a platform for AoC? Why not use one of the existing "standard" platforms like basic-cli? Is it because you also want to experiment with Roc platforms while you develop for AoC?</p>



<a name="484986329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484986329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484986329">(Nov 28 2024 at 21:05)</a>:</h4>
<p>Just gives a really simple and tailored experience. Could easily do AOC with the basic-cli platform.</p>



<a name="484986626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484986626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt Harden <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484986626">(Nov 28 2024 at 21:08)</a>:</h4>
<p>Is it possible to wrap one platform in another? What if I wanted to use all the code in basic-cli but replace main.roc with my own? Would I have to fork it or can I wrap it somehow?</p>



<a name="484987761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484987761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484987761">(Nov 28 2024 at 21:21)</a>:</h4>
<p>I think you can replace the term platform with the term framework in other languages.</p>
<p>For example in python, you can use Django to create a webpage with one input element. For you use a much simpler framework.</p>
<p>I would say, basic-cli is like Django. You can do many things with it. But for AoC, you just need to transform an input string.</p>
<p>I like simple solutions. And a small AoC framework/platform seems much simpler then basic-cli.</p>



<a name="484987916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484987916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt Harden <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484987916">(Nov 28 2024 at 21:23)</a>:</h4>
<p>Ah, I see the motivation then. Thanks. Are there things in basic-cli that go beyond Roc builtins, or does your platform drop parts of the builtin stuff for simplicity's sake?</p>



<a name="484988995"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484988995" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt Harden <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484988995">(Nov 28 2024 at 21:34)</a>:</h4>
<p>Never mind; I see all the extra complexity in basic-cli. The Roc platform concept is kind of interesting / new to me; I'm used to all of the things in basic-cli just being always available but I like the idea of a platform being as simple as possible for the purpose.</p>



<a name="484989698"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484989698" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484989698">(Nov 28 2024 at 21:42)</a>:</h4>
<p>If you're interested I've also got a template for AoC I shared. It's using basic-cli and is just a roc package. </p>
<p><a href="#narrow/channel/358903-advent-of-code/topic/2024.20AoC.20Template/near/481387177">https://roc.zulipchat.com/#narrow/channel/358903-advent-of-code/topic/2024.20AoC.20Template/near/481387177</a></p>
<p>Technically you could use any platform that provides the required effects to pass in a module parameters to the package, but realistically basic-cli is probably the easiest rn.</p>



<a name="484989773"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484989773" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt Harden <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484989773">(Nov 28 2024 at 21:43)</a>:</h4>
<p>Thanks!</p>



<a name="484990524"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/484990524" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matt Harden <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#484990524">(Nov 28 2024 at 21:52)</a>:</h4>
<p>I think I'll try my hand at a super simple Go based platform. I like the idea of a solution "part" being just a function from a string (or maybe list of strings) to another string. The platform can handle reading the input and writing the output.</p>



<a name="485501095"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/485501095" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#485501095">(Dec 01 2024 at 17:51)</a>:</h4>
<p>I changed the signature of the platform. Now, it requires the functions <code>part1 : Str -&gt; Result Str _</code> and <code>part2 : Str -&gt; Result Str _</code></p>
<p>To work with <code>List U8</code> was not so nice in the tests, since the values are not shown as string, but as a List of ascii codes.</p>
<p>The new signature works good with <code>try</code>.</p>



<a name="486530151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486530151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486530151">(Dec 06 2024 at 14:45)</a>:</h4>
<p>I found out today, that the zig FixedBufferAllocator does not support deallocation. It can free the last allocation, but not anything before that.</p>
<p>This does not work with the way roc uses the allocator.</p>
<p>Its a bit sad, but I had to switch back to a c-allocator. </p>
<p>Here is the <a href="https://github.com/ziglang/zig/issues/3049">zig issue</a>. I also asked in there help discord channel. It seems, that there is no FixBufferAllocator, that can deallocate.</p>



<a name="486531065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486531065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486531065">(Dec 06 2024 at 14:50)</a>:</h4>
<p>That seems strange, I thought that TigerBeetle used a FixedBufferAllocator for the entire lifetime of the database</p>



<a name="486531195"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486531195" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486531195">(Dec 06 2024 at 14:51)</a>:</h4>
<p>But I guess what they actually say is they _never allocate_ while the database is running, after setup</p>



<a name="486531299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486531299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486531299">(Dec 06 2024 at 14:51)</a>:</h4>
<p>So maybe they do, but then initialize all the structs within that layout and never worry about deallocation from then on</p>



<a name="486531313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486531313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486531313">(Dec 06 2024 at 14:51)</a>:</h4>
<p>Yes, that is what they saying. I have not looked, how they do it</p>



<a name="486531447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486531447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486531447">(Dec 06 2024 at 14:52)</a>:</h4>
<p>I think there DB just has a very specific structure where they can precisely lay out everything from the beginning</p>



<a name="486531524"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486531524" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486531524">(Dec 06 2024 at 14:52)</a>:</h4>
<p>And they use asserts EVERYWHERE to make sure none of their invariants are broken during development</p>



<a name="486531565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486531565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486531565">(Dec 06 2024 at 14:53)</a>:</h4>
<p>That's their "TigerStyle" coding practice</p>



<a name="486552383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486552383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486552383">(Dec 06 2024 at 16:34)</a>:</h4>
<p>Yeah, tiger beetle only allocated once and never deallocates</p>



<a name="486552421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486552421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486552421">(Dec 06 2024 at 16:34)</a>:</h4>
<p>Everything accounted for up front</p>



<a name="486552478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486552478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486552478">(Dec 06 2024 at 16:35)</a>:</h4>
<p>Fixed buffer allocator is just a limited arena allocator</p>



<a name="486552833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486552833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486552833">(Dec 06 2024 at 16:36)</a>:</h4>
<p><span class="user-mention" data-user-id="496321">@Oskar Hahn</span> what is your goal for the allocator? Why use a fixed buffer in the first place?</p>



<a name="486646519"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486646519" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486646519">(Dec 07 2024 at 08:01)</a>:</h4>
<p>I thought, it would be faster. And for advent of code, it seemed like a good trade of, to allocate one big chunk of memory at the beginning</p>



<a name="486649425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486649425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486649425">(Dec 07 2024 at 08:44)</a>:</h4>
<p>That's fair. Depending on the exact goals, something like the allocator for roc wasm4 may work. It is written in zig and very light weight. Could give it a chunk of memory and it will still properly free. The allocator it's a copy of was specifically designed to be light weight for embedded.</p>



<a name="486778329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486778329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486778329">(Dec 08 2024 at 15:23)</a>:</h4>
<p>In the zig forum, there was the hint to use a <a href="https://ziglang.org/documentation/master/std/#std.heap.memory_pool.MemoryPoolExtra">MemoryPool</a></p>
<p>There could be pools specific sizes, like 100 bytes, 100 kb etc. For big values, it could fall back to a "normal" allocator.</p>
<p>Of cause, this is a lot of wasted space, but this would work with a preallocated memory.</p>
<p>Since the memory is big enough, the wast should not be a problem. I also don't think that it is a CPU-cache problem, since each memory is packed. Only the space between to allocations is bigger then needed. But there is no guaranty anyway, that two allocations are next to each other.</p>



<a name="486783810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486783810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486783810">(Dec 08 2024 at 16:37)</a>:</h4>
<p>Yeah, all allocators use various levels of pools. Generally after a certain size they fall back on more direct allocation via mmap.</p>



<a name="486783895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486783895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486783895">(Dec 08 2024 at 16:38)</a>:</h4>
<p>The allocator for roc wasm4 assumes a fixed size memory limit and has no fallback, but otherwise should be quite fast and generally light on resources</p>



<a name="486783953"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486783953" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486783953">(Dec 08 2024 at 16:39)</a>:</h4>
<p>More robust allocators like tcmalloc, mimalloc and jbz allocator have a lot of tricks, but they also have a lot of complexity due to expecting multithreaded complex applications.</p>



<a name="486784201"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/486784201" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#486784201">(Dec 08 2024 at 16:42)</a>:</h4>
<p>I would guess allocating is rarely a noticeable bottleneck for Advent of code applications, but if you want to try preallocating a specific size chunk of memory for allocation, you could give this a try based on umm_malloc: <a href="https://github.com/lukewilliamboswell/roc-wasm4/blob/main/platform/allocator.zig">https://github.com/lukewilliamboswell/roc-wasm4/blob/main/platform/allocator.zig</a></p>



<a name="490044835"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/304902-show%20and%20tell/topic/Advent%20of%20Code%20platform/near/490044835" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/304902-show-and-tell/topic/Advent.20of.20Code.20platform.html#490044835">(Dec 19 2024 at 20:32)</a>:</h4>
<p>Following up on the original post here, for anyone look for more zig platform examples. I've taken some hints from your build.zig file, Oskar, then added some additional features to the one I'm using for a Zig-based Roc platform:</p>
<ul>
<li>Add dependencys from off the roc commands on all the .roc files in a directory, to ensure the build system will rerun those commands if any roc source file changes.</li>
<li>Generation of platform documentation.</li>
</ul>
<p>That can be found here in case it's of use to anyone!<br>
<a href="https://github.com/jwoudenberg/jay/blob/main/build.zig">https://github.com/jwoudenberg/jay/blob/main/build.zig</a></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Boxing Anything · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html">Boxing Anything</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="449373361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449373361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449373361">(Jul 05 2024 at 18:26)</a>:</h4>
<p>Just to ask this concretely, should these effects be allowed:</p>
<div class="codehilite"><pre><span></span><code>storeAnything : Box a -&gt; Effect U64
loadAnything : U64 -&gt; Effect (Box a)
</code></pre></div>
<p>They are fundamentally what enable dynamic FFI and would enable caching any data in basic webserver. They just have no type safety. Unless <code>loadAnything</code> could inspect the type expected to be returned, roc user code could request a <code>Box Str</code> when you actually have a <code>Box U64</code> stored.</p>



<a name="449382296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449382296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449382296">(Jul 05 2024 at 19:27)</a>:</h4>
<p>These remind me a bit of the <code>Var</code> type in Haskell. Maybe you're already familiar, their types (translated to Roc syntax) would are like:</p>
<div class="codehilite"><pre><span></span><code>new : Box a -&gt; Effect (Var a)
read: Var a -&gt; Effect (Box a)
write: Var a, Box a -&gt; Effect {}
</code></pre></div>
<p>Where <code>Var a</code> represents a mutable reference to some value of type <code>A</code>. I think that would allow caching in a type-safe manner.</p>



<a name="449383034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449383034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449383034">(Jul 05 2024 at 19:29)</a>:</h4>
<p>I don't think roc currently would allow you to define <code>Var a</code> cause it would have an unused type variable.</p>



<a name="449384474"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449384474" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449384474">(Jul 05 2024 at 19:35)</a>:</h4>
<p>Also, just to give the more complex ffi example, it is essentially:</p>
<div class="codehilite"><pre><span></span><code>ffi: Lib, Str, Box a -&gt; Effect (Box b)
</code></pre></div>
<p>So I don't think there is any sort of <code>Var a</code> strategy that could work. But I think that is expected. Obviously ffi, can totally transform types.</p>



<a name="449384683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449384683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449384683">(Jul 05 2024 at 19:36)</a>:</h4>
<p>I think Roc allows it. Maybe I misunderstand?</p>
<div class="codehilite"><pre><span></span><code>$ roc repl
» Var a := U64
» mkvar : a -&gt; Var a
… mkvar = \_ -&gt; @Var 42

&lt;function&gt; : a -&gt; Var a
» mkvar &quot;Hi!&quot;

@Var 42 : Var Str
</code></pre></div>



<a name="449384788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449384788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449384788">(Jul 05 2024 at 19:36)</a>:</h4>
<p>Oh interesting. I thought we generated a warning for that. Guess not.</p>



<a name="449385874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449385874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449385874">(Jul 05 2024 at 19:41)</a>:</h4>
<p>I think we don't because phantom types are useful <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="449386203"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449386203" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449386203">(Jul 05 2024 at 19:44)</a>:</h4>
<p>yeah it's an error for type aliases but not even a warning for opaque type (because yeah, phantom types are useful!)</p>



<a name="449386286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449386286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449386286">(Jul 05 2024 at 19:45)</a>:</h4>
<p>Ah, alias vs opaque. Makes sense.</p>



<a name="449386619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449386619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449386619">(Jul 05 2024 at 19:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Boxing.20Anything/near/449373361">said</a>:</p>
<blockquote>
<p>Just to ask this concretely, should these effects be allowed:</p>
<div class="codehilite"><pre><span></span><code>storeAnything : Box a -&gt; Effect U64
loadAnything : U64 -&gt; Effect (Box a)
</code></pre></div>
<p>They are fundamentally what enable dynamic FFI and would enable caching any data in basic webserver. They just have no type safety. Unless <code>loadAnything</code> could inspect the type expected to be returned, roc user code could request a <code>Box Str</code> when you actually have a <code>Box U64</code> stored.</p>
</blockquote>
<p>this is a very good question</p>



<a name="449386657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449386657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449386657">(Jul 05 2024 at 19:48)</a>:</h4>
<p>there's some other way to do it which is less efficient, right?</p>



<a name="449386660"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449386660" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449386660">(Jul 05 2024 at 19:48)</a>:</h4>
<p>like with <code>List U8</code> instead of <code>a</code></p>



<a name="449387069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449387069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449387069">(Jul 05 2024 at 19:51)</a>:</h4>
<p>Yeah, you could do a <code>List U8</code> instead of <code>Box a</code> and force some form of encoding and decoding.</p>



<a name="449387161"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449387161" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449387161">(Jul 05 2024 at 19:52)</a>:</h4>
<p>You also can make it type safe with <code>Var a</code> as <span class="user-mention" data-user-id="477725">@Jasper Woudenberg</span> mentioned.</p>



<a name="449387236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449387236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449387236">(Jul 05 2024 at 19:53)</a>:</h4>
<p>To the platform, box is just a pointer, so they can handle and store it safely for the most part. (refcounting may have some complications, but I'm not 100% sure)</p>



<a name="449399995"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449399995" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449399995">(Jul 05 2024 at 21:21)</a>:</h4>
<p>yeah I think for now we should be conservative and disallow this</p>



<a name="449400032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449400032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449400032">(Jul 05 2024 at 21:21)</a>:</h4>
<p>and consider supporting it in the future if there’s demand for it in practice</p>



<a name="449400117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449400117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449400117">(Jul 05 2024 at 21:22)</a>:</h4>
<p>because it’s both super unsafe and also prevents an automatic replay feature</p>



<a name="449400143"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449400143" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449400143">(Jul 05 2024 at 21:22)</a>:</h4>
<p>because we can’t know the layout of what’s behind that pointer, so we don’t know how to write it down to replay it later</p>



<a name="449400270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449400270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449400270">(Jul 05 2024 at 21:24)</a>:</h4>
<p>Hmm... You have to allow some form of it due to <code>Box a</code> being used for models? Or is that different</p>



<a name="449400422"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449400422" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449400422">(Jul 05 2024 at 21:26)</a>:</h4>
<p>Like in an elm architecture style app</p>



<a name="449403865"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449403865" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449403865">(Jul 05 2024 at 22:04)</a>:</h4>
<p>yeah that's different</p>



<a name="449403869"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449403869" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449403869">(Jul 05 2024 at 22:04)</a>:</h4>
<p>I specifically mean <code>*</code></p>



<a name="449404018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404018">(Jul 05 2024 at 22:06)</a>:</h4>
<p>hm, actually</p>



<a name="449404030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404030">(Jul 05 2024 at 22:06)</a>:</h4>
<p>I guess for replay we can know what the type is after monomorphization <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="449404055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404055">(Jul 05 2024 at 22:07)</a>:</h4>
<p>because we'll have inferred it</p>



<a name="449404069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404069">(Jul 05 2024 at 22:07)</a>:</h4>
<p>so we could use that to know the layout, which in turn means we'd know how to traverse it for replay</p>



<a name="449404094"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404094" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404094">(Jul 05 2024 at 22:07)</a>:</h4>
<p>Yeah, roc knows all the types. The platform just doesnt</p>



<a name="449404098"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404098" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404098">(Jul 05 2024 at 22:07)</a>:</h4>
<p>it's unsafe, but to be fair, literally anything we get from the host could be a bad pointer</p>



<a name="449404104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404104">(Jul 05 2024 at 22:07)</a>:</h4>
<p>so it's all equally unsafe in that sense</p>



<a name="449404156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404156">(Jul 05 2024 at 22:08)</a>:</h4>
<p>the difference is whether application authors can cause UB</p>



<a name="449404157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404157">(Jul 05 2024 at 22:08)</a>:</h4>
<p>The part that makes it less safe is that if exposed directly to userland, the app author can hit it</p>



<a name="449404160"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404160" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404160">(Jul 05 2024 at 22:08)</a>:</h4>
<p>which they can if we allow this, and can't if we don't allow this</p>



<a name="449404161"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404161" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404161">(Jul 05 2024 at 22:08)</a>:</h4>
<p>right</p>



<a name="449404234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449404234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449404234">(Jul 05 2024 at 22:09)</a>:</h4>
<p>so we'd go from "only platform authors can cause UB" to "application authors (or any of the libraries they use which return <code>Task</code>) can cause UB if the platform supports it"</p>



<a name="449405940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449405940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449405940">(Jul 05 2024 at 22:20)</a>:</h4>
<p>Yep. Though I don't think UB is the right term. More like can generate totally broken bindings that crash the app or return garbage data.</p>
<p>That said, it is one of those weird cases where depending on how it is exposed, it could be totally safe. Like stored with <code>Var a</code>. So kinda a case where it enables new features, but those features may have too much power</p>



<a name="449408175"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449408175" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449408175">(Jul 05 2024 at 22:42)</a>:</h4>
<p>unfortunately I think UB is accurate here <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="449408280"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449408280" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449408280">(Jul 05 2024 at 22:43)</a>:</h4>
<p>if you get the layout wrong, all bets are off and anything could happen</p>



<a name="449408459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449408459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449408459">(Jul 05 2024 at 22:43)</a>:</h4>
<p>including overwriting data in a completely unrelated data structure which was unfortunate enough to be adjacent in memory to the thing with the wrong layout, which in turn leads to other incorrect pointers, which…etc etc</p>



<a name="449408566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449408566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449408566">(Jul 05 2024 at 22:45)</a>:</h4>
<p>yeah this feels like “we can always introduce support later if it feels worth it, but it would be a big breaking change to take away if we support it now and regret it later”</p>



<a name="449409207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449409207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449409207">(Jul 05 2024 at 22:53)</a>:</h4>
<p>UB is just a very specific compiler term that means something different. Like when c++ or llvm says UB, it means that they won't specify a specific behaviour generally for performance reasons. Then the optimizer will pick the faster choice for the specific hardware.</p>
<p>Having a wrong layout for a call isn't UB. It is totally incorrect and broken code.</p>



<a name="449409259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449409259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449409259">(Jul 05 2024 at 22:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/Boxing.20Anything/near/449408566">said</a>:</p>
<blockquote>
<p>yeah this feels like “we can always introduce support later if it feels worth it, but it would be a big breaking change to take away if we support it now and regret it later”</p>
</blockquote>
<p>Note, we do support this today</p>



<a name="449414513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449414513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449414513">(Jul 05 2024 at 23:45)</a>:</h4>
<p>i’m pretty sure exposing any generic types to the platform, in either input or output is a bad idea</p>



<a name="449414527"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449414527" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449414527">(Jul 05 2024 at 23:45)</a>:</h4>
<p>it feels like a mistake that it can be done today</p>



<a name="449414563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449414563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449414563">(Jul 05 2024 at 23:45)</a>:</h4>
<p>How are you supposed to do something elm architecture like then?</p>



<a name="449414606"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449414606" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449414606">(Jul 05 2024 at 23:46)</a>:</h4>
<p>Where the model depends on the app?</p>



<a name="449414746"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449414746" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449414746">(Jul 05 2024 at 23:48)</a>:</h4>
<p>that seems like a special case, because the type is specialized to the app right? in that case the runtime should box the model type, but it’s not generic in the sense that the application cannot call it with any other type</p>



<a name="449415340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449415340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449415340">(Jul 05 2024 at 23:52)</a>:</h4>
<p>said another way, from the perspective of the app there are no generic inputs or outputs</p>



<a name="449415445"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449415445" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449415445">(Jul 05 2024 at 23:55)</a>:</h4>
<p>In all of these cases, I think we are talking about actually sending a <code>Box a</code> over to the platform. The app is required to know what <code>a</code> is. I guess in the ffi case specifically, it is so flexible that generally it requires a type annotation or roc compilation will break.</p>



<a name="449415489"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449415489" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449415489">(Jul 05 2024 at 23:55)</a>:</h4>
<p>I think any sort of type variable passed to the platform has to be wrapped in an indirection. So like <code>List a</code> or <code>Box a</code>. I 100% agree that a raw <code>a</code> passed to a platform is definitely wrong.</p>



<a name="449416022"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449416022" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449416022">(Jul 06 2024 at 00:02)</a>:</h4>
<p>to me the problem is that this allows the programmer to write a function a -&gt; b where a and b are generic. i think this is prone to writing mistakes, and makes it hard to manage your applications (whenever you change the input or output type, you need to make sure the types propagate but the compiler won’t help you). i think the right solution is runtime type tagging (not saying the language runtime should provide that, but some serialization should be used). The model case is a bit different I think because the programmer must explicitly type the model type (as something non-generic), and so you don’t end up being able to write a function a-&gt;b</p>



<a name="449417051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417051">(Jul 06 2024 at 00:15)</a>:</h4>
<p>I think nested runtime type tagging would be too slow. On the otherhand, I think sideband type tagging could work great.</p>
<p>Basically <code>taggedEffect (Box.box a) (Type.type a)</code></p>
<p>Where if <code>a</code> is a <code>List (Str, I32)</code>, <code>Type.type</code> would return a tag explaining that info <code>ListType (TupleType [StrType, I32Type])</code>.</p>



<a name="449417150"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417150" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417150">(Jul 06 2024 at 00:17)</a>:</h4>
<p>Then the roc type only has to be boxed and no other serialization has to happen. <code>Type.type</code> would actually always be a compile time constant. So no cost to building it out. Mono would just know the answer.</p>



<a name="449417285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417285">(Jul 06 2024 at 00:19)</a>:</h4>
<p>yeah, that’s a much larger change though. that has some things to figure out too, for example if you do not want to add type tags to all runtime values you need to figure out where to drop them-and it may not be trivial to do so, because of the vitality of type inference</p>



<a name="449417417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417417">(Jul 06 2024 at 00:21)</a>:</h4>
<p>Why is it such a large change? after type inference runs and mono, won't the variable <code>a</code> have a concrete type. So it would just be running a mapping over the concrete type of a? I mean today, inspect could be used to build the <code>Type.type</code> function.</p>



<a name="449417556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417556">(Jul 06 2024 at 00:23)</a>:</h4>
<p>yes, but there a lot of details to discuss - how and when to check the tags, whether to infer whether tags should be added, the tag representation, so on. you’re right that it’s simple, but my guess is it’s not trivial to implement. yes, the actual tag to add is easy to compute</p>



<a name="449417606"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417606" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417606">(Jul 06 2024 at 00:24)</a>:</h4>
<p>Ok, yeah. Totally agree with that sentiment.</p>



<a name="449417641"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417641" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417641">(Jul 06 2024 at 00:25)</a>:</h4>
<p>I just want to make sure we don't lock to only decode/encode. I think that would be really sad for the perf story of some common patterns. Even having to box is a bit sad, but it gets around variable sized types so makes sense.</p>



<a name="449417733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417733">(Jul 06 2024 at 00:26)</a>:</h4>
<p>I also empathize with the concern about runtime type data being too slow, but i would suggest using serialization at the ffi boundary for now until performance becomes a concern in practice at which point some ecosystem or language level solution can be devised. i don’t think any real uses of Roc are going to run into a performance problem here while Roc is still being used for small/medium enterprise applications - and if you do run into something that has a perf problem, you can create a special-case effect. reducing the surface area of the language also makes development easier; there are still a ton of holes in compilation, and might be worth avoiding another potential source of those right now.</p>



<a name="449417857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449417857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449417857">(Jul 06 2024 at 00:28)</a>:</h4>
<blockquote>
<p>reducing the surface area of the language also makes development easier; there are still a ton of holes in compilation, and might be worth avoiding another potential source of those right now.</p>
</blockquote>
<p>Very true</p>



<a name="449418101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449418101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449418101">(Jul 06 2024 at 00:31)</a>:</h4>
<p>I guess maybe we just need someone to implement a simple binary serialization format that avoids needing to tag every individual piece of data. Make sure it can represent a <code>List (Str, Int)</code> without generating the equivalent of everything being nested <code>RocObject</code>s. Where you have a <code>RocObject (List) -&gt; RocObject (Tuple) -&gt; RocObject(Str/Int)</code>. Cause that is a horrid amount of wrapping that would definitely ruin perf.</p>



<a name="449418123"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449418123" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449418123">(Jul 06 2024 at 00:31)</a>:</h4>
<p>Also, by invent, probably just mean implement. I'm sure something must exist.</p>



<a name="449421574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449421574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449421574">(Jul 06 2024 at 01:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Boxing.20Anything/near/449418101">said</a>:</p>
<blockquote>
<p>I guess maybe we just need someone to implement a simple binary serialization format that avoids needing to tag every individual piece of data. Make sure it can represent a <code>List (Str, Int)</code> without generating the equivalent of everything being nested <code>RocObject</code>s. Where you have a <code>RocObject (List) -&gt; RocObject (Tuple) -&gt; RocObject(Str/Int)</code>. Cause that is a horrid amount of wrapping that would definitely ruin perf.</p>
</blockquote>
<p>this would be a nice binary serialization format to have in general, not just for FFI!</p>



<a name="449423289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449423289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449423289">(Jul 06 2024 at 01:50)</a>:</h4>
<p>Yeah, maybe that will be something I dig into after sqlite. Not really sure what binary format to target though.</p>
<p>Things like <a href="https://protobuf.dev/">protobuf</a> and <a href="https://capnproto.org/">cap'n proto</a> have no type info in the serialized format and require codegen for decode/encode.</p>
<p><a href="https://msgpack.org/">msgpack</a> or maybe <a href="https://bsonspec.org/">bson</a> look reasonable. They have repeated types inline, which is kinda annoying. So a list of 100 strings specifies that each individual element in the list is a string. That said, with both of these, specifying the element type is a single byte. And everything gets built into a single flat buffer. So should be reasonable for perf.</p>
<p><a href="https://avro.apache.org/">apache avro</a> is one of the few things that seems to have out of band types that are sent as metadata. They send the types as json for some reason. I guess it is meant for big data, so parsing a single json to learn you are decoding a <code>List (Str, Int)</code> is no big deal. Then the actual data is densely packed with no type info.</p>
<p>Anyone have general input on binary formats with type info? I would guess that <code>bson</code> is the most popular simply because it is used with mongo db. That said, <code>msgpack</code> looks a lot cleaner and simpler. But I don't really have much knowledge of the various options in this space.</p>



<a name="449423709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449423709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449423709">(Jul 06 2024 at 01:56)</a>:</h4>
<p>Not quite sure if its the same. But folkert mentioned this format to me when I was asking about something similar <a href="https://postcard.jamesmunns.com/wire-format">https://postcard.jamesmunns.com/wire-format</a></p>



<a name="449423724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449423724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449423724">(Jul 06 2024 at 01:57)</a>:</h4>
<p>Benefit would be interop with rust</p>



<a name="449424329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449424329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449424329">(Jul 06 2024 at 02:01)</a>:</h4>
<p>I think <code>postcard</code> is in the same category as <code>protobuf</code> and <code>cap'n proto</code>. Totally type unsafe. I think it is kinda a simpler variant of those two libraries.</p>
<p>So if you pick the wrong type to decode into <code>List (I32, Str)</code> when it should have been <code>List (U64, Str)</code>, you will just decode wrong. It may fail. It may succeed and just give you garbage data.</p>
<p>I think for our first spec here, we probably want something with some form of type info, but maybe that is a wrong assumption.</p>



<a name="449463644"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449463644" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449463644">(Jul 06 2024 at 09:13)</a>:</h4>
<p>One possibility would be to have a header section with a serialized version of the <code>Layout</code>, then a body section with the actual data, in the same format we use at runtime. Pointers would get translated to byte offsets within the payload.</p>
<p>That pointer translation is something we already do in the Web REPL, where the user's compiled app is in a separate address space from the REPL app.</p>



<a name="449476184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449476184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449476184">(Jul 06 2024 at 10:49)</a>:</h4>
<p>we can make a roc-specific one like rvn if there’s nothing off the shelf that does what we want!</p>



<a name="449512412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449512412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449512412">(Jul 06 2024 at 15:36)</a>:</h4>
<p>For sure. I was trying to find something off the shelf simply to help with value. Like bson would both help here and would be useful if someone interacts with mongo DB. Plus it means we don't have to implement it in all host languages.</p>



<a name="449512595"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449512595" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449512595">(Jul 06 2024 at 15:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="431893">Brian Carroll</span> <a href="#narrow/stream/395097-compiler-development/topic/Boxing.20Anything/near/449463644">said</a>:</p>
<blockquote>
<p>One possibility would be to have a header section with a serialized version of the <code>Layout</code>, then a body section with the actual data, in the same format we use at runtime. Pointers would get translated to byte offsets within the payload.</p>
</blockquote>
<p>This is something I am trying to make as a Encoder/Decoder written in roc. I think it would actually be pretty hard to match Roc's runtime format using an encoder.</p>



<a name="449521706"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Boxing%20Anything/near/449521706" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Boxing.20Anything.html#449521706">(Jul 06 2024 at 16:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Boxing.20Anything/near/449512412">said</a>:</p>
<blockquote>
<p>For sure. I was trying to find something off the shelf simply to help with value. Like bson would both help here and would be useful if someone interacts with mongo DB</p>
</blockquote>
<p>true, although if someone wants bson and we have this, it should give them a very strong starting point!</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
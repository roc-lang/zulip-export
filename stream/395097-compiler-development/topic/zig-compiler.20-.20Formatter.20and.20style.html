<html>
<head><meta charset="utf-8"><title>zig-compiler - Formatter and style · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html">zig-compiler - Formatter and style</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="506122812"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506122812" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506122812">(Mar 17 2025 at 11:31)</a>:</h4>
<p>I want to make this thread so I can ask for pointed feedback on the style of the formatter and any general questions about expectations around formatting</p>



<a name="506123179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506123179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506123179">(Mar 17 2025 at 11:32)</a>:</h4>
<p>I have this EXTREMELY OVER COMMENTED block of code.  Does this look how people could expect it to look if someone had typed this in?  I.e., should this parse and format stably? (Please ignore \\ for zig multiline comments)</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\import # Comment here</span>
<span class="w">        </span><span class="sh">\\    pkg # And here</span>
<span class="w">        </span><span class="sh">\\        .Something # Another one</span>
<span class="w">        </span><span class="sh">\\            exposing # Still commenting</span>
<span class="w">        </span><span class="sh">\\                [ # I really like comments</span>
<span class="w">        </span><span class="sh">\\                    func # Commenting for life</span>
<span class="w">        </span><span class="sh">\\                        as # Even here</span>
<span class="w">        </span><span class="sh">\\                            function, # And here</span>
<span class="w">        </span><span class="sh">\\                    Type # Commenting again</span>
<span class="w">        </span><span class="sh">\\                        as # And again...</span>
<span class="w">        </span><span class="sh">\\                            ValueCategory, # Why can't I stop?</span>
<span class="w">        </span><span class="sh">\\                    Custom # This is getting ridiculous</span>
<span class="w">        </span><span class="sh">\\                        .* # Even Uncle Bob is emabarrased</span>
<span class="w">        </span><span class="sh">\\                ] # And...I'm done</span>
<span class="p">;</span>
</code></pre></div>



<a name="506124483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506124483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506124483">(Mar 17 2025 at 11:38)</a>:</h4>
<p>Seems not unreasonable</p>



<a name="506125021"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506125021" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506125021">(Mar 17 2025 at 11:40)</a>:</h4>
<p>I guess the big question is:  is the principle that in a continuation where there is a comment not at end of line (and not in some collection) that we indent on the next newline and continue?</p>



<a name="506125429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506125429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506125429">(Mar 17 2025 at 11:42)</a>:</h4>
<p>Or should things like qualifier and identifier proceed at the same level of indent?</p>



<a name="506131533"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506131533" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506131533">(Mar 17 2025 at 12:07)</a>:</h4>
<p>The alternative would be:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\import # Comment here</span>
<span class="w">        </span><span class="sh">\\    pkg # And here</span>
<span class="w">        </span><span class="sh">\\    .Something # Another one</span>
<span class="w">        </span><span class="sh">\\        exposing # Still commenting</span>
<span class="w">        </span><span class="sh">\\            [ # I really like comments</span>
<span class="w">        </span><span class="sh">\\                func # Commenting for life</span>
<span class="w">        </span><span class="sh">\\                    as # Even here</span>
<span class="w">        </span><span class="sh">\\                    function, # And here</span>
<span class="w">        </span><span class="sh">\\                Type # Commenting again</span>
<span class="w">        </span><span class="sh">\\                    as # And again...</span>
<span class="w">        </span><span class="sh">\\                    ValueCategory, # Why can't I stop?</span>
<span class="w">        </span><span class="sh">\\                Custom # This is getting ridiculous</span>
<span class="w">        </span><span class="sh">\\                    .* # Even Uncle Bob is emabarrased</span>
<span class="w">        </span><span class="sh">\\            ] # And...I'm done</span>
<span class="p">;</span>
</code></pre></div>



<a name="506131871"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506131871" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506131871">(Mar 17 2025 at 12:09)</a>:</h4>
<p>I'll also write up an example with complex binops as well.  There are SO many places where comments could be inserted there</p>



<a name="506134438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506134438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506134438">(Mar 17 2025 at 12:19)</a>:</h4>
<p>On balance, less rightward drift seems good - but this is such an unusual situation that I’m not particularly concerned about it</p>



<a name="506275070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506275070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506275070">(Mar 17 2025 at 22:33)</a>:</h4>
<p>I'd push for less rightward drift whenever consistently possible, so the second example is preferable to me</p>



<a name="506276391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506276391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506276391">(Mar 17 2025 at 22:42)</a>:</h4>
<p>Hmm. I think it should be consistent with what we would do for a function chain</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">x</span>
<span class="w">    </span><span class="o">.</span><span class="n">y</span>
<span class="w">    </span><span class="o">.</span><span class="n">transform</span><span class="p">()</span>
<span class="w">    </span><span class="o">.</span><span class="n">run!</span><span class="p">()</span>
</code></pre></div>
<p>So I would vote for this:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\import # Comment here</span>
<span class="w">        </span><span class="sh">\\    pkg # And here</span>
<span class="w">        </span><span class="sh">\\        .ExtraNesting # not sure this is actualy valid, but just an example of more nesting</span>
<span class="w">        </span><span class="sh">\\        .Something # Another one</span>
<span class="w">        </span><span class="sh">\\            exposing # Still commenting</span>
<span class="w">        </span><span class="sh">\\                [ # I really like comments</span>
<span class="w">        </span><span class="sh">\\                    func # Commenting for life</span>
<span class="w">        </span><span class="sh">\\                        as # Even here</span>
<span class="w">        </span><span class="sh">\\                        function, # And here</span>
<span class="w">        </span><span class="sh">\\                    Type # Commenting again</span>
<span class="w">        </span><span class="sh">\\                        as # And again...</span>
<span class="w">        </span><span class="sh">\\                        ValueCategory, # Why can't I stop?</span>
<span class="w">        </span><span class="sh">\\                    Custom # This is getting ridiculous</span>
<span class="w">        </span><span class="sh">\\                        .* # Even Uncle Bob is emabarrased</span>
<span class="w">        </span><span class="sh">\\                ] # And...I'm done</span>
<span class="p">;</span>
</code></pre></div>



<a name="506277058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506277058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506277058">(Mar 17 2025 at 22:46)</a>:</h4>
<p>yeah I agree with that</p>



<a name="506277153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506277153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506277153">(Mar 17 2025 at 22:46)</a>:</h4>
<p>I don't think anyone is actually going to write comments in all these places, so I don't think the quantity of indentation really matters here</p>



<a name="506277220"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/506277220" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#506277220">(Mar 17 2025 at 22:47)</a>:</h4>
<p>I think what's more important is that if you put comments in a small subset of these places, it looks consistent with what we do elsewhere</p>



<a name="536179002"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/536179002" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#536179002">(Aug 26 2025 at 07:53)</a>:</h4>
<p>Hi, first thanks to <span class="user-mention" data-user-id="639239">@JRI98</span> for fixing the remaining multiline string issues that I caused.</p>
<p>While looking at the formatter I saw the following remaining issues, that I would like to confirm before taking a shot at them:</p>
<p>The formatter does not make sure files end in a newline. According to POSIX they should. But this will change probably all snapshots when implementing.</p>
<p>The formatter removes everything that is malformed. I think it should just put out the original code for malformed nodes. I'm not sure how easy that is to implement, but I could imagine that it's not that easy, because I noticed the ranges of the malformed nodes is not always what I would expect.</p>



<a name="536181433"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/536181433" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JRI98 <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#536181433">(Aug 26 2025 at 08:08)</a>:</h4>
<p>Hello. I actually ended up breaking more stuff <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span><br>
But I have a new PR that should finally fix it <a href="https://github.com/roc-lang/roc/issues/8225">#8225</a>. It should be easier if we track if the last printed node was a multiline string.</p>
<p>Regarding the newline at the end of the file, sounds good to me.</p>
<p>When it comes to malformed nodes, I have thought about it before, but it is a particularity of the snapshots, because when formatting a file outside of them, the formatter doesn't change the file if it doesn't parse correctly.<br>
What we could do is mimic the same behavior for snapshots and only try to format if the input parses correctly. And it has been a source of fuzz crashes in the past, when it practice they wouldn't happen outside of the snapshotting environment.</p>



<a name="536184491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%20-%20Formatter%20and%20style/near/536184491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style.html#536184491">(Aug 26 2025 at 08:27)</a>:</h4>
<p>Ok, I will leave the malformed nodes alone, just not formatting sounds way better.</p>
<p>I will have a look at the EOF newline. Probably easy to do. I think it's best to also update the snapshot tool to include the newline as part of the source and expect it as part of the formatted output. That should reduce the changes to the snapshots.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
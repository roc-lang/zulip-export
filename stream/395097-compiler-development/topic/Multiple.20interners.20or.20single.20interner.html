<html>
<head><meta charset="utf-8"><title>Multiple interners or single interner · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html">Multiple interners or single interner</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="499161465"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499161465" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499161465">(Feb 12 2025 at 07:02)</a>:</h4>
<p>Currently the new compiler has multiple interners based roughly on the outline Agus made for the Rust-based compiler's <code>specialize_types</code> pass. There's an array of tag_names, field_names, idents, etc. I thought that copying this would be a good pattern to help get the type safety that we got in Rust, e.g. an <code>Index&lt;TagName&gt;</code> in Rust can only be used for looking up tag names, mirrored in the Zig rewrite with a <code>TagName.Idx</code>.</p>
<p>However, I'm not sure if this is the right move. For one, the interners for everything but string literals are deduplicated, meaning we can't deduplicate variables names and record field names with the same names, taking more space. More importantly, if we want to look up a name, we can only look for things with that intern kind, meaning we can't do constant-time lookup of a tag name using a type name. That shouldn't be too much of a problem though: the only place I think the same token represents two different interned types is name punning, AKA records like <code>{ field_name }</code>. That just means we'd need to convert that to <code>{ field_name: field_name }</code> during desugaring and potentially copy the name <code>field_name</code> from the record field interner to the ident one.</p>
<p>So with that in mind, I'm not seeing one option as <em>definitely better</em> but I'd rather have type safety than a little space conservation.</p>
<p>For the parsing team, would there be any problems with interning into different interners based on the token type? I presume we'd be good to do that. If so, I'll probably make a change to break into more groups of types, e.g. one for module names, one for type names, etc.</p>



<a name="499161544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499161544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499161544">(Feb 12 2025 at 07:03)</a>:</h4>
<p>And to those outside of <span class="user-mention" data-user-id="453336">@Joshua Warner</span> and <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> , do you think there's a strong reason to prefer one or multiple interners?</p>



<a name="499162045"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162045" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162045">(Feb 12 2025 at 07:07)</a>:</h4>
<p>My thinking right now is to have interning happen in canonicalization, not parsing</p>



<a name="499162137"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162137" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162137">(Feb 12 2025 at 07:08)</a>:</h4>
<p>Hmm. Anthony suggested otherwise, but it'd be okay</p>



<a name="499162218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162218">(Feb 12 2025 at 07:09)</a>:</h4>
<p>I don't think there's a strong benefit to doing it earlier, since the ast needs to be carrying around references/indices into the text anyway - and if that's all it's carrying around we can maybe keep the ast smaller.</p>



<a name="499162238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162238">(Feb 12 2025 at 07:09)</a>:</h4>
<p>The benefit of doing it during parsing is that it's an O(n) pass over the data which allows us to do mostly constant time string comparisons (outside of checking imports) and also carry around less data starting with canonicalization</p>



<a name="499162344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162344">(Feb 12 2025 at 07:10)</a>:</h4>
<p>I guess it's a question if dropping the full text earlier during compilation would be considered beneficial</p>



<a name="499162361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162361">(Feb 12 2025 at 07:10)</a>:</h4>
<p>I definitely buy constant time string comparisons as a benefit</p>



<a name="499162386"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162386" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162386">(Feb 12 2025 at 07:10)</a>:</h4>
<p>That happens as soon as interning happens</p>



<a name="499162397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162397">(Feb 12 2025 at 07:10)</a>:</h4>
<p>... but I don't want the parser to have to talk to some complicated multithreaded interning system</p>



<a name="499162413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162413">(Feb 12 2025 at 07:11)</a>:</h4>
<p>It's not multithreaded</p>



<a name="499162414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162414">(Feb 12 2025 at 07:11)</a>:</h4>
<p>That's going to slow down the parser</p>



<a name="499162427"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162427" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162427">(Feb 12 2025 at 07:11)</a>:</h4>
<p>There's an interner per module</p>



<a name="499162453"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162453" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162453">(Feb 12 2025 at 07:11)</a>:</h4>
<p>Ahhh; ok; that's somewhat less concerning</p>



<a name="499162459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162459">(Feb 12 2025 at 07:11)</a>:</h4>
<p>Specifically one of these: <a href="https://github.com/roc-lang/roc/blob/main/src/base/ModuleEnv.zig">https://github.com/roc-lang/roc/blob/main/src/base/ModuleEnv.zig</a></p>



<a name="499162559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162559">(Feb 12 2025 at 07:12)</a>:</h4>
<p>The other thought is that we could check for ident attributes and problems in the same pass as we tokenize, or at least as we parse</p>



<a name="499162598"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162598" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162598">(Feb 12 2025 at 07:12)</a>:</h4>
<p>Still, I'd rather have more work in can than in parsing (supposing we're just shifting it around, and not making lots more/less work). That way, things like formatting can be faster (very common to do across a whole file or even whole codebase!)</p>



<a name="499162648"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162648" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162648">(Feb 12 2025 at 07:13)</a>:</h4>
<p>Because if we intern during canonicalization, we have to read over each ident in full (not just the starting and ending chars) to check for warning info, like multiple underscores in a row or uppercase letters in a lowercase ident (we want to warn on camelCase)</p>



<a name="499162704"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162704" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162704">(Feb 12 2025 at 07:13)</a>:</h4>
<p>You're right, this would make formatting faster...</p>



<a name="499162783"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162783" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162783">(Feb 12 2025 at 07:14)</a>:</h4>
<p>(re)building an ast after saving a file, too</p>



<a name="499162817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162817">(Feb 12 2025 at 07:14)</a>:</h4>
<p>It'd be nice to have some estimate whether interning during parsing would be faster for overall compilation time</p>



<a name="499162838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162838">(Feb 12 2025 at 07:14)</a>:</h4>
<p>Because if it's not, then it should <em>definitely</em> be done during can</p>



<a name="499162879"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162879" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162879">(Feb 12 2025 at 07:15)</a>:</h4>
<p>I only suggested it because I thought it would speed up overall compilation, even if it makes formatting slower</p>



<a name="499162898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162898">(Feb 12 2025 at 07:15)</a>:</h4>
<p>If anything, I'd intern during tokenization rather than parsing</p>



<a name="499162919"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162919" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162919">(Feb 12 2025 at 07:15)</a>:</h4>
<p>Yeah, that was my thought too</p>



<a name="499162927"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162927" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162927">(Feb 12 2025 at 07:15)</a>:</h4>
<p>That way the parser never has to look at the source</p>



<a name="499162938"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162938" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162938">(Feb 12 2025 at 07:15)</a>:</h4>
<p>yep</p>



<a name="499162939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162939">(Feb 12 2025 at 07:15)</a>:</h4>
<p>(just the tokens)</p>



<a name="499162982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499162982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499162982">(Feb 12 2025 at 07:15)</a>:</h4>
<p>I'd still like to push that later, until/unless we have some evidence to the contrary</p>



<a name="499163052"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499163052" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499163052">(Feb 12 2025 at 07:16)</a>:</h4>
<p>A reasonable decision</p>



<a name="499163068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499163068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499163068">(Feb 12 2025 at 07:16)</a>:</h4>
<p>Not sure how to get that evidence</p>



<a name="499163219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499163219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499163219">(Feb 12 2025 at 07:17)</a>:</h4>
<p>Let me ask in a separate thread about regions if you have a plan for those</p>



<a name="499163590"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499163590" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499163590">(Feb 12 2025 at 07:20)</a>:</h4>
<p>For other readers, if you have an opinion on the root question of this thread, I'd still love to hear it</p>



<a name="499227981"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499227981" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499227981">(Feb 12 2025 at 13:09)</a>:</h4>
<p>if we're doing <code>roc check</code>, doing it during tokenization makes the most sense because the whole string will be in L1 cache right then</p>



<a name="499228015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499228015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499228015">(Feb 12 2025 at 13:09)</a>:</h4>
<p>if we're doing <code>roc format</code>, not doing it at all makes the most sense <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="499228434"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499228434" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499228434">(Feb 12 2025 at 13:10)</a>:</h4>
<p>deduplicating string literals only comes up if we're doing <code>roc build</code> and not using the interpreter as the backend</p>



<a name="499233190"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499233190" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499233190">(Feb 12 2025 at 13:29)</a>:</h4>
<p>I think doing it per-module instead of globally makes the most sense</p>



<a name="499233361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499233361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499233361">(Feb 12 2025 at 13:29)</a>:</h4>
<p>it avoids contention when we get to parallelizing things, because the interns are only used by the current module</p>



<a name="499233759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499233759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499233759">(Feb 12 2025 at 13:31)</a>:</h4>
<p>(or if they're being used by other modules it's because we're translating IDs from one module to another, but at that point they aren't being written to)</p>



<a name="499234205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499234205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499234205">(Feb 12 2025 at 13:33)</a>:</h4>
<p>I think we'll also need to serialize them to disk as part of caching, which of course we want to do on a per-module basis instead of globally</p>



<a name="499234716"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499234716" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499234716">(Feb 12 2025 at 13:35)</a>:</h4>
<p>also having them per-module makes it easier for the language server to manage their memory, since otherwise we'd need to refcount each individual interned string to know when it was safe to free, compared to just resetting a particular module's arena and redoing parsing etc</p>



<a name="499235104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499235104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499235104">(Feb 12 2025 at 13:36)</a>:</h4>
<p>oh and also per-module means there's more cache coherence, so fewer cache misses when using interns because there aren't a bunch of gaps from indentifiers that aren't even used in the module and won't come up</p>



<a name="499237803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499237803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499237803">(Feb 12 2025 at 13:47)</a>:</h4>
<p>as an aside, I think there are some potentially very interesting ways we can reduce memory usage in interns by packing them into size and capitalization categories and using simd to find matches, but all of that is definitely not stuff we should do for 0.1.0 <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="499257974"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499257974" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499257974">(Feb 12 2025 at 15:10)</a>:</h4>
<p>Ok, if I’m reading things right, the lexer for Carbon (for which I know that team has been very performance-focused), does ident interning. Here: <a href="https://github.com/carbon-language/carbon-lang/blob/trunk/toolchain/lex/lex.cpp">https://github.com/carbon-language/carbon-lang/blob/trunk/toolchain/lex/lex.cpp</a></p>



<a name="499258056"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499258056" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499258056">(Feb 12 2025 at 15:10)</a>:</h4>
<p>That’s good enough reason to me</p>



<a name="499258131"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499258131" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499258131">(Feb 12 2025 at 15:11)</a>:</h4>
<p>At least we can be relatively confident it’s not a serious perf problem</p>



<a name="499261637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499261637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499261637">(Feb 12 2025 at 15:26)</a>:</h4>
<p>yeah and in the future we can potentially have <code>roc format</code> tell it to use a "null interner" which just returns 0 for every ident (or something) because we know it's never going to look them up again</p>



<a name="499275826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499275826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499275826">(Feb 12 2025 at 16:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner/near/499228434">said</a>:</p>
<blockquote>
<p>deduplicating string literals only comes up if we're doing <code>roc build</code> and not using the interpreter as the backend</p>
</blockquote>
<p>During canonicalization, we can check if the same variable/type/tag/etc. name is used while scope checking in constant time if all strings are interned, so I think it's beneficial before interpreting too</p>



<a name="499280546"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280546" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280546">(Feb 12 2025 at 16:44)</a>:</h4>
<p>I mean string literals specifically</p>



<a name="499280585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280585">(Feb 12 2025 at 16:44)</a>:</h4>
<p>like <code>"foo"</code> in the Roc code <code>cli_arg_name = "foo"</code></p>



<a name="499280629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280629">(Feb 12 2025 at 16:45)</a>:</h4>
<p>as opposed to identifier names in code</p>



<a name="499280725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280725">(Feb 12 2025 at 16:45)</a>:</h4>
<p>Ah, do we need to unique those?</p>



<a name="499280730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280730">(Feb 12 2025 at 16:45)</a>:</h4>
<p>we want to deduplicate those when compiling to a static binary, so that we don't put the same string in the binary's readonly section more than once</p>



<a name="499280774"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280774" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280774">(Feb 12 2025 at 16:46)</a>:</h4>
<p>there's no benefit to having duplicates since they're readonly</p>



<a name="499280827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280827">(Feb 12 2025 at 16:46)</a>:</h4>
<p>Ah true; but I would assume that happens later</p>



<a name="499280852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280852">(Feb 12 2025 at 16:46)</a>:</h4>
<p>yeah that's what I mean</p>



<a name="499280874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280874">(Feb 12 2025 at 16:46)</a>:</h4>
<p>we only need to dedupe those if we're building a binary</p>



<a name="499280891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280891">(Feb 12 2025 at 16:46)</a>:</h4>
<p>but <code>check</code> and <code>format</code> have no reason to do that work</p>



<a name="499280929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499280929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499280929">(Feb 12 2025 at 16:46)</a>:</h4>
<p>(and those strings can be pretty big!)</p>



<a name="499281023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281023">(Feb 12 2025 at 16:47)</a>:</h4>
<p>Yep, those are not deduped right now</p>



<a name="499281041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281041">(Feb 12 2025 at 16:47)</a>:</h4>
<p>Because big and unique</p>



<a name="499281073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281073">(Feb 12 2025 at 16:47)</a>:</h4>
<p>yeah, so I don't think we should use interns for those (at least at this stage)</p>



<a name="499281107"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281107" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281107">(Feb 12 2025 at 16:47)</a>:</h4>
<p>better to leave that for a later pass</p>



<a name="499281183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281183">(Feb 12 2025 at 16:48)</a>:</h4>
<p>We still put them in a big array to keep IR nodes smaller</p>



<a name="499281270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281270">(Feb 12 2025 at 16:48)</a>:</h4>
<p>Not sure if you think that's actively a bad idea</p>



<a name="499281289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281289">(Feb 12 2025 at 16:48)</a>:</h4>
<p>oh I think we can just reference original source range</p>



<a name="499281321"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281321" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281321">(Feb 12 2025 at 16:48)</a>:</h4>
<p>Oh, that's better</p>



<a name="499281385"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281385" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281385">(Feb 12 2025 at 16:48)</a>:</h4>
<p>I'll hook that up</p>



<a name="499281421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281421">(Feb 12 2025 at 16:49)</a>:</h4>
<p>that does mean the interpreter has to redo a bit of work</p>



<a name="499281440"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281440" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281440">(Feb 12 2025 at 16:49)</a>:</h4>
<p>to do things like resolve <code>\</code> escapes</p>



<a name="499281555"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281555" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281555">(Feb 12 2025 at 16:49)</a>:</h4>
<p>which maybe isn't worth it</p>



<a name="499281707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281707">(Feb 12 2025 at 16:50)</a>:</h4>
<p>could always have 2 different IR nodes, one for like "literal with no escapes" that just stores a source code range and another for "escaped string literal" which points to the post-processed one</p>



<a name="499281927"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281927" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281927">(Feb 12 2025 at 16:51)</a>:</h4>
<p>I guess that's okay complexity to eat today since we'd only need to deal with this during check</p>



<a name="499281978"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499281978" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499281978">(Feb 12 2025 at 16:51)</a>:</h4>
<p>The later phases would get back a normal string</p>



<a name="499349874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499349874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499349874">(Feb 12 2025 at 23:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner/near/499280730">said</a>:</p>
<blockquote>
<p>we want to deduplicate those when compiling to a static binary, so that we don't put the same string in the binary's readonly section more than once</p>
</blockquote>
<p>I think we can trivially do that when generating llvm ir. We generate a single ir module so we can literally keep a map of seen strings if we want.</p>



<a name="499350029"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Multiple%20interners%20or%20single%20interner/near/499350029" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner.html#499350029">(Feb 12 2025 at 23:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/Multiple.20interners.20or.20single.20interner/near/499281421">said</a>:</p>
<blockquote>
<p>that does mean the interpreter has to redo a bit of work</p>
</blockquote>
<p>I guess that would mean we have to keep all source in memory which doesn't sound good. Or the interpreter has to re-open every file to pull all the strings, which sounds kinda strange, but ok.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
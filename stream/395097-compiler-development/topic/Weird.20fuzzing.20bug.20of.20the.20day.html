<html>
<head><meta charset="utf-8"><title>Weird fuzzing bug of the day · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html">Weird fuzzing bug of the day</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="482907910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482907910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482907910">(Nov 18 2024 at 00:07)</a>:</h4>
<p>If there's a weird way for features to interact, fuzzing seems to reliably find it. So, brain teaser:</p>
<p>When parsed and formatted, <code>dbg dbg g g</code> yields: <code>dbg (dbg g g)</code></p>
<p>Is that the same thing? Why or why not?</p>



<a name="482908225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482908225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482908225">(Nov 18 2024 at 00:12)</a>:</h4>
<p>Why does it add the parens?</p>



<a name="482908232"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482908232" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482908232">(Nov 18 2024 at 00:12)</a>:</h4>
<p>Wouldn't that parse as a function call with three arguments?</p>



<a name="482908270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482908270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482908270">(Nov 18 2024 at 00:13)</a>:</h4>
<p>I would expect that to fail typechecking or something later, but for the sake of parsing/formatting it should be no different to say <code>foo 1 2 3</code> right?</p>



<a name="482908803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482908803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482908803">(Nov 18 2024 at 00:21)</a>:</h4>
<p>It _is_ different, because there are two different ways <code>dbg</code> is parsed :/</p>



<a name="482908815"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482908815" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482908815">(Nov 18 2024 at 00:21)</a>:</h4>
<p>The same thing doesn't happen with <code>foo foo g g</code></p>



<a name="482908863"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482908863" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482908863">(Nov 18 2024 at 00:22)</a>:</h4>
<div class="codehilite"><pre><span></span><code>* * * AST before formatting:
Expr(
    SpaceAfter(
        Apply(
            @0-11 Dbg,
            [
                @4-11 Apply(
                    @4-7 Dbg,
                    [
                        @8-9 Var {
                            module_name: &quot;&quot;,
                            ident: &quot;g&quot;,
                        },
                        @10-11 Var {
                            module_name: &quot;&quot;,
                            ident: &quot;g&quot;,
                        },
                    ],
                    Space,
                ),
            ],
            Space,
        ),
        [
            Newline,
        ],
    ),
)

* * * AST after formatting:
Expr(
    Apply(
        Dbg,
        [
            Apply(
                Dbg,
                [
                    Apply(
                        Var {
                            module_name: &quot;&quot;,
                            ident: &quot;g&quot;,
                        },
                        [
                            Var {
                                module_name: &quot;&quot;,
                                ident: &quot;g&quot;,
                            },
                        ],
                        Space,
                    ),
                ],
                Space,
            ),
        ],
        Space,
    ),
)
</code></pre></div>



<a name="482908936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482908936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482908936">(Nov 18 2024 at 00:23)</a>:</h4>
<p>The key is that <code>dbg</code> in the outer context is parsing as a dbg statement, so it gobbles up the rest of the string - and then prior to formatting (haven't quite identified where...) this gets converted to a Dbg expression, which of course must follow the usual rules for how calls work - and so we introduce parens in the formatter to (try to) preserve that nesting order.</p>



<a name="482909001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482909001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482909001">(Nov 18 2024 at 00:24)</a>:</h4>
<p>... but unbeknownst to the formatter, adding the parens triggers that inner thing to be a new "defs" context, which allows the inner dbg to parse as a dbg statement instead of a dbg expression.</p>



<a name="482909129"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482909129" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482909129">(Nov 18 2024 at 00:26)</a>:</h4>
<p>I guess it needs to be parsed as a special keyword because we don't have statements in roc, like user space function call on a line by itself.</p>



<a name="482909271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482909271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482909271">(Nov 18 2024 at 00:28)</a>:</h4>
<p>I'm looking at </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">dbg_kw</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">Parser</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">Expr</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">EExpect</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">arena</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">a</span><span class="w"> </span><span class="nc">Bump</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nc">State</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">min_indent</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">next_state</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">parser</span><span class="p">::</span><span class="n">keyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">::</span><span class="n">DBG</span><span class="p">,</span><span class="w"> </span><span class="n">EExpect</span><span class="p">::</span><span class="n">Dbg</span><span class="p">).</span><span class="n">parse</span><span class="p">(</span><span class="n">arena</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">min_indent</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">MadeProgress</span><span class="p">,</span><span class="w"> </span><span class="n">Expr</span><span class="p">::</span><span class="n">Dbg</span><span class="p">,</span><span class="w"> </span><span class="n">next_state</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="p">.</span><span class="n">trace</span><span class="p">(</span><span class="s">"dbg_kw"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>In the <code>parser::keyword</code> should we prevent two keywords in sequence, like <code>if if</code> or <code>dbg dbg</code>?</p>



<a name="482912508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482912508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482912508">(Nov 18 2024 at 01:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day/near/482907910">said</a>:</p>
<blockquote>
<p>If there's a weird way for features to interact, fuzzing seems to reliably find it. So, brain teaser:</p>
<p>When parsed and formatted, <code>dbg dbg g g</code> yields: <code>dbg (dbg g g)</code></p>
<p>Is that the same thing? Why or why not?</p>
</blockquote>
<p>that seems correct, but I don't like that it seems correct <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="482912575"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482912575" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482912575">(Nov 18 2024 at 01:18)</a>:</h4>
<p>in the sense that <code>dbg</code> doesn't accept multiple arguments, so whatever comes after it must be its own self-contained expression (hence the parens)</p>



<a name="482912586"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482912586" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482912586">(Nov 18 2024 at 01:18)</a>:</h4>
<p>but although it's logical, I don't like it <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="482913557"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482913557" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482913557">(Nov 18 2024 at 01:31)</a>:</h4>
<p>The core of the weirdness here is that we have two fundamental the different precedence levels for dbg statements: at the statement level, it has a very low precedence, but if the expression level it has the same precedence as other function applications.</p>



<a name="482913635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482913635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482913635">(Nov 18 2024 at 01:32)</a>:</h4>
<p>One way to fix that would be to standardize on dbg always having function level precedents - effectively, eliminating the statement level dbg.</p>



<a name="482913673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482913673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482913673">(Nov 18 2024 at 01:32)</a>:</h4>
<p>On the other hand, we could move even the expression level dbg to have a very low precedence, and operate the same way as the statement level dbg.</p>



<a name="482913737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482913737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482913737">(Nov 18 2024 at 01:34)</a>:</h4>
<p>Or, if we just want to fix this one particular thing, we can teach the formatter not to introduce parentheses in the case where it would matter and change how this inner statement is parsed. But that feels pretty hacky?</p>



<a name="482920744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482920744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482920744">(Nov 18 2024 at 03:03)</a>:</h4>
<p>Actually not sure that last option will be very feasible...</p>



<a name="482921217"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921217" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921217">(Nov 18 2024 at 03:10)</a>:</h4>
<p>personally I'm okay with the status quo</p>



<a name="482921230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921230">(Nov 18 2024 at 03:10)</a>:</h4>
<p>on the grounds that I don't think anyone is likely to ever write it on purpose</p>



<a name="482921271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921271">(Nov 18 2024 at 03:11)</a>:</h4>
<p>also in the parens-and-commas world you'd have to write it like <code>dbg(dbg(g, g))</code> or <code>dbg(dbg, g, g)</code> anyway so there wouldn't be any strangeness</p>



<a name="482921374"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921374" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921374">(Nov 18 2024 at 03:12)</a>:</h4>
<p>I would like to fix this invariant violation somehow</p>



<a name="482921412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921412">(Nov 18 2024 at 03:12)</a>:</h4>
<p>I do eventually want to get "fuzz-clean", which then means we have strong properties that you can trust of the parser and formatter</p>



<a name="482921478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921478">(Nov 18 2024 at 03:13)</a>:</h4>
<p>And after that, move on to fuzzing other areas of the compiler ;)</p>



<a name="482921564"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921564" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921564">(Nov 18 2024 at 03:14)</a>:</h4>
<p>IMO the status quo is a bit hard to understand because there are two different rules for how you have to parenthesize things in <code>dbg</code>, depending on where it is</p>



<a name="482921726"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921726" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921726">(Nov 18 2024 at 03:17)</a>:</h4>
<p>Concretely, <code>dbg f g</code> is fine at the top level, and operates like <code>dbg (f g)</code> - but if it's inside an expression somewhere you have to do <code>dbg (f g)</code>.</p>



<a name="482921755"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482921755" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482921755">(Nov 18 2024 at 03:17)</a>:</h4>
<p>This fuzzer-found bug is a very round about way of describing that weirdness</p>



<a name="482923306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923306">(Nov 18 2024 at 03:39)</a>:</h4>
<p>a straightforward fix would be to have <code>dbg</code> "accept" multiple arguments, like a function call, at the parsing level</p>



<a name="482923315"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923315" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923315">(Nov 18 2024 at 03:39)</a>:</h4>
<p>and then give a canonicalization error for too many args passed to <code>dbg</code></p>



<a name="482923371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923371">(Nov 18 2024 at 03:40)</a>:</h4>
<p>Yep, and that's how <code>dbg</code> works at the "expression" level</p>



<a name="482923379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923379">(Nov 18 2024 at 03:40)</a>:</h4>
<p>yeah so we could do the same at the statement level</p>



<a name="482923387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923387">(Nov 18 2024 at 03:40)</a>:</h4>
<p>Aha yeah; that's what I was thinking as well :)</p>



<a name="482923418"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923418" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923418">(Nov 18 2024 at 03:41)</a>:</h4>
<p>A slightly further change would be to make us parse <code>dbg</code> identically regardless of the context</p>



<a name="482923484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923484">(Nov 18 2024 at 03:42)</a>:</h4>
<p>Given the thing we just agreed upon above, the remaining difference is that <code>dbg</code> at the statement level can currently introduce a block - e.g.:</p>
<div class="codehilite"><pre><span></span><code>dbg
   x = 1
   x
</code></pre></div>



<a name="482923515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923515">(Nov 18 2024 at 03:42)</a>:</h4>
<p>That seems much less useful than it is in the <code>expect</code> context, so my initial instinct is to go ahead and remove that ability</p>



<a name="482923533"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482923533" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482923533">(Nov 18 2024 at 03:42)</a>:</h4>
<p>Note that you can always do:</p>
<div class="codehilite"><pre><span></span><code>dbg (
    x = 1
    x
)
</code></pre></div>
<p>... if you really need to</p>



<a name="482924086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482924086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482924086">(Nov 18 2024 at 03:50)</a>:</h4>
<p>why couldn't you do it in the expression? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="482925001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482925001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482925001">(Nov 18 2024 at 04:02)</a>:</h4>
<p>(moved discussion to <a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/Defs.20in.20arbitrary.20expressions">#compiler development &gt; Defs in arbitrary expressions</a> )</p>



<a name="482926959"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482926959" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482926959">(Nov 18 2024 at 04:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day/near/482921412">said</a>:</p>
<blockquote>
<p>I do eventually want to get "fuzz-clean", which then means we have strong properties that you can trust of the parser and formatter</p>
</blockquote>
<p>It would be cool to have a "hey did you run the fuzzer" as a requirement whenever someone updates anything syntax related. I'm guessing at the moment they would immediately run into these kind of issues, and so it wouldn't be as helpful for them?</p>



<a name="482927268"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482927268" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482927268">(Nov 18 2024 at 04:29)</a>:</h4>
<p>You could have CI run the fuzzer for 30 seconds or a minute on each pr. Or do it a bit longer each nightly.</p>



<a name="482966526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482966526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482966526">(Nov 18 2024 at 09:11)</a>:</h4>
<p>Nightly seems best, we don't want to confuse people with failures unrelated to their changes</p>



<a name="482966733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482966733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482966733">(Nov 18 2024 at 09:12)</a>:</h4>
<p>Do we have a script or single command for the fuzzing?</p>



<a name="482979412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482979412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482979412">(Nov 18 2024 at 10:11)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ cd crates/compiler/test_syntax/fuzz
$ cargo +nightly fuzz run -j4 fuzz_expr --sanitizer=none -- -dict=dict.txt
</code></pre></div>
<p>It's described in <code>crates/compiler/test_syntax/fuzz/README.md</code></p>



<a name="482981499"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/482981499" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#482981499">(Nov 18 2024 at 10:20)</a>:</h4>
<p>Thanks :)</p>



<a name="483074475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483074475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483074475">(Nov 18 2024 at 16:59)</a>:</h4>
<p>Assuming we iron out the current bugs, I think it is much nicer to do a bit per PR. Cause if it caches something it will almost certainly be a real bug from the PR.</p>



<a name="483074526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483074526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483074526">(Nov 18 2024 at 16:59)</a>:</h4>
<p>Can always bisect instead, but it is more work</p>



<a name="483074747"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483074747" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483074747">(Nov 18 2024 at 17:00)</a>:</h4>
<p>Also, if you can, make sure to save the corpus (and probably want to minimize it at the end of runs)</p>



<a name="483179330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483179330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483179330">(Nov 19 2024 at 04:23)</a>:</h4>
<p>One caveat that I didn't realize immediately with moving _everything_ to use the expr-level <code>dbg</code> is that things like <code>dbg 1 + 1</code> will cease to work, and you'll have to write <code>dbg (1 + 1)</code>.<br>
Thoughts?</p>



<a name="483213775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483213775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483213775">(Nov 19 2024 at 09:09)</a>:</h4>
<p>seems reasonable, we'll see if people complain about it <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="483286556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483286556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483286556">(Nov 19 2024 at 15:10)</a>:</h4>
<p>I was also surprised when I first used debug that you didn’t have add parens around expressions like that so I think this just decreases the amount of surprise <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="483302292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483302292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483302292">(Nov 19 2024 at 16:20)</a>:</h4>
<p>Given debug works as an expression, I would expect this to print 1:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">dbg</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>This prints 2</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">dbg</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p>That said, as a statement, I would expect different precedence. Though same precedence is ok. I would expect 2 from this</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">dbg</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>



<a name="483309291"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483309291" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483309291">(Nov 19 2024 at 16:50)</a>:</h4>
<p>Could we make those use a different syntax?</p>



<a name="483317413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483317413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483317413">(Nov 19 2024 at 17:30)</a>:</h4>
<p>I think parens-and-commas fixes this, right?</p>



<a name="483343582"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483343582" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483343582">(Nov 19 2024 at 20:03)</a>:</h4>
<p>Yeah, I think so</p>



<a name="483347434"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483347434" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483347434">(Nov 19 2024 at 20:28)</a>:</h4>
<p>in that case I'd say we can go with whatever design most easily fixes the fuzzing case <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="483347450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483347450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483347450">(Nov 19 2024 at 20:28)</a>:</h4>
<p>can always revisit later</p>



<a name="483830468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483830468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483830468">(Nov 22 2024 at 03:37)</a>:</h4>
<p>Here's the diff to do that, with some refactoring to make the required transformations in <code>can</code> easier: <a href="https://github.com/roc-lang/roc/pull/7239">https://github.com/roc-lang/roc/pull/7239</a></p>



<a name="483830525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483830525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483830525">(Nov 22 2024 at 03:37)</a>:</h4>
<p>This relegates Expr::Defs to only be used between desugaring and the main canonicalization phase, and instead uses Expr::Stmts as the representation that comes out of the parser.</p>



<a name="483830629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483830629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483830629">(Nov 22 2024 at 03:39)</a>:</h4>
<p>Note that the list of stmts already existed as an intermediate representation in the parser - so this isn't introducing a new step, it's just moving it around.</p>



<a name="483830810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/483830810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#483830810">(Nov 22 2024 at 03:41)</a>:</h4>
<p>One of the ancillary benefits here is that some things that used to be a parse errors, and thus completely blocked running the code (e.g. missing a final expression in a defs), are now canonicalization errors where they can be non-fatal</p>



<a name="485024957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485024957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485024957">(Nov 29 2024 at 05:33)</a>:</h4>
<p>Ok, with that out of the way, I was able to fix a bunch of other bugs found in fuzzing here: <a href="https://github.com/roc-lang/roc/pull/7267">https://github.com/roc-lang/roc/pull/7267</a></p>
<p>Not yet at the end of it, but I at least feel like it's still finding interesting things that'd be possible for users to hit, rather than trivial problems.</p>
<p>Was hoping to get fully to "fuzz clean" before submitting the next PR - but these fixes have been piling up for too long now.</p>



<a name="485754738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485754738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485754738">(Dec 03 2024 at 04:50)</a>:</h4>
<div class="codehilite"><pre><span></span><code>...
#1863400: cov: 47740 ft: 42904 corp: 11904 exec/s 1197 oom/timeout/crash: 0/0/0 time: 397s job: 52 dft_time: 0
#1936387: cov: 47842 ft: 42918 corp: 11911 exec/s 1351 oom/timeout/crash: 0/0/0 time: 412s job: 53 dft_time: 0
#1985095: cov: 47873 ft: 42933 corp: 11917 exec/s 885 oom/timeout/crash: 0/0/0 time: 427s job: 54 dft_time: 0
#2068034: cov: 47874 ft: 42945 corp: 11925 exec/s 1481 oom/timeout/crash: 0/0/0 time: 441s job: 55 dft_time: 0
#2105228: cov: 47882 ft: 42948 corp: 11928 exec/s 652 oom/timeout/crash: 0/0/0 time: 455s job: 56 dft_time: 0
#2184903: cov: 47914 ft: 42959 corp: 11937 exec/s 1373 oom/timeout/crash: 0/0/0 time: 471s job: 57 dft_time: 0
#2262528: cov: 47917 ft: 42960 corp: 11938 exec/s 1315 oom/timeout/crash: 0/0/0 time: 486s job: 58 dft_time: 0
#2335873: cov: 47986 ft: 42969 corp: 11944 exec/s 1222 oom/timeout/crash: 0/0/0 time: 501s job: 59 dft_time: 0
#2388073: cov: 48069 ft: 42995 corp: 11954 exec/s 855 oom/timeout/crash: 0/0/0 time: 517s job: 60 dft_time: 0
#2468634: cov: 48092 ft: 43009 corp: 11962 exec/s 1299 oom/timeout/crash: 0/0/0 time: 534s job: 61 dft_time: 0
#2548301: cov: 48139 ft: 43018 corp: 11970 exec/s 1264 oom/timeout/crash: 0/0/0 time: 550s job: 62 dft_time: 0
#2623369: cov: 48172 ft: 43021 corp: 11972 exec/s 1172 oom/timeout/crash: 0/0/0 time: 566s job: 63 dft_time: 0
#2701742: cov: 48202 ft: 43039 corp: 11983 exec/s 1205 oom/timeout/crash: 0/0/0 time: 583s job: 64 dft_time: 0
#2748245: cov: 48243 ft: 43046 corp: 11987 exec/s 704 oom/timeout/crash: 0/0/0 time: 601s job: 65 dft_time: 0
INFO: fuzzed for 601 seconds, wrapping up soon
INFO: exiting: 0 time: 602s
</code></pre></div>
<p>And there is the sweet sweet sound of the fuzzer not having found any problems in 10 minutes of fuzzing.</p>



<a name="485754760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485754760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485754760">(Dec 03 2024 at 04:50)</a>:</h4>
<p>Yay for arbitrary goals</p>



<a name="485754998"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485754998" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485754998">(Dec 03 2024 at 04:53)</a>:</h4>
<p>PR here: <a href="https://github.com/roc-lang/roc/pull/7301">https://github.com/roc-lang/roc/pull/7301</a></p>



<a name="485755019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485755019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485755019">(Dec 03 2024 at 04:53)</a>:</h4>
<p>Note that one of the changes I'm including here is removing the ability for joining neighboring annotations+bodies if the patterns are not "equivalent", discussed here: <a href="#narrow/channel/395097-compiler-development/topic/Merging.20non-equivalent.20annotations.20.2B.20bodies.3F/near/485732867">https://roc.zulipchat.com/#narrow/channel/395097-compiler-development/topic/Merging.20non-equivalent.20annotations.20.2B.20bodies.3F/near/485732867</a></p>



<a name="485755069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485755069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485755069">(Dec 03 2024 at 04:53)</a>:</h4>
<p>That much is probably worth discussing prior to actually merging. I can fairly easily back that commit out and fix that fuzzing issue separately if need be.</p>



<a name="485755543"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485755543" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485755543">(Dec 03 2024 at 04:57)</a>:</h4>
<p>Well done! This is great to see. Feels good</p>



<a name="485755554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485755554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485755554">(Dec 03 2024 at 04:57)</a>:</h4>
<p>Indeed</p>



<a name="485755565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485755565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485755565">(Dec 03 2024 at 04:57)</a>:</h4>
<p>That was a long time coming</p>



<a name="485756343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485756343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485756343">(Dec 03 2024 at 05:04)</a>:</h4>
<p>If I could quickly TL;DR the <a href="https://github.com/roc-lang/roc/issues/1">#1</a> learning here, it's: spaces are "slippery", and if they have any room to slide around, chaos ensues.</p>
<p>For example, and eliding some of the fields of these things, you can have these two trees that are logically equivalent:</p>
<div class="codehilite"><pre><span></span><code>SpaceBefore(Apply(Dbg, [...]))
Apply(SpaceBefore(Dbg), [...])
</code></pre></div>
<p>i.e. both represent having placed the spaces at the same place in the file.</p>
<p>Or similarly, where each element in a series of Defs has both "spaces_before" and "spaces_after".</p>
<p>I'm not sure if the parser would ever produce that exact example, but there definitely are a bunch of other possible cases where spaces can "slide" around while still being in logically the same place.</p>
<p>That's what all the <code>expr_lift_spaces</code>, <code>pattern_lift_spaces</code>, etc stuff in these recent diffs have been: trying to normalize the placing of those spaces, "lifting" it up to the highest part of the tree it can be.</p>



<a name="485756914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485756914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485756914">(Dec 03 2024 at 05:08)</a>:</h4>
<p>This "sliding" is particularly prone to happening if the formatter decides to add or remove parentheses</p>



<a name="485757285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485757285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485757285">(Dec 03 2024 at 05:12)</a>:</h4>
<p>Another footgun in the formatter is that <code>is_multiline()</code> must correctly predict what <code>.format_with_options(...)</code> will do, and if we have some subtle logic that sometimes adds a newline to the output in the <code>.format_with_options(...)</code> impl, it's easy to forget to make <code>.is_multiline()</code> account for that. The rules to format a string as a block string if it contains a newline or quote char have been particularly annoying here.</p>



<a name="485757545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485757545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485757545">(Dec 03 2024 at 05:14)</a>:</h4>
<p>The solution to both of those that I'm very slowly working towards is to add an intermediate stage of processing that gives a heavily-normalized version of the expression from which <code>is_multiline</code> can be calculated trivially and 100% correctly.</p>



<a name="485757854"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/485757854" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#485757854">(Dec 03 2024 at 05:17)</a>:</h4>
<p>Today that's taking the form of <code>expr_lift_spaces</code>/etc - but there are hints of my eventual plans with <code>ann_lift_to_node</code>: that's the barest sketch of that normalized form. I added that in this case in order to make sure the decision of whether a type annotation needs parens consistent in a couple key spots.</p>



<a name="486620624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486620624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486620624">(Dec 07 2024 at 01:42)</a>:</h4>
<p>I put up an initial sketch of doing fuzzing in CI here: <a href="https://github.com/roc-lang/roc/pull/7316">https://github.com/roc-lang/roc/pull/7316</a></p>
<p>Would love some help getting this properly set up since I really don't know what I'm doing, and this is me just flailing around.</p>
<p>In particular, I'm guessing that we'll have problems with making sure the nightly version of cargo is installed. There may also be problems with nix/</p>



<a name="486621668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621668">(Dec 07 2024 at 01:57)</a>:</h4>
<p>Does the fuzzer work inside nix? I'd just add it as another step for one of our existing nix runs</p>



<a name="486621678"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621678" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621678">(Dec 07 2024 at 01:57)</a>:</h4>
<p>It doesn't need to run on all the different os/archs</p>



<a name="486621736"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621736" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621736">(Dec 07 2024 at 01:58)</a>:</h4>
<p>Yeah, no need for different architectures.</p>



<a name="486621740"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621740" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621740">(Dec 07 2024 at 01:58)</a>:</h4>
<p>Like in <code>.github/workflows/nix_linux_x86_64.yml</code></p>



<a name="486621766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621766">(Dec 07 2024 at 01:58)</a>:</h4>
<p>The only thing I'm not sure about is how to get the nightly compiler working in CI with nix. Fuzzing requires running nightly compiler, and doesn't work on stable.</p>



<a name="486621779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621779">(Dec 07 2024 at 01:59)</a>:</h4>
<p>The rust compiler I mean.</p>



<a name="486621786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621786">(Dec 07 2024 at 01:59)</a>:</h4>
<p>Just copy the commands already there I think</p>



<a name="486621805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621805">(Dec 07 2024 at 01:59)</a>:</h4>
<p><code>nix develop -c</code> ... maybe we add a bash<code>.sh</code> script that runs the fuzzer</p>



<a name="486621951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486621951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486621951">(Dec 07 2024 at 02:00)</a>:</h4>
<p>I'd give this a try</p>
<div class="codehilite"><pre><span></span><code>- name: run fuzz tests
        run: |
          cd crates/compiler/test_syntax/fuzz
          nix develop -c cargo +nightly fuzz run -j4 fuzz_expr --sanitizer=none -- -dict=dict.txt -max_total_time=60
</code></pre></div>



<a name="486622073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486622073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486622073">(Dec 07 2024 at 02:02)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> may not have the nightly toolchain on the self-hosted machine.. but that should be an easy fix</p>



<a name="486622384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486622384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486622384">(Dec 07 2024 at 02:07)</a>:</h4>
<p>One reason we might want this to be part of a separate job is so that we can configure it to be not blocking merging of PRs until we're confident that it's very stable.</p>



<a name="486622474"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486622474" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486622474">(Dec 07 2024 at 02:08)</a>:</h4>
<p>I'm just throwing ideas around for how to get it working... I think <span class="user-mention" data-user-id="361169">@Anton</span> will definitely have some things to say on this. But the more we can do to set it up and have something working for him, the easier to get to the desired end state is my thinking.</p>



<a name="486696047"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486696047" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486696047">(Dec 07 2024 at 19:06)</a>:</h4>
<p>Here's the current failure mode:</p>
<div class="codehilite"><pre><span></span><code> path &#39;/home/small-ci-user/actions-runner/_work/roc/roc/crates/compiler/test_syntax/fuzz&#39; does not contain a &#39;flake.nix&#39;, searching up
error: no such command: `+nightly`

    Cargo does not handle `+toolchain` directives.
    Did you mean to invoke `cargo` through `rustup` instead?
</code></pre></div>
<p>It appears the <code>cargo</code> installed there is actual cargo instead of rustup, so it doesn't understand the <code>+nightly</code> thing.</p>



<a name="486696860"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486696860" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486696860">(Dec 07 2024 at 19:18)</a>:</h4>
<p>Can you do <code>rustup +nightly cargo</code> (that might not be the right command, but something like that)</p>



<a name="486696880"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486696880" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486696880">(Dec 07 2024 at 19:18)</a>:</h4>
<p>Cause I know we use rustup and the tool chain file</p>



<a name="486698378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486698378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486698378">(Dec 07 2024 at 19:39)</a>:</h4>
<p>It's Anton's machine, we should just wait for him to jump online.</p>



<a name="486698441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486698441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486698441">(Dec 07 2024 at 19:40)</a>:</h4>
<p>It's a self hosted runner</p>



<a name="486708467"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486708467" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486708467">(Dec 07 2024 at 22:02)</a>:</h4>
<p>Ok, my most recent attempt seems to be getting closest... except the nightly toolchain isn't installed it looks like</p>
<p>Config:</p>
<div class="codehilite"><pre><span></span><code>      - name: run fuzz tests
        run: |
          cd crates/compiler/test_syntax/fuzz
          nix develop -c rustup run nightly cargo fuzz run -j4 fuzz_expr --sanitizer=none -- -dict=dict.txt -max_total_time=60
</code></pre></div>
<p>Output:</p>
<div class="codehilite"><pre><span></span><code> error: toolchain &#39;nightly-x86_64-unknown-linux-gnu&#39; is not installed
</code></pre></div>



<a name="486959264"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486959264" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486959264">(Dec 09 2024 at 10:34)</a>:</h4>
<p>Our nix rust version comes from <a href="https://github.com/roc-lang/roc/blob/861f9c5d47599147824a3732cf7c855ff5400d60/nix/default.nix#L3">here</a>, getting the nightly in there too would require some fiddling. I recommend starting out with a new workflow using the runner <code>runs-on: [self-hosted, i7-6700K]</code>. I'll install nightly(rust toolchain) nightly-2024-02-03 on there, that one matches our current rust version and that way we don't need to install the latest every day.</p>



<a name="486962572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/486962572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#486962572">(Dec 09 2024 at 10:49)</a>:</h4>
<p>It's installed, I expect this will work for your command <code>cargo +nightly-2024-02-03 fuzz ...</code></p>



<a name="487288643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/487288643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#487288643">(Dec 10 2024 at 16:08)</a>:</h4>
<p>I think we'll also need a <code>cargo +nightly-2024-02-03 install cargo-fuzz</code> command as a preparatory step. Or should I put that in the job?</p>



<a name="487293400"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/487293400" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#487293400">(Dec 10 2024 at 16:29)</a>:</h4>
<p>Yeah, you can put that in the job, it'll basically be zero cost if it is already installed</p>



<a name="488003845"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488003845" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488003845">(Dec 11 2024 at 02:54)</a>:</h4>
<p>Ok, seems to be working! I currently have this in ubuntu_x86_64.yml, which may not be the ideal spot.</p>



<a name="488059311"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488059311" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488059311">(Dec 11 2024 at 10:04)</a>:</h4>
<p>that file should be fine <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="488533999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488533999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488533999">(Dec 12 2024 at 01:25)</a>:</h4>
<p>We got our first fuzzer bug in the wild! <span aria-label="bug" class="emoji emoji-1f41b" role="img" title="bug">:bug:</span> <span aria-label="ladybug" class="emoji emoji-1f41e" role="img" title="ladybug">:ladybug:</span> </p>
<p>In this CI run <a href="https://github.com/roc-lang/roc/actions/runs/12287783837/job/34290444406?pr=7335">https://github.com/roc-lang/roc/actions/runs/12287783837/job/34290444406?pr=7335</a></p>
<div class="codehilite"><pre><span></span><code>INFO: exiting: 77 time: 33s

────────────────────────────────────────────────────────────────────────────────

Failing input:

    artifacts/fuzz_expr/crash-7f53e1d94350d5255f7f9bfdbedaff7665f10a0b

Output of `std::fmt::Debug`:

    [50, 45, 52, 10, 46, 116, 10, 10, 33, 10, 10, 38, 112, 122, 50, 112, 122, 46, 116, 10, 10, 33, 10, 38, 112, 114, 118, 111, 105, 100, 101, 115, 33, 61, 61, 101, 74]

Reproduce with:

    cargo fuzz run --sanitizer=none fuzz_expr artifacts/fuzz_expr/crash-7f53e1d94350d5255f7f9bfdbedaff7665f10a0b

Minimize test case with:

    cargo fuzz tmin --sanitizer=none fuzz_expr artifacts/fuzz_expr/crash-7f53e1d94350d5255f7f9bfdbedaff7665f10a0b

────────────────────────────────────────────────────────────────────────────────

Error: Fuzz target exited with exit status: 77
Error: Process completed with exit code 1.
</code></pre></div>



<a name="488534084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488534084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488534084">(Dec 12 2024 at 01:26)</a>:</h4>
<div class="codehilite"><pre><span></span><code>2-4
.t

!

&amp;pz2pz.t

!
&amp;prvoides!==eJ
</code></pre></div>



<a name="488534279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488534279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488534279">(Dec 12 2024 at 01:29)</a>:</h4>
<p>What's our plan if CI fails on a fuzzer bug... and it passes everything else? Merge the PR and log an issue with a repro?</p>



<a name="488534387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488534387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488534387">(Dec 12 2024 at 01:30)</a>:</h4>
<p>Nvm, it looks like it cancels the rest of the run immediately</p>



<a name="488535784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488535784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488535784">(Dec 12 2024 at 01:48)</a>:</h4>
<p>We should move fuzzing to the last step in that job, so we can be sure everything else succeeded</p>



<a name="488535796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488535796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488535796">(Dec 12 2024 at 01:49)</a>:</h4>
<p>And obviously if this gets too noisy we should remove it or move it to a non-blocking job</p>



<a name="488535814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488535814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488535814">(Dec 12 2024 at 01:49)</a>:</h4>
<p>Will take a look later tonight</p>



<a name="488538367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488538367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488538367">(Dec 12 2024 at 02:19)</a>:</h4>
<p>The minimal repro here is:</p>
<div class="codehilite"><pre><span></span><code>4
!
&amp;z.t
</code></pre></div>



<a name="488538435"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488538435" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488538435">(Dec 12 2024 at 02:20)</a>:</h4>
<p>(found by putting that in a file called <code>todo</code> and then running <code>cargo run --bin minimize expr todo</code>)</p>



<a name="488540051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488540051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488540051">(Dec 12 2024 at 02:39)</a>:</h4>
<p>Fixed here: <a href="https://github.com/roc-lang/roc/pull/7340">https://github.com/roc-lang/roc/pull/7340</a></p>



<a name="488540392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488540392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488540392">(Dec 12 2024 at 02:43)</a>:</h4>
<p>It'll still cancel all the other jobs early in CI Manager though right if this fails? I had a little investigation how to make it not do that, and I wasn't confident I could do it.</p>



<a name="488541467"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488541467" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488541467">(Dec 12 2024 at 02:56)</a>:</h4>
<p>I didn't realize it canceled other jobs</p>



<a name="488541620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488541620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488541620">(Dec 12 2024 at 02:58)</a>:</h4>
<p>Although, I think this is one of the longer running jobs, so maybe it will work out fine.</p>



<a name="488547467"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547467" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547467">(Dec 12 2024 at 04:08)</a>:</h4>
<p>here's another! <a href="https://github.com/roc-lang/roc/actions/runs/12289072630/job/34293972798?pr=7337#step:8:5297">https://github.com/roc-lang/roc/actions/runs/12289072630/job/34293972798?pr=7337#step:8:5297</a></p>



<a name="488547582"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547582" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547582">(Dec 12 2024 at 04:08)</a>:</h4>
<p>Ooof</p>



<a name="488547590"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547590" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547590">(Dec 12 2024 at 04:09)</a>:</h4>
<p>This is a little noisier than I was hoping for :/</p>



<a name="488547602"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547602" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547602">(Dec 12 2024 at 04:09)</a>:</h4>
<p>I think I'm going to go ahead and disable it for now</p>



<a name="488547645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547645">(Dec 12 2024 at 04:09)</a>:</h4>
<p>That was before merging the other fix into main</p>



<a name="488547654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547654">(Dec 12 2024 at 04:10)</a>:</h4>
<p>could they both be hitting the same failure?</p>



<a name="488547749"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547749" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547749">(Dec 12 2024 at 04:10)</a>:</h4>
<p>oh, nvm</p>



<a name="488547761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547761">(Dec 12 2024 at 04:10)</a>:</h4>
<p>missed the last commit being merging main</p>



<a name="488547821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547821">(Dec 12 2024 at 04:11)</a>:</h4>
<p>I'll run it for a bit while I'm in a meeting and see if I can find anything</p>



<a name="488547881"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547881" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547881">(Dec 12 2024 at 04:12)</a>:</h4>
<p>actually my first statement is correct. That failure is before the fix on main. So main may be clean for fuzzing.</p>



<a name="488547897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547897">(Dec 12 2024 at 04:12)</a>:</h4>
<p>I just found a couple more things locally</p>



<a name="488547911"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547911" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547911">(Dec 12 2024 at 04:12)</a>:</h4>
<p>Definitely not clean</p>



<a name="488547917"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488547917" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488547917">(Dec 12 2024 at 04:12)</a>:</h4>
<p>ok</p>



<a name="488548055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488548055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488548055">(Dec 12 2024 at 04:14)</a>:</h4>
<p>Actually, interesting fuzzing question here</p>



<a name="488548067"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488548067" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488548067">(Dec 12 2024 at 04:14)</a>:</h4>
<p>Or perhaps language design question</p>



<a name="488548600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488548600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488548600">(Dec 12 2024 at 04:18)</a>:</h4>
<p>Here's another </p>
<div class="codehilite"><pre><span></span><code>x
!&amp;
</code></pre></div>



<a name="488548665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488548665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488548665">(Dec 12 2024 at 04:19)</a>:</h4>
<p>I've been running into a bunch of problems with <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/parse/src/expr.rs#L3192">this logic</a> that sees what would usually be an Alias followed by a body and turns that into an annotation.</p>
<p>It's very sensitive to where exactly the whitespace is attached, as well as some details like whether we're adding/removing parens around the pattern in the alias turned annotation.</p>
<p>I'm not sure I've seen this logic kick in on actual example code. Is that needed/valuable?</p>



<a name="488549190"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549190" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549190">(Dec 12 2024 at 04:23)</a>:</h4>
<p>Found another </p>
<div class="codehilite"><pre><span></span><code>1)
</code></pre></div>



<a name="488549270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549270">(Dec 12 2024 at 04:24)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> Maybe my 10 minute no-bugs-found run was lucky. And/or because I'm running it on relatively modest hardware (M1 macbook air)</p>



<a name="488549272"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549272" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549272">(Dec 12 2024 at 04:24)</a>:</h4>
<p>I can make issues instead if you'd prefer <span class="user-mention" data-user-id="453336">@Joshua Warner</span></p>



<a name="488549337"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549337" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549337">(Dec 12 2024 at 04:25)</a>:</h4>
<p>I had to go into the office, for some meetings. I can sit here all afternoon poking at the fuzzer <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="488549353"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549353" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549353">(Dec 12 2024 at 04:25)</a>:</h4>
<p>This is a task I can excel at</p>



<a name="488549354"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549354" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549354">(Dec 12 2024 at 04:25)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> what were the errors those were failing with?</p>



<a name="488549390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549390">(Dec 12 2024 at 04:25)</a>:</h4>
<p>I'll make issues and copy it all in, with the minimisation too</p>



<a name="488549720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488549720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488549720">(Dec 12 2024 at 04:29)</a>:</h4>
<p><a href="/user_uploads/22008/s8crwMVhH9Xw2w3M5bh0SdyA/crash-d8c7b906b169f03d93286cac954573468ff5aae9">crash-d8c7b906b169f03d93286cac954573468ff5aae9</a><br>
I lost the history (can't scroll back far enough) for this one.</p>



<a name="488550424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488550424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488550424">(Dec 12 2024 at 04:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day/near/488548665">said</a>:</p>
<blockquote>
<p>I've been running into a bunch of problems with <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/parse/src/expr.rs#L3192">this logic</a> that sees what would usually be an Alias followed by a body and turns that into an annotation.</p>
<p>It's very sensitive to where exactly the whitespace is attached, as well as some details like whether we're adding/removing parens around the pattern in the alias turned annotation.</p>
<p>I'm not sure I've seen this logic kick in on actual example code. Is that needed/valuable?</p>
</blockquote>
<p>I don't think this is something people mess up in any significant amount in practice, so I'd say in this situation it sounds reasonable to change the parser to be more resilient to failure - even if that makes the grammar stricter</p>



<a name="488551064"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488551064" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488551064">(Dec 12 2024 at 04:42)</a>:</h4>
<p>Ok, I'm going to try and not post ones that look like duplicates. Just noticing some of these might be for the same thing</p>



<a name="488551703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488551703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488551703">(Dec 12 2024 at 04:49)</a>:</h4>
<blockquote>
<p>it sounds reasonable to change the parser to be more resilient to failure</p>
</blockquote>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> What would you say to requiring parens around the pattern in this case?<br>
e.g.</p>
<div class="codehilite"><pre><span></span><code>(UserId x) : [ UserId I64 ]
UserId x = UserId 42
</code></pre></div>
<p>... and have the non-parens equivalent parse strictly as an Alias?</p>



<a name="488553180"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553180" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553180">(Dec 12 2024 at 05:04)</a>:</h4>
<p>that seems fine for now...I don't think I've ever seen anyone write an annotation like that in practice <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="488553239"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553239" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553239">(Dec 12 2024 at 05:05)</a>:</h4>
<p>that is a valid annotation?</p>



<a name="488553296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553296">(Dec 12 2024 at 05:06)</a>:</h4>
<p>Can we just ban the parens there?</p>



<a name="488553371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553371">(Dec 12 2024 at 05:07)</a>:</h4>
<p>Not sure what you mean by ban?</p>



<a name="488553509"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553509" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553509">(Dec 12 2024 at 05:08)</a>:</h4>
<p>Like, give a parse error?</p>



<a name="488553683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553683">(Dec 12 2024 at 05:10)</a>:</h4>
<p>yeah</p>



<a name="488553708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553708">(Dec 12 2024 at 05:11)</a>:</h4>
<p>Though I guess roc is permissive...so remove with the formatter I guess...</p>



<a name="488553730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553730">(Dec 12 2024 at 05:11)</a>:</h4>
<p>I don't think that actually helps in this situation, but I could be misunderstanding</p>



<a name="488553832"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553832" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553832">(Dec 12 2024 at 05:12)</a>:</h4>
<p>well there ought to be <em>some</em> way to annotate that if you really want to</p>



<a name="488553840"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553840" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553840">(Dec 12 2024 at 05:12)</a>:</h4>
<p>I guess, in my mind:</p>
<p>This is normal code to see:</p>
<div class="codehilite"><pre><span></span><code>(UserId x) = UserId 42
</code></pre></div>
<p>This is abnormal code to see:</p>
<div class="codehilite"><pre><span></span><code>(UserId x) : [ UserId I64 ]
</code></pre></div>



<a name="488553930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553930">(Dec 12 2024 at 05:13)</a>:</h4>
<p>Why do you have to be able to annotate a pattern match?</p>



<a name="488553993"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553993" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553993">(Dec 12 2024 at 05:14)</a>:</h4>
<p>Right; I think that's what I was getting at earlier...</p>



<a name="488553994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488553994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488553994">(Dec 12 2024 at 05:14)</a>:</h4>
<p>Like you don't annotate branches of a <code>when ... is</code></p>



<a name="488554010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554010">(Dec 12 2024 at 05:14)</a>:</h4>
<p>I don't think you should be able to annotate this</p>



<a name="488554050"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554050" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554050">(Dec 12 2024 at 05:15)</a>:</h4>
<p>hm, that's interesting <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="488554054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554054">(Dec 12 2024 at 05:15)</a>:</h4>
<p>Or you have to annotate it indirectly:</p>
<div class="codehilite"><pre><span></span><code>y : [ UserId I64 ]
y = UserId 42
UserId x = y
</code></pre></div>



<a name="488554072"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554072" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554072">(Dec 12 2024 at 05:15)</a>:</h4>
<p>I hadn't thought about that perspective, but it would certainly simplify things!</p>



<a name="488554084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554084">(Dec 12 2024 at 05:15)</a>:</h4>
<p>so you can only annotate plain identifiers, not destructures</p>



<a name="488554098"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554098" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554098">(Dec 12 2024 at 05:15)</a>:</h4>
<p>so you also couldn't annotate like <code>(a, b) =</code></p>



<a name="488554100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554100">(Dec 12 2024 at 05:15)</a>:</h4>
<p>yeah, that would be my take</p>



<a name="488554164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554164">(Dec 12 2024 at 05:16)</a>:</h4>
<p>do people annotate destructures? I don't think I have ever seen that happen.</p>



<a name="488554178"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554178" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554178">(Dec 12 2024 at 05:16)</a>:</h4>
<p>given that people seem not to do that anyway, and that it definitely creates parsing problems, I'm on board with that plan</p>



<a name="488554200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554200">(Dec 12 2024 at 05:16)</a>:</h4>
<p>I think there's been plenty enough time of having it be supported to know that it hasn't seen significant use in practice <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="488554252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554252">(Dec 12 2024 at 05:17)</a>:</h4>
<p>Also, when I initially saw this code, I thought it was a weird way to write a type alias.</p>
<div class="codehilite"><pre><span></span><code>(UserId x) : [ UserId I64 ]
</code></pre></div>



<a name="488554269"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554269" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554269">(Dec 12 2024 at 05:17)</a>:</h4>
<p>Thought it was the same as:</p>
<div class="codehilite"><pre><span></span><code>UserId x : [ UserId I64 ]
</code></pre></div>



<a name="488554701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554701">(Dec 12 2024 at 05:22)</a>:</h4>
<p>FWIW when I first encountered Roc, I was very confused that aliases look so much like annotations.</p>



<a name="488554869"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/488554869" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#488554869">(Dec 12 2024 at 05:24)</a>:</h4>
<p>I didn't know you could annotate a pattern match. My mental model was; Uppercase is an Alias, Lowercase is an Annotation</p>



<a name="492881373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/492881373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#492881373">(Jan 10 2025 at 05:51)</a>:</h4>
<p>~30mins on commit <code>9f395e033dfb9ade5c0642567f0dda8bbd1f2e5a</code></p>
<p><a href="/user_uploads/22008/XqziOhICyZCXmTMQ1u6bYx9o/round-20.tar.gz">round-20.tar.gz</a></p>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span></p>



<a name="493015746"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493015746" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493015746">(Jan 10 2025 at 19:49)</a>:</h4>
<p>~12 hours on commit <code>9f395e033dfb9ade5c0642567f0dda8bbd1f2e5a</code></p>
<p><a href="/user_uploads/22008/ODrfz6OqRbYv8HVE95XyhIdO/round-21.tar.gz">round-21.tar.gz</a></p>



<a name="493089444"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493089444" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493089444">(Jan 11 2025 at 11:37)</a>:</h4>
<p>~6 hours on commit <code>0471993428739cc754516c0e6c8a432895dbdaff</code></p>
<p><a href="/user_uploads/22008/uixHdF0ZWkFecd4qgFmmRlBb/round-22.tar.gz">round-22.tar.gz</a></p>



<a name="493120189"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493120189" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493120189">(Jan 11 2025 at 19:07)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/7500">https://github.com/roc-lang/roc/pull/7500</a> now has fixes for all these :)</p>



<a name="493129533"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493129533" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493129533">(Jan 11 2025 at 21:38)</a>:</h4>
<p>~2 hours on commit <code>875e355b68d15334f13fad616d7fe5d0dbc055ce</code></p>
<p><a href="/user_uploads/22008/meA8n4-xe-b5A7pRvkzsGeiz/round-23.tar.gz">round-23.tar.gz</a></p>



<a name="493131835"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493131835" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493131835">(Jan 11 2025 at 22:17)</a>:</h4>
<p>These are all <code>slow-unit-</code> or <code>oom-</code> results; i.e. the test framework thought those inputs took excessively long or consumed too much memory.</p>
<p>... but when I run those, I don't see either thing happen <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="493132010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132010">(Jan 11 2025 at 22:20)</a>:</h4>
<p>I think in light of Josh's change....I might just throw away my current PR and focus on <code>||</code> lambda syntax</p>



<a name="493132157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132157">(Jan 11 2025 at 22:22)</a>:</h4>
<p>Do you mean this one? <a href="https://github.com/roc-lang/roc/pull/7470">https://github.com/roc-lang/roc/pull/7470</a></p>



<a name="493132179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132179">(Jan 11 2025 at 22:22)</a>:</h4>
<p>No, <a href="https://github.com/roc-lang/roc/pull/7490">https://github.com/roc-lang/roc/pull/7490</a></p>



<a name="493132185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132185">(Jan 11 2025 at 22:23)</a>:</h4>
<p>And maybe 7470 too</p>



<a name="493132209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132209">(Jan 11 2025 at 22:23)</a>:</h4>
<p>But 7490 on my local is _much larger_ and ambitious</p>



<a name="493132270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132270">(Jan 11 2025 at 22:24)</a>:</h4>
<p>And I think after your change, and Sam's from a day or two ago, it might be hard to rebase and a lot of the assumptions I'm making might not work out</p>



<a name="493132309"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132309" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132309">(Jan 11 2025 at 22:25)</a>:</h4>
<p>Basically I'm trying to move ALL <code>PncApply</code> likes to Collections, and also Pattern:RecordDestructure to use assignedfield and deprecate the RequiredField and OptionalFiled variants of the Pattern enum.</p>



<a name="493132325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132325">(Jan 11 2025 at 22:25)</a>:</h4>
<p>And just moving to align everything between Pattern and Expr to be more consistent</p>



<a name="493132510"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132510" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132510">(Jan 11 2025 at 22:28)</a>:</h4>
<p>I definitely like the direction</p>



<a name="493132775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132775">(Jan 11 2025 at 22:33)</a>:</h4>
<p>Anything I can do to help?</p>



<a name="493132783"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493132783" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493132783">(Jan 11 2025 at 22:33)</a>:</h4>
<p>Happy to work on fixing conflicts or something</p>



<a name="493133819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493133819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493133819">(Jan 11 2025 at 22:53)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> maybe you could help merge this <a href="https://github.com/roc-lang/roc/pull/7470">https://github.com/roc-lang/roc/pull/7470</a></p>



<a name="493133829"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493133829" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493133829">(Jan 11 2025 at 22:53)</a>:</h4>
<p>That sounds like the work Anthony is referring to</p>



<a name="493133898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493133898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493133898">(Jan 11 2025 at 22:54)</a>:</h4>
<p>And I guess the other one too?? <a href="https://github.com/roc-lang/roc/pull/7490">https://github.com/roc-lang/roc/pull/7490</a></p>



<a name="493146246"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493146246" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493146246">(Jan 12 2025 at 02:21)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> <span class="user-mention" data-user-id="453336">@Joshua Warner</span> I have a lot more going on on my local</p>



<a name="493146301"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493146301" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493146301">(Jan 12 2025 at 02:22)</a>:</h4>
<p>The weekend has been hectic,  but I’ll try to make it pushable tomorrow morning</p>



<a name="493153913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493153913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493153913">(Jan 12 2025 at 04:27)</a>:</h4>
<p>Started finding &amp; fixing some problems in <code>can</code> now!<br>
<a href="https://github.com/roc-lang/roc/pull/7504">https://github.com/roc-lang/roc/pull/7504</a></p>



<a name="493155024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493155024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493155024">(Jan 12 2025 at 04:44)</a>:</h4>
<p>~6 hours on commit <code>9ffc671659c2c2fec55e9b0475535e6cd34eb278</code></p>
<p><a href="/user_uploads/22008/gEkoleDsumFVor7OTp6Ueboi/round-24.tar.gz">round-24.tar.gz</a></p>



<a name="493155317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493155317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493155317">(Jan 12 2025 at 04:49)</a>:</h4>
<p>That's a big tuple <span aria-label="smirk" class="emoji emoji-1f60f" role="img" title="smirk">:smirk:</span> </p>
<div class="codehilite"><pre><span></span><code>@0-21 AccessorFunction(
    TupleIndex(
        &quot;18888888888888888888&quot;,
    ),
),
</code></pre></div>



<a name="493157231"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493157231" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493157231">(Jan 12 2025 at 05:17)</a>:</h4>
<p>Honestly I think we should give the same error for anything more than say 32 or something. In that range it’ll still work with the warning. We can always raise the limit if someone autogenerates code that needs that or something.</p>



<a name="493219830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493219830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493219830">(Jan 12 2025 at 20:33)</a>:</h4>
<p>~12 hours on commit <code>5ebd6e0884db65f2d099dfb0ebf255d0bdf80c2b</code></p>
<p><a href="/user_uploads/22008/AMqtlanpLruD-HzF3Q6geCfU/round-25.tar.gz">round-25.tar.gz</a></p>



<a name="493247275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493247275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493247275">(Jan 13 2025 at 03:03)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> I push up where I'm at right now.</p>



<a name="493247294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493247294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493247294">(Jan 13 2025 at 03:03)</a>:</h4>
<p>Still some snapshot failures I'm not happy with, but don't have the brain power to fix right now</p>



<a name="493247374"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493247374" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493247374">(Jan 13 2025 at 03:04)</a>:</h4>
<p>But the changes that are in there I'm happy with - for now.  I still need to implement the "short single-arg" collapsing</p>



<a name="493247416"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493247416" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493247416">(Jan 13 2025 at 03:04)</a>:</h4>
<p>And obviously rebase and figure out some of the new newlines I have</p>



<a name="493247461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493247461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493247461">(Jan 13 2025 at 03:05)</a>:</h4>
<p>Probably just an artifact of some of the pattern-only variance I removed (Some may need to be added back, some may need to be done in a different way).</p>



<a name="493610932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493610932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493610932">(Jan 14 2025 at 15:31)</a>:</h4>
<div class="codehilite"><pre><span></span><code>stat::number_of_executed_units: 567703
stat::average_exec_per_sec:     15343
stat::new_units_added:          9912
stat::slowest_unit_time_sec:    0
stat::peak_rss_mb:              602
INFO: exiting: 19712 time: 240s
</code></pre></div>
<p>AST changed after formatting...</p>
<p>Before formatting:</p>
<div class="codehilite"><pre><span></span><code>MM//(#
z
(#
w)#\&quot;
w)#\&quot;,/

!\&quot;\&quot;aC-\&quot;\&quot;\&quot;!\&quot;a\&quot;\&quot;!CCa\&quot;a\&quot;\&quot;\&quot;(
#w)##,(
interface
##w,(
w)?
</code></pre></div>
<p>After formatting:</p>
<div class="codehilite"><pre><span></span><code>MM
// ( #
z
#
w # &quot;
w) # &quot;,/

!&quot;&quot;
    aC
    -
    &quot;&quot;&quot;
    !&quot;a&quot;&quot;!CCa&quot;a
    &quot;&quot;&quot;(
        # w)##,(
        interface
            ## w,(
            w,
    )?
</code></pre></div>
<p>AST diff</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>Expr(
<span class="w"> </span>    Defs(
<span class="w"> </span>        Defs {
<span class="w"> </span>            tags: [
<span class="w"> </span>                EitherIndex(2147483648),
<span class="w"> </span>            ],
<span class="w"> </span>            regions: [
<span class="w"> </span>                …,
<span class="w"> </span>            ],
<span class="w"> </span>            space_before: [
<span class="w"> </span>                Slice&lt;roc_parse::ast::CommentOrNewline&gt; { start: 0, length: 0 },
<span class="w"> </span>            ],
<span class="w"> </span>            space_after: [
<span class="w"> </span>                Slice&lt;roc_parse::ast::CommentOrNewline&gt; { start: 0, length: 0 },
<span class="w"> </span>            ],
<span class="w"> </span>            spaces: [],
<span class="w"> </span>            type_defs: [],
<span class="w"> </span>            value_defs: [
<span class="w"> </span>                Stmt(
<span class="w"> </span>                    BinOps(
<span class="w"> </span>                        [
<span class="w"> </span>                            (
<span class="w"> </span>                                Tag(
<span class="w"> </span>                                    "MM",
<span class="w"> </span>                                ),
<span class="w"> </span>                                DoubleSlash,
<span class="w"> </span>                            ),
<span class="w"> </span>                        ],
<span class="w"> </span>                        Defs(
<span class="w"> </span>                            Defs {
<span class="w"> </span>                                tags: [
<span class="w"> </span>                                    EitherIndex(2147483648),
<span class="w"> </span>                                    EitherIndex(2147483649),
<span class="w"> </span>                                ],
<span class="w"> </span>                                regions: [
<span class="w"> </span>                                    …,
<span class="w"> </span>                                    …,
<span class="w"> </span>                                ],
<span class="w"> </span>                                space_before: [
<span class="w"> </span>                                    Slice&lt;roc_parse::ast::CommentOrNewline&gt; { start: 0, length: 0 },
<span class="w"> </span>                                    Slice&lt;roc_parse::ast::CommentOrNewline&gt; { start: 0, length: 0 },
<span class="w"> </span>                                ],
<span class="w"> </span>                                space_after: [
<span class="w"> </span>                                    Slice&lt;roc_parse::ast::CommentOrNewline&gt; { start: 0, length: 0 },
<span class="w"> </span>                                    Slice&lt;roc_parse::ast::CommentOrNewline&gt; { start: 0, length: 0 },
<span class="w"> </span>                                ],
<span class="w"> </span>                                spaces: [],
<span class="w"> </span>                                type_defs: [],
<span class="w"> </span>                                value_defs: [
<span class="w"> </span>                                    Stmt(
<span class="w"> </span>                                        Var {
<span class="w"> </span>                                            module_name: "",
<span class="w"> </span>                                            ident: "z",
<span class="w"> </span>                                        },
<span class="w"> </span>                                    ),
<span class="w"> </span>                                    Stmt(
<span class="w"> </span>                                        Var {
<span class="w"> </span>                                            module_name: "",
<span class="w"> </span>                                            ident: "w",
<span class="w"> </span>                                        },
<span class="w"> </span>                                    ),
<span class="w"> </span>                                ],
<span class="w"> </span>                            },
<span class="w"> </span>                            Var {
<span class="w"> </span>                                module_name: "",
<span class="w"> </span>                                ident: "w",
<span class="w"> </span>                            },
<span class="w"> </span>                        ),
<span class="w"> </span>                    ),
<span class="w"> </span>                ),
<span class="w"> </span>            ],
<span class="w"> </span>        },
<span class="gd">-        Apply(</span>
<span class="gd">-            UnaryOp(</span>
<span class="gd">-                Str(</span>
<span class="gd">-                    PlainLine(</span>
<span class="gd">-                        "",</span>
<span class="gd">-                    ),</span>
<span class="gd">-                ),</span>
<span class="gd">-                Not,</span>
<span class="gd">-            ),</span>
<span class="gi">+        BinOps(</span>
<span class="w"> </span>            [
<span class="gd">-                Var {</span>
<span class="gd">-                    module_name: "",</span>
<span class="gd">-                    ident: "aC",</span>
<span class="gd">-                },</span>
<span class="gd">-                UnaryOp(</span>
<span class="gd">-                    TrySuffix(</span>
<span class="gd">-                        PncApply(</span>
<span class="gi">+                (</span>
<span class="gi">+                    Apply(</span>
<span class="gi">+                        UnaryOp(</span>
<span class="w"> </span>                            Str(
<span class="w"> </span>                                PlainLine(
<span class="gd">-                                    "!\"a\"\"!CCa\"a",</span>
<span class="gi">+                                    "",</span>
<span class="w"> </span>                                ),
<span class="w"> </span>                            ),
<span class="gd">-                            [</span>
<span class="gd">-                                Apply(</span>
<span class="gd">-                                    Var {</span>
<span class="gd">-                                        module_name: "",</span>
<span class="gd">-                                        ident: "interface",</span>
<span class="gd">-                                    },</span>
<span class="gd">-                                    [</span>
<span class="gd">-                                        Var {</span>
<span class="gd">-                                            module_name: "",</span>
<span class="gd">-                                            ident: "w",</span>
<span class="gd">-                                        },</span>
<span class="gd">-                                    ],</span>
<span class="gd">-                                    Space,</span>
<span class="gd">-                                ),</span>
<span class="gd">-                            ],</span>
<span class="gi">+                            Not,</span>
<span class="w"> </span>                        ),
<span class="gi">+                        [</span>
<span class="gi">+                            Var {</span>
<span class="gi">+                                module_name: "",</span>
<span class="gi">+                                ident: "aC",</span>
<span class="gi">+                            },</span>
<span class="gi">+                        ],</span>
<span class="gi">+                        Space,</span>
<span class="w"> </span>                    ),
<span class="gd">-                    Negate,</span>
<span class="gi">+                    Minus,</span>
<span class="w"> </span>                ),
<span class="w"> </span>            ],
<span class="gd">-            Space,</span>
<span class="gi">+            TrySuffix(</span>
<span class="gi">+                PncApply(</span>
<span class="gi">+                    Str(</span>
<span class="gi">+                        PlainLine(</span>
<span class="gi">+                            "!\"a\"\"!CCa\"a",</span>
<span class="gi">+                        ),</span>
<span class="gi">+                    ),</span>
<span class="gi">+                    [</span>
<span class="gi">+                        Apply(</span>
<span class="gi">+                            Var {</span>
<span class="gi">+                                module_name: "",</span>
<span class="gi">+                                ident: "interface",</span>
<span class="gi">+                            },</span>
<span class="gi">+                            [</span>
<span class="gi">+                                Var {</span>
<span class="gi">+                                    module_name: "",</span>
<span class="gi">+                                    ident: "w",</span>
<span class="gi">+                                },</span>
<span class="gi">+                            ],</span>
<span class="gi">+                            Space,</span>
<span class="gi">+                        ),</span>
<span class="gi">+                    ],</span>
<span class="gi">+                ),</span>
<span class="gi">+            ),</span>
<span class="w"> </span>        ),
<span class="w"> </span>    ),
<span class="w"> </span>)
</code></pre></div>



<a name="493611279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493611279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493611279">(Jan 14 2025 at 15:32)</a>:</h4>
<p><a href="/user_uploads/22008/YrVvUAm9k_82ag7ompMzz2rX/crash-e5c5f2279bb018c4128ff6a25ca5e1130aae4952">crash-e5c5f2279bb018c4128ff6a25ca5e1130aae4952</a></p>



<a name="493619121"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493619121" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493619121">(Jan 14 2025 at 16:08)</a>:</h4>
<p>That one's fixed in <a href="https://github.com/roc-lang/roc/pull/7510">https://github.com/roc-lang/roc/pull/7510</a></p>



<a name="493666291"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/493666291" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#493666291">(Jan 14 2025 at 20:39)</a>:</h4>
<p>~12 hours on <code>9c340302e2b83246ad3857337b7f5d22fcd58a7f</code></p>
<p><a href="/user_uploads/22008/n9z5Ea0FlVzGLLBfkWy3uV38/round-26.tar.gz">round-26.tar.gz</a></p>



<a name="494330762"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494330762" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494330762">(Jan 17 2025 at 10:37)</a>:</h4>
<p>~ 1 min on commit <code>d42af0b763440176e829d67f0646b5c59c3f0f6d</code></p>
<p><a href="/user_uploads/22008/FsnbWtADYloZKGGKU5Goo047/round-27.tar.gz">round-27.tar.gz</a></p>



<a name="494599092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494599092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494599092">(Jan 19 2025 at 03:47)</a>:</h4>
<p>That was all one bug; pushed a fix to <a href="https://github.com/roc-lang/roc/pull/7510">https://github.com/roc-lang/roc/pull/7510</a></p>



<a name="494599162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494599162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494599162">(Jan 19 2025 at 03:48)</a>:</h4>
<p>(pretty easy-to-hit problem with pipe-based closures)</p>



<a name="494599168"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494599168" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494599168">(Jan 19 2025 at 03:48)</a>:</h4>
<p><span class="user-mention" data-user-id="781658">@Anthony Bullard</span> (or perhaps <span class="user-mention" data-user-id="515757">@Luke Boswell</span>) - that could use a re-review if you have some time :)</p>



<a name="494616554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494616554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494616554">(Jan 19 2025 at 07:40)</a>:</h4>
<p>~3 hours on commit <code>300412a4da46d81c6f40d196d968045fb0ad973f</code></p>
<p><a href="/user_uploads/22008/zfKjuYUvxuChk8kvUnfbmA0M/round-28.tar.gz">round-28.tar.gz</a></p>



<a name="494943295"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494943295" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494943295">(Jan 21 2025 at 01:01)</a>:</h4>
<p>That, plus a pretty key oversight in the implementation of and/or, are fixed in <a href="https://github.com/roc-lang/roc/pull/7535">https://github.com/roc-lang/roc/pull/7535</a></p>



<a name="494943349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494943349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494943349">(Jan 21 2025 at 01:01)</a>:</h4>
<p>I think &gt;= 50% of the recent bugs I've fixed have been regressions introduced with recent parser changes</p>



<a name="494943492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494943492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494943492">(Jan 21 2025 at 01:03)</a>:</h4>
<p>Some of them have been caught either directly on the fuzzing job on the PR itself, or in a fuzzing job on some subsequent PR</p>



<a name="494943576"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494943576" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494943576">(Jan 21 2025 at 01:03)</a>:</h4>
<p>Maybe it's time to start paying more attention to the fuzzing happening in CI?</p>



<a name="494947168"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947168" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947168">(Jan 21 2025 at 01:33)</a>:</h4>
<p>Ahk that's good to know. I thought we might be mostly ignoring that until we get a solid run out of the fuzzer without issues.</p>



<a name="494947192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947192">(Jan 21 2025 at 01:33)</a>:</h4>
<p>I haven't seen it run for more than 10mins yet without a crash - edit after the recent PNC changes etc</p>



<a name="494947270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947270">(Jan 21 2025 at 01:34)</a>:</h4>
<p>But I guess I'm only running each time you've been putting a new syntax related PR in.</p>



<a name="494947271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947271">(Jan 21 2025 at 01:34)</a>:</h4>
<p>There was a stretch of time where it was going a few hours without a crash</p>



<a name="494947295"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947295" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947295">(Jan 21 2025 at 01:34)</a>:</h4>
<p>Yeah, we were really close</p>



<a name="494947328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947328">(Jan 21 2025 at 01:34)</a>:</h4>
<p>It definitely feels like we're almost back there again.</p>



<a name="494947330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947330">(Jan 21 2025 at 01:34)</a>:</h4>
<p>Yeah we need to stabilize again after some pretty rapid</p>



<a name="494947409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947409">(Jan 21 2025 at 01:35)</a>:</h4>
<p>Maybe if there is a crash we should make it a policy to:</p>
<ul>
<li>Run the minimizer on it (shouldn't be hard to make this automatic)</li>
<li>Eyeball it to see if it looks related to that PR or perhaps a recent PR</li>
</ul>



<a name="494947430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947430">(Jan 21 2025 at 01:35)</a>:</h4>
<p>A fuzzing crash found in CI, I mean</p>



<a name="494947634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947634">(Jan 21 2025 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> would you prefer pushing a fix into a PR for new syntax, or landing that PR in main and then following up with any syntax/fuzzer related fixes?</p>



<a name="494947691"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947691" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947691">(Jan 21 2025 at 01:37)</a>:</h4>
<p>If it does look related to the PR, we should probably be bugging the PR author to look at it :)</p>



<a name="494947740"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947740" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947740">(Jan 21 2025 at 01:38)</a>:</h4>
<p>We've been moving a lot faster than usual and trying to land the breaking changes staged to unblock things.</p>



<a name="494947846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947846">(Jan 21 2025 at 01:38)</a>:</h4>
<p>Keeping master bug-free-ish is a nice-to-have. Agree rapid collaboration is important (particularly recently)</p>



<a name="494947893"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947893" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947893">(Jan 21 2025 at 01:39)</a>:</h4>
<p>I'm not too picky if the fix goes in the same PR or a following one</p>



<a name="494947939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494947939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494947939">(Jan 21 2025 at 01:39)</a>:</h4>
<p>(at least, supposing the breakage isn't to something fairly obvious!)</p>



<a name="494948034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948034">(Jan 21 2025 at 01:40)</a>:</h4>
<p>I've been a little more relaxed because I know the nightlies are paused, and you've been very effective at cleaning things up. So it's been a way to collaborate faster, by merging things into main and not backing up merge conflicts</p>



<a name="494948182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948182">(Jan 21 2025 at 01:41)</a>:</h4>
<p>Yeah I think for better or worse we’ve been in move fast and break things mode - but I think that’s going to slow down now.  We can work as a team and smash the fuzzer issues</p>



<a name="494948276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948276">(Jan 21 2025 at 01:42)</a>:</h4>
<p>I think there is a lot of dissonance (much of it surely caused by me) between the parse grammar and the formatter</p>



<a name="494948308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948308">(Jan 21 2025 at 01:42)</a>:</h4>
<p>I’m happy to put down my current projects and jump on to help with that</p>



<a name="494948451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948451">(Jan 21 2025 at 01:43)</a>:</h4>
<p>If we see a legitimate crash - it shouldn’t be on you alone Josh, despite being a wizard - write up issues for these and mark them as P:Medium</p>



<a name="494948517"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948517" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948517">(Jan 21 2025 at 01:44)</a>:</h4>
<p>And maybe tag them as nightly blocker</p>



<a name="494948529"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948529" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948529">(Jan 21 2025 at 01:44)</a>:</h4>
<p>Haha fair point :)</p>



<a name="494948565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948565">(Jan 21 2025 at 01:44)</a>:</h4>
<p>And feel free to assign the guilty party</p>



<a name="494948581"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494948581" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494948581">(Jan 21 2025 at 01:44)</a>:</h4>
<p>I await the flood of issues…</p>



<a name="494974383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/494974383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#494974383">(Jan 21 2025 at 05:55)</a>:</h4>
<p>Adding auto-minimization to the fuzzer in ci: <a href="https://github.com/roc-lang/roc/pull/7537">https://github.com/roc-lang/roc/pull/7537</a></p>



<a name="495021941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/495021941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#495021941">(Jan 21 2025 at 11:04)</a>:</h4>
<p><a href="/user_uploads/22008/6wAayUc_md0xc0f8I0SAyOeo/crash-fd9fabc49ffdbd93271a9f8d8e75ad416b7f9d83">crash-fd9fabc49ffdbd93271a9f8d8e75ad416b7f9d83</a></p>



<a name="495134675"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Weird%20fuzzing%20bug%20of%20the%20day/near/495134675" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Weird.20fuzzing.20bug.20of.20the.20day.html#495134675">(Jan 21 2025 at 20:00)</a>:</h4>
<p>~12 hours on commit <code>5b4c8e70d873e7f5e30f995aedea0199bf1f99b1</code></p>
<p><a href="/user_uploads/22008/GRxmOPe6HG2xbA2AxlTox2yO/round-29.tar.gz">round-29.tar.gz</a></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
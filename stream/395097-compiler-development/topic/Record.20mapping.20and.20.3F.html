<html>
<head><meta charset="utf-8"><title>Record mapping and ? · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html">Record mapping and ?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="462259285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462259285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462259285">(Aug 14 2024 at 04:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/stream/395097-compiler-development/topic/Builtins.20to.20implement/near/462251827">said</a>:</p>
<blockquote>
<p>I think with the map2-based record builders landed, there's no more need for map3 and mapN beyond map2 for Result or Task</p>
</blockquote>
<p>I don't think those are related to record builder at all. I think they are just convenience functions. If you have n results from separate paths you can pass them all to a single function (assuming they all end up being Ok). The most likely alternative is using <code>Result.try</code> n times and then passing the values into the function.</p>
<p>That said, I still don't think they are needed. I think pushing for <code>Result.try</code> and eventually <code>?</code> will be a much nicer API.</p>



<a name="462261162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462261162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462261162">(Aug 14 2024 at 04:47)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> I agree that we don't <em>need</em> record builders, they're just an alternative way to manage multiple Results to the ? desugaring. For example,</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">map2</span><span class="w"> </span><span class="nf">&lt;-</span>
<span class="w">        </span><span class="nv">a</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultA</span><span class="p">,</span>
<span class="w">        </span><span class="nv">b</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultB</span><span class="p">,</span>
<span class="w">        </span><span class="nv">c</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultC</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="err">?</span>
</code></pre></div>
<p>should be the same as</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">a</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultA</span><span class="err">?</span>
<span class="nv">b</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultB</span><span class="err">?</span>
<span class="nv">c</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultC</span><span class="err">?</span>
</code></pre></div>
<p>But the first can be used to create a Result without the return type of the function being a Result.</p>



<a name="462261403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462261403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462261403">(Aug 14 2024 at 04:47)</a>:</h4>
<p>Sure, but that still is different than the mapN functions listed in the issue above.</p>



<a name="462261802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462261802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462261802">(Aug 14 2024 at 04:49)</a>:</h4>
<p>Sure, you're right</p>



<a name="462261817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462261817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462261817">(Aug 14 2024 at 04:49)</a>:</h4>
<p>I wasn't trying to compare <code>?</code> to record builder. More trying to mention what the goal of the mapN functions was for.</p>



<a name="462261859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462261859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462261859">(Aug 14 2024 at 04:49)</a>:</h4>
<p>Also, never thought of using record builder like that</p>



<a name="462262104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462262104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462262104">(Aug 14 2024 at 04:50)</a>:</h4>
<p>Yeah, I was thinking of what you'd want to do that would use a mapN function, not something analagous to a mapN's literal usage, which isn't the same thing</p>



<a name="462262173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462262173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462262173">(Aug 14 2024 at 04:51)</a>:</h4>
<p>And yes, that's the glory of <span class="user-mention" data-user-id="489294">@Agus Zubiaga</span> 's design, it's really awesome that so much can be done with so little</p>



<a name="462262183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462262183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462262183">(Aug 14 2024 at 04:51)</a>:</h4>
<p>I guess it is the same as:</p>
<div class="codehilite"><pre><span></span><code>{a, b, c} =
    {
        a: resultA?,
        b: resultB?,
        c: resultC?,
    }?
</code></pre></div>



<a name="462262285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462262285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462262285">(Aug 14 2024 at 04:53)</a>:</h4>
<p>I'd say you shouldn't need that last ? around the record literal, but yes</p>



<a name="462262729"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462262729" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462262729">(Aug 14 2024 at 04:59)</a>:</h4>
<p>It is actually important to require the final <code>?</code> in my opinion. Enables aggregating the error and then acting on it instead of propagating it.</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">mergedRes</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nv">a</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultA</span><span class="err">?</span><span class="p">,</span>
<span class="w">        </span><span class="nv">b</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultB</span><span class="err">?</span><span class="p">,</span>
<span class="w">        </span><span class="nv">c</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultC</span><span class="err">?</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="nv">when</span><span class="w"> </span><span class="nv">mergedRes</span><span class="w"> </span><span class="nv">is</span>
<span class="w">    </span><span class="kt">Ok</span><span class="w"> </span><span class="p">{</span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="p">}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nf">...</span>
<span class="w">    </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nf">...</span>
</code></pre></div>
<p>That said, definitely depends on exactly how we decide to desugar.</p>
<p>Which of these two is it equivalent to:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultA</span><span class="err">?</span>
<span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultB</span><span class="err">?</span>
<span class="nv">z</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultC</span><span class="err">?</span>
<span class="p">{</span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="p">}</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nv">a</span><span class="nf">:</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span>
<span class="w">        </span><span class="nv">b</span><span class="nf">:</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span>
<span class="w">        </span><span class="nv">c</span><span class="nf">:</span><span class="w"> </span><span class="nv">z</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nf">`</span><span class="err">?</span><span class="nf">`</span><span class="w"> </span><span class="nv">here</span><span class="w"> </span><span class="nv">would</span><span class="w"> </span><span class="nv">be</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nv">error</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">this</span><span class="w"> </span><span class="nv">desugaring</span>
</code></pre></div>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="p">{</span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="p">}</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultA</span><span class="err">?</span>
<span class="w">    </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultB</span><span class="err">?</span>
<span class="w">    </span><span class="nv">z</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultC</span><span class="err">?</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nv">a</span><span class="nf">:</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span>
<span class="w">        </span><span class="nv">b</span><span class="nf">:</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span>
<span class="w">        </span><span class="nv">c</span><span class="nf">:</span><span class="w"> </span><span class="nv">z</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="err">?</span>
</code></pre></div>
<p>I think the second desugaring is more useful.</p>



<a name="462263549"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462263549" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462263549">(Aug 14 2024 at 05:03)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> can you move this to another thread? This is useful discussion, but I don't want to distract from this thread's purpose. I'd do it myself, but I don't have the right perms</p>



<a name="462264284"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264284" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264284">(Aug 14 2024 at 05:06)</a>:</h4>
<p>So the reason why I think the second proposed behavior is wrong is because it doesn't map onto my understanding of how ? works in Rust, which is how I assume Roc intends to work. In Rust, ? returns errors to the top of the function no matter how many blocks nested you're in. The only thing that breaks this is nested closures, which are their own functions, anyway</p>



<a name="462264426"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264426" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264426">(Aug 14 2024 at 05:08)</a>:</h4>
<p>For sure, it definitely differs from rust. That said, I think it matches <code>!</code> today. Which is probably why I expect some differences.</p>



<a name="462264429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264429">(Aug 14 2024 at 05:08)</a>:</h4>
<p>Meaning that</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="p">{</span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="p">}</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">x</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultA</span><span class="err">?</span>
<span class="w">    </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultB</span><span class="err">?</span>
<span class="w">    </span><span class="nv">z</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">resultC</span><span class="err">?</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nv">a</span><span class="nf">:</span><span class="w"> </span><span class="nv">x</span><span class="p">,</span>
<span class="w">        </span><span class="nv">b</span><span class="nf">:</span><span class="w"> </span><span class="nv">y</span><span class="p">,</span>
<span class="w">        </span><span class="nv">c</span><span class="nf">:</span><span class="w"> </span><span class="nv">z</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="err">?</span>
</code></pre></div>
<p>would already have <code>x</code>, <code>y</code>, and <code>z</code> extracted from their results, not only within the scope of the record literal's block</p>



<a name="462264439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264439">(Aug 14 2024 at 05:08)</a>:</h4>
<p>Okay, if this is how ! works today, I'm good with that</p>



<a name="462264455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264455">(Aug 14 2024 at 05:08)</a>:</h4>
<p>! and ? should work identically IMO anyway</p>



<a name="462264496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264496">(Aug 14 2024 at 05:09)</a>:</h4>
<p>I'll have to double check the impl for !, then</p>



<a name="462264524"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264524" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264524">(Aug 14 2024 at 05:10)</a>:</h4>
<p>Note, I'm not actually sure <code>!</code> works with records at all today. But it definitely works that way if you do something like:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">x</span><span class="w"> </span><span class="nf">=</span>
<span class="w">   </span><span class="nv">y</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">task1</span><span class="err">!</span>
<span class="w">   </span><span class="nv">z</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">task2</span><span class="err">!</span>
<span class="w">   </span><span class="p">{</span><span class="nv">y</span><span class="p">,</span><span class="w"> </span><span class="nv">z</span><span class="p">}</span>
</code></pre></div>
<p>In this case, <code>x</code> will be a <code>Task</code>. The outer function is not required to be a task.</p>



<a name="462264620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264620">(Aug 14 2024 at 05:10)</a>:</h4>
<p>Hmm</p>



<a name="462264682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264682">(Aug 14 2024 at 05:11)</a>:</h4>
<p>Of course with task, in essentially all cases, you will end up merging all task together and aggregating into a single error type.</p>



<a name="462264780"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264780" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264780">(Aug 14 2024 at 05:12)</a>:</h4>
<p>I'd posit that this is not desired, but I think having it return to the top-level function block isn't ideal because then we break how platforms that expect a <code>main : Task I32 _</code> work, since they aren't functions</p>



<a name="462264825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264825">(Aug 14 2024 at 05:13)</a>:</h4>
<p>Yeah, okay, I can see the logic with your above example</p>



<a name="462264886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462264886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462264886">(Aug 14 2024 at 05:13)</a>:</h4>
<p>Note, the reason it works this way is cause it is super simple sugar:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">x</span><span class="w"> </span><span class="nf">=</span>
<span class="w">   </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">await</span><span class="w"> </span><span class="nv">task1</span><span class="w"> </span><span class="nf">\</span><span class="nv">y</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">       </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">await</span><span class="w"> </span><span class="nv">task2</span><span class="w"> </span><span class="nf">\</span><span class="nv">z</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">           </span><span class="p">{</span><span class="nv">y</span><span class="p">,</span><span class="w"> </span><span class="nv">z</span><span class="p">}</span>
</code></pre></div>



<a name="462265000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265000">(Aug 14 2024 at 05:14)</a>:</h4>
<p>But ideally, you'd not have to write</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="p">{</span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="p">}</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nv">a</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultA</span><span class="err">?</span><span class="p">,</span>
<span class="w">        </span><span class="nv">b</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultB</span><span class="err">?</span><span class="p">,</span>
<span class="w">        </span><span class="nv">c</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultC</span><span class="err">?</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="err">?</span>
</code></pre></div>
<p>and could instead write</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="nv">a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="p">,</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">map2</span><span class="err">?</span><span class="w"> </span><span class="nf">&lt;-</span>
<span class="w">        </span><span class="nv">a</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultA</span><span class="p">,</span>
<span class="w">        </span><span class="nv">b</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultB</span><span class="p">,</span>
<span class="w">        </span><span class="nv">c</span><span class="nf">:</span><span class="w"> </span><span class="nv">resultC</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>and avoid all the duplication of ?</p>



<a name="462265003"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265003" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265003">(Aug 14 2024 at 05:15)</a>:</h4>
<p>I think  it matches the roc viewpoint of:</p>
<ol>
<li>everything is an expression</li>
<li>there are no early returns (in other words, no ifs without elses)</li>
</ol>



<a name="462265030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265030">(Aug 14 2024 at 05:15)</a>:</h4>
<p>Okay, so that last point...</p>



<a name="462265065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265065">(Aug 14 2024 at 05:15)</a>:</h4>
<p>Doesn't ! work like an early return? Is "no early returns" a core principle?</p>



<a name="462265133"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265133" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265133">(Aug 14 2024 at 05:16)</a>:</h4>
<p>I'm trying to think of the best wording here. Fundamentally, the real principle is there are no ifs without elses.</p>



<a name="462265183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265183">(Aug 14 2024 at 05:17)</a>:</h4>
<p>So maybe that is still just</p>
<ol>
<li>everything is an expression</li>
</ol>



<a name="462265248"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265248" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265248">(Aug 14 2024 at 05:18)</a>:</h4>
<p>so you have an <code>if</code> expression that always includes an else. The expression as a whole returns a value, so there is no early return technically.</p>



<a name="462265256"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265256" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265256">(Aug 14 2024 at 05:18)</a>:</h4>
<p>I think allowing early returns is preferable for writing clean code. AFAIK we have a way to use ! in <code>when</code> and <code>if</code> statements so that you don't have to pull out intermediate vars</p>



<a name="462265278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265278">(Aug 14 2024 at 05:18)</a>:</h4>
<p>I'd say that early returns are exactly an <code>if-else</code> statement with sugar</p>



<a name="462265318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265318">(Aug 14 2024 at 05:19)</a>:</h4>
<p>Fair enough. As long as you have an <code>else</code> with a block that includes everything else, that is an early return kinda.</p>



<a name="462265328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265328">(Aug 14 2024 at 05:19)</a>:</h4>
<p>If I write </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">parse_data</span><span class="p">(</span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">s</span><span class="p">.</span><span class="n">parse</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>
<p>There's an implicit else</p>



<a name="462265387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265387">(Aug 14 2024 at 05:20)</a>:</h4>
<p>But I think the core distinction is that you can't skip any blocks. You have to return through each layer of the expression tree</p>



<a name="462265472"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265472" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265472">(Aug 14 2024 at 05:21)</a>:</h4>
<p>So <code>!</code> inside of an <code>if</code> is not early returning. It is creating a value passed as the result of the <code>if</code>. That value could then be returned, but that is not guaranteed</p>



<a name="462265496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265496">(Aug 14 2024 at 05:21)</a>:</h4>
<p>So everything is guaranteed to be isolated to some extent.</p>



<a name="462265711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265711">(Aug 14 2024 at 05:24)</a>:</h4>
<p>If I see</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">x</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nv">tons</span><span class="w"> </span><span class="kr">of</span><span class="w"> </span><span class="nv">code</span>
<span class="w">    </span><span class="nv">finalFn</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">q</span>

<span class="nv">z</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nv">something</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="kt">I</span><span class="w"> </span><span class="nv">guess</span>
</code></pre></div>
<p>I know that <code>z</code> is guaranteed to be run. <code>x</code> is capturing the entire expression with all of that tons of code. There are no early returns. If the tons of code includes <code>!</code>, <code>x</code> is a <code>Task</code>. If the tons of code includes <code>?</code>, <code>x</code> is a <code>Result</code>. <code>x</code> may be some other type, but fundamentally, <code>x</code> is the result of some expression and then we are continuing forward.</p>



<a name="462265753"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265753" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265753">(Aug 14 2024 at 05:24)</a>:</h4>
<p>That's what I mean by no early returns.</p>



<a name="462265827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265827">(Aug 14 2024 at 05:25)</a>:</h4>
<p>I can understand wanting isolation as a principle, but I think this is valid under the "everything is an expression" rule:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">firstHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">       </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"first half: "</span>
<span class="w">    </span><span class="nv">secondHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">       </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"second half: "</span>

<span class="w">    </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"$(firstHalf) $(secondHalf)"</span>
</code></pre></div>
<p>The problem if this works is that we lose isolation, but we get the convenience of not needing to await <code>firstHalf</code> and <code>secondHalf</code> while running things.</p>



<a name="462265953"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265953" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265953">(Aug 14 2024 at 05:26)</a>:</h4>
<p>So yes, in our documentation of ! and ?, I think we need to emphasize that we break the mental model of Rust for the sake of maintaining isolation</p>



<a name="462265988"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265988" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265988">(Aug 14 2024 at 05:27)</a>:</h4>
<p>I would not expect that code to work in Roc. Would need to be:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">firstHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"first half: "</span>
<span class="w">    </span><span class="nv">secondHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"second half: "</span>

<span class="w">    </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"$(firstHalf!) $(secondHalf!)"</span>
</code></pre></div>



<a name="462265990"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462265990" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462265990">(Aug 14 2024 at 05:27)</a>:</h4>
<p>Unless the thing we both seem to agree on (the current behavior is good and should be kept) is actually bad and needs to be made to follow Rust</p>



<a name="462266008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266008">(Aug 14 2024 at 05:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F/near/462265988">said</a>:</p>
<blockquote>
<p>I would not expect that code to work in Roc. Would need to be:</p>
<p><div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">firstHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">       </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"first half: "</span>
<span class="w">    </span><span class="nv">secondHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">       </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"second half: "</span>

<span class="w">    </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"$(firstHalf!) $(secondHalf!)"</span>
</code></pre></div><br>
</p>
</blockquote>
<p>Yes, it wouldn't work with current rules, only if we changed Roc to work like Rust</p>



<a name="462266016"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266016" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266016">(Aug 14 2024 at 05:27)</a>:</h4>
<p>yep</p>



<a name="462266156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266156">(Aug 14 2024 at 05:29)</a>:</h4>
<p>But yeah, we definitely could change <code>!</code> desugaring to make that work.</p>



<a name="462266217"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266217" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266217">(Aug 14 2024 at 05:30)</a>:</h4>
<p>It is kinda jumping up an extra scope, but that might be ok</p>



<a name="462266450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266450">(Aug 14 2024 at 05:32)</a>:</h4>
<p>No, unless it's really annoying to people, I prefer the isolation we get to the scope level. I think it will be really annoying to have it work the other way</p>



<a name="462266461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266461">(Aug 14 2024 at 05:32)</a>:</h4>
<p>I think this just requires documentation in the tutorial</p>



<a name="462266523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266523">(Aug 14 2024 at 05:33)</a>:</h4>
<p>This is definitely one of those things where working through the journey of how roc got to <code>!</code> makes the isolation feel totally normal, but obvious that is now how new users will feel. From nested closures to backpassing to <code>!</code>.</p>



<a name="462266579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266579">(Aug 14 2024 at 05:34)</a>:</h4>
<p>I wonder what the best way to teach this is.</p>



<a name="462266632"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266632" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266632">(Aug 14 2024 at 05:35)</a>:</h4>
<p>Makes me also think of:</p>
<div class="codehilite"><pre><span></span><code>input = Stdin.line {}
    |&gt; Task.mapErr! StdinErr
</code></pre></div>
<p>When I first saw that I was super confused. <code>!</code> felt like it was in a nonsensical place</p>



<a name="462266658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266658">(Aug 14 2024 at 05:35)</a>:</h4>
<p>Yeah, great similar example to bring up</p>



<a name="462266671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266671">(Aug 14 2024 at 05:36)</a>:</h4>
<p>Makes perfect sense as a simple design choice once you get it</p>



<a name="462266718"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462266718" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462266718">(Aug 14 2024 at 05:36)</a>:</h4>
<p>It feels like watching Arrival haha</p>



<a name="462327548"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462327548" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462327548">(Aug 14 2024 at 11:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F/near/462265278">said</a>:</p>
<blockquote>
<p>I'd say that early returns are exactly an <code>if-else</code> statement with sugar</p>
</blockquote>
<p>in Roc this is true (although in other languages it's more complicated because of things like <code>finally</code>) - we've never talked about <code>return</code> as an idea! Do you want to start a thread in <a class="stream" data-stream-id="304641" href="/#narrow/stream/304641-ideas">#ideas</a> about it?</p>



<a name="462339422"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462339422" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462339422">(Aug 14 2024 at 12:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F/near/462262183">said</a>:</p>
<blockquote>
<p>I guess it is the same as:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">{</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">}</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">resultA</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">resultB</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">resultC</span><span class="o">?</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="o">?</span>
</code></pre></div><br>
</p>
</blockquote>
<p>an argument for not requiring the <code>}?</code> is that (as Sam noted earlier) you can already get that behavior using record builders:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nb">Result</span><span class="p">.</span><span class="n">map2</span><span class="w"> </span><span class="o">&lt;-</span>
<span class="w">        </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="nc">resultA</span><span class="p">,</span>
<span class="w">        </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="nc">resultB</span><span class="p">,</span>
<span class="w">        </span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="nc">resultC</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="o">?</span>
</code></pre></div>



<a name="462339474"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462339474" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462339474">(Aug 14 2024 at 12:54)</a>:</h4>
<p>and I definitely agree that <code>!</code> and <code>?</code> should have the same rules</p>



<a name="462339698"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462339698" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462339698">(Aug 14 2024 at 12:55)</a>:</h4>
<p>using <code>!</code> with records seems much more common, and there I think we wouldn't want <code>}!</code> - e.g.</p>
<div class="codehilite" data-code-language="Perl"><pre><span></span><code><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">username:</span><span class="w"> </span><span class="n">readUsernameFromFile</span><span class="o">!</span><span class="p">,</span>
<span class="w">    </span><span class="n">posts:</span><span class="w"> </span><span class="n">getPostsFromUrl</span><span class="o">!</span><span class="w"> </span><span class="n">url</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="462339760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462339760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462339760">(Aug 14 2024 at 12:55)</a>:</h4>
<p>I don't think anyone would expect to have to write that as:</p>
<div class="codehilite" data-code-language="Perl"><pre><span></span><code><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">username:</span><span class="w"> </span><span class="n">readUsernameFromFile</span><span class="o">!</span><span class="p">,</span>
<span class="w">    </span><span class="n">posts:</span><span class="w"> </span><span class="n">getPostsFromUrl</span><span class="o">!</span><span class="w"> </span><span class="n">url</span><span class="p">,</span>
<span class="p">}</span><span class="o">!</span>
</code></pre></div>



<a name="462370156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462370156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462370156">(Aug 14 2024 at 15:33)</a>:</h4>
<p>Fair. This is mostly a question of what counts as a nested expression.</p>
<p>As mentioned by Sam above, we could also make this work if we wanted:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">firstHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"first half: "</span>
<span class="w">    </span><span class="nv">secondHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"second half: "</span>

<span class="w">    </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"$(firstHalf) $(secondHalf)"</span>
</code></pre></div>



<a name="462370310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462370310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462370310">(Aug 14 2024 at 15:34)</a>:</h4>
<p>We just have to make the rules consistent enough that we don't confuse users too much</p>



<a name="462370927"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462370927" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462370927">(Aug 14 2024 at 15:37)</a>:</h4>
<p>Also, going a step farther, what about this:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">tasks</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">userTask</span><span class="nf">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">username</span><span class="nf">:</span><span class="w"> </span><span class="nv">readUsernameFromFile</span><span class="err">!</span><span class="p">,</span>
<span class="w">        </span><span class="nv">posts</span><span class="nf">:</span><span class="w"> </span><span class="nv">getPostsFromUrl</span><span class="err">!</span><span class="w"> </span><span class="nv">url</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nv">adminTask</span><span class="nf">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nv">username</span><span class="nf">:</span><span class="w"> </span><span class="nv">readUsernameFromFile</span><span class="err">!</span><span class="p">,</span>
<span class="w">        </span><span class="nv">posts</span><span class="nf">:</span><span class="w"> </span><span class="nv">getPostsFromUrl</span><span class="err">!</span><span class="w"> </span><span class="nv">url</span><span class="p">,</span>
<span class="w">        </span><span class="nv">secretStuff</span><span class="nf">:</span><span class="w"> </span><span class="nv">readSecretAdminOnlyStuff</span><span class="err">!</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="kr">if</span><span class="w"> </span><span class="nv">user</span><span class="nf">.</span><span class="nv">isAdmin</span><span class="w"> </span><span class="nf">...</span><span class="w"> </span><span class="kr">then</span>
<span class="w">    </span><span class="p">{</span><span class="nv">username</span><span class="p">,</span><span class="w"> </span><span class="nv">posts</span><span class="p">,</span><span class="w"> </span><span class="nv">secretStuff</span><span class="p">}</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">tasks</span><span class="nf">.</span><span class="nv">adminTask</span><span class="err">!</span>
<span class="w">    </span><span class="nf">...</span>
<span class="kr">else</span>
<span class="w">    </span><span class="p">{</span><span class="nv">username</span><span class="p">,</span><span class="w"> </span><span class="nv">posts</span><span class="p">}</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">tasks</span><span class="nf">.</span><span class="nv">userTask</span><span class="err">!</span>
<span class="w">    </span><span class="nf">...</span>
</code></pre></div>



<a name="462373783"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462373783" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462373783">(Aug 14 2024 at 15:49)</a>:</h4>
<blockquote>
<p>we could also make this work if we wanted:</p>
</blockquote>
<p>Yeah, I've hit that one a couple times as well. I think if that does not work it will be confusing for users who don't deeply understand ! desugaring</p>



<a name="462385587"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462385587" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462385587">(Aug 14 2024 at 17:00)</a>:</h4>
<p>so the idea there would be that we automatically insert <code>Task.ok</code> at the end of the expression?</p>



<a name="462385878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462385878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462385878">(Aug 14 2024 at 17:02)</a>:</h4>
<p>if so, I can see that being useful but also potentially confusing in conditionals, e.g. this wouldn't work:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">foo</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="n">blah</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="n">input</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="o">.</span><span class="n">line</span><span class="o">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kt">Str</span><span class="o">.</span><span class="n">withPrefix</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="s">"first half: "</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="s">"stuff"</span>
</code></pre></div>



<a name="462385923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462385923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462385923">(Aug 14 2024 at 17:02)</a>:</h4>
<p>because it would have to be <code>Task.ok "stuff"</code> since the sugar wouldn't expand to the <code>else</code> branch</p>



<a name="462386001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462386001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462386001">(Aug 14 2024 at 17:03)</a>:</h4>
<p>we could potentially make the rule be that if there's a <code>!</code> in one branch, we treat all the other branches as having a <code>!</code> too <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="462386019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462386019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462386019">(Aug 14 2024 at 17:03)</a>:</h4>
<p>and on those grounds apply the transformation to all of them</p>



<a name="462388073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462388073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462388073">(Aug 14 2024 at 17:16)</a>:</h4>
<p>That sounds reasonable</p>



<a name="462437690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462437690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462437690">(Aug 15 2024 at 00:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F/near/462385587">said</a>:</p>
<blockquote>
<p>so the idea there would be that we automatically insert <code>Task.ok</code> at the end of the expression?</p>
</blockquote>
<p>I just realized a cool thing about this idea:</p>
<ul>
<li>this is a syntax sugar transformation, so it doesn't know about types</li>
<li>therefore, if it <em>always</em> inserts a <code>Task.ok</code> at the end, that will be a problem if you already happened to have a <code>Task</code> at the end, because it would become a <code>Task (Task ...) ...</code> - which isn't what you want</li>
<li>we could fix this by saying "if the last thing is a task, put a <code>!</code> on it and we won't add the <code>Task.ok</code>"</li>
<li>I would actually consider this an improvement over the status quo, because currently the rule is "trailing <code>!</code> is optional but doesn't do anything, but it's encouraged, although <code>roc format</code> can't enforce it one way or the other" - and in this world, you would actually <em>have</em> to use trailing <code>!</code> when you want to return a <code>Task</code> because otherwise you'd get a type mismatch</li>
</ul>



<a name="462437760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462437760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462437760">(Aug 15 2024 at 00:18)</a>:</h4>
<p>so it would eliminate the unnecessary (and unintentional, but currently unavoidable) stylistic option there</p>



<a name="462437784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462437784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462437784">(Aug 15 2024 at 00:18)</a>:</h4>
<p>and make the style more consistent!</p>



<a name="462440097"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462440097" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462440097">(Aug 15 2024 at 00:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F/near/462385587">said</a>:</p>
<blockquote>
<p>so the idea there would be that we automatically insert <code>Task.ok</code> at the end of the expression?</p>
</blockquote>
<p>I don't think that was the idea. I think the idea was that <code>!</code> would desugar to the outer scope.</p>



<a name="462449047"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462449047" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462449047">(Aug 15 2024 at 01:51)</a>:</h4>
<p>hm, I don't follow <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="462451607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462451607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462451607">(Aug 15 2024 at 02:11)</a>:</h4>
<p>Essentially, the question was, should this code:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">firstHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"first half: "</span>
<span class="w">    </span><span class="nv">secondHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">input</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="s">"second half: "</span>

<span class="w">    </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"$(firstHalf) $(secondHalf)"</span>
</code></pre></div>
<p>do the same as this code?</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">input0</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="nv">firstHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input0</span><span class="w"> </span><span class="s">"first half: "</span>
<span class="w">    </span><span class="nv">input1</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdin</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="nv">secondHalf</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">withPrefix</span><span class="w"> </span><span class="nv">input1</span><span class="w"> </span><span class="s">"second half: "</span>

<span class="w">    </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"$(firstHalf) $(secondHalf)"</span>
</code></pre></div>



<a name="462451661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462451661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462451661">(Aug 15 2024 at 02:11)</a>:</h4>
<p>Many beginners expect those two pieces of code to be equivalent. It also is more similar to how <code>?</code> works in rust.</p>



<a name="462455263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462455263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462455263">(Aug 15 2024 at 02:50)</a>:</h4>
<p>hm, I don't think beginners would write the first thing though <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="462455298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462455298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462455298">(Aug 15 2024 at 02:50)</a>:</h4>
<p>so that seems moot in this case, although maybe there's another case where it might come up?</p>



<a name="462465254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462465254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462465254">(Aug 15 2024 at 04:09)</a>:</h4>
<p>I would assume similar cases exist. That said, I think where a beginner is most likely to trip up would be related to conditionals and the trailing Task.ok. so your idea above seems helpful</p>



<a name="462532158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Record%20mapping%20and%20%3F/near/462532158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Record.20mapping.20and.20.3F.html#462532158">(Aug 15 2024 at 11:37)</a>:</h4>
<p>yeah I think that idea is worth exploring!</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>zig compiler - snapshot testing · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html">zig compiler - snapshot testing</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="498046429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498046429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498046429">(Feb 06 2025 at 06:40)</a>:</h4>
<p>For testing in the new compiler, I want to take a few lessons from both the current snapshot testing system in test_syntax, as well as making a similar system applicable across the rest of the compiler passes. I also want to take more inspiration from llvm <code>lit</code> tests and the zig compiler tests.</p>
<p>My thinking is each test should be in a single file, with the output of passes (e.g. the ast) simply concatenated on the end of each test. You'd have the test source, then <code>####</code> (or some other separator), then the formatted version of that source, then a separator, then a pretty-printed form of the AST, then the canonicalized ir, etc. This is in contrast to the current snapshot tests, where the formatted code and the ast are in separate files from the input. I also want to include any problems directly into the file. This should hopefully minimize needing to swap back and forth between </p>
<p>In contrast to the current <code>test_syntax</code> tests which heavily test the parser and formatter but generally aren't semantically valid, I'd like to focus more on having most tests ending up making it all the way thru the compiler. In cases we don't want this, we can include a system of directives at the top of the test in order to control what parts of the compiler we run, and which passes we include the output of.</p>
<p>Also in contrast to the current <code>test_syntax</code> system, adding a new test shouldn't require recompiling. This necessarily means these tests will use a custom test harness - probably just a separate binary compiled from a different main file in the source tree.</p>
<p>Inspired by the zig compiler, we can have a syntax for specifying the contents of multiple test files as part of the same test case.</p>
<p>Here's a quick example:</p>
<div class="codehilite"><pre><span></span><code>#### Mode: expression # &lt;-- this directive will cause us to parse and compile the input as if it was a repl input
&quot;test&quot;.length()
#### Formatted: (same)
#### AST:
(pnc_call (str &quot;test&quot;) (ident &quot;length&quot;)())
#### Can IR:
&lt;tbd&gt;
#### etc etc
</code></pre></div>
<p>Thoughts?</p>



<a name="498046916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498046916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498046916">(Feb 06 2025 at 06:44)</a>:</h4>
<p>I think it is also important to be able to start part way down the stack. I should be able to make a small Can IR and simply run the resolve step with nothing else. Or run the interpreter theoretically.</p>



<a name="498046987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498046987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498046987">(Feb 06 2025 at 06:45)</a>:</h4>
<p>That does imply we have not just a "debug dump" functionality for each IR, but also the ability to _parse_ that IR</p>



<a name="498047004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047004">(Feb 06 2025 at 06:45)</a>:</h4>
<p>Agreed that's valuable tho</p>



<a name="498047042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047042">(Feb 06 2025 at 06:46)</a>:</h4>
<p>I think this is one of the best features of MLIR.</p>



<a name="498047073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047073">(Feb 06 2025 at 06:46)</a>:</h4>
<p>Really helps with testing during development</p>



<a name="498047095"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047095" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047095">(Feb 06 2025 at 06:46)</a>:</h4>
<p>That said, can get messy at scale.</p>



<a name="498047138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047138">(Feb 06 2025 at 06:46)</a>:</h4>
<p>I don't think we necessarily need this for every IR, but at least the IRs around complex passes.</p>



<a name="498047184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047184">(Feb 06 2025 at 06:47)</a>:</h4>
<p>Often times, that makes a much more concise and understandable test than starting all the way at the top level IR.</p>



<a name="498047369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047369">(Feb 06 2025 at 06:48)</a>:</h4>
<p>That said, I am simply used to doing that for pass level unit tests at this point. That same could be done in pure zig if generating IR is simple enough</p>



<a name="498047436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047436">(Feb 06 2025 at 06:49)</a>:</h4>
<p>I think in the rust compiler generating IR is so painful that it makes unit testing passes less likely to happen and more painful</p>



<a name="498047546"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047546" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047546">(Feb 06 2025 at 06:49)</a>:</h4>
<p>If generating a zig ast is trivial, we could consider doing that for pass level tests instead of snapshots.</p>



<a name="498047777"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047777" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047777">(Feb 06 2025 at 06:51)</a>:</h4>
<p>What do you mean by "generating a zig ast"?</p>



<a name="498047925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047925">(Feb 06 2025 at 06:52)</a>:</h4>
<p>Oh, one other thought:</p>
<p>With <code>lit</code> and <code>FileCheck</code>, you can choose to ignore 90% of an ir and just check something very specific. Sometimes that is really useful for making tests more understandable (focuses on what is expected to change instead of printing the entire IR). Not sure that is the right choice a lot of the time though. Well it reduces verbosity, it can often miss bugs, so <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="498047998"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498047998" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498047998">(Feb 06 2025 at 06:52)</a>:</h4>
<p>Ahhh I should read up on that</p>



<a name="498048038"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498048038" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498048038">(Feb 06 2025 at 06:53)</a>:</h4>
<blockquote>
<p>What do you mean by "generating a zig ast"?</p>
</blockquote>
<p>If generating a Parse/Can/Resolve/etc IR ast directly in zig code is easy enough, then maybe that is enough for unit testing. If it is verbose or painful at all to generate said IR, I definitely think we want parsing at all levels.</p>



<a name="498048177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498048177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498048177">(Feb 06 2025 at 06:54)</a>:</h4>
<p>Ahhh. My somewhat naive prediction is that'll end up being more verbose than will be ergonomic for doing lots of unit tests.</p>



<a name="498048208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498048208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498048208">(Feb 06 2025 at 06:54)</a>:</h4>
<p>Maybe there are zig tricks I don't know tho?</p>



<a name="498048220"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498048220" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498048220">(Feb 06 2025 at 06:54)</a>:</h4>
<p>Yeah, that is my exact same thought and question</p>



<a name="498048239"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498048239" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498048239">(Feb 06 2025 at 06:54)</a>:</h4>
<p>So I bet we will want a parser for the various IRs</p>



<a name="498048250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498048250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498048250">(Feb 06 2025 at 06:54)</a>:</h4>
<p>It will make them way more testable</p>



<a name="498048261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498048261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498048261">(Feb 06 2025 at 06:55)</a>:</h4>
<p>As a side note, we totally could just directly use lit and file check assuming we have a flag or special executable that simply prints out the IRs. (not saying it is worth it, just noting)</p>
<p>and this is filecheck, really simple: <a href="https://llvm.org/docs/CommandGuide/FileCheck.html">https://llvm.org/docs/CommandGuide/FileCheck.html</a></p>



<a name="498061944"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498061944" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498061944">(Feb 06 2025 at 08:26)</a>:</h4>
<p>I had just assumed it would be a folder for each test, with a different file containing each IR. But I guess a single file may be easier?</p>



<a name="498129424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498129424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> László Benedek <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498129424">(Feb 06 2025 at 14:10)</a>:</h4>
<p>I’m not active on these forums (only lurking) but I’d like to break the silence and share an advice. If you start creating IR tests then it will make refactoring much harder because you will have to change an insane amount of (test) code every time you change the IR or try to rearrange passes. Unless you feel that you can see the future and it is not a real issue, I really really recommend not doing this and instead focus solely on end to end tests. An end to end test suite is much more valuable than a set of IR tests. This would help with alternative compiler implementations or various large scale refactors where otherwise you’d have to throw out or migrate a lot of test code.</p>



<a name="498149197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498149197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498149197">(Feb 06 2025 at 15:33)</a>:</h4>
<p>Yep, they will change pretty often - and that’s why an important part of this will be automated tooling to update the checked in snapshots as necessary. (I didn’t mention that above, but it’s already part of the test_syntax snapshots)</p>



<a name="498165559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498165559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498165559">(Feb 06 2025 at 16:44)</a>:</h4>
<blockquote>
<p>If you start creating IR tests then it will make refactoring much harder because you will have to change an insane amount of (test) code every time you change the IR or try to rearrange passes.</p>
</blockquote>
<p>I pretty strongly disagree with this overall premise. While end to end tests are fundamental for a compiler like this, even a handful of mediocre pass level tests often are quite valuable. E2E tests are often painful to debug. If something can be caught by a pass level test, it saves tons of times. On top of that, testing the core pillars of various transformations can help make them a lot more robust (bonus if you can fuzz and arbitrary pass). Yes, it is more work, but it is super important work to make a robust compiler and I have seen this kind of work save tons of time.</p>
<blockquote>
<p>Unless you feel that you can see the future and it is not a real issue, I really really recommend not doing this and instead focus solely on end to end tests.</p>
</blockquote>
<p>This is a second rewrite of the compiler so we do have very strong understanding of the passes and ordering. I'm sure we'll shift some around, but that's ok.</p>
<blockquote>
<p>An end to end test suite is much more valuable than a set of IR tests. This would help with alternative compiler implementations or various large scale refactors where otherwise you’d have to throw out or migrate a lot of test code.</p>
</blockquote>
<p>The same can always be said of unit tests. It doesn't matter if it is a compiler, webserver, app, game, etc. Yet, the industry has for the most part realized that unit tests lead to better software despite needing to be thrown away or rewritten when software changes.</p>
<p>I think trying to focus solely on end to end tests would be a big mistake and a way to fundamentally make our compiler more brittle and harder to debug.</p>
<hr>
<p>As I mentioned above after working with mlir for years, one of its pieces of magic is simply that every ir can be printed and parsed. This enables spinning up tons of pass level unit tests. It makes way more robust software, is more observalble and debuggable.</p>



<a name="498166429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498166429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498166429">(Feb 06 2025 at 16:48)</a>:</h4>
<p>Aside for <span class="user-mention" data-user-id="453336">@Joshua Warner</span>: another reason to enable pass by pass snapshot tests is cause most of the functionally can be tested without seeing the monster updates of full compiler snapshot tests. So adding a feature to the parser won't affect the can ir to resolve ir snapshot tests at all. But adding said feature if you only have these e2e test will affect all tests. Just makes it harder to validate what changed. (Still need the E2E tests, but maybe not as many)</p>



<a name="498212000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498212000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498212000">(Feb 06 2025 at 21:18)</a>:</h4>
<p>One thing about forcing tests to start as real roc code that at least sounds good on the surface to me, is that forces us never have ambiguity about, "yeah but that state of the IR is not something the previous pass would ever generate so why are we trying to handle this". If there's a test, then it's unambiguously possible to hit that part of the state space. Combine that with good fuzzing that hopefully reaches fairly deep into the compiler (far from proven!), and you can maybe have the best of both worlds.</p>



<a name="498220795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498220795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498220795">(Feb 06 2025 at 22:17)</a>:</h4>
<p>Yeah, I think that is great for larger examples. I think for smaller features and simple algorithm tests, the snippets are much nicer.</p>



<a name="498220830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498220830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498220830">(Feb 06 2025 at 22:18)</a>:</h4>
<p>That said, the golden standard is for every ir to have a verifier for what is valid or not</p>



<a name="498220950"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498220950" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498220950">(Feb 06 2025 at 22:18)</a>:</h4>
<p>And if every ir has a parser and verifier, you can start fuzzing at any point in the compiler and stop at any point. Which should enable much better fuzzing exploration</p>



<a name="498220993"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498220993" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498220993">(Feb 06 2025 at 22:19)</a>:</h4>
<p>Not to mention the fuzzer can break if any invariant to broken at any or level</p>



<a name="498221032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498221032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498221032">(Feb 06 2025 at 22:19)</a>:</h4>
<p>Though obviously correct by construction IRs see the best.</p>



<a name="498796111"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498796111" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Loris Cro <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498796111">(Feb 10 2025 at 15:42)</a>:</h4>
<p>Not sure how well this can apply to your use case but it works perfectly well for me in Zine: <a href="https://kristoff.it/blog/dead-simple-snapshot-testing/">https://kristoff.it/blog/dead-simple-snapshot-testing/</a> (bonus mention of 2 snapshot testing frameworks for Zig in the post)</p>



<a name="498798084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/498798084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#498798084">(Feb 10 2025 at 15:49)</a>:</h4>
<p>Oh nice, that looks like a great strategy!</p>



<a name="499810153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499810153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499810153">(Feb 14 2025 at 19:11)</a>:</h4>
<p>I started looking at function lifting, and it's going to be much easier to write tests for the build stages like that once we have IR dumping and parsing in place. Did anyone have specific ideas about how this should be implemented? Is the idea to manually write a sexpr printer and parser for each IR?</p>



<a name="499810410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499810410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499810410">(Feb 14 2025 at 19:12)</a>:</h4>
<p>I think at least a printer</p>



<a name="499810928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499810928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499810928">(Feb 14 2025 at 19:16)</a>:</h4>
<p>If we implement the phases roughly in order, we can just have Roc source go in, and each S-expr printer come out, we glue everything together, and check that the file has the expected content</p>



<a name="499812401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499812401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499812401">(Feb 14 2025 at 19:26)</a>:</h4>
<p>If we want to be able to work on the later stages of the compiler before everything else is implemented I think we'll need to write parsers also. Manually writing the IR for the previous stage seems prohibitively tedious</p>



<a name="499884462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499884462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499884462">(Feb 15 2025 at 05:37)</a>:</h4>
<p>Yeah, I was running into the exact same thing when starting to look at function solving. For that stage though, it uses the function lift IR. <span class="user-mention" data-user-id="611722">@Isaac Van Doren</span> any way I can help out in writing the parsers/printers?</p>



<a name="499884806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499884806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499884806">(Feb 15 2025 at 05:43)</a>:</h4>
<p>I'd say it would be helpful to take the IR in <code>src/build/lift_functions/IR.zig</code> and have a go at building a pretty printer / S-expression thing for it</p>



<a name="499884884"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499884884" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499884884">(Feb 15 2025 at 05:44)</a>:</h4>
<p>I have come up with a method for making snapshots in <a href="https://github.com/roc-lang/roc/pull/7608">https://github.com/roc-lang/roc/pull/7608</a> which it <em>very</em> preliminary... but I figure we are in an exploratory phase so may as well just try things.</p>



<a name="499884898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499884898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499884898">(Feb 15 2025 at 05:44)</a>:</h4>
<p>I've found Claude is able to write slabs of code at once, and I can iterate pretty quickly with ideas.</p>



<a name="499885233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499885233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499885233">(Feb 15 2025 at 05:50)</a>:</h4>
<p>Not sure this is a good way to do it, but in my struct for the UnificationTable I added a field and then a <code>debugLog</code> fn which writes to a file.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="n">debug_capture</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="n">std</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">File</span><span class="p">.</span><span class="n">Writer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>

<span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">debugLog</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">UnificationTable</span><span class="p">,</span><span class="w"> </span><span class="kr">comptime</span><span class="w"> </span><span class="n">fmt</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">:</span><span class="w"> </span><span class="n">anytype</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">builtin</span><span class="p">.</span><span class="n">is_test</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">debug_capture</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">debug_capture</span><span class="p">.</span><span class="o">?</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The I use it in tests like this.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">// create a snapshot file</span>
<span class="kr">const</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">fs</span><span class="p">.</span><span class="n">cwd</span><span class="p">().</span><span class="n">createFile</span><span class="p">(</span><span class="s">"src/types/snapshots/unification_table_descriptor_modification.txt"</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>

<span class="kr">var</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">UnificationTable</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="k">defer</span><span class="w"> </span><span class="n">table</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="c1">// give the file to our struct</span>
<span class="n">table</span><span class="p">.</span><span class="n">debug_capture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">writer</span><span class="p">();</span>

<span class="c1">// write something to the file</span>
<span class="n">table</span><span class="p">.</span><span class="n">debugLog</span><span class="p">(</span><span class="s">"INFO: Modify descriptor change Mark from {} to {}</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="n">Mark</span><span class="p">.</span><span class="n">NONE</span><span class="p">,</span><span class="w"> </span><span class="n">Mark</span><span class="p">.</span><span class="n">OCCURS</span><span class="w"> </span><span class="p">});</span>

<span class="c1">// internal methods to the UnificationTable also use</span>
<span class="c1">// self.debugLog to write to the file...</span>
</code></pre></div>



<a name="499885583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499885583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499885583">(Feb 15 2025 at 05:57)</a>:</h4>
<p>That's an interesting pattern! If this works for the typecheck tests, we can try applying it elsewhere</p>



<a name="499885803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499885803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499885803">(Feb 15 2025 at 06:00)</a>:</h4>
<p>I'm sure there is a better way to do it... not sure if zig has interfaces or anything yet. Still a zig noob</p>



<a name="499950674"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499950674" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499950674">(Feb 15 2025 at 21:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="341568">Jared Ramirez</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing/near/499884462">said</a>:</p>
<blockquote>
<p>Yeah, I was running into the exact same thing when starting to look at function solving. For that stage though, it uses the function lift IR. <span class="user-mention silent" data-user-id="611722">Isaac Van Doren</span> any way I can help out in writing the parsers/printers?</p>
</blockquote>
<p>I'm not sure if there's a great way for us to work concurrently on this, but I'd be happy to pair!</p>



<a name="499950743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499950743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499950743">(Feb 15 2025 at 21:09)</a>:</h4>
<p>I think it would be ideal to store the snapshots as multiline strings directly in the test source. Then you can see exactly what each test is doing in one place without having to deal with any extra files. We can use the <code>@src</code> builtin to accomplish this. Described in this blog post <a href="https://tigerbeetle.com/blog/2024-05-14-snapshot-testing-for-the-masses/">https://tigerbeetle.com/blog/2024-05-14-snapshot-testing-for-the-masses/</a></p>



<a name="499951547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499951547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499951547">(Feb 15 2025 at 21:22)</a>:</h4>
<p>I don't think that will scale for roc</p>



<a name="499951556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499951556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499951556">(Feb 15 2025 at 21:22)</a>:</h4>
<p>We have way way too many cases and they work best as individual files</p>



<a name="499951580"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499951580" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499951580">(Feb 15 2025 at 21:23)</a>:</h4>
<p>Otherwise, parse.zig would be 10000 lines of snapshots of the ast.</p>



<a name="499951588"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499951588" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499951588">(Feb 15 2025 at 21:23)</a>:</h4>
<p>So I think the git and file based solution is definitely the way to go</p>



<a name="499951617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499951617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499951617">(Feb 15 2025 at 21:24)</a>:</h4>
<p>Especially since roc files are naturally files anyway</p>



<a name="499951685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499951685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499951685">(Feb 15 2025 at 21:24)</a>:</h4>
<p>I do like <span class="user-mention" data-user-id="453336">@Joshua Warner</span>'s idea to put section headers ina. Single file so you can scroll through the various IRs. Instead of each or being its own file</p>



<a name="499952259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/499952259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#499952259">(Feb 15 2025 at 21:34)</a>:</h4>
<p>Yeah that's fair</p>



<a name="529744990"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529744990" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529744990">(Jul 21 2025 at 03:02)</a>:</h4>
<p>Looks like snapshot EXPECTED handling is now broken in a couple different ways:</p>
<ol>
<li>In several snapshots, we have lines in PROBLEMS that begin with <code># </code> (comments extracted from roc code in a snippet) - and the <code>extractSection</code> logic doesn't handle that properly. Indeed, I think we'll need to adjust the format a bit if we want that to work properly in all cases.</li>
<li>The <code>repl</code> snapshots now re-use the EXPECTED section to mean something different, but <code>zig build update-expected</code> doesn't aware of that and (un)helpfully puts the extracted problems into the EXPECTED section, thereby breaking the tests.</li>
</ol>



<a name="529745025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745025">(Jul 21 2025 at 03:03)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> IIRC you were wanting to keep the update-expected functionality separate from snapshot.zig - can you say more about that?</p>



<a name="529745053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745053">(Jul 21 2025 at 03:03)</a>:</h4>
<p>I think neither of these bugs would have happened if the updated-expected logic (and the verification test) were better integrated with the snapshot code.</p>



<a name="529745086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745086">(Jul 21 2025 at 03:04)</a>:</h4>
<p>ah damn</p>



<a name="529745089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745089">(Jul 21 2025 at 03:04)</a>:</h4>
<p>I didn't think of <code>update-expected</code></p>



<a name="529745173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745173">(Jul 21 2025 at 03:06)</a>:</h4>
<p>so for repl snapshots, what I really want to confirm hasn't regressed is the repl output as a whole, which includes both diagnostic reports <em>and</em> the output values</p>



<a name="529745185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745185">(Jul 21 2025 at 03:06)</a>:</h4>
<p>I don't really care about the distinction between like "here are the problems that were reported" and "here was the repl output" because at the end of the day I'm going to see both in the repl anyway, so it seemed reasonable to combine them</p>



<a name="529745204"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745204" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745204">(Jul 21 2025 at 03:07)</a>:</h4>
<p>(although actually I'm not sure if the problems are included in that repl snapshot output right yet)</p>



<a name="529745206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745206">(Jul 21 2025 at 03:07)</a>:</h4>
<p>They're not</p>



<a name="529745211"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745211" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745211">(Jul 21 2025 at 03:07)</a>:</h4>
<p>so it seemed like at the time having that replace <code>EXPECTED</code> made sense</p>



<a name="529745218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745218">(Jul 21 2025 at 03:07)</a>:</h4>
<p>but maybe they should just have their own separate snapshot format?</p>



<a name="529745238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745238">(Jul 21 2025 at 03:08)</a>:</h4>
<p>Why not have an <code>OUTPUT</code> section?</p>



<a name="529745263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745263">(Jul 21 2025 at 03:08)</a>:</h4>
<p>only for repl snapshots?</p>



<a name="529745271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745271">(Jul 21 2025 at 03:08)</a>:</h4>
<p>that would work - would it be clear that that's the <em>expected</em> output?</p>



<a name="529745296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745296">(Jul 21 2025 at 03:09)</a>:</h4>
<blockquote>
<p>only for repl snapshots?</p>
</blockquote>
<p>For the moment; but in the future I don't know why we couldn't/wouldn't  expand that to exprs and full file snapshots</p>



<a name="529745331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745331">(Jul 21 2025 at 03:10)</a>:</h4>
<blockquote>
<p>would it be clear that that's the <em>expected</em> output</p>
</blockquote>
<p>We can just _not_ update it unless a flag is passed</p>



<a name="529745336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745336">(Jul 21 2025 at 03:10)</a>:</h4>
<p><code>--update-output</code> or something</p>



<a name="529745354"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745354" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745354">(Jul 21 2025 at 03:10)</a>:</h4>
<p>And if that flag isn't passed, we can print a warning about some outputs having changed</p>



<a name="529745384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745384">(Jul 21 2025 at 03:11)</a>:</h4>
<p>(Or even error out I suppose)</p>



<a name="529745451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745451">(Jul 21 2025 at 03:12)</a>:</h4>
<p>Side note: for the expected problems, I kinda want to switch to a "lit"-style test, with problems noted in comments</p>



<a name="529745490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529745490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529745490">(Jul 21 2025 at 03:13)</a>:</h4>
<p>e.g.</p>
<div class="codehilite"><pre><span></span><code>foo(bar) # EXPECTED: IDENTIFIER NOT DEFINED
</code></pre></div>
<p>(or whatever the error message would be)</p>



<a name="529746305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529746305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529746305">(Jul 21 2025 at 03:30)</a>:</h4>
<p>gotcha, the output changes sound fine to me! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="529941162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529941162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529941162">(Jul 21 2025 at 18:01)</a>:</h4>
<p>Made those changes as part of a somewhat more significant reorganization of the logic here: <a href="https://github.com/roc-lang/roc/pull/8089">https://github.com/roc-lang/roc/pull/8089</a></p>



<a name="529941341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529941341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529941341">(Jul 21 2025 at 18:02)</a>:</h4>
<p>The other stuff going on there is centralizing all the snapshot logic to go thru the same snapshot generation functions to hopefully prevent this sort of issue cropping up again in the future</p>



<a name="529941458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529941458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529941458">(Jul 21 2025 at 18:02)</a>:</h4>
<p>Now instead of <code>zig build update-expected</code>, you do <code>zig build snapshot -- --update-expected</code>. There's also <code>--check-expected</code>, <code>--update-output</code>, and <code>--check-output</code>.</p>



<a name="529942318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529942318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529942318">(Jul 21 2025 at 18:07)</a>:</h4>
<p>There's still a test that does the validation of snapshots (without doing updates), and that now lives in snapshot.zig, calling the same snapshot generation/collection code but disabling the output.</p>



<a name="529942930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20snapshot%20testing/near/529942930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing.html#529942930">(Jul 21 2025 at 18:11)</a>:</h4>
<p>I'm not fully satisfied with the current workflow/interface; suggestions welcome!</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
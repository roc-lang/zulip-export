<html>
<head><meta charset="utf-8"><title>glue improvements · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html">glue improvements</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="375626375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375626375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375626375">(Jul 15 2023 at 21:02)</a>:</h4>
<p>I've been working on some glue improvements, specifically having it generate glue for the user-defined effects in <code>hosted</code> modules - I have a <a href="https://github.com/roc-lang/roc/pull/5664">draft PR</a> for this, but it's giving:</p>
<blockquote>
<p>thread 'main' panicked at 'unspecialized lambda sets left over during resolution: LambdaSet([] + (&lt;475&gt;FlexAble(fmt, [<code>Encode.EncoderFormatting</code>]):<code>Encode.record</code>:1), ^&lt;473&gt;), UlsOfVar(VecMap { keys: [], values: [] })', crates/compiler/mono/src/layout.rs:1980:17</p>
</blockquote>
<p>this is for <code>$ cargo run -- glue crates/glue/src/RustGlue.roc glue-out examples/cli/cli-platform/main.roc</code> on that branch</p>



<a name="375626525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375626525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375626525">(Jul 15 2023 at 21:04)</a>:</h4>
<p>I'm assuming this is because of a combination of <a href="https://github.com/roc-lang/roc/pull/5664/files#diff-37a9508d25ec08eeb70c40673f91ec9c507c8ed20039e45aebc9df6e87c156afR2417">this change</a> and <a href="https://github.com/roc-lang/roc/pull/5664/files#diff-2c26c9585cb6db3d160cecbce28235589955317dc58c5c30e6306630a87501f7R393">this line</a> (I added the <code>.chain</code>)</p>



<a name="375626580"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375626580" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375626580">(Jul 15 2023 at 21:04)</a>:</h4>
<p>those <code>variables</code> have an interaction with lambda sets <a href="https://github.com/roc-lang/roc/blob/15788159b27769452c9d894bc3118f0f911f1358/crates/glue/src/load.rs#L412">a bit later on</a></p>



<a name="375626603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375626603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375626603">(Jul 15 2023 at 21:05)</a>:</h4>
<p>but I'm guessing maybe they need to be registered in some other way?</p>



<a name="375639956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375639956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375639956">(Jul 15 2023 at 23:33)</a>:</h4>
<p>Is this coming from when you try to generate the glue for a host-exposed lambda set? If so, this should be fine - it just means the lambda set is polymorphic, like the other polymorphic HELSs. I would probably add a flag to the layout generator to drop those unspecialized lambda sets for glue generation (or always drop them, but if that road is taken, let's add a debug flag that checks against this, since the assert is intended to catch bugs in specialization)</p>



<a name="375641028"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641028" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641028">(Jul 15 2023 at 23:47)</a>:</h4>
<p>oh hm, I hadn't even thought about where it was coming from</p>



<a name="375641047"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641047" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641047">(Jul 15 2023 at 23:47)</a>:</h4>
<p>I just tried it on <code>platform-cli</code> in <code>examples/</code> - I didn't even look at what it was trying to operate on</p>



<a name="375641118"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641118" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641118">(Jul 15 2023 at 23:48)</a>:</h4>
<p>but everything in <code>hosted</code> should need to be monomorphic, right?</p>



<a name="375641126"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641126" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641126">(Jul 15 2023 at 23:48)</a>:</h4>
<p>(I don't think we have a check for that yet though)</p>



<a name="375641141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641141">(Jul 15 2023 at 23:48)</a>:</h4>
<p>and if so, then shouldn't the lambda sets no longer be polymorphic?</p>



<a name="375641154"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641154" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641154">(Jul 15 2023 at 23:48)</a>:</h4>
<p>they should be monomorphic in the surface types, but the lambda sets can almost never be monomorphic</p>



<a name="375641169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641169">(Jul 15 2023 at 23:49)</a>:</h4>
<p>gotcha</p>



<a name="375641170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641170">(Jul 15 2023 at 23:49)</a>:</h4>
<p>hence the need for the host-exposed lambda set wrapper functions</p>



<a name="375641300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641300">(Jul 15 2023 at 23:51)</a>:</h4>
<p>one case is if the host-exposed main is something like</p>
<div class="codehilite"><pre><span></span><code>mainForHost : {} -&gt; (Int -&gt; Int)
</code></pre></div>
<p>The lambda set of the <code>Int -&gt; Int</code> is (very likely) only provided per-app, we don't know what lambda set to reference there when generating the glue</p>



<a name="375641318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641318">(Jul 15 2023 at 23:51)</a>:</h4>
<p>Folkert's numbering scheme should generate the right lambda set wrapper</p>



<a name="375641330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641330">(Jul 15 2023 at 23:51)</a>:</h4>
<p>we just need to tell the layout generator that it's okay for them to be unresolved as polymorphic for the purposes of glue</p>



<a name="375641832"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375641832" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375641832">(Jul 15 2023 at 23:58)</a>:</h4>
<p>hmmm ok, if I drop it (just disable that <code>debug_assert!</code> for now), I hit <a href="https://github.com/roc-lang/roc/blob/15788159b27769452c9d894bc3118f0f911f1358/crates/glue/src/types.rs#L1586">this <code>unreachable!</code></a> due to the builtin (!) Alias in question having a <code>name</code> of <code>Decode.0</code> and a repr of <code>LayoutRepr::Struct([])</code> <span aria-label="face with raised eyebrow" class="emoji emoji-1f928" role="img" title="face with raised eyebrow">:face_with_raised_eyebrow:</span></p>



<a name="375642074"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375642074" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375642074">(Jul 16 2023 at 00:00)</a>:</h4>
<p>that is <code>Decode.DecodeError</code>. seems like that pattern match should be expanded?</p>



<a name="375645028"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375645028" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375645028">(Jul 16 2023 at 00:28)</a>:</h4>
<p>hm, I don't follow <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="375645104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375645104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375645104">(Jul 16 2023 at 00:29)</a>:</h4>
<p>oh as in like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">LayoutRepr</span>::<span class="n">Struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Symbol</span>::<span class="n">DECODE_DECODE_ERROR</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>



<a name="375645972"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375645972" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375645972">(Jul 16 2023 at 00:36)</a>:</h4>
<p>ha, looks like we do have <em>some</em> amount of checking for this <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span> </p>
<blockquote>
<p>thread 'main' panicked at 'not yet implemented: TODO give a nice error message for a non-concrete type being passed to the host', crates/glue/src/types.rs:1386:13</p>
</blockquote>



<a name="375647023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375647023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375647023">(Jul 16 2023 at 00:45)</a>:</h4>
<p>guess it's time to improve that error message!</p>



<a name="375650260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375650260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375650260">(Jul 16 2023 at 01:10)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span>  I think probably the best way to go about that is to add an extra check after we've just solved all the types for a <code>hosted</code> module, while we still have all the <code>decls</code> in scope: traverse each of them, and if there are any unbound type variables in them, change the <code>Decl</code>'s type to <code>Erroneous</code> and report it</p>



<a name="375651813"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375651813" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375651813">(Jul 16 2023 at 01:24)</a>:</h4>
<p>hm, ok I added a text fixture with a couple of effects: <a href="https://github.com/roc-lang/roc/blob/acb1a5ac04077c4abdffb203bb79b8c8ccd393f6/crates/glue/tests/fixtures/basic-effects/Effect.roc">https://github.com/roc-lang/roc/blob/acb1a5ac04077c4abdffb203bb79b8c8ccd393f6/crates/glue/tests/fixtures/basic-effects/Effect.roc</a></p>
<p>now I'm running into this, though:</p>
<p><a href="https://github.com/roc-lang/roc/blob/15788159b27769452c9d894bc3118f0f911f1358/crates/compiler/mono/src/layout.rs#L2394">https://github.com/roc-lang/roc/blob/15788159b27769452c9d894bc3118f0f911f1358/crates/compiler/mono/src/layout.rs#L2394</a></p>



<a name="375651966"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375651966" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375651966">(Jul 16 2023 at 01:25)</a>:</h4>
<p>interestingly, it's only for the <code>getLine : Effect Str</code> though</p>



<a name="375651979"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375651979" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375651979">(Jul 16 2023 at 01:25)</a>:</h4>
<p>if I delete that one, <code>putLine : Str -&gt; Effect {}</code> works</p>



<a name="375652278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375652278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375652278">(Jul 16 2023 at 01:28)</a>:</h4>
<p>I would have guessed that it would be for the one with the actual function type, but I guess it's the wrapper?</p>



<a name="375660509"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375660509" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375660509">(Jul 16 2023 at 02:57)</a>:</h4>
<p>what is the backtrace? I guess that could happen if you’re asking to generate a RawFunctionLayout for a host exposed lambda sets</p>



<a name="375826693"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375826693" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375826693">(Jul 16 2023 at 19:36)</a>:</h4>
<p>update: <code>putLine : Str -&gt; Effect {}</code> <del>works</del> completes, but generates the wrong type <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="375826779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375826779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375826779">(Jul 16 2023 at 19:36)</a>:</h4>
<p>this is interesting...the <code>Content</code> of the type when I write it down is:</p>
<blockquote>
<p>[crates/compiler/load_internal/src/file.rs:2436] symbol = <code>Effect.putLine</code><br>
[crates/compiler/load_internal/src/file.rs:2473] f = "Func([&lt;1792&gt;Apply(<code>Str.Str</code>, []),], &lt;261=1801&gt;LambdaSet([<code>Effect.putLine</code> , ], ^&lt;1800&gt;), &lt;1793&gt;Opaque(<code>Effect.Effect</code>, [257, 256], &lt;259&gt;Func([&lt;1&gt;EmptyRecord,], &lt;249=69&gt;LambdaSet([<code>Effect.IdentId(20)</code> &lt;244&gt;Apply(<code>Str.Str</code>, []) , ], ^&lt;1796&gt;), &lt;257&gt;EmptyRecord)))"</p>
</blockquote>



<a name="375826822"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375826822" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375826822">(Jul 16 2023 at 19:36)</a>:</h4>
<p>that looks correct, because the signature in <code>Effect.roc</code> is:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">putLine</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Effect</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>



<a name="375826971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375826971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375826971">(Jul 16 2023 at 19:38)</a>:</h4>
<p>however, the generated glue is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">HostedFn</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">name</span>: <span class="s">"putLine"</span><span class="p">,</span>
<span class="w">        </span><span class="n">arg_types</span>: <span class="kp">&amp;</span><span class="p">[],</span>
<span class="w">        </span><span class="n">ret_type</span>: <span class="nc">R1</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Clone, Debug, PartialEq, PartialOrd, )]</span>
<span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">R1</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">rest</span>: <span class="nc">roc_std</span>::<span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">result</span>: <span class="nc">roc_std</span>::<span class="n">RocResult</span><span class="o">&lt;</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="375827108"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375827108" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375827108">(Jul 16 2023 at 19:39)</a>:</h4>
<p>so it thinks it's a thunk whose return value is what we generate for <code>Decode</code> on a <a href="https://github.com/roc-lang/roc/blob/06dbe06971d83d2dfe2c0061ab7f157a67229ed7/crates/compiler/derive/src/decoding/record.rs#L257C26-L257C26">record</a> or <a href="https://github.com/roc-lang/roc/blob/06dbe06971d83d2dfe2c0061ab7f157a67229ed7/crates/compiler/derive/src/decoding/tuple.rs#L259">tuple</a></p>



<a name="375840138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375840138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375840138">(Jul 16 2023 at 21:38)</a>:</h4>
<p>ok, the plot thickens:</p>
<ul>
<li>when I look up the <code>Content</code> in <code>solved_subs</code>, it's the above <code>Func</code> as expected</li>
<li>when I look up the same <code>Variable</code> (and <code>Symbol</code>) later on in <code>env.subs</code> in <code>glue</code>, it's a <code>Record</code> instead of a <code>Func</code> <span aria-label="face with raised eyebrow" class="emoji emoji-1f928" role="img" title="face with raised eyebrow">:face_with_raised_eyebrow:</span></li>
</ul>



<a name="375840244"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375840244" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375840244">(Jul 16 2023 at 21:39)</a>:</h4>
<p>so one guess at what's happening:</p>
<ul>
<li>the <code>Symbol</code> that's being recorded is global, so it's correct</li>
<li>the <code>Variable</code> that's being recorded is relative to the <code>Effect</code> module (and that module's <code>Subs</code>), whereas when I go to look it up later in <code>env.subs</code>, it's a different <code>Subs</code> (the one for the root module being used in <code>glue</code>), so the <code>Variable</code> is just referring to something totally different</li>
</ul>



<a name="375840406"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375840406" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375840406">(Jul 16 2023 at 21:41)</a>:</h4>
<p>if that is indeed what's happening, I guess a potential solution is to store the <code>Symbol</code> only and see if I can look up the appropriate <code>Variable</code> to use in the root module later?</p>



<a name="375840492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375840492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375840492">(Jul 16 2023 at 21:42)</a>:</h4>
<p>hm, but I don't have an easy way in glue to go from <code>Symbol</code> to <code>Variable</code> in the root module <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="375841099"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841099" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841099">(Jul 16 2023 at 21:49)</a>:</h4>
<p>like we have <code>exposed_vars_by_symbol: Vec&lt;(Symbol, Variable)&gt;</code> but these aren't exposed (at least not to the end user)</p>



<a name="375841223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841223">(Jul 16 2023 at 21:51)</a>:</h4>
<p>but it must be possible to look these up somehow, because mono has to do it in order to generate the externs for linking</p>



<a name="375841236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841236">(Jul 16 2023 at 21:51)</a>:</h4>
<p>like those need both the symbol and the appropriate <code>Variable</code> (or at least the solved type) at some point</p>



<a name="375841250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841250">(Jul 16 2023 at 21:51)</a>:</h4>
<p>anyone know how that works and how we might do the same thing for glue?</p>



<a name="375841387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841387">(Jul 16 2023 at 21:53)</a>:</h4>
<p>why is the solved_subs different from the env.subs in glue?</p>



<a name="375841405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841405">(Jul 16 2023 at 21:53)</a>:</h4>
<p>it's <code>solved_subs</code> for the <code>hosted</code> module</p>



<a name="375841425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841425">(Jul 16 2023 at 21:53)</a>:</h4>
<p>actually wait, is that true? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="375841432"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841432" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841432">(Jul 16 2023 at 21:53)</a>:</h4>
<p>or is <code>solved_subs</code> always for the root module</p>



<a name="375841526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841526">(Jul 16 2023 at 21:54)</a>:</h4>
<p>yeah no it's for the <code>hosted</code> module</p>



<a name="375841527"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841527" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841527">(Jul 16 2023 at 21:54)</a>:</h4>
<p>each module gets its own subs (and eventually a solved subs), so it depends where it's being referenced</p>



<a name="375841532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841532">(Jul 16 2023 at 21:54)</a>:</h4>
<p>I'm printing it out for <code>Msg::SolvedTypes</code></p>



<a name="375841544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841544">(Jul 16 2023 at 21:54)</a>:</h4>
<p>so yeah it's the per-module one</p>



<a name="375841573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841573">(Jul 16 2023 at 21:55)</a>:</h4>
<p>got it. why is glue not using that subs too then? I would assume you want to generate glue from the hosted module?</p>



<a name="375841801"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841801" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841801">(Jul 16 2023 at 21:58)</a>:</h4>
<p>yeah so the algorithm I'm using right now (which has the aforementioned issue) is:</p>
<ul>
<li>during module header parsing, when we encounter a <code>hosted</code> module, we add its <code>ModuleId</code> to <code>state.hosted_ids</code> for later (this part is fine)</li>
<li>then, when get a <code>Msg::SolvedTypes</code> for that module, we add all of the symbols in its <code>decls</code> to <code>state.hosted_vars_by_symbol: MutMap&lt;Symbol, Variable&gt;</code> - this is where we add the correct <code>Symbol</code>, but the <code>Variable</code> we have access to at this point is for the <code>hosted</code> module's <code>Subs</code> and not the root module's <code>Subs</code></li>
<li>that <code>state.hosted_vars_by_symbol</code> makes it into <code>LoadedModule</code>, which <code>glue</code> then uses - but although it has the correct <code>Symbol</code>s, it has the wrong <code>Variable</code>s</li>
</ul>



<a name="375841987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375841987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375841987">(Jul 16 2023 at 22:00)</a>:</h4>
<p>i see. I would add another subs, let’s call it H for now, alongside this hosted_vars_by_symbol object, and export the module’s variable from the module subs into H, and then work on H in glue</p>



<a name="375842017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375842017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375842017">(Jul 16 2023 at 22:00)</a>:</h4>
<p>cool, I like it! <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="375842059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375842059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375842059">(Jul 16 2023 at 22:01)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/3a934ba8d61c627de4d946768b3824ecf6f4e713/crates/compiler/types/src/subs.rs#L4592">https://github.com/roc-lang/roc/blob/3a934ba8d61c627de4d946768b3824ecf6f4e713/crates/compiler/types/src/subs.rs#L4592</a></p>



<a name="375842559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375842559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375842559">(Jul 16 2023 at 22:06)</a>:</h4>
<p>yeah but when would I call that? <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="375842704"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375842704" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375842704">(Jul 16 2023 at 22:08)</a>:</h4>
<p>can you do it during the time you add the mapping into state.hosted_vars_by_symbol?</p>



<a name="375842896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375842896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375842896">(Jul 16 2023 at 22:09)</a>:</h4>
<p>I think that would cause a race condition because <code>root_subs: Option&lt;Subs&gt;</code> might not be set yet</p>



<a name="375842985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375842985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375842985">(Jul 16 2023 at 22:10)</a>:</h4>
<p>but actually it turns out <code>module_cache</code> has <code>solved_subs</code> for each module</p>



<a name="375843378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375843378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375843378">(Jul 16 2023 at 22:14)</a>:</h4>
<p>yeah</p>



<a name="375843744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375843744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375843744">(Jul 16 2023 at 22:17)</a>:</h4>
<p>ok I think things will go best if I use <code>export_variable_to</code> - do I understand correctly that the returned <code>CopiedImport</code>'s <code>variable</code> field is the new <code>Variable</code> in the other <code>Subs</code>'s variable space?</p>



<a name="375844154"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375844154" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375844154">(Jul 16 2023 at 22:21)</a>:</h4>
<p>yes</p>



<a name="375844271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375844271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375844271">(Jul 16 2023 at 22:22)</a>:</h4>
<p>oh, it's on <code>StorageSubs</code> - I haven't worked with that before, what's the difference between it and <code>Subs</code>?</p>



<a name="375844941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375844941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375844941">(Jul 16 2023 at 22:29)</a>:</h4>
<p>they are basically the same, StorageSubs is a wrapper of Subs IIRC. it just has some extra methods bc it’s intended for cross-module storage</p>



<a name="375848367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375848367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375848367">(Jul 16 2023 at 23:05)</a>:</h4>
<p>ok, <code>module_cache.typechecked</code> entries get removed from the cache too soon for my purposes</p>



<a name="375848513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375848513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375848513">(Jul 16 2023 at 23:06)</a>:</h4>
<p>one potentially interesting option I just thought of: if <code>root_subs: Option&lt;Subs&gt;</code> is <code>None</code> when I want to add the hosted variables to it, just initialize it to empty and copy in the variables</p>



<a name="375848540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375848540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375848540">(Jul 16 2023 at 23:06)</a>:</h4>
<p>then later, when starting to work on the root module, use that as the starting point if it's set</p>



<a name="375848553"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375848553" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375848553">(Jul 16 2023 at 23:07)</a>:</h4>
<p>that way, whichever one gets to it first doesn't matter</p>



<a name="375851451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375851451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375851451">(Jul 16 2023 at 23:36)</a>:</h4>
<p>at that point might as well drop the <code>Option</code> I suppose, and always initialize it</p>



<a name="375864188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375864188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375864188">(Jul 17 2023 at 01:26)</a>:</h4>
<p>ok, got all that working, but now <a href="https://github.com/roc-lang/roc/blob/3a934ba8d61c627de4d946768b3824ecf6f4e713/crates/glue/src/types.rs#L1301">this</a> is blowing up because it has a return type of a FlexVar somehow <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="375864228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/glue%20improvements/near/375864228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/glue.20improvements.html#375864228">(Jul 17 2023 at 01:27)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Adding function type ret_type_id for RocFunction_1540...
[crates/glue/src/types.rs:1323] &amp;ret_layout = InLayout(VOID)
[crates/glue/src/types.rs:1324] types.get_type(lambda_set_type_id) = Unsized
[crates/glue/src/types.rs:1360] subs.get_content_without_compacting(var) = FlexVar(
    None,
)
thread &#39;main&#39; panicked at &#39;not yet implemented: TODO give a nice error message for a non-concrete type being passed to the host&#39;, crates/glue/src/types.rs:1365:13
</code></pre></div>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Decode ability for tagged union · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html">Decode ability for tagged union</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="490816439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816439">(Dec 25 2024 at 23:30)</a>:</h4>
<p>I'm assuming it's not possible to handle implement Decode for tagged unions without some form of a macro system.  Have there been any previous discussions of this? It does feel a bit incomplete for this to be missing</p>



<a name="490816537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816537">(Dec 25 2024 at 23:32)</a>:</h4>
<p>it's possible, we just haven't implemented it</p>



<a name="490816543"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816543" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816543">(Dec 25 2024 at 23:32)</a>:</h4>
<p>it shouldn't need a macro system</p>



<a name="490816556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816556">(Dec 25 2024 at 23:32)</a>:</h4>
<p>We haven't implemented it? I thought it already worked</p>



<a name="490816566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816566">(Dec 25 2024 at 23:32)</a>:</h4>
<p>Just isn't implemented for the JSON decoder</p>



<a name="490816586"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816586" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816586">(Dec 25 2024 at 23:33)</a>:</h4>
<p>I don't think we have it for Decoding</p>



<a name="490816592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816592">(Dec 25 2024 at 23:33)</a>:</h4>
<p>but I could be misremembering <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="490816607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816607">(Dec 25 2024 at 23:33)</a>:</h4>
<p>Oh... intriguing. I don't recall at this point. That said, we still plan to revamp the whole system.</p>



<a name="490816672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816672">(Dec 25 2024 at 23:34)</a>:</h4>
<p>But yeah, no macro system needed.</p>



<a name="490816692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816692">(Dec 25 2024 at 23:35)</a>:</h4>
<p>You have autoderive or a manual implementation. Either is fine.</p>



<a name="490816781"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816781" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816781">(Dec 25 2024 at 23:36)</a>:</h4>
<p>It's also missing from the Ability definition</p>



<a name="490816899"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816899" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816899">(Dec 25 2024 at 23:38)</a>:</h4>
<p>Ok</p>



<a name="490816920"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816920" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816920">(Dec 25 2024 at 23:39)</a>:</h4>
<p>Last I checked with the work to revamp decode, it was stuck on lambdaset bugs.</p>



<a name="490816930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490816930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490816930">(Dec 25 2024 at 23:39)</a>:</h4>
<p>But we should be able to add tag decoding directly to the old decode</p>



<a name="490817135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490817135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490817135">(Dec 25 2024 at 23:43)</a>:</h4>
<p>The compiler panics with</p>
<div class="codehilite"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at crates/compiler/mono/src/ir.rs:6257:10:
Ability specialization is unknown. Tip: check out &lt;https://roc.zulipchat.com/#na
rrow/stream/231634-beginners/topic/Non-Functions.20in.20Abilities/near/456068617
&gt;: DeriveError(Underivable)
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="490817443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490817443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490817443">(Dec 25 2024 at 23:49)</a>:</h4>
<p>I was trying out roc and decided to implement lamdera in roc by writing a platform but I've gotten stuck on sending messages over the wire.</p>



<a name="490817478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490817478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490817478">(Dec 25 2024 at 23:50)</a>:</h4>
<p>This is with a tag?</p>



<a name="490817535"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490817535" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490817535">(Dec 25 2024 at 23:50)</a>:</h4>
<p>Yes that is what happens with a tag<br>
There's a different but similar message for Opaque types too</p>



<a name="490817546"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490817546" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490817546">(Dec 25 2024 at 23:51)</a>:</h4>
<p>If so, we need to add tag decoding to the ability. Then we need to add autoderive for it in the compiler.</p>



<a name="490817562"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490817562" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490817562">(Dec 25 2024 at 23:51)</a>:</h4>
<p>Would be very similar to the autoderrive for encoding a tag</p>



<a name="490817820"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490817820" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490817820">(Dec 25 2024 at 23:56)</a>:</h4>
<p>Trying to decode with an opaque type errors with</p>
<div class="codehilite"><pre><span></span><code>An internal compiler expectation was broken.

This is definitely a compiler bug.

Please file an issue here: &lt;https://github.com/roc-lang/roc/issues/new/choose&gt;

expected to know a specialization for `17.IdentId(2)`#`13.IdentId(4)`, but it wasn&#39;t found

Location: crates/compiler/solve/src/specialize.rs:749:29
</code></pre></div>
<p>But my assumption is that this is intentional</p>



<a name="490818054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490818054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490818054">(Dec 26 2024 at 00:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union/near/490817562">said</a>:</p>
<blockquote>
<p>Would be very similar to the autoderrive for encoding a tag</p>
</blockquote>
<p>Should I create an issue for it? You mentioned that there is work to revamp the code<br>
I will take a look at the compiler and try to implement an autoderive.</p>



<a name="490988118"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/490988118" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#490988118">(Dec 27 2024 at 12:44)</a>:</h4>
<p>What is reasonable API for a tag method in the <code>DeocderFormatting</code> ability?</p>



<a name="491007489"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/491007489" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#491007489">(Dec 27 2024 at 16:22)</a>:</h4>
<p>With the current decode it should be very similar to a tuple. It should just decode a string tag name before decoding the tuple fields</p>



<a name="491008342"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/491008342" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#491008342">(Dec 27 2024 at 16:32)</a>:</h4>
<p>I assume something similar to record and tuple like<br>
<code>tuple : state, (state, Str -&gt; [Select (Decoder state fmt), Next]), (state -&gt; Result val DecodeError) -&gt; Decoder val fmt where fmt implements DecoderFormatting</code><br>
but the nested decoding requirements where each variant would then need to decode a variable number of fields does feel like it may require more information like the index of the current tuple field</p>



<a name="491009291"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Decode%20ability%20for%20tagged%20union/near/491009291" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Decode.20ability.20for.20tagged.20union.html#491009291">(Dec 27 2024 at 16:43)</a>:</h4>
<p>The alternative would just be push all of that to the state</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
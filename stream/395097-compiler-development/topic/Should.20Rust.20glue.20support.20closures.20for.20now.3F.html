<html>
<head><meta charset="utf-8"><title>Should Rust glue support closures for now? · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html">Should Rust glue support closures for now?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="492533923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492533923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven van Caem <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492533923">(Jan 08 2025 at 15:57)</a>:</h4>
<p>My rewrite of RustGlue.roc is nearing feature parity with old Rust glue (only missing NullableUnwrapped tag unions and closures). I heard closures exposed to the platform are soon to become type-erased closures, which would simplify its glue code a lot (I'm not even sure the glue platform supplies enough information to correctly generate glue code for them at the moment). Would it be better to leave closures unimplemented for now until those changes hit?</p>



<a name="492536230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492536230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492536230">(Jan 08 2025 at 16:09)</a>:</h4>
<blockquote>
<p>My rewrite of RustGlue.roc is nearing feature parity with old Rust glue</p>
</blockquote>
<p>Awesome :)</p>



<a name="492536264"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492536264" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492536264">(Jan 08 2025 at 16:09)</a>:</h4>
<blockquote>
<p>I heard closures exposed to the platform are soon to become type-erased closures</p>
</blockquote>
<p>Can you link to that?</p>



<a name="492536890"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492536890" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven van Caem <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492536890">(Jan 08 2025 at 16:12)</a>:</h4>
<p>I remember <span class="user-mention" data-user-id="515757">@Luke Boswell</span> mentioning it a while back in dms, I'll see if I can find anything</p>



<a name="492537739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492537739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven van Caem <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492537739">(Jan 08 2025 at 16:17)</a>:</h4>
<p>Hm, I'm only finding talk of replacing lambda sets with erased closures entirely (before ayaz cracked lambda sets and that plan was reverted). Perhaps a misunderstanding on my part then</p>



<a name="492538375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492538375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492538375">(Jan 08 2025 at 16:21)</a>:</h4>
<p>This idea from <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> may alter things though: <a href="#narrow/channel/316715-contributing/topic/projects/near/491614327">https://roc.zulipchat.com/#narrow/channel/316715-contributing/topic/projects/near/491614327</a></p>



<a name="492539189"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492539189" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven van Caem <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492539189">(Jan 08 2025 at 16:25)</a>:</h4>
<p>It does sound like it yeah!</p>



<a name="492539305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492539305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven van Caem <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492539305">(Jan 08 2025 at 16:26)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> maybe you could weigh in on this? <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="492542194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492542194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492542194">(Jan 08 2025 at 16:42)</a>:</h4>
<p>See <a href="https://github.com/roc-lang/roc/issues/6985">https://github.com/roc-lang/roc/issues/6985</a></p>
<p>We needed type erasure for <code>Task.map2</code>... which I assume may no longer be require with purity inference??</p>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> do we still need type erasure? It's also the only way to pass functions over the host boundary I thought.</p>



<a name="492542540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492542540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492542540">(Jan 08 2025 at 16:44)</a>:</h4>
<p>I wonder why that would be the case?  Wouldn't we really only need that for application-defined types?</p>



<a name="492542635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492542635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492542635">(Jan 08 2025 at 16:44)</a>:</h4>
<p>Like generics would need to be type-erased sure</p>



<a name="492542688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492542688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492542688">(Jan 08 2025 at 16:45)</a>:</h4>
<p>But I wouldn't think a <code>Str =&gt; {}</code> would need that</p>



<a name="492546619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492546619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492546619">(Jan 08 2025 at 16:57)</a>:</h4>
<p>I don't think the glue revamp really affects this. At least not now. Long term, we will need to expose roc c abi functions to increase the refcounts of closure captures. I'm not sure if we need to expose anything to call the closure. Oh actually I think we plan to box the closures. That may actually simplify things and mean their refcounting works the same as box</p>



<a name="492548208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492548208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492548208">(Jan 08 2025 at 17:03)</a>:</h4>
<p>I think type erasure would only be needed if we want many different shaped functions to fit in the same shaped hole.</p>
<p>I think this would be equally needed/equally not needed in the purity inference world.</p>
<p>We still want a map2 shaped solution to enable parallel execution (though I guess we could do a more raw thread style solution). Also, given results are not lazy like task, it definitely has to be shaped differently. For that to work, either we need type erasure, we need to box all the inputs and outputs, or we need to make the parallel executions all be <code>{} =&gt; {}</code> (only inputs are captures and outputs have to be through channels or some other mechanism).</p>



<a name="492548598"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492548598" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492548598">(Jan 08 2025 at 17:05)</a>:</h4>
<p>I guess that PI, kinda leans us towards a go style solution. Threads and channels with minimal extra orchestration.</p>



<a name="492548719"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492548719" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492548719">(Jan 08 2025 at 17:06)</a>:</h4>
<p>That would not need type erasure.</p>



<a name="492548772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492548772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492548772">(Jan 08 2025 at 17:06)</a>:</h4>
<p>Still needs the ability to call closures.</p>



<a name="492548814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492548814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492548814">(Jan 08 2025 at 17:06)</a>:</h4>
<p>And refcount them</p>



<a name="492568178"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492568178" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492568178">(Jan 08 2025 at 19:10)</a>:</h4>
<p>I still kinda own type erasure, but I'm trying to prioritize the re-canning work for now. Once we have the new compiler pipeline at least mostly ready, I can coordinate with Ayaz to see how accurate the plan in his <a href="https://github.com/roc-lang/rfcs/blob/main/0012-type-erasure.md">type erasure proposal</a> is for implementation, and then jump on that if we need it</p>



<a name="492569637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492569637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sven van Caem <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492569637">(Jan 08 2025 at 19:20)</a>:</h4>
<p>It sounds like the current approach to exposing Roc closures to the platform will stay the same, at least for the foreseeable future? If so, I'll see if I can make any headway improving rust glue's support for them.</p>



<a name="492585759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492585759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492585759">(Jan 08 2025 at 21:16)</a>:</h4>
<p>Yeah</p>



<a name="492594174"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492594174" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492594174">(Jan 08 2025 at 22:31)</a>:</h4>
<p>Can someone help me update the issue please? <a href="https://github.com/roc-lang/roc/issues/6985">https://github.com/roc-lang/roc/issues/6985</a></p>



<a name="492594264"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492594264" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492594264">(Jan 08 2025 at 22:32)</a>:</h4>
<p>If we no longer need it, then it'd be good to add the context and close. Or maybe state that it needs further design review/discussion and we can close and make a new one in future.</p>



<a name="492595859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Should%20Rust%20glue%20support%20closures%20for%20now%3F/near/492595859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Should.20Rust.20glue.20support.20closures.20for.20now.3F.html#492595859">(Jan 08 2025 at 22:46)</a>:</h4>
<p>Yeah, I think it needs further discussion. Really depends how roc decides to support concurrency in the future. There are paths that don't need it, but it is unclear what path will be recommended.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>remove expect in can · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html">remove expect in can</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="488528927"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488528927" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488528927">(Dec 12 2024 at 00:29)</a>:</h4>
<p>Currently when we have an expect, it isn't removed until all the way after mono. This has the annoying issue that the expect and conditional are separate code by that point. As such, the conditional still runs no matter what. This is clearly a waste of perf and unintended behaviour. On top of that, we eventually want to have the dev backend and wasm backend generating expects. As such, addition or removal of expects should be higher up in compilation process instead of in each individual backend.</p>
<p>My gut feeling as that it should get removed in can around the time we desugar (maybe as part of desaguring). Anyone have other thoughts/opinions? Also, what is the best way to map a single boolean of information from the cli all the way down into can. Feels like this should be easy to do, but I think we may have multiple levels of indirection that make this quite inconvenient to do. Any tips or folks that want to take this on?</p>



<a name="488555486"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555486" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555486">(Dec 12 2024 at 05:31)</a>:</h4>
<p>I don't think we'll be able to remove at least top-level <code>expect</code> until after type constraining because <code>expect</code> will probably be allowed to have bodies with different rules than any other expression.</p>



<a name="488555583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555583">(Dec 12 2024 at 05:32)</a>:</h4>
<p>As discussed in the <a href="#narrow/channel/304641-ideas/topic/top.20level.20.3F.20try/near/472996399">top level ? try</a> topic, we want expect to allow top-level <code>try</code> usage.</p>



<a name="488555615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555615">(Dec 12 2024 at 05:32)</a>:</h4>
<p>This only needs to be for the inline expects</p>



<a name="488555651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555651">(Dec 12 2024 at 05:33)</a>:</h4>
<p>Guess I missed clarifying that</p>



<a name="488555657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555657">(Dec 12 2024 at 05:33)</a>:</h4>
<p>Currently top level expects are properly elided (though through a different mechanism)</p>



<a name="488555676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555676">(Dec 12 2024 at 05:33)</a>:</h4>
<p>Okay, good thing I didn't type everything in one big message.</p>



<a name="488555685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555685">(Dec 12 2024 at 05:33)</a>:</h4>
<p>Saved us both some time</p>



<a name="488555781"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555781" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555781">(Dec 12 2024 at 05:34)</a>:</h4>
<p>We'll still want to give proper type errors when inline expect is used incorrectly</p>



<a name="488555804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555804">(Dec 12 2024 at 05:35)</a>:</h4>
<p>Let's say we desugar inline expect to something like:</p>



<a name="488555849"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555849" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555849">(Dec 12 2024 at 05:35)</a>:</h4>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="p">{}</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nv">condition</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="nv">dbg</span><span class="w"> </span><span class="p">(</span><span class="nv">condition</span><span class="p">,</span><span class="w"> </span><span class="s">"condition failed"</span><span class="p">)</span>
</code></pre></div>



<a name="488555924"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555924" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555924">(Dec 12 2024 at 05:36)</a>:</h4>
<p>Not sure what to put for the <code>else</code> branch, it doesn't matter as much</p>



<a name="488555968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488555968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488555968">(Dec 12 2024 at 05:36)</a>:</h4>
<p>If <code>condition</code> is not a <code>Bool</code>, then we want to be able to say "inline expects only work with Bool values"</p>



<a name="488556041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556041">(Dec 12 2024 at 05:37)</a>:</h4>
<p>I might be misunderstanding something, let me re-read your message again</p>



<a name="488556176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556176">(Dec 12 2024 at 05:39)</a>:</h4>
<blockquote>
<p>As such, addition or removal of expects should be higher up in compilation process instead of in each individual backend.</p>
</blockquote>
<p>This seems like your real goal, to not run the expect's condition if you're trying to optimize the expect away</p>



<a name="488556204"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556204" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556204">(Dec 12 2024 at 05:39)</a>:</h4>
<p>So we essentially desugar to that. The issue is that it ends up becoming:</p>
<div class="codehilite"><pre><span></span><code>condition = # some expensive computation
{} = if condition then {} else dbg (condition, &quot;condition failed&quot;)
</code></pre></div>
<p>We then skip emitting the expect and emit this:</p>
<div class="codehilite"><pre><span></span><code>condition = # some expensive computation
</code></pre></div>



<a name="488556269"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556269" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556269">(Dec 12 2024 at 05:40)</a>:</h4>
<p>I understand now</p>



<a name="488556344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556344">(Dec 12 2024 at 05:41)</a>:</h4>
<p>Sometimes llvm optimizes that away. A lot of the time we touch memory or call a zig builtin and llvm gives up.</p>



<a name="488556373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556373">(Dec 12 2024 at 05:41)</a>:</h4>
<p>Not surprising</p>



<a name="488556492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556492">(Dec 12 2024 at 05:42)</a>:</h4>
<p>I'm looking through the <code>roc_can</code> to see what we currently represent <code>expect</code> as</p>



<a name="488556536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556536">(Dec 12 2024 at 05:43)</a>:</h4>
<p>I think it is just a statement at that level</p>



<a name="488556638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556638">(Dec 12 2024 at 05:44)</a>:</h4>
<p>But it seems like we'd just want to pass an <code>ignore_expects</code> flag to mono and delete inline <code>expect</code>s in <a href="https://github.com/roc-lang/roc/blob/7495495800eb18c5fbd66e41850b3f5fa5a42fcf/crates/compiler/mono/src/ir.rs#L4280">with_hole</a>?</p>



<a name="488556697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556697">(Dec 12 2024 at 05:44)</a>:</h4>
<p>By mono, the condition is a separate statement and expect just holds a symbol to load</p>



<a name="488556733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556733">(Dec 12 2024 at 05:45)</a>:</h4>
<p>That's surprising, but I believe you</p>



<a name="488556751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556751">(Dec 12 2024 at 05:45)</a>:</h4>
<p>I could be wrong, but that is what it looked like to me</p>



<a name="488556763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556763">(Dec 12 2024 at 05:45)</a>:</h4>
<p>I'm checking</p>



<a name="488556872"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556872" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556872">(Dec 12 2024 at 05:46)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/7495495800eb18c5fbd66e41850b3f5fa5a42fcf/crates/compiler/mono/src/ir.rs#L7112">https://github.com/roc-lang/roc/blob/7495495800eb18c5fbd66e41850b3f5fa5a42fcf/crates/compiler/mono/src/ir.rs#L7112</a></p>



<a name="488556936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488556936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488556936">(Dec 12 2024 at 05:47)</a>:</h4>
<p>So on this line, when we see an <code>expect</code>, it's represented as:</p>
<ul>
<li>the condition's <code>roc_can</code> expression</li>
<li>the rest of the body's <code>roc_can</code> expression</li>
<li>the variables to display when the expect fails</li>
</ul>



<a name="488557018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557018">(Dec 12 2024 at 05:48)</a>:</h4>
<p>This match branch is where the statements are created</p>



<a name="488557039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557039">(Dec 12 2024 at 05:48)</a>:</h4>
<p>So this is the last place to cut everything off in one place instead of having split statements</p>



<a name="488557054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557054">(Dec 12 2024 at 05:48)</a>:</h4>
<p>Yep</p>



<a name="488557063"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557063" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557063">(Dec 12 2024 at 05:48)</a>:</h4>
<p>But I'm not sure where to cut it off before this.</p>



<a name="488557092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557092">(Dec 12 2024 at 05:49)</a>:</h4>
<p>In the pipeline, we've got</p>
<ul>
<li>parse</li>
<li>canonicalize</li>
<li>type check</li>
<li>specialize</li>
<li>codegen</li>
</ul>



<a name="488557110"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557110" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557110">(Dec 12 2024 at 05:49)</a>:</h4>
<p>We need to type check, and then right after that this is what's called</p>



<a name="488557126"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557126" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557126">(Dec 12 2024 at 05:49)</a>:</h4>
<p>So it seems like the right move is to chop it off here</p>



<a name="488557130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557130">(Dec 12 2024 at 05:49)</a>:</h4>
<p>I just think it should be before codegen. Cause backends should not need to decide to elide expects</p>



<a name="488557196"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557196" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557196">(Dec 12 2024 at 05:50)</a>:</h4>
<p>So right at conversion from can to mono. That sounds fine</p>



<a name="488557226"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557226" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557226">(Dec 12 2024 at 05:50)</a>:</h4>
<p>Just need to pipeline the right info here</p>



<a name="488557228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557228">(Dec 12 2024 at 05:50)</a>:</h4>
<p>I agree that <code>monomorphization</code> doesn't mean "specialize AND ALSO delete expects if this flag was passed"</p>



<a name="488557267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557267">(Dec 12 2024 at 05:51)</a>:</h4>
<p>Would you be happy with adding a 4th field to the <code>Expr::Expect</code> that's called <code>ignored</code>?</p>



<a name="488557292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557292">(Dec 12 2024 at 05:51)</a>:</h4>
<p>I feel like this should be part of the environment or similar. It will be one value for all expects</p>



<a name="488557324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557324">(Dec 12 2024 at 05:52)</a>:</h4>
<p>Which feels like we're still having mono do the work of deleting dead code, but then it's not reading from the environment</p>



<a name="488557360"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557360" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557360">(Dec 12 2024 at 05:52)</a>:</h4>
<p>What you just suggested would be my actual vote</p>



<a name="488557395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557395">(Dec 12 2024 at 05:52)</a>:</h4>
<p>My most recent suggestion is a way to avoid having mono need to be "directly" compiler flag-aware</p>



<a name="488557520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557520">(Dec 12 2024 at 05:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/remove.20expect.20in.20can/near/488557196">said</a>:</p>
<blockquote>
<p>So right at conversion from can to mono. That sounds fine</p>
</blockquote>
<p>Oh, I see that we're in agreement</p>



<a name="488557541"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557541" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557541">(Dec 12 2024 at 05:54)</a>:</h4>
<p>I'll make an issue?</p>



<a name="488557621"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557621" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557621">(Dec 12 2024 at 05:55)</a>:</h4>
<p>Also, just to clarify, I'm just being pragmatic. It needs to be somewhere before mono. Probably should be after type checking so that types won't change between debug and release due to removing expects.</p>



<a name="488557696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557696">(Dec 12 2024 at 05:56)</a>:</h4>
<p>We'd need some other compiler phase to do that</p>



<a name="488557697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557697">(Dec 12 2024 at 05:56)</a>:</h4>
<p>And I just think we need to get a bool there somehow (may want to make the bool a two element enum, but same idea)</p>



<a name="488557721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557721">(Dec 12 2024 at 05:56)</a>:</h4>
<p>oh, is type check on mono?</p>



<a name="488557739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557739">(Dec 12 2024 at 05:57)</a>:</h4>
<p>I really don't know these parts of the compiler</p>



<a name="488557778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557778">(Dec 12 2024 at 05:57)</a>:</h4>
<p>I thought mono was after unification and was just about generating many specializations, but that is probably wrong?</p>



<a name="488557910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557910">(Dec 12 2024 at 05:58)</a>:</h4>
<p>To my understanding:</p>
<ul>
<li>canonicalization is the last place we reorder/add/remove AST nodes and set warnings</li>
<li>type checking just determines the type of each AST node and saves those types in the relevant type variables, no AST changes are made</li>
<li>mono converts to mono IR from the same AST created after canonicalization and uses the type-checked type variables to determine layout for symbols</li>
</ul>



<a name="488557966"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557966" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557966">(Dec 12 2024 at 05:59)</a>:</h4>
<p>If we do it in canonicalization, we can't do type-checking (unless we added a <code>UselessExpect</code> ast node, type checked it just like inline expects, and then ignored in in mono)</p>



<a name="488557977"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488557977" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488557977">(Dec 12 2024 at 05:59)</a>:</h4>
<p>We can't remove anything during typechecking</p>



<a name="488558058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558058">(Dec 12 2024 at 06:00)</a>:</h4>
<p>So this is literally the first <em>and</em> last place to do it</p>



<a name="488558141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558141">(Dec 12 2024 at 06:00)</a>:</h4>
<p>That said, we will eventually need something that does inlining and constant evaluation</p>



<a name="488558227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558227">(Dec 12 2024 at 06:01)</a>:</h4>
<p>That compiler phase could also decide to remove dbg's and expect's</p>



<a name="488558262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558262">(Dec 12 2024 at 06:01)</a>:</h4>
<p>Theoretically, you could remove it all the way at the top of canonicalization.</p>



<a name="488558297"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558297" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558297">(Dec 12 2024 at 06:01)</a>:</h4>
<blockquote>
<p>inlining and constant evaluation</p>
</blockquote>
<p>I think that is expected to run on mono right before the backends run</p>



<a name="488558302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558302">(Dec 12 2024 at 06:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/channel/395097-compiler-development/topic/remove.20expect.20in.20can/near/488557966">said</a>:</p>
<blockquote>
<p>If we do it in canonicalization, we can't do type-checking (unless we added a <code>UselessExpect</code> ast node, type checked it just like inline expects, and then ignored in in mono)</p>
</blockquote>
<p>Sounds like you'd like something like this?</p>



<a name="488558419"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558419" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558419">(Dec 12 2024 at 06:02)</a>:</h4>
<p>Actually, as I am thinking about this more, I think we should remove it before typechecking and allow the type to change</p>



<a name="488558421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558421">(Dec 12 2024 at 06:02)</a>:</h4>
<p>A better name would be <code>IgnoredExpect</code> or something like that</p>



<a name="488558479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558479">(Dec 12 2024 at 06:03)</a>:</h4>
<p>I think the type will almost never change, but if it does, it should be a compiler optimization due to removing an unnecessary constraint.</p>



<a name="488558579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558579">(Dec 12 2024 at 06:04)</a>:</h4>
<p>eh, but that mean if you always build with <code>--optimize</code> and then remove that flag at some point, you code my suddenly have a type error... so nvm to the above idea</p>



<a name="488558668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558668">(Dec 12 2024 at 06:05)</a>:</h4>
<p>I guess another option is to put a pass after mono that deletes expects along with the node that generates their conditionals.</p>



<a name="488558754"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558754" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558754">(Dec 12 2024 at 06:06)</a>:</h4>
<p>but that just feels like extra hassle</p>



<a name="488558760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558760">(Dec 12 2024 at 06:06)</a>:</h4>
<p>The long term with canonicalization is to cache some artifact that is parsed, canonicalized, and partially typecheck in a way that doesn't ever need to be recalculated unless there are code changes or you use a different Roc version</p>



<a name="488558868"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558868" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558868">(Dec 12 2024 at 06:07)</a>:</h4>
<p>I see the more-than-single responsibility aspect of <code>mono</code> as a performance optimization. We don't to read over the entire AST 40 times, this seems like an unfortunate side effect of that</p>



<a name="488558934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488558934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488558934">(Dec 12 2024 at 06:08)</a>:</h4>
<p>But we can add a TODO or something that says if we add such a compiler pass, we can move this conditional deletion of inline expects to that pass</p>



<a name="488560625"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488560625" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488560625">(Dec 12 2024 at 06:25)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/issues/7348">https://github.com/roc-lang/roc/issues/7348</a></p>



<a name="488563394"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488563394" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488563394">(Dec 12 2024 at 06:53)</a>:</h4>
<p>as it happens, <span class="user-mention" data-user-id="489294">@Agus Zubiaga</span> and I have been working on just such a pass for lambda sets! <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="488563463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488563463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488563463">(Dec 12 2024 at 06:53)</a>:</h4>
<p>so yeah we can make sure to drop inline <code>expect</code> (when it's an optimized build) when we convert from canonical IR to the new IR that we're working on that will later get turned into our current <code>mono</code> IR</p>



<a name="488568340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/remove%20expect%20in%20can/near/488568340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/remove.20expect.20in.20can.html#488568340">(Dec 12 2024 at 07:35)</a>:</h4>
<p>i wonder if there’s an easier method to this - for example, what if you desugared the entire expect call to a closure and called that at the expect site? for example</p>
<p>expect foo == bar</p>
<p>becomes</p>
<p>#call_expect expect_1 {..closure data}</p>
<p>expect_1 = \{..locals} -&gt; expect foo == bar</p>
<p>Now it is trivial to remove the #call_expect calls in prod build and the rest is DCEd</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
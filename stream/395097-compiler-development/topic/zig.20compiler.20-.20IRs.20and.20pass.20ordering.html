<html>
<head><meta charset="utf-8"><title>zig compiler - IRs and pass ordering · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html">zig compiler - IRs and pass ordering</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="497212139"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212139" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212139">(Feb 02 2025 at 00:44)</a>:</h4>
<p>Are all of those IRs separate data structures? Many (especially in the build phase) Feel like they should be the same IR just with multiple passes running on it.</p>



<a name="497212281"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212281" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212281">(Feb 02 2025 at 00:46)</a>:</h4>
<p>Also, I feel like adding in reference counting is likely too late in the pipeline. The interpreter will need to run reference counting. So likely we will want refcounting right after check phase and to the interpreter run on the refcounted IR, but maybe I am missing something with the dependencies here.</p>



<a name="497212380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212380">(Feb 02 2025 at 00:48)</a>:</h4>
<p>I also definitely think we should think more about the build phase pass ordering. What would lead to the simplest implementation.</p>



<a name="497212647"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212647" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212647">(Feb 02 2025 at 00:53)</a>:</h4>
<p>I think the interpreter would do its own runtime reference counting</p>



<a name="497212651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212651">(Feb 02 2025 at 00:53)</a>:</h4>
<p>separate system</p>



<a name="497212717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212717">(Feb 02 2025 at 00:54)</a>:</h4>
<p>Sure, but it still needs to know when to check reference counts, right? Like it needs to know when calling a function that the function requires incrementing the reference count of the 3rd arg passed in.</p>



<a name="497212747"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212747" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212747">(Feb 02 2025 at 00:55)</a>:</h4>
<p>Though I guess that probably can still be figured out at runtime. Hmm.</p>



<a name="497212764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497212764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497212764">(Feb 02 2025 at 00:55)</a>:</h4>
<p>That stage has a big question mark around it. Sam mentioned it's something he was really unsure about what it does or where it should go.</p>



<a name="497213039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497213039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497213039">(Feb 02 2025 at 01:00)</a>:</h4>
<p>I see it as a few different pieces:</p>
<ol>
<li>You have inserting refcount increments and decrements based on lifetimes</li>
<li>You have optimizations like drop specialization to remove a ton of refcounting changes by realizing when records or containers go out of scope but some of their elements stick around (like record destructuring).</li>
<li>You have morphic which we don't plan to port and don't need to worry about for now, but can statically recognize uniqueness for mutation purposes.</li>
<li>You have borrow inference which is super important for hot loop perf and allows avoiding refcounts if a function argument is only ever read from and never potentially mutated (currently only works for lists, but theoretically would be more powerful if it understands aggregates).</li>
<li>Finally, you have actually generation of code that knows how to perform a refcount. For example, you have to know how to recursively decrement refcounts of complex datastructures. This makes code gen a lot simpler cause code gen no longer has to understand how to refcount types.</li>
</ol>



<a name="497213185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497213185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497213185">(Feb 02 2025 at 01:03)</a>:</h4>
<p>also, I'm definitely keen to help port and work on a lot of this backend stuff and our new wiring to llvm. I feel like I have a solid bar on many things after specialization (Though I have not actually looked into the algorithm for drop specialization).</p>
<p>The nice thing with most of theses passes is that they are optional. So In the list above, you would start by porting just 1 and 5. Later 2, 3, and 4 can be added in.</p>



<a name="497216398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497216398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497216398">(Feb 02 2025 at 01:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497212747">said</a>:</p>
<blockquote>
<p>Though I guess that probably can still be figured out at runtime. Hmm.</p>
</blockquote>
<p>yeah, for example Python does automatic reference counting fully at runtime</p>



<a name="497236291"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497236291" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497236291">(Feb 02 2025 at 07:33)</a>:</h4>
<p>As a note, I realized I missed reset reuse which is also refcounting related. Lots of optimizations passes to eventually add but that I don't think are fundamentally needed.</p>
<p>Oh, as another note talking of irs. Sharing irs between multiple passes means you can turn off passes or implement new passes without changing API boundaries significantly.</p>



<a name="497242823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497242823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497242823">(Feb 02 2025 at 09:25)</a>:</h4>
<p>You're right. However, it's easier to ensure correctness when we have the shape of the IRs constrained to what each phase can actually use and actually produce. Less of a need to say "I shouldn't have a function, save a compiler problem to a big list."</p>



<a name="497242843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497242843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497242843">(Feb 02 2025 at 09:25)</a>:</h4>
<p>It's prioritizing correctness over performance</p>



<a name="497242855"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497242855" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497242855">(Feb 02 2025 at 09:25)</a>:</h4>
<p>It really won't be that hard to change later</p>



<a name="497271896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497271896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497271896">(Feb 02 2025 at 16:47)</a>:</h4>
<p>I think adding 10 to 20 clones of the ir for all the phases is still a mistake either way. And I don't think it helps correctness in many cases</p>



<a name="497272032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272032">(Feb 02 2025 at 16:49)</a>:</h4>
<p>As a first note, any pass that is optional, if it can avoid changing to a new IR, that really helps test correctness. It makes it easy to toggle any off, which is huge for debugging correctness.</p>



<a name="497272069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272069">(Feb 02 2025 at 16:50)</a>:</h4>
<p>I'm pretty sure <span class="user-mention" data-user-id="453336">@Joshua Warner</span> was running into multiple "this should have been desugared" errors while getting fuzzing up to speed</p>



<a name="497272128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272128">(Feb 02 2025 at 16:50)</a>:</h4>
<p>We can assume testing will catch these things, but I'd always rather trust types than tests</p>



<a name="497272132"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272132" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272132">(Feb 02 2025 at 16:50)</a>:</h4>
<p>On top of that some passes like lifting lambdas really should not change the ir. It will be easier to move a few nodes around then make an entire new ir.</p>



<a name="497272158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272158">(Feb 02 2025 at 16:51)</a>:</h4>
<p>And Ayaz keeps iterating that IR translation costs basically nothing compared to algorithmic costs like specialization</p>



<a name="497272194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272194">(Feb 02 2025 at 16:52)</a>:</h4>
<p>Sure, but even ignoring the compile time cost, I think it hurts correctness for many phases (especially optimization phases that are optional)</p>



<a name="497272250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272250">(Feb 02 2025 at 16:52)</a>:</h4>
<p>I don't understand how correctness could be hurt</p>



<a name="497272266"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272266" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272266">(Feb 02 2025 at 16:52)</a>:</h4>
<p>Cause you lose the ability to turn off a pass. It is now always required due to creating a new IR.</p>



<a name="497272345"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272345" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272345">(Feb 02 2025 at 16:53)</a>:</h4>
<p>I don't think any of our passes besides maybe refcounting and maaaaybeee lower_ir could be turned off</p>



<a name="497272431"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272431" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272431">(Feb 02 2025 at 16:54)</a>:</h4>
<p>reset reuse, drop specialization, borrow inference, morphic (if we ever re-add it), any other future optimization</p>



<a name="497272440"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272440" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272440">(Feb 02 2025 at 16:54)</a>:</h4>
<p>Oh, those, sure</p>



<a name="497272447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272447">(Feb 02 2025 at 16:54)</a>:</h4>
<p>Those aren't in the preliminary design</p>



<a name="497272466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272466">(Feb 02 2025 at 16:55)</a>:</h4>
<p>The 9 in the preliminary design are all required</p>



<a name="497272485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272485">(Feb 02 2025 at 16:55)</a>:</h4>
<p>Everything past that could get away with reuse</p>



<a name="497272513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272513">(Feb 02 2025 at 16:55)</a>:</h4>
<p>Ah, ok, then quite possibly it is fine.</p>



<a name="497272571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272571">(Feb 02 2025 at 16:56)</a>:</h4>
<p>What are the difference in the middle IRs? like lift functions?</p>



<a name="497272581"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272581" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272581">(Feb 02 2025 at 16:56)</a>:</h4>
<p>The 9 I'm thinking about are:</p>
<ul>
<li>parse</li>
<li>canonicalize (now has type ids, interned values)</li>
<li>resolve imports (reused for typechecking) (any "delayed import" values are resolved to the actual values)</li>
<li>specialize types (no more generic types anywhere, so normal type vars are gone)</li>
<li>lift functions (lambdas should no longer exist in the code)</li>
<li>solve functions (all higher-order function arguments need to be generic)</li>
<li>specialize functions (no more higher-order functions anywhere)</li>
<li>lower IR (converted to statements, refcounting shouldn't exist yet)</li>
<li>refcount (refcounts added)</li>
</ul>



<a name="497272599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272599">(Feb 02 2025 at 16:56)</a>:</h4>
<p>I'll edit that message to talk about structural differences</p>



<a name="497272748"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272748" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272748">(Feb 02 2025 at 16:58)</a>:</h4>
<p>yes, please do, I would like to understand</p>



<a name="497272749"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272749" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272749">(Feb 02 2025 at 16:58)</a>:</h4>
<p>done</p>



<a name="497272764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272764">(Feb 02 2025 at 16:59)</a>:</h4>
<p>Very terse descriptions, let me know what needs explaining</p>



<a name="497272792"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272792" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272792">(Feb 02 2025 at 16:59)</a>:</h4>
<p>The only one we might consider is solve functions, but that's playing with fire a little bit</p>



<a name="497272886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272886">(Feb 02 2025 at 17:00)</a>:</h4>
<blockquote>
<p>resolve imports (reused for typechecking) (any "delayed import" values are resolved to the actual values)</p>
</blockquote>
<p>Why is this an entire new IR and not just making a new dictionary of resolved imports or editting all import nodes and then banning the old type of import node?  What does a new IR help with?</p>



<a name="497272900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497272900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497272900">(Feb 02 2025 at 17:00)</a>:</h4>
<p>just one example</p>



<a name="497273149"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273149" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273149">(Feb 02 2025 at 17:04)</a>:</h4>
<p>As a relative percentage, like 90%+ of the IR is shared</p>



<a name="497273184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273184">(Feb 02 2025 at 17:05)</a>:</h4>
<p>yeah, so why make a new IR instead of just making a verifier that the old node type is gone/banned. That is exceptionally easy to fuzz/test correct</p>



<a name="497273605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273605">(Feb 02 2025 at 17:10)</a>:</h4>
<p>Yeah, some passes seem to just return subsets of the previous IRs instead of changing the fundamental shape of them</p>



<a name="497273788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273788">(Feb 02 2025 at 17:13)</a>:</h4>
<p><span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> it's a question of trust. Not that big a deal either way</p>



<a name="497273836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273836">(Feb 02 2025 at 17:14)</a>:</h4>
<p>For context, I am not against spinning up new IRs, I have worked with mlir professionally, and it is made to make making new IRs super easy. In practice, making too many IRs always sucks. Verifiers and progressively adding more details generally works a lot better if IRs are similar.</p>



<a name="497273857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273857">(Feb 02 2025 at 17:14)</a>:</h4>
<blockquote>
<p>it's a question of trust</p>
</blockquote>
<p>Verifiers can remove the need for trust.</p>



<a name="497273916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273916">(Feb 02 2025 at 17:15)</a>:</h4>
<p>The feedback on verifiers is far from instantaneous tho</p>



<a name="497273926"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273926" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273926">(Feb 02 2025 at 17:15)</a>:</h4>
<p>e.g. you have to find a failing input first, which is not always obvious</p>



<a name="497273976"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497273976" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497273976">(Feb 02 2025 at 17:16)</a>:</h4>
<p>If you have different IR types, the compiler will yell at you immediately</p>



<a name="497274008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274008">(Feb 02 2025 at 17:17)</a>:</h4>
<p>I agree that it gives some compile time guarantees around typing which can be nice.</p>



<a name="497274102"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274102" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274102">(Feb 02 2025 at 17:18)</a>:</h4>
<p>I still am not sold it is worth 9 IRs, many which are exceptionally similar. As I mentioned above, from working with MLIR, too many dialects ends up being more painful to work with. I think there is a balance where some passes should share, but others should be split. Depends on the amount of difference between IRs.</p>



<a name="497274402"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274402" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274402">(Feb 02 2025 at 17:22)</a>:</h4>
<p>Anyway, not a hill I will die on, I think 9 execeptionally similar IRs will just make a lot of extra work and maintenance burden for us with little gains.</p>



<a name="497274459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274459">(Feb 02 2025 at 17:23)</a>:</h4>
<p>I wonder if there are ways we can catch these at compile time without the entire new IR. Not sure.</p>



<a name="497274558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274558">(Feb 02 2025 at 17:25)</a>:</h4>
<p>Maybe storing the parts that are different out of band?</p>



<a name="497274577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274577">(Feb 02 2025 at 17:25)</a>:</h4>
<p>Not sure if that helps correctness, though, we would have to look at the specifics</p>



<a name="497274588"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274588" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274588">(Feb 02 2025 at 17:25)</a>:</h4>
<p>Ah yeah, that would work. Then cause the old out of ban thing is no longer around, you are guaranteed to have transitioned.</p>



<a name="497274643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274643">(Feb 02 2025 at 17:26)</a>:</h4>
<p>Yeah, exactly</p>



<a name="497274654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274654">(Feb 02 2025 at 17:26)</a>:</h4>
<p>Though I guess you could still have a stale reference to the old out of ban data potentially.</p>



<a name="497274697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497274697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497274697">(Feb 02 2025 at 17:27)</a>:</h4>
<p>There could be debug-mode checks for that I think</p>



<a name="497275228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275228">(Feb 02 2025 at 17:34)</a>:</h4>
<p>Yeah, just like verifiers on the same IR for classes of nodes being gone.</p>



<a name="497275669"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275669" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275669">(Feb 02 2025 at 17:40)</a>:</h4>
<p>Also, one simple example of maintenance pain. If you add a new IR node, you now how to add it to an wire it through 9 dialects instead of 3. Any larger refactor also becomes multiple times bigger if you have more IRs.</p>



<a name="497275741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275741">(Feb 02 2025 at 17:41)</a>:</h4>
<p>You lose the ability to ever reorder passes without significant hassle (may not matter for roc if we truly know the pipeline, but has been a big pain in practices for work I have done before)</p>



<a name="497275850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275850">(Feb 02 2025 at 17:42)</a>:</h4>
<p>If passes have fundamentally different requirements and guarantees on input and output (e.g. it expects a specific node to have been desugared), then it's already not re-orderable</p>



<a name="497275892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275892">(Feb 02 2025 at 17:43)</a>:</h4>
<p>Some passes are not re-orderable. That is true. But that is not true of all passes</p>



<a name="497275904"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275904" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275904">(Feb 02 2025 at 17:43)</a>:</h4>
<p>And that is where verifiers come in.</p>



<a name="497275913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275913">(Feb 02 2025 at 17:43)</a>:</h4>
<p>I would contend that it is true of all passes that should have separate IRs</p>



<a name="497275970"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497275970" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497275970">(Feb 02 2025 at 17:44)</a>:</h4>
<p>(and visa-versa)</p>



<a name="497276058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497276058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497276058">(Feb 02 2025 at 17:45)</a>:</h4>
<blockquote>
<p>If you add a new IR node, you now how to add it to an wire it through 9 dialects instead of 3.</p>
</blockquote>
<p>This "wire things around" kind of update is the sort of thing I expect LLM-driven tooling to get much better at very quickly.</p>



<a name="497276204"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497276204" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497276204">(Feb 02 2025 at 17:47)</a>:</h4>
<p>I think that is a bad metric for what is a maintainable and fun to work on compiler.</p>



<a name="497276219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497276219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497276219">(Feb 02 2025 at 17:47)</a>:</h4>
<p>Fair <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="497276328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497276328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497276328">(Feb 02 2025 at 17:48)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> is specialize where we make N copies of each function?</p>



<a name="497276687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497276687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497276687">(Feb 02 2025 at 17:53)</a>:</h4>
<p>If so, we may want to order passes as:</p>
<ol>
<li>lower IR</li>
<li>Add in refcounting and do any sort of refcounting optimizations (not sure we can do all the optimizations before specialization)</li>
<li>specialize</li>
<li>code gen concrete refcounting functions (this will also turn unused refcount nodes into noops)</li>
<li>gen llvm/other backends</li>
</ol>
<p>Note: for 2, I think at a minimum we can do the refcount insertion and borrow inference. May not be able to do other optimization like reset reuse.</p>



<a name="497299961"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497299961" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497299961">(Feb 02 2025 at 23:00)</a>:</h4>
<p>How can we do refcounting for a function that uses either a list or an int? We'd have to optionally do it</p>



<a name="497300015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300015">(Feb 02 2025 at 23:01)</a>:</h4>
<p>If you're doing this level of reordering, we need a expert to agree on it, aka <span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> . I'm pretty sure we need to make everything first order before we start lowering</p>



<a name="497300694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300694">(Feb 02 2025 at 23:10)</a>:</h4>
<p>Refcounting is the same. Int refcounting will just turn to a noop when finalized. So we would insert refcounts for everything concrete that needs refcounting and anything dynamic that might need refcounting.</p>



<a name="497300750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300750">(Feb 02 2025 at 23:11)</a>:</h4>
<p>Why not just do refcounting once at the end?</p>



<a name="497300765"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300765" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300765">(Feb 02 2025 at 23:11)</a>:</h4>
<p>I see your goal</p>



<a name="497300790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300790">(Feb 02 2025 at 23:11)</a>:</h4>
<p>Which is to specialize later to avoid doing the same work we need to do later on more copies</p>



<a name="497300793"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300793" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300793">(Feb 02 2025 at 23:11)</a>:</h4>
<p>Just trying to move as much stuff as possible before specialization to avoid repeating it n times</p>



<a name="497300800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300800">(Feb 02 2025 at 23:11)</a>:</h4>
<p>Yeah, exactly</p>



<a name="497300860"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300860" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300860">(Feb 02 2025 at 23:12)</a>:</h4>
<p>I'm just assuming <span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> would have suggested that was an option if we could</p>



<a name="497300867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300867">(Feb 02 2025 at 23:12)</a>:</h4>
<p>But maybe I'm putting words in his mouth</p>



<a name="497300910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300910">(Feb 02 2025 at 23:13)</a>:</h4>
<p>Also, I assume specializing a dense ir will be faster than specializing a recursive ir. Thus moving lower ir before specialization. I think for the most part this shouldn't hurt complexity/correctness much. Just a different order.</p>



<a name="497300917"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300917" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300917">(Feb 02 2025 at 23:13)</a>:</h4>
<p>But fundamentally the same work</p>



<a name="497300955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497300955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497300955">(Feb 02 2025 at 23:13)</a>:</h4>
<p>Actually, I don't know how lowering to statements would work with child functions not having been lifted yet</p>



<a name="497301011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301011">(Feb 02 2025 at 23:14)</a>:</h4>
<p>I'm not sure I follow isn't lifting functions much earlier in the pipeline?</p>



<a name="497301021"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301021" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301021">(Feb 02 2025 at 23:14)</a>:</h4>
<p>Can we spin these off into separate discussion threads.. and keep the contributor coord meeting thread scoped to planning/scheduling discussion. It's going to be hard to find things later.</p>



<a name="497301022"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301022" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301022">(Feb 02 2025 at 23:14)</a>:</h4>
<p>It's after type specialization</p>



<a name="497301037"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301037" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301037">(Feb 02 2025 at 23:14)</a>:</h4>
<p>I'm on mobile, could someone else do it?</p>



<a name="497301229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301229">(Feb 02 2025 at 23:17)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> can you explain the difference betteen type and function specialization? I assumed function specialization is what leads to N copies of each function, but maybe that is wrong?</p>



<a name="497301305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301305">(Feb 02 2025 at 23:18)</a>:</h4>
<p>No, it's different</p>



<a name="497301344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301344">(Feb 02 2025 at 23:19)</a>:</h4>
<p>Type specialization takes a copy of every top level value and every top level function and makes a concretely-typed copy for each specific set of types it should have at runtime</p>



<a name="497301450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301450">(Feb 02 2025 at 23:20)</a>:</h4>
<p>Function specialization is <a href="https://github.com/roc-lang/rfcs/blob/ayaz/compile-with-lambda-sets/0102-compiling-lambda-sets.md#function_specialize">https://github.com/roc-lang/rfcs/blob/ayaz/compile-with-lambda-sets/0102-compiling-lambda-sets.md#function_specialize</a></p>



<a name="497301452"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301452" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301452">(Feb 02 2025 at 23:20)</a>:</h4>
<p>oh....</p>



<a name="497301480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301480">(Feb 02 2025 at 23:21)</a>:</h4>
<p>Which is a way to convert higher order functions to functions we call using a tag union to represent different possible arguments</p>



<a name="497301491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301491">(Feb 02 2025 at 23:21)</a>:</h4>
<p>It's kinda like, if not exactly, defunctionalization</p>



<a name="497301517"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301517" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301517">(Feb 02 2025 at 23:21)</a>:</h4>
<p>Confusing name, I agree</p>



<a name="497301537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301537">(Feb 02 2025 at 23:22)</a>:</h4>
<p>and type specialization has to come before all of these:</p>
<blockquote>
<ul>
<li>lift functions (lambdas should no longer exist in the code)</li>
<li>solve functions (all higher-order function arguments need to be generic)</li>
<li>specialize functions (no more higher-order functions anywhere)</li>
</ul>
</blockquote>



<a name="497301577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301577">(Feb 02 2025 at 23:22)</a>:</h4>
<p>We could maybe call it defunctionalize to make the name distinct</p>



<a name="497301600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301600">(Feb 02 2025 at 23:22)</a>:</h4>
<p>It doesn't have to, but it's gonna be pretty hard to do those correctly otherwise I think</p>



<a name="497301605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301605">(Feb 02 2025 at 23:22)</a>:</h4>
<p>ack</p>



<a name="497301616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301616">(Feb 02 2025 at 23:22)</a>:</h4>
<p>That section of the compiler, even if we combine those phases, will be hard to reorder</p>



<a name="497301640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301640">(Feb 02 2025 at 23:23)</a>:</h4>
<p>Yeah, then suggested order sounds fine</p>



<a name="497301650"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301650" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301650">(Feb 02 2025 at 23:23)</a>:</h4>
<p>Though it'd be nice to avoid doing more work for the phases after them because of the type specialization</p>



<a name="497301816"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301816" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301816">(Feb 02 2025 at 23:25)</a>:</h4>
<p>Yeah, would be nice if we could share more. Cause, for example, if you have 10 specializations of the same function that uses lists, they all refcount the same way.</p>



<a name="497301893"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497301893" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497301893">(Feb 02 2025 at 23:26)</a>:</h4>
<p>But unless that is easy to do, I 100% agree with correctness first.</p>



<a name="497302069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302069">(Feb 02 2025 at 23:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering/near/497275669">said</a>:</p>
<blockquote>
<p>Also, one simple example of maintenance pain. If you add a new IR node, you now how to add it to an wire it through 9 dialects instead of 3. Any larger refactor also becomes multiple times bigger if you have more IRs.</p>
</blockquote>
<p>Not sure if we'll come to an agreement, but it feels like we're not on the same page, so I'll ask: if we can't really reorder from the suggested order, then are you still against the IRs being different?</p>
<p>One big benefit of different IRs is that if we make sure that calculating stage N takes the stage N+1 IRs for the dep modules, then we have a type guarantee that the deps must have been compiled first</p>



<a name="497302119"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302119" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302119">(Feb 02 2025 at 23:29)</a>:</h4>
<p>I think it's my lizard brain speaking, but I see fuzzing as a high probability test for correctness, and types as true guarantees</p>



<a name="497302178"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302178" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302178">(Feb 02 2025 at 23:30)</a>:</h4>
<p>I always prefer types where possible, but I'm definitely always a high-level thinker for modeling problems</p>



<a name="497302263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302263">(Feb 02 2025 at 23:31)</a>:</h4>
<p>my heuristic for this would be:</p>
<ul>
<li>material change in the invariants of the program: use a different IR (parsed/can/type checked/specialized/function specialized/etc)</li>
<li>optimizations or simple invariant: use same IR</li>
</ul>



<a name="497302289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302289">(Feb 02 2025 at 23:31)</a>:</h4>
<p>all optimizations over the so called mono IR, refcounting etc are probably same IR</p>



<a name="497302303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302303">(Feb 02 2025 at 23:31)</a>:</h4>
<p>cost of creating a new IR is a bad reason not to create an IR IMO</p>



<a name="497302382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302382">(Feb 02 2025 at 23:32)</a>:</h4>
<p>the IR creation being redundant and obfuscating the actual transformation is a good reason not to create an IR, which is the case for refcounting and optimizations</p>



<a name="497302806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302806">(Feb 02 2025 at 23:37)</a>:</h4>
<p>Yeah, that sounds pretty reasonable overall as a metric. It's up to the stage author to decide if invariants are simple enough to reuse the same IR. In my mind, many of the "its the same IR minus one specific thing" are pretty simple invariants, but I won't be writing those passes, so whoever writes the passes can decide.</p>



<a name="497302893"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497302893" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497302893">(Feb 02 2025 at 23:39)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> do you think any work can be hoisted above type specialization to avoid repeating N times? Just curious if there is anything that is flexible that we should try to move now instead of later when the pipeline is more ironed down.</p>



<a name="497303782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497303782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497303782">(Feb 02 2025 at 23:49)</a>:</h4>
<p>what is the worry about what might be repeated N times?</p>



<a name="497303943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497303943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497303943">(Feb 02 2025 at 23:51)</a>:</h4>
<p>It is N times faster to do work once than N times. So anything that is reasonable to move before specialization probably should be.</p>



<a name="497303968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497303968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497303968">(Feb 02 2025 at 23:51)</a>:</h4>
<p>i see</p>



<a name="497304015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497304015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497304015">(Feb 02 2025 at 23:52)</a>:</h4>
<p>i probably wouldn't think about this too deeply right now</p>



<a name="497304051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497304051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497304051">(Feb 02 2025 at 23:52)</a>:</h4>
<p>I don't want to think too deeply about it, but if there is anything we think would be easy to move now without a concern for correctness, I think we should move it. I think later it will be much harder to fix these kinds of issues.</p>



<a name="497304059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497304059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497304059">(Feb 02 2025 at 23:53)</a>:</h4>
<p>if there's something obvious that can be lifted it to an earlier pass it will be obviously and be easy to lift i think</p>



<a name="497304090"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497304090" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497304090">(Feb 02 2025 at 23:53)</a>:</h4>
<p>for example function lifting can kind of be done whenever after typechecking</p>



<a name="497304102"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497304102" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497304102">(Feb 02 2025 at 23:53)</a>:</h4>
<p>but that is one of those kind of obvious/trivial things</p>



<a name="497304150"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497304150" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497304150">(Feb 02 2025 at 23:54)</a>:</h4>
<p>i think its worth embracing that all of this will have to be rewritten at the limit anyway</p>



<a name="497304167"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497304167" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497304167">(Feb 02 2025 at 23:54)</a>:</h4>
<p>if you want the fastest compiler there are some parts of this architecture that will be blockers</p>



<a name="497307015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307015">(Feb 03 2025 at 00:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering/near/497304150">said</a>:</p>
<blockquote>
<p>i think its worth embracing that all of this will have to be rewritten at the limit anyway</p>
</blockquote>
<p>I don't want to embrace that</p>



<a name="497307035"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307035" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307035">(Feb 03 2025 at 00:27)</a>:</h4>
<p>I think that will lead us to an unnecessarily and noticeably slow compiler for years and years</p>



<a name="497307063"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307063" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307063">(Feb 03 2025 at 00:27)</a>:</h4>
<p>I think that's what most compilers do, and I think we can do better without going overboard like we did before</p>



<a name="497307115"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307115" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307115">(Feb 03 2025 at 00:28)</a>:</h4>
<p>I do think it's fine to have different IRs for each pass (when it would be valuble)</p>



<a name="497307138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307138">(Feb 03 2025 at 00:28)</a>:</h4>
<p>but I think eventually once things have settled down we might explore combining some of them as an incremental change</p>



<a name="497307148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307148">(Feb 03 2025 at 00:28)</a>:</h4>
<p>eventually as in "someday" not like right after 0.1.0 or anything <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497307156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307156">(Feb 03 2025 at 00:29)</a>:</h4>
<p>and I think that can be done more incrementally than rewriting the whole compiler</p>



<a name="497307173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307173">(Feb 03 2025 at 00:29)</a>:</h4>
<p>i don't know. i don't think you can have both worlds. the current implementation is closer to what the limit needs to look like. but there's a reasoning a rewrite is being discussed.</p>



<a name="497307282"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307282" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307282">(Feb 03 2025 at 00:30)</a>:</h4>
<p>I'm saying I think we should prioritize correctness, simplicity, maintainability, and debugabillity for this rewrite, but I think "embrace that it's all gonna be rewritten and don't worry about it" goes too far</p>



<a name="497307288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307288">(Feb 03 2025 at 00:30)</a>:</h4>
<p>im not saying this approach will be too slow or anything like that. it will be totally fine for the vast majority of programs because limiting factors for any non-trivial program are going to be algorithmic, not number of passes or whatever.</p>



<a name="497307315"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307315" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307315">(Feb 03 2025 at 00:30)</a>:</h4>
<p>well, i'm just saying that the fastest possible approach is not this approach</p>



<a name="497307336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307336">(Feb 03 2025 at 00:31)</a>:</h4>
<p>for sure!</p>



<a name="497307351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307351">(Feb 03 2025 at 00:31)</a>:</h4>
<p>I just think we shouldn't be all-or-nothing about it haha</p>



<a name="497307367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307367">(Feb 03 2025 at 00:31)</a>:</h4>
<p>before the goal was "fastest possible" and that got us into trouble</p>



<a name="497307379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307379">(Feb 03 2025 at 00:31)</a>:</h4>
<p>I don't think we should aim for "fastest possible" for this rewrite</p>



<a name="497307396"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307396" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307396">(Feb 03 2025 at 00:31)</a>:</h4>
<p>but I also don't think we should aim for "only algorithmic perf matters" because I don't think that will turn out to be correct</p>



<a name="497307401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307401">(Feb 03 2025 at 00:31)</a>:</h4>
<p>I mean maybe I'll be wrong!</p>



<a name="497307471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307471">(Feb 03 2025 at 00:32)</a>:</h4>
<p>i think it's true. the only cases i can think of in the current implementation where it was a problem was because of algorithms. but maybe i'm missing cases you have in mind?</p>



<a name="497307532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307532">(Feb 03 2025 at 00:33)</a>:</h4>
<p>I agree with that, but "the current thing that's heavily optimized for perf only has algorithmic trouble" does not imply "if we have one that's not optimized at all for perf it will also only have algorithmic trouble"</p>



<a name="497307594"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307594" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307594">(Feb 03 2025 at 00:34)</a>:</h4>
<p>that would imply that only algorithmic performance optimizations matter to compilers as a category, which I would be extremely skeptical of haha</p>



<a name="497307627"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307627" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307627">(Feb 03 2025 at 00:34)</a>:</h4>
<p>i agree</p>



<a name="497307759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307759">(Feb 03 2025 at 00:36)</a>:</h4>
<p>i think the difference is in limiting factors. it's far more likely that algorithmic passes are the limiting factor because Roc is doing a lot work to lower a high level language to a low level one, than just rewriting stuff to a different form. But at the limit you have to fuse both, and this approach doesn't really work for that, I think.</p>



<a name="497307814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307814">(Feb 03 2025 at 00:37)</a>:</h4>
<p>but also like i think they should be two different planes</p>



<a name="497307832"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307832" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307832">(Feb 03 2025 at 00:37)</a>:</h4>
<p>the concerns about the algorithmic passes should be entirely disjoint from the implementation of how data is stored</p>



<a name="497307842"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307842" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307842">(Feb 03 2025 at 00:37)</a>:</h4>
<p>I guess a really big question mark here is whether the "dev backend can be an interpreter and it's fine" hypothesis proves correct in practice</p>



<a name="497307851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307851">(Feb 03 2025 at 00:37)</a>:</h4>
<p>that way you have a nice interface boundary between the two and can prefer to optimize one or the other</p>



<a name="497307887"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307887" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307887">(Feb 03 2025 at 00:38)</a>:</h4>
<p>because if that works out, then in dev builds we stop after type-checking</p>



<a name="497307900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307900">(Feb 03 2025 at 00:38)</a>:</h4>
<p>and only <code>--optimize</code> builds do any of this expensive stuff</p>



<a name="497307910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307910">(Feb 03 2025 at 00:38)</a>:</h4>
<p>if that kind of boundary can be done correctly, then you don't have to worry about getting both right at the same time</p>



<a name="497307917"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307917" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307917">(Feb 03 2025 at 00:38)</a>:</h4>
<p>which get run way less frequently, and the downside of a slower feedback loop is much less (unless you're doing performance optimization, in which case it's painful if they're slow)</p>



<a name="497307926"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307926" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307926">(Feb 03 2025 at 00:38)</a>:</h4>
<p>I think it will work out fine, taking e.g python or ocaml as prior</p>



<a name="497307939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307939">(Feb 03 2025 at 00:38)</a>:</h4>
<p>OCaml is interpreted? <span aria-label="astonished" class="emoji emoji-1f632" role="img" title="astonished">:astonished:</span></p>



<a name="497307951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307951">(Feb 03 2025 at 00:39)</a>:</h4>
<p>both of which don't have sophisticated interpreters (or at least didn't until the past few years)</p>



<a name="497307957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307957">(Feb 03 2025 at 00:39)</a>:</h4>
<p>ocaml has many modes</p>



<a name="497307971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497307971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497307971">(Feb 03 2025 at 00:39)</a>:</h4>
<p>TIL!</p>



<a name="497308554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308554">(Feb 03 2025 at 00:46)</a>:</h4>
<p>yeah the specific scenario I'm concerned about (because I don't have any idea how likely it is to come up in practice) is something like:</p>
<ul>
<li>I'm making a game in Roc</li>
<li>If I run it in <code>--optimize</code> it plays great but my feedback loop is slow</li>
<li>If I run it with the interpreter I have a fast feedback loop but the game is unplayably laggy so I have to pass <code>--optimize</code> to try anything out</li>
<li>If I had a dev backend, the game would be fast enough to play and the feedback loop would be fast</li>
</ul>



<a name="497308573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308573">(Feb 03 2025 at 00:46)</a>:</h4>
<p>Brendan pointed out that our current dev backend is so unoptimized that it might not actually be faster enough than an interpreter to be noticeable</p>



<a name="497308590"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308590" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308590">(Feb 03 2025 at 00:46)</a>:</h4>
<p>and also, we can potentially JIT up the interpreter if <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span> becomes a problem in practice</p>



<a name="497308600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308600">(Feb 03 2025 at 00:47)</a>:</h4>
<p>which also would still skip all the steps after type-checking for dev builds</p>



<a name="497308708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308708">(Feb 03 2025 at 00:48)</a>:</h4>
<p>i think this is the kind of thing where it's probably just worth punting until it comes up</p>



<a name="497308732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308732">(Feb 03 2025 at 00:48)</a>:</h4>
<p>if the implementation is simple, then it's not hard to refactor to make this work or introduce complexity for specific usage patterns</p>



<a name="497308758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308758">(Feb 03 2025 at 00:49)</a>:</h4>
<p>and maybe it never comes up</p>



<a name="497308779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308779">(Feb 03 2025 at 00:49)</a>:</h4>
<p>"this" being the IRs after type-checking?</p>



<a name="497308786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/497308786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#497308786">(Feb 03 2025 at 00:49)</a>:</h4>
<p>well just the compiler in general</p>



<a name="501140202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501140202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501140202">(Feb 21 2025 at 16:19)</a>:</h4>
<p>just a note I remembered: today, we have automatic dead code elimination of unused constants (e.g. I use a package but I only use some of its exposed operations, and nothing I actually use involves certain top-level constants the package defines) because we compile them to thunks which automatically get DCE'd</p>



<a name="501140357"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501140357" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501140357">(Feb 21 2025 at 16:19)</a>:</h4>
<p>but in the new compiler where we're instead evaluating constants at compile-time, we need to make sure that we don't include constants that have been compiled down to literals unless they're actually referenced somewhere!</p>



<a name="501140445"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501140445" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501140445">(Feb 21 2025 at 16:20)</a>:</h4>
<p>(same goes for string literals etc in general)</p>



<a name="501149617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501149617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501149617">(Feb 21 2025 at 17:09)</a>:</h4>
<p>Depends on what section granularity we use</p>



<a name="501149732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501149732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501149732">(Feb 21 2025 at 17:10)</a>:</h4>
<p>You can also put each constant in their own section just like functions.</p>



<a name="501150701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501150701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501150701">(Feb 21 2025 at 17:15)</a>:</h4>
<p>true, although it'll improve build speed if we just only flag things as used when we actually use them, and then only include them if so</p>



<a name="501150735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501150735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501150735">(Feb 21 2025 at 17:15)</a>:</h4>
<p>(compared to adding everything and then having the linker remove them again in a later pass)</p>



<a name="501155685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501155685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501155685">(Feb 21 2025 at 17:44)</a>:</h4>
<p>Same for functions preferably</p>



<a name="501155958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501155958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501155958">(Feb 21 2025 at 17:45)</a>:</h4>
<p>I think we could use specialization to do a liveness check even on functions that are already concrete.</p>



<a name="501156219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501156219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501156219">(Feb 21 2025 at 17:47)</a>:</h4>
<p>we've always done it for functions</p>



<a name="501156661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501156661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501156661">(Feb 21 2025 at 17:49)</a>:</h4>
<p>Oh, never realized</p>



<a name="501168043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IRs%20and%20pass%20ordering/near/501168043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IRs.20and.20pass.20ordering.html#501168043">(Feb 21 2025 at 18:57)</a>:</h4>
<p>I think we can have type specialization handle this</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>roc-ray possible ABI issue? · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html">roc-ray possible ABI issue?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="477635917"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477635917" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477635917">(Oct 18 2024 at 11:39)</a>:</h4>
<p>Ok, I think I've got some kind of ABI problem.. but I'm not sure. </p>
<p>In the platform I have </p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code># Effect.roc
HostColor : {
    # this is a hack to work around https://github.com/roc-lang/roc/issues/7142
    unused : I64,
    unused2 : I64,
    r : U8,
    g : U8,
    b : U8,
    a : U8,
}

setBackgroundColor : HostColor -&gt; Task {} {}
</code></pre></div>
<p>This generates the following LLVM IR, which looks like I expect, basically passing a struct by value and geting a tag union back.</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">declare</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="vg">@roc_fx_setBackgroundColor</span><span class="p">({</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">})</span>
</code></pre></div>
<p>In the host I'm representing the struct as follows</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">HostColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// this is a hack to work around https://github.com/roc-lang/roc/issues/7142</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">unused</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">unused2</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_setBackgroundColor</span><span class="p">(</span><span class="n">color</span><span class="p">:</span><span class="w"> </span><span class="nc">HostColor</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">CLEAR_BACKGOUND</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">color</span><span class="p">);</span>

<span class="w">    </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>And for some reason... the information I'm getting in the host is not initialized. I thought it may be because I should actually be receiving a pointer <code>&amp;HostColor</code> but, I'm pretty sure the LLVM IR is passing the struct by value. Anyway... messing with LLDB I can see the memory is not initialized. </p>
<div class="codehilite"><pre><span></span><code>* thread #1, name = &#39;main&#39;, stop reason = EXC_BAD_ACCESS (code=1, address=0x0)
    frame #0: 0x0000000100009084 roc-ray`roc_fx_setBackgroundColor(color=(unused = &lt;parent is NULL&gt;, unused2 = &lt;parent is NULL&gt;, a = &lt;parent is NULL&gt;, b = &lt;parent is NULL&gt;, g = &lt;parent is NULL&gt;, r = &lt;parent is NULL&gt;)) at main.rs:282:5
   279
   280  #[no_mangle]
   281  unsafe extern &quot;C&quot; fn roc_fx_setBackgroundColor(color: glue::HostColor) -&gt; RocResult&lt;(), ()&gt; {
-&gt; 282      CLEAR_BACKGOUND.set(color);
   283
   284      RocResult::ok(())
   285  }
</code></pre></div>



<a name="477637004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477637004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477637004">(Oct 18 2024 at 11:45)</a>:</h4>
<p>From what I can tell from my investigation, it appears the issue may be in roc at the callsite, something related to the ABI.</p>



<a name="477637265"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477637265" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477637265">(Oct 18 2024 at 11:46)</a>:</h4>
<p>It's only called in one place... that is in the fastcc wrapper</p>
<div class="codehilite"><pre><span></span><code>declare { [0 x i8], i8 } @roc_fx_setBackgroundColor({ i64, i64, i8, i8, i8, i8 })

define internal fastcc void @roc_fx_setBackgroundColor_fastcc_wrapper({ i64, i64, i8, i8, i8, i8 } %0, ptr %1) {
entry:
  %tmp = call { [0 x i8], i8 } @roc_fx_setBackgroundColor({ i64, i64, i8, i8, i8, i8 } %0), !dbg !222
  store { [0 x i8], i8 } %tmp, ptr %1, align 1, !dbg !222
  ret void, !dbg !222
}
</code></pre></div>



<a name="477638048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477638048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477638048">(Oct 18 2024 at 11:51)</a>:</h4>
<p>I'm working on this branch <a href="https://github.com/lukewilliamboswell/roc-ray/tree/sprites">https://github.com/lukewilliamboswell/roc-ray/tree/sprites</a></p>
<p>I was adding the feature for working with Textures.. but this is unrelated.... I got distracted by the set background color function not working as I expected it to.</p>



<a name="477640695"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477640695" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477640695">(Oct 18 2024 at 12:06)</a>:</h4>
<p>I'm going to take a break. But I'm thinking I should check what rust is doing with that function and struct using godbolt next.</p>



<a name="477665025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477665025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477665025">(Oct 18 2024 at 14:12)</a>:</h4>
<p>Yeah looks like a roc bug....I'm actually quite a bit surprised by this one</p>



<a name="477665085"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477665085" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477665085">(Oct 18 2024 at 14:12)</a>:</h4>
<p>We should be passing a pointer to that strict due to how large it is</p>



<a name="477665138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477665138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477665138">(Oct 18 2024 at 14:13)</a>:</h4>
<p>I'm pretty sure rust is automatically converting it to a pointer</p>



<a name="477665175"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477665175" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477665175">(Oct 18 2024 at 14:13)</a>:</h4>
<p>This is something I would expect to just work....</p>



<a name="477665283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477665283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477665283">(Oct 18 2024 at 14:13)</a>:</h4>
<p>Rocs c abi could really use some love</p>



<a name="477714786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477714786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477714786">(Oct 18 2024 at 19:09)</a>:</h4>
<p>Could it be specifically related to Task or hosted module? Does roc use a different ABI internally? Just looking for any pointers to narrow my search in the compiler... I'm thinking gen_llvm... but I suspect this might be back up in something earlier if it's Task related.</p>



<a name="477715127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477715127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477715127">(Oct 18 2024 at 19:12)</a>:</h4>
<p>is using RocList&lt;u8&gt; a reliable workaround for this c abi thing and 7142, or would that have the same problems?</p>



<a name="477715568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477715568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477715568">(Oct 18 2024 at 19:15)</a>:</h4>
<p>I dont know. Haven't ran into this before with previous platforms. It seems strange. Using a RocList is probably a good workaround because its working elsewhere.</p>



<a name="477715820"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477715820" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477715820">(Oct 18 2024 at 19:16)</a>:</h4>
<p>I've still been digging... I'll keep going for a little, but if it's over my head I'll look for a workaround and move on with the features.</p>



<a name="477716684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477716684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477716684">(Oct 18 2024 at 19:23)</a>:</h4>
<p>I was just wondering if I should change what I was doing</p>



<a name="477716816"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477716816" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477716816">(Oct 18 2024 at 19:24)</a>:</h4>
<p>With what part?</p>



<a name="477717437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477717437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477717437">(Oct 18 2024 at 19:28)</a>:</h4>
<p>with inputs it seemed like just always passing a list of bytes was nice, so I was considering treating it like a default. if it also avoids this then that's good. I'm not sure if I'm inviting overhead this way (beyond the fat pointer I guess?), but it seems like a reasonable default</p>



<a name="477718023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477718023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477718023">(Oct 18 2024 at 19:32)</a>:</h4>
<p>For adding features and avoiding these issues I think that is a great approach.</p>



<a name="477725407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477725407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477725407">(Oct 18 2024 at 19:52)</a>:</h4>
<p>So back on this issue above... I wanted to know what rust does with something shaped like that. I built the following program.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">roc_fx_setBackgroundColor</span><span class="p">(</span><span class="n">HostColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span>
<span class="w">            </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span>
<span class="w">            </span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span>
<span class="w">            </span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>

<span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">HostColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_setBackgroundColor</span><span class="p">(</span><span class="n">color</span><span class="p">:</span><span class="w"> </span><span class="nc">HostColor</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">color</span><span class="p">.</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">.</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">.</span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="p">.</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>And then compiled it using <code>$ RUSTFLAGS="--emit=llvm-ir" cargo build</code> to get the LLVM IR.</p>
<p>I can see this, </p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="c">; asdfasdf::main</span>
<span class="c">; Function Attrs: uwtable</span>
<span class="k">define</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_ZN8asdfasdf4main17h34e824c37946dda6E</span><span class="p">()</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="vg">#1</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!392</span><span class="w"> </span><span class="p">{</span>
<span class="nl">start:</span>
<span class="w">  </span><span class="nv">%_2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="nv">%HostColor</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!395</span>
<span class="w">  </span><span class="nv nv-Anonymous">%0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_2</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!395</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!395</span>
<span class="w">  </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_2</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!395</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!395</span>
<span class="w">  </span><span class="nv nv-Anonymous">%2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="k">inbounds</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_2</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!395</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="m">-1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!395</span>
<span class="w">  </span><span class="nv nv-Anonymous">%3</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%_2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!396</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc_fx_setBackgroundColor</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%3</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!396</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!397</span>
<span class="p">}</span>

<span class="c">; Function Attrs: uwtable</span>
<span class="k">define</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc_fx_setBackgroundColor</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">)</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="vg">#1</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!398</span><span class="w"> </span><span class="p">{</span>
<span class="nl">start:</span>
<span class="w">  </span><span class="nv">%f.dbg.spill.i28</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv">%x.dbg.spill.i29</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv">%_0.i30</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="nv">%"core::fmt::rt::Argument&lt;'_&gt;"</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv">%f.dbg.spill.i25</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv">%x.dbg.spill.i26</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv">%_0.i27</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="nv">%"core::fmt::rt::Argument&lt;'_&gt;"</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
</code></pre></div>
<p>Which looks to me like Rust is passing that by pointer.</p>



<a name="477725524"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477725524" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477725524">(Oct 18 2024 at 19:53)</a>:</h4>
<p>I'm using LLVM instead of machine code here... because I assume that avoids any differences between x64 / aarch64 etc.</p>



<a name="477737810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477737810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477737810">(Oct 18 2024 at 21:37)</a>:</h4>
<p>That is not passing by pointer</p>



<a name="477737824"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477737824" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477737824">(Oct 18 2024 at 21:37)</a>:</h4>
<p>That is passing in a single register as an <code>i64</code></p>



<a name="477737834"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477737834" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477737834">(Oct 18 2024 at 21:37)</a>:</h4>
<p>So it is packing the struct into one value</p>



<a name="477745072"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477745072" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477745072">(Oct 18 2024 at 22:54)</a>:</h4>
<p>Random aside, do you know why rust represents the u8 as an i8 and assigns -1? Is there anything in that?</p>



<a name="477749782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477749782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477749782">(Oct 18 2024 at 23:58)</a>:</h4>
<p>Just to clarify, this is a roc bug right?</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>Color : { r : U8, g : U8, b : U8, a : U8 }

setBackgroundColor : Color -&gt; Task {} {}
</code></pre></div>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="c">; WHAT ROC GENERATES</span>
<span class="k">declare</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="vg">@roc_fx_setBackgroundColor</span><span class="p">({</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="k">local_unnamed_addr</span>

<span class="c">; WHAT RUST GENERATES</span>
<span class="k">define</span><span class="w"> </span><span class="k">dso_local</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc_fx_setBackgroundColor</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">)</span><span class="w"> </span><span class="k">unnamed_addr</span><span class="w"> </span><span class="vg">#1</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!398</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p><strong>ChatGPT Summary</strong></p>
<div class="codehilite" data-code-language="Markdown"><pre><span></span><code>In LLVM IR, <span class="sb">`{ i8, i8, i8, i8 }`</span> and <span class="sb">`i64`</span> are not the same, although they can represent the same amount of data (64 bits). The difference lies in how the data is structured and accessed.

<span class="gu">### `{ i8, i8, i8, i8 }`</span>

This represents a structure with four 8-bit integers. Each <span class="sb">`i8`</span> is an individual byte, and the structure explicitly defines the layout of these bytes. Accessing each byte would involve accessing the specific field within the structure.

<span class="gu">### `i64`</span>

This represents a single 64-bit integer. The entire 64 bits are treated as one unit, and accessing individual bytes would typically involve bitwise operations or shifts to isolate specific parts of the 64-bit value.

<span class="gu">### Key Differences</span>

<span class="k">1.</span> <span class="gs">**Data Layout**</span>:
<span class="w">   </span><span class="k">-</span><span class="w"> </span><span class="sb">`{ i8, i8, i8, i8 }`</span>: The data is laid out as four separate 8-bit fields.
<span class="w">   </span><span class="k">-</span><span class="w"> </span><span class="sb">`i64`</span>: The data is a single 64-bit field.

<span class="k">2.</span> <span class="gs">**Access Patterns**</span>:
<span class="w">   </span><span class="k">-</span><span class="w"> </span><span class="sb">`{ i8, i8, i8, i8 }`</span>: Accessing individual bytes is straightforward as each byte is a separate field.
<span class="w">   </span><span class="k">-</span><span class="w"> </span><span class="sb">`i64`</span>: Accessing individual bytes requires bitwise operations to extract the desired byte.

<span class="k">3.</span> <span class="gs">**Type Semantics**</span>:
<span class="w">   </span><span class="k">-</span><span class="w"> </span><span class="sb">`{ i8, i8, i8, i8 }`</span>: The type explicitly indicates a structure with four bytes.
<span class="w">   </span><span class="k">-</span><span class="w"> </span><span class="sb">`i64`</span>: The type indicates a single 64-bit integer.
</code></pre></div>



<a name="477749888"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477749888" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477749888">(Oct 19 2024 at 00:00)</a>:</h4>
<p>This is the same issue as the tag c-abi thread</p>



<a name="477750092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477750092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477750092">(Oct 19 2024 at 00:02)</a>:</h4>
<p>Specifically this:</p>
<blockquote>
<p>Struct and union parameters with sizes of two (eight in case of only SSE fields) pointers or fewer that are aligned on 64-bit boundaries are decomposed into "eightbytes" and each one is classified and passed as a separate parameter.[28]: 24  Otherwise they are replaced with a pointer when used as an argument.</p>
</blockquote>



<a name="477750149"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477750149" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477750149">(Oct 19 2024 at 00:03)</a>:</h4>
<p>Can you share the reference for this?</p>



<a name="477750167"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477750167" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477750167">(Oct 19 2024 at 00:03)</a>:</h4>
<p>I'm going to try packing the bits into what Rust expects on the roc side. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="477750227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477750227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477750227">(Oct 19 2024 at 00:04)</a>:</h4>
<p>That's just from the x86 call conv wikipedia page</p>



<a name="477750247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477750247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477750247">(Oct 19 2024 at 00:04)</a>:</h4>
<p>Is it the same on aarch64?</p>



<a name="477750656"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477750656" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477750656">(Oct 19 2024 at 00:10)</a>:</h4>
<p>Not really, but in this case I think so:</p>
<blockquote>
<p>If the argument is a Composite Type, and the size in double-words of the argument is no more than 8 minus NGRN, then the argument is copied into consecutive general-purpose registers, starting at x[NGRN]. The argument is passed as though it had been loaded into the registers from a double-word-aligned address, with an appropriate sequence of LDR instructions that load consecutive registers from memory. The contents of any unused parts of the registers are unspecified by this standard. The NGRN is incremented by the number of registers used. The argument has now been allocated.</p>
</blockquote>



<a name="477750974"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477750974" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477750974">(Oct 19 2024 at 00:16)</a>:</h4>
<p>I tried tricking roc to produce the rust equivalent using this helper. But I'm still not getting the right data out of roc. I can crash and see all <code>255</code>'s but using dbg in rust I'm getting </p>
<div class="codehilite"><pre><span></span><code>[src/main.rs:284:5] color = HostColor {
    a: 1,
    b: 0,
    g: 0,
    r: 0,
}
</code></pre></div>
<div class="codehilite"><pre><span></span><code>fromRGBA : { r : U8, g : U8, b : U8, a : U8 } -&gt; I64
fromRGBA = \{ r, g, b, a } -&gt;
    Num.shiftLeftBy 24 a
    |&gt; Num.bitwiseOr (Num.shiftLeftBy 16 b)
    |&gt; Num.bitwiseOr (Num.shiftLeftBy 8 g)
    |&gt; Num.bitwiseOr (Num.shiftLeftBy 0 r)
</code></pre></div>
<p>I think I'm going to try make my own version and manually pack/unpack from an <code>i64</code> next.</p>



<a name="477751025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477751025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477751025">(Oct 19 2024 at 00:16)</a>:</h4>
<p>This is fun <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="477752097"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477752097" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477752097">(Oct 19 2024 at 00:35)</a>:</h4>
<p>Hey, got it working <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="477752319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477752319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477752319">(Oct 19 2024 at 00:39)</a>:</h4>
<div class="codehilite"><pre><span></span><code>fromRGBA : { r : U8, g : U8, b : U8, a : U8 } -&gt; U64
fromRGBA = \{ r, g, b, a } -&gt;
    (Num.intCast a |&gt; Num.shiftLeftBy 24)
    |&gt; Num.bitwiseOr (Num.intCast b |&gt; Num.shiftLeftBy 16)
    |&gt; Num.bitwiseOr (Num.intCast g |&gt; Num.shiftLeftBy 8)
    |&gt; Num.bitwiseOr (Num.intCast r)
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">RocColor</span><span class="p">(</span><span class="kt">i64</span><span class="p">);</span>

<span class="k">impl</span><span class="w"> </span><span class="n">RocColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">from_rgba</span><span class="p">(</span><span class="n">r</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocColor</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="n">g</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">r</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">);</span>
<span class="w">        </span><span class="n">RocColor</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">to_rgba</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xFF</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">;</span>
<span class="w">        </span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Added a bunch of tests, and it's also working nicely with the raylib stuff. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="477753615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477753615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477753615">(Oct 19 2024 at 00:56)</a>:</h4>
<p>Yeah, manual packing is a decent workaround</p>



<a name="477753638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477753638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477753638">(Oct 19 2024 at 00:57)</a>:</h4>
<p>Also, I'm kinda stunned we didn't hit this before. Make me feel like there was a regression at somepoint</p>



<a name="477753657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477753657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477753657">(Oct 19 2024 at 00:57)</a>:</h4>
<p>Doesn't roc wasm4 use small types like this and not have problems?</p>



<a name="477753732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477753732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477753732">(Oct 19 2024 at 00:58)</a>:</h4>
<p>I think we stuck to RocStr, and RocList for everything</p>



<a name="477753756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477753756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477753756">(Oct 19 2024 at 00:58)</a>:</h4>
<p>I think this is the first time I've seen a record passed as an argument</p>



<a name="477756172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477756172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477756172">(Oct 19 2024 at 01:38)</a>:</h4>
<p>I think it's the same with floats. </p>
<div class="codehilite"><pre><span></span><code>Vector2 : { x : F32, y : F32 }

setWindowSize : Vector2 -&gt; Task {} {}
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">RocVector2</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="c">; WHAT ROC GENERATES</span>
<span class="vg">@roc_fx_setWindowSize</span><span class="p">({</span><span class="w"> </span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="p">})</span>

<span class="c">; WHAT RUST GENERATES</span>
<span class="vg">@roc_fx_setWindowSize</span><span class="p">([</span><span class="m">2</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">float</span><span class="p">]</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">)</span>
</code></pre></div>



<a name="477768062"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477768062" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477768062">(Oct 19 2024 at 03:33)</a>:</h4>
<p>In that case, I think roc and rust generate the same thing</p>



<a name="477768068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477768068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477768068">(Oct 19 2024 at 03:33)</a>:</h4>
<p>I don't think there should be a meaningful difference</p>



<a name="477768084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477768084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477768084">(Oct 19 2024 at 03:33)</a>:</h4>
<p>If there is, I'm not sure why/how. Both should pass in two float regs I think</p>



<a name="477768542"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477768542" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477768542">(Oct 19 2024 at 03:40)</a>:</h4>
<p>I found a bit of a silly workaround... increases the size enough until it gets passed as a pointer.</p>
<div class="codehilite"><pre><span></span><code>RocRectangle := {
    x : F32,
    y : F32,
    width : F32,
    height : F32,
    unused : I64,
    unused2 : I64,
    unused3 : I64,
}
</code></pre></div>
<p>When we fix the bug we only need to change it in one part in the host and the platform.</p>



<a name="477768569"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477768569" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477768569">(Oct 19 2024 at 03:41)</a>:</h4>
<p>My thoughts are that maybe... LLVM will be smart enough to optimise these unused fields out even.</p>



<a name="477771802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/roc-ray%20possible%20ABI%20issue%3F/near/477771802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/roc-ray.20possible.20ABI.20issue.3F.html#477771802">(Oct 19 2024 at 04:30)</a>:</h4>
<p>It wont</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
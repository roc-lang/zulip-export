<html>
<head><meta charset="utf-8"><title>Roc Cache discussion - Abomonation serialization · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html">Roc Cache discussion - Abomonation serialization</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="531128558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531128558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Karl <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531128558">(Jul 27 2025 at 12:12)</a>:</h4>
<p>There was a back and forth about CapnProto type compression and whether it'd be faster and I'll chip in that there should be benchmarks on this in rust serialization land. Richard's serialization scheme is abomonation and there's also a rust capnproto implementation. I'm not deeply invested in this area but my memory is that abomonation trounces all the other serialization strategies by a significant margin when things aren't coming over a network.</p>



<a name="531187364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531187364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csg <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531187364">(Jul 27 2025 at 18:15)</a>:</h4>
<p>Sure, but metaphysically what good is a message you can't send to another?</p>
<p>There are a lot of external variables - in particular the size of messages and the rhythm/cadence of the protocol (multi-mesage) interactions that the system produces when normally operating. </p>
<p>Cap'n proto has a "lens" (from haskell) approach on the opaque blob.  I can get you down to the part you want to modify or observe.  The cost for this is loop-detection to guarantee termination on malformed data.</p>
<p>Protocol-buffers completely parse the message into your local language structure.  Protobuf rejects malformed objects at parse.  The costs are a full-traversal and transcoding of the message (at least 1 copy in ram) and needing to work for the entire message to be received before starting parsing.</p>
<p>Cap'n proto would be "infinitely faster" for a moderate sized (1M) protobuf message because our first-scan of the data can be used for our program; not decoding into a different buffer we can also read.</p>
<p>Some of these choices could be a function of the larger system architecture -- if you spent the setup to RDMA or IO_URING to use pre-allocated page-aligned buffers for speed; and then protobuf decode you're hacking around on stuff that works; but you're being quite silly about performance.</p>
<p>The variance of in the interactions between service A &lt;-&gt; service B vary much more fundamentally in size, frequency, and computational cost per message - than these overheads.</p>
<p>I can pontificate on RPC systems all day.  In the hangout - I was only getting 40% signal due to this being my first interaction in the community. <span class="user-mention" data-user-id="281383">@Richard Feldman</span>  can you remind us of the context where you're thinking carefully about the structure packing for ROC ?</p>



<a name="531190320"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531190320" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Karl <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531190320">(Jul 27 2025 at 18:34)</a>:</h4>
<p>In case it wasn't clear from the crate name,  nobody is arguing in favor of abomination for general purpose RPC including the author. It was written to be a fast way to distribute computing across Timely nodes and comes with a whole stack of caveats. I only mention it because the question came up and I'd expect the comparison to be representative.</p>



<a name="531197290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531197290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> csg <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531197290">(Jul 27 2025 at 19:20)</a>:</h4>
<p>I did not parse <code>abomination</code> as code, but as an adjective followed by awkward grammar. <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span> <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="531223192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531223192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531223192">(Jul 27 2025 at 22:18)</a>:</h4>
<blockquote>
<p>Richard's serialization scheme is abomonation and there's also a rust capnproto implementation.</p>
</blockquote>
<p><span class="user-mention" data-user-id="705503">@Karl</span> can you share a link to something I can read about this. I'm interested, but having trouble searching for it.</p>



<a name="531223256"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531223256" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531223256">(Jul 27 2025 at 22:19)</a>:</h4>
<p>Oh, nvm I think I found it... <a href="https://crates.io/crates/abomonation">https://crates.io/crates/abomonation</a></p>



<a name="531223265"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531223265" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Karl <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531223265">(Jul 27 2025 at 22:19)</a>:</h4>
<p>The crate: <a href="https://github.com/TimelyDataflow/abomonation">https://github.com/TimelyDataflow/abomonation</a></p>



<a name="531223347"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531223347" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Karl <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531223347">(Jul 27 2025 at 22:20)</a>:</h4>
<p>If you can find rust serialization benchmarks it shows up relatively often. It's basically the same scheme as Richard outlined.</p>



<a name="531223497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531223497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Karl <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531223497">(Jul 27 2025 at 22:21)</a>:</h4>
<p><a href="https://www.frankmcsherry.org/serialization/2015/05/04/unsafe-at-any-speed.html">https://www.frankmcsherry.org/serialization/2015/05/04/unsafe-at-any-speed.html</a></p>



<a name="531223511"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531223511" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531223511">(Jul 27 2025 at 22:21)</a>:</h4>
<blockquote>
<p><strong>Warning</strong>: Abomonation should not be used on any data you care strongly about, or from any computer you value the data on. The <code>encode</code> and <code>decode</code> methods do things that may be undefined behavior, and you shouldn't stand for that.</p>
</blockquote>
<p>What's that about? I guess it's not relevant for the way we're talking about using it in Roc?</p>



<a name="531223615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531223615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531223615">(Jul 27 2025 at 22:21)</a>:</h4>
<p>10 messages were moved here from <a class="stream-topic" data-stream-id="303057" href="/#narrow/channel/303057-gatherings/topic/Roc.20Online.20Meetup.20Jul.202025/with/531017977">#gatherings &gt; Roc Online Meetup Jul 2025</a> by <span class="user-mention silent" data-user-id="515757">Luke Boswell</span>.</p>



<a name="531224060"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531224060" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Karl <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531224060">(Jul 27 2025 at 22:25)</a>:</h4>
<p>The blog post I just linked outlines the reasons but the brief part is that in-memory representation isn't a reliable format for something that can wind up on machines with different architectures. It also can't handle versioning and whatnot. Basically it's reasonable enough if you're running the same software on the same CPU architecture and otherwise you're in undefined behavior and there are no guardrails for any of this.</p>



<a name="531224818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531224818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531224818">(Jul 27 2025 at 22:30)</a>:</h4>
<p>in this specific case the only relevant distinction between machines would be 32-bit vs 64-bit pointers</p>



<a name="531225103"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531225103" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531225103">(Jul 27 2025 at 22:32)</a>:</h4>
<p>we could prevent that if we wanted to by padding our ~20 pointers with zeros on 32-bit targets (so, just wasm32) which would mean the cache files could be generated on a 64-bit system and then used in wasm32 builds of the compiler</p>



<a name="531225185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531225185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531225185">(Jul 27 2025 at 22:33)</a>:</h4>
<p>I thought about this but it didn't seem worth doing right now since I couldn't think of a use for it, plus we can kinda do it whenever we want to later if desired</p>



<a name="531226919"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531226919" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531226919">(Jul 27 2025 at 22:46)</a>:</h4>
<p>I'm really fascinated by this idea of compiling on my machine and sending the ModuleEnv over the network for a host running in the cloud, potentially a WASM runtime.</p>



<a name="531229127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531229127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531229127">(Jul 27 2025 at 23:01)</a>:</h4>
<p>Like I'm wondering if we could use this for hot-reloading something like basic-dom?</p>



<a name="531229135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531229135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531229135">(Jul 27 2025 at 23:01)</a>:</h4>
<p>well it's pretty straightforward to do that if we want to</p>



<a name="531229875"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531229875" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531229875">(Jul 27 2025 at 23:06)</a>:</h4>
<p>I'm definitely leaning towards we should do this now, while we have the context loaded and are testing it etc. Such an incredible capability.</p>



<a name="531230366"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Roc%20Cache%20discussion%20-%20Abomonation%20serialization/near/531230366" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Roc.20Cache.20discussion.20-.20Abomonation.20serialization.html#531230366">(Jul 27 2025 at 23:10)</a>:</h4>
<p>ok I'll make a pr for it tonight or tomorrow prob</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
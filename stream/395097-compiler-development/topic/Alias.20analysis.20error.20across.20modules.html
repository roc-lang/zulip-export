<html>
<head><meta charset="utf-8"><title>Alias analysis error across modules · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html">Alias analysis error across modules</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="436126715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436126715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436126715">(Apr 29 2024 at 19:50)</a>:</h4>
<p>We are looking at this example (from <a href="https://github.com/roc-lang/roc/issues/5701#issuecomment-2016888604">https://github.com/roc-lang/roc/issues/5701#issuecomment-2016888604</a>) of an alias analysis error.</p>
<div class="codehilite"><pre><span></span><code># Main.roc
interface Main
    exposes []
    imports [Helper]

expect
    _ = Helper.f (loop {})
    1 == 1

loop = \{} -&gt;
    Helper.foobar \_ -&gt;
        if Bool.true then
            loop {}
        else
            \_ -&gt; {}
</code></pre></div>
<div class="codehilite"><pre><span></span><code># Helper.roc
interface Helper
    exposes [f, foobar]
    imports []

f : ({} -&gt; {}) -&gt; {}
f = \_ -&gt; {}

foobar : ({} -&gt; ({} -&gt; {})) -&gt; ({} -&gt; {})
foobar = \fn -&gt; \_ -&gt; (fn {}) {}
</code></pre></div>
<p>run</p>
<div class="codehilite"><pre><span></span><code>roc test Main.roc
</code></pre></div>
<p>What happens here is that <code>Main.roc</code> will call <code>foobar</code> with a particular LayoutId (really a <code>([LayoutId, Niche, LayoutId)</code>), say <code>foobar#32</code>. It will also ask <code>Helper</code> to generate an implementation of <code>foobar</code> for the particular type at the call site. <code>Helper</code> will do so, but gives it another name, e.g. <code>foobar#33</code>. This wil now fail with an alias analysis error because <code>loop</code> calls a function that does not exist.</p>
<p>So, in effect, the same type gets two different layout ids. That causes problems down the line. We need to somehow guarantee that both parent and child module use the same LayoutId at both the definition and call site.</p>
<p>When we put all definitions in the same module, it works. So something fails to translate between modules.</p>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> any idea for how how to track this down? We've tried printing a bunch of things but it's not really telling us much besides confirming the above diagnosis </p>
<p>cc <span class="user-mention" data-user-id="281383">@Richard Feldman</span></p>



<a name="436146424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436146424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436146424">(Apr 29 2024 at 21:51)</a>:</h4>
<p>yeah, i don't really know how we solve this problem in general</p>



<a name="436146578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436146578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436146578">(Apr 29 2024 at 21:52)</a>:</h4>
<p>i think i discussed this before, let me see if i can find earlier notes</p>



<a name="436146942"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436146942" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436146942">(Apr 29 2024 at 21:55)</a>:</h4>
<p>this is one reason this issue can happen: <a href="https://github.com/roc-lang/roc/issues/5464#issuecomment-1631583439">https://github.com/roc-lang/roc/issues/5464#issuecomment-1631583439</a>. As i mention there i have no idea how to fix it</p>



<a name="436147559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436147559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436147559">(Apr 29 2024 at 22:00)</a>:</h4>
<p>I fixed this a while ago for some structural types via "fixpoint fixing", which during unifications finds if there are types that are isomorphic but whose fixpoint is not equivalent (e.g. <a href="#narrow/stream/231635-compiler-development-.28private.29/topic/.E2.9C.94.20alias.20references.20to.20mutually.20recursive.20types/near/300843640">https://roc.zulipchat.com/#narrow/stream/231635-compiler-development-.28private.29/topic/.E2.9C.94.20alias.20references.20to.20mutually.20recursive.20types/near/300843640</a>). It's possible that if the type is cloned across modules, its appearance in the new module causes it to get fixpoint-fixed again into a form that produces a different layout (i.e. different fixpoint) in the new module.</p>



<a name="436148541"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436148541" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436148541">(Apr 29 2024 at 22:06)</a>:</h4>
<p>this is truly the curse of structural types. Maybe we need some way to "lock" the structure of a type once it gets exported?</p>



<a name="436148549"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436148549" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436148549">(Apr 29 2024 at 22:06)</a>:</h4>
<p>I'm not sure</p>



<a name="436179860"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436179860" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436179860">(Apr 30 2024 at 02:42)</a>:</h4>
<p>if performance were no concern, is there any sort of "brute force" solution that would be comically inefficient but get the right answer?</p>



<a name="436182560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436182560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436182560">(Apr 30 2024 at 03:06)</a>:</h4>
<p>"locking" as mentioned above would solve it</p>



<a name="436182589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436182589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436182589">(Apr 30 2024 at 03:06)</a>:</h4>
<p>i.e. don't allow the type to change after it's exported, all other types must unify to it exactly</p>



<a name="436240019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436240019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436240019">(Apr 30 2024 at 10:27)</a>:</h4>
<p>but that changes semantics right? Like some programs wouldn't compile anymore</p>



<a name="436240065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436240065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436240065">(Apr 30 2024 at 10:28)</a>:</h4>
<p>or rather, they wouldn't type-check anymore, when today they would</p>



<a name="436264459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436264459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436264459">(Apr 30 2024 at 12:50)</a>:</h4>
<p>why wouldn’t they?</p>



<a name="436269256"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436269256" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436269256">(Apr 30 2024 at 13:14)</a>:</h4>
<p>I might be misunderstanding the implications of this: <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> </p>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules/near/436182589">said</a>:</p>
<blockquote>
<p>i.e. don't allow the type to change after it's exported, all other types must unify to it exactly</p>
</blockquote>
<p>it sounds like "all other types must unify to it exactly" means that there would be some scenario(s) where a type gets less polymorphic</p>



<a name="436269416"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436269416" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436269416">(Apr 30 2024 at 13:15)</a>:</h4>
<p>like today it would be allowed to unify into a different type which later successfully unifies with other types, but instead it would refuse to unify into that other type, and therefore might have a type mismatch with other types later</p>



<a name="436269456"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436269456" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436269456">(Apr 30 2024 at 13:15)</a>:</h4>
<p>but maybe I'm misunderstanding the implications there!</p>



<a name="436446931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436446931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436446931">(May 01 2024 at 04:24)</a>:</h4>
<p>is there a case where a type gets imported from a module and doesn't become less, or equivalently, polymorphic?</p>



<a name="436446969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436446969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436446969">(May 01 2024 at 04:24)</a>:</h4>
<p>i guess the crux of my point is that once you find a location of a recursionpointer in a type, you must decide whether that recursionpointer's location is allowed to change in the future or not.</p>



<a name="436446982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436446982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436446982">(May 01 2024 at 04:25)</a>:</h4>
<p>if the type is unique in the sense that nothing else has unified with it, it's fine for it to change.</p>



<a name="436447003"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436447003" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436447003">(May 01 2024 at 04:25)</a>:</h4>
<p>but if it's not unique (e.g. exported to another module), it cannot change without running into the bug here.</p>



<a name="436447014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/436447014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#436447014">(May 01 2024 at 04:25)</a>:</h4>
<p>so finding some way to encode/enforce that would be the fix.</p>



<a name="438195659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438195659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438195659">(May 12 2024 at 16:28)</a>:</h4>
<p>I'd love to try this out, and I'll actually have a week off after I get back from Milan, but I have no idea where to start with the implementation <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="438195672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438195672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438195672">(May 12 2024 at 16:29)</a>:</h4>
<p>any suggestions for how to go about doing this?</p>



<a name="438196320"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438196320" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438196320">(May 12 2024 at 16:39)</a>:</h4>
<p>yeah, so it's probably most useful to start here with the definitions of recursive types:<br>
<a href="https://github.com/roc-lang/roc/blob/e500d664fdd5b79b004ec5be4614424557b67425/crates/compiler/types/src/subs.rs#L2362-L2366">https://github.com/roc-lang/roc/blob/e500d664fdd5b79b004ec5be4614424557b67425/crates/compiler/types/src/subs.rs#L2362-L2366</a></p>
<p>and how fixpoint fixing works</p>
<p><a href="https://github.com/roc-lang/roc/blob/e500d664fdd5b79b004ec5be4614424557b67425/crates/compiler/unify/src/fix.rs#L14">https://github.com/roc-lang/roc/blob/e500d664fdd5b79b004ec5be4614424557b67425/crates/compiler/unify/src/fix.rs#L14</a></p>



<a name="438196409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438196409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438196409">(May 12 2024 at 16:40)</a>:</h4>
<p>im realizing though this may be hard more difficult than it might seem though</p>



<a name="438196437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438196437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438196437">(May 12 2024 at 16:41)</a>:</h4>
<p>if there are two recursive types that are isomorphic but not equal, imported from two different modules into the same module M, then when we compare them in M, it may be impossible to reconcile them into the same type</p>



<a name="438196553"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438196553" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438196553">(May 12 2024 at 16:43)</a>:</h4>
<p>yeah okay i don't know how to deal with that without breaking module isolation for typechecking, lol</p>



<a name="438196616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438196616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438196616">(May 12 2024 at 16:44)</a>:</h4>
<p>or compiling all recursive types as boxed at every level</p>



<a name="438197013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438197013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438197013">(May 12 2024 at 16:50)</a>:</h4>
<p>to put the problem concretely: suppose we have modules A and B both importing the definitions</p>
<div class="codehilite"><pre><span></span><code>F : [FromG G]
G : [G {lst : List F}]

# the unfurled representation of these types is
# F = [FromG [G {lst: List &lt;1&gt;}] as &lt;1&gt;
# G = [G {lst: List [FromG &lt;2&gt;]}] as &lt;2&gt;
# where &lt;1&gt;, &lt;2&gt; are recursion pointers
</code></pre></div>
<p>both expose <code>val</code> where</p>
<div class="codehilite"><pre><span></span><code># module A
val : F
val = FromG (G {lst: []})

# module B
val : G
val = G {lst: []}
</code></pre></div>
<p>now you import both in module C and do a comparison</p>
<div class="codehilite"><pre><span></span><code>A.val == (FromG B.val)
</code></pre></div>
<p>In C we are comparing</p>
<div class="codehilite"><pre><span></span><code>A.val : [FromG [G {lst: List &lt;1&gt;}] as &lt;1&gt;
to
(FromG B.val) :  [FromG [G {lst: List [FromG &lt;2&gt;]}] as &lt;2&gt;]
</code></pre></div>
<p>which typechecks because these types are clearly isomorphic. But their layouts are not the same. And we cannot change the type of either <code>A.val</code> or <code>B.val</code> to be equal to the other's type without also changing the types in module <code>A</code> and <code>B</code>, respectively.</p>



<a name="438198327"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198327" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198327">(May 12 2024 at 17:12)</a>:</h4>
<p>ugh. if we break module isolation, incremental compilation will become very difficult in the future.</p>



<a name="438198365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198365">(May 12 2024 at 17:13)</a>:</h4>
<p>can we not make <code>F</code> and <code>G</code> structurally the same in the defining module?</p>



<a name="438198485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198485">(May 12 2024 at 17:14)</a>:</h4>
<p>we could, but suppose it was instead</p>
<div class="codehilite"><pre><span></span><code>F : [FromG G_]
G_ : [G {lst : List F}]

F_ : [FromG G]
G : [G {lst : List F_}]
</code></pre></div>
<p>now F and G are not related in the defining module but <code>[FromG G]</code> is still isomorphic to <code>F</code></p>



<a name="438198637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198637">(May 12 2024 at 17:17)</a>:</h4>
<p>hmm yes</p>



<a name="438198720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198720">(May 12 2024 at 17:18)</a>:</h4>
<p>I'll run this by some ocaml people</p>



<a name="438198729"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198729" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198729">(May 12 2024 at 17:18)</a>:</h4>
<p>also even in the earlier example <code>F</code> and <code>G</code> could be defined in distinct modules (with slight modifications), right?</p>



<a name="438198733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198733">(May 12 2024 at 17:18)</a>:</h4>
<p>yeah</p>



<a name="438198737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198737">(May 12 2024 at 17:18)</a>:</h4>
<p>because this is all about structural equality</p>



<a name="438198747"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198747" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198747">(May 12 2024 at 17:18)</a>:</h4>
<p>yeah, exactly</p>



<a name="438198764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438198764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438198764">(May 12 2024 at 17:19)</a>:</h4>
<p>the curse of structural recursion with unboxed compilation. maybe this is why everyone uses nominal types</p>



<a name="438199058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199058">(May 12 2024 at 17:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules/near/438198327">said</a>:</p>
<blockquote>
<p>ugh. if we break module isolation, incremental compilation will become very difficult in the future.</p>
</blockquote>
<p>is that necessarily true if this is the only way we break it?</p>



<a name="438199106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199106">(May 12 2024 at 17:24)</a>:</h4>
<p>for example, if what we cache is "these are the resolved type annotations, but they can be modified further later"</p>



<a name="438199127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199127">(May 12 2024 at 17:24)</a>:</h4>
<p>I guess we potentially have to load a lot more from disk if we need all the subs</p>



<a name="438199134"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199134" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199134">(May 12 2024 at 17:24)</a>:</h4>
<p>i think the dependency graph becomes a mess, because it is no longer is DAG</p>



<a name="438199163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199163">(May 12 2024 at 17:25)</a>:</h4>
<p>If you had the graph <code>A -&gt; C &lt;- B</code>, where C depends on both A and B as in the example above, a change in A now can force a change in B</p>



<a name="438199170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199170">(May 12 2024 at 17:25)</a>:</h4>
<p>hm true</p>



<a name="438199230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199230">(May 12 2024 at 17:26)</a>:</h4>
<p>ok crazy idea. recursive types must be nominal</p>



<a name="438199261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199261">(May 12 2024 at 17:27)</a>:</h4>
<p>this is potentially a can of worms, but probably worth considering</p>



<a name="438199275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199275">(May 12 2024 at 17:27)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> what about "exposed types must be annotated" instead?</p>



<a name="438199276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199276">(May 12 2024 at 17:27)</a>:</h4>
<p>like to expose them from a module</p>



<a name="438199331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199331">(May 12 2024 at 17:28)</a>:</h4>
<p>we still have the same problem though right? For example if <code>val</code> is annotated as F and G accordingly in both modules A and B in the example above.</p>



<a name="438199369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199369">(May 12 2024 at 17:29)</a>:</h4>
<p>yeah true</p>



<a name="438199382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199382">(May 12 2024 at 17:29)</a>:</h4>
<p>so in other words they can only be recursive if they're opaque</p>



<a name="438199450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199450">(May 12 2024 at 17:30)</a>:</h4>
<p>yes. the idea being that the name of the opaque type forces one representation of the type, and hence one layout</p>



<a name="438199476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199476">(May 12 2024 at 17:30)</a>:</h4>
<p>interesting!</p>



<a name="438199484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199484">(May 12 2024 at 17:30)</a>:</h4>
<p>can we think of cases where this would cause problems?</p>



<a name="438199597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199597">(May 12 2024 at 17:33)</a>:</h4>
<p>yeah, there's certainly some issues to figure out with that approach though. A couple off the top of my head:</p>
<ul>
<li>How do you generate error messages for types that are structurally recursive? It may not be obvious to the implementor that they are.</li>
<li>How do we make something like the following work?</li>
</ul>
<div class="codehilite"><pre><span></span><code>Op := # my opaque recursive definition

eq = \@Op ob1, @Op ob2 -&gt; ob1.fieldA == ob2.fieldA &amp;&amp; ob1.fieldB == ob2.fieldB
</code></pre></div>
<p>inside this definition, the field accesses are structural and recursive, which we've disallowed. So some language rule to allow this needs to be defined.</p>



<a name="438199703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199703">(May 12 2024 at 17:34)</a>:</h4>
<p>Actually the second might have an easy solution - if the recursion point is named by an opaque type it's fine.</p>



<a name="438199711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199711">(May 12 2024 at 17:35)</a>:</h4>
<p>but this needs a design doc</p>



<a name="438199793"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438199793" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438199793">(May 12 2024 at 17:36)</a>:</h4>
<p>I'm very hype about this direction! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="438200142"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200142" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200142">(May 12 2024 at 17:43)</a>:</h4>
<p>it seems like it would come up relatively rarely, and existing cases of "recursion has to happen behind an opaque type" haven't felt like a big burden</p>



<a name="438200148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200148">(May 12 2024 at 17:43)</a>:</h4>
<p>more of a surprise than anything</p>



<a name="438200365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200365">(May 12 2024 at 17:46)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> are you up for writing a design doc on this?</p>



<a name="438200370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200370">(May 12 2024 at 17:46)</a>:</h4>
<p>yeah i can</p>



<a name="438200457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200457">(May 12 2024 at 17:48)</a>:</h4>
<p>awesome, thank you so much!</p>



<a name="438200477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200477">(May 12 2024 at 17:48)</a>:</h4>
<p>it would be so huge to have this working</p>



<a name="438200507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200507">(May 12 2024 at 17:49)</a>:</h4>
<p>huh, I guess morphic doesn't have this problem because it's a separate pass</p>



<a name="438200609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200609">(May 12 2024 at 17:50)</a>:</h4>
<p>maybe that's a relevant difference in correctness between doing it during type checking vs in a separate pass</p>



<a name="438200650"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200650" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200650">(May 12 2024 at 17:50)</a>:</h4>
<p>morphic only has nominal types</p>



<a name="438200659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200659">(May 12 2024 at 17:51)</a>:</h4>
<p>for recursive defs anyway</p>



<a name="438200673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200673">(May 12 2024 at 17:51)</a>:</h4>
<p>ha, til!</p>



<a name="438200683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200683">(May 12 2024 at 17:51)</a>:</h4>
<p>but a separate pass would also fix the problem, right?</p>



<a name="438200731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200731">(May 12 2024 at 17:52)</a>:</h4>
<p>because then "revisiting modules" wouldn't be a problem</p>



<a name="438200743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200743">(May 12 2024 at 17:52)</a>:</h4>
<p>yes, but it would need a whole-program analysis</p>



<a name="438200754"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200754" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200754">(May 12 2024 at 17:52)</a>:</h4>
<p>i.e. you would still need to examine all modules, i think</p>



<a name="438200764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200764">(May 12 2024 at 17:52)</a>:</h4>
<p>to find all instances of a type and produce one canonical form</p>



<a name="438200868"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200868" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200868">(May 12 2024 at 17:54)</a>:</h4>
<p>right</p>



<a name="438200908"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200908" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200908">(May 12 2024 at 17:55)</a>:</h4>
<p>yeah not saying it's the right design, just something I hadn't thought of until now</p>



<a name="438200943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438200943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438200943">(May 12 2024 at 17:56)</a>:</h4>
<p>requiring opaque types feels like the better design to proceed with</p>



<a name="438206802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438206802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438206802">(May 12 2024 at 19:31)</a>:</h4>
<p>I can't think of a reason this would be a problem, but if you define the opaque type as <code>:= _</code> does that reintroduce any issues because its (recursive) structure is being completely inferred?</p>



<a name="438206906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438206906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438206906">(May 12 2024 at 19:33)</a>:</h4>
<p>i’m not sure but it probably does introduce complexity</p>



<a name="438207601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438207601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438207601">(May 12 2024 at 19:45)</a>:</h4>
<p>worth thinking though I guess, since that's definitely a thing that can happen today!</p>



<a name="438208045"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208045" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208045">(May 12 2024 at 19:54)</a>:</h4>
<p>huh? writing <code>O := _</code>?</p>



<a name="438208052"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208052" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208052">(May 12 2024 at 19:54)</a>:</h4>
<p>pretty sure that's not allowed</p>



<a name="438208290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208290">(May 12 2024 at 19:59)</a>:</h4>
<p>it's allowed today!</p>



<a name="438208403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208403">(May 12 2024 at 20:00)</a>:</h4>
<p>and even if it weren't, if it turned out that was a problem, you'd probably have to disallow <code>_</code> from appearing in there at all, including in any type aliases it references - since type aliases can also be defined with <code>_</code> today</p>



<a name="438208605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208605">(May 12 2024 at 20:03)</a>:</h4>
<p>that said, I'm open to disallowing <code>_</code> in opaque type and/or type alias declarations if necessary to fix this (since they're allowed today but don't seem to be used significantly in practice)</p>



<a name="438208720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208720">(May 12 2024 at 20:05)</a>:</h4>
<div class="codehilite"><pre><span></span><code>── UNBOUND TYPE VARIABLE ─────────────────────────────────────────────── B.roc ─

The definition of O has an unbound type variable:

3│  O := _
         ^

Tip: Type variables must be bound before the :=. Perhaps you intended
to add a type parameter to this type?
</code></pre></div>



<a name="438208727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208727">(May 12 2024 at 20:05)</a>:</h4>
<p>Am I doing this wrong?</p>



<a name="438208758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208758">(May 12 2024 at 20:05)</a>:</h4>
<div class="codehilite"><pre><span></span><code>interface B exposes [] imports []

O := _

f = \@O x -&gt; x + 1

expect
    f (@O 1) == 2
</code></pre></div>
<p>this program doesn't compile for me</p>



<a name="438208854"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208854" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208854">(May 12 2024 at 20:07)</a>:</h4>
<p>pretty sure type aliases also can't have <code>_</code></p>
<div class="codehilite"><pre><span></span><code>── UNBOUND TYPE VARIABLE in B.roc ──────────────────────────────────────────────

The definition of O has an unbound type variable:

3│  O : _
        ^

Tip: Type variables must be bound before the :. Perhaps you intended
to add a type parameter to this type?
</code></pre></div>



<a name="438208997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438208997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438208997">(May 12 2024 at 20:09)</a>:</h4>
<p>Allowing <code>_</code> in type aliases would have a few UX problems too</p>



<a name="438209079"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438209079" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438209079">(May 12 2024 at 20:10)</a>:</h4>
<p>huh, I'm on mobile and the online repl accepted it <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="438209193"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438209193" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438209193">(May 12 2024 at 20:13)</a>:</h4>
<p>seems like a bug. im pretty sure this isn't allowed. even if it is, i think we should revisit ever supporting this</p>



<a name="438209301"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438209301" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438209301">(May 12 2024 at 20:14)</a>:</h4>
<p>looks like the repl is deferring evaluation. if you use</p>
<p>O := _</p>
<p>f = \@O x -&gt; x + 1</p>
<p>f (@O 1)</p>
<p>you'll see it errors out</p>



<a name="438209629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438209629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438209629">(May 12 2024 at 20:20)</a>:</h4>
<p>ahh gotcha</p>



<a name="438209649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438209649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438209649">(May 12 2024 at 20:20)</a>:</h4>
<p>yeah I guess we should give an error for this at the parsing stage then</p>



<a name="438209657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438209657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438209657">(May 12 2024 at 20:20)</a>:</h4>
<p>for both opaque type and type alias declarations</p>



<a name="438210126"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438210126" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438210126">(May 12 2024 at 20:28)</a>:</h4>
<p>should ability declarations also disallow it?</p>



<a name="438210432"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438210432" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438210432">(May 12 2024 at 20:33)</a>:</h4>
<p>I'm gonna add an explicit error for it</p>



<a name="438210997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438210997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438210997">(May 12 2024 at 20:43)</a>:</h4>
<p>yes, let's disallow it in abilities too</p>



<a name="438211934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438211934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438211934">(May 12 2024 at 21:00)</a>:</h4>
<p>I posted a simpler, single file reduction in the issue <a href="https://github.com/roc-lang/roc/issues/5701#issuecomment-2106372599">here</a>.</p>
<div class="codehilite"><pre><span></span><code>app [main] {
    pf: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/0.10.0/vNe6s9hWzoTZtFmNkvEICPErI9ptji_ySjicO6CkucY.tar.br&quot;,
}

import pf.Stdout
import pf.Task exposing [Task]

First : {}
Second : First {}

main =
    testFunc {}

testFunc : Second -&gt; Task {} [StdoutErr Stdout.Err]
testFunc = \{} -&gt;
    Stdout.line &quot;123&quot;
</code></pre></div>



<a name="438212038"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438212038" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438212038">(May 12 2024 at 21:02)</a>:</h4>
<p>It looks (without compiler analysis) that we generate a layout for <code>First</code>, think <code>Second</code> has the same layout, but don't pass <code>First</code>'s layout to the generated <code>Task</code></p>



<a name="438212044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438212044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438212044">(May 12 2024 at 21:02)</a>:</h4>
<p>That's just a guess though</p>



<a name="438212076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438212076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438212076">(May 12 2024 at 21:03)</a>:</h4>
<p>Sorry to interrupt discussion, just figured there's more visibility on Zulip</p>



<a name="438221270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438221270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438221270">(May 12 2024 at 23:58)</a>:</h4>
<p>Thanks for the note Sam. Unfortunately I think that issue is different and the bug is that <code>Second : First {}</code> isn't caught as a type error; if I change it to <code>Second : First</code>, the program compiles.</p>



<a name="438247665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438247665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438247665">(May 13 2024 at 05:43)</a>:</h4>
<p>Yes, that's true. Good to know</p>



<a name="438383447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438383447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438383447">(May 13 2024 at 14:56)</a>:</h4>
<p>btw is this related to <a href="https://github.com/roc-lang/roc/issues/5464#issuecomment-1631583439">https://github.com/roc-lang/roc/issues/5464#issuecomment-1631583439</a> or is that a separate issue?</p>



<a name="438383614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438383614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438383614">(May 13 2024 at 14:57)</a>:</h4>
<p>That's a separate issue</p>



<a name="438500819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438500819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438500819">(May 14 2024 at 04:46)</a>:</h4>
<p>Document for consideration on this issue: <a href="https://github.com/roc-lang/rfcs/pull/1">https://github.com/roc-lang/rfcs/pull/1</a>. Feedback appreciated from everyone.</p>



<a name="438670162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438670162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438670162">(May 14 2024 at 22:25)</a>:</h4>
<p>Wow... That's super thorough and impressive! <br>
As to your proposed solution of using opaque types. I think it is another example of the fact that opaque types kind of come in two forms "types I wish to hide the implementation of" and "types I need the features of opaque types for (see some of the discussion on Json decoding and enum types)". <br>
I do think the current setup is unergonomic for those second class of types because I generally don't actually want them to be "opaque" </p>
<p>In my own codebase I tested out implementing <code>from</code> and <code>to</code> abilities for opaque types that I wnated to be less opaque. eg: <code>when from myopaqueType  is</code></p>
<p>In summary. My only concern with solution 1 is reduced ergonomics, but I think that is already an issue that needs to be investigated.</p>



<a name="438671131"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/438671131" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#438671131">(May 14 2024 at 22:32)</a>:</h4>
<p>Thanks for the feedback Eli!</p>



<a name="439660641"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439660641" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439660641">(May 20 2024 at 19:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="651372">Eli Dowling</span> <a href="#narrow/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules/near/438670162">said</a>:</p>
<blockquote>
<p>I think it is another example of the fact that opaque types kind of come in two forms "types I wish to hide the implementation of" and "types I need the features of opaque types for (see some of the discussion on Json decoding and enum types)". <br>
I do think the current setup is unergonomic for those second class of types because I generally don't actually want them to be "opaque"</p>
</blockquote>
<p>I know this has come up before, but personally I really hope we can avoid introducing "nominal but not opaque types" to the language</p>



<a name="439660851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439660851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439660851">(May 20 2024 at 19:08)</a>:</h4>
<p>that said, I just realized that this solution to the problem will create a different (much smaller) problem: I think it's important for multiple reasons that we disallow sending opaque types across the host boundary (in either direction), and this will mean that it would be disallowed to send recursive types to or from the host</p>



<a name="439661005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439661005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439661005">(May 20 2024 at 19:09)</a>:</h4>
<p>obviously it would be ideal to not have that limitation somehow, but like I said, I really would prefer not to introduce the language feature of nominal types that are not opaque <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="439665235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439665235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439665235">(May 20 2024 at 19:33)</a>:</h4>
<p>so we tried the solution of making task an opaque type, but that does not (yet) work either. This code</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">interface</span><span class="w"> </span><span class="kt">Task</span>
<span class="w">    </span><span class="nv">exposes</span><span class="w"> </span><span class="p">[</span><span class="kt">Task</span><span class="p">,</span><span class="w"> </span><span class="nv">stdoutLine</span><span class="p">,</span><span class="w"> </span><span class="kt">Op</span><span class="p">]</span>
<span class="w">    </span><span class="nv">imports</span><span class="w"> </span><span class="p">[]</span>

<span class="kt">Op</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="kt">StdoutLine</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">(</span><span class="kt">Box</span><span class="w"> </span><span class="p">({}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Op</span><span class="p">)),</span>
<span class="w">    </span><span class="kt">StdinLine</span><span class="w"> </span><span class="p">(</span><span class="kt">Box</span><span class="w"> </span><span class="p">(</span><span class="kt">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Op</span><span class="p">)),</span>
<span class="w">    </span><span class="kt">None</span><span class="p">,</span>
<span class="p">]</span>

<span class="kt">Task</span><span class="w"> </span><span class="nv">ok</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="nf">:=</span><span class="w"> </span><span class="p">(</span><span class="kt">Result</span><span class="w"> </span><span class="nv">ok</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Op</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Op</span>

<span class="nv">stdoutLine</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nv">a</span>
<span class="nv">stdoutLine</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">line</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">helper</span><span class="nf">:</span><span class="w"> </span><span class="p">((</span><span class="kt">Result</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nv">a</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Op</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Op</span>
<span class="w">    </span><span class="nv">helper</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nf">\</span><span class="nv">fromResult</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">StdoutLine</span><span class="w"> </span><span class="nv">line</span><span class="w"> </span><span class="p">(</span><span class="kt">Box</span><span class="nf">.</span><span class="nv">box</span><span class="w"> </span><span class="nf">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">fromResult</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="p">{}))</span>

<span class="w">    </span><span class="err">@</span><span class="kt">Task</span><span class="w"> </span><span class="nv">helper</span>
</code></pre></div>
<p>gives this error with <code>cargo run -- check examples/platform-switching/rust-platform/Task.roc</code></p>
<div class="codehilite"><pre><span></span><code>── CIRCULAR TYPE in examples/platform-switching/rust-platform/Task.roc ─────────

I&#39;m inferring a weird self-referential type for stdoutLine:

14│&gt;  stdoutLine = \line -&gt;
15│&gt;      helper: ((Result {} a) -&gt; Op) -&gt; Op
16│&gt;      helper =
17│&gt;          # crash &quot;foo&quot;
18│&gt;          \fromResult -&gt; StdoutLine line (Box.box \{} -&gt; fromResult (Ok {}))
19│&gt;
20│&gt;      @Task helper

Here is my best effort at writing down the type. You will see ∞ for
parts of the type that repeat something already printed out
infinitely.

    Str -&gt; Task {} a
</code></pre></div>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> this is no longer a module crossing problem now, is what we observe here entirely different from the original problem we're trying to solve here?</p>



<a name="439668215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439668215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439668215">(May 20 2024 at 19:52)</a>:</h4>
<p>yes that seems different</p>



<a name="439668294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439668294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439668294">(May 20 2024 at 19:53)</a>:</h4>
<p>try making Op opaque too</p>



<a name="439668600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439668600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439668600">(May 20 2024 at 19:55)</a>:</h4>
<p>right, we tried that next </p>
<div class="codehilite"><pre><span></span><code>Op := [
    StdoutLine ({} -&gt; Op),
    StdinLine ({} -&gt; Op),
    None,
]

Task := ({} -&gt; Op) -&gt; Op

stdoutLine : Task
stdoutLine =
    helper: ({} -&gt; Op) -&gt; Op
    helper =
        \fromResult -&gt; @Op (StdoutLine ((\{} -&gt; fromResult {})))

    @Task helper
</code></pre></div>



<a name="439668698"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439668698" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439668698">(May 20 2024 at 19:55)</a>:</h4>
<p>gives</p>
<div class="codehilite"><pre><span></span><code>── CIRCULAR TYPE in examples/platform-switching/rust-platform/Task.roc ─────────

I&#39;m inferring a weird self-referential type for stdoutLine:

14│  stdoutLine =
     ^^^^^^^^^^

Here is my best effort at writing down the type. You will see ∞ for
parts of the type that repeat something already printed out
infinitely.

    Task
</code></pre></div>



<a name="439668733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439668733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439668733">(May 20 2024 at 19:55)</a>:</h4>
<p>hm</p>



<a name="439668787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439668787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439668787">(May 20 2024 at 19:55)</a>:</h4>
<p>will take a look in a minute</p>



<a name="439669864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439669864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439669864">(May 20 2024 at 20:00)</a>:</h4>
<p>this is some kind of bug in the occurs checking</p>



<a name="439669982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439669982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439669982">(May 20 2024 at 20:00)</a>:</h4>
<p>if you remove the annotation on stdoutLine it works for me</p>



<a name="439670011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439670011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439670011">(May 20 2024 at 20:00)</a>:</h4>
<p>well, it typechecks at least</p>



<a name="439671403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439671403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439671403">(May 20 2024 at 20:09)</a>:</h4>
<div class="codehilite"><pre><span></span><code>interface B exposes [main] imports []

# Task.roc
Task v op := (v -&gt; op) -&gt; op

await : Task a op, (a -&gt; Task b op) -&gt; Task b op
await = \@Task fromResult, next -&gt;
    @Task \continue -&gt;
        fromResult \result -&gt;
            @Task inner = next result
            inner continue

# StdinEffect.roc
OpIn a b : [
    StdinLine (Str -&gt; OpIn a b),
    Done a,
]b

# Stdin.roc
lineIn : Task Str (OpIn * *)
lineIn = @Task \toNext -&gt; StdinLine \s -&gt; (toNext s)

# StdoutEffect.roc
OpOut a b : [
    StdoutLine Str ({} -&gt; OpOut a b),
    Done a,
]b

# Stdout.roc
lineOut : Str -&gt; Task {} (OpOut * *)
lineOut = \s -&gt; @Task \toNext -&gt; StdoutLine s \{} -&gt; (toNext {})

# Platform
# really, we want a syntax like [Done a](OpIn a)(OpOut a) here
Op a : [
    StdinLine (Str -&gt; Op a),
    StdoutLine Str ({} -&gt; Op a),
    Done a,
]

main : Task {} (Op *)
main =
    lineIn
    |&gt; await \s -&gt; lineOut s
</code></pre></div>



<a name="439671717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439671717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439671717">(May 20 2024 at 20:11)</a>:</h4>
<div class="codehilite"><pre><span></span><code>interface B exposes [stdoutLine] imports []

Op := [
    StdinLine (Str -&gt; Op),
    StdoutLine Str ({} -&gt; Op),
    Done,
]

Task := ({} -&gt; Op) -&gt; Op

stdoutLine =
    @Task \fromResult -&gt; @Op (StdoutLine &quot;foo&quot; (\{} -&gt; fromResult {}))
</code></pre></div>



<a name="439721904"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439721904" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439721904">(May 21 2024 at 03:03)</a>:</h4>
<p>Okay, I suggest as a path forward here:<br>
-Remove lambda sets in favor of erasure, at least for the time being<br>
-Remove anonymous recursive types as described above, or at least severely restrict them</p>



<a name="439722258"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439722258" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439722258">(May 21 2024 at 03:06)</a>:</h4>
<p>I know this has various downsides including runtime performance. But lambda sets can be added later, in a separate pass. This will temporarily push Roc further away from its end goals, but I think the goal of making a fast compile-time and runtime language has put the implementation in a position where it’s difficult to recover from these issues we discover only years later. A functional compiler is more useful than a fast one that has bugs. And, without lambda sets or anonymous recursive types, the implementation should be much more approachable to contributors.</p>



<a name="439798505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439798505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439798505">(May 21 2024 at 11:44)</a>:</h4>
<p>but, the erased version also does not work with current examples. Do you know what the problem is there?</p>



<a name="439818529"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439818529" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439818529">(May 21 2024 at 13:33)</a>:</h4>
<p>Almost certainly the problem of recursive types across modules</p>



<a name="439851153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439851153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439851153">(May 21 2024 at 16:04)</a>:</h4>
<p>I was just rereading the doc and I wondered - would the fixpoint fixing work if we delayed it until after typechecking was done? e.g. if we did it during mono, when we’re already revisiting modules</p>



<a name="439856883"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439856883" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439856883">(May 21 2024 at 16:37)</a>:</h4>
<p>You would still need to break module isolation during type inference</p>



<a name="439856971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439856971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439856971">(May 21 2024 at 16:38)</a>:</h4>
<p>because you need to know "what types, across all modules, are in the same strongly-connected components"</p>



<a name="439857672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439857672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439857672">(May 21 2024 at 16:42)</a>:</h4>
<p>gotcha</p>



<a name="439857949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439857949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439857949">(May 21 2024 at 16:43)</a>:</h4>
<p>I really think the goal here should be to simplify, at the cost of the performance, until this works again, and then layer on optimizations as needed</p>



<a name="439862212"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439862212" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439862212">(May 21 2024 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> is breaking that isolation required during type inference, or only in later steps, assuming these steps</p>
<ol>
<li>type inference</li>
<li>type mono</li>
<li>lambda set inference (using graph SSC)</li>
<li>lambda set mono</li>
</ol>
<p>where is the isolation breaking actually required? Intuitively it's only at step 3 that we need it, given the restriction on recursive types that was proposed earlier in this thread</p>



<a name="439863545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439863545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439863545">(May 21 2024 at 17:11)</a>:</h4>
<p>yes, if recursive types must be nominal, then</p>
<ol>
<li>type inference over Can AST. This can happen with module isolation.</li>
<li>type specialization. Let's call this IR MonoTy. All code is combined into one program; there is no longer a module concept in the same way there is no module concept after the Mono IR today.</li>
<li>lambda set inference over MonoTy</li>
<li>lambda set specialization over MonoTy, let's say the new IR is called MonoLam</li>
</ol>



<a name="439863658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439863658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439863658">(May 21 2024 at 17:12)</a>:</h4>
<p>MonoLam = Mono IR today</p>



<a name="439863876"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439863876" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439863876">(May 21 2024 at 17:13)</a>:</h4>
<p>can we not perform step 2 just in subs only (while traversing Can, but not materializing a whole separate AST)?</p>



<a name="439865827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439865827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439865827">(May 21 2024 at 17:25)</a>:</h4>
<p>there is probably a way, but i don't see it quite yet. one complication is abilities. if you do not materialize the call to a specific lambda in the AST you must keep the call information elsewhere. so you would need a lookaside table that associates a type specialization ID + can AST node ID =&gt; ability specialization</p>



<a name="439865909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439865909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439865909">(May 21 2024 at 17:25)</a>:</h4>
<p>this could be an optimization. i suspect it will be easier to implement and debug if it's a separate AST.</p>



<a name="439913488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439913488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439913488">(May 21 2024 at 21:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules/near/439857949">said</a>:</p>
<blockquote>
<p>I really think the goal here should be to simplify, at the cost of the performance, until this works again, and then layer on optimizations as needed</p>
</blockquote>
<p>ok so how would we go about doing this? I remember we'd talked about this before but I don't remember the specific steps it would take <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="439913602"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439913602" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439913602">(May 21 2024 at 21:57)</a>:</h4>
<p>something to do with marking closures as erased maybe?</p>



<a name="439922940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/439922940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#439922940">(May 21 2024 at 22:57)</a>:</h4>
<ol>
<li>Replace lambda sets with type erased closures. This is already implemented for the most part. The missing pieces are reference counting and abilities.</li>
<li>In parallel, the restriction of recursive types to be nominal can be put in place. Folkert and I discussed how to do this. The <code>RecursiveType</code> constructor needs to be adjusted to hold a symbol naming the recursive type. During can, construct recursive types from opaque type definitions as needed. Two recursive types are equal only if their RecursiveType constructors are equal in symbol name, and the arguments to their opaque type unify.<br>
I don't have the bandwidth to implement this myself but I'm happy to provide suggestions or mentorship as needed</li>
</ol>



<a name="440526487"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440526487" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440526487">(May 24 2024 at 14:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules/near/439922940">said</a>:</p>
<blockquote>
<ol>
<li>Replace lambda sets with type erased closures. This is already implemented for the most part. The missing pieces are reference counting and abilities.</li>
</ol>
</blockquote>
<p>ok cool! So where should we look for implementing type-erased closures?</p>



<a name="440526844"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440526844" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440526844">(May 24 2024 at 15:00)</a>:</h4>
<p>more specifically, where does the refcounting need to happen? Could we reuse some logic from <code>Box</code> maybe?</p>



<a name="440526929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440526929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440526929">(May 24 2024 at 15:01)</a>:</h4>
<p>also, what needs to happen with regards to abilities? Normally functions don't have any abilities, but I'm assuming there's some nuance I'm missing there <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="440550972"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440550972" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440550972">(May 24 2024 at 17:37)</a>:</h4>
<p>whe need to generate a function that decrements all captured values I think? and make that accessible such that a <code>dec someClosure</code> calls the corresponding function</p>



<a name="440550977"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440550977" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440550977">(May 24 2024 at 17:37)</a>:</h4>
<p>right?</p>



<a name="440551519"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440551519" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440551519">(May 24 2024 at 17:41)</a>:</h4>
<p>Like with my work for lists, can we make this lazy? Does that make sense here.</p>
<p>As in just refcount the erased closure instead of every value in the closure? I guess it maybe makes less sense here than in lists.</p>
<p>Fundamentally, for wrapped types, I think only refcounting the wrapper is a nice property.</p>



<a name="440551552"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440551552" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440551552">(May 24 2024 at 17:41)</a>:</h4>
<p>Of course when loading values from the wrapper, you would need to deal with refcounts</p>



<a name="440551664"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440551664" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440551664">(May 24 2024 at 17:42)</a>:</h4>
<p>yes sure but the generation work is mostly the same (but only runs when the rc goes from 1 to 0)</p>



<a name="440551882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440551882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440551882">(May 24 2024 at 17:44)</a>:</h4>
<p>Yep</p>



<a name="440556318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440556318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440556318">(May 24 2024 at 18:13)</a>:</h4>
<p>actually, nothing needs to happen with abilities so you can disregard that</p>



<a name="440556814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440556814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440556814">(May 24 2024 at 18:16)</a>:</h4>
<p>ok cool!</p>



<a name="440556913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440556913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440556913">(May 24 2024 at 18:17)</a>:</h4>
<p>I wonder - is this a situation where we can split up the work by having someone knowledgeable about the low-level parts make a starting point commit like "ok now the refcounting happens in this one place, but it also needs to happen in these N other similar situations that need to be considered individually" and someone else can pick up that part?</p>



<a name="440557006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440557006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440557006">(May 24 2024 at 18:18)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> what is the memory layout supposed to be? where does that function pointer go?</p>



<a name="440557364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440557364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440557364">(May 24 2024 at 18:20)</a>:</h4>
<p>one sec, im putting up the document i wrote about this before</p>



<a name="440557853"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440557853" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440557853">(May 24 2024 at 18:24)</a>:</h4>
<p><a href="https://github.com/roc-lang/rfcs/pull/4">https://github.com/roc-lang/rfcs/pull/4</a></p>



<a name="440557886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440557886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440557886">(May 24 2024 at 18:24)</a>:</h4>
<p>the structure of the erased closure is</p>
<div class="codehilite"><pre><span></span><code>struct erased {
  void* value;
  void (*refcounter)(void*);  // NULL if value needs no refcounting
  void* callee;  // NULL if the erased value is not a closure
  struct ability_dictionary* abilities;  // Discussed below
};
</code></pre></div>



<a name="440557909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440557909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440557909">(May 24 2024 at 18:24)</a>:</h4>
<p>ability_dictionary is NULL for closures</p>



<a name="440557918"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440557918" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440557918">(May 24 2024 at 18:24)</a>:</h4>
<p><code>callee</code> is the function target`</p>



<a name="440557940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440557940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440557940">(May 24 2024 at 18:24)</a>:</h4>
<p><code>value</code> are the captures (NULL if no captures)</p>



<a name="440558048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558048">(May 24 2024 at 18:25)</a>:</h4>
<p><code>refcounter</code> is a pointer to the refcounting function for the captures. the name needs to be generated/looked up whenever the erased closure is constructed.</p>



<a name="440558208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558208">(May 24 2024 at 18:26)</a>:</h4>
<p>i suppose it should really be <code>void (*refcounter)(int, void*)</code> where the first parameter indicates inc or dec</p>



<a name="440558227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558227">(May 24 2024 at 18:26)</a>:</h4>
<p>or split them out into separate pointers</p>



<a name="440558356"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558356" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558356">(May 24 2024 at 18:28)</a>:</h4>
<p>when refcounting happens for captures is the same as when refcounting happens today. you just need to lookup the refcounting function differently because it's not statically known from the caller's side</p>



<a name="440558454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558454">(May 24 2024 at 18:28)</a>:</h4>
<p>fyi this memory layout is already implemented</p>



<a name="440558469"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558469" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558469">(May 24 2024 at 18:28)</a>:</h4>
<p>but the refcounting function is not populated</p>



<a name="440558811"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558811" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558811">(May 24 2024 at 18:31)</a>:</h4>
<p>nice! do you know where that code lives at the moment?</p>



<a name="440558823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440558823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440558823">(May 24 2024 at 18:31)</a>:</h4>
<p>like where the refcounting fn needs to go</p>



<a name="440559145"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440559145" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440559145">(May 24 2024 at 18:33)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/25f230fda81ef57387dc73cc315a15b5e383752b/crates/compiler/gen_llvm/src/llvm/erased.rs#L61-L89">https://github.com/roc-lang/roc/blob/25f230fda81ef57387dc73cc315a15b5e383752b/crates/compiler/gen_llvm/src/llvm/erased.rs#L61-L89</a></p>



<a name="440559261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440559261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440559261">(May 24 2024 at 18:34)</a>:</h4>
<p>oh, well the actual implementation already refernces refcounter_inc and refcounter_dec, so it is two separate functions</p>
<p>/// Erased is laid out like<br>
///<br>
/// <code>text
/// struct Erased {
///     value: void*,
///     callee: void*,
///     refcounter_inc: (void* -&gt; void) *,
///     refcounter_dec: (void* -&gt; void) *,
/// }
/// </code></p>



<a name="440559304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Alias%20analysis%20error%20across%20modules/near/440559304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Alias.20analysis.20error.20across.20modules.html#440559304">(May 24 2024 at 18:34)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/25f230fda81ef57387dc73cc315a15b5e383752b/crates/compiler/gen_llvm/src/llvm/erased.rs#L33">https://github.com/roc-lang/roc/blob/25f230fda81ef57387dc73cc315a15b5e383752b/crates/compiler/gen_llvm/src/llvm/erased.rs#L33</a></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>zig compiler - spike · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html">zig compiler - spike</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="497101907"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497101907" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497101907">(Jan 31 2025 at 22:46)</a>:</h4>
<p>Long story short, Richard proposed moving to Zig while we're rewriting so much of the compiler</p>



<a name="497101917"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497101917" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497101917">(Jan 31 2025 at 22:46)</a>:</h4>
<p>And we all seemed to agree</p>



<a name="497101939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497101939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497101939">(Jan 31 2025 at 22:46)</a>:</h4>
<p>Ok cool</p>



<a name="497102002"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102002" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102002">(Jan 31 2025 at 22:47)</a>:</h4>
<p>So next weekend, I'll have a PR ready for us to look over the IRs for a Zig compiler</p>



<a name="497102027"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102027" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102027">(Jan 31 2025 at 22:47)</a>:</h4>
<p>Written in Zig in our existing repo</p>



<a name="497102206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102206">(Jan 31 2025 at 22:49)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> I was hoping we could talk about what we would want the parser to look like in a new Zig world.  It's a good opportunity for us to implement a lot of the things we've talked about behind the scenes</p>



<a name="497102257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102257">(Jan 31 2025 at 22:49)</a>:</h4>
<p>We'll be all opening said PR in Zed and collaboratively shaping it how we think things should look, and then maybe starting to implement something pretty soon!</p>



<a name="497102369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102369">(Jan 31 2025 at 22:50)</a>:</h4>
<p>I'm busy this weekend vacationing out of town, but don't let my plans to set up these IRs next weekend stop people from doing something before I do for next weekend's meeting</p>



<a name="497102574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102574">(Jan 31 2025 at 22:52)</a>:</h4>
<p>For the parser and ast, I’d start by at least loosely following the design of the parser and ast for zig itself</p>



<a name="497102602"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102602" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102602">(Jan 31 2025 at 22:52)</a>:</h4>
<p>Probably wouldn't be a bad choice :-)</p>



<a name="497102638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102638">(Jan 31 2025 at 22:53)</a>:</h4>
<p>Let's talk sometime in the next week if you have some time.  Nothing formal, just over Zulip async</p>



<a name="497102690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497102690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497102690">(Jan 31 2025 at 22:53)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> I think someone should set our intention and add a top-level directory for the Zig project</p>



<a name="497103097"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497103097" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497103097">(Jan 31 2025 at 22:57)</a>:</h4>
<p>I'll do that ASAP, not sure when the "possible" part is</p>



<a name="497105076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497105076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497105076">(Jan 31 2025 at 23:18)</a>:</h4>
<p>to Ayaz's point about debuggability and struct-of-arrays, as far as I can tell <a href="https://andreashohmann.com/zig-struct-of-arrays/">Zig's <code>MultiArrayList</code></a> has the same ergonomics as a normal Rust <code>Vec</code> except it's automatically struct-of-arrays behind the scenes</p>



<a name="497105120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497105120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497105120">(Jan 31 2025 at 23:18)</a>:</h4>
<p>so the (very serious) debuggability/ergonomics downside we've had of doing SoA in Rust may just be a non-issue in Zig</p>



<a name="497113869"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497113869" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497113869">(Feb 01 2025 at 00:56)</a>:</h4>
<p>also <span class="user-mention" data-user-id="406911">@Andrew Kelley</span> mentioned to me, and said it was ok to share:</p>
<blockquote>
<p>if your dev loop ever gets longer than like 1 second let me know, I bet we can keep it under that number</p>
</blockquote>



<a name="497114038"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497114038" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497114038">(Feb 01 2025 at 00:58)</a>:</h4>
<p>here's the llvm bitcode builder: <a href="https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/src/codegen/llvm/Builder.zig">https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/src/codegen/llvm/Builder.zig</a></p>
<p><a href="https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/src/codegen/llvm.zig#L9">https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/src/codegen/llvm.zig#L9</a></p>



<a name="497119075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497119075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497119075">(Feb 01 2025 at 02:06)</a>:</h4>
<p>Also, with this rewrite, I assume we'll add in some of the platform changes. Specifically thinking it would be good to design from the beginning to assume that platforms pass in a gigantic struct of functions pointers. That struct would contain all effects and all <code>roc_</code> special functions like for allocation. It would be used the entire call stack in roc. I think that will fix some linking problems and be very important for eventually wiring up a roc interpreter.</p>



<a name="497119142"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497119142" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497119142">(Feb 01 2025 at 02:07)</a>:</h4>
<p>Not to mention finally fix our llvm c-abi woes. I wonder if we can share some code for c abi with zig instead of doing it manually.</p>



<a name="497119355"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497119355" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497119355">(Feb 01 2025 at 02:10)</a>:</h4>
<p>Yeah Richard's cooking a whole plan for fixing llvm by cooperating with the zig guys.</p>



<a name="497119401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497119401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497119401">(Feb 01 2025 at 02:11)</a>:</h4>
<p>Also, reminder to future llvm backend writer (maybe myself). Make sure to follow this to help make llvm happy: <a href="https://llvm.org/docs/Frontend/PerformanceTips.html">https://llvm.org/docs/Frontend/PerformanceTips.html</a></p>



<a name="497119414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497119414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497119414">(Feb 01 2025 at 02:11)</a>:</h4>
<p>I'm definitely keen to scope out the platform related things we want to fix too. Like we can leave the shared memory stuff behind and just go straight to the new test provided by the host.</p>



<a name="497119533"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497119533" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497119533">(Feb 01 2025 at 02:13)</a>:</h4>
<p>what is the issue with llvm?</p>



<a name="497120454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497120454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497120454">(Feb 01 2025 at 02:26)</a>:</h4>
<p>Honestly the biggest annoyance with llvm is that it doesn't deal with calling conventions. Second biggest annoyance is that it expects the ir in a specific form to optimize well (like all allocas in the entry block)</p>



<a name="497120485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497120485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497120485">(Feb 01 2025 at 02:27)</a>:</h4>
<p>That is at least thinking from the code gen side</p>



<a name="497120507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497120507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497120507">(Feb 01 2025 at 02:27)</a>:</h4>
<p>Not a huge deal to do it manually, but would be nice to just share with the zig compiler since they have already had to solve some of these annoyances</p>



<a name="497120536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497120536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497120536">(Feb 01 2025 at 02:28)</a>:</h4>
<p>We currently have a lot of c-abi calling convention bugs in our llvm backend</p>



<a name="497121593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121593">(Feb 01 2025 at 02:43)</a>:</h4>
<p>This is probably a dumb question - or will be construed as such - but is there a world where it's better and faster to compiler Roc to Zig?</p>



<a name="497121600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121600">(Feb 01 2025 at 02:43)</a>:</h4>
<p>Andrew shared this - <a href="https://github.com/ziglang/zig/blob/master/test/c_abi/cfuncs.c">https://github.com/ziglang/zig/blob/master/test/c_abi/cfuncs.c</a> - it's not the actual implementation, but it's test cases written in Zig</p>



<a name="497121658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121658">(Feb 01 2025 at 02:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497121593">said</a>:</p>
<blockquote>
<p>This is probably a dumb question - or will be construed as such - but is there a world where it's better and faster to compiler Roc to Zig?</p>
</blockquote>
<p>it's definitely strictly slower, plus then we'd have to bundle an entire Zig compiler inside <code>roc</code> <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497121724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121724">(Feb 01 2025 at 02:45)</a>:</h4>
<p>Well, I meant would there be a simplification to our compiler that would / could justify that dependency</p>



<a name="497121727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121727">(Feb 01 2025 at 02:45)</a>:</h4>
<p>compiling to C is more common, but yeah it's definitely slower</p>



<a name="497121789"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121789" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121789">(Feb 01 2025 at 02:46)</a>:</h4>
<p>I don't think compiling to c is that much simpler than compiling to llvm</p>



<a name="497121796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121796">(Feb 01 2025 at 02:46)</a>:</h4>
<p>it would be from the ABI perspective specifically</p>



<a name="497121804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121804">(Feb 01 2025 at 02:46)</a>:</h4>
<p>but in other ways probably harder</p>



<a name="497121815"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121815" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121815">(Feb 01 2025 at 02:46)</a>:</h4>
<p>Yep, that is the main gain. You don't have to implement c abi.</p>



<a name="497121823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121823">(Feb 01 2025 at 02:46)</a>:</h4>
<p>not sure if it would be a net win overall when you put the two together, not to mention what it would do to our build complexity <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497121842"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121842" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121842">(Feb 01 2025 at 02:47)</a>:</h4>
<p>I thought with Zig there is higher-level constructs that would make a lot of things simpler</p>



<a name="497121849"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121849" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121849">(Feb 01 2025 at 02:47)</a>:</h4>
<p>But just act like I never asked the question <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="497121925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121925">(Feb 01 2025 at 02:48)</a>:</h4>
<p>Roc primitives are pretty simple and we already can write builtins in zig instead of raw llvm, so don't think otherwise using zig is a big difference</p>



<a name="497121952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121952">(Feb 01 2025 at 02:48)</a>:</h4>
<p>Andrew said:</p>
<blockquote>
<p><a href="https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/src/codegen/llvm.zig#L5423-L5722">https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/src/codegen/llvm.zig#L5423-L5722</a><br>
it lowers from Zig IR ("AIR") to LLVM IR in this logic. So the best thing this codebase has to offer is perhaps the opportunity to port that ParamTypeIterator abstraction, which handles many calling conventions in addition to the C one<br>
see also this: <a href="https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/lib/std/Target.zig#L3326-L3391">https://github.com/ziglang/zig/blob/4de2b1ea65e6b54cedfe56268a8bf8e9446addb0/lib/std/Target.zig#L3326-L3391</a></p>
</blockquote>



<a name="497121955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497121955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497121955">(Feb 01 2025 at 02:48)</a>:</h4>
<p>Like we already have the ability to dish out to zig for anything complex that we don't want to write in raw llvm ir.</p>



<a name="497122048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497122048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497122048">(Feb 01 2025 at 02:50)</a>:</h4>
<p>Yeah, I bet if we can use some of zigs backend for llvm as a library, it will solve the hardest parts of working with llvm. That will be awesome</p>



<a name="497122084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497122084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497122084">(Feb 01 2025 at 02:50)</a>:</h4>
<p>yeah I feel like if we:</p>
<ul>
<li>start with Zig's C ABI test suite</li>
<li>convert the tests to test compiled Roc code instead of compiled Zig code</li>
<li>port Zig's C ABI code gen from consuming Zig IR to consuming Roc IR</li>
</ul>
<p>...we should end up with something that works as well as Zig's does, which is to say - very well! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="497122117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497122117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497122117">(Feb 01 2025 at 02:51)</a>:</h4>
<p>Yeah, like Joshua is saying, one advantage of Zig is that the Zig compiler is maybe approachable enough that if nothing else there could be some code sharing - or at least some patterns that we can pick up.</p>



<a name="497122124"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497122124" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497122124">(Feb 01 2025 at 02:51)</a>:</h4>
<p>Andrew did add a caveat:</p>
<blockquote>
<p>note that this isn't enough, you still have to follow certain undocumented rules about what LLVM types and attributes to use in parameters and return value</p>
</blockquote>



<a name="497122192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497122192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497122192">(Feb 01 2025 at 02:52)</a>:</h4>
<p>yeah plus Andrew is keen to help us out, so we're not just poking around Zig's code base in the dark with a flashlight</p>



<a name="497122196"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497122196" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497122196">(Feb 01 2025 at 02:52)</a>:</h4>
<p>By "sharing" I mean mostly copy/paste/iterate</p>



<a name="497122488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497122488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497122488">(Feb 01 2025 at 02:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497122124">said</a>:</p>
<blockquote>
<p>Andrew did add a caveat:</p>
<blockquote>
<p>note that this isn't enough, you still have to follow certain undocumented rules about what LLVM types and attributes to use in parameters and return value</p>
</blockquote>
</blockquote>
<p>Yep, makes sense. But should ease some pain still.</p>



<a name="497127352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497127352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497127352">(Feb 01 2025 at 04:06)</a>:</h4>
<p>Whoa, I was not expecting this, nice!!</p>



<a name="497127383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497127383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497127383">(Feb 01 2025 at 04:07)</a>:</h4>
<p>I cannot believe how much has been changing in Roc land this last year <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span><span aria-label="star" class="emoji emoji-2b50" role="img" title="star">:star:</span></p>



<a name="497128203"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497128203" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497128203">(Feb 01 2025 at 04:18)</a>:</h4>
<p>Tried translating an old tokenizer experiment from rust to zig: <a href="https://github.com/joshuawarner32/roc/blob/c80a3ba0e453abf495619a1abf8ed28c9e6ff909/zig/tokenize/src/main.zig">https://github.com/joshuawarner32/roc/blob/c80a3ba0e453abf495619a1abf8ed28c9e6ff909/zig/tokenize/src/main.zig</a></p>



<a name="497133292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497133292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497133292">(Feb 01 2025 at 05:39)</a>:</h4>
<p>This reminds me. For zigs tokenizer, didn't they remove the tag. Instead they just load the offset and reparse the token (cause the token is essentially the tag). Not saying we need to do that, but reminded of the DOD talk on the new zig irs and such.</p>
<p>Other random cool technique. For chomping whitespace and trivial things, some sort of SWAR mask may enable easily going 8 bytes at a time for essentially the same cost.</p>



<a name="497134967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497134967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497134967">(Feb 01 2025 at 06:07)</a>:</h4>
<blockquote>
<p>For chomping whitespace and trivial things, some sort of SWAR mask may enable easily going 8 bytes at a time for essentially the same cost.</p>
</blockquote>
<p>Roc actually already does this! (I wrote that part :P)</p>



<a name="497135046"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497135046" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497135046">(Feb 01 2025 at 06:08)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/parse/src/blankspace.rs#L263">https://github.com/roc-lang/roc/blob/main/crates/compiler/parse/src/blankspace.rs#L263</a></p>



<a name="497135328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497135328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497135328">(Feb 01 2025 at 06:13)</a>:</h4>
<p>Time and time again, it seems the Roc parser is just Joshua turtles all the way down</p>



<a name="497163478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497163478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497163478">(Feb 01 2025 at 13:07)</a>:</h4>
<p>How do people feel about scoping in a bit more than just functions, values, and strings to start with? If we want to allow for dev parallelism, we want to give people tasks they don't require as much coordination with. I think once the compiler is working all the way through with just strings, adding subsequent features will happen where a single change affects the whole pipeline. Seems like we can push that off to start with by making the stages bigger silos for now</p>



<a name="497163571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497163571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497163571">(Feb 01 2025 at 13:08)</a>:</h4>
<p>Currently, we need:</p>
<ul>
<li>functions</li>
<li>values</li>
<li>strings</li>
<li>something like tags for the lambda set later stages</li>
</ul>



<a name="497163607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497163607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497163607">(Feb 01 2025 at 13:08)</a>:</h4>
<p>Maybe adding in if-else or records could be something else that's not overly complex?</p>



<a name="497164111"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497164111" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497164111">(Feb 01 2025 at 13:16)</a>:</h4>
<p>Also, a naive but parallelism friendly single-Env replacement would be to get rid of Env as a concept and to save everything in a stage's IR for a given module. When compiling a module for stage N, we compile its dependencies first and pass their N+1 IRs as args for the module that depends on them.  For example, if module Foo imports module Bar, then during type specialization, we'd type specialize Bar first, and then pass the TypeSpecIR for Bar as an arg to <code>specialize_types(typecheck_ir_for_module: TypeCheckIR, type_spec_ir_per_dep_modules: Map&lt;ModuleID, TypeSpecIR&gt;)</code></p>



<a name="497164163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497164163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497164163">(Feb 01 2025 at 13:17)</a>:</h4>
<p>It would be better to load in the relevant data into the main module's IR to avoid having to look in two places for deps, but we should be able to make that improvement later</p>



<a name="497164241"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497164241" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497164241">(Feb 01 2025 at 13:18)</a>:</h4>
<p>I'm gonna run with that approach for the Zig skeleton unless someone has a better but still simple idea</p>



<a name="497164936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497164936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497164936">(Feb 01 2025 at 13:29)</a>:</h4>
<p>it's probably about the same if we sketch things out but don't have <em>all</em> of them implemented end to end right away</p>



<a name="497164952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497164952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497164952">(Feb 01 2025 at 13:29)</a>:</h4>
<p>I think the main thing is that we start with a simple skeleton and don't try to bring everything in at the outset <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="497164957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497164957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497164957">(Feb 01 2025 at 13:29)</a>:</h4>
<p>Agreed</p>



<a name="497165010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497165010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497165010">(Feb 01 2025 at 13:30)</a>:</h4>
<p>just a small handful seems fine</p>



<a name="497165188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497165188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497165188">(Feb 01 2025 at 13:33)</a>:</h4>
<p>Tangentially, does anyone have opinions on whether typechecking would look how it does today or would we do it structurally differently if we rewrote it (as is the plan). Somewhat an <span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> question I presume. I think I know what the IR will look like for most stages, but typechecking is like the one hole in my mental model</p>



<a name="497170228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170228">(Feb 01 2025 at 14:51)</a>:</h4>
<p>i would say rewrite it if it makes it simpler for you</p>



<a name="497170242"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170242" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170242">(Feb 01 2025 at 14:51)</a>:</h4>
<p>the important thing is not whether it's fine rn imo</p>



<a name="497170250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170250">(Feb 01 2025 at 14:51)</a>:</h4>
<p>it's can you build on top of it</p>



<a name="497170377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170377">(Feb 01 2025 at 14:52)</a>:</h4>
<p>i would maybe write a small unification-style typechecker in a toy language to build an intuition for how it works if you all don't have a solid one already, you can pluck a parser for some random language off the internet and write a checker for it</p>



<a name="497170566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170566">(Feb 01 2025 at 14:55)</a>:</h4>
<p>That's a good idea</p>



<a name="497170674"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170674" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170674">(Feb 01 2025 at 14:56)</a>:</h4>
<p>I think the unification strategy makes sense to me (roughly), though writing an impl myself should help a good deal</p>



<a name="497170739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170739">(Feb 01 2025 at 14:57)</a>:</h4>
<p>The thing that feels messy to me is adding type constraints right now, and I'm wondering if there's a way to reduce the vibe of "hopefully we add all the right constraints"</p>



<a name="497170806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170806">(Feb 01 2025 at 14:58)</a>:</h4>
<p>It feels easy in the current system to miss or add too many constraints</p>



<a name="497170957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170957">(Feb 01 2025 at 15:00)</a>:</h4>
<p>And I don't know a good strategy to help with that besides maybe grouping behaviors like "constrain a function type" and "constraint a record" and pulling them into separate functions that take a struct for their args, meaning it's harder to misalign on what constraints to add?</p>



<a name="497170960"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497170960" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497170960">(Feb 01 2025 at 15:00)</a>:</h4>
<p>Idk</p>



<a name="497172745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497172745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497172745">(Feb 01 2025 at 15:22)</a>:</h4>
<p>maybe get rid of constraint gen</p>



<a name="497172755"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497172755" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497172755">(Feb 01 2025 at 15:22)</a>:</h4>
<p>just unify when you need to</p>



<a name="497172759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497172759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497172759">(Feb 01 2025 at 15:22)</a>:</h4>
<p>it's fine</p>



<a name="497172906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497172906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497172906">(Feb 01 2025 at 15:24)</a>:</h4>
<p>Oh??</p>



<a name="497172927"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497172927" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497172927">(Feb 01 2025 at 15:24)</a>:</h4>
<p>Do you know of a language that does that?</p>



<a name="497172932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497172932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497172932">(Feb 01 2025 at 15:24)</a>:</h4>
<p>I'll just read their compiler</p>



<a name="497172973"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497172973" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497172973">(Feb 01 2025 at 15:25)</a>:</h4>
<p>I’ll follow along with you Sam, unification is where I went off the rails with my language</p>



<a name="497173790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497173790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497173790">(Feb 01 2025 at 15:35)</a>:</h4>
<p>brother</p>



<a name="497175403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497175403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497175403">(Feb 01 2025 at 15:56)</a>:</h4>
<p>yes, plenty of languages keep constraints inline while typechecking</p>



<a name="497175637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497175637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497175637">(Feb 01 2025 at 15:58)</a>:</h4>
<p>eg</p>
<div class="codehilite"><pre><span></span><code>fn infer(..) -&gt; type_variable {
...
case
  Apply(f, x) {
    t_f_in_infer = make_var()
    t_f_out_infer = make_var()
    t_f_infer = make_var(TFn(t_f_in_infer, t_f_out_infer))
    t_f = infer(f)
    t_x = infer(x)
    unify(t_f, t_f_infer)
    unify(t_x, t_f_in_infer)
    t_f_out_infer
</code></pre></div>



<a name="497175687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497175687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497175687">(Feb 01 2025 at 15:59)</a>:</h4>
<p>Okay, cool</p>



<a name="497175693"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497175693" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497175693">(Feb 01 2025 at 15:59)</a>:</h4>
<p>I'll mess with it</p>



<a name="497175699"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497175699" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497175699">(Feb 01 2025 at 15:59)</a>:</h4>
<p>If <code>unify(t_f, t_f_infer)</code> fails, emit an error about <code>f</code> not being a function. If <code>unify(t_x, t_f_in_infer)</code> fails, an error about the argument type being wrong</p>



<a name="497175777"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497175777" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497175777">(Feb 01 2025 at 16:00)</a>:</h4>
<p>Makes sense!</p>



<a name="497176307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176307">(Feb 01 2025 at 16:07)</a>:</h4>
<p>one thing that took me awhile to understand is the "occurs check"</p>



<a name="497176367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176367">(Feb 01 2025 at 16:07)</a>:</h4>
<p>as I understand it (Ayaz, feel free to correct or elaborate on any of this!) the basic problem it's trying to solve is that if you have an infinitely recursive type, you don't want the type-checker to get stuck in an infinite loop hopping from one type to another trying to infer their types, but since they depend on each other, it just never terminates</p>



<a name="497176432"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176432" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176432">(Feb 01 2025 at 16:08)</a>:</h4>
<p>so the "occurs check" is to say "hey, does this particular type variable occur anywhere in this other type?" (because if so, we have an infinite loop!)</p>



<a name="497176448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176448">(Feb 01 2025 at 16:08)</a>:</h4>
<p>so it just descends into that other type and tries to find any instances of the requested variable - as soon as it finds one, it returns</p>



<a name="497176455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176455">(Feb 01 2025 at 16:08)</a>:</h4>
<p>so the occurs check can't possibly get stuck in a loop</p>



<a name="497176502"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176502" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176502">(Feb 01 2025 at 16:09)</a>:</h4>
<p>so there are certain places in unification where we're like "ok before proceeding, stop and do an occurs check to make sure that proceeding won't get stuck"</p>



<a name="497176536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176536">(Feb 01 2025 at 16:09)</a>:</h4>
<p>(and then bail out and report an error about it being an infinite type if we detect one)</p>



<a name="497176589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176589">(Feb 01 2025 at 16:10)</a>:</h4>
<p>I'm not sure if there are other use cases where it comes up, but my understanding is that this is its main job</p>



<a name="497176623"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176623" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176623">(Feb 01 2025 at 16:10)</a>:</h4>
<p>also, there's the concept of <code>rank</code></p>



<a name="497176796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176796">(Feb 01 2025 at 16:12)</a>:</h4>
<p>Folkert and I spent a lot of time figuring out how that one works in Elm's compiler, and what we concluded was:</p>
<ul>
<li>it seems to be necessary for both performance and correctness</li>
<li>you have to increment it and decrement it at the right times</li>
<li>"The way it works is that it's for like...defs, and you sort of increase it when...decreasing def depth, or something? Well, but then with function arguments it's...well, and then pattern matching it's....anyway, it's definitely something. And if you don't increment or decrement it where you needed to, or increment or decrement where you shouldn't, type-checking breaks." <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></li>
</ul>



<a name="497176824"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176824" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176824">(Feb 01 2025 at 16:13)</a>:</h4>
<p>it would be rad to actually understand for real how it's supposed to work <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="497176853"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176853" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176853">(Feb 01 2025 at 16:13)</a>:</h4>
<p>there's also a thing called pools, and I have zero clue what they do</p>



<a name="497176925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176925">(Feb 01 2025 at 16:14)</a>:</h4>
<p>The explanation for ranks is linked here in the compiler: <a href="https://github.com/roc-lang/roc/blob/670d2550603b9bb29ab238b6ed6180778a5d107d/crates/compiler/solve/src/solve.rs#L78">https://github.com/roc-lang/roc/blob/670d2550603b9bb29ab238b6ed6180778a5d107d/crates/compiler/solve/src/solve.rs#L78</a></p>



<a name="497176931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176931">(Feb 01 2025 at 16:14)</a>:</h4>
<p><a href="http://okmij.org/ftp/ML/generalization.html#levels">http://okmij.org/ftp/ML/generalization.html#levels</a></p>



<a name="497176946"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497176946" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497176946">(Feb 01 2025 at 16:15)</a>:</h4>
<p>I'll try to re-read it before next week</p>



<a name="497177090"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177090" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177090">(Feb 01 2025 at 16:17)</a>:</h4>
<blockquote>
<p>The rank tracks the number of let-bindings a variable is "under". Top-level definitions have rank 1. A let in a top-level definition gets rank 2, and so on.</p>
</blockquote>
<p>This is a better explanation than mine from above: "The way it works is that it's for like...defs, and you sort of increase it when...decreasing def depth, or something? Well, but then with function arguments it's...well, and then pattern matching it's....anyway, it's definitely something."</p>



<a name="497177192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177192">(Feb 01 2025 at 16:18)</a>:</h4>
<p>yeah, so the tricky part is taking that general idea and figuring out exactly which situations need it, and then making sure to pair the incrmeents and decrements correctly (e.g. decrement the current rank the appropriate number of times when exiting a particular scope)</p>



<a name="497177294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177294">(Feb 01 2025 at 16:20)</a>:</h4>
<p>Yeah, wondering if there's a good way to encode it into our approach so we can't mess it up</p>



<a name="497177300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177300">(Feb 01 2025 at 16:20)</a>:</h4>
<p>Gonna take some brain power for that, probably</p>



<a name="497177331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177331">(Feb 01 2025 at 16:20)</a>:</h4>
<p>This is a let in the ML understanding, so every successive def is a new let (since in ML there is only expressions)</p>



<a name="497177382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177382">(Feb 01 2025 at 16:21)</a>:</h4>
<p>That’s why SML and OCaml use <code>let x = … in</code> because the next let is a child expression</p>



<a name="497177459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177459">(Feb 01 2025 at 16:22)</a>:</h4>
<p>yeah we already convert to that representation</p>



<a name="497177487"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177487" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177487">(Feb 01 2025 at 16:23)</a>:</h4>
<p>as in, we start with a flat list of defs but then convert them to nested during canonicalization</p>



<a name="497177528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177528">(Feb 01 2025 at 16:23)</a>:</h4>
<p>in other words:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<p>...canonicalizes to the equivalent of:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>



<a name="497177603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177603">(Feb 01 2025 at 16:24)</a>:</h4>
<p>I forget what the reason for this is - maybe because they each have their own scopes?</p>



<a name="497177658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177658">(Feb 01 2025 at 16:25)</a>:</h4>
<p>Not sure what the original reason was, but it does make the IR simpler. "either it's an expression, or a single def followed by an expression."</p>



<a name="497177695"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177695" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177695">(Feb 01 2025 at 16:26)</a>:</h4>
<p>there's also a correctness aspect to it</p>



<a name="497177737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177737">(Feb 01 2025 at 16:26)</a>:</h4>
<p>I just know that no ML-derived type system really works without it</p>



<a name="497177742"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177742" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177742">(Feb 01 2025 at 16:26)</a>:</h4>
<p>we originally didn't do this, and when we switched to it, it fixed bugs</p>



<a name="497177745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177745">(Feb 01 2025 at 16:26)</a>:</h4>
<p>yeah</p>



<a name="497177758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177758">(Feb 01 2025 at 16:26)</a>:</h4>
<p>I don't remember the exact reason though, this would have been like 2019 <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497177807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177807">(Feb 01 2025 at 16:27)</a>:</h4>
<p>that said, I don't think we actually need to rewrite the IR into that form if we don't want to</p>



<a name="497177826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177826">(Feb 01 2025 at 16:27)</a>:</h4>
<p>but we do need to pass the info to the type-checker as if it were in that form, if that makes sense</p>



<a name="497177836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177836">(Feb 01 2025 at 16:27)</a>:</h4>
<p>I think it has to do with a new var has to be scoped and it has a lifetime that has to then be resolved and rolled up into its parent</p>



<a name="497177909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177909">(Feb 01 2025 at 16:28)</a>:</h4>
<p>yeah like the "add this to the scope, increment the rank" and "remove it from the scope and decrement the rank" stuff needs to happen as if it were in that nested form, regardless of whether it is in the IR</p>



<a name="497177924"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177924" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177924">(Feb 01 2025 at 16:28)</a>:</h4>
<p>Yes, I want to move parsing to be a simpler IR that’s flatter, but can will have to continue to do what it does today</p>



<a name="497177985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177985">(Feb 01 2025 at 16:29)</a>:</h4>
<p>amusingly, I think in the someday-future when we start doing adjacency nodes (not  in this version of the compiler!) it might end up being the same haha</p>



<a name="497177995"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497177995" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497177995">(Feb 01 2025 at 16:29)</a>:</h4>
<p>like there might not end up being a distinction at the IR level between nested and not-nested adjacent defs</p>



<a name="497178145"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497178145" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497178145">(Feb 01 2025 at 16:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497177487">said</a>:</p>
<blockquote>
<p>as in, we start with a flat list of defs but then convert them to nested during canonicalization</p>
</blockquote>
<p>I'm really surprised this makes any difference. Feels like you could just walk the dense list and derive all of the same information.</p>



<a name="497178766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497178766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497178766">(Feb 01 2025 at 16:39)</a>:</h4>
<p>yeah that's what I mean about the canonical IR being decoupled from this, but the type checker needing to be told it's in the nested form even if it's not</p>



<a name="497179338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179338">(Feb 01 2025 at 16:47)</a>:</h4>
<p>speaking of general principles, we talked about this a bit on the call, but I definitely think we should put a stronger value on human-readable code in tests</p>



<a name="497179435"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179435" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179435">(Feb 01 2025 at 16:48)</a>:</h4>
<p>Luke is in alignment with you there, and I think also Joshua. I'm confident we'll make that happen!</p>



<a name="497179731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179731">(Feb 01 2025 at 16:52)</a>:</h4>
<p>e.g. parsing tests consistently start with Roc code as inputs, and I think that should also be true of the other stages of the compiler</p>



<a name="497179764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179764">(Feb 01 2025 at 16:52)</a>:</h4>
<p>and as far as outputs go, transforming them into something more human-readable than raw IR nodes also seems like a good idea</p>



<a name="497179772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179772">(Feb 01 2025 at 16:52)</a>:</h4>
<p>and also fuzzing right out the gates <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="497179785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179785">(Feb 01 2025 at 16:53)</a>:</h4>
<p>I think fuzzing would have caught a lot of those Rank mistakes earlier</p>



<a name="497179796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179796">(Feb 01 2025 at 16:53)</a>:</h4>
<p>and missing <code>occurs</code> checks</p>



<a name="497179830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497179830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497179830">(Feb 01 2025 at 16:53)</a>:</h4>
<p>Yes each IR should have a human readable representation that is divorced from the specific languages default formatting</p>



<a name="497184901"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497184901" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497184901">(Feb 01 2025 at 18:02)</a>:</h4>
<p>Also, not sure how helpful this would be, but for mlir, it is useful to be able to write tests in terms of human readable ir and single pass transformations. That said, it doesn't always work to break down at that level. But can make IRs and passes a lot more debuggable if you can do tests like that easily.</p>



<a name="497192791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497192791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497192791">(Feb 01 2025 at 19:48)</a>:</h4>
<p>a thought: I wonder if it would be helpful to start making an early API and test suite for editor commands</p>



<a name="497192844"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497192844" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497192844">(Feb 01 2025 at 19:49)</a>:</h4>
<p>like even if we don't have the implementations right away, just having the pieces in there as part of the skeleton so we can think about which operations have which inputs and outputs</p>



<a name="497192858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497192858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497192858">(Feb 01 2025 at 19:49)</a>:</h4>
<p>so that can inform how everything fits together</p>



<a name="497192935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497192935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497192935">(Feb 01 2025 at 19:50)</a>:</h4>
<p>instead of trying to implement it after the fact on top of a process that was designed with only cli builds in mind</p>



<a name="497192982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497192982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497192982">(Feb 01 2025 at 19:51)</a>:</h4>
<p>I’m assuming you are talking about the Roc Editor, not LSP Code Actions?</p>



<a name="497193004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193004">(Feb 01 2025 at 19:51)</a>:</h4>
<p>I think it's the same consideration regardless</p>



<a name="497193014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193014">(Feb 01 2025 at 19:51)</a>:</h4>
<p>Structural editing would be the difference, I think</p>



<a name="497193019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193019">(Feb 01 2025 at 19:51)</a>:</h4>
<p>(I wasn’t around when that was a live topic of discussion so I don’t know the first thing about the former)</p>



<a name="497193023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193023">(Feb 01 2025 at 19:51)</a>:</h4>
<p>Otherwise should be basically the same</p>



<a name="497193024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193024">(Feb 01 2025 at 19:51)</a>:</h4>
<p>like "the user has asked for this information and provided this input"</p>



<a name="497193101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193101">(Feb 01 2025 at 19:52)</a>:</h4>
<p>I don't think structural editing is as good an idea as I used to <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497193107"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193107" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193107">(Feb 01 2025 at 19:52)</a>:</h4>
<p>but also I don't think it makes that much of a difference</p>



<a name="497193123"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193123" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193123">(Feb 01 2025 at 19:52)</a>:</h4>
<p>incidentally, I know that Rust and C# were both designed to be editor-first compilers, but they're both unacceptably slow to me, so I'm not saying we should do what they did</p>



<a name="497193141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193141">(Feb 01 2025 at 19:53)</a>:</h4>
<p>just that we should keep these use cases in mind early</p>



<a name="497193842"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497193842" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497193842">(Feb 01 2025 at 20:02)</a>:</h4>
<p>a good example of what I'm talking about:</p>
<ul>
<li>"find all places where this type is used" needs to start with a source code range in one file and then return source file ranges in potentially multiple other modules</li>
<li>this requires knowing how to translate from source file range in one file into type ID</li>
<li>then it requires going through other modules and figuring out where that type ID is used within those modules</li>
<li>then it requires translating all those usage sites back into source locations</li>
</ul>



<a name="497194148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194148">(Feb 01 2025 at 20:06)</a>:</h4>
<p>so it would be good to make sure that once compilation is done, we can do all of that without it being a big pain <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="497194421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194421">(Feb 01 2025 at 20:10)</a>:</h4>
<p>Yeah, that can be pretty agnostic. Good idea</p>



<a name="497194423"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194423" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194423">(Feb 01 2025 at 20:10)</a>:</h4>
<p>batch compiler and language server compilers (query compilers) are totally different use cases. i wouldn't try to fit both in one</p>



<a name="497194469"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194469" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194469">(Feb 01 2025 at 20:11)</a>:</h4>
<p>regarding list of statements vs expressions - they are isomorphic. just nested expressions are a lot easier in practice to work with. you can get the type of a whole expression at one node vs looking at the last item in the statement list</p>



<a name="497194596"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194596" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194596">(Feb 01 2025 at 20:13)</a>:</h4>
<blockquote>
<p>i wouldn't try to fit both in one</p>
</blockquote>
<p>The roslyn C# compiler is built exactly like that, and it seems to have worked out reasonably well at least? Typescript too, I think?</p>
<p>Would be interesting to talk to someone on one of those teams to get their take</p>



<a name="497194676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194676">(Feb 01 2025 at 20:14)</a>:</h4>
<p>yes but have two different modes</p>



<a name="497194728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194728">(Feb 01 2025 at 20:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497194469">said</a>:</p>
<blockquote>
<p>regarding list of statements vs expressions - they are isomorphic. just nested expressions are a lot easier in practice to work with. you can get the type of a whole expression at one node vs looking at the last item in the statement list</p>
</blockquote>
<p>I wouldn’t try to use statements past parsing</p>



<a name="497194741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194741">(Feb 01 2025 at 20:15)</a>:</h4>
<p>regarding ranks - this is purely a performance optimization. it's not required. to build an intutition i think Mimram's Program=Proof is the best resource; see section 4.4.4 specifically starting at page 209. He explains the inference mechanism in the most succinct and understandable way i've seen. <a href="https://www.lix.polytechnique.fr/Labo/Samuel.Mimram/teaching/INF551/course.pdf">https://www.lix.polytechnique.fr/Labo/Samuel.Mimram/teaching/INF551/course.pdf</a></p>



<a name="497194763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194763">(Feb 01 2025 at 20:15)</a>:</h4>
<p>Just trying to minimize the size of the parse AST</p>



<a name="497194816"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194816" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194816">(Feb 01 2025 at 20:16)</a>:</h4>
<p>And make it more fault tolerant for error reporting</p>



<a name="497194846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194846">(Feb 01 2025 at 20:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497194741">said</a>:</p>
<blockquote>
<p>regarding ranks - this is purely a performance optimization. it's not required.</p>
</blockquote>
<p>right, but if you have them and get them wrong, it seems to break correctness <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497194857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194857">(Feb 01 2025 at 20:16)</a>:</h4>
<p>yes because if you get it wrong you either over generalize or under generalize</p>



<a name="497194864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194864">(Feb 01 2025 at 20:17)</a>:</h4>
<p>the alternative is to generalize based on the kind of expression</p>



<a name="497194948"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497194948" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497194948">(Feb 01 2025 at 20:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497194423">said</a>:</p>
<blockquote>
<p>batch compiler and language server compilers (query compilers) are totally different use cases. i wouldn't try to fit both in one</p>
</blockquote>
<p>do you think we should make two completely different compilers? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="497195000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195000">(Feb 01 2025 at 20:19)</a>:</h4>
<p>occurs check - this is also not required in a language with infinite types, it is typically employed only to detect recursion and stop it. The current implementation uses it to insert "recursion points" that mark where the compiler should box a value at runtime. this is also unnecessary. Normal unification works just as well as long as you add a check to see that if you have already tried to unify two types A and B, if A and B are seen again, you short circuit the unification (hopefully it's clear why this is correct but i can explain if helpful). Then during code generation you determine the recursion point separately.</p>



<a name="497195028"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195028" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195028">(Feb 01 2025 at 20:19)</a>:</h4>
<p>no, i would just start with the batch compiler use case. because programs are smaller queries are going to be fast even over the batch. then the query use case can be solved later</p>



<a name="497195120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195120">(Feb 01 2025 at 20:20)</a>:</h4>
<p>ahh right, I forgot about detecting recursion!</p>



<a name="497195243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195243">(Feb 01 2025 at 20:22)</a>:</h4>
<p>the "have we seen this already?" check sounds simpler in that we could just implement it once, as opposed to having to call occurs in a bunch of different places, right?</p>



<a name="497195286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195286">(Feb 01 2025 at 20:23)</a>:</h4>
<p>in principle you only need to run occurs after generalization so i dont think it makes a difference in terms of number of places it's called</p>



<a name="497195300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195300">(Feb 01 2025 at 20:23)</a>:</h4>
<p>but i would push it down until its actually needed</p>



<a name="497195352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195352">(Feb 01 2025 at 20:24)</a>:</h4>
<p>you mean in code gen?</p>



<a name="497195358"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195358" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195358">(Feb 01 2025 at 20:24)</a>:</h4>
<p>yes</p>



<a name="497195387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195387">(Feb 01 2025 at 20:24)</a>:</h4>
<p>seems reasonable! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="497195979"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195979" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195979">(Feb 01 2025 at 20:33)</a>:</h4>
<p>it'll be nice that we won't need to deal with optional record fields in the type checker</p>



<a name="497195983"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497195983" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497195983">(Feb 01 2025 at 20:33)</a>:</h4>
<p>that will really simplify the record logic</p>



<a name="497196008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497196008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497196008">(Feb 01 2025 at 20:33)</a>:</h4>
<p>oh yeah, we should remember to handle <code>as</code> whenever we're doing pattern matches and imports and such</p>



<a name="497196015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497196015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497196015">(Feb 01 2025 at 20:34)</a>:</h4>
<p>right now it's implemented pretty inconsistently <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497197997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497197997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497197997">(Feb 01 2025 at 21:02)</a>:</h4>
<p>Do we have a strong direction around what patterns we will use to get around Zig's lack of interfaces?  _I_ know plenty of ways to deal with it, but as I'm sitting here lookin at our current parsing code, we use a number of traits.  The most obvious being Parser.</p>



<a name="497198024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198024">(Feb 01 2025 at 21:03)</a>:</h4>
<p>And I'd like to at least know that I'm going down a road that is going to be well-received by others here</p>



<a name="497198105"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198105" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198105">(Feb 01 2025 at 21:04)</a>:</h4>
<p>Why is parser an interface and not just a concrete type with methods?</p>



<a name="497198234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198234">(Feb 01 2025 at 21:06)</a>:</h4>
<p>It's a pattern from FP languages for recursive descent</p>



<a name="497198250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198250">(Feb 01 2025 at 21:06)</a>:</h4>
<p>I'm actually thinking about explicitly NOT trying to copy that pattern</p>



<a name="497198254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198254">(Feb 01 2025 at 21:06)</a>:</h4>
<p>yeah</p>



<a name="497198267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198267">(Feb 01 2025 at 21:06)</a>:</h4>
<p>I don't think we need it</p>



<a name="497198322"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198322" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198322">(Feb 01 2025 at 21:07)</a>:</h4>
<p>I have a structure for parsers (in procedural languages) that I'm pretty familiar with</p>



<a name="497198329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198329">(Feb 01 2025 at 21:07)</a>:</h4>
<p>I'm going to see how far it can take me</p>



<a name="497198333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198333">(Feb 01 2025 at 21:07)</a>:</h4>
<p>And then I'll present it</p>



<a name="497198341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198341">(Feb 01 2025 at 21:07)</a>:</h4>
<p>Also, as for uses of traits/interfaces in general. I think the zig equivalent of a trait is a comptime returned struct with different function implementations based on the concrete implementation. And interfaces are the same thing but runtime function pointers.</p>



<a name="497198430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198430">(Feb 01 2025 at 21:08)</a>:</h4>
<p>Can you show an example of what you are talking about?  Because a Zig trait equivalent is very verbose usually</p>



<a name="497198459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198459">(Feb 01 2025 at 21:09)</a>:</h4>
<p>Unless you want to do some very tedious things in comptime and have all implementations live in one file</p>



<a name="497198483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198483">(Feb 01 2025 at 21:09)</a>:</h4>
<p>But a Zig wizard I am not</p>



<a name="497198567"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198567" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198567">(Feb 01 2025 at 21:10)</a>:</h4>
<p>I think the recursive descent parser design Josh has in mind wouldn't want this anyway</p>



<a name="497198577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198577">(Feb 01 2025 at 21:10)</a>:</h4>
<p>Yeah, I guess for what I am thinking it requires central registration for traits, but they could still be implemented in various files.</p>



<a name="497198782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198782">(Feb 01 2025 at 21:13)</a>:</h4>
<p>Oh, looks like you can do it without central registration in zig: <a href="https://github.com/permutationlock/zimpl?tab=readme-ov-file#example">https://github.com/permutationlock/zimpl?tab=readme-ov-file#example</a></p>



<a name="497198877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497198877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497198877">(Feb 01 2025 at 21:14)</a>:</h4>
<p>That said, I highly doubt we'll need this in the compiler. Almost everything is static concrete types or can be designed to be so.</p>



<a name="497199187"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199187" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199187">(Feb 01 2025 at 21:19)</a>:</h4>
<p>Fixed some bugs in the tokenizer I pushed earlier: <a href="https://github.com/joshuawarner32/roc/blob/zig-tokenizer/zig/tokenize/src/main.zig">https://github.com/joshuawarner32/roc/blob/zig-tokenizer/zig/tokenize/src/main.zig</a></p>
<p>Now it:</p>
<ul>
<li>Can properly handle string interpolation, including nested interpolation</li>
<li>Handles unicode identifiers</li>
<li>Tokenizes all the current syntax tests without reporting an error (which is not to say it does so correctly - but there are no _obvious_ problems)</li>
</ul>



<a name="497199317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199317">(Feb 01 2025 at 21:20)</a>:</h4>
<p>Did you make it handle snake_case identifiers and <code>import</code> statements in the header?</p>



<a name="497199455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199455">(Feb 01 2025 at 21:22)</a>:</h4>
<p>It does not currently handle snake case; I think those'll probably be tokenized incorrectly at present</p>



<a name="497199459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199459">(Feb 01 2025 at 21:22)</a>:</h4>
<p>Not hard to add tho</p>



<a name="497199500"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199500" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199500">(Feb 01 2025 at 21:22)</a>:</h4>
<p>Yeah I did that on my local copy</p>



<a name="497199501"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199501" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199501">(Feb 01 2025 at 21:22)</a>:</h4>
<p>There's not a whole lot it needs to do in order to handle import statements, with the one exception of making a token for the <code>import</code> keyword (which needs to be done)</p>



<a name="497199519"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199519" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199519">(Feb 01 2025 at 21:23)</a>:</h4>
<p>it looks like there's already enough here to try out zig's builtin fuzzing on! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="497199529"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199529" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199529">(Feb 01 2025 at 21:23)</a>:</h4>
<p>Indeed!</p>



<a name="497199540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199540">(Feb 01 2025 at 21:23)</a>:</h4>
<p>There is one minor syntax tweak I'd like to make, which I think was discussed elsewhere, and that's changing up the ext syntax from <code>{a: Str}ext</code> to (IIRC?) <code>{a: Str, ..ext}</code> - or something similar</p>



<a name="497199565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199565">(Feb 01 2025 at 21:23)</a>:</h4>
<p>that's it exactly! <span aria-label="100" class="emoji emoji-1f4af" role="img" title="100">:100:</span></p>



<a name="497199575"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199575" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199575">(Feb 01 2025 at 21:23)</a>:</h4>
<p>Sweet</p>



<a name="497199632"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199632" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199632">(Feb 01 2025 at 21:24)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> What are your thoughts on the discussion above?</p>



<a name="497199634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199634">(Feb 01 2025 at 21:24)</a>:</h4>
<p>Awesome. The old syntax requires some bending over backwards that I'm going to happily rip out of the zig tokenizer.</p>



<a name="497199689"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199689" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199689">(Feb 01 2025 at 21:25)</a>:</h4>
<p>Re: replacing the trait-laden system we have in Rust with a more straight-forward parser struct with just a ton of methods on it working on some sort of input/state struct?</p>



<a name="497199703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199703">(Feb 01 2025 at 21:25)</a>:</h4>
<p>Yeah, that's exactly my thinking.</p>



<a name="497199707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199707">(Feb 01 2025 at 21:25)</a>:</h4>
<p>Straight-forward recursive descent</p>



<a name="497199717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199717">(Feb 01 2025 at 21:25)</a>:</h4>
<p>Sweet.  I'll continue exploring down this path then</p>



<a name="497199728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199728">(Feb 01 2025 at 21:25)</a>:</h4>
<p>Using your tokenizer output as input</p>



<a name="497199797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199797">(Feb 01 2025 at 21:26)</a>:</h4>
<p>Maybe we should have a branch on the main roc repo we can collaborate on?</p>



<a name="497199804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199804">(Feb 01 2025 at 21:26)</a>:</h4>
<p>Thank you for saving me a couple of hours of work with that!</p>



<a name="497199808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199808">(Feb 01 2025 at 21:26)</a>:</h4>
<p>Probably</p>



<a name="497199851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199851">(Feb 01 2025 at 21:27)</a>:</h4>
<p>Right now I don't have a ton of time so I'm just poking around - remembering how to write Zig, and exploring the design space</p>



<a name="497199879"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497199879" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497199879">(Feb 01 2025 at 21:27)</a>:</h4>
<p>If you're interested in design space exploration, here's an old prototype I wrote: <a href="https://github.com/joshuawarner32/roc/blob/cypress/crates/compiler/cypress/src/parse.rs">https://github.com/joshuawarner32/roc/blob/cypress/crates/compiler/cypress/src/parse.rs</a></p>



<a name="497200008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200008">(Feb 01 2025 at 21:29)</a>:</h4>
<p>Cool, I'll check it out</p>



<a name="497200019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200019">(Feb 01 2025 at 21:29)</a>:</h4>
<p>This is a design I've used (with some small tweaks) in parsers in Dart, Go, and Zig: <a href="https://gist.github.com/gamebox/947afc1fb18cae753be2d25a7ee777dd">https://gist.github.com/gamebox/947afc1fb18cae753be2d25a7ee777dd</a></p>



<a name="497200034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200034">(Feb 01 2025 at 21:30)</a>:</h4>
<p>Of course the AST-level methods would differ a lot</p>



<a name="497200152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200152">(Feb 01 2025 at 21:31)</a>:</h4>
<p>Yep, that looks like roughly the pattern I typically use.</p>



<a name="497200169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200169">(Feb 01 2025 at 21:31)</a>:</h4>
<p>btw Josh, check this out: <a href="https://github.com/ziglang/zig/pull/21257#issuecomment-2336865183">https://github.com/ziglang/zig/pull/21257#issuecomment-2336865183</a></p>



<a name="497200170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200170">(Feb 01 2025 at 21:31)</a>:</h4>
<p>Your prototype above is pretty INTERESTING!</p>



<a name="497200228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200228">(Feb 01 2025 at 21:32)</a>:</h4>
<p>(on the thing I posted above) I'm not super gung-ho on that direction at the moment, and it's probably not a thing we want to try to quickly prototype with, but that is somewhat closer zig's parser, and also has some perf advantages. (IIRC, it was ~2x faster than the current roc parser, prior to any attempts at micro optimization) But harder to read/develop.</p>



<a name="497200239"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200239" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200239">(Feb 01 2025 at 21:32)</a>:</h4>
<p>Yeah, it looks very DOD style</p>



<a name="497200252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200252">(Feb 01 2025 at 21:32)</a>:</h4>
<p>Seems like something Andrew K would enjoy</p>



<a name="497200282"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200282" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200282">(Feb 01 2025 at 21:33)</a>:</h4>
<p>But micro-optimizing the parser perf doesn't make a ton of sense given how much compile time is usually devoted to it</p>



<a name="497200300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200300">(Feb 01 2025 at 21:33)</a>:</h4>
<p>_IF_ it makes the parser harder maintain or debug</p>



<a name="497200379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200379">(Feb 01 2025 at 21:34)</a>:</h4>
<p>It was like 30% win, 70% loss for debuggability</p>



<a name="497200422"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200422" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200422">(Feb 01 2025 at 21:35)</a>:</h4>
<p>The fact that the parser state was easily serializable and inspectable at any point make it really easy to visualize what's going.</p>



<a name="497200508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200508">(Feb 01 2025 at 21:36)</a>:</h4>
<p>That's great.  I'll try to read through it tonight when I have more time</p>



<a name="497200542"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200542" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200542">(Feb 01 2025 at 21:37)</a>:</h4>
<p>But at the same time it's a very _weird_ pattern. The combination of the rigid linear layout of the AST, roc's somewhat weird grammar, and trying to do it "stackless" made it all a lot more headache than it really needed to be.</p>



<a name="497200577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200577">(Feb 01 2025 at 21:38)</a>:</h4>
<p>the thing I linked to makes it possible to do a really direct state machine style</p>



<a name="497200623"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200623" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200623">(Feb 01 2025 at 21:38)</a>:</h4>
<p>where you're basically like "if I encounter this condition, GOTO this other place"</p>



<a name="497200642"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200642" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200642">(Feb 01 2025 at 21:38)</a>:</h4>
<p>except instead of actual gotos, they're all labeled</p>



<a name="497200646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200646">(Feb 01 2025 at 21:39)</a>:</h4>
<p>Sorry Richard, I don't have any experience with that kind of parser (I'm a one-trick pony with RD), do you have an example to share?</p>



<a name="497200689"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200689" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200689">(Feb 01 2025 at 21:39)</a>:</h4>
<p>(I can imagine a simple example, but at the scale of a full PL grammar it's hard)</p>



<a name="497200707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200707">(Feb 01 2025 at 21:39)</a>:</h4>
<p>Actually it reminds me of the grammar that's made by Nearly</p>



<a name="497200759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200759">(Feb 01 2025 at 21:40)</a>:</h4>
<p>it's what simdjson uses for the parsing step, except they use actual goto <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="497200774"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200774" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200774">(Feb 01 2025 at 21:40)</a>:</h4>
<p>(I don't have a link handy and I'm on mobile)</p>



<a name="497200775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200775">(Feb 01 2025 at 21:40)</a>:</h4>
<p>Which is a tool I was forced into using for making the Formula language in our product (in JS)</p>



<a name="497200782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200782">(Feb 01 2025 at 21:40)</a>:</h4>
<p>I'll take a look at it</p>



<a name="497200789"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200789" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200789">(Feb 01 2025 at 21:40)</a>:</h4>
<p>I think they do it for performance, but it seems like it would be super straightforward to read and understand</p>



<a name="497200791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200791">(Feb 01 2025 at 21:40)</a>:</h4>
<p>It's been a while since I read about simdjson</p>



<a name="497200818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200818">(Feb 01 2025 at 21:41)</a>:</h4>
<p>don't look at the lexer <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="497200819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200819">(Feb 01 2025 at 21:41)</a>:</h4>
<p>I think complicated state machines can be very hard to understand a non-linear flow</p>



<a name="497200911"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200911" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200911">(Feb 01 2025 at 21:42)</a>:</h4>
<p>But I am open minded!</p>



<a name="497200939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200939">(Feb 01 2025 at 21:43)</a>:</h4>
<p>oh btw, I think we should restrict line lengths to u16 and total number of lines per file to u16</p>



<a name="497200947"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200947" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200947">(Feb 01 2025 at 21:43)</a>:</h4>
<p>so regions can be more compact</p>



<a name="497200956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200956">(Feb 01 2025 at 21:43)</a>:</h4>
<p>Think of it as a while loop with a switch statement in it over the current state of the state machine. It really isn't anything special.</p>



<a name="497200962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497200962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497200962">(Feb 01 2025 at 21:43)</a>:</h4>
<p>Just more optimized than that</p>



<a name="497201024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201024">(Feb 01 2025 at 21:44)</a>:</h4>
<p>I'm fine saying you can't have a line that's more than 65k lines long, and also that you can't have a .roc file that's more than 65k lines long</p>



<a name="497201180"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201180" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201180">(Feb 01 2025 at 21:46)</a>:</h4>
<p>I guess we’ll cross the “Why can’t you compile my 80k LOC module” bridge when we get there</p>



<a name="497201198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201198">(Feb 01 2025 at 21:46)</a>:</h4>
<p>In some ways you could say we’ve made it if we do</p>



<a name="497201227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201227">(Feb 01 2025 at 21:47)</a>:</h4>
<p>oh that's easy: "Because .roc files aren't allowed to be that long. You have to split it up."</p>



<a name="497201233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201233">(Feb 01 2025 at 21:47)</a>:</h4>
<p>I'm so excited for when this rewrite leads to having proper debug info in the llvm backend</p>



<a name="497201296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201296">(Feb 01 2025 at 21:48)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I wonder how debugging in an interpreter backend could work</p>



<a name="497201357"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201357" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201357">(Feb 01 2025 at 21:49)</a>:</h4>
<p>step debugging I mean</p>



<a name="497201383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201383">(Feb 01 2025 at 21:49)</a>:</h4>
<p>I don't think it could possibly be compatible with gdb/lldb unless I'm missing something</p>



<a name="497201440"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201440" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201440">(Feb 01 2025 at 21:50)</a>:</h4>
<p>I think it would need to do its own thing</p>



<a name="497201442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201442">(Feb 01 2025 at 21:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497200939">said</a>:</p>
<blockquote>
<p>oh btw, I think we should restrict line lengths to u16 and total number of lines per file to u16</p>
</blockquote>
<p>Maybe even u8 line lengths?</p>



<a name="497201446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201446">(Feb 01 2025 at 21:50)</a>:</h4>
<p>Probably need to look into pdb more. Probably has things to learn from</p>



<a name="497201460"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201460" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201460">(Feb 01 2025 at 21:50)</a>:</h4>
<p>Never mind I guess that wouldn’t help because of alignment</p>



<a name="497201594"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201594" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201594">(Feb 01 2025 at 21:52)</a>:</h4>
<p>yeah unless we did SoA regions or something <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497201662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201662">(Feb 01 2025 at 21:53)</a>:</h4>
<p>Did zig end up going with a raw u32 offset? Then they recalculated line and col info if it is needed? Not sure that is a better choice. It is more flexible though.</p>



<a name="497201679"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201679" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201679">(Feb 01 2025 at 21:54)</a>:</h4>
<p>hm actually in Zig it might be pretty easy to do a packed struct of a u32 split into a u20 and u12</p>



<a name="497201727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201727">(Feb 01 2025 at 21:54)</a>:</h4>
<p>oh yeah I think they did</p>



<a name="497201764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201764">(Feb 01 2025 at 21:55)</a>:</h4>
<p>I wonder about that for editor tooling, but maybe it's fine?</p>



<a name="497201787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201787">(Feb 01 2025 at 21:55)</a>:</h4>
<p>like the find all references example</p>



<a name="497201788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201788">(Feb 01 2025 at 21:55)</a>:</h4>
<p>Cause you only need line and col for warnings and errors....I guess you also need it for expect and dbg messages...</p>
<p>Hmm, don't you need it for every node in llvm for debug info?</p>



<a name="497201795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201795">(Feb 01 2025 at 21:55)</a>:</h4>
<p>oh yeah probably</p>



<a name="497201856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497201856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497201856">(Feb 01 2025 at 21:56)</a>:</h4>
<p>And yeah, I think something like U22, U12 sounds amazing. Like pick a reasonable line that allows for longer files at the cost of shorter lines</p>



<a name="497202041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497202041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497202041">(Feb 01 2025 at 21:59)</a>:</h4>
<p>Using offset only is pretty typical</p>



<a name="497202059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497202059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497202059">(Feb 01 2025 at 21:59)</a>:</h4>
<p>You can just pass the input to the reporter and have it calculate the line:col positions on the fly</p>



<a name="497202072"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497202072" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497202072">(Feb 01 2025 at 22:00)</a>:</h4>
<p>My parser above does that</p>



<a name="497202352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497202352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497202352">(Feb 01 2025 at 22:03)</a>:</h4>
<p>u32 split into a u20 and u12 would allow individual lines to be 4096 bytes and then each file could have up to 1M lines</p>



<a name="497202353"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497202353" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497202353">(Feb 01 2025 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497128203">said</a>:</p>
<blockquote>
<p>Tried translating an old tokenizer experiment from rust to zig: <a href="https://github.com/joshuawarner32/roc/blob/c80a3ba0e453abf495619a1abf8ed28c9e6ff909/zig/tokenize/src/main.zig">https://github.com/joshuawarner32/roc/blob/c80a3ba0e453abf495619a1abf8ed28c9e6ff909/zig/tokenize/src/main.zig</a></p>
</blockquote>
<p>saw this last night and made this: <a href="https://clbin.com/m5TF7">https://clbin.com/m5TF7</a></p>
<p>when you have 2+ ArrayList with the same length, that's a great case for MultiArrayList which is equivalent but will have only 1 length field for all of them, as well as manage exactly 1 allocation for all the arrays</p>



<a name="497202507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497202507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497202507">(Feb 01 2025 at 22:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497105120">said</a>:</p>
<blockquote>
<p>so the (very serious) debuggability/ergonomics downside we've had of doing SoA in Rust may just be a non-issue in Zig</p>
</blockquote>
<p>with the llvm backend it's still a pain in the ass to debug MultiArrayList, however, with our self-hosted backends (currently x86_64 only, aarch64 to follow next) we have custom dwarf + <a href="https://github.com/ziglang/zig/wiki/LLDB-for-Zig">lldb fork</a> that recognizes zig std lib types and makes debugging really nice. same thing goes for hash maps</p>
<p><a href="https://calabro.io/uscope">this project</a> may be interesting to watch long term since jacobly (author of above lldb fork as well as zig's x86_64 backend) has taken an interest in it</p>



<a name="497202640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497202640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497202640">(Feb 01 2025 at 22:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497202059">said</a>:</p>
<blockquote>
<p>You can just pass the input to the reporter and have it calculate the line:col positions on the fly</p>
</blockquote>
<p>Yeah, would just require calculating all line and col offsets when generating debug info. So not sure it is that much of a gain.</p>



<a name="497203010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497203010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497203010">(Feb 01 2025 at 22:13)</a>:</h4>
<p>I know this is a silly metric, but I hope with the new compiler rewrite I'll feel confident figuring out any part of the compiler. Currently, parser is manageable but pretty opaque to me. Some of type checking is fine, but a lot is hard to follow fully. Obviously don't really know where to start with our more complex type related passes. Then I can understand all the backends, but I think some of that is due to lots of exposure rather than them being clean or simple.</p>



<a name="497203285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497203285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497203285">(Feb 01 2025 at 22:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497202640">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497202059">said</a>:</p>
<blockquote>
<p>You can just pass the input to the reporter and have it calculate the line:col positions on the fly</p>
</blockquote>
<p>Yeah, would just require calculating all line and col offsets when generating debug info. So not sure it is that much of a gain.</p>
</blockquote>
<p>For a normal use case you are reporting multiple orders of magnitude fewer problems than you are parsing AST nodes</p>



<a name="497203356"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497203356" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497203356">(Feb 01 2025 at 22:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497199519">said</a>:</p>
<blockquote>
<p>it looks like there's already enough here to try out zig's builtin fuzzing on! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>
</blockquote>
<p>Fuzzing is very alpha right now, I recommend to join zig development if you want to play with it. I mean really alpha like I have a branch with everything rewritten that I haven't merged yet. I expect that to become beta quality during the 0.15.0 release cycle. I will say though having it integrated into the compiler tool chain and unit tests is going to be a killer feature. I even have a web UI where you can watch the fuzzer find new code paths in realtime</p>



<a name="497203358"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497203358" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497203358">(Feb 01 2025 at 22:18)</a>:</h4>
<p>I’ve used it in three parser projects and it was still fast enough</p>



<a name="497203983"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497203983" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497203983">(Feb 01 2025 at 22:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497201024">said</a>:</p>
<blockquote>
<p>I'm fine saying you can't have a line that's more than 65k lines long, and also that you can't have a .roc file that's more than 65k lines long</p>
</blockquote>
<p>would you believe me if I told you we had a hand-written, hand-maintained file in the zig compiler codebase that uses 78% of this quota <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="497204912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497204912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497204912">(Feb 01 2025 at 22:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="406911">Andrew Kelley</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497203356">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497199519">said</a>:</p>
<blockquote>
<p>it looks like there's already enough here to try out zig's builtin fuzzing on! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>
</blockquote>
<p>Fuzzing is very alpha right now, I recommend to join zig development if you want to play with it. I mean really alpha like I have a branch with everything rewritten that I haven't merged yet. I expect that to become beta quality during the 0.15.0 release cycle. I will say though having it integrated into the compiler tool chain and unit tests is going to be a killer feature. I even have a web UI where you can watch the fuzzer find new code paths in realtime</p>
</blockquote>
<p>I assume it is easy to plug zig into existing c++ fuzzers currently? Like libfuzzer and afl? Just need to compile zig with some extra llvm flags for coverage info, right?</p>



<a name="497210795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497210795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497210795">(Feb 02 2025 at 00:19)</a>:</h4>
<p>Glad to see everyone hyped about this. I'm going to move this discussion into our compiler development channel to recover the contributor coord thread. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="497210831"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497210831" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497210831">(Feb 02 2025 at 00:19)</a>:</h4>
<p>292 messages were moved here from <a class="stream-topic" data-stream-id="316715" href="/#narrow/channel/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232">#contributing &gt; contributor coordination meeting - Feb 2024 #2</a> by <span class="user-mention silent" data-user-id="515757">Luke Boswell</span>.</p>



<a name="497211006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497211006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497211006">(Feb 02 2025 at 00:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497199797">said</a>:</p>
<blockquote>
<p>Maybe we should have a branch on the main roc repo we can collaborate on?</p>
</blockquote>
<p>I think this would be a good idea.</p>
<p>We discussed all the zig code should live under <code>src/</code>, so I think just start with that structure is ok. </p>
<p>Also for the parser stage - tokenizer specifically.. I think it would live somewhere like <br>
<code>/src/check/parse/tokenize/...</code> based on the presentation we were organising verything according to it's function and nesting from the top-down, phases-&gt;stages-&gt;etc</p>



<a name="497211197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497211197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497211197">(Feb 02 2025 at 00:26)</a>:</h4>
<p>One thing I'm really unsure about because I haven't researched it yet, is if we want or need to organise all of the zig modules into separate zig "packages" or if that is just unnecessary. </p>
<p>One of the goals is for it to be easy for tooling to reach in and use the code for multiple purposes. </p>
<p>Do we need to define these boundaries ahead of time and separate them into packages? or are zig modules easy to refer to, like rust crates?</p>



<a name="497212189"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497212189" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497212189">(Feb 02 2025 at 00:45)</a>:</h4>
<p>I think we should use a separate folder but not a separate branch</p>



<a name="497212205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497212205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497212205">(Feb 02 2025 at 00:45)</a>:</h4>
<p>better to just keep merging stuff into <code>main</code> since we're not going to cause merge conflicts with any existing PRs anyway <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="497212414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497212414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497212414">(Feb 02 2025 at 00:49)</a>:</h4>
<p>To clarify this <code>/src/check/parse/tokenize/...</code>, in my mind this is a structure like;  </p>
<ol>
<li><code>check</code> phase</li>
<li><code>parse</code> stage</li>
<li><code>tokenize</code> function</li>
</ol>
<p>I like to structure things based on their function or behaviour, for at least the top one or two levels. But I appreciate that this can be a controversial topic.</p>



<a name="497212485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497212485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497212485">(Feb 02 2025 at 00:50)</a>:</h4>
<p>Yeah, trying to organize roughly based on pass ordering and IR sounds like a great idea. Should help avoid dependency messes.</p>



<a name="497212530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497212530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497212530">(Feb 02 2025 at 00:51)</a>:</h4>
<p>Though tokenize may just be <code>tokenize.zig</code> in this case. Only needs to be a folder if it is so complex that it needs many files</p>



<a name="497212727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497212727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497212727">(Feb 02 2025 at 00:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497204912">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="406911">Andrew Kelley</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497203356">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/contributor.20coordination.20meeting.20-.20Feb.202024.20.232/near/497199519">said</a>:</p>
<blockquote>
<p>it looks like there's already enough here to try out zig's builtin fuzzing on! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>
</blockquote>
<p>Fuzzing is very alpha right now, I recommend to join zig development if you want to play with it. I mean really alpha like I have a branch with everything rewritten that I haven't merged yet. I expect that to become beta quality during the 0.15.0 release cycle. I will say though having it integrated into the compiler tool chain and unit tests is going to be a killer feature. I even have a web UI where you can watch the fuzzer find new code paths in realtime</p>
</blockquote>
<p>I assume it is easy to plug zig into existing c++ fuzzers currently? Like libfuzzer and afl? Just need to compile zig with some extra llvm flags for coverage info, right?</p>
</blockquote>
<p>Yeah that all works, I recently tried out that use case and fixed a few codegen things to make it a smooth experience. I think Loris has a nice example somewhere, let me grab a link and make sure it still builds</p>



<a name="497216667"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497216667" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497216667">(Feb 02 2025 at 02:02)</a>:</h4>
<p>Useful talks to watch if you want more context on DOD and how things are done in the zig compiler. Likely will help with thinking about how to model data structures in the new compiler:<br>
<a href="https://youtu.be/IroPQ150F6c?si=KfAFMumPd1K44fWA">Andrew Kelley Practical Data Oriented Design (DoD)</a><br>
<a href="https://youtu.be/KOZcJwGdQok?si=NKK0iXHxInXsErM3">Data-Oriented Design Revisited: Type Safety in the Zig Compiler - Matthew Lugg</a></p>
<div class="youtube-video message_inline_image"><a data-id="IroPQ150F6c" href="https://youtu.be/IroPQ150F6c?si=KfAFMumPd1K44fWA"><img src="https://uploads.zulipusercontent.net/1d09c7a84eb347cc4f11baa9a6c2df0af9473718/68747470733a2f2f692e7974696d672e636f6d2f76692f49726f50513135304636632f64656661756c742e6a7067"></a></div><div class="youtube-video message_inline_image"><a data-id="KOZcJwGdQok" href="https://youtu.be/KOZcJwGdQok?si=NKK0iXHxInXsErM3"><img src="https://uploads.zulipusercontent.net/77c7ba4f0729f01fcb5cb34d949753b24c323046/68747470733a2f2f692e7974696d672e636f6d2f76692f4b4f5a634a774764516f6b2f64656661756c742e6a7067"></a></div>



<a name="497216906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497216906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497216906">(Feb 02 2025 at 02:06)</a>:</h4>
<p>second talk especially has zig compiler ir specific designs and example code.</p>



<a name="497219399"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497219399" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497219399">(Feb 02 2025 at 02:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497200939">said</a>:</p>
<blockquote>
<p>oh btw, I think we should restrict line lengths to u16 and total number of lines per file to u16</p>
</blockquote>
<p>We currently use u32's to indicate positions in the syntax tree at least (and I _think_ elsewhere). Just byte index into the original string. That's both (1) the same size as 2 u16's, and (2) more flexible - i.e. you can have 17k lines just fine, so long as they're normal length lines. </p>
<p>I have definitely worked in projects with one or more files with 16k+ lines. While I don't want to encourage that, it's also a small enough limit that it doesn't feel worth it to enforce.</p>



<a name="497220004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497220004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497220004">(Feb 02 2025 at 02:59)</a>:</h4>
<p>Seems really easy to go over 16k lines with codegen</p>



<a name="497220971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497220971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497220971">(Feb 02 2025 at 03:16)</a>:</h4>
<p>re: <a class="message-link" href="/#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497212727">#compiler development &gt; zig compiler - spike @ 💬</a> </p>
<p><a href="https://github.com/kristoff-it/zig-afl-kit/">https://github.com/kristoff-it/zig-afl-kit/</a></p>
<p>if you give this a spin, I recommend to have a chat with Loris if you run into any issues. I didn't try using AFL yet other than reading the source code since I'm more interested in advancing the integrated fuzzing implementation</p>



<a name="497221078"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221078" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221078">(Feb 02 2025 at 03:18)</a>:</h4>
<p><span class="user-mention" data-user-id="406911">@Andrew Kelley</span> Applied your suggestions - thanks!<br>
FWIW, the reason for adding an extra entry to <code>self.output.offsets</code> was essentially the same job an Eof token would be doing. In the parser that corresponded to this, having that there avoided some branches - but I didn't need the actual eof token itself, so I never added it. <span aria-label="man shrugging" class="emoji emoji-1f937-200d-2642" role="img" title="man shrugging">:man_shrugging:</span> Went ahead and replaced that with a proper EndOfFile token.</p>



<a name="497221100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221100">(Feb 02 2025 at 03:19)</a>:</h4>
<p>Also added the import keyword, removed the NoSpace weirdness, and it now supports snake_case idents</p>



<a name="497221223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221223">(Feb 02 2025 at 03:21)</a>:</h4>
<p>ah yeah I figured it was something like that</p>



<a name="497221389"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221389" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221389">(Feb 02 2025 at 03:24)</a>:</h4>
<p>Tokenizer PR here: <a href="https://github.com/roc-lang/roc/pull/7569">https://github.com/roc-lang/roc/pull/7569</a></p>



<a name="497221395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221395">(Feb 02 2025 at 03:24)</a>:</h4>
<p>another thing you might have fun playing with is <a href="https://github.com/ziglang/zig/pull/21257#issuecomment-2336865183">labeled switch continue</a>. In the case that the value used is comptime known, it's a direct branch to the other case. This is a common optimization trick used by emulators for example. <a href="https://github.com/ziglang/zig/pull/21367">When we switched our tokenizer to use it, we observed a 13% perf improvement</a></p>



<a name="497221409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221409">(Feb 02 2025 at 03:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497221389">said</a>:</p>
<blockquote>
<p>Tokenizer PR here: <a href="https://github.com/roc-lang/roc/pull/7569">https://github.com/roc-lang/roc/pull/7569</a></p>
</blockquote>
<p>IT BEGINS</p>



<a name="497221439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221439">(Feb 02 2025 at 03:25)</a>:</h4>
<p>(btw, please please rip my zig code to shreds; this is a useful learning opportunity)</p>



<a name="497221446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221446">(Feb 02 2025 at 03:25)</a>:</h4>
<p>re: labeled switch continue<br>
Ohhhh Richard posted that above, but I didn't get the connection initially. I'll check it out!</p>



<a name="497221500"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221500" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221500">(Feb 02 2025 at 03:26)</a>:</h4>
<p>it's also just like really satisfying to use for some reason, idk if it's just me</p>



<a name="497221655"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497221655" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497221655">(Feb 02 2025 at 03:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497221439">said</a>:</p>
<blockquote>
<p>(btw, please please rip my zig code to shreds; this is a useful learning opportunity)</p>
</blockquote>
<p>ok, you got it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> I trust you to tell me if it becomes too much</p>



<a name="497222461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497222461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497222461">(Feb 02 2025 at 03:42)</a>:</h4>
<p>I'll be curious to hear how the perf measures up old code vs new code, although I'm sure the tokenizer is insignificant compared to the rest of the pipeline</p>



<a name="497231559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497231559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497231559">(Feb 02 2025 at 06:13)</a>:</h4>
<p>General request:</p>
<p>As we spin up this new compiler, can we try to add file and function doc comments to everything (or at least everything exposed). They can be super simple, but I think if we start from the core with a culture of documentation it will be very useful. I think we will be much much more likely to document the compiler flow if we are separate stages of the compiler into different files and we add a high level comment about the goal of each file and roughly what it is meant to do.</p>



<a name="497259791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497259791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497259791">(Feb 02 2025 at 13:44)</a>:</h4>
<p>Beyond Rust compiler compilation speedup that is irrelevant with Zig's compilation speeds, I don't think there's a good reason to split our compiler into separate libraries. Folders seem sufficient. To that end, I don't think we should consolidate the IR into a single place, that moves the data types away from the logic that operates on them. I'm gonna put the IRs in their respective stage folders, probably in <code>&lt;phase&gt;/&lt;stage&gt;/ir.zig</code></p>



<a name="497259822"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497259822" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497259822">(Feb 02 2025 at 13:45)</a>:</h4>
<p>I agree with that</p>



<a name="497270679"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497270679" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497270679">(Feb 02 2025 at 16:28)</a>:</h4>
<p>Totally agree</p>



<a name="497314701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497314701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497314701">(Feb 03 2025 at 02:05)</a>:</h4>
<p>Fun random thing I just realized. Cause the interpreter will be written in zig, it will be able to just call the zig builtins without any sort of ffi complexities.</p>



<a name="497314913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497314913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497314913">(Feb 03 2025 at 02:06)</a>:</h4>
<p>Yeah that was one of the big motivating factors Richard mentioned. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="497319406"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497319406" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497319406">(Feb 03 2025 at 03:00)</a>:</h4>
<p>How does one organize a large multi-file zig project?</p>



<a name="497319478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497319478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497319478">(Feb 03 2025 at 03:01)</a>:</h4>
<p>Do you make intermediate libraries that reference other libs? Or is it better to do one big source tree that builds into a single exe?</p>



<a name="497320055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320055">(Feb 03 2025 at 03:07)</a>:</h4>
<p>On big source tree with direct file imports from what I have seen</p>



<a name="497320380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320380">(Feb 03 2025 at 03:11)</a>:</h4>
<p>I've starting putting a simple shell for the cli together... not sure if it's something we'll want to keep. But something to parse the cli args and build a binary from. Based pretty heavily off the zig compiler. -- mostly as a learning exercise, but I plan to make it a PR so we have something.</p>



<a name="497320386"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320386" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320386">(Feb 03 2025 at 03:11)</a>:</h4>
<p>I'm not sure the exact standard, but I would assume something like:</p>
<div class="codehilite"><pre><span></span><code>build.zig
build.zig.zon
main.zig

&lt;phase.zig&gt;
&lt;phase&gt;/&lt;stage&gt;.zig
&lt;phase&gt;/&lt;stage&gt;/something.zig
</code></pre></div>
<p>Where zig files are only allowed to import from files at the same level or from a level deeper if the folder name matches the zig file name. That enables clean separation of various parts of the compiler with clear interfaces</p>



<a name="497320410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320410">(Feb 03 2025 at 03:12)</a>:</h4>
<p>And how does that work with tests? One test target from main.zig? Or multiple?</p>



<a name="497320472"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320472" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320472">(Feb 03 2025 at 03:12)</a>:</h4>
<p>And if a <code>&lt;stage&gt;</code> is small enough, or just getting started, it may just be in one file. In that case it would just be <code>&lt;phase&gt;/&lt;stage&gt;.zig</code> and there would be no <code>&lt;phase&gt;/&lt;stage&gt;/something.zig</code></p>



<a name="497320608"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320608" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320608">(Feb 03 2025 at 03:14)</a>:</h4>
<p>I'm not sure the best way to do tests. One natural way (but may not scale well) is to put tests at the bottom of the file. That way I can just do <code>zig test &lt;phase&gt;/&lt;stage&gt;.zig</code> to run all tests for a specific stage.</p>



<a name="497320667"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320667" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320667">(Feb 03 2025 at 03:15)</a>:</h4>
<p>But it might be cleaner to make a separate test directory. Based on experience with rust, you want a reasonable number of test executables/targets. If you have too many, it wastes a crap ton of time linking them all. If you have too few, you have to compile way too much code for small changes.</p>



<a name="497320684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320684">(Feb 03 2025 at 03:15)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="406911">@Andrew Kelley</span> in case he has any good tips on zig project organization.</p>



<a name="497320737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320737">(Feb 03 2025 at 03:16)</a>:</h4>
<p>I have this right now:<br>
<a href="/user_uploads/22008/ypRTtM3FWVuqczj7T2NVt5W2/Screenshot-2025-02-02-at-19.15.34.png">Screenshot 2025-02-02 at 19.15.34.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/ypRTtM3FWVuqczj7T2NVt5W2/Screenshot-2025-02-02-at-19.15.34.png" title="Screenshot 2025-02-02 at 19.15.34.png"><img data-original-content-type="image/png" data-original-dimensions="492x570" src="/user_uploads/thumbnail/22008/ypRTtM3FWVuqczj7T2NVt5W2/Screenshot-2025-02-02-at-19.15.34.png/840x560.webp"></a></div><p>Having trouble importing the tokenizer from the parser:</p>
<div class="codehilite"><pre><span></span><code>check/parse/parse.zig:2:27: error: import of file outside module path: '../tokenizer/tokenizer.zig'
const tokenizer = @import("../tokenizer/tokenizer.zig");
                          ^~~~~~~~~~~~~~~~~~~~~~~~~~~~
</code></pre></div>



<a name="497320818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320818">(Feb 03 2025 at 03:17)</a>:</h4>
<p>I think it should be:</p>
<div class="codehilite"><pre><span></span><code>check/parse.zig
check/tokenize.zig
</code></pre></div>



<a name="497320879"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320879" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320879">(Feb 03 2025 at 03:18)</a>:</h4>
<p>If parse needs to be split over multiple files, it would be:</p>
<div class="codehilite"><pre><span></span><code>check/parse.zig
check/parse/subpart1.zig
check/parse/subpart2.zig
</code></pre></div>



<a name="497320890"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320890" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320890">(Feb 03 2025 at 03:18)</a>:</h4>
<p>Ahhhhh cool</p>



<a name="497320922"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497320922" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497320922">(Feb 03 2025 at 03:18)</a>:</h4>
<p>Being a beginner is fun <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497321064"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497321064" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497321064">(Feb 03 2025 at 03:20)</a>:</h4>
<p>I'm definitely still a beginner in terms of expected zig project organization. Though I have worked on a few zig projects at this point, I have never touched anything large or dealt with best practices around organization</p>



<a name="497321135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497321135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497321135">(Feb 03 2025 at 03:21)</a>:</h4>
<p>This is just some stuff I have gleamed from looking at the zig compiler itself, but I really have not studied it thoroughly</p>



<a name="497321257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497321257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497321257">(Feb 03 2025 at 03:22)</a>:</h4>
<blockquote>
<p>File names fall into two categories: types and namespaces. If the file (implicitly a struct) has top level fields, it should be named like any other struct with fields using <code>TitleCase</code>. Otherwise, it should use <code>snake_case</code>. Directory names should be<code>snake_case</code>.</p>
</blockquote>
<p><a href="https://ziglang.org/documentation/0.13.0/#Names">https://ziglang.org/documentation/0.13.0/#Names</a></p>



<a name="497321450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497321450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497321450">(Feb 03 2025 at 03:25)</a>:</h4>
<p>Also, the pattern I described follows what the zig standard library does for reference</p>



<a name="497321712"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497321712" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497321712">(Feb 03 2025 at 03:28)</a>:</h4>
<p>Also, the <code>TitleCase</code> just for reference is used to define a type in a single file. For example, instead of defining <code>Cursor</code> in <code>tokenize.zig</code> you could instead put it in <code>tokenize/Cursor.zig</code>. In this case, you would literally copy <a href="https://github.com/roc-lang/roc/pull/7569/files#diff-c2a2fc09334f303fce8313a1c4bfb2a82735c22b8db2d03e990419cd212daf60R309-R642">all of the lines within <code>struct { ... }</code></a> as the contents of <code>Cursor.zig</code>.</p>



<a name="497321787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497321787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497321787">(Feb 03 2025 at 03:29)</a>:</h4>
<p>Anyway, for structure purpose, I think that we should put unit tests at the bottom of the relevant file. For our larger integration tests, we probably want them to be standalone executables that read the snapshots and what not.</p>



<a name="497322280"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497322280" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497322280">(Feb 03 2025 at 03:35)</a>:</h4>
<p>Also, just to explain one more design point, if we have:</p>
<div class="codehilite"><pre><span></span><code>check/parse.zig
check/parse/ir.zig
check/canonicalize.zig
</code></pre></div>
<p>and <code>canonicalize</code> needs access to <code>parse/ir.zig</code>, it would do:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@import</span><span class="p">(</span><span class="s">"parse.zig"</span><span class="p">);</span>
<span class="kr">const</span><span class="w"> </span><span class="n">ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p">.</span><span class="n">ir</span><span class="p">;</span>
</code></pre></div>



<a name="497322374"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497322374" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497322374">(Feb 03 2025 at 03:36)</a>:</h4>
<p>and parse would need to export the ir for can to import</p>



<a name="497322651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497322651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497322651">(Feb 03 2025 at 03:40)</a>:</h4>
<p>Here's my WIP for the cli <a href="https://github.com/roc-lang/roc/pull/7571">https://github.com/roc-lang/roc/pull/7571</a></p>



<a name="497323600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497323600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497323600">(Feb 03 2025 at 03:53)</a>:</h4>
<p>If others are ok with it, I'm heavily interested in working on the interpreter. Of course, it depends on getting everything wired through type checking before it can be worked on. I feel like it is the highest level thing that I can really help with (both initial implementation and eventual optimizations). I'm sure I'll need help finding the correct design around type info and such, but sounds like a fun project. (also, I'm sure more than one person can work on the interpreter if others are interested).</p>
<p>Hopefully will be able to start by working only with self contained examples that don't need platforms then can expand to passing in pointers for allocators and effects. Will be interesting eventually getting it working in wasm too.</p>



<a name="497323635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497323635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497323635">(Feb 03 2025 at 03:53)</a>:</h4>
<p>Otherwise, hopefully I can help with reviews and some high level zig organizational stuff.</p>



<a name="497333948"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497333948" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497333948">(Feb 03 2025 at 05:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497322651">said</a>:</p>
<blockquote>
<p>Here's my WIP for the cli <a href="https://github.com/roc-lang/roc/pull/7571">https://github.com/roc-lang/roc/pull/7571</a></p>
</blockquote>
<p>What order do we want to land things in. Someone has to put the base zig config and organization together. Currently both this and <span class="user-mention" data-user-id="453336">@Joshua Warner</span>'s PR both are setting up the zig build and what not.</p>



<a name="497334307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497334307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497334307">(Feb 03 2025 at 05:38)</a>:</h4>
<p>I'm still cleaning mine up from the feedback. If Josh's merges first I can merge any updates and adapt it.</p>



<a name="497334401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497334401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497334401">(Feb 03 2025 at 05:39)</a>:</h4>
<p>It sounds like your keen to start on things. Also feel free to push to my branch. I'm not precious about what I have so far... and probably wont be doing much for the next 18hrs</p>



<a name="497334513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497334513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497334513">(Feb 03 2025 at 05:40)</a>:</h4>
<blockquote>
<p>It sounds like your keen to start on things</p>
</blockquote>
<p>I guess so, though not like I have that much time at the end of today.</p>



<a name="497335417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497335417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497335417">(Feb 03 2025 at 05:48)</a>:</h4>
<p>Yeah, I'm so hyped about the zig stuff... I just want to work on this instead of my actual work. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497336841"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497336841" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497336841">(Feb 03 2025 at 06:01)</a>:</h4>
<p>Also, as a general note, I feel like for some things I might just make cleanup PRs for instead of adding PR comments. Just feel liking cleaning up some code will be easier to just show the changes that I think would be nice than add a ton of comments. On top of that, they aren't pressing, so I don't think they are worth tons of iteration on PRs for.</p>



<a name="497337685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497337685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497337685">(Feb 03 2025 at 06:07)</a>:</h4>
<p>Sounds good. I like the feedback because I'm learning. But appreciate its a lot more work.</p>



<a name="497337814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497337814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497337814">(Feb 03 2025 at 06:08)</a>:</h4>
<p>At a minimum, I'll make sure to add original authors as reviewers.</p>



<a name="497341605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497341605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497341605">(Feb 03 2025 at 06:39)</a>:</h4>
<p>Yep, definitely better to just do cleanup PRs for now.</p>



<a name="497341697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497341697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497341697">(Feb 03 2025 at 06:40)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> don't the build.zig ans build.zig.zon usually go in the folder outside of src?</p>



<a name="497341759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497341759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497341759">(Feb 03 2025 at 06:40)</a>:</h4>
<p>I think we could just leave those in the root of the roc repo and they won't interfere with anything</p>



<a name="497377216"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497377216" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497377216">(Feb 03 2025 at 09:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497322651">said</a>:</p>
<blockquote>
<p>Here's my WIP for the cli <a href="https://github.com/roc-lang/roc/pull/7571">https://github.com/roc-lang/roc/pull/7571</a></p>
</blockquote>
<p>Ok... I've fixed <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span>'s suggestions. I think we could just merge this and then we've got a basic structure to start working with.</p>



<a name="497377269"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497377269" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497377269">(Feb 03 2025 at 09:34)</a>:</h4>
<p>Anyone available to review?</p>



<a name="497429205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497429205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497429205">(Feb 03 2025 at 13:04)</a>:</h4>
<p>I approved you <span class="user-mention" data-user-id="515757">@Luke Boswell</span></p>



<a name="497547061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497547061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497547061">(Feb 03 2025 at 22:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497320684">said</a>:</p>
<blockquote>
<p>cc <span class="user-mention silent" data-user-id="406911">Andrew Kelley</span> in case he has any good tips on zig project organization.</p>
</blockquote>
<p>my main suggestion is to take advantage of namespace nesting, try to follow <a href="https://ziglang.org/documentation/master/#Style-Guide">these namespace-related suggestions</a>, and then once any given struct accumulates "too much" code inside of it, extract it to a separate file.</p>
<p>in my experience one generally ends up with weird/wrong organization when trying to guess ahead of time which files to put stuff in, but a nice organization arises when you prioritize the Fully Qualified Namespace Names having precise, accurate, non-redundant names</p>



<a name="497553239"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497553239" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497553239">(Feb 03 2025 at 23:40)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/7573">https://github.com/roc-lang/roc/pull/7573</a></p>
<ul>
<li>Improve cli command and option parsing -- refactor into a separate module and add tests.</li>
<li>Configure all tests to run from cli using <code>zig build test</code> -- tests to run are specified in <code>src/test.zig</code></li>
</ul>



<a name="497553332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497553332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497553332">(Feb 03 2025 at 23:41)</a>:</h4>
<p>Also .. I was surprised at first that just <code>zig build test</code> didn't report anything unless there is a failure. So I also "install"  the test binary so it can be run separately. </p>
<div class="codehilite"><pre><span></span><code>10:40:31 ~/Documents/GitHub/roc zig-cli $ zig build test
10:40:35 ~/Documents/GitHub/roc zig-cli $ zig build &amp;&amp; ./zig-out/bin/test
All 4 tests passed.
</code></pre></div>



<a name="497553512"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497553512" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497553512">(Feb 03 2025 at 23:43)</a>:</h4>
<p>I don't know if it's controversial... but for now you have to specify <code>roc run</code> and the <code>run</code> subcommand isn't optional. It just greatly simplifies the option parsing logic. I figure we could improve later if we still want that.</p>



<a name="497553688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497553688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497553688">(Feb 03 2025 at 23:44)</a>:</h4>
<p>Didn't we want to remove <code>roc run</code>? <a href="https://github.com/roc-lang/roc/issues/6637">https://github.com/roc-lang/roc/issues/6637</a></p>



<a name="497553858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497553858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497553858">(Feb 03 2025 at 23:45)</a>:</h4>
<p>Yes... well remove <code>roc dev</code> and <code>roc run</code> in favour of just <code>roc</code> was the plan ... but now I think it makes sense just to have <code>roc run</code> to simplify option parsing. So I've haven't added a <code>roc dev</code> or anything so we're still aligned with that new Cli workflow</p>



<a name="497553932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497553932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497553932">(Feb 03 2025 at 23:46)</a>:</h4>
<p>The options I'm parsing are based on that Issue and not the current implementation</p>



<a name="497553949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497553949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497553949">(Feb 03 2025 at 23:46)</a>:</h4>
<p><code>--opt size</code> <code>--opt none</code> etc</p>



<a name="497554010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497554010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497554010">(Feb 03 2025 at 23:47)</a>:</h4>
<p>Okay, that's good. I think we shouldn't do <code>roc run</code> even if it's simpler, though. Making <code>roc script.roc</code> work is what makes shebangs work</p>



<a name="497554036"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497554036" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497554036">(Feb 03 2025 at 23:47)</a>:</h4>
<p>I've ignored <code>--backend dev</code> etc.. because it sounds like we will only have the llvm backend. </p>
<p>So <code>roc run</code> would use the interpreter dev loop, and <code>roc build</code> would use llvm.</p>



<a name="497554247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497554247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497554247">(Feb 03 2025 at 23:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497554010">said</a>:</p>
<blockquote>
<p>Okay, that's good. I think we shouldn't do <code>roc run</code> even if it's simpler, though. Making <code>roc script.roc</code> work is what makes shebangs work</p>
</blockquote>
<p>I agree.. I'll have another crack at it in a follow up PR. </p>
<p>It was just challenging because we still support parsing options before providing the <code>path/to/app.roc</code> file to run, and we're not sure if we have invalid options or an invalid roc file path being passed. I'm sure there is a way to do it.</p>



<a name="497592906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497592906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497592906">(Feb 04 2025 at 06:40)</a>:</h4>
<p>Made a PR to start figuring out fuzzing: <a href="https://github.com/roc-lang/roc/pull/7574">https://github.com/roc-lang/roc/pull/7574</a></p>



<a name="497687767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497687767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497687767">(Feb 04 2025 at 15:03)</a>:</h4>
<blockquote>
<p>We discussed all the zig code should live under <code>src/</code>, so I think just start with that structure is ok.</p>
</blockquote>
<p>Can we move src, build.zig and build.zig.zon to a new separate folder (zig or zigcompiler...)? That way I can put a flake.nix in that folder instead of adding a flake-zig.nix at the root level that also requires custom <code>nix develop</code> flags to point to that flake etc.</p>



<a name="497688455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497688455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497688455">(Feb 04 2025 at 15:06)</a>:</h4>
<p>We definitely shouldn't move src somewhere else because that will mean we have to move like a hundred files in 3 months back to the root</p>



<a name="497688564"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497688564" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497688564">(Feb 04 2025 at 15:06)</a>:</h4>
<p>But I think just the build files would be okay</p>



<a name="497691405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497691405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497691405">(Feb 04 2025 at 15:18)</a>:</h4>
<p>Doesn't zig expect the layout to be:</p>
<div class="codehilite"><pre><span></span><code>src
build.zig
</code></pre></div>



<a name="497691643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497691643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497691643">(Feb 04 2025 at 15:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497688455">said</a>:</p>
<blockquote>
<p>We definitely shouldn't move src somewhere else because that will mean we have to move like a hundred files in 3 months back to the root</p>
</blockquote>
<p>Do we plan to add ~hundred files to the root currently?</p>



<a name="497693779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497693779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497693779">(Feb 04 2025 at 15:28)</a>:</h4>
<p>Seems like if we use <code>git mv</code> to move the folder we can avoid most of the typical downsides</p>



<a name="497695378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497695378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497695378">(Feb 04 2025 at 15:34)</a>:</h4>
<p>There will be many files in <code>src/</code></p>



<a name="497695578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497695578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497695578">(Feb 04 2025 at 15:35)</a>:</h4>
<p>Moving files isn't the real problem, it's moving files with 10 PRs against those files</p>



<a name="497700865"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497700865" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497700865">(Feb 04 2025 at 15:58)</a>:</h4>
<p>I volunteer to update all those PRs. I'd really like a separate folder for the new compiler. We want to make tools like <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20integrate.20with.20tooling/near/497684665">this platform</a> that don't belong in src so they'll end up at the root level, that will lead to flake dependency issues. I would also need to add a bunch of exceptions for when the new compiler CI should run vs old compiler CI because there is no clean folder separation.</p>



<a name="497702353"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497702353" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497702353">(Feb 04 2025 at 16:04)</a>:</h4>
<p>I don't feel that strongly about it. If you think its really worth this effort, then go for it</p>



<a name="497705304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497705304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497705304">(Feb 04 2025 at 16:18)</a>:</h4>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> I'll leave some time for others to weigh in on the folder issue if they want to</p>



<a name="497709850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497709850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497709850">(Feb 04 2025 at 16:39)</a>:</h4>
<p>It's just a folder move. People can update PRs for a folder move. Though I would probably rather move the rust compiler and leave the new zig compiler at root.</p>



<a name="497711333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497711333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497711333">(Feb 04 2025 at 16:46)</a>:</h4>
<p>That'd be way better IMO</p>



<a name="497740958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497740958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497740958">(Feb 04 2025 at 19:31)</a>:</h4>
<p>Anyone have opinions on how to handle allocation failures for lists during Roc compilation? I don't know what recovery mechanism there is, so it feels like we'd want to just fail compilation, since <a href="https://ziglang.org/documentation/master/std/#std.mem.Allocator.Error">it can only mean out of memory</a>. I don't think we should expose handling allocation failures because of this.</p>
<p>Not sure how to avoid threading this logic throughout the entire service without doing something like "if OOM, std.process.exit(1)", though that's probably acceptable with a reasonable error message.</p>



<a name="497745132"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497745132" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497745132">(Feb 04 2025 at 19:56)</a>:</h4>
<p>I wrote this function and I'm calling it on allocation results:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="n">exit_on_oom</span><span class="p">(</span><span class="n">alloc_result</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">.</span><span class="n">Error</span><span class="o">!</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">alloc_result</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">oom_message</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="sh">\\I ran out of memory! I can't do anything to recover, so I'm exiting.</span>
<span class="w">            </span><span class="sh">\\Try reducing memory usage on your machine and then running again.</span>
<span class="w">        </span><span class="p">;</span>

<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">oom_message</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">process</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>



<a name="497745299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497745299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497745299">(Feb 04 2025 at 19:56)</a>:</h4>
<p>I would make the function just be what goes in catch</p>



<a name="497745343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497745343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497745343">(Feb 04 2025 at 19:57)</a>:</h4>
<p>So it read <code>alloc(...) catch exit_on_oom</code></p>



<a name="497745369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497745369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497745369">(Feb 04 2025 at 19:57)</a>:</h4>
<p>At the callsite</p>



<a name="497745371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497745371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497745371">(Feb 04 2025 at 19:57)</a>:</h4>
<p>That reads better, yeah</p>



<a name="497773504"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497773504" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497773504">(Feb 04 2025 at 23:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497592906">said</a>:</p>
<blockquote>
<p>Made a PR to start figuring out fuzzing: <a href="https://github.com/roc-lang/roc/pull/7574">https://github.com/roc-lang/roc/pull/7574</a></p>
</blockquote>
<p>neat, did it work? i.e. does it build and link and basically function?</p>



<a name="497774313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497774313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497774313">(Feb 04 2025 at 23:10)</a>:</h4>
<p>It's broken in nix, but otherwise yes.</p>



<a name="497774401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497774401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497774401">(Feb 04 2025 at 23:11)</a>:</h4>
<p>I'm assuming that is an issue with our nix config though. Seems that afl clang is somehow pulling in a version of llvm from nix that is wrong or something along those lines.</p>



<a name="497774604"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497774604" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497774604">(Feb 04 2025 at 23:13)</a>:</h4>
<p>gotcha. well, that's certainly something we can compete on with an integrated fuzzer :) I'm looking forward to picking that project back up after the release is cut</p>



<a name="497774607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497774607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497774607">(Feb 04 2025 at 23:13)</a>:</h4>
<p>Oh, actually, might have one minor other bug. I think there are some wrong linker flags that lead it to "fail" on recompiled due to the linker printing to stderr. But it actually succeeds.</p>



<a name="497774640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497774640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497774640">(Feb 04 2025 at 23:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="406911">Andrew Kelley</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497774604">said</a>:</p>
<blockquote>
<p>gotcha. well, that's certainly something we can compete on with an integrated fuzzer :) I'm looking forward to picking that project back up after the release is cut</p>
</blockquote>
<p>We will be very happy to switch over as it gets more robust.</p>



<a name="497774725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497774725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497774725">(Feb 04 2025 at 23:14)</a>:</h4>
<p>I think that go did an amazing job with integrated fuzzing and I'm sure zig can do something at least as good.</p>



<a name="497775086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497775086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497775086">(Feb 04 2025 at 23:17)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="406911">@Andrew Kelley</span> other random but related question, would you advise that we follow zig master instead of specific stable versions?</p>
<p>I know a lot of zig projects seem to do that (though not sure how common it is nowadays and best practices). I would assume tracking master would get us things like faster compile times and integrated fuzzing sooner.</p>



<a name="497776263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497776263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497776263">(Feb 04 2025 at 23:27)</a>:</h4>
<p>normally I would advise sticking to a release but we're like 2 weeks out from 0.14.0 so master branch is probably your best bet (the download page will show you the most recent master branch commit that passed all CI checks)</p>



<a name="497793806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497793806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497793806">(Feb 05 2025 at 02:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/497774640">said</a>:</p>
<blockquote>
<p>We will be very happy to switch over as it gets more robust.</p>
</blockquote>
<p>there's a fun demo video in this PR that gives you a little taste of what I'm cooking up: <a href="https://github.com/ziglang/zig/pull/20958">https://github.com/ziglang/zig/pull/20958</a></p>



<a name="497795097"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497795097" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497795097">(Feb 05 2025 at 02:17)</a>:</h4>
<p>Very cool</p>



<a name="497813235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/497813235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#497813235">(Feb 05 2025 at 05:45)</a>:</h4>
<p>I rebased <a href="https://github.com/roc-lang/roc/pull/7569">https://github.com/roc-lang/roc/pull/7569</a> on top of the new top-level build organization and did some minimal integration work, mostly just useful for testing at this point. In particular, I do<code>zig build run -- check crates/compiler/test_syntax/tests/snapshots/pass/</code> to verify that the tokenizer will run over our existing tests without spitting out errors.</p>



<a name="498009936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498009936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498009936">(Feb 06 2025 at 00:38)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> I'm thinking we should avoid putting too much time into translating the rust to zig for <code>roc/src/check/parse/ir.zig</code> specifically. It sounds like <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> has been working on this.</p>



<a name="498010001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498010001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498010001">(Feb 06 2025 at 00:39)</a>:</h4>
<p>Yep, I'm basically entirely ignoring parse. The stuff in the draft PR was initial work that I don't plan to finish</p>



<a name="498010058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498010058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498010058">(Feb 06 2025 at 00:39)</a>:</h4>
<p>Yep I’m working</p>



<a name="498011330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498011330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498011330">(Feb 06 2025 at 00:49)</a>:</h4>
<p>Do you have your stuff pushed anywhere? I'd be interested in collaborating. Might have some time tonight.</p>



<a name="498011430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498011430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498011430">(Feb 06 2025 at 00:50)</a>:</h4>
<p>I can push something later</p>



<a name="498011441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498011441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498011441">(Feb 06 2025 at 00:50)</a>:</h4>
<p>It’s in a chaotic state now after our convo</p>



<a name="498011469"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498011469" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498011469">(Feb 06 2025 at 00:50)</a>:</h4>
<p>np!</p>



<a name="498011697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498011697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498011697">(Feb 06 2025 at 00:52)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> what is the state of landing the core structure you have been hacking on?</p>



<a name="498011907"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498011907" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498011907">(Feb 06 2025 at 00:54)</a>:</h4>
<p>Luke and I are about to call, you're welcome to join. I think I could make a couple things a bit more consistent and then just push anyway, and we could keep cleaning up even after merging something into the main repo.</p>
<p>Choir got cancelled tonight so I've got lots of time for that today.</p>



<a name="498011968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498011968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498011968">(Feb 06 2025 at 00:55)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/7580">https://github.com/roc-lang/roc/pull/7580</a></p>



<a name="498012132"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498012132" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498012132">(Feb 06 2025 at 00:56)</a>:</h4>
<p>I want to make the <code>build/</code> IRs all follow a cleaned up structure, and then we can probably just push to prioritize visibility over finishedness</p>



<a name="498012176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498012176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498012176">(Feb 06 2025 at 00:56)</a>:</h4>
<p>I like using Zed's realtime collab features. I can leave all kinds of mess behind in Sam's PR <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="498012727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498012727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498012727">(Feb 06 2025 at 01:00)</a>:</h4>
<p>Oh cool would love to join</p>



<a name="498014008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498014008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498014008">(Feb 06 2025 at 01:12)</a>:</h4>
<p>I might be able to in about an hour or so if you are still on</p>



<a name="498014770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498014770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498014770">(Feb 06 2025 at 01:19)</a>:</h4>
<p>Odds are good, just ping us</p>



<a name="498042200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498042200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498042200">(Feb 06 2025 at 05:57)</a>:</h4>
<p>Hah well figured out why you didn't have my syntax.zig <span class="user-mention" data-user-id="461444">@Sam Mohr</span> ; because I never committed it <span aria-label="man facepalming" class="emoji emoji-1f926-200d-2642" role="img" title="man facepalming">:man_facepalming:</span> <br>
And that's why we need CI!</p>



<a name="498042482"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498042482" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498042482">(Feb 06 2025 at 06:00)</a>:</h4>
<p>Big shrug, we'll get there soon</p>



<a name="498048626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498048626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498048626">(Feb 06 2025 at 06:58)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> I figured out the build flag, it isn't <code>--verbose</code>, it is <code>--summary all</code>. Prints out a summary of all the steps zig ran, if they were cached, and more clearly shows how many tests passed if they ran at all.</p>



<a name="498050314"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498050314" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498050314">(Feb 06 2025 at 07:11)</a>:</h4>
<p>Thanks for the heads up</p>



<a name="498137220"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498137220" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498137220">(Feb 06 2025 at 14:42)</a>:</h4>
<p>I found this interesting while creating the type-safe layer on top of the parser AST:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ast</span><span class="p">.</span><span class="n">NodeStore</span><span class="p">.</span><span class="n">initWithCapacity</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">estimated_node_count</span><span class="p">);</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">expr_index</span><span class="o">:</span><span class="w"> </span><span class="n">ast</span><span class="p">.</span><span class="n">NodeStore</span><span class="p">.</span><span class="n">ExprIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addExpr</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">        </span><span class="p">.</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addStatement</span><span class="p">(.{</span>
<span class="w">        </span><span class="p">.</span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expr_index</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">blah</span><span class="o">:</span><span class="w"> </span><span class="n">ast</span><span class="p">.</span><span class="n">NodeStore</span><span class="p">.</span><span class="n">StatementIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expr_index</span><span class="p">;</span>
</code></pre></div>
<p>This compiles successfully, the definitions of each ExprIndex and StatementIndex:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">StatementIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ExprIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<p>They are what I thought were nominal types, but are treated as structural here.  <span class="user-mention" data-user-id="461444">@Sam Mohr</span> you might want to take note.</p>



<a name="498138705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498138705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498138705">(Feb 06 2025 at 14:49)</a>:</h4>
<p>Changing the implementation of the index types to the following makes the types work fine:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">StatementIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">statement</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ExprIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">expr</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>



<a name="498146425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498146425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498146425">(Feb 06 2025 at 15:22)</a>:</h4>
<p>I'll try the enum thing then. There are a few more options</p>



<a name="498152812"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498152812" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498152812">(Feb 06 2025 at 15:48)</a>:</h4>
<p>I'm happy with what I got</p>



<a name="498152897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498152897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498152897">(Feb 06 2025 at 15:49)</a>:</h4>
<p>I think just having a field name resolves it, you should check though.</p>



<a name="498153001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498153001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498153001">(Feb 06 2025 at 15:49)</a>:</h4>
<p>Here is what usage of the type safe layer looks like:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">ast</span><span class="p">.</span><span class="n">NodeStore</span><span class="p">.</span><span class="n">initWithCapacity</span><span class="p">(</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">estimated_node_count</span><span class="p">);</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">expr_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addExpr</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">        </span><span class="p">.</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">statement_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addStatement</span><span class="p">(.{</span>
<span class="w">        </span><span class="p">.</span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expr_index</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">file_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addFile</span><span class="p">(.{</span>
<span class="w">        </span><span class="p">.</span><span class="n">statements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">ast</span><span class="p">.</span><span class="n">NodeStore</span><span class="p">.</span><span class="n">StatementIndex</span><span class="p">{</span><span class="n">statement_index</span><span class="p">},</span>
<span class="w">        </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">   </span><span class="kr">const</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">getFile</span><span class="p">(</span><span class="n">file_index</span><span class="p">);</span>
<span class="w">   </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"File: {any}"</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">file</span><span class="p">});</span>
</code></pre></div>
<p>prints:</p>
<div class="codehilite"><pre><span></span><code>File: lib_ast.NodeStore.File{ .statements = { lib_ast.NodeStore.StatementIndex{ .statement = 1 } }, .region = lib_ast.Region{ .start = 0, .end = 0 } }
</code></pre></div>



<a name="498161003"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498161003" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498161003">(Feb 06 2025 at 16:23)</a>:</h4>
<p>Yeah, I think the current recommended way in zig is an enum.</p>
<p>The old version was using tuples. (Not sure if those are nominal in zig). Now you switched to strict with unique keys.</p>



<a name="498165041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498165041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498165041">(Feb 06 2025 at 16:41)</a>:</h4>
<p>Well an enum unifies things into one type of</p>



<a name="498165099"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498165099" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498165099">(Feb 06 2025 at 16:42)</a>:</h4>
<p>We are using these to explicitly get different types of</p>



<a name="498165174"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498165174" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498165174">(Feb 06 2025 at 16:42)</a>:</h4>
<p>They are basically typed “pointers”</p>



<a name="498165280"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498165280" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498165280">(Feb 06 2025 at 16:42)</a>:</h4>
<p>But since they are offsets into an array they can be smaller and offer much better memory locality</p>



<a name="498166718"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498166718" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498166718">(Feb 06 2025 at 16:49)</a>:</h4>
<p>Yeah, that is exactly what the zig compiler uses enums for now. Each one of your structs would become an unbounded nominal enum. Each enum would contain all values from 0 to the max u32.</p>



<a name="498167422"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498167422" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498167422">(Feb 06 2025 at 16:53)</a>:</h4>
<div class="codehilite"><pre><span></span><code>const Parse.Id = enum(u32) { _ };
</code></pre></div>



<a name="498170609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498170609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498170609">(Feb 06 2025 at 17:06)</a>:</h4>
<p>btw I wanted to note a general thing that <span class="user-mention" data-user-id="406911">@Andrew Kelley</span> pointed out to me when we were talking about arenas:</p>
<p>a downside of using plain bump-allocated arenas for all memory allocation is that resizes basically never happen in-place</p>



<a name="498170815"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498170815" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498170815">(Feb 06 2025 at 17:07)</a>:</h4>
<p>like if we push an element and it exceeds capacity, it's not really going to be able to grow in-place because something else will have almost always used the next slot in the arena, so it has to allocate a new array in the arena and copy the existing elements over</p>



<a name="498170901"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498170901" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498170901">(Feb 06 2025 at 17:08)</a>:</h4>
<p>something to think about, at any rate!</p>



<a name="498171058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171058">(Feb 06 2025 at 17:09)</a>:</h4>
<p>Are there any data structures that give us in-place memory reuse for free, or is that something we'll have to cook ourselves?</p>



<a name="498171083"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171083" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171083">(Feb 06 2025 at 17:09)</a>:</h4>
<p>I think we should do a single fixed allocation at boot</p>



<a name="498171373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171373">(Feb 06 2025 at 17:10)</a>:</h4>
<p>Like a single mmap at the beginning to create the backing memory for our allocator</p>



<a name="498171453"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171453" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171453">(Feb 06 2025 at 17:11)</a>:</h4>
<p>I think it’s FixedBufferAllocator?</p>



<a name="498171479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171479">(Feb 06 2025 at 17:11)</a>:</h4>
<p>How does that fix the problem?</p>



<a name="498171686"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171686" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171686">(Feb 06 2025 at 17:12)</a>:</h4>
<p>You don’t have to use an Arena</p>



<a name="498171728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171728">(Feb 06 2025 at 17:12)</a>:</h4>
<p>And worry about pointer invalidation on resize</p>



<a name="498171740"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171740" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171740">(Feb 06 2025 at 17:12)</a>:</h4>
<p>Fixed buffer is an arena last I checked</p>



<a name="498171830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171830">(Feb 06 2025 at 17:12)</a>:</h4>
<p>Ok, but if it’s initialized with a fixed capacity it never resizes</p>



<a name="498171849"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171849" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171849">(Feb 06 2025 at 17:12)</a>:</h4>
<p>Also, pointer invalidation isn't a problem cause we use indices. The only problem is the growth.</p>



<a name="498171863"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171863" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171863">(Feb 06 2025 at 17:13)</a>:</h4>
<p>That’s what the fixed means</p>



<a name="498171919"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498171919" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498171919">(Feb 06 2025 at 17:13)</a>:</h4>
<p>It isn't the buffer that is resizing. It is the array lists allocated within the buffer</p>



<a name="498172042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172042">(Feb 06 2025 at 17:13)</a>:</h4>
<p>Oh I totally misread Richard’s comment</p>



<a name="498172061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172061">(Feb 06 2025 at 17:13)</a>:</h4>
<p>My apologies</p>



<a name="498172086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172086">(Feb 06 2025 at 17:14)</a>:</h4>
<p>No worries</p>



<a name="498172349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172349">(Feb 06 2025 at 17:15)</a>:</h4>
<p>Also, mmap is still technically a valid solution. We could mmap enough space to store a max sized array list for every array (like one per IR). It would be a crazy huge mmap, but given the memory is virtual should be ok (though k think some system still complain if you make too big of an mmap)</p>



<a name="498172361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172361">(Feb 06 2025 at 17:15)</a>:</h4>
<p>I think if we init our array lists with a very pessimistic capacity we can avoid this (using some empirical heuristic)</p>



<a name="498172547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172547">(Feb 06 2025 at 17:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498170609">said</a>:</p>
<blockquote>
<p>btw I wanted to note a general thing that <span class="user-mention silent" data-user-id="406911">Andrew Kelley</span> pointed out to me when we were talking about arenas:</p>
<p>a downside of using plain bump-allocated arenas for all memory allocation is that resizes basically never happen in-place</p>
</blockquote>
<p>Did he mention what zig does?</p>



<a name="498172578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172578">(Feb 06 2025 at 17:16)</a>:</h4>
<p>TigerBeetle uses the technique you are talking about to run a high availability database</p>



<a name="498172651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172651">(Feb 06 2025 at 17:16)</a>:</h4>
<p>But they use a holistic coding style to make that work well</p>



<a name="498172690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172690">(Feb 06 2025 at 17:17)</a>:</h4>
<p>(In zig)</p>



<a name="498172775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498172775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498172775">(Feb 06 2025 at 17:17)</a>:</h4>
<p>Did you meet Joran at SYCL <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> ?</p>



<a name="498173495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498173495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498173495">(Feb 06 2025 at 17:21)</a>:</h4>
<p><a href="/user_uploads/22008/jYzUIZAZLRy9ZfmgRSfja5hl/9A8A65F4-4659-4C81-A8DB-0CC6CEAB2A71.jpg">9A8A65F4-4659-4C81-A8DB-0CC6CEAB2A71.jpg</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/jYzUIZAZLRy9ZfmgRSfja5hl/9A8A65F4-4659-4C81-A8DB-0CC6CEAB2A71.jpg" title="9A8A65F4-4659-4C81-A8DB-0CC6CEAB2A71.jpg"><img data-original-content-type="image/jpeg" data-original-dimensions="1290x1068" src="/user_uploads/thumbnail/22008/jYzUIZAZLRy9ZfmgRSfja5hl/9A8A65F4-4659-4C81-A8DB-0CC6CEAB2A71.jpg/840x560.webp"></a></div><p>From their <a href="https://github.com/tigerbeetle/tigerbeetle/blob/main/docs/TIGER_STYLE.md">style guide</a></p>



<a name="498174138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498174138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498174138">(Feb 06 2025 at 17:24)</a>:</h4>
<p>So you would have in effect fixed arrays and just maintain stack allocated cursors on them</p>



<a name="498174258"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498174258" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498174258">(Feb 06 2025 at 17:25)</a>:</h4>
<p>Really reduces the number of trys in your code!</p>



<a name="498174597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498174597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498174597">(Feb 06 2025 at 17:26)</a>:</h4>
<p>How do we determine the size of said fixed array? What if we try to compile lots of big files? The question seems so obvious that I'm hesitant to ask it</p>



<a name="498174715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498174715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498174715">(Feb 06 2025 at 17:27)</a>:</h4>
<p>I wouldn’t say that this is necessarily the right choice for a compiler</p>



<a name="498174749"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498174749" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498174749">(Feb 06 2025 at 17:27)</a>:</h4>
<p>But just explaining the design space available</p>



<a name="498174937"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498174937" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498174937">(Feb 06 2025 at 17:28)</a>:</h4>
<p>To Brendan’s point, I’d be interested in what Zigs own memory management strategy is</p>



<a name="498174981"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498174981" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498174981">(Feb 06 2025 at 17:28)</a>:</h4>
<p>Because that one seems to work well with this DoD architecture we seem to be embracing</p>



<a name="498175138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498175138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498175138">(Feb 06 2025 at 17:29)</a>:</h4>
<p>I know they make some assumptions, and use appendAssumingCapacity a lot from what I read</p>



<a name="498175273"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498175273" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498175273">(Feb 06 2025 at 17:30)</a>:</h4>
<p>The only allocation error is OOM, which we can't/shouldn't do anything about. The current approach to minimize <code>try</code>s is to <code>std.process.exit(1)</code> on OOM, as is done for you in <code>SafeList</code>: <a href="https://github.com/roc-lang/roc/blob/a3cff5aff7a1cf9584eac6926fba03257d48391f/src/collections/safe_list.zig#L43">https://github.com/roc-lang/roc/blob/a3cff5aff7a1cf9584eac6926fba03257d48391f/src/collections/safe_list.zig#L43</a></p>



<a name="498175402"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498175402" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498175402">(Feb 06 2025 at 17:31)</a>:</h4>
<p>You want me to catch every append and call exit?</p>



<a name="498175467"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498175467" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498175467">(Feb 06 2025 at 17:31)</a>:</h4>
<p>(name pending, something like <code>TypedIndexList</code> would be better)</p>



<a name="498176006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498176006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498176006">(Feb 06 2025 at 17:34)</a>:</h4>
<p>Ok, I think those should both have an initWithCapacity constructor</p>



<a name="498176179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498176179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498176179">(Feb 06 2025 at 17:35)</a>:</h4>
<p>Agreed</p>



<a name="498176331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498176331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498176331">(Feb 06 2025 at 17:36)</a>:</h4>
<p>But yes, I think we should <code>catch exit_on_oom</code>on every allocation</p>



<a name="498176380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498176380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498176380">(Feb 06 2025 at 17:36)</a>:</h4>
<p>Ok I’d like to hear what others think</p>



<a name="498176508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498176508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498176508">(Feb 06 2025 at 17:37)</a>:</h4>
<p>But it should be a very rare and extraordinary case regardless of</p>



<a name="498177859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498177859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498177859">(Feb 06 2025 at 17:44)</a>:</h4>
<p>If we use these “initialize with a constant max size” for these lists, we could just use appendAssumeCapacity and get largely the same behavior</p>



<a name="498177965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498177965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498177965">(Feb 06 2025 at 17:44)</a>:</h4>
<p>Sorry not constant, but fixed relative to some attribute of the file</p>



<a name="498193013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498193013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498193013">(Feb 06 2025 at 19:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498172775">said</a>:</p>
<blockquote>
<p>Did you meet Joran at SYCL <span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> ?</p>
</blockquote>
<p>Yes</p>



<a name="498193027"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498193027" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498193027">(Feb 06 2025 at 19:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498172578">said</a>:</p>
<blockquote>
<p>TigerBeetle uses the technique you are talking about to run a high availability database</p>
</blockquote>
<p>Not quite</p>



<a name="498193065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498193065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498193065">(Feb 06 2025 at 19:12)</a>:</h4>
<p>Tiger beetle knows their exact limits and fills up those limits up front</p>



<a name="498193200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498193200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498193200">(Feb 06 2025 at 19:13)</a>:</h4>
<p>That would be more equivalent to recognizing how much memory a machine has and the allocating it into N different arrays of the max size possible for each of the IRs.</p>



<a name="498193364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498193364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498193364">(Feb 06 2025 at 19:14)</a>:</h4>
<p>Of course you could decide to use only 2 arrays and keep reusing the memory, but it is a static limit</p>



<a name="498193629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498193629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498193629">(Feb 06 2025 at 19:16)</a>:</h4>
<p>I was talking about allocating a terrabyte (arbitrary big number) of memory for each array. Way more than the system has. Then keeping track of the current size. The allocation never actually grows, but every once and a while, it page faults to get the os to get more real memory.</p>



<a name="498210997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498210997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498210997">(Feb 06 2025 at 21:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498172547">said</a>:</p>
<blockquote>
<p>Did he mention what zig does?</p>
</blockquote>
<p>a crap ton of ArrayList and AutoArrayHashMap</p>



<a name="498211220"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498211220" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498211220">(Feb 06 2025 at 21:12)</a>:</h4>
<p>tokenizer - append tokens to a multi array list<br>
parser - append nodes to a multi array list<br>
zir - append instructions to a multi array list<br>
air - append instructions to a multi array list<br>
mir - append instructions to a multi array list<br>
machine code - append bytes to an array list</p>



<a name="498211314"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498211314" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498211314">(Feb 06 2025 at 21:13)</a>:</h4>
<p>intern pool - basically an array hash map</p>



<a name="498211412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498211412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498211412">(Feb 06 2025 at 21:13)</a>:</h4>
<p>one factor to consider is portability - if your code uses these simple data structures rather than depending on the OS feature of mmap, then you can e.g. run your code in the browser</p>



<a name="498211511"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498211511" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498211511">(Feb 06 2025 at 21:14)</a>:</h4>
<p>fun fact, when you're browsing zig's autodocs, you're actually downloading literally a tarball of unmodified zig std lib source code plus a wasm file, and nothing else, and then you're running the actual tokenizer and parser in wasm</p>



<a name="498212080"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498212080" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498212080">(Feb 06 2025 at 21:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498161003">said</a>:</p>
<blockquote>
<p>Yeah, I think the current recommended way in zig is an enum.</p>
</blockquote>
<p>one nice outcome of using enums is that you can name special values. for instance the trick where you use max int to store "none":</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">OptionalString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">enum</span><span class="p">(</span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">none</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">maxInt</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span>
<span class="w">    </span><span class="n">_</span><span class="p">,</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">unwrap</span><span class="p">(</span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="n">OptionalString</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="n">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="n">none</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">@enumFromInt</span><span class="p">(</span><span class="nb">@intFromEnum</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">slice</span><span class="p">(</span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="n">OptionalString</span><span class="p">,</span><span class="w"> </span><span class="n">wasm</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">Wasm</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">index</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="k">orelse</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">).</span><span class="n">slice</span><span class="p">(</span><span class="n">wasm</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">enum</span><span class="p">(</span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_</span><span class="p">,</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">slice</span><span class="p">(</span><span class="n">index</span><span class="o">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">wasm</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="kr">const</span><span class="w"> </span><span class="n">Wasm</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">start_slice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm</span><span class="p">.</span><span class="n">string_bytes</span><span class="p">.</span><span class="n">items</span><span class="p">[</span><span class="nb">@intFromEnum</span><span class="p">(</span><span class="n">index</span><span class="p">)..];</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">start_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">mem</span><span class="p">.</span><span class="n">indexOfScalar</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">start_slice</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="o">?</span><span class="w"> </span><span class="o">:</span><span class="mi">0</span><span class="p">];</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">toOptional</span><span class="p">(</span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">OptionalString</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="n">OptionalString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@enumFromInt</span><span class="p">(</span><span class="nb">@intFromEnum</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="p">.</span><span class="n">none</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>maybe you reserve index 0 to mean empty string, and index 1 to be the string "roc", well you can just put that into the enum then</p>



<a name="498214062"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498214062" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498214062">(Feb 06 2025 at 21:33)</a>:</h4>
<p><span class="user-mention" data-user-id="406911">@Andrew Kelley</span> what would you recommend in terms of allocators when it comes to MultiArrayLists that we're going to build up (potentially involving resizes) with unknown up-front length, but which use indices over pointers for everything, and which we want to serialize straight to disk later (and deserialize straight into an arena)?</p>



<a name="498214823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498214823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498214823">(Feb 06 2025 at 21:38)</a>:</h4>
<p>an allocator that supports resizing, i.e. not an arena allocator</p>



<a name="498214871"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498214871" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498214871">(Feb 06 2025 at 21:39)</a>:</h4>
<p>you can memcpy your array list data to disk independently of the allocator used</p>



<a name="498215002"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498215002" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498215002">(Feb 06 2025 at 21:39)</a>:</h4>
<p>since Roc links libc, the libc allocator is going to be your best bet probably for the "gpa" use case, i.e. when you need resizing</p>



<a name="498215116"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498215116" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498215116">(Feb 06 2025 at 21:40)</a>:</h4>
<p>lately I've come around to either naming my allocator parameter <code>gpa</code> or <code>arena</code> to indicate the intended usage pattern</p>



<a name="498215289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498215289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498215289">(Feb 06 2025 at 21:41)</a>:</h4>
<p><code>gpa</code> - is that the kitchen sink, and <code>arena</code> is a dedicated purpose built thing we care about storing?</p>



<a name="498215346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498215346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498215346">(Feb 06 2025 at 21:41)</a>:</h4>
<p>idea is that with <code>gpa</code> you need to avoid leaking by remembering to free, and with <code>arena</code> you can fire and forget</p>



<a name="498215465"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498215465" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498215465">(Feb 06 2025 at 21:42)</a>:</h4>
<p>trying to do storage serialization at the allocator layer is not something I've experimented with. if you go that route, have fun and I have no advice for you</p>



<a name="498216265"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498216265" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498216265">(Feb 06 2025 at 21:47)</a>:</h4>
<p><span class="user-mention" data-user-id="406911">@Andrew Kelley</span> - I wanted to ask about <code>zig ld</code>. Would that be reasonable for us to embed in the roc cli binary to use for linking our prebuilt platform hosts and our roc apps together?</p>



<a name="498216348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498216348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498216348">(Feb 06 2025 at 21:48)</a>:</h4>
<p>Something like <code>zig ld app.o libhost.a</code></p>



<a name="498216419"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498216419" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498216419">(Feb 06 2025 at 21:48)</a>:</h4>
<p>that's actually not a command the compiler supports at the moment, but I think I understand what you're asking - you want to reuse the linker code (not LLD) right?</p>



<a name="498216556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498216556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498216556">(Feb 06 2025 at 21:49)</a>:</h4>
<p>to understand the use case a bit more, my understanding is that you already depend on llvm libraries in the roc binary - what makes zig's linker code a more attractive option than embedding LLD inside the roc binary, having roc expose <code>roc lld</code> and then making roc invoke itself as a subprocess?</p>



<a name="498216863"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498216863" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498216863">(Feb 06 2025 at 21:51)</a>:</h4>
<p>I guess I'm wondering if there is a simpler way. I thought <code>zig ld</code> was written in zig and so using that might be a better option than wrangling llvm's lld.</p>



<a name="498216975"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498216975" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498216975">(Feb 06 2025 at 21:52)</a>:</h4>
<p>Another option I was thinking was having roc distribute a version of lld that we could download from a release and store in cache.</p>



<a name="498217163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217163">(Feb 06 2025 at 21:53)</a>:</h4>
<p>We have been talking about using a similar approach to Zig with producing llvm <code>bc</code> so I guess I assumed that meant we didn't need llvm anymore. But I guess <span class="user-mention" data-user-id="281383">@Richard Feldman</span> has mentioned he would like it all in one binary... so we'll still need <code>clang</code> or something.</p>



<a name="498217290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217290">(Feb 06 2025 at 21:54)</a>:</h4>
<p>yeah we have a macho linker, an elf linker, and a wasm linker all written in zig, however, they do not yet have feature parity or performance parity with LLD</p>



<a name="498217332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217332">(Feb 06 2025 at 21:54)</a>:</h4>
<p>actually I haven't measured the wasm linker perf vs lld since I rewrote it, that might have changed</p>



<a name="498217421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217421">(Feb 06 2025 at 21:55)</a>:</h4>
<p>zig's linkers are also "surgical" if you will, they are designed to be tightly coupled with the frontend and to prioritize zig code updates rather than the use case of only linking objects together</p>



<a name="498217436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217436">(Feb 06 2025 at 21:55)</a>:</h4>
<p>This is for producing a final binary, so as long as the linker isn't too slow (or worse than llvm) it's probably ok. But I'm not sure.</p>



<a name="498217604"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217604" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217604">(Feb 06 2025 at 21:56)</a>:</h4>
<p>I think the tight coupling aspect will make them not a great fit for directly code sharing with roc compiler</p>



<a name="498217625"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217625" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217625">(Feb 06 2025 at 21:56)</a>:</h4>
<p>Ok, it sounds like we're back to plan A, embedding llvm things.</p>



<a name="498217679"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217679" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217679">(Feb 06 2025 at 21:56)</a>:</h4>
<p>have a look yourself and see what you think: <a href="https://github.com/ziglang/zig/blob/master/src/link/Wasm.zig">https://github.com/ziglang/zig/blob/master/src/link/Wasm.zig</a></p>



<a name="498217812"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217812" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217812">(Feb 06 2025 at 21:57)</a>:</h4>
<p>Thank you, but I'm probably not familiar enough with zig or linking to be able to read that just yet. <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="498217814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217814">(Feb 06 2025 at 21:57)</a>:</h4>
<p>it's certainly <em>adaptable</em> to your use case, but then we'd be maintaining two separate implementations. which, hey, maybe that's not so bad. porting code can be fun and fairly quick</p>



<a name="498217954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498217954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498217954">(Feb 06 2025 at 21:58)</a>:</h4>
<p>but yeah I think embedding LLD is a more immediate solution to your problem, and does not come with too many downsides since you already depend on LLVM libraries</p>



<a name="498218052"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218052" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218052">(Feb 06 2025 at 21:59)</a>:</h4>
<p>Would you recommend using a library, or downloading a binary and caching that to use?</p>



<a name="498218088"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218088" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218088">(Feb 06 2025 at 21:59)</a>:</h4>
<p>^^ I hope that question makes sense...</p>



<a name="498218090"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218090" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218090">(Feb 06 2025 at 21:59)</a>:</h4>
<p>for shipping a linker?</p>



<a name="498218130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218130">(Feb 06 2025 at 21:59)</a>:</h4>
<p>Yeah, for both compiling llvm <code>bc</code> and also for linking the final executable</p>



<a name="498218296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218296">(Feb 06 2025 at 22:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="406911">Andrew Kelley</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498216556">said</a>:</p>
<blockquote>
<p>to understand the use case a bit more, my understanding is that you already depend on llvm libraries in the roc binary - what makes zig's linker code a more attractive option than embedding LLD inside the roc binary, having roc expose <code>roc lld</code> and then making roc invoke itself as a subprocess?</p>
</blockquote>
<p>if you do <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span> instead, then you can ship only 1 binary (roc) that has those other abilities built in</p>



<a name="498218431"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218431" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218431">(Feb 06 2025 at 22:01)</a>:</h4>
<p>this is what zig does today - basically you copy paste main.cpp from lld into your project and rename <code>main</code> to <code>lld_main</code></p>



<a name="498218507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218507">(Feb 06 2025 at 22:02)</a>:</h4>
<p>actually I don't think you have to do that since lld exposes library functions</p>



<a name="498218570"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218570" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218570">(Feb 06 2025 at 22:02)</a>:</h4>
<p>we do it for clang tho</p>



<a name="498218625"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218625" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218625">(Feb 06 2025 at 22:02)</a>:</h4>
<p>Ok, I'll checkout the zig code and follow that.</p>



<a name="498218675"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498218675" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498218675">(Feb 06 2025 at 22:02)</a>:</h4>
<p><a href="https://github.com/ziglang/zig/blob/b0ed602d5d9358128471588f00a073f2545809fa/src/main.zig#L301-L306">https://github.com/ziglang/zig/blob/b0ed602d5d9358128471588f00a073f2545809fa/src/main.zig#L301-L306</a></p>



<a name="498221617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498221617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498221617">(Feb 06 2025 at 22:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="406911">Andrew Kelley</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498211220">said</a>:</p>
<blockquote>
<p>tokenizer - append tokens to a multi array list<br>
parser - append nodes to a multi array list<br>
zir - append instructions to a multi array list<br>
air - append instructions to a multi array list<br>
mir - append instructions to a multi array list<br>
machine code - append bytes to an array list</p>
</blockquote>
<p>Just to clarify, these all use gpa in your case.</p>



<a name="498221709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498221709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498221709">(Feb 06 2025 at 22:24)</a>:</h4>
<p>Arena is for temporary non list stuff that never needs to grow</p>



<a name="498222470"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498222470" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498222470">(Feb 06 2025 at 22:29)</a>:</h4>
<p>right</p>



<a name="498224210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498224210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498224210">(Feb 06 2025 at 22:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498218130">said</a>:</p>
<blockquote>
<p>Yeah, for both compiling llvm <code>bc</code> and also for linking the final executable</p>
</blockquote>
<p>doesn't roc already support this via the llvm library APIs? specifically for compiling bitcode, not linking</p>



<a name="498225181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498225181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498225181">(Feb 06 2025 at 22:48)</a>:</h4>
<p>I'm not sure how that works. We currently use the <code>inkwell</code> crate and I assume that bundles in the llvm libraries. But maybe there is some other magic happening there.</p>



<a name="498229448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498229448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498229448">(Feb 06 2025 at 23:22)</a>:</h4>
<p>Our tokenizer and parser are doing exactly this, and right now using the heap allocator but could easily switch to libc. I think if we upfront make some assumptions about needed capacity resizing won’t hit us too hard</p>



<a name="498229901"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498229901" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498229901">(Feb 06 2025 at 23:26)</a>:</h4>
<p>Yep</p>



<a name="498229916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498229916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498229916">(Feb 06 2025 at 23:26)</a>:</h4>
<p>Also, I would probably use gpa and an arena for now</p>



<a name="498229984"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498229984" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498229984">(Feb 06 2025 at 23:27)</a>:</h4>
<p>Currently we don't link libc. And we can generally re-evaluate at any point</p>



<a name="498229997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498229997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498229997">(Feb 06 2025 at 23:27)</a>:</h4>
<p>Easy to switch an allocator</p>



<a name="498245035"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498245035" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498245035">(Feb 07 2025 at 01:58)</a>:</h4>
<p>you don't link libc, but you're planning to link llvm right? that means you will be linking libc</p>



<a name="498245052"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498245052" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498245052">(Feb 07 2025 at 01:58)</a>:</h4>
<p>or do you have plans to keep llvm libraries out of the roc binary?</p>



<a name="498245930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498245930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498245930">(Feb 07 2025 at 02:06)</a>:</h4>
<p>That's true</p>



<a name="498245944"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498245944" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498245944">(Feb 07 2025 at 02:06)</a>:</h4>
<p>So I guess we could just go straight to the c sllocator</p>



<a name="498270235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270235">(Feb 07 2025 at 06:42)</a>:</h4>
<p>I thought we had main compiling. From what I can tell, most of it is just broken code with invalid imports and non-existant variables</p>



<a name="498270257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270257">(Feb 07 2025 at 06:42)</a>:</h4>
<p>lazy compilation made it not obvious</p>



<a name="498270278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270278">(Feb 07 2025 at 06:42)</a>:</h4>
<p>I'm working on stuff right now</p>



<a name="498270317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270317">(Feb 07 2025 at 06:43)</a>:</h4>
<p>I don't think it is lazy. It is just that nothing is imported by <code>main.zig</code> or <code>test.zig</code>. So they literally aren't in the tree at all</p>



<a name="498270359"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270359" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270359">(Feb 07 2025 at 06:43)</a>:</h4>
<p>Yes, lazy compilation is imprecise</p>



<a name="498270373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270373">(Feb 07 2025 at 06:43)</a>:</h4>
<p>It's what you said</p>



<a name="498270461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270461">(Feb 07 2025 at 06:44)</a>:</h4>
<p>I'm not sure how best to fix the issue besides importing all modules in main followed by a <code>_ = imported_module</code> for each of them</p>



<a name="498270483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270483">(Feb 07 2025 at 06:44)</a>:</h4>
<p>Of course, paired with fixing whatever broken imports and such</p>



<a name="498270542"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270542" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270542">(Feb 07 2025 at 06:45)</a>:</h4>
<p>Yeah, that is a fine start (also, I think just importing the coordinate into main imports everything or nearly everything)</p>



<a name="498270752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270752">(Feb 07 2025 at 06:46)</a>:</h4>
<p>I'm gonna try to get my scope cleanup work done first for canonicalization, and then I can try to fix these issues, and then make a PR</p>



<a name="498270785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270785">(Feb 07 2025 at 06:47)</a>:</h4>
<p>Sounds good.</p>



<a name="498270813"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270813" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270813">(Feb 07 2025 at 06:47)</a>:</h4>
<p>I think I'll wait for the tree to be working and then switch into doing some various minor changes and cleanups</p>



<a name="498270839"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270839" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270839">(Feb 07 2025 at 06:47)</a>:</h4>
<p>You might as well wait, I've been touching a lot of minor stuff today</p>



<a name="498270903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498270903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498270903">(Feb 07 2025 at 06:48)</a>:</h4>
<p>yeah, sounds good</p>



<a name="498271014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498271014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498271014">(Feb 07 2025 at 06:49)</a>:</h4>
<p>Also, exceptionally minor PR to update the zig-afl-kit dependency: <a href="https://github.com/roc-lang/roc/pull/7584">https://github.com/roc-lang/roc/pull/7584</a></p>



<a name="498309622"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498309622" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498309622">(Feb 07 2025 at 10:43)</a>:</h4>
<p>It does seem that Zig does not perform full semantic analysis on dead code.</p>



<a name="498310581"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498310581" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498310581">(Feb 07 2025 at 10:48)</a>:</h4>
<p>More work on minor details, started work on scope checking for canonicalization to make sure it fits with everything else, added "coordinate.zig" import to "main.zig" for typechecking: <a href="https://github.com/roc-lang/roc/pull/7585">https://github.com/roc-lang/roc/pull/7585</a></p>



<a name="498310624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498310624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498310624">(Feb 07 2025 at 10:48)</a>:</h4>
<p>Not complete, just a wash of code</p>



<a name="498360263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498360263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498360263">(Feb 07 2025 at 15:03)</a>:</h4>
<p>Got everything I need to _blast_ through the parser and formatter on top of a type-safe NodeStore</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>If you want to see what it would look like to manually construct an AST (which we should almost never do)</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">   </span><span class="k">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">NodeStore</span><span class="p">.</span><span class="n">initWithCapacity</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Try to add the nodes for the Hello World in Roc, using 0 for all tokens:</span>
<span class="w">        </span><span class="c1">// app [main!] { pf: platform "../basic-cli/platform.roc" }</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// import pf.Stdout</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// main! = |_|</span>
<span class="w">        </span><span class="c1">//     Stdout.line!("Hello, world!")</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addHeader</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">provides</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">TokenIndex</span><span class="p">{</span><span class="mi">0</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">platform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">packages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">RecordFieldIndex</span><span class="p">{},</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addStatement</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">import</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">module_name_tok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">qualifier_tok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">alias_tok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">exposes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">TokenIndex</span><span class="p">{},</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">main_ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addPattern</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">ident_tok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">hello_world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addExpr</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">line_ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addExpr</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">ident</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">line_apply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addExpr</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">apply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="err">@</span><span class="s">"fn"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line_ident</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">ExprIndex</span><span class="p">{</span><span class="n">hello_world</span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">body_statement_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addStatement</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">expr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">line_apply</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addBody</span><span class="p">(.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">whitespace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">statements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">StatementIndex</span><span class="p">{</span><span class="n">body_statement_0</span><span class="p">},</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addStatement</span><span class="p">(.{</span><span class="w"> </span><span class="p">.</span><span class="n">decl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_ident</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">body</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">addFile</span><span class="p">(.{</span>
<span class="w">            </span><span class="p">.</span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">header</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">statements</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">StatementIndex</span><span class="p">{</span><span class="w"> </span><span class="n">import</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span><span class="w"> </span><span class="p">.</span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span><span class="p">;</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
</div></div>



<a name="498419920"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498419920" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498419920">(Feb 07 2025 at 20:18)</a>:</h4>
<p>any time you have something like <code>&amp;[_]T{...}</code>, you can shortcut with <code>&amp;.{...}</code>, as long as there is a result type on the LHS</p>



<a name="498421784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498421784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498421784">(Feb 07 2025 at 20:30)</a>:</h4>
<p>Sweet!  I don’t know why I didn’t try that</p>



<a name="498455402"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498455402" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498455402">(Feb 08 2025 at 01:37)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span>, not sure this is useful to you now, but we could add a step in CI to do <code>find src -name "*.zig" | xargs -n1 zig ast-check</code>. It would ensure that all of the zig files that aren't in the tree are at least internally valid. That said, I would assume that pretty quickly everything will be in the tree, so this may not matter.</p>



<a name="498455563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498455563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498455563">(Feb 08 2025 at 01:39)</a>:</h4>
<p>I have time right now, so just trying to figure out if I can do something useful.</p>



<a name="498455592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498455592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498455592">(Feb 08 2025 at 01:39)</a>:</h4>
<p>I think it's fine right now. I think what would be helpful is seeing if you can skeleton out what the interpreter and/or the LLVM backend would need for inputs</p>



<a name="498455732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498455732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498455732">(Feb 08 2025 at 01:41)</a>:</h4>
<p>I'm working on setting up the coordinate.zig file right now so that everything is actually glued together</p>



<a name="498455896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498455896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498455896">(Feb 08 2025 at 01:43)</a>:</h4>
<p>I've at least putatively set up scope checking logic already for canonicalization (not plugged in), meaning I'm pretty confident we'll be okay with the new ModuleIdent approach (formerly Symbol) for referencing idents that Richard proposed</p>



<a name="498455902"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498455902" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498455902">(Feb 08 2025 at 01:43)</a>:</h4>
<blockquote>
<p>If you can skeleton out what the interpreter</p>
</blockquote>
<p>I feel like that may be hard to do without a Can IR. I plan to start by having this as a tree walking interpreter that just directly walks Can (maybe 1 level removed from can to do some type checking first with the concrete input types)</p>
<blockquote>
<p>LLVM backend</p>
</blockquote>
<p>This I definitely should look into more. Need to figure out zigs library to build llvm bitcode and also statically linking to llvm in general (which might be pretty hard)</p>



<a name="498455963"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498455963" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498455963">(Feb 08 2025 at 01:44)</a>:</h4>
<p>Once I finish the package stuff, I'll see if I can get the CanIR at least <em>mostly</em> correct</p>



<a name="498458368"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498458368" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498458368">(Feb 08 2025 at 02:17)</a>:</h4>
<p>Another super minor PR: <a href="https://github.com/roc-lang/roc/pull/7588">https://github.com/roc-lang/roc/pull/7588</a></p>



<a name="498458378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498458378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498458378">(Feb 08 2025 at 02:17)</a>:</h4>
<p>but a bit bigger this time</p>



<a name="498459126"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498459126" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498459126">(Feb 08 2025 at 02:28)</a>:</h4>
<p>Approved, auto-merge enabled</p>



<a name="498459403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498459403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498459403">(Feb 08 2025 at 02:32)</a>:</h4>
<p>Your PR is also the first time I've seen a greentext in Roc's ecosystem, nice</p>



<a name="498466759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498466759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498466759">(Feb 08 2025 at 04:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498455402">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span>, not sure this is useful to you now, but we could add a step in CI to do <code>find src -name "*.zig" | xargs -n1 zig ast-check</code>. It would ensure that all of the zig files that aren't in the tree are at least internally valid. That said, I would assume that pretty quickly everything will be in the tree, so this may not matter.</p>
</blockquote>
<p><code>zig fmt src --check --ast-check</code></p>



<a name="498468649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498468649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498468649">(Feb 08 2025 at 04:54)</a>:</h4>
<p>We should add that to CI once we get all our source cleaned up. Thanks!</p>



<a name="498470779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498470779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498470779">(Feb 08 2025 at 05:27)</a>:</h4>
<p>To add <code>--ast-check</code>. Fails currently, but I want to make sure we don't forget about it later: <a href="https://github.com/roc-lang/roc/pull/7589">https://github.com/roc-lang/roc/pull/7589</a></p>



<a name="498475176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498475176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498475176">(Feb 08 2025 at 06:36)</a>:</h4>
<p>Correctly get the github ci filter working: <a href="https://github.com/roc-lang/roc/pull/7591">https://github.com/roc-lang/roc/pull/7591</a></p>



<a name="498505638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498505638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498505638">(Feb 08 2025 at 14:15)</a>:</h4>
<p>new gpa! <a href="https://ziglang.org/devlog/2025/#2025-02-07">https://ziglang.org/devlog/2025/#2025-02-07</a></p>



<a name="498517498"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498517498" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498517498">(Feb 08 2025 at 16:58)</a>:</h4>
<p>That's cool. Though isn't the libc allocator just b tier? Like the good allocators are like mimalloc and tcmalloc?</p>
<p>Not trying to downplay anything, huge for the zig default to at least match C (while also having options to detect for memory leaks and such). Just noting that there are a lot of allocators out there and I don't think libc has been state of the art for a long time.</p>



<a name="498517557"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498517557" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498517557">(Feb 08 2025 at 17:00)</a>:</h4>
<p>Also, I'm really curious how it compares to the jdz zig allocator: <a href="https://github.com/joadnacer/jdz_allocator">https://github.com/joadnacer/jdz_allocator</a></p>



<a name="498518156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498518156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498518156">(Feb 08 2025 at 17:08)</a>:</h4>
<p>Also, does this mean it is in in time for 0.14.0?</p>



<a name="498522924"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498522924" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498522924">(Feb 08 2025 at 18:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498475176">said</a>:</p>
<blockquote>
<p>Correctly get the github ci filter working: <a href="https://github.com/roc-lang/roc/pull/7591">https://github.com/roc-lang/roc/pull/7591</a></p>
</blockquote>
<p>Or not...try 2: <a href="https://github.com/roc-lang/roc/pull/7592">https://github.com/roc-lang/roc/pull/7592</a></p>



<a name="498529954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498529954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498529954">(Feb 08 2025 at 19:41)</a>:</h4>
<p>Yay! only zig ci running: <a href="https://github.com/roc-lang/roc/pull/7590">https://github.com/roc-lang/roc/pull/7590</a></p>



<a name="498529989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498529989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498529989">(Feb 08 2025 at 19:41)</a>:</h4>
<p>Also above PR just adds a script to enable reproing fuzzing failures.</p>



<a name="498530014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498530014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498530014">(Feb 08 2025 at 19:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/498529954">said</a>:</p>
<blockquote>
<p>Yay! only zig ci running: <a href="https://github.com/roc-lang/roc/pull/7590">https://github.com/roc-lang/roc/pull/7590</a></p>
</blockquote>
<p>I was testing it too :) <a href="https://github.com/roc-lang/roc/pull/7593">https://github.com/roc-lang/roc/pull/7593</a></p>



<a name="498530380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498530380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498530380">(Feb 08 2025 at 19:45)</a>:</h4>
<p>Currently CI is now ~3 minutes....why is windows so much slower than all the rest of CI?</p>



<a name="498530461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498530461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498530461">(Feb 08 2025 at 19:46)</a>:</h4>
<p>To be fair 1m21s was for downloading to our cache for the Windows Zig install</p>



<a name="498530464"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498530464" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498530464">(Feb 08 2025 at 19:46)</a>:</h4>
<p>But still</p>



<a name="498530509"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498530509" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498530509">(Feb 08 2025 at 19:46)</a>:</h4>
<blockquote>
<p>To be fair 1m21s was for downloading to our cache for the Windows Zig install</p>
</blockquote>
<p>So on rerun, this should be skipped? let me test</p>



<a name="498530831"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498530831" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498530831">(Feb 08 2025 at 19:50)</a>:</h4>
<p>Ok, a bit better</p>



<a name="498533512"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498533512" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498533512">(Feb 08 2025 at 20:27)</a>:</h4>
<p>btw if you don't mind using <a href="https://github.com/mlugg/setup-zig">https://github.com/mlugg/setup-zig</a> instead of goto-bus-stop (which is now unmaintained) it will use mirrors and proper caching. should be faster for you and less bandwidth for <a href="http://ziglang.org">ziglang.org</a></p>



<a name="498533615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498533615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498533615">(Feb 08 2025 at 20:29)</a>:</h4>
<p>Yeah, we can definitely switch over</p>



<a name="498557578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557578">(Feb 09 2025 at 02:33)</a>:</h4>
<p>PR to switch: <a href="https://github.com/roc-lang/roc/pull/7594">https://github.com/roc-lang/roc/pull/7594</a></p>



<a name="498557579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557579">(Feb 09 2025 at 02:33)</a>:</h4>
<p>Ok, I have the first draft of the parser able to parse AND format the canonical Hello World.  I need to rebase it on the current structure and then probably make a few more changes to harmonize it with the rest of the project</p>



<a name="498557599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557599">(Feb 09 2025 at 02:33)</a>:</h4>
<p>The rest of the parser should be able to go _VERY_ fast from here</p>



<a name="498557602"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557602" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557602">(Feb 09 2025 at 02:33)</a>:</h4>
<p>Exciting. I'm definitely interested in helping get a fuzzer setup once it lands</p>



<a name="498557607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557607">(Feb 09 2025 at 02:34)</a>:</h4>
<p>I'll have a PR up by tomorrow evening</p>



<a name="498557658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557658">(Feb 09 2025 at 02:34)</a>:</h4>
<p>By that I mean, if no one does it first, I'll add a parser to formatter fuzzer following the current format after your PR lands</p>



<a name="498557695"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557695" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557695">(Feb 09 2025 at 02:35)</a>:</h4>
<p>I made a lot of mistakes and did a few redesigns.  I also feel like I type like molasses with Zig, guess I'm just getting used to the syntax (and cursing everytime I forget the <code>.</code> in front of an anonymous struct)</p>



<a name="498557759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557759">(Feb 09 2025 at 02:36)</a>:</h4>
<p>I know the feeling</p>



<a name="498557793"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557793" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557793">(Feb 09 2025 at 02:36)</a>:</h4>
<p>But I'm very happy with this current design, even if there are some tools (i.e., helpers) that need to be built to make the actual parsing code more quickly scannable - but I didn't want to abstract too early in the game.</p>



<a name="498557905"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557905" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557905">(Feb 09 2025 at 02:38)</a>:</h4>
<p>A good policy</p>



<a name="498557933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498557933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498557933">(Feb 09 2025 at 02:39)</a>:</h4>
<p>Also, I'm going to be upfront - this initial version will have in it a LOT of panics (where problems should be reported, and unimplemented code paths). I do not intend to commit the PR that way, but I wanted to talk about how to do problems effectively  (and Malformed) before I replace them in the PR review.</p>



<a name="498558724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498558724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498558724">(Feb 09 2025 at 02:53)</a>:</h4>
<p>any plans to do snapshot testing for the parser? I think sometimes people call them golden tests? basically just like debug print the ast to a file and compare against it on the next run</p>



<a name="498559409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498559409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498559409">(Feb 09 2025 at 03:02)</a>:</h4>
<p><a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20snapshot.20testing">#compiler development &gt; zig compiler - snapshot testing</a></p>



<a name="498579833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498579833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498579833">(Feb 09 2025 at 08:32)</a>:</h4>
<p><code>@panic("TODO")</code> ftw</p>



<a name="498590103"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498590103" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498590103">(Feb 09 2025 at 11:01)</a>:</h4>
<p><span class="user-mention" data-user-id="406911">@Andrew Kelley</span> This is the way</p>



<a name="498608406"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498608406" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498608406">(Feb 09 2025 at 15:25)</a>:</h4>
<p>I'm going to put up my PR.  But first, should I try linking it into main.zig at all (even in it's very partially implemented state, and even though there is no further analysis being done)?</p>



<a name="498608864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498608864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498608864">(Feb 09 2025 at 15:31)</a>:</h4>
<p>Fire away please! <a href="https://github.com/roc-lang/roc/pull/7597">https://github.com/roc-lang/roc/pull/7597</a></p>



<a name="498608954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498608954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498608954">(Feb 09 2025 at 15:32)</a>:</h4>
<p>And yes, I'm going to be looking at:</p>
<ol>
<li>String interning</li>
<li>Problems</li>
<li>Malformed</li>
<li>Removing panics in general</li>
</ol>



<a name="498619047"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498619047" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498619047">(Feb 09 2025 at 17:43)</a>:</h4>
<p>If you don't link it to main, make sure it at least passes <code>zig fmt --check --ast-check</code></p>



<a name="498619735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498619735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498619735">(Feb 09 2025 at 17:53)</a>:</h4>
<p>Oh, just realized that the tree is valid now. Can we merge <a href="https://github.com/roc-lang/roc/pull/7589">https://github.com/roc-lang/roc/pull/7589</a> to protect it more from future breaks?</p>



<a name="498620856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498620856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498620856">(Feb 09 2025 at 18:08)</a>:</h4>
<p>Done</p>



<a name="498633517"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498633517" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498633517">(Feb 09 2025 at 20:59)</a>:</h4>
<p>I was waiting to see if anyone wanted to claim the fun one... but it seems to be still open for the taking. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> </p>
<p>I'd like to take responsibility for the type-checker. </p>
<p>Me and my mate Claude have some reading to do on HM type inference... but we have a nice implementation to follow.</p>



<a name="498633643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498633643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498633643">(Feb 09 2025 at 21:00)</a>:</h4>
<p>Hell yes, please take the hard work</p>



<a name="498633665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498633665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498633665">(Feb 09 2025 at 21:01)</a>:</h4>
<p>Wait.. you said type-checking was the easy one</p>



<a name="498633673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498633673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498633673">(Feb 09 2025 at 21:01)</a>:</h4>
<p>Talk to <span class="user-mention" data-user-id="357305">@Lucas Rosa</span>, he was also interested because of his experience</p>



<a name="498633690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498633690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498633690">(Feb 09 2025 at 21:01)</a>:</h4>
<p>It's not bad once you understand what's happening</p>



<a name="498633716"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498633716" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498633716">(Feb 09 2025 at 21:02)</a>:</h4>
<p>I'd recommend reading through the current <code>solve</code> and <code>unify</code> crates in the Rust code</p>



<a name="498636221"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498636221" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498636221">(Feb 09 2025 at 21:32)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> go for it, you have my support, just remember that constraint solving part, it's important for the quality of error messages :)</p>



<a name="498636348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498636348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498636348">(Feb 09 2025 at 21:34)</a>:</h4>
<p>I also have access to OG lang PhDs that we can ask questions to, like Kent from chez scheme, also I could ask philip wadler questions probably, not sure how responsive he is but I share a slack with him.</p>



<a name="498636418"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498636418" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498636418">(Feb 09 2025 at 21:35)</a>:</h4>
<p>just ping me and I can pretty much jump online to pair program about it at any time. the basics of HM type inference are straight forward and well understood for decades. definitely make sure you review solve and unify, those are the main show for this. a little bit of <code>can</code> reading wouldn't hurt either</p>



<a name="498636662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498636662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498636662">(Feb 09 2025 at 21:38)</a>:</h4>
<p>Thank you.</p>



<a name="498636776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498636776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498636776">(Feb 09 2025 at 21:40)</a>:</h4>
<p>I will be watching with keen interest Luke</p>



<a name="498636786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498636786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498636786">(Feb 09 2025 at 21:40)</a>:</h4>
<p>And I can also tell you what NOT to do <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="498637014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498637014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498637014">(Feb 09 2025 at 21:43)</a>:</h4>
<p>it's not unlike an interpreter, you walk the tree, assign type vars to things, primitives and annotations are like the terminal points from which everything resolves upwards from</p>
<p>the only things you might not see in intro material is the extensible records stuff (basically row polymorphism if I'm not messing up terms)<br>
and the tags which are like ocaml polymorphic variants (assuming that hasn't changed)</p>



<a name="498637090"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498637090" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498637090">(Feb 09 2025 at 21:44)</a>:</h4>
<p>I also recently did the exhaustive matrix check thingy for matches so that's still fresh in my head</p>



<a name="498637180"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498637180" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498637180">(Feb 09 2025 at 21:45)</a>:</h4>
<p>My plan is to approach it from both sides at once... spend roughly 50% of my time learning the theory, and the other following the rust impl.</p>



<a name="498637205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498637205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498637205">(Feb 09 2025 at 21:46)</a>:</h4>
<p>let me find you a paper for exhaustiveness, I'm pretty sure it's where elm got it's algo from, I lifted it from elm myself as well</p>



<a name="498637464"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498637464" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498637464">(Feb 09 2025 at 21:49)</a>:</h4>
<p>I think this is it<br>
<a href="https://www.cambridge.org/core/services/aop-cambridge-core/content/view/3165B75113781E2431E3856972940347/S0956796807006223a.pdf/warnings-for-pattern-matching.pdf">https://www.cambridge.org/core/services/aop-cambridge-core/content/view/3165B75113781E2431E3856972940347/S0956796807006223a.pdf/warnings-for-pattern-matching.pdf</a></p>



<a name="498637587"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498637587" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498637587">(Feb 09 2025 at 21:51)</a>:</h4>
<p>also available here in web form on some subdomain on inrias website</p>
<p><a href="http://moscova.inria.fr/~maranget/papers/warn/index.html">http://moscova.inria.fr/~maranget/papers/warn/index.html</a></p>



<a name="498637723"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498637723" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498637723">(Feb 09 2025 at 21:52)</a>:</h4>
<p>here is the elm implementation, also a remarkable reference because the code is some of the cleanest haskell code I've ever seen<br>
<a href="https://github.com/elm/compiler/blob/master/compiler/src/Nitpick/PatternMatches.hs">https://github.com/elm/compiler/blob/master/compiler/src/Nitpick/PatternMatches.hs</a><br>
along with my very ugly rust port of the exact algo<br>
<a href="https://github.com/aiken-lang/aiken/blob/main/crates/aiken-lang/src/tipo/exhaustive.rs">https://github.com/aiken-lang/aiken/blob/main/crates/aiken-lang/src/tipo/exhaustive.rs</a></p>



<a name="498640237"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498640237" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498640237">(Feb 09 2025 at 22:30)</a>:</h4>
<p>The existing Roc implementation works very well, I think we should basically try to transcribe it in Zig terms</p>



<a name="498640250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498640250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498640250">(Feb 09 2025 at 22:30)</a>:</h4>
<p>It was also lifted from elm, so I assumed he would look at the roc impl but I wanted to link him more sources</p>



<a name="498642549"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498642549" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498642549">(Feb 09 2025 at 23:03)</a>:</h4>
<p>of note, the "demanded" enum for records isn't necessary anymore due to optional record fields going away</p>



<a name="498642637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498642637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498642637">(Feb 09 2025 at 23:04)</a>:</h4>
<p>ah cool, good to know</p>



<a name="498643303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498643303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498643303">(Feb 09 2025 at 23:12)</a>:</h4>
<blockquote>
<p>optional record fields going away</p>
</blockquote>
<p>single tear. I'll miss default value function arguments</p>



<a name="498645541"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645541" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645541">(Feb 09 2025 at 23:42)</a>:</h4>
<p>Yeah, what replaces that? Is there another way to do it?</p>



<a name="498645574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645574">(Feb 09 2025 at 23:43)</a>:</h4>
<p>I've used them extensively in plume for example</p>



<a name="498645624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645624">(Feb 09 2025 at 23:43)</a>:</h4>
<p>Terse builders</p>



<a name="498645661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645661">(Feb 09 2025 at 23:44)</a>:</h4>
<p>That thing i did for Weaver... let me grab a link</p>



<a name="498645721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645721">(Feb 09 2025 at 23:44)</a>:</h4>
<p>Ahk.. I remember now. The builder pattern</p>



<a name="498645760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645760">(Feb 09 2025 at 23:45)</a>:</h4>
<p><a href="https://gist.github.com/smores56/dc7b37f73114df11d28cd6a148987dea#file-weaver-builders-roc">https://gist.github.com/smores56/dc7b37f73114df11d28cd6a148987dea#file-weaver-builders-roc</a></p>



<a name="498645820"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645820" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645820">(Feb 09 2025 at 23:46)</a>:</h4>
<p>I noticed that yesterday, pipe is replaced with <code>.</code>? not a bad idea at all</p>



<a name="498645887"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498645887" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498645887">(Feb 09 2025 at 23:46)</a>:</h4>
<p>That's static dispatch</p>



<a name="498646482"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498646482" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498646482">(Feb 09 2025 at 23:55)</a>:</h4>
<p>oh I see, I went back and actually paid attention to the proposal</p>
<div class="codehilite"><pre><span></span><code>There it is! Pass the value in front of the dot to that function as its first argument, and we&#39;re done. (If the Result module did not define a top-level mapErr, or if we couldn&#39;t have accessed it in this module because it wasn&#39;t exposed, we&#39;d get a compile-time error.)
</code></pre></div>
<p>sorry, still catching up to the most recent design</p>



<a name="498647626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498647626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498647626">(Feb 10 2025 at 00:07)</a>:</h4>
<p>"In this design, the API is literally all there is to consider—exactly as it should be!" - some chad probably</p>



<a name="498647858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498647858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498647858">(Feb 10 2025 at 00:10)</a>:</h4>
<p>"[-2, 0, 2].map(.abs().sub(1))" omg this is insane, didn't realize this could look so clean</p>



<a name="498648965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498648965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498648965">(Feb 10 2025 at 00:25)</a>:</h4>
<p>I still think default valued args are super useful, but optionals and builder patterns are okish alternatives.</p>



<a name="498651954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498651954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498651954">(Feb 10 2025 at 01:05)</a>:</h4>
<p>Yeah, I guess the hypothesis we are testing is can we get away without them. One more language feature we don't need to think about -- i.e. simplifies roc</p>



<a name="498652191"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498652191" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498652191">(Feb 10 2025 at 01:09)</a>:</h4>
<p>yep</p>



<a name="498818534"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498818534" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498818534">(Feb 10 2025 at 17:19)</a>:</h4>
<p>random other notes I just thought of (or really, Loris reminded me of).</p>
<p>Debug assertions are our friends. Please feel free to add <code>std.debug.assert</code> to your code. They will all be ripped out in the final release binaries, but they are great anchors for fuzzing and for testing in general.</p>



<a name="498820647"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/498820647" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#498820647">(Feb 10 2025 at 17:28)</a>:</h4>
<p><a href="https://github.com/kristoff-it/zig-lsp-kit">https://github.com/kristoff-it/zig-lsp-kit</a></p>
<p>I figure most say this already, but just in case. this could be useful</p>



<a name="499605725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499605725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499605725">(Feb 13 2025 at 23:31)</a>:</h4>
<p>Adding llvm feels so painful. RIP binary size (will be great when we add an interpreter only config).</p>
<p>Debug<br>
840K -&gt; 114M</p>
<p>ReleaseFast strip<br>
72k -&gt; 9M</p>
<p>This is all without actually using any llvm. This is simply linking to a c++ file and statically compiled llvm, not actually using anything yet.</p>



<a name="499605811"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499605811" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499605811">(Feb 13 2025 at 23:31)</a>:</h4>
<p>A necessary cost, it seems</p>



<a name="499605999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499605999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499605999">(Feb 13 2025 at 23:33)</a>:</h4>
<p>I really surprised that release fast with strip grows by so much when we literally don't use any of it. That said, it will grow by much more than that once we start using things.</p>



<a name="499606167"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606167" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606167">(Feb 13 2025 at 23:35)</a>:</h4>
<p>but yeah, statically compiled release builds of llvm and lld together are 201MB. So if we reference absolutely everything our compiler would be that big.</p>



<a name="499606290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606290">(Feb 13 2025 at 23:36)</a>:</h4>
<p>Which is why zig is like 270MB in size (note, zig also packages clang which we won't)</p>



<a name="499606503"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606503" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606503">(Feb 13 2025 at 23:38)</a>:</h4>
<p>It would be really nice to go the same route as zig and take LLVM out of the compiler binary. I know we want everything to be a single binary, but could we instead have some tooling in the cli which makes it easy to install LLVM or setup the right thing if it's not already available in the system.</p>



<a name="499606563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606563">(Feb 13 2025 at 23:39)</a>:</h4>
<p>Do you mean the same route as <code>cargo</code>?</p>



<a name="499606615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606615">(Feb 13 2025 at 23:39)</a>:</h4>
<p>Just spitballing here -- I'm thinking it might be good to map out the intended use cases or some scenarios of people using roc and figure out when we think we need a fully statically linked thing that includes LLVM, and are there other ways we could make that seamless.</p>



<a name="499606628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606628">(Feb 13 2025 at 23:39)</a>:</h4>
<p>Yeah, theoretically we could emit a <code>.bc</code> file or run the interpretter (super slim). Then we could orchestrate llvm to actually compile. On first run, would just download our llvm compiler to the cache.</p>



<a name="499606739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606739">(Feb 13 2025 at 23:40)</a>:</h4>
<p>That said, I think for most users, this just means instead of downloading llvm now, they download it in a few days when they make an optimized build</p>



<a name="499606762"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606762" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606762">(Feb 13 2025 at 23:41)</a>:</h4>
<p>So not really that much of gain in my mind.</p>



<a name="499606775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606775">(Feb 13 2025 at 23:41)</a>:</h4>
<p>Just hidden on first compilation</p>



<a name="499606801"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606801" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606801">(Feb 13 2025 at 23:41)</a>:</h4>
<p>It also means upgrading roc... may use the same LLVM compiler and switching between roc versions may not need to download it again -- just use the one we saved in the roc cache</p>



<a name="499606829"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606829" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606829">(Feb 13 2025 at 23:41)</a>:</h4>
<p>Oh, yeah, that is fair.</p>



<a name="499606836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606836">(Feb 13 2025 at 23:41)</a>:</h4>
<p>less often that you need to update the llvm bundle potentially</p>



<a name="499606925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606925">(Feb 13 2025 at 23:42)</a>:</h4>
<p>Roc compiler without LLVM bundled might be a couple of MBs (maybe even smaller?)... so it would be almost free to have every version in the roc cache.</p>



<a name="499606926"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606926" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606926">(Feb 13 2025 at 23:42)</a>:</h4>
<p>In fact, assuming we generate an old version of bitcode, you potentially could lazily update much later. Like just use llvm 18 for a few years then jump to llvm 22.</p>



<a name="499606983"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499606983" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499606983">(Feb 13 2025 at 23:43)</a>:</h4>
<p>Unless there is a significant performance gain from upgrading to 22 (for example) which we can easily measure... then we may not even need to.</p>



<a name="499607008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607008">(Feb 13 2025 at 23:43)</a>:</h4>
<p>I have zero anything to base that on though</p>



<a name="499607120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607120">(Feb 13 2025 at 23:44)</a>:</h4>
<p>Long term this is definitely something we should explore.</p>



<a name="499607193"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607193" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607193">(Feb 13 2025 at 23:45)</a>:</h4>
<p>I was thinking short-medium term... it would help us with the development process to be able to manage multiple versions seamlessly -- the roc cli upgrades and downgrades itself</p>



<a name="499607367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607367">(Feb 13 2025 at 23:46)</a>:</h4>
<p>I think simply generating bitcode files already will give us a lot of flexibility. Still will depend on a few c apis from llvm, but they are the much more stable high level apis.</p>



<a name="499607391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607391">(Feb 13 2025 at 23:46)</a>:</h4>
<p>What is the size impact if we only have LLD linked?</p>



<a name="499607574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607574">(Feb 13 2025 at 23:48)</a>:</h4>
<p>should be around 10MB</p>



<a name="499607576"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607576" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607576">(Feb 13 2025 at 23:48)</a>:</h4>
<p>Maybe less</p>



<a name="499607633"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607633" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607633">(Feb 13 2025 at 23:49)</a>:</h4>
<p>Seems like bundling LLVM as well will be easier to get right for now. Would we be okay with starting with that and then pulling LLVM out later?</p>



<a name="499607745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607745">(Feb 13 2025 at 23:50)</a>:</h4>
<p>I think we should prioritize features that get us a working compiler first, and a fast one later</p>



<a name="499607763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607763">(Feb 13 2025 at 23:51)</a>:</h4>
<p>But if it's gonna be a fun project to get this working, then by all means</p>



<a name="499607776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607776">(Feb 13 2025 at 23:51)</a>:</h4>
<p>Also, to begin with, for the interpreter path, we will still need llvm.</p>



<a name="499607784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607784">(Feb 13 2025 at 23:51)</a>:</h4>
<p>Cause we need to generate the shims</p>



<a name="499607814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607814">(Feb 13 2025 at 23:51)</a>:</h4>
<p>probably could manually generate those at some point if we want.</p>



<a name="499607939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499607939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499607939">(Feb 13 2025 at 23:52)</a>:</h4>
<p>Could the shim be prebuilt?</p>



<a name="499608279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608279">(Feb 13 2025 at 23:55)</a>:</h4>
<p>hmm... possibly could be. I guess it is static to the platform. So the platform could provide an extra shim object file per platform.</p>



<a name="499608300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608300">(Feb 13 2025 at 23:55)</a>:</h4>
<p>Like roc serialises ResolveIR, the interpreter shim is prebuilt and parses that before it starts doing it's interpreter thing...</p>
<p>But I guess this doesn't work because it needs to know what shape to satisfy the platform hosts API.</p>



<a name="499608366"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608366" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608366">(Feb 13 2025 at 23:56)</a>:</h4>
<p>It's worth trying.</p>



<a name="499608382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608382">(Feb 13 2025 at 23:56)</a>:</h4>
<p>Oh yeah.... that was the idea -- the platform provides a prebuilt interpreter</p>



<a name="499608394"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608394" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608394">(Feb 13 2025 at 23:56)</a>:</h4>
<p>I remember we discussed that</p>



<a name="499608440"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608440" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608440">(Feb 13 2025 at 23:57)</a>:</h4>
<p>Not a prebuilt interpretter, just a prebuilt shim object file</p>



<a name="499608554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608554">(Feb 13 2025 at 23:58)</a>:</h4>
<p>Hmm, though the platform doesn't know the file locations of the final app which is need for the shim to know what to load.</p>



<a name="499608690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608690">(Feb 13 2025 at 23:59)</a>:</h4>
<p>Cause the shim essentially needs to provide the intepretter with the app <code>main.roc</code> path, the name of the entrypoint being called, a return pointer, and a list of argument pointers. The interpreter can then learn the types of each pointer by reading the roc source code.</p>



<a name="499608906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499608906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499608906">(Feb 14 2025 at 00:01)</a>:</h4>
<p>Anyway, I plan to get the interpreter working with shim and such before starting the llvm backend. So that will give us more concrete ideas here.</p>



<a name="499609158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499609158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499609158">(Feb 14 2025 at 00:02)</a>:</h4>
<p>For now, I am just adding the wiring for llvm, I will leave it commented out in the build script to avoid the giant binaries until we have an llvm backend.</p>



<a name="499610004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499610004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499610004">(Feb 14 2025 at 00:10)</a>:</h4>
<p>we should consider having the llvm backend only in the build if you enable a flag</p>



<a name="499610034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499610034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499610034">(Feb 14 2025 at 00:11)</a>:</h4>
<p>bc the majority of compiler development won't need it and will be faster without it</p>



<a name="499610204"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499610204" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499610204">(Feb 14 2025 at 00:12)</a>:</h4>
<p>and then we could instead build in something which just panics every time you call it saying "this compiler wasn't built with llvm, please rebuild with that env var set to use this feature"</p>



<a name="499611761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499611761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499611761">(Feb 14 2025 at 00:27)</a>:</h4>
<blockquote>
<p>the majority of compiler development won't need it</p>
</blockquote>
<p>I wonder how well we can work on backend passes without llvm</p>



<a name="499611838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499611838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499611838">(Feb 14 2025 at 00:28)</a>:</h4>
<p>We just have to validate their output</p>



<a name="499611864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499611864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499611864">(Feb 14 2025 at 00:28)</a>:</h4>
<p>We can do that for at least simple cases with unit testing/fuzzing</p>



<a name="499611886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499611886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499611886">(Feb 14 2025 at 00:28)</a>:</h4>
<p>But yes, the LLVM codegen side will be trickier</p>



<a name="499611991"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499611991" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499611991">(Feb 14 2025 at 00:29)</a>:</h4>
<p>I mean theoretically we will even be able to generate .bc files without llvm</p>



<a name="499612005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499612005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499612005">(Feb 14 2025 at 00:29)</a>:</h4>
<p>So it really is just for the final exe</p>



<a name="499612079"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499612079" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499612079">(Feb 14 2025 at 00:30)</a>:</h4>
<p>Oh, I thought by "I wonder how well" you were implying "I'm not confident we can do a good job"</p>



<a name="499612089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499612089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499612089">(Feb 14 2025 at 00:30)</a>:</h4>
<p>I agree</p>



<a name="499612183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499612183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499612183">(Feb 14 2025 at 00:31)</a>:</h4>
<p>I guess we can run all snapshot tests without llvm, so that is nice anchor.</p>



<a name="499612210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499612210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499612210">(Feb 14 2025 at 00:31)</a>:</h4>
<p>like we can generate refcounting ir and lower ir.</p>



<a name="499628155"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499628155" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499628155">(Feb 14 2025 at 03:07)</a>:</h4>
<p>Roc successfully cross compiling to all major targets with llvm (as static as possible): <a href="https://github.com/roc-lang/roc/actions/runs/13321631348/job/37207263318?pr=7603">https://github.com/roc-lang/roc/actions/runs/13321631348/job/37207263318?pr=7603</a></p>



<a name="499629278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499629278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499629278">(Feb 14 2025 at 03:21)</a>:</h4>
<p>yoooooooooooo</p>



<a name="499683220"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499683220" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499683220">(Feb 14 2025 at 09:24)</a>:</h4>
<p>for what it's worth, zig built in ReleaseSmall mode without llvm is 12M</p>



<a name="499683480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499683480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499683480">(Feb 14 2025 at 09:25)</a>:</h4>
<p>and I think it's interesting to note that includes a full x86 backend, C backend, llvm (bitcode) backend, wasm backend, riscv64 backend, elf linker, coff linker, wasm linker. the only thing it lacks compared to llvm is a few more targets and optimization passes</p>



<a name="499814496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499814496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499814496">(Feb 14 2025 at 19:40)</a>:</h4>
<p>4 messages were moved from this topic to <a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20fuzzing">#compiler development &gt; zig compiler - fuzzing</a> by <span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span>.</p>



<a name="499864345"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499864345" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499864345">(Feb 15 2025 at 01:40)</a>:</h4>
<p>Does anyone have any recommendations for debug printing with zig?</p>



<a name="499864362"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499864362" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499864362">(Feb 15 2025 at 01:40)</a>:</h4>
<p>I want to debug print in tests.. but only if the test fails</p>



<a name="499864481"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499864481" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499864481">(Feb 15 2025 at 01:41)</a>:</h4>
<p><code>std.log.debug</code> and <code>std.log.info</code> do not show up in <code>zig test</code> output</p>



<a name="499864952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499864952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499864952">(Feb 15 2025 at 01:46)</a>:</h4>
<p>did you set the log level?</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">std_options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">    </span><span class="p">.</span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">debug</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>



<a name="499864997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499864997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499864997">(Feb 15 2025 at 01:46)</a>:</h4>
<p>Is that in the module I'm testing or the <code>tests.zig</code> file?</p>



<a name="499865033"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499865033" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499865033">(Feb 15 2025 at 01:47)</a>:</h4>
<p>I think once in <code>test.zig</code> should work. It should be a global flag to my understanding</p>



<a name="499865081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499865081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499865081">(Feb 15 2025 at 01:47)</a>:</h4>
<p>Otherwise, maybe just <code>std.debug.print</code> after checking for failure?</p>



<a name="499865097"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499865097" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499865097">(Feb 15 2025 at 01:47)</a>:</h4>
<p>I'm not really sure best practice here</p>



<a name="499865201"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499865201" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499865201">(Feb 15 2025 at 01:48)</a>:</h4>
<p>Yeah, me either. I've been researching and trying different things. But haven't found a reasonable solution yet.</p>



<a name="499865258"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499865258" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499865258">(Feb 15 2025 at 01:49)</a>:</h4>
<p>Basically... I have all these test scenarios for unification etc... and they can print out useful debug info for each step. I only want to see that for the tests that fail though.</p>



<a name="499865339"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499865339" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499865339">(Feb 15 2025 at 01:50)</a>:</h4>
<p>Maybe I should be thinking about snapshots at this point instead though</p>



<a name="499867616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499867616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499867616">(Feb 15 2025 at 02:13)</a>:</h4>
<p>Hey... I got something working. Builds a snapshot test file using debug prints.</p>



<a name="499867997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499867997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499867997">(Feb 15 2025 at 02:17)</a>:</h4>
<p>Just in case you didn't already read this: <a href="https://kristoff.it/blog/dead-simple-snapshot-testing/">https://kristoff.it/blog/dead-simple-snapshot-testing/</a></p>



<a name="499873969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499873969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499873969">(Feb 15 2025 at 03:17)</a>:</h4>
<p>Would it be a bad idea to give a Type Variable a comptime optional "name" to help with debug printing?</p>



<a name="499874060"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499874060" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499874060">(Feb 15 2025 at 03:18)</a>:</h4>
<p>I'd like to have pretty greek letters for my snapshots tests instead of having random integers everywhere</p>



<a name="499874629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499874629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499874629">(Feb 15 2025 at 03:24)</a>:</h4>
<p>Why not convert integers to characters on print for the snapshot test?</p>



<a name="499874649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499874649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499874649">(Feb 15 2025 at 03:24)</a>:</h4>
<p>Ooh, that's a nicer idea</p>



<a name="499874732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499874732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499874732">(Feb 15 2025 at 03:25)</a>:</h4>
<p>I've almost got something working.. I might just keep going with this thought before trying that</p>



<a name="499880770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499880770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499880770">(Feb 15 2025 at 04:37)</a>:</h4>
<p>I went ahead and rebased <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> 's parser PR and fixed some bugs: <a href="https://github.com/roc-lang/roc/pull/7609">https://github.com/roc-lang/roc/pull/7609</a></p>
<p>(would like to get that landed soon so we can iterate on it)</p>



<a name="499881683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499881683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499881683">(Feb 15 2025 at 04:52)</a>:</h4>
<p>I'm happy to approve to unblock after the tests are fixed</p>



<a name="499884426"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499884426" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499884426">(Feb 15 2025 at 05:36)</a>:</h4>
<p>Very puzzled at the <a href="https://github.com/roc-lang/roc/actions/runs/13342120382/job/37268097270?pr=7609">current failure</a><br>
Is it possible that CI box has run out of disk space or something?</p>



<a name="499884553"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499884553" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499884553">(Feb 15 2025 at 05:39)</a>:</h4>
<p>That is what it looks like, which is pretty confusing cause it is a GitHub runner. Should have a blank slate every time</p>



<a name="499884568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499884568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499884568">(Feb 15 2025 at 05:39)</a>:</h4>
<p>We use our own runners, right?</p>



<a name="499884579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499884579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499884579">(Feb 15 2025 at 05:39)</a>:</h4>
<p>Not here I don't think. I think this are vanilla GitHub runners</p>



<a name="499884587"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499884587" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499884587">(Feb 15 2025 at 05:39)</a>:</h4>
<p>But maybe that is wrong</p>



<a name="499884912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499884912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499884912">(Feb 15 2025 at 05:45)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> can you rebase on latest main and run again. I just merged something that changed test steps a bit. Not saying it will fix anything, but might give more info.</p>



<a name="499885256"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885256" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885256">(Feb 15 2025 at 05:51)</a>:</h4>
<p>No change, looks like</p>



<a name="499885488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885488">(Feb 15 2025 at 05:55)</a>:</h4>
<p>Really confusing that cross compiling with <code>-Dllvm</code> works, but somehow regular compiling does not....</p>



<a name="499885548"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885548" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885548">(Feb 15 2025 at 05:56)</a>:</h4>
<p>I guess it could be related to <code>-Dllvm</code> combined with <code>-Dfuzz</code> for some reason.</p>



<a name="499885552"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885552" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885552">(Feb 15 2025 at 05:56)</a>:</h4>
<p>Removing -Dllvm seems to work</p>



<a name="499885600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885600">(Feb 15 2025 at 05:57)</a>:</h4>
<p>Maybe it'd be better to remove -Dfuzz?</p>



<a name="499885607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885607">(Feb 15 2025 at 05:57)</a>:</h4>
<p>nah, <code>-Dllvm</code> doesn't actually do anything useful currently</p>



<a name="499885608"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885608" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885608">(Feb 15 2025 at 05:57)</a>:</h4>
<p>Still very puzzled as to what's going on</p>



<a name="499885653"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885653" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885653">(Feb 15 2025 at 05:58)</a>:</h4>
<p>Could be out of disk space, but should have 14GB, so a bit surprising</p>



<a name="499885660"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885660" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885660">(Feb 15 2025 at 05:58)</a>:</h4>
<p>llvm is only like 300MB or so</p>



<a name="499885667"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885667" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885667">(Feb 15 2025 at 05:58)</a>:</h4>
<p>even if it gets duplicated for ever executable, it should be no where near 14GB</p>



<a name="499885675"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499885675" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499885675">(Feb 15 2025 at 05:58)</a>:</h4>
<p>Also, why would it break on this PR specifically...hmm</p>



<a name="499886001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886001">(Feb 15 2025 at 06:02)</a>:</h4>
<p>Hmm; added a call to <code>df -h</code> and of course now it works</p>



<a name="499886022"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886022" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886022">(Feb 15 2025 at 06:02)</a>:</h4>
<p>You still don't have <code>-Dllvm</code></p>



<a name="499886037"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886037" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886037">(Feb 15 2025 at 06:03)</a>:</h4>
<p>Oh whoops</p>



<a name="499886254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886254">(Feb 15 2025 at 06:06)</a>:</h4>
<p>Probably not disk space:</p>
<div class="codehilite"><pre><span></span><code> /dev/root        72G   46G   26G  64% /
</code></pre></div>



<a name="499886526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886526">(Feb 15 2025 at 06:11)</a>:</h4>
<p>is it only failing on ubuntu-24.04?</p>



<a name="499886536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886536">(Feb 15 2025 at 06:11)</a>:</h4>
<p>Yep :/</p>



<a name="499886609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886609">(Feb 15 2025 at 06:12)</a>:</h4>
<p>Can we try <code>ubuntu-22.04</code> just to see?</p>



<a name="499886649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499886649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499886649">(Feb 15 2025 at 06:13)</a>:</h4>
<p>I have no immediate ideas, probably would need to pull up a linux machine and test.</p>



<a name="499887233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499887233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499887233">(Feb 15 2025 at 06:23)</a>:</h4>
<p>It works on ubuntu-22.04 <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="499887772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499887772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499887772">(Feb 15 2025 at 06:32)</a>:</h4>
<p>Send it and worry about it later.</p>



<a name="499887776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499887776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499887776">(Feb 15 2025 at 06:32)</a>:</h4>
<p>Might be some weird GitHub CI bug</p>



<a name="499897549"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499897549" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499897549">(Feb 15 2025 at 09:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/499864362">said</a>:</p>
<blockquote>
<p>I want to debug print in tests.. but only if the test fails</p>
</blockquote>
<p>oh yeah I've been meaning to make what you want be the default thing</p>



<a name="499897590"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499897590" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499897590">(Feb 15 2025 at 09:09)</a>:</h4>
<p>tracking issue: <a href="https://github.com/ziglang/zig/issues/5738">https://github.com/ziglang/zig/issues/5738</a></p>



<a name="499961477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/499961477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#499961477">(Feb 16 2025 at 00:03)</a>:</h4>
<p>A message was moved from this topic to <a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20builtins">#compiler development &gt; zig compiler - builtins</a> by <span class="user-mention silent" data-user-id="515757">Luke Boswell</span>.</p>



<a name="500037205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500037205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500037205">(Feb 16 2025 at 19:23)</a>:</h4>
<p>Good watch on some zig patterns like comptime interfaces. Discussed a handful of useful ideas: <a href="https://youtu.be/l_qY2p0OH9A?t=1920&amp;si=gzHTwuGTYRWoDQlS">https://youtu.be/l_qY2p0OH9A?t=1920&amp;si=gzHTwuGTYRWoDQlS</a></p>
<div class="youtube-video message_inline_image"><a data-id="l_qY2p0OH9A" href="https://youtu.be/l_qY2p0OH9A?t=1920&amp;si=gzHTwuGTYRWoDQlS"><img src="https://uploads.zulipusercontent.net/123d390a92bbd330022ffb59373ca97f6e6beedb/68747470733a2f2f692e7974696d672e636f6d2f76692f6c5f71593270304f4839412f64656661756c742e6a7067"></a></div>



<a name="500048370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500048370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500048370">(Feb 16 2025 at 21:54)</a>:</h4>
<p>Implemented some functionality in the old formatter to support migrating to the new braces syntax: <a href="https://github.com/roc-lang/roc/pull/7619">https://github.com/roc-lang/roc/pull/7619</a></p>
<p>There are almost certainly bugs hiding in the formatting here, since I'm not really doing any verification on it. I'd like to assert that the new parser parses all of these inputs (or we add more "NotSupported" errors as appropriate).</p>
<p><span class="user-mention" data-user-id="781658">@Anthony Bullard</span> that PR also contains *.migrated.roc files, which should hopefully serve as useful test inputs for the new parser.</p>



<a name="500067436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500067436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500067436">(Feb 17 2025 at 02:15)</a>:</h4>
<p>I wanted to understand the plan to wire up the compiler stages. I've put together this simplified diagram that I think captures some of the key features - with the help of Sam.</p>
<p><a href="/user_uploads/22008/GNkh3Jn8Pw2WNq44wf3QYazJ/Roc-Compiler-Stages-Environments.pdf">Roc Compiler Stages - Environments.pdf</a></p>
<p>Some key points to summarise</p>
<ul>
<li>we start interning strings, names etc in tokenisation... so we instantiate a <strong>SoloEnv</strong> there</li>
<li>the <strong>SoloEnv</strong> is shared with Can and contains all the interned (and deduplicated) data for a single file (or module) at a time.</li>
<li>When we resolve imports we analyse the graph of module dependencies to find the strongly connected components, then combine those with cyclic deps that cannot be separated into <strong>ModuleSet</strong>. Most <strong>ModuleSet</strong>'s probably contain only a single module.</li>
<li>We instantiate a <strong>CombinedEnv</strong> for each set of modules, which contains all the interned data combined from the separate modules, and this env will be passed between all the future compiler stages.</li>
<li>The Coordinator will ensure that any dependencies are completed first before commencing a stage</li>
<li>The IR's should contain any data that doesn't live beyond the next stage. For example the information about "types" in TypeSpecIR is in the IR and not in the CombinedEnv.</li>
<li>Re namespacing a <strong>Module</strong> lives under <strong>SoloEnv</strong>, and a <strong>ModuleSet</strong> lives under <strong>CombinedEnv</strong>.</li>
</ul>



<a name="500067931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500067931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500067931">(Feb 17 2025 at 02:21)</a>:</h4>
<p>I thought we don't have cyclic dependencies</p>



<a name="500067936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500067936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500067936">(Feb 17 2025 at 02:21)</a>:</h4>
<p>So no module sets?</p>



<a name="500067954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500067954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500067954">(Feb 17 2025 at 02:21)</a>:</h4>
<p>Though maybe type variables or static dispatch change this?</p>



<a name="500067967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500067967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500067967">(Feb 17 2025 at 02:21)</a>:</h4>
<p>We didn't used to have them, but we'd like to see if we can make cyclic dependencies work</p>



<a name="500068042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500068042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500068042">(Feb 17 2025 at 02:22)</a>:</h4>
<p>The reason is because you might have two custom types that depend on each other (we expect this for DB constructs) and they both need to define a <code>to_str</code></p>



<a name="500068045"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500068045" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500068045">(Feb 17 2025 at 02:22)</a>:</h4>
<p>Oh, interesting. Are there restrictions?</p>



<a name="500068047"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500068047" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500068047">(Feb 17 2025 at 02:22)</a>:</h4>
<p>They can't do that in the same file</p>



<a name="500068065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500068065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500068065">(Feb 17 2025 at 02:23)</a>:</h4>
<p>Currently, the plan is to have them give a warning about compilation speed if it's not necessary</p>



<a name="500068089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500068089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500068089">(Feb 17 2025 at 02:23)</a>:</h4>
<p>And "necessary" means the modules have custom types that depend on each other</p>



<a name="500068995"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500068995" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500068995">(Feb 17 2025 at 02:33)</a>:</h4>
<p>yeah, basically the idea is that if you have two nominal tag unions that are mutually recursive, and you also want them to have static dispatch (which could come up when modeling database tables, for example) that's currently impossible</p>



<a name="500069152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069152">(Feb 17 2025 at 02:35)</a>:</h4>
<p>so if we do this, then all the modules in the cycle basically get type-checked as one big unit</p>



<a name="500069180"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069180" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069180">(Feb 17 2025 at 02:36)</a>:</h4>
<p>which is worse for both concurrency and caching granularity</p>



<a name="500069243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069243">(Feb 17 2025 at 02:36)</a>:</h4>
<p>so it's kind of a perf footgun unless you're specifically using it to resolve the thing that's currently impossible</p>



<a name="500069286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069286">(Feb 17 2025 at 02:37)</a>:</h4>
<p>e.g. if you're not careful, one wrong <code>import</code> can accidentally make your entire project into one big cycle that can't be parallelized at all anymore</p>



<a name="500069319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069319">(Feb 17 2025 at 02:37)</a>:</h4>
<p>so the warning would be basically "you have a cycle involving modules that don't expose mutually recursive types, so you should break it up!"</p>



<a name="500069334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069334">(Feb 17 2025 at 02:37)</a>:</h4>
<p>that way you get equivalent perf to today</p>



<a name="500069386"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069386" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069386">(Feb 17 2025 at 02:38)</a>:</h4>
<p>because the only cycles are between modules that have mutually recursive types, which is also true today (where you have to just literally put them in the same module instead)</p>



<a name="500069411"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069411" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069411">(Feb 17 2025 at 02:38)</a>:</h4>
<p>as a bonus, it's also nice for "always report, never block"</p>



<a name="500069448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069448">(Feb 17 2025 at 02:38)</a>:</h4>
<p>in that if you find yourself in a spot where you import something and it causes a cycle, you aren't blocked - you <em>can</em> do that, and still run your program</p>



<a name="500069468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500069468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500069468">(Feb 17 2025 at 02:39)</a>:</h4>
<p>and maybe confirm whether you want to keep that architecture before cleaning up the cycle later</p>



<a name="500072638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500072638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500072638">(Feb 17 2025 at 03:14)</a>:</h4>
<p>What if you end up being unsure how to break up the cycle and want to just leave it be. Will you be stuck with roc reporting failures in CI?</p>



<a name="500079293"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500079293" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500079293">(Feb 17 2025 at 04:30)</a>:</h4>
<p>That's the current plan. You can always remove it by putting the cycle in a single file, but even more, since the cycle will be immediately obvious on creation, this will be an annoyance that will be early to see in at least most cases</p>



<a name="500079363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500079363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500079363">(Feb 17 2025 at 04:31)</a>:</h4>
<p>I'd rather we not allow cyclic imports to prevent this from even being an issue, but the aforementioned custom types scenario doesn't seem to have a better solution</p>



<a name="500081073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500081073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500081073">(Feb 17 2025 at 04:47)</a>:</h4>
<p>Yeah, I just find it strange partially allowing it</p>



<a name="500081084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500081084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500081084">(Feb 17 2025 at 04:47)</a>:</h4>
<p>Sounds painful potentially</p>



<a name="500082494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500082494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500082494">(Feb 17 2025 at 04:59)</a>:</h4>
<p>btw can I get Roc compiler developers' opinions about this? <a href="https://github.com/ziglang/zig/pull/22137">https://github.com/ziglang/zig/pull/22137</a></p>
<p>do you prefer status quo names or the names proposed in this PR?</p>



<a name="500083299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500083299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500083299">(Feb 17 2025 at 05:06)</a>:</h4>
<p>I think the old wording is definitely clearer. I don't have to guess at all. That said, you only have to learn once, so the new wording is fine overall.</p>
<p>I wish ensureReserved worked, I think it's nicer than reserveUnused. I guess appendReserved works.</p>



<a name="500103874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500103874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500103874">(Feb 17 2025 at 07:41)</a>:</h4>
<p>Not familiar with the zig std, so I don't know if there are inconsistencies, but the original wording communicates intent better. To me, even <code>appendAssumeCapacity</code> is more clean than <code>appendReserved</code>, though not by much.</p>



<a name="500125333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500125333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500125333">(Feb 17 2025 at 09:18)</a>:</h4>
<p>Thanks!</p>



<a name="500293568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500293568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500293568">(Feb 18 2025 at 00:13)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> </p>
<p>Could you please make a single unit test or something that produces a minimal <code>parse.IR</code>. </p>
<p>Like are we at the point we're the IR could represents this?</p>
<div class="codehilite"><pre><span></span><code>module [name]

name = &quot;Luke&quot;
</code></pre></div>
<p>This would be really helpful for working on Can. We're just not sure how to work with the ParseIR rn.</p>



<a name="500293691"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500293691" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500293691">(Feb 18 2025 at 00:14)</a>:</h4>
<p>Just the output -- hardcoded is ok if we don't have the parser implementation this far yet.</p>



<a name="500294890"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500294890" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500294890">(Feb 18 2025 at 00:28)</a>:</h4>
<p>I'm trying to make something like this... but definitely not right</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="k">test</span><span class="w"> </span><span class="s">"Example Can IR"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Imagine we received a parse.IR representing the following roc module</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\module [name]</span>
<span class="w">        </span><span class="sh">\\</span>
<span class="w">        </span><span class="sh">\\name = "Luke"</span>
<span class="w">    </span><span class="p">;</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">parse_ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p">.</span><span class="n">IR</span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p">.</span><span class="n">TokenizedBuffer</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parse</span><span class="p">.</span><span class="n">NodeStore</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">errors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{},</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">can_ir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IR</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// We called "canonicalize" and</span>
<span class="w">    </span><span class="n">canonicalize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">can_ir</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parse_ir</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



<a name="500296446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500296446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500296446">(Feb 18 2025 at 00:46)</a>:</h4>
<p>I think it'd be nice to have these fields added to the <code>parse.IR</code>:</p>
<ul>
<li><code>header: NodeStore.Header</code></li>
<li><code>statements: std.ArrayList(NodeStore.Statement)</code></li>
</ul>



<a name="500296462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500296462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500296462">(Feb 18 2025 at 00:46)</a>:</h4>
<p>Or something like those, as that would unblock canonicalization</p>



<a name="500296475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500296475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500296475">(Feb 18 2025 at 00:47)</a>:</h4>
<p>For now, I'm just pretending those exist and using dummy values</p>



<a name="500298889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500298889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500298889">(Feb 18 2025 at 01:14)</a>:</h4>
<p>something I always wished we had in the Rust code base was having every single test suite start with normal Roc source code as the input</p>



<a name="500298949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500298949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500298949">(Feb 18 2025 at 01:15)</a>:</h4>
<p>I think to do that, we'd need test helpers for each step that build on the previous step's helper</p>



<a name="500299076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500299076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500299076">(Feb 18 2025 at 01:16)</a>:</h4>
<p>I presume you're thinking of something like what <span class="user-mention" data-user-id="489294">@Agus Zubiaga</span> started setting up for the <code>test_compile</code> crate: <a href="https://github.com/roc-lang/roc/blob/26f9416929aa0cd52ca732fc533b4a94a690de04/crates/test_compile/src/help_constrain.rs#L29">https://github.com/roc-lang/roc/blob/26f9416929aa0cd52ca732fc533b4a94a690de04/crates/test_compile/src/help_constrain.rs#L29</a></p>



<a name="500299253"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500299253" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500299253">(Feb 18 2025 at 01:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500298889">said</a>:</p>
<blockquote>
<p>something I always wished we had in the Rust code base was having every single test suite start with normal Roc source code as the input</p>
</blockquote>
<p>I would like this.</p>
<p>Im currently just trying to get my head around the IRs in a really minimal sense. Not suggesting we make unit tests like this.</p>



<a name="500300192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500300192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500300192">(Feb 18 2025 at 01:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500298889">said</a>:</p>
<blockquote>
<p>something I always wished we had in the Rust code base was having every single test suite start with normal Roc source code as the input</p>
</blockquote>
<p>I think many tests can be that way, but it also can make things more brittle to changes higher up the stack. Also can make it harder to write some of the low level optimization steps.</p>



<a name="500300211"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500300211" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500300211">(Feb 18 2025 at 01:28)</a>:</h4>
<p>That said..I think that is what the super snapshot test framework is for</p>



<a name="500300272"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500300272" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500300272">(Feb 18 2025 at 01:29)</a>:</h4>
<p>I really think we need to get the base of snapshots working with parse and can. Then slowly work it down the stack</p>



<a name="500301514"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301514" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301514">(Feb 18 2025 at 01:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500300192">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500298889">said</a>:</p>
<blockquote>
<p>something I always wished we had in the Rust code base was having every single test suite start with normal Roc source code as the input</p>
</blockquote>
<p>I think many tests can be that way, but it also can make things more brittle to changes higher up the stack.</p>
</blockquote>
<p>I agree, but I think it's worth it <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="500301559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301559">(Feb 18 2025 at 01:41)</a>:</h4>
<p>like I spent a lot of time in tests trying to build IRs from scratch and then taking even more time to try to figure out if they were correct</p>



<a name="500301637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301637">(Feb 18 2025 at 01:42)</a>:</h4>
<p>also I know there were tests I wouldn't write just because setting up the IRs was too tricky, but starting from scratch it wouldn't have been</p>



<a name="500301668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301668">(Feb 18 2025 at 01:42)</a>:</h4>
<p>so I think the brittleness to upstream changes is worth it</p>



<a name="500301669"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301669" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301669">(Feb 18 2025 at 01:42)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> the reason I'd like not to just directly have a header/statements is I want this to be able to directly parse individual expressions both for testing and for repl evaluation</p>



<a name="500301696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301696">(Feb 18 2025 at 01:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500301559">said</a>:</p>
<blockquote>
<p>like I spent a lot of time in tests trying to build IRs from scratch</p>
</blockquote>
<p>Yeah, this is a fundamental problem</p>



<a name="500301748"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301748" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301748">(Feb 18 2025 at 01:44)</a>:</h4>
<p>I assume if every ir can be printed and parsed, it will reduce this pain a lot</p>



<a name="500301786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301786">(Feb 18 2025 at 01:44)</a>:</h4>
<p>I'm not saying <em>all</em> tests should start from source code btw, but rather that each stage should have at least some tests that are that way</p>



<a name="500301822"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301822" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301822">(Feb 18 2025 at 01:44)</a>:</h4>
<p>Yeah, I think we want a comprehensive library of snapshot tests and they should run through every single ir</p>



<a name="500301825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301825">(Feb 18 2025 at 01:44)</a>:</h4>
<p>and that means we're set up to do them, and can reach for that whenever we want</p>



<a name="500301862"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500301862" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500301862">(Feb 18 2025 at 01:45)</a>:</h4>
<p>100%</p>



<a name="500302200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500302200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500302200">(Feb 18 2025 at 01:48)</a>:</h4>
<p>For the immediate short term, while we figure out what is and isnt in each IR / Env -- I'm hoping we can make a couple of simple hardcoded examples fur the purpose of seeing what the IR actually looks like and how we might use it. </p>
<p>I'm just having trouble piecing everything together and getting familiar with the representations like SoA etc</p>



<a name="500302339"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500302339" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500302339">(Feb 18 2025 at 01:50)</a>:</h4>
<p>Before we have spent much time on implementing things, we might pick up on fundamental design/arch issues, and it's easier to change course now. </p>
<p>Like are we allowing cyclic imports or not... that seems kind of helpful to have a rough plan for now. &lt;-- just an example of a discussion that has spun out of recent efforts to build out the API</p>



<a name="500305558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500305558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500305558">(Feb 18 2025 at 02:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500068995">said</a>:</p>
<blockquote>
<p>yeah, basically the idea is that if you have two nominal tag unions that are mutually recursive, and you also want them to have static dispatch (which could come up when modeling database tables, for example) that's currently impossible</p>
</blockquote>
<p>so I thought about this some more, and I think it's better if we continue to disallow cyclic imports and recommend this workaround if anyone actually needs mutually recursive nominal types with static dispatch:</p>
<ul>
<li>define the two mutually recursive nominal types (let's call them <code>A</code> and <code>B</code>) in the same module, let's call it <code>AandB.roc</code></li>
<li>create separate <code>A.roc</code> and <code>B.roc</code> modules, each of which imports <code>AandB.roc</code> only</li>
<li>both <code>A.roc</code> and <code>B.roc</code> exposes a nominal type which wraps the appropriate mutually recursive type inside <code>AandB.roc</code>, and exposes all the desired methods on those</li>
<li>if the underlying nominal type needs to be exposed too (e.g. because the tags are needed for matching), then <code>A.roc</code> and <code>B.roc</code> can each provide a <code>to_inner</code> function which returns the underlying nominal type from <code>AandB</code>. Static dispatch won't be available on this structure, but that's okay because the wrapper does.</li>
</ul>



<a name="500305827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500305827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500305827">(Feb 18 2025 at 02:24)</a>:</h4>
<p>the tradeoffs of this compared to allowing cyclic imports and doing a warning:</p>
<ul>
<li>it's less ergonomic in the specific case where you want mutually recursive types and static dispatch. Assuming this does come up with database queries, I'm betting it would most often come up with types that are being auto-generated by an external tool anyway, which decreases the downside of the extra module</li>
<li>the rule is easier to understand: "this isn't supported, don't do it"</li>
<li>it significantly simplifies (and speeds up by some small amount) certain parts of the compiler</li>
</ul>



<a name="500306206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306206">(Feb 18 2025 at 02:27)</a>:</h4>
<p>So if you want to be able to call some external <code>use_special_method : a -&gt; Str where a.special_method() -&gt; Str</code> on <code>A</code> or <code>B</code>, you can't?</p>



<a name="500306265"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306265" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306265">(Feb 18 2025 at 02:28)</a>:</h4>
<p>I'm not sure how bad that limitation is</p>



<a name="500306287"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306287" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306287">(Feb 18 2025 at 02:28)</a>:</h4>
<p>Especially for the auto-genned methods like <code>to_str</code> and <code>encode</code></p>



<a name="500306362"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306362" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306362">(Feb 18 2025 at 02:29)</a>:</h4>
<p>I probably should have chosen better names</p>



<a name="500306384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306384">(Feb 18 2025 at 02:29)</a>:</h4>
<p>Yeah, they're tripping me up <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="500306385"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306385" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306385">(Feb 18 2025 at 02:29)</a>:</h4>
<p>let's say <code>A.roc</code> exposes <code>ExternalA</code> and that's a wrapper around <code>InternalA</code> from <code>AandB.roc</code></p>



<a name="500306405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306405">(Feb 18 2025 at 02:29)</a>:</h4>
<p>so <code>InternalA</code> is mutually recursive with <code>InnerB</code></p>



<a name="500306477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306477">(Feb 18 2025 at 02:30)</a>:</h4>
<p><code>InternalA</code> and <code>InternalB</code> are both in <code>AandB.roc</code></p>



<a name="500306495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306495">(Feb 18 2025 at 02:30)</a>:</h4>
<p>and <code>ExternalA</code> wraps <code>InternalA</code> and imports <code>AandB.roc</code> but that's it</p>



<a name="500306524"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306524" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306524">(Feb 18 2025 at 02:30)</a>:</h4>
<p>so you can do static dispatch on <code>ExternalA</code> (which just operates on its wrapped <code>InternalA</code> for you)</p>



<a name="500306543"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306543" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306543">(Feb 18 2025 at 02:31)</a>:</h4>
<p>and then you can call <code>to_inner : ExternalA -&gt; InternalA</code> if you want to pattern match on it</p>



<a name="500306560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306560">(Feb 18 2025 at 02:31)</a>:</h4>
<p>(or maybe some things would make <code>ExternalA</code> opaque and not expose a <code>to_inner</code> - that's fine too)</p>



<a name="500306578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306578">(Feb 18 2025 at 02:31)</a>:</h4>
<p>Yeah, okay, that's a fine limitation</p>



<a name="500306586"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306586" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306586">(Feb 18 2025 at 02:31)</a>:</h4>
<p>so you can't dispatch <em>directly</em> on <code>InnerA</code> but that's fine because you can static dispatch on the <code>ExternalA</code> wrapper around it instead</p>



<a name="500306597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306597">(Feb 18 2025 at 02:31)</a>:</h4>
<p>yeah, it's definitely an ergonomic downside</p>



<a name="500306603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306603">(Feb 18 2025 at 02:32)</a>:</h4>
<p>but you can still do everything</p>



<a name="500306655"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306655" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306655">(Feb 18 2025 at 02:32)</a>:</h4>
<p>As long as its only ergonomics</p>



<a name="500306688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306688">(Feb 18 2025 at 02:32)</a>:</h4>
<p>We force the same tradeoff elsewhere, e.g. unicode stuff</p>



<a name="500306703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306703">(Feb 18 2025 at 02:32)</a>:</h4>
<p>It's good that Roc is opinionated</p>



<a name="500306706"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306706" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306706">(Feb 18 2025 at 02:32)</a>:</h4>
<p>yeah I mean if you have a bunch of these that are all mutually recursive, you could end up with some gigantic <code>QueriesInner.roc</code> or whatever</p>



<a name="500306757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306757">(Feb 18 2025 at 02:33)</a>:</h4>
<p>but what I realized is that if we allow cyclic imports, the compiler still ends up effectively dealing with that file - except it's <em>even more</em> work for the compiler, because first it has to staple together several cyclically imported modules into one gigantic module</p>



<a name="500306844"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306844" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306844">(Feb 18 2025 at 02:34)</a>:</h4>
<p>Roc is a high-level language because we want to do stuff for you automatically you'd do anyway, right?</p>



<a name="500306864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306864">(Feb 18 2025 at 02:34)</a>:</h4>
<p>so on the one hand, arguably the ergonomics are better for the programmer because the modules are smaller, but on the other hand, there's something I do appreciate about like "hey these things are all tangled together into one big chunk" not being hidden from the programmer</p>



<a name="500306874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306874">(Feb 18 2025 at 02:35)</a>:</h4>
<p>So I'm more convinced by the "make it awkward to force better organization" argument</p>



<a name="500306923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306923">(Feb 18 2025 at 02:35)</a>:</h4>
<p>well, it really comes down to whether there are use cases where a ton of mutually recursive types is actually the best way to write the code</p>



<a name="500306992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500306992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500306992">(Feb 18 2025 at 02:36)</a>:</h4>
<p>Do we allow any recursion at all outside of custom unions?</p>



<a name="500307018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307018">(Feb 18 2025 at 02:36)</a>:</h4>
<p>I am somewhat skeptical that those use cases really exist, but I also don't think I've really explored the space of representing the outputs of database queries that involve joins, nested queries, etc. using Roc's type system</p>



<a name="500307026"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307026" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307026">(Feb 18 2025 at 02:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500306992">said</a>:</p>
<blockquote>
<p>Do we allow any recursion at all outside of custom unions?</p>
</blockquote>
<p>not anymore</p>



<a name="500307040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307040">(Feb 18 2025 at 02:36)</a>:</h4>
<p>What about <code>Tree a : [Leaf a, Cons (List (Tree a))]</code></p>



<a name="500307041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307041">(Feb 18 2025 at 02:36)</a>:</h4>
<p>although we do want to allow it within lists</p>



<a name="500307046"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307046" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307046">(Feb 18 2025 at 02:37)</a>:</h4>
<p>yeah we never supported that, but always should have <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="500307054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307054">(Feb 18 2025 at 02:37)</a>:</h4>
<p>lol yep</p>



<a name="500307057"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307057" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307057">(Feb 18 2025 at 02:37)</a>:</h4>
<p>same with sets and dictionaries</p>



<a name="500307061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307061">(Feb 18 2025 at 02:37)</a>:</h4>
<p>Anything list-backed, yep (or Zig-list backed, distinct from written in a Roc-native list)</p>



<a name="500307110"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307110" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307110">(Feb 18 2025 at 02:38)</a>:</h4>
<p>we used to support it in structural tag unions, but decided to stop because of <a href="https://github.com/roc-lang/rfcs/pull/1">https://github.com/roc-lang/rfcs/pull/1</a></p>



<a name="500307290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307290">(Feb 18 2025 at 02:39)</a>:</h4>
<p>So then, I'm gonna finish up the <code>coordinate.zig</code> work I was doing to implement this, but get rid of <code>ModuleSet</code> and move towards sequential module ID assignment for post-cache work. Sound good?</p>



<a name="500307317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307317">(Feb 18 2025 at 02:39)</a>:</h4>
<p>This doesn't feel like we need a big discussion</p>



<a name="500307369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307369">(Feb 18 2025 at 02:40)</a>:</h4>
<p>sounds good!</p>



<a name="500307371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500307371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500307371">(Feb 18 2025 at 02:40)</a>:</h4>
<p>awesome</p>



<a name="500308186"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500308186" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500308186">(Feb 18 2025 at 02:50)</a>:</h4>
<p>I'm really glad we've gone this direction.</p>



<a name="500325448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325448">(Feb 18 2025 at 06:11)</a>:</h4>
<p>I still really think we should support this without requiring custom tags if possible:<br>
<code>Tree a : { data: a, children: List a }</code></p>



<a name="500325505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325505">(Feb 18 2025 at 06:11)</a>:</h4>
<p>Just recursion through list. Cause that covers dict and set as well</p>



<a name="500325508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325508">(Feb 18 2025 at 06:11)</a>:</h4>
<p>That seems to be what we are agreeing on above</p>



<a name="500325521"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325521" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325521">(Feb 18 2025 at 06:11)</a>:</h4>
<p>Oh, you still wrapped it in a tag</p>



<a name="500325570"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325570" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325570">(Feb 18 2025 at 06:12)</a>:</h4>
<p>Oh, good point</p>



<a name="500325576"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325576" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325576">(Feb 18 2025 at 06:12)</a>:</h4>
<p>Hmm</p>



<a name="500325577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325577">(Feb 18 2025 at 06:12)</a>:</h4>
<p>I want it completely tag free</p>



<a name="500325589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325589">(Feb 18 2025 at 06:12)</a>:</h4>
<p>Should be fine</p>



<a name="500325597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325597">(Feb 18 2025 at 06:12)</a>:</h4>
<p>List always breaks recursions.</p>



<a name="500325669"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500325669" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500325669">(Feb 18 2025 at 06:13)</a>:</h4>
<p>Yep</p>



<a name="500414910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500414910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500414910">(Feb 18 2025 at 14:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500293568">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> </p>
<p>Could you please make a single unit test or something that produces a minimal <code>parse.IR</code>. </p>
<p>Like are we at the point we're the IR could represents this?</p>
<div class="codehilite"><pre><span></span><code>module [name]

name = &quot;Luke&quot;
</code></pre></div>
<p>This would be really helpful for working on Can. We're just not sure how to work with the ParseIR rn.</p>
</blockquote>
<p>If you need this right now, I can add parsing a plain module header to my PR</p>



<a name="500414973"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500414973" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500414973">(Feb 18 2025 at 14:32)</a>:</h4>
<p>Everything else should work</p>



<a name="500415138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500415138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500415138">(Feb 18 2025 at 14:32)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> header and statements do exist.  If you get a file, it has this shape:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">header</span><span class="o">:</span><span class="w"> </span><span class="n">HeaderIdx</span><span class="p">,</span>
<span class="w">        </span><span class="n">statements</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kr">const</span><span class="w"> </span><span class="n">StatementIdx</span><span class="p">,</span>
<span class="w">        </span><span class="n">region</span><span class="o">:</span><span class="w"> </span><span class="n">Region</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
</code></pre></div>



<a name="500415179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500415179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500415179">(Feb 18 2025 at 14:33)</a>:</h4>
<p>You just need to run <code>ast.store.getFile()</code> to get it</p>



<a name="500415515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500415515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500415515">(Feb 18 2025 at 14:34)</a>:</h4>
<p>Another passing note, I am at the point where I want to start lazily creating the Parse IR display format, because I think it'll be useful for debugging for me</p>



<a name="500416625"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500416625" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500416625">(Feb 18 2025 at 14:39)</a>:</h4>
<p>So I get:</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="nv">file</span><span class="w"> </span><span class="p">(</span><span class="nv">app</span><span class="w"> </span><span class="p">(</span><span class="nv">main!</span><span class="p">)</span><span class="w"> </span><span class="s">"pf"</span><span class="w"> </span><span class="s">".../platform.roc"</span><span class="w"> </span><span class="p">())</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="nb">import</span><span class="w"> </span><span class="s">"Stdout"</span><span class="w"> </span><span class="s">"pf"</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">decl</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"main!"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="p">(</span><span class="nv">expr</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"line!"</span><span class="w"> </span><span class="s">"Stdout"</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="nb">string</span><span class="w"> </span><span class="s">"Hello, world!"</span><span class="p">)))))))</span>
</code></pre></div>
<p>Maybe with the region as a <code>(START END)</code> sexpr after the tag.</p>



<a name="500479571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500479571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500479571">(Feb 18 2025 at 18:00)</a>:</h4>
<p><span class="user-mention" data-user-id="781658">@Anthony Bullard</span> We were discussing this in <a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/with/499994188">#compiler development &gt; zig compiler - IR serde</a> . The relevant part of that topic is that all IRs would have a way to get turned into S-expression nodes, which then would be serializable to string. Similarly (but less relevant to you), we would have 1 S-expression parser that would take in a string and turn that into a node, which then could be translated into any of the IR-s. That way the pretty printing and parsing could be in 1 place.</p>



<a name="500492087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500492087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500492087">(Feb 18 2025 at 19:10)</a>:</h4>
<p>Okay, we can start running with that for canonicalization. The remaining thing is alignment of <code>Region</code> structs. Maybe we can just use the <code>parse.IR.Region</code> (<a href="https://github.com/roc-lang/roc/blob/26f9416929aa0cd52ca732fc533b4a94a690de04/src/check/parse/IR.zig#L28">source</a>) everywhere and expect that to update when necessary? <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> would you think that a bad idea?</p>



<a name="500510659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510659">(Feb 18 2025 at 21:06)</a>:</h4>
<p>I think it's actually worth trying to use a parser node id as a region</p>



<a name="500510683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510683">(Feb 18 2025 at 21:06)</a>:</h4>
<p>That's a single u32, which is nice</p>



<a name="500510727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510727">(Feb 18 2025 at 21:06)</a>:</h4>
<p>What if a region is for a function body?</p>



<a name="500510766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510766">(Feb 18 2025 at 21:06)</a>:</h4>
<p>Then use the node that corresponds specifically to the body :)</p>



<a name="500510776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510776">(Feb 18 2025 at 21:07)</a>:</h4>
<p>Okay, yeah</p>



<a name="500510793"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510793" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510793">(Feb 18 2025 at 21:07)</a>:</h4>
<p>I think that could work</p>



<a name="500510879"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510879" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510879">(Feb 18 2025 at 21:07)</a>:</h4>
<p>All we'd need to do is ensure that all diagnostics we'd want to show would be traceable to such a parser node</p>



<a name="500510970"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500510970" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500510970">(Feb 18 2025 at 21:08)</a>:</h4>
<p>But for the same source code and the same Roc compiler version, that's free</p>



<a name="500511185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500511185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500511185">(Feb 18 2025 at 21:09)</a>:</h4>
<p>I'd love to make an alias so that we aren't just passing around <code>Parser.NodeStore.Idx</code> or whatever the actual thing is called</p>



<a name="500511199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500511199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500511199">(Feb 18 2025 at 21:09)</a>:</h4>
<p>Not sure what to call it</p>



<a name="500511381"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500511381" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500511381">(Feb 18 2025 at 21:10)</a>:</h4>
<p>maybe</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ParseRegion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">node_id</span><span class="o">:</span><span class="w"> </span><span class="n">Parser</span><span class="p">.</span><span class="n">NodeStore</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div>



<a name="500517104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500517104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500517104">(Feb 18 2025 at 21:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500510659">said</a>:</p>
<blockquote>
<p>I think it's actually worth trying to use a parser node id as a region</p>
</blockquote>
<p>Then for caching, we have to serialize both the parse and can ir?</p>



<a name="500517785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500517785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500517785">(Feb 18 2025 at 21:54)</a>:</h4>
<p>My thinking is to not write that out, but rather re-generate it on demand if we ever need to emit errors for that file.</p>



<a name="500517902"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500517902" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500517902">(Feb 18 2025 at 21:55)</a>:</h4>
<p>(I'm a little unsure of what this means about things like debug info, where resolving line:col info is in the hot path)</p>



<a name="500518032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500518032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500518032">(Feb 18 2025 at 21:56)</a>:</h4>
<p>I kinda want to say we should not emit traditional debug info unless asked, and by default we should have some faster-to-generate thing.</p>



<a name="500519525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500519525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500519525">(Feb 18 2025 at 22:04)</a>:</h4>
<p>I think it is reasonable to say that optimized llvm builds (which likely will be the default llvm builds) don't emit debug info or emit very limited debug info.</p>



<a name="500519709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500519709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500519709">(Feb 18 2025 at 22:05)</a>:</h4>
<p>yeah the interpreter seems like it would reduce demand for debuginfo a lot</p>



<a name="500519710"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500519710" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500519710">(Feb 18 2025 at 22:05)</a>:</h4>
<p>Of course need to be able to opt in for llvm optimized builds with full debug info</p>



<a name="500519792"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500519792" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500519792">(Feb 18 2025 at 22:06)</a>:</h4>
<p>eventually yeah, but not a hard requirement for 0.1.0 I don't think</p>



<a name="500519800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500519800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500519800">(Feb 18 2025 at 22:06)</a>:</h4>
<p>And I think dev llvm builds should have full debug info (but the interpreter will make those rarer)</p>



<a name="500519921"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500519921" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500519921">(Feb 18 2025 at 22:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500519792">said</a>:</p>
<blockquote>
<p>eventually yeah, but not a hard requirement for 0.1.0 I don't think</p>
</blockquote>
<p>It think I might try to add in full debug info on first build of the llvm backend. I think it is the kind of work that can be painful to add later.</p>



<a name="500519952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500519952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500519952">(Feb 18 2025 at 22:07)</a>:</h4>
<p>awesome!</p>



<a name="500523276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500523276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500523276">(Feb 18 2025 at 22:32)</a>:</h4>
<p>Sorry, why a single parser/writer for all IR display formats?  I don't know how well those will work together....</p>



<a name="500523291"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500523291" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500523291">(Feb 18 2025 at 22:33)</a>:</h4>
<p>But I'm happy to see it if it does!</p>



<a name="500525179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500525179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500525179">(Feb 18 2025 at 22:49)</a>:</h4>
<p>My (perhaps unfounded) assumption is that there will be some useful commonality to extract there, but I could be wrong.</p>



<a name="500525364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500525364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500525364">(Feb 18 2025 at 22:50)</a>:</h4>
<p>In particular I was thinking about things like pretty-printing the s-expr, which if you want to have a reasonably dense format that doesn't take up a bunch of vertical space, is non-trivial</p>



<a name="500525455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500525455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500525455">(Feb 18 2025 at 22:51)</a>:</h4>
<p>I'm ambivalent as to whether that takes the form of a bunch of utilities that are used adhoc by different IRs, or a system where you convert the IR to/from some s-expr nodes which are then processed</p>



<a name="500539139"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500539139" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500539139">(Feb 19 2025 at 00:49)</a>:</h4>
<p>I've made a zig library to help parse and generate S-expression. Just wanted to let people know that I've started on this. Haven't wired it up with any of our actual IR's yet.</p>
<p><span class="user-mention" data-user-id="577599">@Norbert Hajagos</span> and I will polish it later today and I'll make a PR to share it.</p>



<a name="500539334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/500539334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#500539334">(Feb 19 2025 at 00:51)</a>:</h4>
<p>Here's a snippet of what I've got so far</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">/// Represents a token in an S-expression.</span>
<span class="c1">///</span>
<span class="c1">/// This type is comptime generic over two types: `T` for identifiers and `V` for values.</span>
<span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">Token</span><span class="p">(</span><span class="kr">comptime</span><span class="w"> </span><span class="n">T</span><span class="o">:</span><span class="w"> </span><span class="kt">type</span><span class="p">,</span><span class="w"> </span><span class="kr">comptime</span><span class="w"> </span><span class="n">V</span><span class="o">:</span><span class="w"> </span><span class="kt">type</span><span class="p">)</span><span class="w"> </span><span class="kt">type</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">union</span><span class="p">(</span><span class="k">enum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ident</span><span class="o">:</span><span class="w"> </span><span class="n">T</span><span class="p">,</span>
<span class="w">        </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="n">V</span><span class="p">,</span>
<span class="w">        </span><span class="n">lparen</span><span class="p">,</span>
<span class="w">        </span><span class="n">rparen</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</code></pre></div>



<a name="501312565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501312565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501312565">(Feb 22 2025 at 23:32)</a>:</h4>
<p>Do we want to use an arg parsing library for the CLI or roll it ourselves? I remember hearing talk of wanting to use very few third party libraries.</p>



<a name="501312958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501312958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501312958">(Feb 22 2025 at 23:38)</a>:</h4>
<p>roll it ourselves!</p>



<a name="501312991"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501312991" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501312991">(Feb 22 2025 at 23:39)</a>:</h4>
<p>as I believe <span class="user-mention" data-user-id="406911">@Andrew Kelley</span> has said, "just write a parser for cli args"</p>



<a name="501313228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501313228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501313228">(Feb 22 2025 at 23:43)</a>:</h4>
<p>We currently have one I wrote that is super simple</p>



<a name="501313259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501313259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501313259">(Feb 22 2025 at 23:43)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/7fc2a08e2811fed7207ab5035f680bbf697d232f/src/cli.zig#L54">https://github.com/roc-lang/roc/blob/7fc2a08e2811fed7207ab5035f680bbf697d232f/src/cli.zig#L54</a></p>



<a name="501313343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501313343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501313343">(Feb 22 2025 at 23:44)</a>:</h4>
<p>Probably could do with some love though</p>



<a name="501314206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501314206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501314206">(Feb 22 2025 at 23:59)</a>:</h4>
<p>Okay sweet. I'm going to take a look at wiring up the formatter in the CLI and wanted to confirm the approach</p>



<a name="501415249"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501415249" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501415249">(Feb 23 2025 at 22:16)</a>:</h4>
<p>Thank you Isaac!  I'd love to get that so I can start writing files straight-up and running the formatter on it</p>



<a name="501415403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501415403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501415403">(Feb 23 2025 at 22:18)</a>:</h4>
<p>Some string tokenizing + parsing updates: <a href="https://github.com/roc-lang/roc/pull/7632">https://github.com/roc-lang/roc/pull/7632</a></p>



<a name="501416808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501416808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501416808">(Feb 23 2025 at 22:38)</a>:</h4>
<p>Type Annotation and Declaration parsing and formatting: <a href="https://github.com/roc-lang/roc/pull/7633">https://github.com/roc-lang/roc/pull/7633</a></p>



<a name="501431208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501431208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501431208">(Feb 24 2025 at 02:00)</a>:</h4>
<p>I got most of <code>Type.Store</code> (new <code>Subs</code>) working today. I’m gonna work on unifying primitives tomorrow!</p>



<a name="501597326"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501597326" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501597326">(Feb 24 2025 at 16:55)</a>:</h4>
<p>haven't disappeared, have been reading almost every message. just letting people cook, lots of chefs already :D</p>



<a name="501598628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501598628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501598628">(Feb 24 2025 at 17:01)</a>:</h4>
<p>honestly, the speed at which this is moving needs to be studied, extremely impressive. ya'll are making what seems like a gargantuan effort look like a weekend project</p>



<a name="501599250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501599250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501599250">(Feb 24 2025 at 17:03)</a>:</h4>
<p>Definitely moving well, but still tons to do. That said, I do agree that it might be hard to fully parallelize to more folks right now. Mostly things at the top of the stack are moving right now.</p>



<a name="501599438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/501599438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#501599438">(Feb 24 2025 at 17:04)</a>:</h4>
<p>yea it's all good, I'll sneak something in eventually, I'm not here for personal glory :D</p>



<a name="502239799"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502239799" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502239799">(Feb 27 2025 at 09:51)</a>:</h4>
<p>I'm trying to update my SExpr PR so I can land what I have, and am running into some issues with memory leaks/issues in the formatting tests.</p>
<p>One somewhat related question... should the SafeMultiList hold onto the allocator? why do we do that?</p>
<div class="codehilite"><pre><span></span><code>pub fn SafeMultiList(comptime T: type) type {
    return struct {
        items: std.MultiArrayList(T),
        allocator: std.mem.Allocator,
</code></pre></div>



<a name="502240012"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502240012" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502240012">(Feb 27 2025 at 09:52)</a>:</h4>
<p>I'm looking at this error trace from a test and it points to the <code>store.nodes.deinit()</code> as the source of the problem.</p>
<div class="codehilite"><pre><span></span><code>thread 415308 panic: integer overflow
/opt/homebrew/Cellar/zig/0.13.0/lib/zig/std/multi_array_list.zig:540:31: 0x103032c37 in capacityInBytes (test)
            return elem_bytes * capacity;
                              ^
/opt/homebrew/Cellar/zig/0.13.0/lib/zig/std/multi_array_list.zig:544:49: 0x103032c7b in allocatedBytes (test)
            return self.bytes[0..capacityInBytes(self.capacity)];
                                                ^
/opt/homebrew/Cellar/zig/0.13.0/lib/zig/std/multi_array_list.zig:177:41: 0x10303122f in deinit (test)
            gpa.free(self.allocatedBytes());
                                        ^
/Users/luke/Documents/GitHub/roc/src/collections/safe_list.zig:132:30: 0x102ff531b in deinit (test)
            self.items.deinit(self.allocator);
                             ^
/Users/luke/Documents/GitHub/roc/src/check/parse/IR.zig:475:27: 0x102fa3ea3 in deinit (test)
        store.nodes.deinit();
</code></pre></div>



<a name="502240166"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502240166" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502240166">(Feb 27 2025 at 09:53)</a>:</h4>
<p>My suspicion is that maybe we are passing it a different allocator somehow... and so it's trying to free memory that isn't there or something.</p>



<a name="502240468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502240468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502240468">(Feb 27 2025 at 09:55)</a>:</h4>
<p>If anyone would like to take a look I pushed a commit for the above error <a href="https://github.com/roc-lang/roc/pull/7629/commits/6f641a7ee9a3e1c850643c44ef988774b62babc6">https://github.com/roc-lang/roc/pull/7629/commits/6f641a7ee9a3e1c850643c44ef988774b62babc6</a></p>



<a name="502352466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502352466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502352466">(Feb 27 2025 at 18:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/502240166">said</a>:</p>
<blockquote>
<p>My suspicion is that maybe we are passing it a different allocator somehow... and so it's trying to free memory that isn't there or something.</p>
</blockquote>
<p>The error is an overflow when calculating the capacity. That should be before any sort of allocator interactions. Probably would be good to print out the capacity and element size in bytes before that call to see what they are.</p>



<a name="502352634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502352634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502352634">(Feb 27 2025 at 18:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/502239799">said</a>:</p>
<blockquote>
<p>One somewhat related question... should the SafeMultiList hold onto the allocator? why do we do that?</p>
<p><div class="codehilite"><pre><span></span><code>pub fn SafeMultiList(comptime T: type) type {
    return struct {
        items: std.MultiArrayList(T),
        allocator: std.mem.Allocator,
</code></pre></div><br>
</p>
</blockquote>
<p>MultiArrayList stores the allocator, so we should not need to.</p>



<a name="502352973"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502352973" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502352973">(Feb 27 2025 at 18:39)</a>:</h4>
<p>One possibility is that we deallocate out of order and that leads to reading a garbage capacity from freed memory. That or the equivalent but via a stack allocation</p>



<a name="502353258"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502353258" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502353258">(Feb 27 2025 at 18:40)</a>:</h4>
<p>I should be able to pull this later today and take a deeper look</p>



<a name="502429906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502429906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502429906">(Feb 27 2025 at 22:21)</a>:</h4>
<p>If you could that would be helpful. I'm very lost staring at these errors in the zig stdlib</p>



<a name="502431591"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502431591" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502431591">(Feb 27 2025 at 22:22)</a>:</h4>
<p>I feel like building the SExpr I'm bumping into issues that we're not aware of just because I'm wiring things up for the first time.</p>



<a name="502480293"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502480293" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502480293">(Feb 28 2025 at 02:27)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> I think I have everything you need in PR comments</p>



<a name="502683664"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502683664" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502683664">(Feb 28 2025 at 23:21)</a>:</h4>
<p><a href="https://www.youtube.com/watch?v=wmOc4GLq8xM">me trying to resist making SExpr-based jokes in this channel</a></p>
<div class="youtube-video message_inline_image"><a data-id="wmOc4GLq8xM" href="https://www.youtube.com/watch?v=wmOc4GLq8xM"><img src="https://uploads.zulipusercontent.net/0b25165df935d25b6a900890552eb193d995f7c6/68747470733a2f2f692e7974696d672e636f6d2f76692f776d4f6334474c7138784d2f64656661756c742e6a7067"></a></div>



<a name="502683888"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502683888" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502683888">(Feb 28 2025 at 23:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/502240012">said</a>:</p>
<blockquote>
<p>I'm looking at this error trace from a test and it points to the <code>store.nodes.deinit()</code> as the source of the problem.</p>
<p><div class="codehilite"><pre><span></span><code>thread 415308 panic: integer overflow
/opt/homebrew/Cellar/zig/0.13.0/lib/zig/std/multi_array_list.zig:540:31: 0x103032c37 in capacityInBytes (test)
            return elem_bytes * capacity;
                              ^
</code></pre></div><br>
</p>
</blockquote>
<p>If this happens in debug mode, it's often because one of the operands is undefined. In zig, when you assign something to undefined (for example by freeing memory), the bytes are memset to <code>0xaa</code>. This has some nice properties, including the fact that if you multiply by an integer even as small as <code>2</code> you get overflow.</p>



<a name="502684072"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502684072" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502684072">(Feb 28 2025 at 23:25)</a>:</h4>
<p>in other words, I would expect that stack trace if you called safe_list deinit() twice</p>



<a name="502684313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502684313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502684313">(Feb 28 2025 at 23:27)</a>:</h4>
<p>fear not, for this is <strong>checked illegal behavior</strong>, which is deterministic and straightforward to debug</p>



<a name="502686329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502686329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502686329">(Feb 28 2025 at 23:49)</a>:</h4>
<p>Yeah, was great for catching the double free. Just not the clearest error message</p>



<a name="502695857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502695857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502695857">(Mar 01 2025 at 01:33)</a>:</h4>
<p>What are general thoughts on always using <code>Unmanaged</code> datastructures?</p>
<p>Unmanaged just means that they do not store a pointer to an allocator. Instead the allocator must be passed in on for all functions that might allocate/deallocate.</p>
<hr>
<p>Fundamentally, I don't think it is a big change. Just a minor api change. It likely isn't too important of a change, but avoids storing lots of extra copies of pointers to the allocator. Instead we just store one copy of the pointer to the allocator and pass it down the stack.</p>
<p>Seems to fit nicely with how we are designing datastructures.</p>



<a name="502862283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502862283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502862283">(Mar 02 2025 at 13:45)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> I think I've got all the <code>coordinate</code> code set up in this PR, more or less: <a href="https://github.com/roc-lang/roc/pull/7625">https://github.com/roc-lang/roc/pull/7625</a></p>
<p>question for you on code structure: I was trying to figure out how best to pass around ownership of the different stage IRs and I realized that they are all in (Multi)ArrayLists anyway, so I changed from having each IR get <code>init</code>ed and returned to each IR being created in a MultiArrayList as <code>undefined</code> and then their <code>init</code> functions get a pointer to that <code>undefined</code> IR that they init in-place (<a href="https://github.com/smores56/roc/blob/4dc1405e1c338f2bb6d6639bfe5e80aa7c123060/src/base/module_work.zig#L70">source</a> and <a href="https://github.com/smores56/roc/blob/4dc1405e1c338f2bb6d6639bfe5e80aa7c123060/src/check/canonicalize/IR.zig#L42">source</a>). This seemed like a simple way to keep the reference depth to one, but maybe there's a better pattern. What do you think about this strategy? Am I not explaining this well enough?</p>



<a name="502886527"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502886527" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502886527">(Mar 02 2025 at 18:24)</a>:</h4>
<p>I'm not sure I quite follow. What is the advantage of </p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="n">items</span><span class="p">.</span><span class="n">appendAssumeCapacity</span><span class="p">(.{</span>
<span class="w">    </span><span class="p">.</span><span class="n">package_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">can_irs</span><span class="p">.</span><span class="n">getPackageIdx</span><span class="p">(</span><span class="n">work_idx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">module_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">can_irs</span><span class="p">.</span><span class="n">getModuleIdx</span><span class="p">(</span><span class="n">work_idx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="p">});</span>

<span class="n">init_work_with_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">items</span><span class="p">.</span><span class="n">items</span><span class="p">(.</span><span class="n">work</span><span class="p">)[</span><span class="n">index</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">can_irs</span><span class="p">.</span><span class="n">getWork</span><span class="p">(</span><span class="n">work_idx</span><span class="p">).</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span><span class="p">);</span>
</code></pre></div>
<p>over (or whatever the equivalent would be):</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="n">items</span><span class="p">.</span><span class="n">appendAssumeCapacity</span><span class="p">(.{</span>
<span class="w">    </span><span class="p">.</span><span class="n">package_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">can_irs</span><span class="p">.</span><span class="n">getPackageIdx</span><span class="p">(</span><span class="n">work_idx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">module_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">can_irs</span><span class="p">.</span><span class="n">getModuleIdx</span><span class="p">(</span><span class="n">work_idx</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">work</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Work</span><span class="p">.</span><span class="n">init_with_env</span><span class="p">(</span><span class="o">&amp;</span><span class="n">can_irs</span><span class="p">.</span><span class="n">getWork</span><span class="p">(</span><span class="n">work_idx</span><span class="p">).</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">gpa</span><span class="p">),</span>
<span class="p">});</span>
</code></pre></div>



<a name="502890872"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502890872" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502890872">(Mar 02 2025 at 19:12)</a>:</h4>
<p>Because the second one is pass by value, so more copying is happening</p>



<a name="502894881"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502894881" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502894881">(Mar 02 2025 at 19:59)</a>:</h4>
<p>Your talking about the returned value from <code>Work.init_with_env</code> which is being placed into the larger struct as the <code>.work</code> field?</p>



<a name="502895099"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502895099" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502895099">(Mar 02 2025 at 20:01)</a>:</h4>
<p>Yes</p>



<a name="502895170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502895170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502895170">(Mar 02 2025 at 20:02)</a>:</h4>
<p>Not sure if that's a big cost, or if LLVM will optimize that away</p>



<a name="502895243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502895243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502895243">(Mar 02 2025 at 20:03)</a>:</h4>
<p>I wouldn't worry about that. Should be optimized away by llvm. Also, should not be anywhere near the hot path.</p>



<a name="502895274"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502895274" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502895274">(Mar 02 2025 at 20:04)</a>:</h4>
<p>large returned structs by default are turned into pointer args</p>



<a name="502895325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/502895325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#502895325">(Mar 02 2025 at 20:04)</a>:</h4>
<p>Great, that was the most underlying question</p>



<a name="503475023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503475023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503475023">(Mar 05 2025 at 10:30)</a>:</h4>
<p>Question re <a href="https://github.com/roc-lang/roc/pull/7664#discussion_r1980864364">https://github.com/roc-lang/roc/pull/7664#discussion_r1980864364</a> <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> and <span class="user-mention" data-user-id="453336">@Joshua Warner</span> </p>
<p>I was wanting to clarify, should I be slicing into the source bytes or getting this information from the interner? </p>
<p>Is the plan for the untagged union to go away eventually and everything will be interned?</p>



<a name="503496731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503496731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503496731">(Mar 05 2025 at 12:16)</a>:</h4>
<p>I haven't really paid attention to the interning progress we've made, I know that I'm using IR.resolve in the formatter</p>



<a name="503559146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503559146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503559146">(Mar 05 2025 at 16:03)</a>:</h4>
<p>The untagged union won’t go away - eg for things that we definitely don’t need to intern (braces, symbols, etc)</p>



<a name="503559391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503559391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503559391">(Mar 05 2025 at 16:03)</a>:</h4>
<p>My intent is that strings/number/etc will all be interned</p>



<a name="503677128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503677128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503677128">(Mar 06 2025 at 02:18)</a>:</h4>
<p>I assume if we have any sort of parse errors, we should not format the ast, right? We should print the parse errors and early exit.</p>



<a name="503677990"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503677990" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503677990">(Mar 06 2025 at 02:27)</a>:</h4>
<p>I thought the plan was to do a best effort, and generate a compiler error.</p>



<a name="503678057"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503678057" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503678057">(Mar 06 2025 at 02:28)</a>:</h4>
<p>Are you specifically talking about the cli formatter?</p>



<a name="503680497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503680497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503680497">(Mar 06 2025 at 02:54)</a>:</h4>
<p>Yeah, cli specifically</p>



<a name="503680522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503680522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503680522">(Mar 06 2025 at 02:54)</a>:</h4>
<p>Ahk, that makes sense then.</p>



<a name="503680587"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503680587" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503680587">(Mar 06 2025 at 02:55)</a>:</h4>
<p>The only thing I can think of is maybe there is something like an LSP that would want different behaviour. But that's a different tool.</p>



<a name="503699951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503699951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503699951">(Mar 06 2025 at 05:31)</a>:</h4>
<p>Eventually I want the formatter to format everything _but_ the part of the input that has the error (e.g. maybe the nearest outer statement/decl) - and then copy the source text from the input verbatum, for the section with the error - the only possible difference being indenting or dedenting the entire block of text, if appropriate.</p>



<a name="503700011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503700011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503700011">(Mar 06 2025 at 05:31)</a>:</h4>
<p>... but for now I think we should just make the formatter bail out on parser OR tokenizer errors.</p>



<a name="503707110"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503707110" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503707110">(Mar 06 2025 at 06:16)</a>:</h4>
<p>That makes sense and will be cool when it works</p>



<a name="503756563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503756563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503756563">(Mar 06 2025 at 10:30)</a>:</h4>
<p>I think we need to keep the source input around throughout all sources that can report errors in the source</p>



<a name="503840914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/503840914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#503840914">(Mar 06 2025 at 16:43)</a>:</h4>
<p>At some point we could manifest the errors if we need to.</p>



<a name="504321163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504321163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504321163">(Mar 08 2025 at 21:50)</a>:</h4>
<p>Note to all, on latest main, the zig version is now 0.14.0</p>
<p>If you have an issue compiling after updating zig, you may need to delete some caches (<code>.zig-cache</code> and/or <code>~/.cache/zig/</code>, maybe also <code>zig-out</code>).</p>



<a name="504331157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504331157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504331157">(Mar 09 2025 at 00:08)</a>:</h4>
<p>Missed this on my first read of the zig updates, but zig plans to make the <code>Unmanaged</code> containers their default contianers. So in zig <code>0.15.0</code> <code>std.ArrayList</code> will be what was previously <code>std.ArrayListUnmanaged</code>. So I guess switching over to the unmanaged veriants makes even more sense.<br>
<a href="https://ziglang.org/download/0.14.0/release-notes.html#toc-Embracing-Unmanaged-Style-Containers">Embracing "Unmanaged"-Style Containers</a></p>



<a name="504360089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504360089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504360089">(Mar 09 2025 at 06:30)</a>:</h4>
<p>Just wanted to highlight something with our Parser diagnostics. See <a href="https://github.com/roc-lang/roc/pull/7672#discussion_r1986224249">https://github.com/roc-lang/roc/pull/7672#discussion_r1986224249</a> </p>
<p>I'm thinking we probably want the Parser problems to be pushed into the ModuleEnv so they outlive the parsing stage of the compiler, and later stages that see a malformed node can still reference those errors. </p>
<p>What do people think?</p>



<a name="504360246"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504360246" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504360246">(Mar 09 2025 at 06:33)</a>:</h4>
<p>That was always the plan in my eyes, but I do remember the Problem.Parse variant being removed by someone else</p>



<a name="504360286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504360286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504360286">(Mar 09 2025 at 06:33)</a>:</h4>
<p>So there may be a reason I don't know about why we don't want them in ModuleEnv</p>



<a name="504360328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504360328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504360328">(Mar 09 2025 at 06:34)</a>:</h4>
<p>But I don't know it</p>



<a name="504360346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504360346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504360346">(Mar 09 2025 at 06:34)</a>:</h4>
<p>Yeah, I suspect we just haven't ever got that far before. Now we've got more of the coordinate and other stages set up a bit, we can find and sort out these things.</p>



<a name="504360469"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504360469" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504360469">(Mar 09 2025 at 06:36)</a>:</h4>
<p>Sounds good to me. Avoids manually managing the lifetime</p>



<a name="504368080"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504368080" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504368080">(Mar 09 2025 at 08:23)</a>:</h4>
<p>I'm happy to attempt this change. Though I'll wait for when <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> is next online as he may have ideas or want to work on this.</p>



<a name="504447888"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504447888" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504447888">(Mar 10 2025 at 00:34)</a>:</h4>
<p>Where did we land on <code>||</code> -- is that meant to be parsed as an <code>or</code> or are we only accepting keyword?</p>



<a name="504447917"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504447917" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504447917">(Mar 10 2025 at 00:35)</a>:</h4>
<p>I'm just working on an ambiguous fuzz failure and this is the current problem.</p>



<a name="504448778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504448778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504448778">(Mar 10 2025 at 00:46)</a>:</h4>
<p>I'm pretty sure both <code>||</code> and <code>&amp;&amp;</code> should parse and then format to <code>or</code> and <code>and</code></p>



<a name="504448830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504448830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504448830">(Mar 10 2025 at 00:47)</a>:</h4>
<p>This is the fuzz issue</p>
<div class="codehilite"><pre><span></span><code>~~~META
description=fuzz crash
~~~SOURCE
||1
</code></pre></div>



<a name="504448894"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504448894" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504448894">(Mar 10 2025 at 00:48)</a>:</h4>
<p>That parses the first time as a lambda, then formats as <code>||</code> (without the space) then the second time around it parses as an <code>or</code></p>



<a name="504449330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504449330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504449330">(Mar 10 2025 at 00:53)</a>:</h4>
<p>Here's the latest snapshot output for that... including the tokens</p>
<div class="codehilite"><pre><span></span><code>~~~META
description=fuzz crash
~~~SOURCE
||1
~~~FORMATTED
|| 1
~~~TOKENS
OpBar,OpBar,Int,EndOfFile
~~~PARSE
(file
    (malformed &#39;missing_header&#39;)
    (lambda
        (args)
        (int &#39;1&#39;)))
</code></pre></div>



<a name="504449449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504449449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504449449">(Mar 10 2025 at 00:54)</a>:</h4>
<p>One "fix" I found that works, was to format the lambda with no args with a space, e.g. <code>| |</code></p>



<a name="504449494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504449494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504449494">(Mar 10 2025 at 00:54)</a>:</h4>
<p>ah yeah, there is ambiguity now. Not sure the plan on that</p>



<a name="504449554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504449554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504449554">(Mar 10 2025 at 00:55)</a>:</h4>
<p>Would it look terrible if it formatted as <code>|_|</code>?</p>



<a name="504449635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504449635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504449635">(Mar 10 2025 at 00:56)</a>:</h4>
<p>I think that would suggest an ignored arg</p>



<a name="504449711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504449711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504449711">(Mar 10 2025 at 00:57)</a>:</h4>
<p>For the sake of moving past this crash, I think I'll format using a space for now. It's a hack but we can come back to it.</p>



<a name="504453049"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504453049" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504453049">(Mar 10 2025 at 01:33)</a>:</h4>
<p>so the idea we settled on was that:</p>
<ul>
<li>officially, we only support <code>or</code> and <code>and</code></li>
<li>as a matter of convenience, we always have the formatter rewrite <code>&amp;&amp;</code> to <code>and</code>, and in the situations where you wrote <code>||</code> and it can unambiguously detect that <code>or</code> would have worked (but 0-arg lambda would not), then it can also rewrite that to <code>or</code> for you. But there was at least one situation where either could work, and so in those situations we have to assume you meant lambda (which is why we have to go with <code>or</code> as the keyword)</li>
</ul>



<a name="504453179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504453179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504453179">(Mar 10 2025 at 01:35)</a>:</h4>
<p>Ok, that makes sense</p>



<a name="504579627"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504579627" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504579627">(Mar 10 2025 at 13:22)</a>:</h4>
<p>We are _not_ parsing <code>||</code> or <code>&amp;&amp;</code> any longer. With the 0.1.0-line compiler we are hard moving to <code>or</code> and <code>and</code></p>



<a name="504580192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504580192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504580192">(Mar 10 2025 at 13:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/504453049">said</a>:</p>
<blockquote>
<ul>
<li>as a matter of convenience, we always have the formatter rewrite <code>&amp;&amp;</code> to <code>and</code>, and in the situations where you wrote <code>||</code> and it can unambiguously detect that <code>or</code> would have worked (but 0-arg lambda would not), then it can also rewrite that to <code>or</code> for you. But there was at least one situation where either could work, and so in those situations we have to assume you meant lambda (which is why we have to go with <code>or</code> as the keyword)</li>
</ul>
</blockquote>
<p>We can work to do this eventually, but I'm not going to focus on this now.</p>
<p>My biggest concern is landing my current PR, then finishing all header parsing, then figuring out and implementing <code>where ...</code> in type annotations, and then making malformed work well (the current situation has a number of issues)</p>



<a name="504630042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504630042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504630042">(Mar 10 2025 at 16:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/504579627">said</a>:</p>
<blockquote>
<p>We are _not_ parsing <code>||</code> or <code>&amp;&amp;</code> any longer. With the 0.1.0-line compiler we are hard moving to <code>or</code> and <code>and</code></p>
</blockquote>
<p>I don't think this is correct. I think the tokenizer unifies them.</p>



<a name="504630218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504630218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504630218">(Mar 10 2025 at 16:10)</a>:</h4>
<p>So we likely need to delete support from the tokenizer if this is what we want.</p>



<a name="504688647"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/504688647" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#504688647">(Mar 10 2025 at 21:13)</a>:</h4>
<p>If that is the case, then yes the tokenizer needs an update</p>



<a name="505313150"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505313150" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505313150">(Mar 13 2025 at 04:06)</a>:</h4>
<p>I think || at least needs to be given its own special token (not unified with <code>or</code> at that level)</p>



<a name="505313236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505313236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505313236">(Mar 13 2025 at 04:07)</a>:</h4>
<p>We need context from the parser in order to distinguish cases where || would me <code>or</code> from uses as a no-args closure</p>



<a name="505320233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505320233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505320233">(Mar 13 2025 at 05:07)</a>:</h4>
<p>Parser could match on double single bar instead of doing it in the tokenizer.</p>



<a name="505320251"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505320251" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505320251">(Mar 13 2025 at 05:07)</a>:</h4>
<p>Though not sure the tradeoffs there</p>



<a name="505320366"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505320366" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505320366">(Mar 13 2025 at 05:08)</a>:</h4>
<p>Like if in an expression where it could see <code>and</code> or <code>or</code>, if the parser sees two ampersand or two bar tokens, it could consider them and/or</p>



<a name="505444379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505444379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505444379">(Mar 13 2025 at 14:53)</a>:</h4>
<p>I don’t want two bars with white space in between to ever accidentally be treated as an  pipe || or. So I think this definitely needs some kind of token representation that’s unique from that.</p>



<a name="505450755"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505450755" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505450755">(Mar 13 2025 at 15:16)</a>:</h4>
<p>I see. Yeah, forgot about whitespace</p>



<a name="505482923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505482923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505482923">(Mar 13 2025 at 17:25)</a>:</h4>
<p>Interesting reply to our roc post on switching to zig. Specifically about compile times: <br>
<a href="https://x.com/zack_overflow/status/1899953945990357081?t=oaGhkuoKLPnMyAsvl_zUxg&amp;s=19">https://x.com/zack_overflow/status/1899953945990357081?t=oaGhkuoKLPnMyAsvl_zUxg&amp;s=19</a></p>



<a name="505520784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505520784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505520784">(Mar 13 2025 at 20:37)</a>:</h4>
<p>I agree with <a href="https://x.com/bhansconnect/status/1900237824122905077">your reply</a> <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="505520999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505520999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505520999">(Mar 13 2025 at 20:38)</a>:</h4>
<p>I'll happily take "massive feedback loop improvements for large code bases are mid-development but haven't landed yet" over "there are no plans for massive feedback loop improvements at any point in the future"</p>



<a name="505523765"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505523765" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505523765">(Mar 13 2025 at 20:53)</a>:</h4>
<p>Even worse, no possible plans, IMO</p>



<a name="505523845"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505523845" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505523845">(Mar 13 2025 at 20:54)</a>:</h4>
<p>The WASM runtime for proc macros seems pretty promising</p>



<a name="505523933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505523933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505523933">(Mar 13 2025 at 20:54)</a>:</h4>
<p>And parallelism was only recently introduced in nightly for pre-LLVM stages within the same crate</p>



<a name="505524005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505524005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505524005">(Mar 13 2025 at 20:55)</a>:</h4>
<p>But Rust as a language isn't designed in a way that can be compiled quickly</p>



<a name="505524034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505524034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505524034">(Mar 13 2025 at 20:55)</a>:</h4>
<p>This coming from one of Rust's biggest fanboys</p>



<a name="505559935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505559935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505559935">(Mar 14 2025 at 01:39)</a>:</h4>
<p>I think y'all should be able to try out <a href="https://ziglang.org/download/0.14.0/release-notes.html#Incremental-Compilation">this workflow</a> already (the thing the bun guy said they can't try out because of <code>usingnamespace</code>).</p>
<p>has anyone tried it? can you report success or trouble with it?</p>



<a name="505560600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505560600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505560600">(Mar 14 2025 at 01:45)</a>:</h4>
<p>note: specifically the "no-bin" thing (read the linked section to see how to set it up)</p>



<a name="505560705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505560705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505560705">(Mar 14 2025 at 01:46)</a>:</h4>
<p>Does no-bin have to be a flag? Currently we have a <code>check</code> build step, but zig seems to ignore it and still build everything.</p>



<a name="505560824"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505560824" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505560824">(Mar 14 2025 at 01:47)</a>:</h4>
<p>might be a bit of an awkward build system API thing here to work around. it needs to pass <code>-fno-bin</code> to the compiler, which I believe it does based on whether or not <code>exe.getEmittedBin()</code> is called, which is called by <code>installArtifact</code></p>



<a name="505560898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505560898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505560898">(Mar 14 2025 at 01:48)</a>:</h4>
<p>I'm interested in addressing that, but more interested in seeing if you can get incremental compilation on errors only to work already</p>



<a name="505561233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505561233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505561233">(Mar 14 2025 at 01:51)</a>:</h4>
<p>If I comment out all installArtifact calls and remove the test step we get super fast compiles.</p>
<p>If I only comment out installArtifact, but leave in the test step, some reason every other build is super fast (presumably a bug of some sort cause I change the file every time).</p>



<a name="505561399"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505561399" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505561399">(Mar 14 2025 at 01:52)</a>:</h4>
<p>interesting. well you are welcome to file bugs against this functionality (codegen disabled). mlugg has been pretty diligent about fixing such bugs</p>



<a name="505561417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505561417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505561417">(Mar 14 2025 at 01:52)</a>:</h4>
<p>Despite changing the same amount of code between every run, every other call full rebuilds the tests and takes 2 seconds.</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>with test step</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite"><pre><span></span><code>time zig build check -fincremental --watch
Build Summary: 6/6 steps succeeded
check success
├─ zig build-exe roc Debug native success 428ms
├─ zig test Debug native success 2s
├─ zig build-exe repro-tokenize Debug native success 372ms
└─ zig build-exe repro-parse Debug native success 406ms
Build Summary: 6/6 steps succeeded
check success
├─ zig build-exe roc Debug native success 19ms
├─ zig test Debug native success 21ms
├─ zig build-exe repro-tokenize Debug native success 22ms
└─ zig build-exe repro-parse Debug native success 18ms
Build Summary: 6/6 steps succeeded
check success
├─ zig build-exe roc Debug native success 26ms
├─ zig test Debug native success 2s
├─ zig build-exe repro-tokenize Debug native success 30ms
└─ zig build-exe repro-parse Debug native success 27ms
Build Summary: 6/6 steps succeeded
check success
├─ zig build-exe roc Debug native success 28ms
├─ zig test Debug native success 33ms
├─ zig build-exe repro-tokenize Debug native success 36ms
└─ zig build-exe repro-parse Debug native success 30ms
Build Summary: 6/6 steps succeeded
check success
├─ zig build-exe roc Debug native success 25ms
├─ zig test Debug native success 2s
├─ zig build-exe repro-tokenize Debug native success 30ms
└─ zig build-exe repro-parse Debug native success 25ms
Build Summary: 6/6 steps succeeded
</code></pre></div>
</div></div>



<a name="505561594"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505561594" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505561594">(Mar 14 2025 at 01:54)</a>:</h4>
<p>that's a good bug report assuming that you've managed to make the <code>zig test</code> command pass <code>-fno-emit-bin</code></p>



<a name="505561687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505561687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505561687">(Mar 14 2025 at 01:55)</a>:</h4>
<p>and assuming that gets fixed soon, that should be a ~25ms recompile cycle for you while working on a refactor. hope that gives you a sense of where things are headed :)</p>



<a name="505562132"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505562132" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505562132">(Mar 14 2025 at 01:59)</a>:</h4>
<p>Is there any equivalent config to <code>-fno-emit-bin</code> for <code>addTest</code> followed by <code>addRunArtifact</code>?</p>



<a name="505562165"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505562165" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505562165">(Mar 14 2025 at 01:59)</a>:</h4>
<p>From a quick skim of the options, I don't see anything available there</p>



<a name="505562201"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505562201" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505562201">(Mar 14 2025 at 01:59)</a>:</h4>
<p>mm I think addTest is equivalent to addExecutable. so if you don't try to run the test, I think it will pass -fno-emit-bin. you can verify the CLI commands with --verbose</p>



<a name="505562850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505562850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505562850">(Mar 14 2025 at 02:05)</a>:</h4>
<p>btw another thing I'm doing in this release cycle is separating out the build runner process from the application's configure script (build.zig), so that you don't have to wait for the growing number of build system features to compile every time you change your build script. this is relevant as the fuzzer UI becomes more sophisticated</p>



<a name="505563455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505563455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505563455">(Mar 14 2025 at 02:09)</a>:</h4>
<p>Hmm, so yeah, some reason every other save it rebuilds the test binary. And it is missing <code>-fno-emit-bin</code>.<br>
<code>/Users/bren077s/vendor/zig-0.14.0/zig test -ODebug -Mroot=/Users/bren077s/Projects/roc/src/test.zig -lc --cache-dir /Users/bren077s/Projects/roc/.zig-cache --global-cache-dir /Users/bren077s/.cache/zig --name test --zig-lib-dir /Users/bren077s/vendor/zig-0.14.0/lib/ -fincremental --listen=-</code></p>
<p>That said, given I am not calling <code>zig build test</code>, I am a bit surprised this is happening at all.<br>
I guess just because the <code>test</code> step exists which runs the test binary, anything that interacts with the test binary (even if it doesn't run the binary), will lead to the binary being generated. I made our <code>check</code> step depend on <code>addTest</code>, just to make sure all our tests compile.</p>



<a name="505563626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505563626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505563626">(Mar 14 2025 at 02:10)</a>:</h4>
<p>I'm sure the build system API could be improved to make this better without you having to think so hard about it</p>



<a name="505563670"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505563670" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505563670">(Mar 14 2025 at 02:11)</a>:</h4>
<p>Hmm, yeah, making 2 copies of the test step. One that is used for <code>zig build test</code> and actually runs the test, and one that is used for <code>zig build check</code> but never run fixes the issue.</p>



<a name="505563671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505563671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505563671">(Mar 14 2025 at 02:11)</a>:</h4>
<p>I mean, once the "codegen doesn't work yet" caveat is lifted, for instance, this will Just Work</p>



<a name="505563786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505563786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505563786">(Mar 14 2025 at 02:12)</a>:</h4>
<p>but anyway, I hope you will find these workarounds worth it for the 0.14.x release of zig - they sure helped me out a ton when working on big things</p>



<a name="505563803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505563803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505563803">(Mar 14 2025 at 02:12)</a>:</h4>
<p>Anyway, thanks for the tip, definitely will clean up our build.zig to make incremental builds work.</p>



<a name="505564024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505564024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505564024">(Mar 14 2025 at 02:14)</a>:</h4>
<p>np! report bugs :)</p>



<a name="505564076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505564076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505564076">(Mar 14 2025 at 02:14)</a>:</h4>
<p>one day we'll find all our own bugs with fuzzing but that day has not yet arrived</p>



<a name="505588574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505588574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505588574">(Mar 14 2025 at 05:30)</a>:</h4>
<p>I've just checked out the new incremental stuff <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> landed for roc's zig compiler and configured ZLS too. </p>
<p>It's very fast.  <span aria-label="firebird" class="emoji emoji-1f426-200d-1f525" role="img" title="firebird">:firebird:</span> <span aria-label="racecar" class="emoji emoji-1f3ce" role="img" title="racecar">:racecar:</span> <span aria-label="rocket" class="emoji emoji-1f680" role="img" title="rocket">:rocket:</span></p>
<p><em>(edit) it's hard to find the right emoji to really convey the feeling</em></p>



<a name="505630068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505630068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Loris Cro <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505630068">(Mar 14 2025 at 09:54)</a>:</h4>
<p>The "official" emoji for fast Zig stuff is <span aria-label="zap" class="emoji emoji-26a1" role="img" title="zap">:zap:</span> (<code>:zap:</code>)</p>



<a name="505631507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505631507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505631507">(Mar 14 2025 at 10:01)</a>:</h4>
<p>Thank you Loris <span aria-label="zap" class="emoji emoji-26a1" role="img" title="zap">:zap:</span></p>



<a name="505632609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505632609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Loris Cro <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505632609">(Mar 14 2025 at 10:07)</a>:</h4>
<p>ZLS does support --watch so you should also be able to enjoy basically the best of both worlds (in editor diagnostics, fast feedback) if you have the correct setup <a href="https://github.com/zigtools/zls/pull/2096">https://github.com/zigtools/zls/pull/2096</a></p>



<a name="505635744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/505635744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Loris Cro <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#505635744">(Mar 14 2025 at 10:21)</a>:</h4>
<p>forgot to add: <span aria-label="zap" class="emoji emoji-26a1" role="img" title="zap">:zap:</span></p>



<a name="508423427"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508423427" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508423427">(Mar 27 2025 at 03:39)</a>:</h4>
<p>What's the next thing that ought to be worked on at this point?</p>



<a name="508423488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508423488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508423488">(Mar 27 2025 at 03:40)</a>:</h4>
<p>There are a few candidates</p>



<a name="508423529"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508423529" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508423529">(Mar 27 2025 at 03:40)</a>:</h4>
<p>Moving to a keyboard</p>



<a name="508424073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424073">(Mar 27 2025 at 03:47)</a>:</h4>
<p>There are a few paths for us to take to get to an MVP</p>



<a name="508424128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424128">(Mar 27 2025 at 03:47)</a>:</h4>
<p>The first stage we have been talking about was functions and strings</p>



<a name="508424206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424206">(Mar 27 2025 at 03:48)</a>:</h4>
<p>_nods_</p>



<a name="508424244"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424244" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424244">(Mar 27 2025 at 03:48)</a>:</h4>
<p>There were a couple of "more difficult to do after" steps I thought important to implement, like blocks and imports</p>



<a name="508424259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424259">(Mar 27 2025 at 03:49)</a>:</h4>
<p>But those aren't <em>necessary</em></p>



<a name="508424304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424304">(Mar 27 2025 at 03:49)</a>:</h4>
<p>So if we want to finish up with imports, then implementing the basics of import resolution would be a good next step</p>



<a name="508424372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424372">(Mar 27 2025 at 03:50)</a>:</h4>
<p>That's part of can? Or is that in a later phase?</p>



<a name="508424382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424382">(Mar 27 2025 at 03:50)</a>:</h4>
<p>That's the <del>phase</del> stage directly after canonicalization</p>



<a name="508424436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424436">(Mar 27 2025 at 03:51)</a>:</h4>
<p>resolve_imports.zig, presumably</p>



<a name="508424441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424441">(Mar 27 2025 at 03:51)</a>:</h4>
<p>yep</p>



<a name="508424547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424547">(Mar 27 2025 at 03:52)</a>:</h4>
<p>In particular, can wants to treat imported data as "probably" present, and imported from a module with the given name. <code>resolve_imports.zig</code> would go through those imports (and also ingested files a la <code>import "file.txt" as data : List(U8)</code>) and match them to files in the filesystem or create an error</p>



<a name="508424595"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424595" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424595">(Mar 27 2025 at 03:52)</a>:</h4>
<p>So it'll need to trigger parsing (and can) for those other files, right?</p>



<a name="508424613"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424613" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424613">(Mar 27 2025 at 03:53)</a>:</h4>
<p>What's the mechanism for that?</p>



<a name="508424616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424616">(Mar 27 2025 at 03:53)</a>:</h4>
<p>That has already been implemented in the <code>coordinate.zig</code> foundational work</p>



<a name="508424661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424661">(Mar 27 2025 at 03:53)</a>:</h4>
<p>The <code>coordinate.zig</code> file looks at all files (Roc and non-Roc) in all referenced packages</p>



<a name="508424680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424680">(Mar 27 2025 at 03:53)</a>:</h4>
<p>And registers them in a big list</p>



<a name="508424790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424790">(Mar 27 2025 at 03:55)</a>:</h4>
<p>Then <code>resolve_imports.zig</code> would look in the <code>*Package.Store</code> and see if it can find a file with the right name for the imported module</p>



<a name="508424864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424864">(Mar 27 2025 at 03:55)</a>:</h4>
<p>Is that the <code>discoverModulesStartingFromEntry</code> thing?</p>



<a name="508424920"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424920" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424920">(Mar 27 2025 at 03:56)</a>:</h4>
<p>I'd look at <code>ModuleGraph.zig</code> for whoever implements this, because that already forms a dependency graph and sorts the modules in reverse dependency order for compilation of post-cache stages, AKA import resolution and beyond</p>



<a name="508424948"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424948" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424948">(Mar 27 2025 at 03:56)</a>:</h4>
<p>Aha great</p>



<a name="508424975"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424975" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424975">(Mar 27 2025 at 03:56)</a>:</h4>
<p>And remind me, are we guaranteed to have a DAG? Or might there be import cycles?</p>



<a name="508424989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508424989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508424989">(Mar 27 2025 at 03:57)</a>:</h4>
<p>We are banning import cycles</p>



<a name="508425049"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425049" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425049">(Mar 27 2025 at 03:57)</a>:</h4>
<p>If we find an import cycle, we exit early: <br>
<a href="https://github.com/roc-lang/roc/blob/2dbbdf3e1f6b80f7fade826b27e6a4703dd24357/src/coordinate.zig#L111">https://github.com/roc-lang/roc/blob/2dbbdf3e1f6b80f7fade826b27e6a4703dd24357/src/coordinate.zig#L111</a></p>



<a name="508425055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425055">(Mar 27 2025 at 03:57)</a>:</h4>
<p>So this is one potential task</p>



<a name="508425106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425106">(Mar 27 2025 at 03:58)</a>:</h4>
<p>I thought we needed import cycles for mutually recursive custom types.</p>



<a name="508425146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425146">(Mar 27 2025 at 03:58)</a>:</h4>
<p>We could just require that mutual recursion stays within one module, no?</p>



<a name="508425169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425169">(Mar 27 2025 at 03:59)</a>:</h4>
<p>Or are you saying you also want to allow functions of the same name on each type?</p>



<a name="508425177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425177">(Mar 27 2025 at 03:59)</a>:</h4>
<p>Well, what about <code>Foo</code> and <code>Bar</code> both having <code>to_str</code> methods</p>



<a name="508425205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425205">(Mar 27 2025 at 03:59)</a>:</h4>
<p>Ah, fair</p>



<a name="508425206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425206">(Mar 27 2025 at 03:59)</a>:</h4>
<p>Yeah... we should be able to support those <em>awkwardly</em> without allowing people to write less performantly-compiling code</p>



<a name="508425225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425225">(Mar 27 2025 at 03:59)</a>:</h4>
<p>I'll link the message from Richard's brain blast on the subject</p>



<a name="508425333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425333">(Mar 27 2025 at 04:00)</a>:</h4>
<p>Yeah, I think in that one special case, we have to conseder those modules as a super unit essentially</p>



<a name="508425367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425367">(Mar 27 2025 at 04:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500305558">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20spike/near/500068995">said</a>:</p>
<blockquote>
<p>yeah, basically the idea is that if you have two nominal tag unions that are mutually recursive, and you also want them to have static dispatch (which could come up when modeling database tables, for example) that's currently impossible</p>
</blockquote>
<p>so I thought about this some more, and I think it's better if we continue to disallow cyclic imports and recommend this workaround if anyone actually needs mutually recursive nominal types with static dispatch:</p>
<ul>
<li>define the two mutually recursive nominal types (let's call them <code>A</code> and <code>B</code>) in the same module, let's call it <code>AandB.roc</code></li>
<li>create separate <code>A.roc</code> and <code>B.roc</code> modules, each of which imports <code>AandB.roc</code> only</li>
<li>both <code>A.roc</code> and <code>B.roc</code> exposes a nominal type which wraps the appropriate mutually recursive type inside <code>AandB.roc</code>, and exposes all the desired methods on those</li>
<li>if the underlying nominal type needs to be exposed too (e.g. because the tags are needed for matching), then <code>A.roc</code> and <code>B.roc</code> can each provide a <code>to_inner</code> function which returns the underlying nominal type from <code>AandB</code>. Static dispatch won't be available on this structure, but that's okay because the wrapper does.</li>
</ul>
</blockquote>
<p>From earlier in this channel:</p>



<a name="508425696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425696">(Mar 27 2025 at 04:02)</a>:</h4>
<p>Interesting</p>



<a name="508425727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425727">(Mar 27 2025 at 04:02)</a>:</h4>
<p>ah yeah, forgot about that</p>



<a name="508425734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425734">(Mar 27 2025 at 04:02)</a>:</h4>
<p>This sorta creates a one-type-per-file requirement</p>



<a name="508425758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425758">(Mar 27 2025 at 04:03)</a>:</h4>
<p>So yeah, painful, but no recursion</p>



<a name="508425789"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425789" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425789">(Mar 27 2025 at 04:03)</a>:</h4>
<blockquote>
<p>This sorta creates a one-type-per-file requirement</p>
</blockquote>
<p>Custom types do that in general. This is more a side effect.</p>



<a name="508425795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425795">(Mar 27 2025 at 04:03)</a>:</h4>
<p>Yaeh true</p>



<a name="508425877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425877">(Mar 27 2025 at 04:04)</a>:</h4>
<p>I guess what I was poking at is maybe static dispatch methods ought to be definable within a smaller scope than a whole module</p>



<a name="508425913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425913">(Mar 27 2025 at 04:04)</a>:</h4>
<p>Like if you could define types in submodules and re-export them from the parent (real file) module</p>



<a name="508425931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425931">(Mar 27 2025 at 04:04)</a>:</h4>
<p>like Rust's <code>mod{}</code> blocks</p>



<a name="508425932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425932">(Mar 27 2025 at 04:04)</a>:</h4>
<p>Yeah, that has been mentioned a few times. I think it is currently in the lets wait and see in practice state</p>



<a name="508425943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508425943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508425943">(Mar 27 2025 at 04:04)</a>:</h4>
<p>Yep yep, makes sense</p>



<a name="508426005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508426005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508426005">(Mar 27 2025 at 04:05)</a>:</h4>
<p>Cause could be dealt with via submodules or via explicitly bound methods to an object.</p>



<a name="508427328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508427328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508427328">(Mar 27 2025 at 04:19)</a>:</h4>
<p>So <span class="user-mention" data-user-id="453336">@Joshua Warner</span>, in order of my estimation of importance, there's</p>
<ul>
<li>import resolution</li>
<li>typechecking</li>
<li>helping with canonicalization (might be tricky to coordinate?)</li>
<li>S-Expr's</li>
<li>type specialization</li>
<li>refcounting</li>
<li>error message rendering</li>
</ul>



<a name="508427342"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508427342" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508427342">(Mar 27 2025 at 04:19)</a>:</h4>
<p>Is there something in particular you want to hear about?</p>



<a name="508427444"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508427444" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508427444">(Mar 27 2025 at 04:21)</a>:</h4>
<p>If you're interested in typechecking, I'd reach out to Agus and see if you can grab it from him, he seems very busy with work at the moment and hasn't been pushing to his PR since its creation.</p>



<a name="508427478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508427478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508427478">(Mar 27 2025 at 04:21)</a>:</h4>
<p>But there are technically multiple people that are interested in working on it, so that one will happen <em>eventually</em></p>



<a name="508427800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508427800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508427800">(Mar 27 2025 at 04:25)</a>:</h4>
<p>I have fairly limited time, so whatever I pick up probably needs to be possible to put into some relatively bite-sized chunks</p>



<a name="508428605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508428605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508428605">(Mar 27 2025 at 04:36)</a>:</h4>
<p>Looks like snapshots can't have multiple test files right now, and thus can't usefully hit code in resolve_imports</p>



<a name="508428956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508428956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508428956">(Mar 27 2025 at 04:42)</a>:</h4>
<p>Actually it looks like snapshots don't currently cover anything after parsing (no canonicalization, for example)</p>



<a name="508429157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508429157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508429157">(Mar 27 2025 at 04:45)</a>:</h4>
<p>Yes, that would be something helpful to figure out on its own, and working on one stage at a time (or part of a stage at a time) should be modular enough</p>



<a name="508429300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508429300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508429300">(Mar 27 2025 at 04:47)</a>:</h4>
<p>I thinking of tackling these things next:</p>
<ol>
<li>Add coverage of canonicalize to the snapshot handling</li>
<li>Allow a snapshot to define multiple files - I'm thinking using the section headers, so instead of <code>~~~SOURCE</code> you have <code>~~~SOURCE:foo.roc</code> and <code>~~~SOURCE:bar.roc</code> sections, and so on for any of the following sections which are per-module.</li>
<li>Try to switch to using coordinate.zig logic in snapshot testing. Both so we don't have to duplicate that to get coverage of resolve_imports, but also to just... get coverage of coordinate.zig itself in snapshot testing.</li>
</ol>
<p>Thoughts?</p>



<a name="508435296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20spike/near/508435296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20spike.html#508435296">(Mar 27 2025 at 06:03)</a>:</h4>
<p>That would be great!</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
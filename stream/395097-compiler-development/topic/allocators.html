<html>
<head><meta charset="utf-8"><title>allocators · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html">allocators</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="544365433"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544365433" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544365433">(Oct 12 2025 at 02:46)</a>:</h4>
<p>What is our general opinion around passing both <code>gpa</code> and <code>arena</code> to many functions. I noticed that we have a solid number of tiny allocations going to the gpa (like paths and such). Generally it is better for those to got to an arena instead. On top of that, we have some memory leaks that I am fixing up and in a few case, I think it might be nicer to put those things in the arena and not need to worry about them not being freed.</p>
<hr>
<p>My general thought is that this is best practice, but definitely a bit inconvenient. Definitely not something that needs to be done of first pass or anything. I'm just in general thinking of cleaning up some locations and also trying to explicitly name allocators as <code>gpa</code> or <code>arena</code> to make it clearer what is expected. Of course for agnostic functions, it would stay as <code>allocator</code>.</p>
<p>Thoughts?</p>



<a name="544365895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544365895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544365895">(Oct 12 2025 at 02:58)</a>:</h4>
<p>Given we make both the gpa and the arena right at the start of main, maybe we should just eventually switch to a struct that contains both. That way, all functions can just choose what makes sense for each allocation?</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">Allocators</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">gpa</span><span class="o">:</span><span class="w"> </span><span class="n">Allocator</span><span class="p">,</span>
<span class="w">    </span><span class="n">arena</span><span class="o">:</span><span class="w"> </span><span class="n">Allocator</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="544366275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544366275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544366275">(Oct 12 2025 at 03:01)</a>:</h4>
<p>This is kinda what zig does in their compiler, just at a per stage basis:<br>
<a href="https://github.com/ziglang/zig/blob/87c18945c207c77b5bc84123a7ba043b848bbabb/src/Sema.zig#L43-L46">https://github.com/ziglang/zig/blob/87c18945c207c77b5bc84123a7ba043b848bbabb/src/Sema.zig#L43-L46</a></p>



<a name="544366458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544366458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544366458">(Oct 12 2025 at 03:02)</a>:</h4>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">/// Alias to `zcu.gpa`.</span>
<span class="n">gpa</span><span class="o">:</span><span class="w"> </span><span class="n">Allocator</span><span class="p">,</span>
<span class="c1">/// Points to the temporary arena allocator of the Sema.</span>
<span class="c1">/// This arena will be cleared when the sema is destroyed.</span>
<span class="n">arena</span><span class="o">:</span><span class="w"> </span><span class="n">Allocator</span><span class="p">,</span>
</code></pre></div>
<p>Though I guess they have a perf stage arena instead of a global arena here. I think for all the paths and other things we would have global arena for roc. Separately we could consider per stage arenas for roc, but I think we already have our scratch buffers which kinda fill that role.</p>



<a name="544366934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544366934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544366934">(Oct 12 2025 at 03:13)</a>:</h4>
<p>Also, context: <a href="https://github.com/roc-lang/roc/actions/runs/18436673436/job/52531070396?pr=8285">https://github.com/roc-lang/roc/actions/runs/18436673436/job/52531070396?pr=8285</a></p>
<p>These are some memory leaks we currently have that probably should be in an arena anyway.</p>



<a name="544367983"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544367983" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544367983">(Oct 12 2025 at 03:37)</a>:</h4>
<p>I like that idea!</p>



<a name="544367986"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544367986" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544367986">(Oct 12 2025 at 03:37)</a>:</h4>
<p>+1 to more arena usage</p>



<a name="544368012"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544368012" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544368012">(Oct 12 2025 at 03:38)</a>:</h4>
<p>could we call it like <code>scratch</code> or something?</p>



<a name="544368023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544368023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544368023">(Oct 12 2025 at 03:38)</a>:</h4>
<p>since sometimes we use an arena allocator for gpa <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="544368346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544368346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544368346">(Oct 12 2025 at 03:44)</a>:</h4>
<p>In the most extreme I would see 3 categories:</p>
<ol>
<li><code>gpa</code> only for things that grow and reallocate like all our arraylists</li>
<li><code>arena</code> for things that like the whole program (or at least for multiple stages) but are tiny and not worth deallocating.</li>
<li><code>scratch</code> anything that is specific to a compiler stage but is static size or exceptionally unlikely to grow and thus fine to consider static. Will be fully cleared between each compiler stage.</li>
</ol>
<hr>
<p>That said, I'm not sure it is worth having all 3. Might just be inconvenient to wrangle. I'm also not sure how much stuff we have in category 3. If it isn't a lot, it can still just go into 2 instead.</p>
<p>And I'm open to whatever name. I was assuming functions would have <code>allocs: Allocators</code> as the first arg and then use <code>allocs.gpa</code> and <code>allocs.arena</code> (or whatever other name).</p>



<a name="544368406"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544368406" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544368406">(Oct 12 2025 at 03:45)</a>:</h4>
<p>Do you have a sense of how much stuff we have in category 3? I know that some of the stages have scratch space, but to my understand it is dynamically resizing, so probably should be under the gpa instead of in a true scratch buffer for the specific stage.</p>



<a name="544368476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544368476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544368476">(Oct 12 2025 at 03:47)</a>:</h4>
<p>Of note, I think zig used to have the 3 allocator system. They called them <code>gpa</code>, <code>perm_arena</code>, and <code>arena</code>. But they remove the <code>perm_arena</code> actually.</p>



<a name="544407609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544407609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544407609">(Oct 12 2025 at 15:11)</a>:</h4>
<p>interesting! We actually have a bunch of scratch array lists that are used as typed stacks of temporary work, so maybe those are sufficient</p>



<a name="544412870"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544412870" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544412870">(Oct 12 2025 at 16:27)</a>:</h4>
<p>Yeah, as long as they are amortizing the allocations, they are probably fine. Different ways to essentially do the same thing.</p>
<p>Like the other design with an arena would probably be to free form allocate into the arena instead of having the n different array lists for scratch.</p>
<p>I would say that for now these are a fine scratch solutions and I just want to add a global arena for all the random tiny allocations that we really don't care about.</p>



<a name="544414296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/544414296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#544414296">(Oct 12 2025 at 16:46)</a>:</h4>
<p>sounds good to me, go for it!</p>



<a name="545143929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/allocators/near/545143929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/allocators.html#545143929">(Oct 15 2025 at 23:45)</a>:</h4>
<p>Add new Allocators struct to pass gpa and arena to more functions <a href="https://github.com/roc-lang/roc/issues/8285">#8285</a></p>
<p>Really only got to updating main.zig (tons of paths and things now using the arena). That said, I think it is big enough that it is worth submitting. And follow ups and expand to more files.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
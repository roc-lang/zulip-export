<html>
<head><meta charset="utf-8"><title>zig compiler - calling roc · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html">zig compiler - calling roc</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="497282963"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497282963" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497282963">(Feb 02 2025 at 19:18)</a>:</h4>
<p>I wanted to write this out to make sure we are all on the same page. This is especially important cause I know we want to change some of the platform calling convention to make things easier to work with. This does not need to all be done at once, but I think some of it is important to do from the start.</p>
<p>Firstly, and probably the most important (it may effect some of the IRs). All functions that roc generates will now have an implicit arg. The arg will be a constant reference to a record that contains all allocation related functions. This will make it much easier for platforms to control allocations with arenas and what not. One piece I am not sure of with this design, do lambdas capture this record or do they take it as an argument? There may be some weird edge cases here that platforms need to be careful around.</p>
<p>Note: Due to switching to static libraries instead of surgical linking, all other effects will stay the same as they are today. They will not need to be passed in on each call. They will just be linked as normal.</p>
<p>Second, we want to change the host and effect function allowed types. Essentially, the host must box all returned lambdas and type variables. Type variables are allowed to be passed to the host, but they are simply opaque boxes to the host (Like <code>Box model</code> which the host would see as <code>Box {}</code>). This removes any sort of variable sized data being passed to the host. </p>
<p>Third, and this is a longer term goal, we want to generate cffi functions that the host can use to interact with all roc primitives. These can be gc'd if the host doesn't use them, but we should generate functions for all types exposed to the host to make them easier to interact with. This will fundamentally work with glue to make interacting with roc types way easier. Instead of repeating the same logic that is rather complex in N different glue scripts, we just have to wrap a couple of functions and tell the host how many bytes a type is.</p>



<a name="497284436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497284436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497284436">(Feb 02 2025 at 19:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/497282963">said</a>:</p>
<blockquote>
<p>One piece I am not sure of with this design, do lambdas capture this record or do they take it as an argument? There may be some weird edge cases here that platforms need to be careful around.</p>
</blockquote>
<p>I don't think they should capture. if I'm the host and I run a chunk of Roc code, I always want the whole thing to run using the allocators I specified at the call site. Capturing them would remove that invariant, which definitely sounds undesirable! <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="497284451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497284451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497284451">(Feb 02 2025 at 19:38)</a>:</h4>
<p>but in general that all sounds right to me!</p>



<a name="497284955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497284955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497284955">(Feb 02 2025 at 19:44)</a>:</h4>
<p>The hard part is that the lambda may capture variables that were allocated with the allocator that created the lambda. Maybe types need to store the allocator they were created with, but I was hoping to avoid that.</p>



<a name="497285001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497285001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497285001">(Feb 02 2025 at 19:45)</a>:</h4>
<p>Also, if types store the allocator, should they migrate to a new allocator if they grow in a different roc function with a different new allocator.</p>



<a name="497285452"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497285452" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497285452">(Feb 02 2025 at 19:51)</a>:</h4>
<p>I think it's best to let the host figure that out</p>



<a name="497285541"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497285541" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497285541">(Feb 02 2025 at 19:52)</a>:</h4>
<p>like if the host is going to store returned closures and then use them again later, it's up to the host to make sure they're being used with the same allocator again</p>



<a name="497285662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497285662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497285662">(Feb 02 2025 at 19:54)</a>:</h4>
<p>or at least with a compatible one, e.g. if the new one is told to deallocate an address it doesn't recognize, it knows to ask the previous allocator to deallocate it</p>



<a name="497285803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497285803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497285803">(Feb 02 2025 at 19:55)</a>:</h4>
<p>Ok, yeah that sounds fine. I guess worst case the host makes a linked list of allocators. I wonder if this will make it hard to clean up old arenas. Probably depends a lot on context. Worst case the arena would last until all lambdas are resolved</p>



<a name="497303903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497303903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497303903">(Feb 02 2025 at 23:51)</a>:</h4>
<p>I wanted to mention it in this thread too:</p>
<p>we talked about simplifying the ABI by saying the host always passes exactly 3 pointers to the compiled Roc function:</p>
<ol>
<li>pointer to the struct of function pointers</li>
<li>pointer to the memory where the return value will be written</li>
<li>pointer to the memory where the 1 arg is stored (we restrict exposed Roc functions to 1 arg, but of course that 1 arg can be a tuple etc.)</li>
</ol>



<a name="497303934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497303934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497303934">(Feb 02 2025 at 23:51)</a>:</h4>
<p>this means we don't need to deal with C ABI at all</p>



<a name="497304207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304207">(Feb 02 2025 at 23:55)</a>:</h4>
<p>Yeah, that would free us from c call conv, but not from c abi in general (well, I guess glue just has to use c abi layouts to match roc's layout, so it does mostly avoid c abi too)</p>



<a name="497304313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304313">(Feb 02 2025 at 23:56)</a>:</h4>
<p>Also, I think n args is fine.</p>



<a name="497304343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304343">(Feb 02 2025 at 23:56)</a>:</h4>
<p>but yeah, each arg is passed by pointer to avoid abi for the most part</p>



<a name="497304499"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304499" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304499">(Feb 02 2025 at 23:58)</a>:</h4>
<p>That said, for the interpreter, it would take that and map it to having all args in a list and also a list of types for each arg.</p>



<a name="497304533"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304533" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304533">(Feb 02 2025 at 23:59)</a>:</h4>
<p>I think if we did one pointer per arg, there would become (correct) folklore that it's better for perf if you just put everything in one arg</p>



<a name="497304546"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304546" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304546">(Feb 02 2025 at 23:59)</a>:</h4>
<p>so I feel like we should just make that be how it works directly</p>



<a name="497304576"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304576" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304576">(Feb 02 2025 at 23:59)</a>:</h4>
<blockquote>
<p>it's better for perf if you just put everything in one arg</p>
</blockquote>
<p>Why would that be better perf?</p>



<a name="497304736"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304736" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304736">(Feb 03 2025 at 00:01)</a>:</h4>
<p>if I'm passing four u16s, passing the four pointers will use way more memory than the four u16s themselves</p>



<a name="497304779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304779">(Feb 03 2025 at 00:01)</a>:</h4>
<p>I don't think it would be consistently better or worse. The cost of putting them in one arg is making a big stack allocation and copying everything over. If in the platform they are all separate data, it is probably faster to pass them as separate pointers and avoid any copying of data.</p>



<a name="497304931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304931">(Feb 03 2025 at 00:02)</a>:</h4>
<p>fair</p>



<a name="497304965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497304965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497304965">(Feb 03 2025 at 00:02)</a>:</h4>
<p>ok yeah maybe that's better just to make one less rule to think about</p>



<a name="497305122"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305122" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305122">(Feb 03 2025 at 00:04)</a>:</h4>
<p>Honestly, I don't think the platform to roc boundary will be in the hot loop generally speaking. If roc is doing that little, you probably don't want to dish out to roc at all. So I think any abi is probably fine.</p>



<a name="497305169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305169">(Feb 03 2025 at 00:05)</a>:</h4>
<p>Is it helpful to think about what would be nice for Go, or Swift, or other languages to work with?</p>



<a name="497305224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305224">(Feb 03 2025 at 00:05)</a>:</h4>
<p>I feel like C or Zig is easy to do anything... but if we stray to far from convention it may make it difficult for those other languages to call into roc</p>



<a name="497305381"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305381" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305381">(Feb 03 2025 at 00:07)</a>:</h4>
<p>nah</p>



<a name="497305408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305408">(Feb 03 2025 at 00:07)</a>:</h4>
<p>don't think this should matter for them</p>



<a name="497305420"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305420" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305420">(Feb 03 2025 at 00:07)</a>:</h4>
<p>they have to know how to pass pointers to things regardless</p>



<a name="497305426"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305426" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305426">(Feb 03 2025 at 00:07)</a>:</h4>
<p>Also -- not sure if we've forgotten about it. But should we discuss hot-reloading or the ideas around that?</p>



<a name="497305454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305454">(Feb 03 2025 at 00:08)</a>:</h4>
<p>yeah! prob in its own thread?</p>



<a name="497305544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305544">(Feb 03 2025 at 00:08)</a>:</h4>
<p>Yeah, I'm not sure what to say though... other than "hey, anyone thought about hot-reloading?"</p>



<a name="497305962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497305962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497305962">(Feb 03 2025 at 00:13)</a>:</h4>
<p>Also, just to note, we are defining two different specs here. One for <code>libroc</code> and one for standard platform-&gt;roc calls.</p>
<h2>Here is what I would propose:</h2>
<h3>LibRoc</h3>
<ol>
<li>A pointer to write the return data to</li>
<li>A pointer to write the return <code>TypeSpec</code> to</li>
<li>A record of function pointers (this must include all effects).</li>
<li>A slice of pointers (these are the args)</li>
<li>A slice of <code>TypeSpec</code> (this tells it the types of every arg)</li>
</ol>
<h3>Platform -&gt; Roc standard FFI</h3>
<ol>
<li>A pointer to write the return data to</li>
<li>A record of function pointers (only allocators functions and <code>roc_load</code>)</li>
<li>N pointers, one for each arg.</li>
</ol>
<hr>
<p>The shim would map between those to formats. A standard host would only implement "Platform -&gt; Roc standard FFI". A host directly consuming <code>libroc</code> would implement "LibRoc".</p>



<a name="497306086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306086">(Feb 03 2025 at 00:14)</a>:</h4>
<p>I'm not understanding the benefit of the typespec thing</p>



<a name="497306186"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306186" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306186">(Feb 03 2025 at 00:16)</a>:</h4>
<p>The interpreter will run solely using tagged data. You didn't want recursively tagged data like would be traditional if we made a <code>RocObject</code> that the interpreter used. Without that, we need a type spec so the interpret can understand the underlying data.</p>



<a name="497306293"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306293" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306293">(Feb 03 2025 at 00:17)</a>:</h4>
<p>that's true inside the running interpreter, yes</p>



<a name="497306298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306298">(Feb 03 2025 at 00:17)</a>:</h4>
<p>As a simple, if the interpreter calls <code>List.len</code>, it needs to know the element type of the list. This is required so it can decrement the refcount of the elements and free them.</p>



<a name="497306372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306372">(Feb 03 2025 at 00:18)</a>:</h4>
<p>Yes, and if a platform is able to dynamically build up args to call into the interpreter, we want to make sure the args passed in are what the roc function expects</p>



<a name="497306409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306409">(Feb 03 2025 at 00:18)</a>:</h4>
<p>Otherwise, we may blindly use the arg as the wrong type due to only trusting the roc source code and things would go very wrong.</p>



<a name="497306583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306583">(Feb 03 2025 at 00:21)</a>:</h4>
<p>the thing I'm missing is that the caller still has to get the ABI right</p>



<a name="497306599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306599">(Feb 03 2025 at 00:21)</a>:</h4>
<p>like if I give you a pointer to some bytes, and then I also give you a thing that says "hey the pointer to the bytes has this type"</p>



<a name="497306614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306614">(Feb 03 2025 at 00:21)</a>:</h4>
<p>and the type I'm giving you at runtime is always going to be the same type as the type you've statically declared you're expecting</p>



<a name="497306738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306738">(Feb 03 2025 at 00:23)</a>:</h4>
<p>I think it doesn't matter much for the shim use case. The shim gets rid of this type safety anyway by using the static API matching what llvm will use</p>



<a name="497306740"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306740" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306740">(Feb 03 2025 at 00:23)</a>:</h4>
<p>then the scenario where this helps is:</p>
<ul>
<li>I gave you bytes that aren't the type you expect, even though you told me what you expect</li>
<li>however, I correctly described the bytes I was giving you</li>
<li>so I knew what type I was giving you, and although I statically had the information that you expected a different type, I missed that or something</li>
<li>therefore, this runtime check caught it and replaced UB with a crash</li>
</ul>



<a name="497306753"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306753" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306753">(Feb 03 2025 at 00:23)</a>:</h4>
<p>For direct use of lib roc, more dynamic use cases should be possible</p>



<a name="497306770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306770">(Feb 03 2025 at 00:23)</a>:</h4>
<p>but in all cases we know statically what the expected type is</p>



<a name="497306784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306784">(Feb 03 2025 at 00:24)</a>:</h4>
<p>like there's no value of <code>main.roc</code> I can pass to it where I don't statically know what types are expected</p>



<a name="497306872"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306872" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306872">(Feb 03 2025 at 00:24)</a>:</h4>
<p>I guess the scenario could be that I gave it the wrong main.roc maybe?</p>



<a name="497306890"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306890" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306890">(Feb 03 2025 at 00:25)</a>:</h4>
<p>Sure, I guess then libroc at least needs to expose a function to get the type spec and list of exposed functions in <code>main.roc</code></p>



<a name="497306997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497306997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497306997">(Feb 03 2025 at 00:26)</a>:</h4>
<p>That anchors to <code>main.roc</code> as the source of truth and trusts the platform to follow the spec read from <code>main.roc</code>. this is more thinking about future <code>libroc</code> use cases than the current shim plans.</p>



<a name="497307062"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497307062" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497307062">(Feb 03 2025 at 00:27)</a>:</h4>
<p>Cause a platform could dynamically load a main.roc file and do something different depending on what is exposed by the main.roc file. A simple example would be supporting plugin versioning. Load main.roc, depending on the return function API, you know the plugin version to run with.</p>



<a name="497307539"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497307539" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497307539">(Feb 03 2025 at 00:33)</a>:</h4>
<p>Anyway, assuming the platform -&gt; roc part looks fine, let's move the rest of this discussion over to the libroc thread. I think that dynamic use case is what needs to decide the API for it</p>



<a name="497307632"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497307632" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497307632">(Feb 03 2025 at 00:34)</a>:</h4>
<p>I guess if the typespec is like a hash of the types, that's probably very quick?</p>



<a name="497307641"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497307641" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497307641">(Feb 03 2025 at 00:34)</a>:</h4>
<p>as in, if it's just for validation</p>



<a name="497307668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497307668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497307668">(Feb 03 2025 at 00:35)</a>:</h4>
<p>or perhaps it's a hash for quick validation plus an expanded version for more helpful error messages if the types disagree</p>



<a name="497308135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308135">(Feb 03 2025 at 00:41)</a>:</h4>
<p>I imagined it as a tag union of a spec defining the type, but I really haven't thought through it in detail. For the full libroc use case, it needs to be enough information that the interpreter can call a dynamic function with type variables.</p>



<a name="497308235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308235">(Feb 03 2025 at 00:42)</a>:</h4>
<p>I think maybe something worth establishing (because I'm not sure if we're on the same page about it) is that the <em>only</em> benefit of passing a type spec is that it would allow for an extra runtime check which could either give an error or do nothing</p>



<a name="497308257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308257">(Feb 03 2025 at 00:42)</a>:</h4>
<p>like it wouldn't allow any useful amount of introspection, or performance (would be a slight perf downside but negligible if we pass a hash)</p>



<a name="497308265"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308265" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308265">(Feb 03 2025 at 00:42)</a>:</h4>
<p>wouldn't be necessary for correctness, etc.</p>



<a name="497308338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308338">(Feb 03 2025 at 00:43)</a>:</h4>
<p>and a totally reasonable alternative design would be to just not do a typespec at all, and everything would work exactly the same way except that in the specific case where you have a correct typespec for what you're passing but that typespec doesn't line up with what main.roc expects, the typespec would have let you get a runtime error instead of UB</p>



<a name="497308405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308405">(Feb 03 2025 at 00:44)</a>:</h4>
<p>does that all sound right?</p>



<a name="497308484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308484">(Feb 03 2025 at 00:45)</a>:</h4>
<p>The interpreter will just end up creating the type spec anyway if the platform doesn't. It will be required internally to run the interpretter. Let me put up an example.</p>



<a name="497308613"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308613" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308613">(Feb 03 2025 at 00:47)</a>:</h4>
<p>oh for sure!</p>



<a name="497308616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308616">(Feb 03 2025 at 00:47)</a>:</h4>
<p>no disagreement there</p>



<a name="497308647"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308647" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308647">(Feb 03 2025 at 00:47)</a>:</h4>
<p>I'm just talking about the specific question of whether the host should construct its own type spec and pass it to <code>libroc</code></p>



<a name="497308707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308707">(Feb 03 2025 at 00:48)</a>:</h4>
<p>In the default use case, the shim constructs the type spec</p>



<a name="497308709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308709">(Feb 03 2025 at 00:48)</a>:</h4>
<p>but of note, I'm saying the interpreter has to create its own typespec in either cae</p>



<a name="497308711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308711">(Feb 03 2025 at 00:48)</a>:</h4>
<p>*case</p>



<a name="497308731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308731">(Feb 03 2025 at 00:48)</a>:</h4>
<p>oh wait, are you thinking it doesn't do validation at the boundary?</p>



<a name="497308750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308750">(Feb 03 2025 at 00:48)</a>:</h4>
<p>like it just accepts whatever it was given as truth, and then starts interpreting on that, and if that results in a runtime type mismatch at some point, so be it?</p>



<a name="497308928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497308928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497308928">(Feb 03 2025 at 00:51)</a>:</h4>
<p>Ok, I feel like this just got mixed up do to talking about libroc and about standard roc calling.</p>
<p>Let me try to anchor it.</p>
<p>Normal platforms only see a single interface. That interface is:</p>
<blockquote>
<h3>Platform -&gt; Roc standard FFI</h3>
<ol>
<li>A pointer to write the return data to</li>
<li>A record of function pointers (only allocators functions and <code>roc_load</code>)</li>
<li>N pointers, one for each arg.</li>
</ol>
</blockquote>
<p>That is all they see period. Anything libroc is an implementation detail and not exposed to the platform.</p>



<a name="497309042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309042">(Feb 03 2025 at 00:52)</a>:</h4>
<p>The shim library will deal with whatever is required to map from that interface to libroc.</p>



<a name="497309073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309073">(Feb 03 2025 at 00:52)</a>:</h4>
<p>Are we in agreement with this interface?</p>



<a name="497309165"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309165" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309165">(Feb 03 2025 at 00:54)</a>:</h4>
<p>I agree that's the standard interface between for the host in a platform + application that's compiled into a single binary</p>



<a name="497309181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309181">(Feb 03 2025 at 00:54)</a>:</h4>
<p>but I don't think that <code>libroc</code> needs to <em>necessarily</em> be in any way different from that interface</p>



<a name="497309197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309197">(Feb 03 2025 at 00:54)</a>:</h4>
<p>we can choose to have it be different, but it's optional</p>



<a name="497309295"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309295" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309295">(Feb 03 2025 at 00:56)</a>:</h4>
<p>in other words, <code>libroc</code> can expose a function which is exactly the same interface as <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span> except for 3 extra arguments:</p>
<ol>
<li>The path to main.roc</li>
<li>The function to go from a path to a .roc file to its source bytes</li>
<li>The name of the entrypoint function within main.roc that I want to call</li>
</ol>



<a name="497309299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309299">(Feb 03 2025 at 00:56)</a>:</h4>
<blockquote>
<p>only allocators functions and <code>roc_load</code></p>
</blockquote>
<ul>
<li>roc_alloc/roc_dealloc/roc_realloc - allocators for roc to use</li>
<li>roc_panic - roc crashed.. here's what happened</li>
<li>roc_debug - here's a <code>dbg</code> thing for your information </li>
<li>roc_expect_failed - hey an <code>expect</code> failed, heres some information about that</li>
<li>roc_load -- give me the bytes for a file path</li>
</ul>



<a name="497309302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309302">(Feb 03 2025 at 00:56)</a>:</h4>
<p>and then I just give it the arguments exactly as normal</p>



<a name="497309306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309306">(Feb 03 2025 at 00:56)</a>:</h4>
<p>look at the last message in <a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20libroc.20exploration">#compiler development &gt; zig compiler - libroc exploration</a> and lets move the conversation there. That is why libroc needs a different interface.</p>
<p><a class="message-link" href="/#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20libroc.20exploration/near/497307664">#compiler development &gt; zig compiler - libroc exploration @ 💬</a></p>



<a name="497309720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309720">(Feb 03 2025 at 01:02)</a>:</h4>
<p>separate thought about calling roc in general</p>



<a name="497309778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309778">(Feb 03 2025 at 01:02)</a>:</h4>
<p>we have the rule that only <code>Box</code>ed closures can be sent to the host</p>



<a name="497309782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309782">(Feb 03 2025 at 01:02)</a>:</h4>
<p>and in the interpreter, all closures are boxed</p>



<a name="497309790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309790">(Feb 03 2025 at 01:02)</a>:</h4>
<p>I guess that means we have an extra layer of boxing on them</p>



<a name="497309791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497309791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497309791">(Feb 03 2025 at 01:02)</a>:</h4>
<blockquote>
<p>A record of function pointers (only allocators functions and <code>roc_load</code>)</p>
</blockquote>
<p>edit: I think this just needs to be the allocator functions. The rest can be linked in like normal effects.</p>



<a name="497765587"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497765587" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497765587">(Feb 04 2025 at 22:06)</a>:</h4>
<p>Edit to my edit. Given we want to support roc code as a shared library, we actually do want to require passing in all effects period. Forgot about this use case.</p>
<p>Otherwise you get into all of the rdynamic pain and into brittle code symbol code that may not even consistently work cross platform.</p>



<a name="497765771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497765771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497765771">(Feb 04 2025 at 22:08)</a>:</h4>
<p>Can glue (in future) generate the full type for our struct that needs to be passed in? -- with all the allocators, and entry-points, and effects etc</p>
<p>So if I'm writing a platform in zig or rust for example, it's pretty hard to pass in the wrong things.</p>



<a name="497765957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497765957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497765957">(Feb 04 2025 at 22:09)</a>:</h4>
<p>Just a record of function pointers. Sounds doable.</p>



<a name="497766575"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497766575" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497766575">(Feb 04 2025 at 22:13)</a>:</h4>
<p>I'm thinking of stubbing out <code>roc glue</code> to take a fake glue script, and generates some zig/rust/go/c (not sure which) glue for a test platform using the new calling roc shape.</p>



<a name="497766680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497766680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497766680">(Feb 04 2025 at 22:14)</a>:</h4>
<p>I would keep everything in zig for now.</p>



<a name="497766776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497766776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497766776">(Feb 04 2025 at 22:15)</a>:</h4>
<p>And sure, though I'm not sure how valuable having the cart this far before the horse is.</p>



<a name="497766806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497766806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497766806">(Feb 04 2025 at 22:15)</a>:</h4>
<p>For glue, maybe we should just focus on the roc side</p>



<a name="497766826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497766826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497766826">(Feb 04 2025 at 22:15)</a>:</h4>
<p>We are going to the effort of engineering this thing top-down... it's all cart before horse</p>



<a name="497766841"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497766841" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497766841">(Feb 04 2025 at 22:15)</a>:</h4>
<p>It needs to be expanding to support telling about all of the effects and such</p>



<a name="497766974"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497766974" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497766974">(Feb 04 2025 at 22:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/497766826">said</a>:</p>
<blockquote>
<p>We are going to the effort of engineering this thing top-down... it's all cart before horse</p>
</blockquote>
<p>I think this is useful for broad strokes, but it often is just wrong for specific details that depend on an unknown implementation. So I would focus more on concrete API than on stubbing all the interfaces loosely</p>



<a name="497767106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497767106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497767106">(Feb 04 2025 at 22:17)</a>:</h4>
<p>I think a lot of these pieces will be easier to get right once with have a slim slice of the compiler from parser down to interpreter</p>



<a name="497767202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497767202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497767202">(Feb 04 2025 at 22:18)</a>:</h4>
<p>But don't let me stop your stubbing if you think it is useful</p>



<a name="497767330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497767330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497767330">(Feb 04 2025 at 22:19)</a>:</h4>
<p>You have outlined a specific API above for calling roc. I am proposing making a test platform that uses this new convention, and stubbing out the roc side of things -- to see it all working together, even though our roc side hasn't been implemented yet.</p>



<a name="497767451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497767451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497767451">(Feb 04 2025 at 22:20)</a>:</h4>
<p>I'm also particularly interested in validating the fully-embedded roc use cases, which is more covered in that <code>libroc</code> exploration thread.</p>



<a name="497767893"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497767893" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497767893">(Feb 04 2025 at 22:23)</a>:</h4>
<p>For fully embedded roc, I don't think this API is required. Or even recommended. You have direct access to roc internals. So you want a different API. I tried to mention the two apis above though.</p>



<a name="497767905"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497767905" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497767905">(Feb 04 2025 at 22:24)</a>:</h4>
<p>My other reason, is I was hoping to figure out how to get our bundled <code>lld</code> linking thing working, so <code>roc build</code> produces an executable.</p>



<a name="497815218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497815218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497815218">(Feb 05 2025 at 06:06)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> and I have been cooking... we've put together a working prototype of <code>roc build</code> with an example platform, and a fake roc <code>app.o</code> object file. </p>
<p>All the files are sitting on this branch. We will probably migrate into the roc repo -- now that it's less of a hack. I've included some explanation and notes in the README in case that helps.</p>
<p><a href="https://github.com/lukewilliamboswell/roc-platform-template-zig/tree/calling-roc">https://github.com/lukewilliamboswell/roc-platform-template-zig/tree/calling-roc</a></p>
<p>If you want to try it out... </p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>zig<span class="w"> </span>build-obj<span class="w"> </span>host/app.zig
$<span class="w"> </span>zig<span class="w"> </span>build-lib<span class="w"> </span>host/main.zig
$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>app.o<span class="w"> </span>libmain.a
$<span class="w"> </span>./app
info:<span class="w"> </span>Running<span class="w"> </span>Roc<span class="w"> </span>APP
Hello
</code></pre></div>
<p>There are a few things different from the current way we do things, and we've tried to implement the ideal based on our previous design discussions. </p>
<p>Now would be a good time to discuss the API, and if there are ways we can improve things.</p>



<a name="497815492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497815492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497815492">(Feb 05 2025 at 06:09)</a>:</h4>
<p>I wouldn't advise looking closely at <code>host/app.zig</code> -- it's a real hack and some scary internal things that would never be exposed to the general public. </p>
<p>It's better to look at <code>platform/app.roc</code> which is the example and pretend the compiler generated our <code>app.o</code> object file and linked it with the prebuilt-host <code>libmain.a</code> all behind the scenes.</p>



<a name="497817290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497817290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497817290">(Feb 05 2025 at 06:26)</a>:</h4>
<p>Two immediate painpoints I noticed (carry overs from the old api):</p>
<ol>
<li>dealloc not having a size means that the allocator has to track the size. In the case of zig, this means we allocate an extra usize before every allocation to store the size.</li>
<li>Alignment is not useful cause zig only takes it as a comptime value (I guess you could manually toggle between all the alignments, but it isn't as nice). Also, in practice, everything will be aligned to 8 or 16, so no real gains.</li>
</ol>



<a name="497817466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497817466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497817466">(Feb 05 2025 at 06:28)</a>:</h4>
<p>One silly thing I noticed:<br>
    Always using pointers means that a number of functions with trivial args or return types have ABIs that look really poor. Look at the string functions especially.</p>



<a name="497821515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497821515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497821515">(Feb 05 2025 at 07:04)</a>:</h4>
<p>The pain points I've ran into trying to write a Zig platform and using a Zig allocator for Roc memory allocation. For Zig platform code it'd be really nice if the roc allocation API were ziggier, saves quite a bit of work! I guess that comes at the cost of writing platforms in other languages, though it does seem like it might be easier to implement malloc on top of a zig allocator then the other way around.</p>



<a name="497822337"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497822337" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497822337">(Feb 05 2025 at 07:12)</a>:</h4>
<p>Yeah, I think We will always be anchoring to cffi. Looking at the new example, apparate from passing the size to dealloc, I'm not sure we could make it ziggier.</p>



<a name="497822398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497822398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497822398">(Feb 05 2025 at 07:12)</a>:</h4>
<p>We can't give it a comptime alignment cause cffi can't comptime</p>



<a name="497822426"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497822426" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497822426">(Feb 05 2025 at 07:12)</a>:</h4>
<p>You can directly use an arena or other zig allocator now.</p>



<a name="497822467"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497822467" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497822467">(Feb 05 2025 at 07:13)</a>:</h4>
<p>We give enough info for most of the calls....free is the only pain point I think.</p>



<a name="497823247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497823247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497823247">(Feb 05 2025 at 07:19)</a>:</h4>
<p>And I currently don't know how to solve free except my making every list and string allocation 4 to 8 bytes larger to store the size.</p>
<p>Instead with the example platform, we end up making all allocations 4 to 8 bytes larger (including recursive tags and boxes).</p>
<p>Note, with arena allocation, this extra size would go away.</p>
<p>When using an allocator that implicitly tracks the size, allocations are not made any larger at all.</p>



<a name="497823282"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497823282" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497823282">(Feb 05 2025 at 07:20)</a>:</h4>
<p>I wonder if we can somehow get some allocator internal info on size information and avoid this explicit tracking</p>



<a name="497824473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497824473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497824473">(Feb 05 2025 at 07:28)</a>:</h4>
<p>Ah, thanks for explaining, that makes a lot of sense.</p>
<p>I guess it's not so bad, we can write a Zig-&gt;Roc allocator helper once and then anyone writing a Zig platform can use that. Maybe it'd be the kind of thing to include in Luke's platform examples repo.</p>



<a name="497827448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497827448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497827448">(Feb 05 2025 at 07:48)</a>:</h4>
<p>Yeah, I think we could easily make something that wraps a zig allocator to make it track size. And as mentioned above for arenas and for allocators that already internally track size (if you can get access to the internals), you can avoid adding the size to the allocation.</p>



<a name="497889985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497889985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497889985">(Feb 05 2025 at 13:14)</a>:</h4>
<p>I have written one here: </p>
<p><a href="https://github.com/ostcar/roc-aoc-platform/blob/main/host/RocAllocator.zig">https://github.com/ostcar/roc-aoc-platform/blob/main/host/RocAllocator.zig</a></p>
<p>It probably can be improved</p>



<a name="497916332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497916332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497916332">(Feb 05 2025 at 15:11)</a>:</h4>
<p>over the years we've gone back and forth regarding whether it would be possible for Roc to pass the total allocation size to dealloc automatically</p>



<a name="497916416"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497916416" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497916416">(Feb 05 2025 at 15:11)</a>:</h4>
<p>I think whether or not it was possible depended on some seamless slice implementation details?</p>



<a name="497916585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497916585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497916585">(Feb 05 2025 at 15:12)</a>:</h4>
<p>and I thought we ended up in a place where we actually did always have the info on the Roc side and could pass it to dealloc, but maybe I'm misremembering <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="497935478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497935478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497935478">(Feb 05 2025 at 16:34)</a>:</h4>
<p>Yeah, I always end up thinking we can. Then I realize that we store the number of live elements on the heap for refcounted seamless slices. That is not the size. The size is the full capacity, which a seamless slice has no way to get.</p>



<a name="497963571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497963571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497963571">(Feb 05 2025 at 19:02)</a>:</h4>
<p>ahhh right</p>



<a name="497963617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497963617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497963617">(Feb 05 2025 at 19:02)</a>:</h4>
<p>yeah I remember thinking this changed when we changed the representation of how that's stored in memory</p>



<a name="497963637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/497963637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#497963637">(Feb 05 2025 at 19:03)</a>:</h4>
<p>but I think we actually ended up with a representation where we <em>don't</em> know it</p>



<a name="519246304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/519246304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#519246304">(May 19 2025 at 23:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/497815218">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> and I have been cooking... we've put together a working prototype of <code>roc build</code> with an example platform, and a fake roc <code>app.o</code> object file. </p>
<p>All the files are sitting on this branch. We will probably migrate into the roc repo -- now that it's less of a hack. I've included some explanation and notes in the README in case that helps.</p>
<p><a href="https://github.com/lukewilliamboswell/roc-platform-template-zig/tree/calling-roc">https://github.com/lukewilliamboswell/roc-platform-template-zig/tree/calling-roc</a></p>
<p>If you want to try it out... </p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>zig<span class="w"> </span>build-obj<span class="w"> </span>host/app.zig
$<span class="w"> </span>zig<span class="w"> </span>build-lib<span class="w"> </span>host/main.zig
$<span class="w"> </span>zig<span class="w"> </span>build-exe<span class="w"> </span>app.o<span class="w"> </span>libmain.a
$<span class="w"> </span>./app
info:<span class="w"> </span>Running<span class="w"> </span>Roc<span class="w"> </span>APP
Hello
</code></pre></div>
<p>There are a few things different from the current way we do things, and we've tried to implement the ideal based on our previous design discussions. </p>
<p>Now would be a good time to discuss the API, and if there are ways we can improve things.</p>
</blockquote>
<p>I'm looking at Richard's PR <a href="https://github.com/roc-lang/roc/pull/7795">https://github.com/roc-lang/roc/pull/7795</a> and thinking about this work we did. I wonder if our design has evolved much from this and if it's worth updating this again so we have a test platform ready to go.</p>



<a name="519248130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/519248130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#519248130">(May 19 2025 at 23:33)</a>:</h4>
<p>I think it is mostly the same, but yeah, some minor differences</p>



<a name="525443137"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/525443137" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#525443137">(Jun 24 2025 at 05:16)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> -- I started writing this as a comment in that other thread... <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> </p>
<p>We're fast approaching the point where I'd like to pick your brains on how to actually implement this interpreter shim thing. We're really close to having single module/expression evaluation working in a simple form. </p>
<p>What comes next is fuzzy for me, particularly with the platform integration.</p>
<p>I'm of the opinion that the platform supplies a host executable that has embedded a roc compiler/interpreter (libroc) which can be used to load, compile, and execute <code>.roc</code> code and call relevant platform provided IO/effects.</p>
<p>Running an app using the roc cli, i.e <code>roc my_demo_app.roc</code>, roc is then calling this platform supplied executable and passing through the arguments (<code>my_demo_app.roc</code> etc) for the interpreter to run.</p>



<a name="525443527"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/525443527" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#525443527">(Jun 24 2025 at 05:22)</a>:</h4>
<p>Alternatively, I think is the intended design is that the roc cli compiles the app into a canonical IR (including comp-time eval etc) then produces a static library (with the builtin bitcode included) that represents the <code>app.o</code> part. </p>
<p>From a platform's perspective they could be calling a fully compiled app (and optimised using LLVM) <code>app.o</code>, however internally it is using an interpreter at runtime to evaluate the code when the host calls into roc.</p>



<a name="525443911"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/525443911" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#525443911">(Jun 24 2025 at 05:27)</a>:</h4>
<p>Yeah, it will be interesting making the shim and getting this all working together</p>



<a name="525443963"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/525443963" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#525443963">(Jun 24 2025 at 05:28)</a>:</h4>
<p>I have ideas, but will be interesting to see if it works how I expect when we implement it in practice</p>



<a name="529178058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529178058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529178058">(Jul 16 2025 at 22:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/316715-contributing/topic/Pull.20Request.20for.20Review/near/529088676">said</a>:</p>
<blockquote>
<p>Nice base doc. One note, we don't want to hardcode the entry point. There can be many, but that is just a minor note.</p>
</blockquote>
<p>FYSA we are cooking a plan to have a single entrypoint to start with, to simplify the integration and get things working. </p>
<p>If we can get the <code>llvm-objcopy</code> library working like we have for <code>lld</code> then Richard has an idea for supporting up to N (say 256) entrypoints by renaming the symbols in our interpreter shim before the cli links with the platform host for combined interpreter executable.</p>



<a name="529178199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529178199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529178199">(Jul 16 2025 at 22:56)</a>:</h4>
<p>That way the platform author doesn't need to change anything. they provide a static library e.g. <code>host.a</code> and then the roc cli can link that with either the interpreter shim (i.e. roc run for fast dev loop), or with the LLVM optimised machine code and there is no difference.</p>



<a name="529178371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529178371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529178371">(Jul 16 2025 at 22:58)</a>:</h4>
<p>I had a couple of questions that came up yesterday that I wanted to get down while I'm thinking of it.</p>



<a name="529178375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529178375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529178375">(Jul 16 2025 at 22:58)</a>:</h4>
<p>Do we want to change <code>roc_dealloc</code> to include the size of the allocation. I realised without this we need to track the size of allocations manually in the host in order to play nicely with Zig's allocators. </p>
<p>I remember <span class="user-mention" data-user-id="496321">@Oskar Hahn</span> had something similar when we was building a Go platform.</p>



<a name="529178610"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529178610" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529178610">(Jul 16 2025 at 23:00)</a>:</h4>
<p>If <code>roc_alloc</code> is being passed into Roc... does this change the zig builtins? </p>
<p>We currently assume that <code>roc_alloc</code> is linked and available globally, but it's just a function pointer now. </p>
<p>I need to explore this further... so this question may not make much sense.</p>



<a name="529178735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529178735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529178735">(Jul 16 2025 at 23:02)</a>:</h4>
<p>Should we link libC with our interpreter shim? I wasn't sure if we needed it or if it made any difference.</p>



<a name="529178826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529178826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529178826">(Jul 16 2025 at 23:03)</a>:</h4>
<p>6 messages were moved here from <a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/casual.20conversation/with/528948872">#compiler development &gt; casual conversation</a> by <span class="user-mention silent" data-user-id="515757">Luke Boswell</span>.</p>



<a name="529180322"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529180322" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529180322">(Jul 16 2025 at 23:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/529178058">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/316715-contributing/topic/Pull.20Request.20for.20Review/near/529088676">said</a>:</p>
<blockquote>
<p>Nice base doc. One note, we don't want to hardcode the entry point. There can be many, but that is just a minor note.</p>
</blockquote>
<p>FYSA we are cooking a plan to have a single entrypoint to start with, to simplify the integration and get things working. </p>
<p>If we can get the <code>llvm-objcopy</code> library working like we have for <code>lld</code> then Richard has an idea for supporting up to N (say 256) entrypoints by renaming the symbols in our interpreter shim before the cli links with the platform host for combined interpreter executable.</p>
</blockquote>
<p>I found a better way btw; can add symbols and it'll be fine</p>



<a name="529180401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529180401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529180401">(Jul 16 2025 at 23:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/529178610">said</a>:</p>
<blockquote>
<p>If <code>roc_alloc</code> is being passed into Roc... does this change the zig builtins? </p>
<p>We currently assume that <code>roc_alloc</code> is linked and available globally, but it's just a function pointer now. </p>
</blockquote>
<p>you're correct! We'll have to change all of them to accept function pointers to roc_alloc etc</p>



<a name="529186908"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529186908" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529186908">(Jul 17 2025 at 01:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/529178199">said</a>:</p>
<blockquote>
<p>That way the platform author doesn't need to change anything. they provide a static library e.g. <code>host.a</code> and then the roc cli can link that with either the interpreter shim (i.e. roc run for fast dev loop), or with the LLVM optimised machine code and there is no difference.</p>
</blockquote>
<p>I don't understand this. Even with 500 entry points, the platform author shouldn't need to change anything</p>



<a name="529187296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529187296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529187296">(Jul 17 2025 at 01:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/529178375">said</a>:</p>
<blockquote>
<p>Do we want to change <code>roc_dealloc</code> to include the size of the allocation. I realised without this we need to track the size of allocations manually in the host in order to play nicely with Zig's allocators. </p>
<p>I remember <span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> had something similar when we was building a Go platform.</p>
</blockquote>
<p>I forget what we decided here. Either we need to modify lists to store size of the allocation on the heap...or we need the platform to do it.</p>



<a name="529188156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529188156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529188156">(Jul 17 2025 at 01:19)</a>:</h4>
<p>That's helpful context. I might try and dig out our conversation about it. </p>
<p>I'm thinking we should aim to make this as friendly as possible for platform dev as long as it's not a massive performance cost. It sounds like the information needs to be saved anyway, if roc does it internally we can be sure it's done correctly I guess.</p>



<a name="529188672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529188672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529188672">(Jul 17 2025 at 01:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/529187296">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/529178375">said</a>:</p>
<blockquote>
<p>Do we want to change <code>roc_dealloc</code> to include the size of the allocation. I realised without this we need to track the size of allocations manually in the host in order to play nicely with Zig's allocators. </p>
<p>I remember <span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> had something similar when we was building a Go platform.</p>
</blockquote>
<p>I forget what we decided here. Either we need to modify lists to store size of the allocation on the heap...or we need the platform to do it.</p>
</blockquote>
<p>yeah I think the host should do it</p>



<a name="529188707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529188707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529188707">(Jul 17 2025 at 01:28)</a>:</h4>
<p>the thing is, a lot of allocators store size on every allocation anyway, and so it's wasteful for us to automatically store it again</p>



<a name="529188750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529188750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529188750">(Jul 17 2025 at 01:29)</a>:</h4>
<p>but for allocators that don't do that, they can just have their <code>roc_alloc</code> implementation store an extra <code>usize</code> for the size and write it in there before they return the pointer (to right after the <code>usize</code> they stored)</p>



<a name="529188771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529188771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529188771">(Jul 17 2025 at 01:29)</a>:</h4>
<p>and then during deallocation they can just look right in front of the allocation to find the <code>usize</code> that they stored earlier in <code>roc_alloc</code></p>



<a name="529188788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529188788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529188788">(Jul 17 2025 at 01:29)</a>:</h4>
<p>we can and should pass the alignment though</p>



<a name="529188838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529188838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529188838">(Jul 17 2025 at 01:30)</a>:</h4>
<p>because that's statically known, and it helps any <code>roc_alloc</code> author who's doing that trick avoid having to conservatively allocate space for the count</p>



<a name="529190757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529190757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529190757">(Jul 17 2025 at 02:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc/near/529188707">said</a>:</p>
<blockquote>
<p>the thing is, a lot of allocators store size on every allocation anyway, and so it's wasteful for us to automatically store it again</p>
</blockquote>
<p>To be fair, I think it is often know for small allocations, but not always tracked for large allocations... But in general, yeah, allocators tend to track it cause they are based on the malloc api</p>



<a name="529202322"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20calling%20roc/near/529202322" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20calling.20roc.html#529202322">(Jul 17 2025 at 04:54)</a>:</h4>
<p>Ok, sounds good <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
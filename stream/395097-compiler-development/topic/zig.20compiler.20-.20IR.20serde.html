<html>
<head><meta charset="utf-8"><title>zig compiler - IR serde · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html">zig compiler - IR serde</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="499994188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/499994188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#499994188">(Feb 16 2025 at 09:08)</a>:</h4>
<p>Hi! I'm starting on function specialization. I'd like to create a test that has the correct input data in it. Since I'm at the veeery beginning of learning, can someone give me an example how I could build up an IR in zig manually (with module Env all that)? Just for example this code:</p>
<div class="codehilite"><pre><span></span><code>increment = |num| num + 1

main = || {
    x = 2
    increment(x)
}
</code></pre></div>
<p>I will be available after the usual Sunday family dinner :)</p>



<a name="499995222"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/499995222" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#499995222">(Feb 16 2025 at 09:25)</a>:</h4>
<p>The best approach seems to be creating an S-expr parser and printer for each IR</p>



<a name="499995471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/499995471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#499995471">(Feb 16 2025 at 09:29)</a>:</h4>
<p>We could manually create nodes, but that's probably more trouble than it's worth</p>



<a name="499995692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/499995692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#499995692">(Feb 16 2025 at 09:33)</a>:</h4>
<p>If you really want to go that way, let me know and I can make a branch with an example</p>



<a name="500011710"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500011710" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500011710">(Feb 16 2025 at 13:39)</a>:</h4>
<p>I agree a serializable format would be better. I guess there's no need for me to rush straight to tackling specialization, if there are things that would make it easier.</p>



<a name="500022213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500022213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500022213">(Feb 16 2025 at 16:10)</a>:</h4>
<p>Any chance we can share one printer/parser?</p>



<a name="500022230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500022230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500022230">(Feb 16 2025 at 16:11)</a>:</h4>
<p>Are the IRs similar enough?</p>



<a name="500022391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500022391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500022391">(Feb 16 2025 at 16:13)</a>:</h4>
<p>From a quick look, yes, they seem pretty similar. At least from what I have seen, in function lift and  function solve IR. But after reading Ayas' document, they should be the same as they are just more and more simplified versions of one-another.</p>



<a name="500022679"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500022679" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500022679">(Feb 16 2025 at 16:17)</a>:</h4>
<p>I more meant in datastructure form such that a tiny bit of zig comptime could deal with any of them for printing and parsing. And I know they all should have similar datastrtutures. Just not sure if they are close enough in practice.</p>



<a name="500023040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500023040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500023040">(Feb 16 2025 at 16:23)</a>:</h4>
<p>You mean creating a general IRPrinter that can take any of the IR's and spit out the correct strings? (Same for the parse)</p>



<a name="500023092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500023092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500023092">(Feb 16 2025 at 16:23)</a>:</h4>
<p>Yeah</p>



<a name="500023224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500023224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500023224">(Feb 16 2025 at 16:25)</a>:</h4>
<p>Given we have so many IRs and they are all laid out very similar, sounds doable</p>



<a name="500023504"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500023504" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500023504">(Feb 16 2025 at 16:29)</a>:</h4>
<p>I see. Would be cool and should strive for it I think! I just started to work on a printer. I'm still in the Zig phase of "What.. a file is a struct?", so I don't know when that will be usable. Right now my plan is to create 'serialize' functions on all the base.zig types. They would take a std.io.AnyWriter as argument. Once I can print those, I can widen my horizon.</p>



<a name="500024945"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500024945" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500024945">(Feb 16 2025 at 16:48)</a>:</h4>
<p>Sure</p>



<a name="500024952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500024952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500024952">(Feb 16 2025 at 16:48)</a>:</h4>
<p>Exploration is good right now in general</p>



<a name="500029687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500029687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500029687">(Feb 16 2025 at 17:45)</a>:</h4>
<p>My thinking was to create a generic sexpr parser, and have each IR be constructable from that sexpr representation. Similarly for printing - irs only need to know how to output sexpr nodes.</p>



<a name="500030355"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500030355" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500030355">(Feb 16 2025 at 17:55)</a>:</h4>
<p>Do I understand it correctly that Sexpr would be an Intermediate representation for all the intermadiate representations during serialization / deserialization <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> ? So we would go from {check_IR, lift_IR, ...}-&gt;Sexpr-&gt;String and similarly backwards</p>



<a name="500030620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500030620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500030620">(Feb 16 2025 at 17:58)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="395097" href="/#narrow/channel/395097-compiler-development/topic/help.20creating.20a.20basic.20IR">#compiler development &gt; help creating a basic IR</a> by <span class="user-mention silent" data-user-id="577599">Norbert Hajagos</span>.</p>



<a name="500030839"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500030839" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500030839">(Feb 16 2025 at 18:01)</a>:</h4>
<p>Yep, that was my thought</p>



<a name="500030851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500030851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500030851">(Feb 16 2025 at 18:01)</a>:</h4>
<p>I like that</p>



<a name="500030888"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500030888" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500030888">(Feb 16 2025 at 18:01)</a>:</h4>
<p>That'll let us have one parser and one pretty-printer</p>



<a name="500035833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500035833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500035833">(Feb 16 2025 at 19:09)</a>:</h4>
<p>How do you think a common printer and parser would be implemented in Zig? I don’t have a clear idea how that would work</p>



<a name="500036194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500036194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500036194">(Feb 16 2025 at 19:13)</a>:</h4>
<p>Sounds like they were thinking just making a generic intermediate IR. Then having everything go to/from that data structure.</p>



<a name="500036325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500036325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500036325">(Feb 16 2025 at 19:15)</a>:</h4>
<p>Otherwise, you can do interfaces by doing what allocators do with essentially a vtable. Could make one that every ir implements that is used for printing/parsing</p>



<a name="500036355"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500036355" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500036355">(Feb 16 2025 at 19:15)</a>:</h4>
<p>Lastly, by making comptime interfaces, you essentially have traits from rust</p>



<a name="500040106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500040106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500040106">(Feb 16 2025 at 19:57)</a>:</h4>
<p>When we are spinning this up, if anyone needs help with zig interfaces and what not, let me know. I think if you design the interface as you see fit ignoring zig, I can help translate to zig.</p>



<a name="500040622"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500040622" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500040622">(Feb 16 2025 at 20:03)</a>:</h4>
<p>I'll be cooking up something then and put progress updates in this thread.</p>



<a name="500042083"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500042083" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500042083">(Feb 16 2025 at 20:25)</a>:</h4>
<p>I already have a zig question <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span> <br>
The type of base.Literal.String is of collections.interner.StringLiteral <br>
I wanted to experiment with printing each kind of literal, but the StringLiteral type doesn't seem to hold any value. It's only a namespace for the Idx and the Interner type. I undestand that with the combination of an interner and an index, i can query the string value, but does the current representation of base.Literal.String doesn't have either, so it holds 0 information. </p>
<p>Should the base.Literal.String be of type collections.interner.StringLiteral.Idx, or am I missing something?</p>



<a name="500042490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500042490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500042490">(Feb 16 2025 at 20:30)</a>:</h4>
<p>The IRs in those later build stages are mostly a placeholder. It's possible it just doesn't make sense. Im afk rn but can help poke at it in a couple of hours.</p>



<a name="500042739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500042739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500042739">(Feb 16 2025 at 20:33)</a>:</h4>
<p>Thanks, but in a couple of hours, I'll already be sleeping <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span>. Think I'll just change it to Idx, see how things will puzzle out.</p>



<a name="500042800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500042800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500042800">(Feb 16 2025 at 20:34)</a>:</h4>
<p>Yes, it should be Idx</p>



<a name="500042858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500042858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500042858">(Feb 16 2025 at 20:35)</a>:</h4>
<p>The lazy compilation thing has been pretty tricky for starting this project, though I'm sure it'll not be as annoying in a couple weeks</p>



<a name="500043009"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500043009" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500043009">(Feb 16 2025 at 20:37)</a>:</h4>
<p>It feels so good to slowly get a hold on what's happening!</p>
<p>You mean the modules not being connected and thus not checked?</p>



<a name="500043281"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500043281" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500043281">(Feb 16 2025 at 20:40)</a>:</h4>
<p>Yep</p>



<a name="500051470"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500051470" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500051470">(Feb 16 2025 at 22:41)</a>:</h4>
<p>As I was exploring, I stumbled upon a memory leak in the string interner. Fixed it on <a href="https://github.com/roc-lang/roc/commit/7672bd7d64fdc45518d6f2fc8cbb1e0e7c23ade9#diff-a6612772b67c70357d50a4668fe4b9eddc1f4b22752213bba61cf4ef2262062b">my branch</a> (testing allocator is so good, just running <code>zig build test</code> does the job).<br>
But... it just feels wrong to loop through strings and free them one-by-one. After all these times of hearing about them, I'm pretty sure this is where I'd need an arena. I tried to wrap the interner's allocator in one, but it kept leaking anyways, so I'm asking if any one of you could guide me here. </p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Faild attempt at using arena:</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">Interner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">strings</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">([]</span><span class="kt">u8</span><span class="p">),</span>
<span class="w">    </span><span class="n">arena</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ArenaAllocator</span><span class="p">,</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">Allocator</span><span class="p">)</span><span class="w"> </span><span class="n">Interner</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">var</span><span class="w"> </span><span class="n">arena</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">ArenaAllocator</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Interner</span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">strings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">ArrayList</span><span class="p">([]</span><span class="kt">u8</span><span class="p">).</span><span class="n">init</span><span class="p">(</span><span class="n">arena</span><span class="p">.</span><span class="n">allocator</span><span class="p">()),</span>
<span class="w">            </span><span class="p">.</span><span class="n">arena</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arena</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">deinit</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">Interner</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">arena</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">insert</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">Interner</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="n">Idx</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
<span class="w">        </span><span class="kr">const</span><span class="w"> </span><span class="n">copied_string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">arena</span><span class="p">.</span><span class="n">allocator</span><span class="p">().</span><span class="n">alloc</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="n">exitOnOom</span><span class="p">();</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">mem</span><span class="p">.</span><span class="n">copyForwards</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">copied_string</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">);</span>

<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">copied_string</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="n">exitOnOom</span><span class="p">();</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">@enumFromInt</span><span class="p">(</span><span class="nb">@as</span><span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="nb">@intCast</span><span class="p">(</span><span class="n">len</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">Interner</span><span class="p">,</span><span class="w"> </span><span class="n">idx</span><span class="o">:</span><span class="w"> </span><span class="n">Idx</span><span class="p">)</span><span class="w"> </span><span class="p">[]</span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">items</span><span class="p">[</span><span class="nb">@as</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="nb">@intFromEnum</span><span class="p">(</span><span class="n">idx</span><span class="p">))];</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
</div></div>
<p>Was a fun weekend on the compiler, tomorrow I'll catch up. Bye!</p>



<a name="500051956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500051956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500051956">(Feb 16 2025 at 22:48)</a>:</h4>
<p>yeah I think we need arenas for everything, including string interning, so that we can serialize them <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="500051983"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500051983" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500051983">(Feb 16 2025 at 22:48)</a>:</h4>
<p>I guess except like...scratch allocations that aren't going to end up being serialized maybe</p>



<a name="500051985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500051985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500051985">(Feb 16 2025 at 22:48)</a>:</h4>
<p>Yep</p>



<a name="500051998"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500051998" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500051998">(Feb 16 2025 at 22:49)</a>:</h4>
<p>I think having some naming pattern around <code>scratch_arena</code> vs. just <code>arena</code> could help there</p>



<a name="500052017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500052017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500052017">(Feb 16 2025 at 22:49)</a>:</h4>
<p>Since Zig seems to lean into the <code>gpa</code> meaning "use a general-purpose allocator here" naming convention</p>



<a name="500052084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500052084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500052084">(Feb 16 2025 at 22:50)</a>:</h4>
<p>yeah I'm not sure if we want gpa or not for those</p>



<a name="500052119"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500052119" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500052119">(Feb 16 2025 at 22:50)</a>:</h4>
<p><span class="user-mention" data-user-id="406911">@Andrew Kelley</span> pointed out that bump arenas are not conducive to arraylists that need to resize because they're super unlikely to be able to resize in-place</p>



<a name="500052136"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500052136" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500052136">(Feb 16 2025 at 22:50)</a>:</h4>
<p>whereas I guess with a gpa it's more likely</p>



<a name="500052145"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500052145" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500052145">(Feb 16 2025 at 22:51)</a>:</h4>
<p>I'm not sure how to think about the tradeoffs there <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="500055363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055363">(Feb 16 2025 at 23:38)</a>:</h4>
<p>We want gpa or c allocator for all the arraylists</p>



<a name="500055376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055376">(Feb 16 2025 at 23:39)</a>:</h4>
<p>We want arenas for basically everything else</p>



<a name="500055424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055424">(Feb 16 2025 at 23:39)</a>:</h4>
<p>For arraylists, the amortization of growing by 1.5 to 2x and reasonable capacity defaults will make it cheap</p>



<a name="500055515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055515">(Feb 16 2025 at 23:40)</a>:</h4>
<p>Likely arenas we just have to be careful minorly of lifetimes.</p>



<a name="500055618"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055618" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055618">(Feb 16 2025 at 23:42)</a>:</h4>
<p>Yeah, and I think we should have a pattern of all allocators being named <code>arena</code> or <code>gpa</code>. I guess we could get more fine grain, but that is likely enough by context of the datastructure. Like the parsing arena won't out live the parsing IR.</p>



<a name="500055797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055797">(Feb 16 2025 at 23:44)</a>:</h4>
<p>well everything that's going to be serialized needs to use the arena</p>



<a name="500055959"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055959" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055959">(Feb 16 2025 at 23:46)</a>:</h4>
<p>There will be one arena for that which <code>CanIR</code> will own, and it'll get provided to each module's <code>ModuleEnv</code> as their allocator. We should call the allocator for <code>ModuleEnv</code> "arena" to make that more obvious</p>



<a name="500055978"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500055978" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500055978">(Feb 16 2025 at 23:47)</a>:</h4>
<p>And by <code>CanIR</code> owning the arena, then the serialization work just falls out of that for free</p>



<a name="500056084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056084">(Feb 16 2025 at 23:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500055797">said</a>:</p>
<blockquote>
<p>well everything that's going to be serialized needs to use the arena</p>
</blockquote>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span>??? Why?</p>



<a name="500056087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056087">(Feb 16 2025 at 23:48)</a>:</h4>
<p>So <code>parse</code> will intern data into the <code>CanIR</code> arena but put its IR into a different allocator's memory, canonicalize will put its intern data (e.g. generated idents created during desugaring) into the arena</p>



<a name="500056108"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056108" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056108">(Feb 16 2025 at 23:49)</a>:</h4>
<p>If everything is in a single arena, then we get (de)serialization for free</p>



<a name="500056113"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056113" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056113">(Feb 16 2025 at 23:49)</a>:</h4>
<p>They just need to use indices instead or pointers</p>



<a name="500056222"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056222" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056222">(Feb 16 2025 at 23:50)</a>:</h4>
<p>So if there's a single data structure, <code>CanIR</code>, in the arena, which includes the <code>ModuleEnv</code>, then we can just treat that arena as binary data that goes into/out of the cache</p>



<a name="500056266"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056266" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056266">(Feb 16 2025 at 23:51)</a>:</h4>
<p>The ir needs to be in a gpa or you will hit big pains on growth. On top of that, if your arena has tons of gaps, you don't want to serialize it.</p>



<a name="500056287"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056287" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056287">(Feb 16 2025 at 23:52)</a>:</h4>
<p>IR for everything besides canonicalization would be in a GPA</p>



<a name="500056330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056330">(Feb 16 2025 at 23:52)</a>:</h4>
<p>I think it is better to think of serialization as writing out a struct containing each of the core arrays of data. Each array only uses indices and not pointers and thus can just be copied to disk.</p>



<a name="500056376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056376">(Feb 16 2025 at 23:52)</a>:</h4>
<p>I would not consider serializing arenas. They will have tons of gaps and garbage data from intermediates.</p>



<a name="500056393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056393">(Feb 16 2025 at 23:53)</a>:</h4>
<p>Also, references to data in an arena are still pointers (thus not safe to just serialize)</p>



<a name="500056408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056408">(Feb 16 2025 at 23:53)</a>:</h4>
<p>There should be no references in the arena, I agree</p>



<a name="500056470"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056470" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056470">(Feb 16 2025 at 23:54)</a>:</h4>
<p>All intermediates besides arraylist's backing arrays should be created within other allocators</p>



<a name="500056478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056478">(Feb 16 2025 at 23:54)</a>:</h4>
<p>So a perf question:</p>



<a name="500056529"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056529" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056529">(Feb 16 2025 at 23:55)</a>:</h4>
<p>Which would be faster: creating an <code>mmap</code>ed arena that we don't have to serialize, or using a <code>gpa</code> to get a more compact memory backing for the serialized data and then manually copying to/from the cache?</p>



<a name="500056556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056556">(Feb 16 2025 at 23:55)</a>:</h4>
<p>Because I don't think we can just <code>mmap</code> a file in the second case</p>



<a name="500056628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056628">(Feb 16 2025 at 23:56)</a>:</h4>
<p>But if it's similar perf, then maybe the arena-based approach isn't worth the effort</p>



<a name="500056632"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056632" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056632">(Feb 16 2025 at 23:56)</a>:</h4>
<p>(deleted)</p>



<a name="500056657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056657">(Feb 16 2025 at 23:56)</a>:</h4>
<p>Wrong button clicked...</p>



<a name="500056660"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056660" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056660">(Feb 16 2025 at 23:56)</a>:</h4>
<p>Since it would create a larger cache artifact to use the arena, as you say</p>



<a name="500056662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056662">(Feb 16 2025 at 23:56)</a>:</h4>
<p>Meant to edit not delete</p>



<a name="500056843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056843">(Feb 16 2025 at 23:59)</a>:</h4>
<p>How I see it working.</p>
<ol>
<li>Allocate with gpa for growing things and arenas for everything else. Everything should use indices not pointers.</li>
<li>Writing out to cache will require moving data to disk and writing everything out flat. Should just be a couple of really big mem copies and quite cheap</li>
<li>When reloading, growth will not be needed, so can just mmap and then get slices to the correct data for each array.</li>
</ol>



<a name="500056875"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056875" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056875">(Feb 17 2025 at 00:00)</a>:</h4>
<p>I for sure agree if this approach is about as performant as Richard's idea</p>



<a name="500056996"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500056996" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500056996">(Feb 17 2025 at 00:00)</a>:</h4>
<p>I've been presuming Richard's way must be faster for us to consider it, but that may very well be wrong</p>



<a name="500057209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057209">(Feb 17 2025 at 00:02)</a>:</h4>
<p>so briefly, the whole goal of the serialization is that reading a cache into memory is 2 syscalls: open the file, and then read it into memory. That's it, there's no parsing step whatsoever - once it's in memory, it is already ready to use normally</p>



<a name="500057284"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057284" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057284">(Feb 17 2025 at 00:03)</a>:</h4>
<p>Yes</p>



<a name="500057361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057361">(Feb 17 2025 at 00:04)</a>:</h4>
<p>I'm not sure how that works outside of an arena <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="500057388"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057388" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057388">(Feb 17 2025 at 00:05)</a>:</h4>
<p>Well, you may want to do some minor range processing to get zig slices instead of raw offsets for some things, but that is derived from the raw mmap</p>



<a name="500057474"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057474" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057474">(Feb 17 2025 at 00:06)</a>:</h4>
<p>the thing is, in bigger projects (where compile times are noticeable) reading from cache is going to be overwhelmingly how things get loaded into memory</p>



<a name="500057545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057545">(Feb 17 2025 at 00:06)</a>:</h4>
<p>I think you think arenas solve an issue they don't</p>



<a name="500057589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057589">(Feb 17 2025 at 00:07)</a>:</h4>
<p>An arena is an linked list of chunks of memory allocated from another allocator</p>



<a name="500057610"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057610" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057610">(Feb 17 2025 at 00:07)</a>:</h4>
<p>Chunks are large and cheap to allocate.</p>



<a name="500057614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057614">(Feb 17 2025 at 00:07)</a>:</h4>
<p>oh 100% this doesn't work if the arena is backed by linked list haha</p>



<a name="500057621"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057621" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057621">(Feb 17 2025 at 00:07)</a>:</h4>
<p>has to be big virtual allocations</p>



<a name="500057645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057645">(Feb 17 2025 at 00:07)</a>:</h4>
<p>that reallocate and copy if necessary (like an arraylist does), which is fine if everything is indices</p>



<a name="500057712"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057712" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057712">(Feb 17 2025 at 00:08)</a>:</h4>
<p>I guess what I'm trying to say is separate initial construction from cache form.</p>



<a name="500057729"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057729" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057729">(Feb 17 2025 at 00:08)</a>:</h4>
<p>Initial construction will be fastest and easiest to do with large gpa backed arraylists</p>



<a name="500057758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057758">(Feb 17 2025 at 00:09)</a>:</h4>
<p>After done, you have a set of slices all using indicies and no pointers.</p>



<a name="500057770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057770">(Feb 17 2025 at 00:09)</a>:</h4>
<p>a critical part of the "2 syscalls" idea is that the very beginning of the allocation (as in, index zero) has to be the header which holds all the other arraylists (and then from there everything can be indices into those)</p>



<a name="500057784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057784">(Feb 17 2025 at 00:09)</a>:</h4>
<p>hm, but I guess writev can guarantee that actually <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="500057858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057858">(Feb 17 2025 at 00:10)</a>:</h4>
<p>Yes, when serializing, you do so flat (header of slice info) then all those slices constructed above with the gpa.</p>
<p>You serialize flat into a static sized file. This can be loaded with the two syscall approach</p>



<a name="500057884"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057884" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057884">(Feb 17 2025 at 00:10)</a>:</h4>
<p>ok separate question though: if we're running this persistently, and we've loaded something from cache, we explicitly don't want to dealloc everything individually</p>



<a name="500057895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057895">(Feb 17 2025 at 00:10)</a>:</h4>
<p>whereas we must do that if it's long-running (e.g. for language server)</p>



<a name="500057906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057906">(Feb 17 2025 at 00:10)</a>:</h4>
<p>I guess we can just have a flag of like</p>



<a name="500057923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057923">(Feb 17 2025 at 00:11)</a>:</h4>
<p>"this was loaded from cache, so dealloc it all at once"</p>



<a name="500057924"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057924" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057924">(Feb 17 2025 at 00:11)</a>:</h4>
<p>You can dealloc at the module level. Each module will have its own mmap or allocators</p>



<a name="500057935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500057935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500057935">(Feb 17 2025 at 00:11)</a>:</h4>
<p>yeah that seems reasonable!</p>



<a name="500058023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500058023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500058023">(Feb 17 2025 at 00:12)</a>:</h4>
<p>separately, I think we'll want to do some giant virtual alloc up front and then read all the cache entries into that</p>



<a name="500058080"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500058080" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500058080">(Feb 17 2025 at 00:13)</a>:</h4>
<p>well, that's in a batch build I guess</p>



<a name="500058085"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500058085" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500058085">(Feb 17 2025 at 00:13)</a>:</h4>
<p>prob not language server bc we might need to dealloc those</p>



<a name="500058648"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500058648" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500058648">(Feb 17 2025 at 00:21)</a>:</h4>
<p>I don't think it will make a difference</p>



<a name="500058776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500058776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500058776">(Feb 17 2025 at 00:23)</a>:</h4>
<p>MMaps are lazily loaded and page fault to load data. Force loading them into one big allocation would force being everything to be copied an extra time.</p>



<a name="500058817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500058817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500058817">(Feb 17 2025 at 00:23)</a>:</h4>
<p>It might be beneficial to load everything into CPU cache early, but if so, we can just force non-lazy loading of the mmaps</p>



<a name="500058933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500058933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500058933">(Feb 17 2025 at 00:25)</a>:</h4>
<p>And due to everything being handled at the page level anyway, doesn't really matter if we have "scattered" mmap pages or "linear" mmap pages. Both are totally up to the os virtual to physical page map to where they will actually be in memory</p>



<a name="500059355"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500059355" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500059355">(Feb 17 2025 at 00:31)</a>:</h4>
<p>As a note, the string intern probably needs to be two gpa backed arraylists. One of starts and lengths for the interned strings. And one flat U8 arraylists of string content. That will make serialization easy.</p>
<p>Aside, does string interning do deduplication if so, it probably also needs an hashmap of string to index it is inserted at. No need to serialize the hashmap cause the string intern will be finalized when serialized to disk.</p>



<a name="500059838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500059838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500059838">(Feb 17 2025 at 00:38)</a>:</h4>
<p>ah interesting, I hadn't been thinking of mmap for these</p>



<a name="500059841"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500059841" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500059841">(Feb 17 2025 at 00:38)</a>:</h4>
<p>that would change things <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="500061868"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500061868" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500061868">(Feb 17 2025 at 01:06)</a>:</h4>
<p>Oh, I thought the point of making a flat serializable datastructure was to enable mmaping them</p>



<a name="500061889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500061889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500061889">(Feb 17 2025 at 01:06)</a>:</h4>
<p>Oh, you mean the string interner specifically?</p>



<a name="500061945"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500061945" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500061945">(Feb 17 2025 at 01:07)</a>:</h4>
<p>We would either need to serialize the interner or would need to reference the original source to reload the strings</p>



<a name="500062037"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062037" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062037">(Feb 17 2025 at 01:08)</a>:</h4>
<p>I definitely figured we'd be serializing the interner, which would "own" the strings within the arena instead of referencing the source file or something</p>



<a name="500062082"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062082" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062082">(Feb 17 2025 at 01:09)</a>:</h4>
<p>Yeah, I agree. Makes sense to do so when serializing can ir.</p>



<a name="500062241"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062241" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062241">(Feb 17 2025 at 01:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500056843">said</a>:</p>
<blockquote>
<ol start="2">
<li>Writing out to cache will require moving data to disk and writing everything out flat. Should just be a couple of really big mem copies and quite cheap</li>
</ol>
</blockquote>
<p>btw this can be even cheaper than that! <code>writev</code> can let you skip the memcpys, and there's an equivalent on windows</p>



<a name="500062324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062324">(Feb 17 2025 at 01:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500061868">said</a>:</p>
<blockquote>
<p>Oh, I thought the point of making a flat serializable datastructure was to enable mmaping them</p>
</blockquote>
<p>I was just thinking of doing one big <code>read</code> on the whole thing</p>



<a name="500062358"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062358" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062358">(Feb 17 2025 at 01:12)</a>:</h4>
<p>Yeah, that sounds fine too (can test both and see which is faster, minor detail on how the data is loaded)</p>



<a name="500062392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062392">(Feb 17 2025 at 01:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500062241">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500056843">said</a>:</p>
<blockquote>
<ol start="2">
<li>Writing out to cache will require moving data to disk and writing everything out flat. Should just be a couple of really big mem copies and quite cheap</li>
</ol>
</blockquote>
<p>btw this can be even cheaper than that! <code>writev</code> can let you skip the memcpys, and there's an equivalent on windows</p>
</blockquote>
<p>Yeah, I said memcpy, but I really meant a copy to disk. Which would be writeev or whatever system call.</p>



<a name="500062405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062405">(Feb 17 2025 at 01:13)</a>:</h4>
<p>mmap on anything not in a tempdir always makes me nervous that some other process is going to delete the file while the mmap is active and cause chaos</p>



<a name="500062425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062425">(Feb 17 2025 at 01:13)</a>:</h4>
<p>although wait, didn't you say there's a setting that can prevent that? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="500062435"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062435" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062435">(Feb 17 2025 at 01:14)</a>:</h4>
<p>Someone deletes the roc cache while we are compiling</p>



<a name="500062473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062473">(Feb 17 2025 at 01:14)</a>:</h4>
<p>yeah</p>



<a name="500062584"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062584" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062584">(Feb 17 2025 at 01:15)</a>:</h4>
<p>Yeah, if so, reading is fine. Then less chance for failure at the cost of eagerly loading everything (which could actually be a perf gain, really depends on usage pattern). Could be worse for memory use, but maybe not in any sort of meaningful way.</p>



<a name="500062657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062657">(Feb 17 2025 at 01:16)</a>:</h4>
<p>But yeah, read or mmap or etc all sound fine and we can figure out the tradeoffs later.</p>



<a name="500062869"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062869" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062869">(Feb 17 2025 at 01:19)</a>:</h4>
<p>Sounds like mmap counts as an extra reference count on a file and it won't actually be deleted until the mmaps is closed (on Linux)</p>



<a name="500062870"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062870" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062870">(Feb 17 2025 at 01:19)</a>:</h4>
<p><a href="https://stackoverflow.com/questions/42961339/mmap-after-deleting-the-file#50376124">https://stackoverflow.com/questions/42961339/mmap-after-deleting-the-file#50376124</a></p>



<a name="500062937"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062937" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062937">(Feb 17 2025 at 01:20)</a>:</h4>
<p>So deleting it will remove it from the file tree, but the lnode wont be deleted until the file is until it is safe</p>



<a name="500062959"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500062959" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500062959">(Feb 17 2025 at 01:20)</a>:</h4>
<p>Would definitely want to test that behaviour to make sure or look it up in docs somewhere</p>



<a name="500063133"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063133" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063133">(Feb 17 2025 at 01:22)</a>:</h4>
<p>Oh, though mutation on an mmaped file still may affect things, but if a user is mutating cache files, that is their own problem</p>



<a name="500063158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063158">(Feb 17 2025 at 01:23)</a>:</h4>
<p>yeah I agree</p>



<a name="500063198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063198">(Feb 17 2025 at 01:23)</a>:</h4>
<p>mutating cache files is UB anyway</p>



<a name="500063210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063210">(Feb 17 2025 at 01:23)</a>:</h4>
<p>regardless of when you do it</p>



<a name="500063217"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063217" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063217">(Feb 17 2025 at 01:24)</a>:</h4>
<p>(in this case)</p>



<a name="500063263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063263">(Feb 17 2025 at 01:24)</a>:</h4>
<p>but deleting cache files should always be safe</p>



<a name="500063276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063276">(Feb 17 2025 at 01:24)</a>:</h4>
<p>so that sounds like a great option to me!</p>



<a name="500063365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063365">(Feb 17 2025 at 01:25)</a>:</h4>
<p>in that design the 2 syscalls are <code>open</code> and <code>mmap</code>, and then afterwards we can <code>munmap</code> if we're a language server and want to selectively clean up</p>



<a name="500063370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063370">(Feb 17 2025 at 01:25)</a>:</h4>
<p>this sounds awesome <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="500063605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500063605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500063605">(Feb 17 2025 at 01:28)</a>:</h4>
<p>Yep</p>



<a name="500073840"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500073840" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500073840">(Feb 17 2025 at 03:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500055515">said</a>:</p>
<blockquote>
<p>Likely arenas we just have to be careful minorly of lifetimes.</p>
</blockquote>
<p>ArrayList didn't grow this debug feature yet but some of the data structures such as hash maps have "pointer locks", so if you want to keep element pointers alive for a nontrivial amount of function call graph, you can do something like this:</p>
<div class="codehilite"><pre><span></span><code>map.lockPointers();
defer map.unlockPointers();
</code></pre></div>
<p>and it will crash if you called any of the non "assume capacity" methods. i.e. you get a crash instead of potential Use-After-Free</p>
<p>in release fast mode those are no-ops.</p>



<a name="500074000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500074000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500074000">(Feb 17 2025 at 03:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500057361">said</a>:</p>
<blockquote>
<p>I'm not sure how that works outside of an arena <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p><a href="https://codeberg.org/andrewrk/groovebasin/src/commit/9022521c445c2ba398f2f646aa24241ecd1a715a/shared/Db.zig#L576-L634">like this</a></p>



<a name="500074549"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500074549" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500074549">(Feb 17 2025 at 03:39)</a>:</h4>
<p>Thanks</p>



<a name="500074554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500074554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500074554">(Feb 17 2025 at 03:39)</a>:</h4>
<p>Yeah, that matches what I expected</p>



<a name="500074558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500074558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500074558">(Feb 17 2025 at 03:39)</a>:</h4>
<p>Also, cool debug feature</p>



<a name="500139568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500139568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500139568">(Feb 17 2025 at 10:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500059355">said</a>:</p>
<blockquote>
<p>As a note, the string intern probably needs to be two gpa backed arraylists. One of starts and lengths for the interned strings. And one flat U8 arraylists of string content. That will make serialization easy.</p>
<p>Aside, does string interning do deduplication if so, it probably also needs an hashmap of string to index it is inserted at. No need to serialize the hashmap cause the string intern will be finalized when serialized to disk.</p>
</blockquote>
<p>This is the comment above the StringLiteral.Interner:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">/// As opposed to the [IdentName.Interner], this interner does not</span>
<span class="c1">/// deduplicate its values because they are expected to be almost all unique,</span>
<span class="c1">/// and also larger, meaning more expensive to do equality checking on.</span>
</code></pre></div>
<p>I also thought of something similar, since the strings won't be changing in the buffer. How do you feel about a design like this?</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">// just after inicialization</span>
<span class="n">expect</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">buff</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">""</span>
<span class="n">expect</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">start_positions</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">//inserting 2 strings</span>
<span class="kr">const</span><span class="w"> </span><span class="n">hi_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">"hi"</span><span class="p">);</span><span class="w"> </span><span class="c1">// 0</span>
<span class="kr">const</span><span class="w"> </span><span class="n">there_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">"there"</span><span class="p">);</span><span class="w"> </span><span class="c1">// 1</span>

<span class="c1">//results with</span>
<span class="n">expect</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">buff</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"hithere"</span>
<span class="n">expect</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">start_positions</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">]</span>

<span class="c1">// no need to store start and length, since the next value in start_positions holds where the string ends</span>
<span class="n">expect</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">there_idx</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">interner</span><span class="p">.</span><span class="n">buff</span><span class="p">[</span><span class="n">interner</span><span class="p">.</span><span class="n">start_positions</span><span class="p">[</span><span class="n">there_idx</span><span class="p">]..</span><span class="n">interner</span><span class="p">.</span><span class="n">start_positions</span><span class="p">[</span><span class="n">there_idx</span><span class="w"> </span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span>
</code></pre></div>
<p>Would be happy to implement it. What type should the start_positions arraylist hold? If only string literals from source code will be in the interner, u32 would be enough. Source files with &gt; 4Gb str literals aren't realistic imo. However, if we stored embedded files in these as well (think <code>import "some-file" as some_str : Str</code>) then I'd use a <code>usize</code> just in case. I'm easily convinced it's an overkill though.</p>



<a name="500148025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500148025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500148025">(Feb 17 2025 at 10:48)</a>:</h4>
<p>null termination is viable as well. with short strings the cpu cache savings can be worth it</p>



<a name="500155574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500155574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500155574">(Feb 17 2025 at 11:18)</a>:</h4>
<p>Or a previous strategy I’ve seen, of prepending the string with a varint length, encoded backwards, and placed before the offset you return.</p>



<a name="500170603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500170603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500170603">(Feb 17 2025 at 12:23)</a>:</h4>
<p>Cool! Could do either. <span class="user-mention" data-user-id="453336">@Joshua Warner</span> do you think storing the length that way would be beneficial over having null terminated strings?</p>



<a name="500222092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500222092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500222092">(Feb 17 2025 at 15:40)</a>:</h4>
<p>The advantage would be in making computing the length of strings &gt;= ~64 bytes (a cache line) faster</p>



<a name="500222215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500222215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500222215">(Feb 17 2025 at 15:41)</a>:</h4>
<p>(that said, I think it's unlikely we'll have many identifiers &gt;= 64 bytes, so <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> )</p>



<a name="500225008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500225008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500225008">(Feb 17 2025 at 15:52)</a>:</h4>
<p>This is the string literal Interner. We will have some large ones</p>



<a name="500227622"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500227622" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500227622">(Feb 17 2025 at 16:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="577599">Norbert Hajagos</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500139568">said</a>:</p>
<blockquote>
<p>Would be happy to implement it. What type should the start_positions arraylist hold? If only string literals from source code will be in the interner, u32 would be enough. Source files with &gt; 4Gb str literals aren't realistic imo. However, if we stored embedded files in these as well (think <code>import "some-file" as some_str : Str</code>) then I'd use a <code>usize</code> just in case. I'm easily convinced it's an overkill though.</p>
</blockquote>
<p>I think we should handle imported sources special and just never put them in interners. That would be a waste. And since the interners are per module, the strings from a single module can never be over 4GB.</p>



<a name="500247449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500247449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500247449">(Feb 17 2025 at 17:35)</a>:</h4>
<p>should literals be interned at all? I don't see the benefit honestly <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="500247557"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500247557" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500247557">(Feb 17 2025 at 17:36)</a>:</h4>
<p>Only benefit is that you can close files....so maybe not worth it.</p>



<a name="500247582"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500247582" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500247582">(Feb 17 2025 at 17:36)</a>:</h4>
<p>Might be better to just reference back to the original file</p>



<a name="500247632"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500247632" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500247632">(Feb 17 2025 at 17:37)</a>:</h4>
<p>I guess also maybe minor cache gains later in the compiler</p>



<a name="500247786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500247786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500247786">(Feb 17 2025 at 17:38)</a>:</h4>
<p>But yeah, I think the only real gain is if it saves a lot of memory in large roc projects due to being able to free files.</p>



<a name="500252735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500252735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500252735">(Feb 17 2025 at 18:14)</a>:</h4>
<p>Presumably we would want to serialize that data with the can IR (or whatever else we're caching)</p>



<a name="500252828"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500252828" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500252828">(Feb 17 2025 at 18:15)</a>:</h4>
<p>That way we only have to read the can IR and not the original file (e.g. supposing we're confident it hasn't changed - and assuming we didn't need to hash it to figure that out)</p>



<a name="500253051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500253051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500253051">(Feb 17 2025 at 18:17)</a>:</h4>
<p>we already have to read the original file into memory in order to hash it, because the hash is the key for the cached can IR</p>



<a name="500253082"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500253082" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500253082">(Feb 17 2025 at 18:17)</a>:</h4>
<p>and the can IR is a hash of the source bytes, so we know all the offsets into the source file will still be valid! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="500253101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500253101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500253101">(Feb 17 2025 at 18:17)</a>:</h4>
<p>IMO we ought to skip hashing most of the time</p>



<a name="500253137"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500253137" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500253137">(Feb 17 2025 at 18:18)</a>:</h4>
<p>That sort of thing can really matter for large projects</p>



<a name="500253254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500253254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500253254">(Feb 17 2025 at 18:18)</a>:</h4>
<p>(this is exactly what git does - it doesn't rehash all files in your git dir every time you commit - only the ones that have a different stat)</p>



<a name="500253512"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500253512" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500253512">(Feb 17 2025 at 18:20)</a>:</h4>
<p>If we can only read one file (the can ir), and not seek the disk to read the original file again, that's a substantial speed boost</p>



<a name="500260855"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500260855" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500260855">(Feb 17 2025 at 19:19)</a>:</h4>
<p>Note: this is the kind of thing that is super easy to change later</p>



<a name="500260871"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500260871" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500260871">(Feb 17 2025 at 19:19)</a>:</h4>
<p>So either way we go should be fine.</p>



<a name="500260978"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500260978" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500260978">(Feb 17 2025 at 19:20)</a>:</h4>
<p>But yeah, especially on a HDD, reading only one could be big gains</p>



<a name="500263288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500263288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500263288">(Feb 17 2025 at 19:41)</a>:</h4>
<p>I'm not sure how we could skip it <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="500263455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500263455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500263455">(Feb 17 2025 at 19:42)</a>:</h4>
<p>like if the CLI receives an instruction to check <code>main.roc</code>, how would it know what cached IR to load without reading and hashing the source bytes?</p>



<a name="500263495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500263495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500263495">(Feb 17 2025 at 19:42)</a>:</h4>
<p>(it's different if it's a persistent process that's watching the filesystem for changes, of course)</p>



<a name="500267032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500267032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500267032">(Feb 17 2025 at 20:09)</a>:</h4>
<p>Oh yeah, the hash of the file is the key to the cache.</p>



<a name="500267039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500267039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500267039">(Feb 17 2025 at 20:09)</a>:</h4>
<p>So hashing is required unless we come up with a different key</p>



<a name="500305405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500305405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500305405">(Feb 18 2025 at 02:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500155574">said</a>:</p>
<blockquote>
<p>Or a previous strategy I’ve seen, of prepending the string with a varint length, encoded backwards, and placed before the offset you return.</p>
</blockquote>
<p>This never occured to me. Cool idea!</p>



<a name="500305525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500305525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500305525">(Feb 18 2025 at 02:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500247449">said</a>:</p>
<blockquote>
<p>should literals be interned at all? I don't see the benefit honestly <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>In zig we do it because it helps simplify our memory model, particularly with serialization</p>



<a name="500305569"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500305569" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500305569">(Feb 18 2025 at 02:21)</a>:</h4>
<p>I must be missing something because I don't see the connection with files</p>



<a name="500305924"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500305924" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500305924">(Feb 18 2025 at 02:24)</a>:</h4>
<p>if the literal doesn't have any escapes in it, you can just store the region in the original source file<br>
because those are the exact bytes you want anyway</p>



<a name="500305934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500305934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500305934">(Feb 18 2025 at 02:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/500263455">said</a>:</p>
<blockquote>
<p>like if the CLI receives an instruction to check <code>main.roc</code>, how would it know what cached IR to load without reading and hashing the source bytes?</p>
</blockquote>
<p>Have a cache file per source file path, and store the size, mtime, inode.  If any of those change, cache miss. We do this in zig for source -&gt; ZIR</p>



<a name="500305987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500305987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500305987">(Feb 18 2025 at 02:25)</a>:</h4>
<p>Oh, we don't have source files, tokens, or ast nodes loaded at all in the happy path</p>



<a name="500306024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500306024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500306024">(Feb 18 2025 at 02:26)</a>:</h4>
<p>we could do the size/mtime/inode/etc as an extra layer, but if any of those change we still have to redo the hash computation</p>



<a name="500306225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500306225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500306225">(Feb 18 2025 at 02:28)</a>:</h4>
<p>so the tradeoff for the cache hit scenario would be:</p>
<ul>
<li>"always hash" means in the happy path where we're getting a cache hit, we just read the file and hash it and then proceed</li>
<li>"size/mtime/inode/etc" means in the happy path we do strictly more work, because we check those things and then calculate the hash anyway</li>
</ul>
<p>in the cache miss scenario, we might discover that we need to re-hash sooner...but then the first thing we do in a cache miss is hash anyway, to know what to name the new cache file <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="500306289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500306289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500306289">(Feb 18 2025 at 02:28)</a>:</h4>
<p>so I guess another way to say it is that we re-hash whether there's going to be a cache miss or cache hit, so might as well just always do it, yeah?</p>



<a name="500306403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500306403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500306403">(Feb 18 2025 at 02:29)</a>:</h4>
<p>I think you should be able to avoid rehashing when you have a hit</p>



<a name="500306484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500306484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500306484">(Feb 18 2025 at 02:30)</a>:</h4>
<p>In our case it would be extremely wasteful since we don't even need access to the file contents on a cache hit</p>



<a name="500306551"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500306551" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500306551">(Feb 18 2025 at 02:31)</a>:</h4>
<p>Maybe I'm not understanding what you mean when you say "hash". Are you talking about the file contents?</p>



<a name="500307183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500307183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500307183">(Feb 18 2025 at 02:38)</a>:</h4>
<p>I vaguely recall something about assigning a unique integer per identifier across all source files or something like that. I'm guessing that's what you mean by "hash"</p>



<a name="500307405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500307405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500307405">(Feb 18 2025 at 02:40)</a>:</h4>
<p>by hash I specifically mean a BLAKE3 hash of the entire contents of the <code>.roc </code>source file</p>



<a name="500307439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500307439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500307439">(Feb 18 2025 at 02:41)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> how do we know we have a hit without rehashing though?</p>



<a name="500308483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308483">(Feb 18 2025 at 02:54)</a>:</h4>
<p>(mtime, inode, size) is generally considered to be reliable enough. As a bonus you can try to detect mtime granularity and avoid false positives in case the file system has high granularity (i.e. NFS, which nobody should be using)</p>



<a name="500308577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Kelley <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308577">(Feb 18 2025 at 02:55)</a>:</h4>
<p>fstat cache hits are going to be a lot faster than hashing cache hits. Especially if you don't need to load the file contents on hit</p>



<a name="500308710"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308710" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308710">(Feb 18 2025 at 02:57)</a>:</h4>
<p>If we intern string literals, then I'm pretty sure we wouldn't need anything from the source file, just the cache contents</p>



<a name="500308733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308733">(Feb 18 2025 at 02:57)</a>:</h4>
<p>Unless there are compiler errors and we need to show diagnostics based on regions in the source, of course</p>



<a name="500308849"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308849" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308849">(Feb 18 2025 at 02:58)</a>:</h4>
<p>gotcha, yeah that's a reasonable argument for layering a (mtime, inode, size) cache on top of the BLAKE3 hash cache, to avoid reading the files and BLAKE3-ing them unnecessarily in the happy path case <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="500308880"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308880" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308880">(Feb 18 2025 at 02:59)</a>:</h4>
<p>I don't think we need to do any special design work for that now - can add that on sometime after 0.1.0</p>



<a name="500308899"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308899" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308899">(Feb 18 2025 at 02:59)</a>:</h4>
<p>but it is a good argument for not assuming we have the source bytes in memory</p>



<a name="500308956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308956">(Feb 18 2025 at 03:00)</a>:</h4>
<p>so yeah, maybe just interning them is simplest haha</p>



<a name="500308992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500308992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500308992">(Feb 18 2025 at 03:00)</a>:</h4>
<p>(them being literals)</p>



<a name="500309021"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500309021" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500309021">(Feb 18 2025 at 03:00)</a>:</h4>
<p>It's simpler for 0.1.0 as well</p>



<a name="500309068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500309068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500309068">(Feb 18 2025 at 03:00)</a>:</h4>
<p>But not <em>that</em> much simpler</p>



<a name="500309159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500309159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500309159">(Feb 18 2025 at 03:02)</a>:</h4>
<p>interning literals?</p>



<a name="500309881"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500309881" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500309881">(Feb 18 2025 at 03:10)</a>:</h4>
<p>Yes</p>



<a name="500312331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500312331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500312331">(Feb 18 2025 at 03:42)</a>:</h4>
<p>We can differentiate between interning (ensuring we have one unique copy of each) and just copying them</p>



<a name="500312349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500312349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500312349">(Feb 18 2025 at 03:42)</a>:</h4>
<p>The latter is what we need to avoid re-reading the source file</p>



<a name="500312379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500312379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500312379">(Feb 18 2025 at 03:43)</a>:</h4>
<p>The former is potentially a small binary size optimization, but this is probably the wrong layer to do that at</p>



<a name="500312395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500312395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500312395">(Feb 18 2025 at 03:43)</a>:</h4>
<p>We need to ensure symbols are unique, but I don't see any particular reason we need to guarantee strings are</p>



<a name="500313521"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500313521" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500313521">(Feb 18 2025 at 03:57)</a>:</h4>
<p>I'm talking about just copying, not interning, good distinction</p>



<a name="500317752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500317752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500317752">(Feb 18 2025 at 04:43)</a>:</h4>
<p>Yeah, string interner doesn't deduplicate</p>



<a name="500317763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/500317763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#500317763">(Feb 18 2025 at 04:44)</a>:</h4>
<p>It could, but unnecessary for the most part</p>



<a name="501228789"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501228789" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501228789">(Feb 22 2025 at 05:14)</a>:</h4>
<p>I've made a draft PR with an initial implementation of Parser AST -&gt; SExpr</p>
<p><a href="https://github.com/roc-lang/roc/pull/7629">https://github.com/roc-lang/roc/pull/7629</a></p>
<p>It doesn't really do a whole lot right now... but it compiles and runs <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> </p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="k">test</span><span class="w"> </span><span class="s">"example s-expr"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\module []</span>
<span class="w">        </span><span class="sh">\\</span>
<span class="w">        </span><span class="sh">\\foo = "bar"</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\(header statement)</span>
<span class="w">    </span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="n">testHelper</span><span class="p">(</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



<a name="501228818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501228818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501228818">(Feb 22 2025 at 05:14)</a>:</h4>
<p>Intention will be to make it generate snapshots somehow... but while I'm developing the IR and wiring it up I'll probably use a unit test.</p>



<a name="501312927"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501312927" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501312927">(Feb 22 2025 at 23:38)</a>:</h4>
<p>After going down this road a bit further... I'm thinking this may be the wrong approach.</p>



<a name="501312951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501312951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501312951">(Feb 22 2025 at 23:38)</a>:</h4>
<p>The issue is how to work with the nested nodes and our SoA structure.</p>



<a name="501312960"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501312960" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501312960">(Feb 22 2025 at 23:38)</a>:</h4>
<p>I'm going to try just using the standard zig <code>format</code></p>



<a name="501313011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501313011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501313011">(Feb 22 2025 at 23:40)</a>:</h4>
<p>That does mean we are providing a <code>std.io.Writer</code>, but I assume there is a way for that to not allocate, like maybe a heap allocated writer or similar.</p>



<a name="501315227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501315227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501315227">(Feb 23 2025 at 00:14)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> </p>
<p>How should I be getting the ident strings back out of the Parser AST? </p>
<p>I'm reasonably sure we just haven't got to this part yet, but wondering where the interned strings would be. </p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">/// Represents a Pattern used in pattern matching.</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">Pattern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">union</span><span class="p">(</span><span class="k">enum</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ident</span><span class="o">:</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ident_tok</span><span class="o">:</span><span class="w"> </span><span class="n">TokenIdx</span><span class="p">,</span><span class="w"> </span><span class="c1">// &lt;--- should this be an interned Ident.Idx instead?</span>
<span class="w">        </span><span class="n">region</span><span class="o">:</span><span class="w"> </span><span class="n">Region</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
</code></pre></div>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">Token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tag</span><span class="o">:</span><span class="w"> </span><span class="n">Tag</span><span class="p">,</span>
<span class="w">    </span><span class="n">offset</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="n">extra</span><span class="o">:</span><span class="w"> </span><span class="n">Extra</span><span class="p">,</span>

<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">Extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">length</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">interned</span><span class="o">:</span><span class="w"> </span><span class="n">base</span><span class="p">.</span><span class="n">Ident</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;---</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">pulling</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">here</span><span class="o">??</span>
<span class="w">    </span><span class="p">};</span>
</code></pre></div>



<a name="501315270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501315270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501315270">(Feb 23 2025 at 00:15)</a>:</h4>
<p>Or maybe using the <code>offset</code> and <code>length</code> and just indexing from the source bytes</p>



<a name="501315390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501315390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501315390">(Feb 23 2025 at 00:17)</a>:</h4>
<p>Or maybe I should be using the <code>Region</code> somehow</p>



<a name="501315928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501315928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501315928">(Feb 23 2025 at 00:25)</a>:</h4>
<p>Ok, yeah I'm pretty sure I should be grabbing them from the <code>ModuleEnv</code> using the <code>Ident.Idx</code>. So I'll need to take the env as an argument for the formatting helper.</p>



<a name="501316347"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501316347" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501316347">(Feb 23 2025 at 00:31)</a>:</h4>
<p>Yeah you can fetch indents from the ModuleEnv</p>



<a name="501316424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501316424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501316424">(Feb 23 2025 at 00:32)</a>:</h4>
<p>Strings and numbers and such you’ll have to fetch from the source for now, but my plan is to also stash those somewhere, possibly on the ModuleEnv</p>



<a name="501317313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501317313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501317313">(Feb 23 2025 at 00:46)</a>:</h4>
<p>Ok got something working. Just building out more of the structure for a minimal SExpr test</p>



<a name="501319530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501319530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501319530">(Feb 23 2025 at 01:19)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> I've currently got the Can IR assuming that we have <code>StringLiteral.Idx</code> for the text of numbers as well as strings: <a href="https://github.com/roc-lang/roc/blob/7fc2a08e2811fed7207ab5035f680bbf697d232f/src/check/canonicalize/IR.zig#L88">https://github.com/roc-lang/roc/blob/7fc2a08e2811fed7207ab5035f680bbf697d232f/src/check/canonicalize/IR.zig#L88</a></p>



<a name="501330023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501330023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501330023">(Feb 23 2025 at 03:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/501312927">said</a>:</p>
<blockquote>
<p>After going down this road a bit further... I'm thinking this may be the wrong approach.</p>
</blockquote>
<p>Would be glad to chat about this design space at some point or help with implementation issues. Overall, the perf isn't too important. Though good perf will help with fuzzing</p>



<a name="501330636"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501330636" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501330636">(Feb 23 2025 at 03:43)</a>:</h4>
<p>It was more a reflection on my <code>SExpr</code> "library" and how I had planned to map between the IR's and that to generate a string. </p>
<p>My new approach is to make a <code>toStr</code> helper for things that can be implemented at each level in the IR (but still has the global SoA context). Probably a terrible description -- but I'll get something minimal working soon and share my PR for comments/review.</p>



<a name="501330702"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501330702" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501330702">(Feb 23 2025 at 03:44)</a>:</h4>
<p>Basically I'm experimenting with ways to do it as I haven't built something like this before.</p>



<a name="501333617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501333617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501333617">(Feb 23 2025 at 04:28)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> interested to know what you think of this <a href="https://github.com/roc-lang/roc/pull/7629">https://github.com/roc-lang/roc/pull/7629</a></p>
<p>Currently have this test passing.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="k">test</span><span class="w"> </span><span class="s">"example s-expr"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\module [foo, bar]</span>
<span class="w">        </span><span class="sh">\\</span>
<span class="w">        </span><span class="sh">\\foo = "hey"</span>
<span class="w">        </span><span class="sh">\\bar = "yo"</span>
<span class="w">    </span><span class="p">;</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\(parse_ast (header "module" (exposes ("foo" "bar"))) (statements (decl (pattern (ident "foo")) (body ((expr "hey")))) (decl (pattern (ident "bar")) (body ((expr "yo"))))))</span>
<span class="w">    </span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="n">testSExprHelper</span><span class="p">(</span><span class="n">testing</span><span class="p">.</span><span class="n">allocator</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



<a name="501333754"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501333754" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501333754">(Feb 23 2025 at 04:30)</a>:</h4>
<p>Basic idea is to implement the following for various levels of the IR hierarchy and just call it recursively writing out the AST as it goes.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">toStr</span><span class="p">(</span><span class="n">ir</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="nb">@This</span><span class="p">(),</span><span class="w"> </span><span class="n">env</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">.</span><span class="n">ModuleEnv</span><span class="p">,</span><span class="w"> </span><span class="n">writer</span><span class="o">:</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">AnyWriter</span><span class="p">)</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



<a name="501337330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501337330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501337330">(Feb 23 2025 at 05:24)</a>:</h4>
<p>Ah, but then you have to separately make a parser for every ir? Well, I guess the parser isn't strictly required. Just nice to have</p>



<a name="501414359"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414359" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414359">(Feb 23 2025 at 22:04)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> I was heading in the direction of having a separate SExpr IR -- see <a href="https://github.com/roc-lang/roc/blob/c72993c7519188698937bcc359d15e5b032ebe78/src/check/parse/SExpr.zig">https://github.com/roc-lang/roc/blob/c72993c7519188698937bcc359d15e5b032ebe78/src/check/parse/SExpr.zig</a> for an example. </p>
<p>This approach with <code>toStr</code> is my second attempt but taking a different direction. </p>
<p>I'm not sure how important it will be for parsing these IR's. That seems to be a tangental requirement in the nice to have category -- but also feels like a rabbit hole in itself. </p>
<p>I can appreciate the idea of build a list of tokens instead of writing directly to a buffer -- I was thinking this enables us to implement checks to ensure everything is well formed. </p>
<p>I am not opposed to returning to try the SExpr IR idea again, I think I would simplify it a littler further, only have the "node" itself a comptime type variable.</p>



<a name="501414491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414491">(Feb 23 2025 at 22:06)</a>:</h4>
<p>Why does anything need comptime? (I think the comptime free IR I shared on the PR should be enough)</p>



<a name="501414731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414731">(Feb 23 2025 at 22:09)</a>:</h4>
<blockquote>
<p>I'm not sure how important it will be for parsing these IR's. That seems to be a tangental requirement in the nice to have category -- but also feels like a rabbit hole in itself.</p>
</blockquote>
<p>I don't think we need to write any of the parsing right now. I think we can just write a basic node type, conversion logic from parse ir to that basic node type, and a printer.</p>



<a name="501414738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414738">(Feb 23 2025 at 22:09)</a>:</h4>
<p>I think it could be super minimal</p>



<a name="501414799"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414799" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414799">(Feb 23 2025 at 22:10)</a>:</h4>
<p>Cause the sexpr ir should be trivial to print</p>



<a name="501414810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414810">(Feb 23 2025 at 22:10)</a>:</h4>
<p>(and pretty trivial to parse too)</p>



<a name="501414856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414856">(Feb 23 2025 at 22:11)</a>:</h4>
<p>Yeah it's easy to do. I did the first version like that (without comptime).</p>



<a name="501414889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414889">(Feb 23 2025 at 22:11)</a>:</h4>
<p>All this said, I don't want to block anything, but I don't understand the issue with a super simple sexpr ir as an intermediate.</p>



<a name="501414891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414891">(Feb 23 2025 at 22:11)</a>:</h4>
<p>I added the comptime so you could pass in a "parser" function to take the <code>[]u8</code> and give you back the nodes you expect -- or an error if it didn't recognise the node string</p>



<a name="501414965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414965">(Feb 23 2025 at 22:12)</a>:</h4>
<p>There's no issue. I'm just exploring the design space a little.</p>



<a name="501414973"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501414973" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501414973">(Feb 23 2025 at 22:12)</a>:</h4>
<p>Oh, I would just separately parse to sexpr ir, then simply pattern match on sexpr ir to convert to the parse ir.</p>



<a name="501415011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501415011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501415011">(Feb 23 2025 at 22:13)</a>:</h4>
<p>so parsing sexpr ir would accept all node types and names. Only the final conversion would invalidate specific like node types</p>



<a name="501415018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501415018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501415018">(Feb 23 2025 at 22:13)</a>:</h4>
<p>That's probably simpler than where I was going. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="501436674"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501436674" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501436674">(Feb 24 2025 at 03:06)</a>:</h4>
<p>to use sexprs to build IRs for later stages (anything after solve), then will it need to parse nodes that contain type information as well?</p>



<a name="501436792"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501436792" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501436792">(Feb 24 2025 at 03:08)</a>:</h4>
<p>Likely</p>



<a name="501436829"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501436829" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501436829">(Feb 24 2025 at 03:08)</a>:</h4>
<p>Though we can make type info a child node or side band if necessary (as long as we make a way to print it)</p>



<a name="501436892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501436892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501436892">(Feb 24 2025 at 03:09)</a>:</h4>
<p>Or if may be the case that we don't support parsing later IRs and they simply print in a lossy form. Haven't fully thought through this</p>



<a name="501440993"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501440993" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501440993">(Feb 24 2025 at 04:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/501436892">said</a>:</p>
<blockquote>
<p>Or if may be the case that we don't support parsing later IRs and they simply print in a lossy form. Haven't fully thought through this</p>
</blockquote>
<p>I've been thinking along these lines as one of the reasons why we may not want to "parse" the IR's.</p>



<a name="501441043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501441043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501441043">(Feb 24 2025 at 04:01)</a>:</h4>
<p>The other thought is that these SExpr IR's aren't very nice to read. I'm starting to think it might be nicer just to make something more human readable that is unique for each IR that just includes the context relevant for that stage.</p>



<a name="501443269"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501443269" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501443269">(Feb 24 2025 at 04:15)</a>:</h4>
<p>￼ <span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/501441043">said</a>:</p>
<blockquote>
<p>The other thought is that these SExpr IR's aren't very nice to read. I'm starting to think it might be nicer just to make something more human readable that is unique for each IR that just includes the context relevant for that stage.</p>
</blockquote>
<p>I was thinking a similar thing as I’ve been hand-writing some IRs (while exploring the function solving stage). It seems like sexprs that contain ast _plus_ type info could get in unwieldy.</p>



<a name="501444320"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501444320" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501444320">(Feb 24 2025 at 04:24)</a>:</h4>
<p>And each stage has different data, so there’s one main parser, it would need to support a bunch of nodes that are maybe only applicable to a single stage</p>



<a name="501445531"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501445531" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501445531">(Feb 24 2025 at 04:39)</a>:</h4>
<p>My thinking was to do sexprs with perhaps some tasteful extensions. Keep it simple to print and parse but perhaps slightly less verbose</p>



<a name="501446095"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501446095" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501446095">(Feb 24 2025 at 04:46)</a>:</h4>
<p>I guess I see a two way split. I think it is fine to either:</p>
<ol>
<li>Go the way of the old compiler, just have pretty printing, and make it special per IR (give up parsing)</li>
<li>Use s expression and for at least the high level IRs, but maybe all IRs eventually add parsing.</li>
</ol>
<p>Just depends on our exact goals.</p>



<a name="501446128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501446128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501446128">(Feb 24 2025 at 04:47)</a>:</h4>
<p>Goal one is definitely snapshot tests (which requires printing and some reliability, but doesn't need to be perfect).</p>



<a name="501446176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501446176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501446176">(Feb 24 2025 at 04:47)</a>:</h4>
<p>Goal two is parsing for better fuzzing (probably also requires verification, which may actually not be reasonable).</p>



<a name="501446261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501446261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501446261">(Feb 24 2025 at 04:49)</a>:</h4>
<p>I think we could minorly expand expressions to support types and that would be reasonable (something to worry about later)</p>



<a name="501446385"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501446385" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501446385">(Feb 24 2025 at 04:50)</a>:</h4>
<p>So I would argue that s expressions leave more open for future improvements</p>



<a name="501446428"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501446428" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501446428">(Feb 24 2025 at 04:51)</a>:</h4>
<p>That said, the simplicity of bespoke printing and no parsing is also reasonable as long as we try to be consistent with printing.</p>



<a name="501446454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501446454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501446454">(Feb 24 2025 at 04:51)</a>:</h4>
<p>I definitely still lean s expr currently.</p>



<a name="501477161"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/501477161" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#501477161">(Feb 24 2025 at 08:35)</a>:</h4>
<p>I've got something simple that is working ok. I'm going to continue with converting it into some small snapshots and trying a simple heuristic for pretty printing. </p>
<p>I'm busy all day tomorrow, but should be able to make some progress later in the week.</p>



<a name="502495778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502495778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502495778">(Feb 28 2025 at 05:00)</a>:</h4>
<p>I've updated my PR and would like to merge what I have to prevent it going stale again. </p>
<p>I haven't quite figured out how to get the string parts back to working  yet, but the rest is working well. </p>
<p>I also added an option to give either compact or pretty formatted strings. So now our unit test looks like this.</p>
<p>The next step is to generate actual snapshot files instead of having a unit test. But I'm pretty happy now with the API I think.</p>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> can you cast your eye over my implementation - particularly the <code>children: std.ArrayListUnmanaged(Node)</code> part... <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span> </p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="k">test</span><span class="w"> </span><span class="s">"example s-expr"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\module [foo, bar]</span>
<span class="w">        </span><span class="sh">\\</span>
<span class="w">        </span><span class="sh">\\foo = "hey"</span>
<span class="w">        </span><span class="sh">\\bar = "yo"</span>
<span class="w">    </span><span class="p">;</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="sh">\\(file</span>
<span class="w">        </span><span class="sh">\\    (header</span>
<span class="w">        </span><span class="sh">\\        'foo'</span>
<span class="w">        </span><span class="sh">\\        'bar')</span>
<span class="w">        </span><span class="sh">\\    (decl</span>
<span class="w">        </span><span class="sh">\\        (ident</span>
<span class="w">        </span><span class="sh">\\            'foo')</span>
<span class="w">        </span><span class="sh">\\        (string_part))</span>
<span class="w">        </span><span class="sh">\\    (decl</span>
<span class="w">        </span><span class="sh">\\        (ident</span>
<span class="w">        </span><span class="sh">\\            'bar')</span>
<span class="w">        </span><span class="sh">\\        (string_part)))</span>
<span class="w">    </span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="n">testSExprHelper</span><span class="p">(</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>



<a name="502695968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502695968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502695968">(Mar 01 2025 at 01:34)</a>:</h4>
<p>Ok, I've had a crack at an initial implementation for a tool to run through all the snapshot files... <a href="https://github.com/roc-lang/roc/pull/7644">https://github.com/roc-lang/roc/pull/7644</a></p>
<p>This PR adds a snapshot tool that iterates through all the snapshot text files in <code>src/snapshots/*.txt</code> and re-generates the AST/IR's for each compiler stage.</p>
<div class="codehilite"><pre><span></span><code>$ zig build snapshot
info: processed 2 snapshots in 1ms.
$ zig build snapshot -- --verbose
info: src/snapshots/002.txt
info: src/snapshots/001.txt
info: processed 2 snapshots in 2ms.
</code></pre></div>
<p>Here is an example of a snapshot file.</p>
<div class="codehilite"><pre><span></span><code>~~~META
description=Basic example to develop the snapshot methodology
~~~SOURCE
module [foo, bar]
foo = &quot;one&quot;
bar = &quot;two&quot;
~~~PARSE
(file
    (header
        &#39;foo&#39;
        &#39;bar&#39;)
    (decl
        (ident
            &#39;foo&#39;)
        (string_part))
    (decl
        (ident
            &#39;bar&#39;)
        (string_part)))
</code></pre></div>



<a name="502701093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701093">(Mar 01 2025 at 02:40)</a>:</h4>
<p><span class="user-mention" data-user-id="611722">@Isaac Van Doren</span> -- how would you feel about me adding <code>FORMAT</code> as a section in these snapshot tests, instead of having a unit tests that write out to another file? </p>
<p>We could then also run the formatter on  each snapshot file in our corpus.</p>



<a name="502701163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701163">(Mar 01 2025 at 02:41)</a>:</h4>
<p>If we think that's a good idea, I'm down to give it a try. We can land the format cli PR, I can rebase my snapshot PR and try it out</p>



<a name="502701184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701184">(Mar 01 2025 at 02:41)</a>:</h4>
<p>I guess I'm thinking of the "snapshot" tool as like our integration test suite...</p>



<a name="502701320"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701320" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701320">(Mar 01 2025 at 02:43)</a>:</h4>
<p>Yeah, sounds great!</p>
<p>Would also be great to make the format section optional. If the section is missing, it will then be required that the source section formats to itself.</p>



<a name="502701380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701380">(Mar 01 2025 at 02:44)</a>:</h4>
<p>Well... it's kind of one way.</p>



<a name="502701409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701409">(Mar 01 2025 at 02:44)</a>:</h4>
<p>So like, we put un-formatted code in the SOURCE section... it formats it and adds to the FORMATED section.</p>



<a name="502701414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701414">(Mar 01 2025 at 02:44)</a>:</h4>
<p>Then you can see in any changes in the <code>git diff</code></p>



<a name="502701489"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701489" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701489">(Mar 01 2025 at 02:45)</a>:</h4>
<p>Did you have another idea in mind <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> ? why would we want it optional?</p>



<a name="502701615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701615">(Mar 01 2025 at 02:47)</a>:</h4>
<p>Or maybe if the formatted code is identical we don't bother writing out the section... but I wonder if it's cheaper just to dump the bytes out than compare the strings.</p>



<a name="502701624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701624">(Mar 01 2025 at 02:47)</a>:</h4>
<p>I guess to work with git diff, if only a SOURCE section. The process is read source, format it, and write it back to SOURCE (only source means it is already formatted correctly). This avoids printing the same chunk of code twice in a row if the formatting is already good.</p>
<p>If a FORMATTED section exist, we expect the SOURCE to change when formatted. So we need to write out both sections and they aren't redundant.</p>
<p>So just noise reduction, but ensure that all test case can format</p>



<a name="502701727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701727">(Mar 01 2025 at 02:48)</a>:</h4>
<p>Ahk that's a good idea. That way we will know if the formatting changes, but not duplicate things unnecessarily.</p>



<a name="502701731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701731">(Mar 01 2025 at 02:48)</a>:</h4>
<p>Maybe that isn't needed, but I feel like for long examples, it will be nice to not print the source twice</p>



<a name="502701858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701858">(Mar 01 2025 at 02:50)</a>:</h4>
<p>FYI <span class="user-mention" data-user-id="611722">@Isaac Van Doren</span> I merged your PR -- I'll adapt your integration tests into the snapshot tool as above.</p>



<a name="502701932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701932">(Mar 01 2025 at 02:51)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> -- I assumed we want to build the snapshot tool by default so you can run the integration tests easily</p>



<a name="502701959"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502701959" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502701959">(Mar 01 2025 at 02:51)</a>:</h4>
<p>I'm happy to make it a flag though. Just that was my assumption</p>



<a name="502702015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502702015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502702015">(Mar 01 2025 at 02:52)</a>:</h4>
<p>I guess it should probably just sit behind <code>zig build test</code> also? or might we want to keep that for unit tests only?</p>



<a name="502703020"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502703020" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502703020">(Mar 01 2025 at 03:04)</a>:</h4>
<p>Yeah validating formatting in the multi tiered snapshots sounds useful</p>



<a name="502703178"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502703178" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502703178">(Mar 01 2025 at 03:06)</a>:</h4>
<p>But it won't be testing the same behavior as the test I wrote so I think we should keep it. That test wasn't meant to really check anything about the actual formatting itself, just that <code>roc format</code> correctly reads in the specified file and writes back out the formatted version.</p>



<a name="502703328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502703328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502703328">(Mar 01 2025 at 03:08)</a>:</h4>
<p>Originally that test was e2e (it actually built the roc executable and invoked it). I think it would be good to stand up a separate e2e suite for the CLI which would be a good place for tests like that to live</p>



<a name="502703802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502703802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502703802">(Mar 01 2025 at 03:14)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/502701932">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> -- I assumed we want to build the snapshot tool by default so you can run the integration tests easily</p>
</blockquote>
<p>That's probably fine.</p>
<p>Just thinking if someone only wants to build roc, they can just <code>zig build</code> and that can be roc and no other wasted time</p>



<a name="502704148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502704148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502704148">(Mar 01 2025 at 03:18)</a>:</h4>
<p>Any concerns with a separate e2e suite for the CLI? I'm happy to set it up</p>



<a name="502704626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502704626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502704626">(Mar 01 2025 at 03:23)</a>:</h4>
<p>I feel like it would be pretty redundant with all of the snapshot tests. Not bad to add a few of, but it is probably preferable to avoid too many scattered tests</p>



<a name="502704788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502704788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502704788">(Mar 01 2025 at 03:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/502702015">said</a>:</p>
<blockquote>
<p>I guess it should probably just sit behind <code>zig build test</code> also? or might we want to keep that for unit tests only?</p>
</blockquote>
<p>If we put it behind, <code>zig build test</code> we just need to make it sure it is fast enough. Might hurt the dev loop, in which case, probably should be <code>zig build test -Dsnapshot</code>. I think really the separation is for ensure fast feedback.</p>
<p>I assume eventually we will have enough snapshot tests we will want to separate it out, but probably fine to start unified and only separate out if it gets too slow.</p>



<a name="502705391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502705391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502705391">(Mar 01 2025 at 03:34)</a>:</h4>
<p>I might leave it as <code>zig build snapshot</code> for now... at least for this PR</p>



<a name="502705442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502705442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502705442">(Mar 01 2025 at 03:34)</a>:</h4>
<p>I can imagine we'll iterate on the design a few more times at least</p>



<a name="502706302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502706302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502706302">(Mar 01 2025 at 03:47)</a>:</h4>
<blockquote>
<p>I feel like it would be pretty redundant with all of the snapshot tests. Not bad to add a few of, but it is probably preferable to avoid too many scattered tests</p>
</blockquote>
<p>My intention would be to focus on focusing on the CLI/orchestration logic that wouldn't be tested by the snapshots at all, so I don't think there would be much overlap there. I wouldn't try to make it exhaustive, just for some confidence that changes to the CLI are correct without having to manually test everything.</p>



<a name="502706355"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502706355" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502706355">(Mar 01 2025 at 03:47)</a>:</h4>
<p>Ah, I thought you meant specifically formatting tests. Like another suite of tests but just for formatting.</p>



<a name="502706449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502706449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502706449">(Mar 01 2025 at 03:48)</a>:</h4>
<p>But like tests that format examples/stdlib (folder vs file vs invalid) or exercise various cli args sound great</p>



<a name="502706476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502706476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502706476">(Mar 01 2025 at 03:49)</a>:</h4>
<p>Right, that's what I'm thinking <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="502798564"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502798564" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502798564">(Mar 01 2025 at 23:25)</a>:</h4>
<p>Anyone looking for something to help out with, we should set up our snapshot tool to run in CI with the other zig things. </p>
<p>I haven't started looking at this yet. But it's ready to be added now.</p>



<a name="502798676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502798676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502798676">(Mar 01 2025 at 23:26)</a>:</h4>
<p>I think the next thing I'd like to tackle is parsing just an expression (not a full file), and translate some of our syntax snapshot tests across to work on improving coverage there. </p>
<p>Maybe look at how we might handle multi file snapshots... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="502974197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502974197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502974197">(Mar 03 2025 at 09:06)</a>:</h4>
<blockquote>
<p>we should set up our snapshot tool to run in CI</p>
</blockquote>
<p>What are the commands to use it?</p>



<a name="502987189"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502987189" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502987189">(Mar 03 2025 at 10:11)</a>:</h4>
<p><code>zig build snapshot</code><br>
<code>zig build snapshot -- --verbose</code> also</p>



<a name="502988421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/502988421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#502988421">(Mar 03 2025 at 10:17)</a>:</h4>
<p>I'll get on that after the roc nix package</p>



<a name="503024065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503024065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503024065">(Mar 03 2025 at 13:18)</a>:</h4>
<p><code>zig build snapshot</code> updates the golden values right? Why do we want to run it in CI?</p>



<a name="503073886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503073886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503073886">(Mar 03 2025 at 16:40)</a>:</h4>
<p>You run it, then a few extra git commands to ensure that none of the snapshot files changed</p>



<a name="503074003"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503074003" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503074003">(Mar 03 2025 at 16:41)</a>:</h4>
<p>If any change or if new ones pop into existence, it is a failure</p>



<a name="503075312"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503075312" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503075312">(Mar 03 2025 at 16:47)</a>:</h4>
<p>Ah I see. I was imagining that there would be a command that would explicitly check that the snapshots matched the current output without requiring you to manually diff them</p>



<a name="503294092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503294092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503294092">(Mar 04 2025 at 15:19)</a>:</h4>
<p>Small improvement to sexpr pretty printing: <a href="https://github.com/roc-lang/roc/pull/7659">https://github.com/roc-lang/roc/pull/7659</a></p>



<a name="503726206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503726206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503726206">(Mar 06 2025 at 08:04)</a>:</h4>
<p>What approach should we take for snapshots that are just a single expression... </p>
<p>For example in <code>crates/compiler/test_syntax/tests/snapshots/pass/add_var_with_spaces.expr.roc</code> we have a single expression</p>
<div class="codehilite"><pre><span></span><code>x + 2
</code></pre></div>
<p>Would we want snapshots this small, i.e. without being a full module? </p>
<p>I was thinking of migrating these across one by one as snapshots and using them to help add parser functionality.</p>



<a name="503728272"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503728272" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503728272">(Mar 06 2025 at 08:15)</a>:</h4>
<p>Or perhaps we would want something like this instead... so turn them into a full module.</p>
<div class="codehilite"><pre><span></span><code>~~~META
description=Add a variable with spaces
~~~SOURCE
module [add2]

add2 = x + 2
~~~PARSE
(file
    (header &#39;add2&#39;)
    (decl
        (ident &#39;add2&#39;)
        (binop
            &#39;+&#39;
            (ident &#39;&#39; &#39;x&#39;)
            (int &#39;2&#39;))))
</code></pre></div>



<a name="503728931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503728931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503728931">(Mar 06 2025 at 08:18)</a>:</h4>
<p>Also -- minor tangent while I'm looking at it... would we prefer <code>(binop  '+' &lt;lhs&gt; &lt;rhs&gt;)</code> ... or switch on the token and make it more like <code>(plus &lt;lhs&gt; &lt;rhs&gt;)</code></p>



<a name="503729398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503729398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503729398">(Mar 06 2025 at 08:21)</a>:</h4>
<p>I'd vote for the former (AKA <code>(binop ...)</code>) since it's more consistent with how the rest of the S-expr stuff seems to work, and it gets desugared immediately in the next stage, so it's minor anyway</p>



<a name="503756798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503756798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503756798">(Mar 06 2025 at 10:31)</a>:</h4>
<p>Definitely want to be able to parse single syntax nodes (exprs, statements, header, etc)</p>



<a name="503833480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503833480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503833480">(Mar 06 2025 at 16:12)</a>:</h4>
<p>Could just have <code>type = Expr</code> in the META section of the snapshot</p>



<a name="503937067"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503937067" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503937067">(Mar 07 2025 at 03:04)</a>:</h4>
<p>It's really cool seeing this stuff come alive...</p>
<div class="codehilite"><pre><span></span><code>~~~META
description=Various type annotations
~~~SOURCE
module []

foo : U64
bar : Thing(a, b, _)
baz : (a, b, c)
add_one : (U8, U16 -&gt; U32)
main! : List(String) -&gt; Result({}, _)
~~~PARSE
(file
    (header)
    (type_anno
        &#39;foo&#39;
        (tag &#39;U64&#39;))
    (type_anno
        &#39;bar&#39;
        (tag
            &#39;Thing&#39;
            (ty_var &#39;a&#39;)
            (ty_var &#39;b&#39;)
            (_)))
    (type_anno
        &#39;baz&#39;
        (tuple
            (ty_var &#39;a&#39;)
            (ty_var &#39;b&#39;)
            (ty_var &#39;c&#39;)))
    (type_anno
        &#39;add_one&#39;
        (fn
            (tag &#39;U32&#39;)
            (tag &#39;U8&#39;)
            (tag &#39;U16&#39;)))
    (type_anno
        &#39;main!&#39;
        (fn
            (tag
                &#39;Result&#39;
                (record)
                (_))
            (tag
                &#39;List&#39;
                (tag &#39;String&#39;)))))
</code></pre></div>



<a name="503937229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/503937229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#503937229">(Mar 07 2025 at 03:06)</a>:</h4>
<p>Some simplifications I'm debating rn (just for the snapshots, not renaming tag unions in the zig source or anything)</p>
<ul>
<li><code>type_anno</code> -&gt; <code>tann</code></li>
<li><code>ty_var</code> -&gt; <code>tvar</code></li>
</ul>
<p>There's a lot of design space here. It's nice that this is all one way and so easy to update the snapshots.</p>



<a name="504257825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/504257825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#504257825">(Mar 08 2025 at 09:39)</a>:</h4>
<p><code>type_anno</code> and <code>ty_var</code> are a lot clearer, I wouldn't change them if we don't experience noticeable problems due to verbosity.</p>



<a name="504324427"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/504324427" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#504324427">(Mar 08 2025 at 22:35)</a>:</h4>
<p>I'd just like to say in case anyone is wondering Re the current state of snapshots, because they look somewhat  strange.</p>
<p>I've just been dumping things in there to help figure out syntax issues with the parser and seed the fuzzer etc. </p>
<p>The current snapshots are pretty expendable and we will probably blow them away soon or change them a lot when we start having a usable Can etc.</p>



<a name="504585749"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/504585749" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#504585749">(Mar 10 2025 at 13:43)</a>:</h4>
<p>I think it's this output is really nice, but I _personally_ would prefer double quotes for strings.  Are we using singles just to avoid having to worry about escaping?</p>



<a name="504732462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/504732462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#504732462">(Mar 11 2025 at 03:36)</a>:</h4>
<p>Just wanted to show off a little... checkout this snapshot. I'm pretty happy with how this is starting to look. It's really easy to see at a glance where the issues are. You can feed inputs from fuzz crashes and dissect what the compiler is doing pretty quickly -- which has helped me find and fix a number of issues.</p>
<p>I'm loving the formatting for Problems also <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> </p>
<div class="codehilite"><pre><span></span><code>~~~META
description=fuzz crash
~~~SOURCE
H{o,
    ]

foo =

    &quot;on        (string &#39;onmo %&#39;)))
~~~PROBLEMS
TOKENIZE: (2:4-2:4) AsciiControl:

    ]
   ^
TOKENIZE: (1:6-1:6) Expected the correct closing brace here:

    ]
      ^

TOKENIZE: (6:7-6:36) UnclosedString:

    &quot;on        (string &#39;onmo %&#39;)))
      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
PARSER: missing_header
~~~TOKENS
UpperIdent,OpenCurly,LowerIdent,Comma,Newline,CloseCurly,Newline,LowerIdent,OpAssign,Newline,StringStart,StringPart,EndOfFile
~~~PARSE
(file
    (malformed_header &#39;missing_header&#39;)
    (record (field &#39;o&#39;))
    (decl
        (ident &#39;foo&#39;)
        (string &#39;on        (string &#39;onmo %&#39;)))&#39;)))
~~~FORMATTED
{ o }

foo = &quot;on        (string &#39;onmo %&#39;)))&quot;
~~~END
</code></pre></div>



<a name="504733942"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/504733942" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#504733942">(Mar 11 2025 at 03:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/504585749">said</a>:</p>
<blockquote>
<p>I think it's this output is really nice, but I _personally_ would prefer double quotes for strings.  Are we using singles just to avoid having to worry about escaping?</p>
</blockquote>
<p>I changed it to double quotes in <a href="https://github.com/roc-lang/roc/pull/7672">https://github.com/roc-lang/roc/pull/7672</a></p>



<a name="517935471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/517935471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#517935471">(May 13 2025 at 22:41)</a>:</h4>
<p>Hey <span class="user-mention" data-user-id="515757">@Luke Boswell</span> I'm dealing with an issue with Zig where TLDR we want to move to using TAB as the canonical indentation character in the formatter but Zig multiline string literals do not support using TAB in them.  So long story short I need to move all of the current fmt tests to snapshots (I don't have to per se, but I think it's the logical move).</p>
<p>In order to do that I am moving to make snapshots support different IR nodes like the old test_syntax snapshots did.  Are you aligned with this?  It means that I need to expose some extra methods on the Parse IR so that we can output the SExpr and format correctly.</p>



<a name="517986669"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/517986669" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#517986669">(May 14 2025 at 07:11)</a>:</h4>
<p>I'm not sure what you mean by </p>
<blockquote>
<p>make snapshots support different IR nodes like the old test_syntax snapshots did</p>
</blockquote>



<a name="517986745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/517986745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#517986745">(May 14 2025 at 07:12)</a>:</h4>
<p>In general though, I think moving the fmt tests to snapshots is a great idea!</p>



<a name="517986907"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/517986907" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#517986907">(May 14 2025 at 07:13)</a>:</h4>
<p>That was my intention too, but I figured you wanted the kitchen sink in there because it was easier to work with while developing the Parser initial implementation.</p>



<a name="518025309"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/518025309" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#518025309">(May 14 2025 at 10:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde/near/517986669">said</a>:</p>
<blockquote>
<p>I'm not sure what you mean by </p>
<blockquote>
<p>make snapshots support different IR nodes like the old test_syntax snapshots did</p>
</blockquote>
</blockquote>
<p>sorry i mean have it support snapshots of just exprs, statements, or headers instead of just modules</p>



<a name="518031577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20IR%20serde/near/518031577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20IR.20serde.html#518031577">(May 14 2025 at 10:48)</a>:</h4>
<p>yeah, that is something we need to support anyway (imo)</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
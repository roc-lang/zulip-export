<html>
<head><meta charset="utf-8"><title>tags and c abi · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html">tags and c abi</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="470770367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470770367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470770367">(Sep 16 2024 at 23:14)</a>:</h4>
<p>I think I just realized part of the reason we have been having some any issues with tags being passed between rust and roc. Especially around types like <code>RocResult&lt;U64, ()&gt;</code>. We have been representing tag types roc in llvm and that is leading to them being passed incorrectly.</p>
<p>We represent that type as <code>[0xi64, 1xi64, 1xi8, 7xi8]</code>. That is <code>0xi64</code> to get the alignment correct. <code>1xi64</code> as the payload. <code>1xi8</code> as the tag, and <code>7xi8</code> as the padding.</p>
<p>The padding being represented in the type messes up c-abi. Let's ignore the <code>0xi64</code> for now, llvm doesn't actually admit anything for it to my knowledge.</p>
<p><code>1xi64, 1xi8</code> and <code>1xi64, 1xi8, 7xi8</code> are not compatible when it comes to c-abi. <code>1xi64, 1xi8</code> will be passed in two register. <code>1xi64, 1xi8, 7xi8</code> will be passed on the stack due to containing too many values to be passed in registers. So here and likely a few other places, we need to remove the explicit padding from our types. This will also be important in the rust glue. Representing padding explicitly is not valid and will change the c-abi of a type.</p>



<a name="470770432"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470770432" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470770432">(Sep 16 2024 at 23:14)</a>:</h4>
<p>TLDR, we need to change our tag representation and it should fix some bugs we have been hitting</p>



<a name="470770663"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470770663" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470770663">(Sep 16 2024 at 23:15)</a>:</h4>
<p>Makes sense why we have been hitting so many confusing bugs since we change to tasks everywhere a lot more. <code>Task SomeType {}</code> that is being passed incorrectly via c-abi currently.</p>



<a name="470779471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470779471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470779471">(Sep 17 2024 at 00:13)</a>:</h4>
<p>This is at least the core of the fix: <a href="https://github.com/roc-lang/roc/pull/7084">https://github.com/roc-lang/roc/pull/7084</a></p>
<p>I am still seeing issues with nqueens in false interpreter, but I'm not sure the cause at this point. Assuming this passes tests, I think it should be good to merge.</p>



<a name="470780709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470780709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470780709">(Sep 17 2024 at 00:20)</a>:</h4>
<p>Oh, I see the next issue:<br>
For <code>u8, u8</code> which is what is generated by <code>Task U8 {}</code>, Rust is packing both <code>u8</code> into a single register <code>w0</code>. Roc is expecting them to be put in two registers, <code>w0</code> and <code>w1</code>....not sure why yet</p>



<a name="470781381"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470781381" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470781381">(Sep 17 2024 at 00:24)</a>:</h4>
<p>Hmm, maybe it is due to representing the type as <code>{ [1xi8], i8}</code> in llvm instead of <code>{i8, i8}</code>. Not sure the best way to fix that....</p>



<a name="470781503"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470781503" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470781503">(Sep 17 2024 at 00:24)</a>:</h4>
<p>Guess I need to mess around more</p>



<a name="470790477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470790477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470790477">(Sep 17 2024 at 00:58)</a>:</h4>
<p>Even if I change rust to use a <code>[1xi8]</code>, it still seems to be packing everything into a single register while llvm with roc is not.... This may be a case where we need more special handling cause llvm doesn't fully handle abi......</p>



<a name="470790838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470790838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470790838">(Sep 17 2024 at 01:01)</a>:</h4>
<p>Luckily an easy workaround is just to make the type bigger <code>Task U64 {}</code> works fine and doesn't pack into a single register, but I should try to figure out a more proper fix.</p>



<a name="470791040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470791040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470791040">(Sep 17 2024 at 01:02)</a>:</h4>
<p>Oh, I think we may be using llvm cc instead of the c calling convention here.</p>



<a name="470791065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470791065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470791065">(Sep 17 2024 at 01:03)</a>:</h4>
<p>Cause it is faster to pass in two regs than pack into one and unpack on the other side</p>



<a name="470791396"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470791396" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470791396">(Sep 17 2024 at 01:05)</a>:</h4>
<p>hmm...but we set the call conv to c. So that shouldn't be it. But maybe we need to manually deal with something here. Not fully sure.</p>



<a name="470793820"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470793820" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470793820">(Sep 17 2024 at 01:22)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span>, I think <a href="https://github.com/roc-lang/roc/pull/7084">https://github.com/roc-lang/roc/pull/7084</a> fixes your issues with <a href="https://github.com/roc-lang/basic-webserver/pull/72">https://github.com/roc-lang/basic-webserver/pull/72</a></p>



<a name="470793955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470793955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470793955">(Sep 17 2024 at 01:23)</a>:</h4>
<p>I thought at some point <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> and I were looking at an ABI issue and concluded that maybe we couldn't have a <code>RocResult</code> abstraction in Rust and instead needed to have glue generate a tag union every time, but I don't remember what the details were anymore <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="470794150"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470794150" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470794150">(Sep 17 2024 at 01:25)</a>:</h4>
<p>I can think of 2 issues:</p>
<ol>
<li>It would be incorrect in the case where there is no err type (as in <code>[]</code> for the err type instead of <code>{}</code>). Cause there will be no tag in that case.</li>
<li>It will be incorrect if the tag has more than 255 variants.</li>
</ol>



<a name="470794169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470794169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470794169">(Sep 17 2024 at 01:25)</a>:</h4>
<p>But neither of those should apply here.</p>



<a name="470794709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470794709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470794709">(Sep 17 2024 at 01:28)</a>:</h4>
<p>For the issue of <code>Result U8 {}</code> being passed in a single register by rust, but two registers by our llvm ir (at least that is what looks to be happening from what I can tell), it may be a case that we need to manually pack certain types when sending things over c abi.</p>



<a name="470794954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470794954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470794954">(Sep 17 2024 at 01:29)</a>:</h4>
<p>So we may need to convert the llvm type from <code>{[1xi8], i8}</code> to <code>i16</code>. Same with any other cases that the c abi would pack into a single register.</p>



<a name="470795014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470795014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470795014">(Sep 17 2024 at 01:30)</a>:</h4>
<p>But that is just a guess from what seems to be happening</p>



<a name="470796852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470796852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470796852">(Sep 17 2024 at 01:36)</a>:</h4>
<p>Nice work Brendan!</p>



<a name="470797585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470797585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470797585">(Sep 17 2024 at 01:40)</a>:</h4>
<p>Yeah, it looks like we don't handle these for aggregate types:</p>
<blockquote>
<p>Types less than or equal to 8 bytes are returned in x0.<br>
Types less than or equal to 16 bytes are returned in x0 and x1, with x0 containing the lower-order 8 bytes.</p>
</blockquote>



<a name="470797697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470797697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470797697">(Sep 17 2024 at 01:41)</a>:</h4>
<p>So more c call conv cases that aren't covered by llvm and we need to do manually.</p>



<a name="470800731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470800731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470800731">(Sep 17 2024 at 01:59)</a>:</h4>
<p>I'll fix this in a different PR. How things are wired currently, this feels like more of a hassle to fix than I want to deal with at this exact moment. Nothing specifically, hard, but a solid bit of wiring.</p>



<a name="470801332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470801332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470801332">(Sep 17 2024 at 02:03)</a>:</h4>
<p>How this impacts things in practice: Anything that returned from the host, is less than 9 bytes, and is a <code>Task SomeOk SomeErr</code>, probably won't work (at least not on all architectures). Also, if it is less than 17 bytes, it may have issues but that is less likely to be problematic.</p>
<p>So <code>Task U8 {}</code> fails for example, but can be worked around in rust by changing the type to <code>RocResult&lt;u64, ()&gt;</code>.</p>
<p>This is a pre-existing bug, just made obvious and much more common by the Task as builtin PR.</p>



<a name="470801920"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470801920" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470801920">(Sep 17 2024 at 02:06)</a>:</h4>
<p>great find! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="470801954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470801954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470801954">(Sep 17 2024 at 02:07)</a>:</h4>
<p>I guess sending enumerations to the host would run into this</p>



<a name="470801964"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470801964" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470801964">(Sep 17 2024 at 02:07)</a>:</h4>
<p>because they're <code>U8</code> under the hood</p>



<a name="470802127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470802127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470802127">(Sep 17 2024 at 02:08)</a>:</h4>
<p>I can have a closer look tonight. This is awesome. Looking forward to JWT in basic-webserver <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="470802275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470802275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470802275">(Sep 17 2024 at 02:09)</a>:</h4>
<p>Yeah, this will be hit my anything that is a return type from the host and is an aggregate type under 9/17 bytes depending on the architecture. So a <code>{ a: U8, b: U8}</code> would also hit this.</p>



<a name="470923177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/tags%20and%20c%20abi/near/470923177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/tags.20and.20c.20abi.html#470923177">(Sep 17 2024 at 09:27)</a>:</h4>
<p>Looks like it's working <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> -- just testing on that JWT PR for basic-webserver</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
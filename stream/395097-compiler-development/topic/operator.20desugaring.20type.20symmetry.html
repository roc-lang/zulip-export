<html>
<head><meta charset="utf-8"><title>operator desugaring type symmetry · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html">operator desugaring type symmetry</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="560055556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055556">(Nov 25 2025 at 02:16)</a>:</h4>
<p>FYI, I discovered that we need to make binops have a type constraint where both sides are equal after all (I previously thought we could get away without doing this, but turns out not!)</p>



<a name="560055600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055600">(Nov 25 2025 at 02:16)</a>:</h4>
<p>example situation where the unconstrained design (where e.g. <code>a * b</code> desugars to <code>a.times(b)</code> and that's it, <code>a</code> and <code>b</code> are permitted to have totally different types) breaks down:</p>



<a name="560055611"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055611" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055611">(Nov 25 2025 at 02:17)</a>:</h4>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">answer</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">Answer</span>
<span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">my_custom_number</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">MyVector</span>
<span class="w">    </span><span class="n">my_custom_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span>

<span class="w">    </span><span class="mi">5</span><span class="o">.</span><span class="n">times</span><span class="p">(</span><span class="n">my_custom_number</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>



<a name="560055641"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055641" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055641">(Nov 25 2025 at 02:17)</a>:</h4>
<p>(that's after desugaring <code>5 * my_custom_number</code> to <code>5.times(my_custom_number)</code>)</p>



<a name="560055676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055676">(Nov 25 2025 at 02:17)</a>:</h4>
<p>the type of that <code>5</code> literal is:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">a</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="n">a</span><span class="o">.</span><span class="n">from_numeral</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">Try</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="no">InvalidNumeral</span><span class="p">(</span><span class="no">Str</span><span class="p">)),</span>
<span class="w">    </span><span class="n">a</span><span class="o">.</span><span class="n">times</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="no">MyVector</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">Answer</span><span class="p">,</span>
<span class="o">]</span>
</code></pre></div>



<a name="560055708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055708">(Nov 25 2025 at 02:18)</a>:</h4>
<p>since nothing is forcing this to be concrete, this ends up "defaulting to <code>Dec</code>"</p>



<a name="560055745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055745">(Nov 25 2025 at 02:19)</a>:</h4>
<p>however, the way <em>that</em> works is that we unify <code>Dec</code> with this type - which fails, because <code>Dec.times : Dec, Dec -&gt; Dec</code> fails to unify with <code>a.times : a, MyVector -&gt; Answer</code> even if <code>Answer</code> turns out to be a type alias for <code>Dec</code>, because <code>Dec</code> will fail to unify with <code>MyVector</code></p>



<a name="560055764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055764">(Nov 25 2025 at 02:19)</a>:</h4>
<p>so we know it can't be <code>Dec</code>, but we can't leave it as unbound, so...what do we do?</p>



<a name="560055802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055802">(Nov 25 2025 at 02:19)</a>:</h4>
<p>one design is that we give an error, which means Roc is a language where you can't write <code>2 * x</code> or <code>1 + x</code> etc. - which would be absurd; obviously we're not going with that design</p>



<a name="560055867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055867">(Nov 25 2025 at 02:20)</a>:</h4>
<p>another design is where we do our best to guess what number type this should be, since it can't be <code>Dec</code> but we also can't leave it as an unbound variable because we have no how to do operations on that</p>



<a name="560055900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560055900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560055900">(Nov 25 2025 at 02:21)</a>:</h4>
<p>so how would we guess? the only clue we have to go on in that entire type is <code>MyVector</code>, so even if we hand-wave away what the exact heuristic is, it would have to conclude that <code>MyVector</code> is the type to go with</p>



<a name="560056142"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560056142" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560056142">(Nov 25 2025 at 02:25)</a>:</h4>
<p>at which point there's only one thing for it to do: unify <code>MyVector</code> with this type, which in turn means it has to unify <code>MyVector.times : MyVector, _ -&gt; _</code> with <code>a.times : a, MyVector -&gt; Answer</code> - a type where the only way it can _possibly_ successfully unify is if <code>MyVector.times</code> has both arguments being the same type</p>



<a name="560056195"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560056195" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560056195">(Nov 25 2025 at 02:26)</a>:</h4>
<p>at which point the final design option, which I conclude is the correct one by process of elimination, is just a strictly clearer and more performant (in terms of compiler performance, due to not needing to have a heuristic for howto guess this) design compared to the second option, is:</p>



<a name="560056230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560056230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560056230">(Nov 25 2025 at 02:26)</a>:</h4>
<p>we require that both sides of the binop have the same type</p>



<a name="560056299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560056299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560056299">(Nov 25 2025 at 02:27)</a>:</h4>
<p>so it's not _just_ <code>a * b</code> is sugar for <code>a.times(b)</code>, it's that it's <code>a * b</code> is sugar for "<code>a.times(b)</code> where <code>a</code> and <code>b</code> have the same type"</p>



<a name="560056410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560056410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560056410">(Nov 25 2025 at 02:29)</a>:</h4>
<p>at that point this is all trivial because they just unify</p>



<a name="560056964"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560056964" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560056964">(Nov 25 2025 at 02:36)</a>:</h4>
<p>so none of these problems exist</p>



<a name="560056999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560056999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560056999">(Nov 25 2025 at 02:37)</a>:</h4>
<p>because <code>5.times(blah)</code> just unifies to both arguments of <code>times</code> being the same, which means we just end up dispatching on whatever the type of <code>blah</code> is and we're all set</p>



<a name="560718368"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560718368" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andres Villegas <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560718368">(Nov 28 2025 at 07:11)</a>:</h4>
<p>I think one of a common patterns in scientific computing which as far as I know is a motivation to have "operator overloading" is to enable stuff like "5 * x" where x is not necessarily another number, but can be a vector or a matrix or a tensor.</p>



<a name="560718392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560718392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andres Villegas <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560718392">(Nov 28 2025 at 07:12)</a>:</h4>
<p>Will this design limit those use cases?</p>



<a name="560770497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560770497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560770497">(Nov 28 2025 at 12:06)</a>:</h4>
<p>I think you could implement a <code>from_numeral</code>to turn the number into the same type as the matrix. Might be a bit of effort so that both <code>5 + x</code> and <code>5 * x</code> all do the right thing, but I think it should be possible?</p>



<a name="560784430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560784430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560784430">(Nov 28 2025 at 13:14)</a>:</h4>
<p>Matrix * vector would be a bigger problem, right? Like you could define MatrixN.from_numeral(1) to be the identity matrix, but normal usage of matrices still want an assymetric operation.</p>



<a name="560836447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560836447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560836447">(Nov 28 2025 at 18:00)</a>:</h4>
<p>You probably would want a generic tensor type that can be a matrix or vector or etc</p>



<a name="560836542"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560836542" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560836542">(Nov 28 2025 at 18:01)</a>:</h4>
<p>Otherwise, yeah, you need <code>matrix.matmul(matrix2)</code> and <code>matrix.matmalV(vector)</code></p>



<a name="560836559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560836559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560836559">(Nov 28 2025 at 18:01)</a>:</h4>
<p>Or something of that nature</p>



<a name="560836689"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/operator%20desugaring%20type%20symmetry/near/560836689" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/operator.20desugaring.20type.20symmetry.html#560836689">(Nov 28 2025 at 18:02)</a>:</h4>
<p>You will need a solution like the above anyway in roc cause we don't have custom operators. So you can't define <code>@</code> to be the generic matmul like numpy/must python libs</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
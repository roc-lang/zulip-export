<html>
<head><meta charset="utf-8"><title>Task as builtin · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html">Task as builtin</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="434960491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/434960491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#434960491">(Apr 23 2024 at 11:14)</a>:</h4>
<p>I have been thinking about how we could get an intermediate step towards Task as builtin.</p>
<p>What if we just made <code>InternalTask</code> a builtin. We could assume that all platforms will have an <code>Effects.roc</code> file. </p>
<p>This would mean that users could write <code>main = Stdout.line! "foo"</code> without importing <code>pf.Task</code>, and also the platform main wouldn't need to import <code>Task</code> either I think.  </p>
<div class="codehilite"><pre><span></span><code>interface InternalTask
    exposes [Task, fromEffect, toEffect, ok, err]
    imports [Effect.{ Effect }]

Task ok err := Effect (Result ok err)

ok : a -&gt; Task a *
ok = \a -&gt; @Task (Effect.always (Ok a))

err : a -&gt; Task * a
err = \a -&gt; @Task (Effect.always (Err a))

fromEffect : Effect (Result ok err) -&gt; Task ok err
fromEffect = \effect -&gt; @Task effect

toEffect : Task ok err -&gt; Effect (Result ok err)
toEffect = \@Task effect -&gt; effect
</code></pre></div>



<a name="434960641"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/434960641" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#434960641">(Apr 23 2024 at 11:15)</a>:</h4>
<p>I think we'd need to name it <code>Task</code> rather than <code>InternalTask</code>, but yeah that could work!</p>



<a name="434960705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/434960705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#434960705">(Apr 23 2024 at 11:15)</a>:</h4>
<p>(otherwise if you write <code>Task.mapErr</code> it wouldn't work)</p>



<a name="434960929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/434960929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#434960929">(Apr 23 2024 at 11:16)</a>:</h4>
<p>Ahk, in that case we would need to include all the things... like <code>loop</code>, <code>mapErr</code> etc and this would be common accross all platforms.</p>



<a name="434967515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/434967515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#434967515">(Apr 23 2024 at 11:55)</a>:</h4>
<p>yeah that'll happen with the transition to builtin <code>Task</code> anyway <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="438917211"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/438917211" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#438917211">(May 16 2024 at 02:28)</a>:</h4>
<p>I was taking a look at what is necessary to implement Task as a builtin going off of this message:<br>
<span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/304902-show-and-tell/topic/draft.20article.20about.20!.20syntax/near/434593822">said</a>:</p>
<blockquote>
<p>yeah basically task as builtin (on its own) just requires:</p>
<ul>
<li>add the <code>Task</code> module to builtins</li>
<li>instead of generating <code>Effect</code> in <code>hosted</code> modules we generate <code>Task</code></li>
<li>hosts have to update their effect implementations accordingly (basically now they'll always be dealing with a <code>Result</code>)</li>
</ul>
</blockquote>
<p>If I'm understanding correctly, in the platforms we need to update <code>Effect.roc</code> to generate <code>Task</code> instead of <code>Effect</code>. This is just renaming things right?</p>
<p>Right now the Task module uses Effect and InternalTask from the platform. What I don't understand is how this will work once the Task module no longer has access to the platform. Won't it need to know about the Task type that is defined in <code>Effect.roc</code> because it is opaque? </p>
<p>I would appreciate other details about what needs to be done also <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="439283409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/439283409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#439283409">(May 17 2024 at 19:52)</a>:</h4>
<p>Is any generation of effectful code/tasks in hosted modules required if task is a builtin? I would have guessed it isn't but maybe im missing something</p>



<a name="439304162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/439304162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#439304162">(May 17 2024 at 23:13)</a>:</h4>
<p>Yeah, I think the idea is that hosted modules wouldn’t generate any types, and their members could return <code>Task</code> directly.</p>



<a name="439305923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/439305923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#439305923">(May 17 2024 at 23:36)</a>:</h4>
<p>As for actually implementing this, yeah you could copy over the implementation of task into the standard library. You'll also want to define the <code>after</code> and so on methods in Roc source, which you can find as generated by the compiler today here <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/can/src/effect_module.rs">https://github.com/roc-lang/roc/blob/main/crates/compiler/can/src/effect_module.rs</a></p>



<a name="439479282"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/439479282" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#439479282">(May 20 2024 at 00:45)</a>:</h4>
<p>Okay cool, that makes sense! I got nerd sniped by another project, but once I finish that I might try to implement this. If anyone else wants to do it before I get to it, go for it</p>



<a name="444132539"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/444132539" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#444132539">(Jun 12 2024 at 02:13)</a>:</h4>
<p>What would be a good way to call the functions created in <a href="http://effect_module.rs">effect_module.rs</a> from the builtins? Is there already infrastructure setup to do this or will new stuff need to be put in place?</p>



<a name="466129639"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466129639" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466129639">(Aug 29 2024 at 23:42)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> I think we need to add you Heap implementation to the False interpreter host. It's so we can handle refcounting on the FileHandle correctly as I suspect that is causing our issue there. </p>
<p>The added benefit is that if we remove the basic-cli tests from roc-lang/roc, at least we will have a good way to continue testing that and keep it in sync with roc.</p>



<a name="466129727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466129727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466129727">(Aug 29 2024 at 23:43)</a>:</h4>
<p>There's probably a way to do it without all that extra ceremony, i.e. convert a <code>*mut BufReader&lt;File&gt;</code> to a <code>RocBox&lt;()&gt;</code>... but my rust foo isn't good enough yet.</p>



<a name="466130024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466130024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466130024">(Aug 29 2024 at 23:47)</a>:</h4>
<p>I'll try it</p>



<a name="466131664"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466131664" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466131664">(Aug 30 2024 at 00:04)</a>:</h4>
<p>This hasn't really helped -- <a href="https://github.com/roc-lang/roc/commit/fc8c46beee6c9b6ae7f54b50a322c2e6bab90390">https://github.com/roc-lang/roc/commit/fc8c46beee6c9b6ae7f54b50a322c2e6bab90390</a></p>
<div class="codehilite"><pre><span></span><code>$ cargo test -p roc_cli cli_run::false_interpreter
    Finished test [unoptimized + debuginfo] target(s) in 0.51s
     Running unittests src/lib.rs (target/debug/deps/roc_cli-7e72f520dc480795)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 4 filtered out; finished in 0.00s

     Running tests/cli_run.rs (target/debug/deps/cli_run-f57f6c0a8cfd68c7)

running 1 test
test cli_run::false_interpreter ... FAILED

failures:

---- cli_run::false_interpreter stdout ----
thread &#39;cli_run::false_interpreter&#39; panicked at crates/cli/tests/cli_run.rs:314:17:
&gt; expected output to end with:
1414
&gt; but instead got:

&gt; stderr was:
[src/lib.rs:256:11] File::open(string) = Ok(
    File {
        fd: 3,
        path: &quot;/Users/luke/Documents/GitHub/roc/examples/cli/false-interpreter/examples/sqrt.false&quot;,
        read: true,
        write: false,
    },
)
[src/lib.rs:83:5] &amp;format!(&quot;Panic: {}&quot;, &amp;*msg) = &quot;Panic: unreachable: File.open&quot;
Application hit a panic: unreachable: File.open

note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="466132025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466132025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466132025">(Aug 30 2024 at 00:07)</a>:</h4>
<p>At this point, I should probably figure out cargo and make that a proper rust psckage</p>



<a name="466132082"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466132082" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466132082">(Aug 30 2024 at 00:08)</a>:</h4>
<p>Or at least make it downloadable from a github url</p>



<a name="466132117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466132117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466132117">(Aug 30 2024 at 00:08)</a>:</h4>
<p>We could add it as a crate in roc-lang/roc, and then it's easy to use from there</p>



<a name="466132207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466132207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466132207">(Aug 30 2024 at 00:09)</a>:</h4>
<p>Makes sense, because it's specific to <code>RocBox</code>.</p>



<a name="466132377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466132377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466132377">(Aug 30 2024 at 00:11)</a>:</h4>
<p>That would work!</p>



<a name="466134348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466134348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466134348">(Aug 30 2024 at 00:34)</a>:</h4>
<p>Oh yeah. That sounds like a good idea</p>



<a name="466134433"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466134433" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466134433">(Aug 30 2024 at 00:35)</a>:</h4>
<p>I'm an a branch off from Task as builtin, I'll move it into a crate. </p>
<p>I have fixed a couple of things up in the False platform, but haven't resolved the main issue.</p>



<a name="466134526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466134526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466134526">(Aug 30 2024 at 00:36)</a>:</h4>
<p>I'm at the stage where I think I need to inspect the LLVM IR to see what roc is actually generating for the effect roc_fx_openFile, though I dont' fully know how to do that properly.</p>



<a name="466134602"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466134602" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466134602">(Aug 30 2024 at 00:37)</a>:</h4>
<p>Should just be <code>build --emit-llvm-ir</code> then search for <code>roc_fx_openFile</code></p>



<a name="466134657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466134657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466134657">(Aug 30 2024 at 00:38)</a>:</h4>
<p>Oh yeah, I've got that part ok... it's the knowing how to interpret the IR</p>



<a name="466134661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466134661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466134661">(Aug 30 2024 at 00:38)</a>:</h4>
<p><span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="466134806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466134806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466134806">(Aug 30 2024 at 00:40)</a>:</h4>
<p>Paste the function signature here and we can help guess</p>



<a name="466135051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466135051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466135051">(Aug 30 2024 at 00:43)</a>:</h4>
<h2>PlatformTasks.roc</h2>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kt">FileHandle</span><span class="w"> </span><span class="nf">:=</span><span class="w"> </span><span class="kt">Box</span><span class="w"> </span><span class="p">{}</span>
<span class="nv">openFile</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="w"> </span><span class="kt">FileHandle</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<h2><code>lib.rs</code></h2>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_openFile</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">RocStr</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="n">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span>
</code></pre></div>
<h2>False.ll</h2>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">declare</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">7</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="vg">@roc_fx_openFile</span><span class="p">(</span><span class="kt">ptr</span><span class="p">)</span>

<span class="k">define</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc_fx_openFile_fastcc_wrapper</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">)</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%tmp</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">7</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="vg">@roc_fx_openFile</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!117</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">7</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nv">%tmp</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!117</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!117</span>
<span class="p">}</span>

<span class="k">define</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@PlatformTasks_task_closure_openFile_e93bf924107d8e1718c9a20bb89a13fa86198933bf2155d2785223e43180</span><span class="p">({}</span><span class="w"> </span><span class="nv">%"48"</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%closure_arg_openFile_0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">)</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!116</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%result_value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">7</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc_fx_openFile_fastcc_wrapper</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%closure_arg_openFile_0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">nonnull</span><span class="w"> </span><span class="nv">%result_value</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!117</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@"#Attr_#dec_7"</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%closure_arg_openFile_0</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!117</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@llvm.memcpy.p0.p0.i64</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">nonnull</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="k">dereferenceable</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">noundef</span><span class="w"> </span><span class="k">nonnull</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="w"> </span><span class="k">dereferenceable</span><span class="p">(</span><span class="m">16</span><span class="p">)</span><span class="w"> </span><span class="nv">%result_value</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="kt">i1</span><span class="w"> </span><span class="k">false</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!117</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!117</span>
<span class="p">}</span>
</code></pre></div>



<a name="466137540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466137540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466137540">(Aug 30 2024 at 01:14)</a>:</h4>
<p>That looks correct to me</p>



<a name="466137822"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466137822" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466137822">(Aug 30 2024 at 01:18)</a>:</h4>
<p>And this looks ok too right?</p>
<div class="codehilite"><pre><span></span><code>Handle := PlatformTasks.FileHandle

open : Str -&gt; Task Handle *
open = \path -&gt;
    PlatformTasks.openFile path
    |&gt; Task.map @Handle
    |&gt; Task.mapErr \{} -&gt; crash &quot;unreachable: File.open&quot;
</code></pre></div>



<a name="466137943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466137943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466137943">(Aug 30 2024 at 01:19)</a>:</h4>
<p>I'm running out of ideas here... I'm thinking the problem must be inside roc at this point.</p>



<a name="466139005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139005">(Aug 30 2024 at 01:31)</a>:</h4>
<p>Ok I've pushed the investigation stuff to <a href="https://github.com/roc-lang/roc/tree/builtin-task-wip">https://github.com/roc-lang/roc/tree/builtin-task-wip</a></p>



<a name="466139023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139023">(Aug 30 2024 at 01:31)</a>:</h4>
<p>I didn't want to force push onto Sam's branch in case we decide we don't want to go this path.</p>



<a name="466139049"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139049" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139049">(Aug 30 2024 at 01:31)</a>:</h4>
<p>Anton had reverted Sam's last change, and hasn't had a chance to look at this since then.</p>



<a name="466139120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139120">(Aug 30 2024 at 01:32)</a>:</h4>
<p>Okay, so I might have it working??</p>



<a name="466139185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139185">(Aug 30 2024 at 01:32)</a>:</h4>
<p>I did the AtomicU64 trick for file handle keys in a static hashmap</p>



<a name="466139218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139218">(Aug 30 2024 at 01:33)</a>:</h4>
<p>But when I return <code>Task U64 {}</code>, there's a segfault. When I return <code>Task {} {}</code>, it works.</p>



<a name="466139244"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139244" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139244">(Aug 30 2024 at 01:33)</a>:</h4>
<p>Interesting... checkout the changes I made to main on <span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span> I fixed an issue around calling <code>main</code> in there</p>



<a name="466139247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139247">(Aug 30 2024 at 01:33)</a>:</h4>
<p>So I just have to figure this last issue out</p>



<a name="466139325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139325">(Aug 30 2024 at 01:34)</a>:</h4>
<p>you could <code>git cherry-pick e60450dc9617465e8b1223a266d59e266c362914</code> probably, I put it all in that one commit</p>



<a name="466139649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466139649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466139649">(Aug 30 2024 at 01:38)</a>:</h4>
<p>Doing that now!</p>



<a name="466141074"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141074" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141074">(Aug 30 2024 at 01:48)</a>:</h4>
<p>Ok, Sam's latest (commit 74f9b993887a4a8f5096b70394a0446faf61805c) on my linux x64 dev machine native (not nix)</p>
<p>Just the false interpreter failure.</p>
<div class="codehilite"><pre><span></span><code>$ cargo test -p roc_cli
---- cli_run::false_interpreter stdout ----
thread &#39;cli_run::false_interpreter&#39; panicked at crates/cli/tests/cli_run.rs:261:29:
`valgrind` exited with no exit code. valgrind stdout was: &quot;&quot;

valgrind stderr was: &quot;==42266==  If you believe this happened as a result of a stack
==42266==  overflow in your program&#39;s main thread (unlikely but
==42266==  possible), you can try to increase the size of the
==42266==  main thread stack using the --main-stacksize= flag.
==42266==  The main thread stack size used in this run was 8388608.
&quot;
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    cli_run::false_interpreter

test result: FAILED. 57 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 37.77s
</code></pre></div>



<a name="466141138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141138">(Aug 30 2024 at 01:48)</a>:</h4>
<p>I'll run the full test suite now, just to check everything else is ok</p>



<a name="466141253"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141253" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141253">(Aug 30 2024 at 01:50)</a>:</h4>
<p>Oh, is this a new issue?</p>



<a name="466141276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141276">(Aug 30 2024 at 01:50)</a>:</h4>
<p>Like different than the one above</p>



<a name="466141278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141278">(Aug 30 2024 at 01:50)</a>:</h4>
<p>Yep</p>



<a name="466141300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141300">(Aug 30 2024 at 01:50)</a>:</h4>
<p>on which branch?</p>



<a name="466141301"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141301" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141301">(Aug 30 2024 at 01:50)</a>:</h4>
<p>Not sure how so</p>



<a name="466141309"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141309" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141309">(Aug 30 2024 at 01:50)</a>:</h4>
<p><a href="https://github.com/smores56/roc/tree/builtin-task">https://github.com/smores56/roc/tree/builtin-task</a></p>



<a name="466141321"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141321" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141321">(Aug 30 2024 at 01:50)</a>:</h4>
<p>The PR's branch</p>



<a name="466141617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141617">(Aug 30 2024 at 01:54)</a>:</h4>
<p>I think it's the same issue. I scrolled back up through my shell history and it looks the same as where we started today.</p>



<a name="466141626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141626">(Aug 30 2024 at 01:54)</a>:</h4>
<p>Welp</p>



<a name="466141665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141665">(Aug 30 2024 at 01:55)</a>:</h4>
<p>I presumed it was different because of the changes I made, I was not confident in it being different.</p>



<a name="466141766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141766">(Aug 30 2024 at 01:56)</a>:</h4>
<p>Well, this is consistent behaviour though. We now have two branches, with two different approaches to the platform side implementaiton and both kind of suggest an alignment bug inside roc</p>



<a name="466141800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141800">(Aug 30 2024 at 01:57)</a>:</h4>
<p>I haven't merged in main personally in a while</p>



<a name="466141818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141818">(Aug 30 2024 at 01:57)</a>:</h4>
<p>This might be the bug that Brendan already fixed for us, unless someone else has merged in for me</p>



<a name="466141821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466141821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466141821">(Aug 30 2024 at 01:57)</a>:</h4>
<p>Let me try that</p>



<a name="466142304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142304">(Aug 30 2024 at 02:01)</a>:</h4>
<p>It didn't help on my other branch... I've got failures in two other test platforms though. Looks like this. </p>
<div class="codehilite"><pre><span></span><code>$ cargo test -p roc_cli interactive_effects
&lt;---- snipped ---&gt;
Roc standard library crashed with message

    voided tag constructor is unreachable
</code></pre></div>
<p>What's interesting about this is that the effects platform is a zig platform. But it also currently has <code>mainForHost : Task {} []</code>. I'm going to update that and see it it changes the error message at all.</p>



<a name="466142472"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142472" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142472">(Aug 30 2024 at 02:03)</a>:</h4>
<p>I don't exactly know how to handle roc giving the host a refcounted RocResult in zig. But I'll give it a go</p>



<a name="466142570"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142570" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142570">(Aug 30 2024 at 02:04)</a>:</h4>
<p>Okay, I got the right crash back. Which isn't great, but it <em>should</em> be more fixable</p>



<a name="466142588"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142588" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142588">(Aug 30 2024 at 02:04)</a>:</h4>
<div class="codehilite"><pre><span></span><code>failures:

---- cli_run::false_interpreter stdout ----
thread &#39;cli_run::false_interpreter&#39; panicked at crates/cli/tests/cli_run.rs:314:17:
&gt; expected output to end with:
1414
&gt; but instead got:

&gt; stderr was:
Application hit a panic: unreachable File.open

note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="466142624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142624">(Aug 30 2024 at 02:05)</a>:</h4>
<p>Pushed that version to the <code>builtin-task</code> branch</p>



<a name="466142748"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142748" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142748">(Aug 30 2024 at 02:06)</a>:</h4>
<p>Yeah, this crash is really confusing me. At a quick glance to the llvm ir, it feels like the ir is correct</p>



<a name="466142775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142775">(Aug 30 2024 at 02:06)</a>:</h4>
<p>But nothing seems wrong with the platform or any of the types</p>



<a name="466142829"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142829" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142829">(Aug 30 2024 at 02:07)</a>:</h4>
<p>Linux x64 native commit 9263986433531cb4c0f2d78729dbdbb706c6a5d5</p>
<div class="codehilite"><pre><span></span><code>$ cargo test -p roc_cli
&lt;--- snip----&gt;
---- cli_run::false_interpreter stdout ----
thread &#39;cli_run::false_interpreter&#39; panicked at crates/cli/tests/cli_run.rs:261:29:
`valgrind` exited with no exit code. valgrind stdout was: &quot;&quot;

valgrind stderr was: &quot;thread panicked while processing panic. aborting.
&quot;
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace


failures:
    cli_run::false_interpreter

test result: FAILED. 57 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 38.66s
</code></pre></div>



<a name="466142947"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142947" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142947">(Aug 30 2024 at 02:09)</a>:</h4>
<p>Luke, are you on my latest commit?</p>



<a name="466142962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466142962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466142962">(Aug 30 2024 at 02:09)</a>:</h4>
<p>The answer is yes</p>



<a name="466143008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143008">(Aug 30 2024 at 02:10)</a>:</h4>
<div class="codehilite"><pre><span></span><code>---- cli_run::false_interpreter stdout ----
thread &#39;cli_run::false_interpreter&#39; panicked at crates/cli/tests/cli_run.rs:314:17:
&gt; expected output to end with:
1414
&gt; but instead got:
handle id: (Err {})

&gt; stderr was:
Application hit a panic: unreachable File.open

note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="466143139"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143139" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143139">(Aug 30 2024 at 02:11)</a>:</h4>
<p>Currently, if I print out the returned <code>Result U64 {}</code> value, it returns <code>Err {}</code></p>



<a name="466143296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143296">(Aug 30 2024 at 02:12)</a>:</h4>
<p>And the Rust side calls <code>panic!</code> on failure, so it's not being returned</p>



<a name="466143316"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143316" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143316">(Aug 30 2024 at 02:12)</a>:</h4>
<p><code>dbg!</code> verifies this</p>



<a name="466143640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143640">(Aug 30 2024 at 02:15)</a>:</h4>
<p>Yeah, feels like it should either be a bad mapping for the return type leading to roc reading the wrong memory as the returned result or a bug in roc leading to incorrect handling of the task after it is loaded</p>



<a name="466143709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143709">(Aug 30 2024 at 02:15)</a>:</h4>
<p>Could be the latter, but in most of my testing of this feature it was the former</p>



<a name="466143725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143725">(Aug 30 2024 at 02:15)</a>:</h4>
<p>Valgrind is angry <a href="https://gist.github.com/lukewilliamboswell/086f5cb00b923a6269fc16a2ea662104">https://gist.github.com/lukewilliamboswell/086f5cb00b923a6269fc16a2ea662104</a></p>



<a name="466143867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466143867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466143867">(Aug 30 2024 at 02:16)</a>:</h4>
<p>can you show the result from an optimized build as well?</p>



<a name="466144117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466144117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466144117">(Aug 30 2024 at 02:18)</a>:</h4>
<p>Is this normal??</p>
<div class="codehilite"><pre><span></span><code>lb-dev@lb-dev:~/github/roc$ valgrind examples/cli/false-interpreter/False examples/cli/false-interpreter/examples/sqrt.false &amp;&gt; out2.txt
Aborted (core dumped)
lb-dev@lb-dev:~/github/roc$ head out2.txt
==71529== Memcheck, a memory error detector
==71529== Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
==71529== Using Valgrind-3.18.1 and LibVEX; rerun with -h for copyright info
==71529== Command: examples/cli/false-interpreter/False examples/cli/false-interpreter/examples/sqrt.false
==71529==
==71529== Conditional jump or move depends on uninitialised value(s)
==71529==    at 0x14DAA9: ??? (in /home/lb-dev/github/roc/examples/cli/false-interpreter/False)
==71529==    by 0x14C585: ??? (in /home/lb-dev/github/roc/examples/cli/false-interpreter/False)
==71529==    by 0x4887B17: ??? (in /usr/lib/x86_64-linux-gnu/libc.so.6)
==71529==    by 0x1FFEFFFBEF: ???
</code></pre></div>



<a name="466144177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466144177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466144177">(Aug 30 2024 at 02:18)</a>:</h4>
<p>Valgrind crashing?</p>



<a name="466144351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466144351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466144351">(Aug 30 2024 at 02:19)</a>:</h4>
<p>Normal? no. Happens? on occasion</p>



<a name="466144364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466144364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466144364">(Aug 30 2024 at 02:19)</a>:</h4>
<p>Here's an optimized version <a href="https://gist.github.com/lukewilliamboswell/ac614630e785ac6592497432031697d2">https://gist.github.com/lukewilliamboswell/ac614630e785ac6592497432031697d2</a></p>



<a name="466144805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466144805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466144805">(Aug 30 2024 at 02:23)</a>:</h4>
<p>So probably one of the things making valgrind angry is roc reading the wrong memory at some point leading to it seeing <code>Err {}</code> instead of the correct result from the file task</p>



<a name="466144892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466144892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466144892">(Aug 30 2024 at 02:24)</a>:</h4>
<p>Is valgrind happy with all of the other examples? I would guess so cause you said this is the only failing test case?</p>



<a name="466145039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466145039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466145039">(Aug 30 2024 at 02:26)</a>:</h4>
<p>I would guess this is some sort of regression with deeply nested lambdasets cause that is what makes false special (terible code with tons of copies, allocations, and lambdasets).</p>



<a name="466145064"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466145064" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466145064">(Aug 30 2024 at 02:26)</a>:</h4>
<p>but not really sure at this piont</p>



<a name="466145131"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466145131" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466145131">(Aug 30 2024 at 02:27)</a>:</h4>
<p>Also... <span aria-label="tear" class="emoji emoji-1f972" role="img" title="tear">:tear:</span> <code>[1]    1329912 IOT instruction  valgrind examples/cli/false-interpreter/False  &amp;&gt; out.txt</code> I can't even run valgrind on the false intrpreter from the <code>builtin-task-wip</code> branch</p>



<a name="466145234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466145234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466145234">(Aug 30 2024 at 02:28)</a>:</h4>
<p>That's my other branch...</p>



<a name="466145247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466145247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466145247">(Aug 30 2024 at 02:28)</a>:</h4>
<p>I've also got issues with other test platforms on that one</p>



<a name="466145425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466145425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466145425">(Aug 30 2024 at 02:30)</a>:</h4>
<p>I'll get the proper branch, just more effort cause it is on a fork</p>



<a name="466146429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146429">(Aug 30 2024 at 02:38)</a>:</h4>
<p>Same on the proper branch....</p>



<a name="466146454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146454">(Aug 30 2024 at 02:38)</a>:</h4>
<p>Hmmmmm</p>



<a name="466146473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146473">(Aug 30 2024 at 02:38)</a>:</h4>
<p>let me fully clean...maybe a cached artifact or something</p>



<a name="466146526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146526">(Aug 30 2024 at 02:39)</a>:</h4>
<p>I think your theory of false-interpreter -&gt; unification issue could be it</p>



<a name="466146695"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146695" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146695">(Aug 30 2024 at 02:41)</a>:</h4>
<p>In general, I feel like this is a real bug and not something false interpreter specific, but I also think that it may not be worth fixing (for this pr). It might get fixed with the future lambdaset cleanup work.</p>



<a name="466146737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146737">(Aug 30 2024 at 02:41)</a>:</h4>
<p>It might be a super big time sync....hard to say.</p>



<a name="466146840"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146840" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146840">(Aug 30 2024 at 02:42)</a>:</h4>
<p>Do we have an extra level of closures in tasks now due to this change? Or is the builtin type still the same as with effect?</p>



<a name="466146940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146940">(Aug 30 2024 at 02:43)</a>:</h4>
<p>Literally a copy of Effect</p>



<a name="466146958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146958">(Aug 30 2024 at 02:43)</a>:</h4>
<p>The only difference being that we've changed to assume everything is a Result, instead of arbitrary types.</p>



<a name="466146976"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466146976" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466146976">(Aug 30 2024 at 02:43)</a>:</h4>
<p>So not literally a copy of Effect, but literally a copy of Effect, if you catch my drift.</p>



<a name="466147039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466147039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466147039">(Aug 30 2024 at 02:44)</a>:</h4>
<p>Yes, I'd like to see if fixing the lambda set issues will fix this, it feels unrelated.</p>



<a name="466147287"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466147287" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466147287">(Aug 30 2024 at 02:47)</a>:</h4>
<p>If it is the only blocking test, I say table it. <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span> this isn't something common in the wild when this goes out.</p>



<a name="466147306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466147306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466147306">(Aug 30 2024 at 02:47)</a>:</h4>
<p>Okay, I'll disable it and let Anton know in the comments of the PR</p>



<a name="466147401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466147401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466147401">(Aug 30 2024 at 02:48)</a>:</h4>
<p>My guess is we are holding lambdasets a little bit differently and they are breaking. There are a lot of captures and any one could be messed up. So let's look at it again when we fix up lambdasets</p>



<a name="466156294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466156294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466156294">(Aug 30 2024 at 04:24)</a>:</h4>
<p>I'm afraid this may be related to Task as Builtin... so I'm posting here. </p>
<p>I've been working on a PR to add support for Json Web Tokens to basic-webserver <br>
<a href="https://github.com/roc-lang/basic-webserver/pull/72">https://github.com/roc-lang/basic-webserver/pull/72</a></p>
<p>I'm getting a random segfault using the builtin task branch. </p>
<p>The builtin task PR is a branch on my fork, but I've made this PR on roc-lang/basic-webserver so it's easier to see -- but it's the last 2 commits and based off the builtin-task branch.</p>



<a name="466156830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466156830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466156830">(Aug 30 2024 at 04:28)</a>:</h4>
<p>It doesn't do anything yet, just sets up the interface between roc and the host and stubs out the impl.</p>



<a name="466157166"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157166" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157166">(Aug 30 2024 at 04:32)</a>:</h4>
<p>Yeah, I'm really hoping I've done something obviously wrong...</p>



<a name="466157365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157365">(Aug 30 2024 at 04:34)</a>:</h4>
<p>Ok, I might be doing something strange... built a clean version on linux and it's happy. So I must have a cache or something strange on mac. <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="466157566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157566">(Aug 30 2024 at 04:36)</a>:</h4>
<p>Yeah false alarm <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> cleaned out my cargo cache and rebuilt everything and it's looking fine.</p>



<a name="466157605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157605">(Aug 30 2024 at 04:37)</a>:</h4>
<p>Yay</p>



<a name="466157692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157692">(Aug 30 2024 at 04:38)</a>:</h4>
<p>My heart</p>



<a name="466157702"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157702" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157702">(Aug 30 2024 at 04:38)</a>:</h4>
<p>Sorry to do this to you guys.</p>



<a name="466157742"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157742" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157742">(Aug 30 2024 at 04:39)</a>:</h4>
<p>Luckily you've already bled for this feature change, so I can't be mad</p>



<a name="466157804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157804">(Aug 30 2024 at 04:39)</a>:</h4>
<p>I don't think I'll be able to sleep until Anton hit's merge on that PR... <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="466157930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466157930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466157930">(Aug 30 2024 at 04:40)</a>:</h4>
<p>I don't know why I keep testing things... I'm bound to find an issue.</p>



<a name="466174241"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466174241" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466174241">(Aug 30 2024 at 06:40)</a>:</h4>
<p>There is something really messed up with our cargo setup for basic-webserver. </p>
<p>I've been trying to add a single test that I can run using <code>cargo test</code> and it's complicated. I haven't been able to achieve it yet. <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="466174310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466174310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466174310">(Aug 30 2024 at 06:41)</a>:</h4>
<p>I was wanting to write a unit test for each of the JWT algorithms, but I think I'm limited to doing it all in a roc example for now which isn't ideal.</p>



<a name="466308768"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466308768" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466308768">(Aug 30 2024 at 16:50)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> for the <code>basic-webserver</code> task branch, there's a TODO to use a proper <code>basic-cli</code> task release for scripts/testing. Do you want to wait to prepare a release, or am I good to just cleanup everything, leave the <code>0.15-testing</code> release, and get ready for merge after approval?</p>



<a name="466308914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466308914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466308914">(Aug 30 2024 at 16:51)</a>:</h4>
<p>I was just about to start building basic-cli 0.15 :)</p>



<a name="466309089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466309089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466309089">(Aug 30 2024 at 16:53)</a>:</h4>
<p>Well then!</p>



<a name="466309119"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Task%20as%20builtin/near/466309119" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Task.20as.20builtin.html#466309119">(Aug 30 2024 at 16:53)</a>:</h4>
<p>I'll still do everything else, we can update the final download link at that point</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>zig 0.11 · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html">zig 0.11</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="390852567"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390852567" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390852567">(Sep 14 2023 at 04:53)</a>:</h4>
<p>I started looking at zig 0.11 again. I think we have been using the allocator api wrong (at least in tests and probably elsewhere). We have been using <code>alloc</code> and <code>destroy</code>. In reality, <code>alloc</code> is meant to be used with <code>free</code> and <code>destroy</code> is meant to be used with <code>create</code>. The difference between the apis is that <code>alloc/free</code> are for arrays and <code>create/destroy</code> are for single elements.</p>



<a name="390852721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390852721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390852721">(Sep 14 2023 at 04:55)</a>:</h4>
<p>The new annoyances is that we need to correctly use <code>alloc</code> and <code>free</code>. Sadly, free requires a slice or array pointer as the input. Both of these contain the size information. So now, for our dealloc function to work, we need to track the size and use it to generate a correct array before freeing.</p>



<a name="390853046"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390853046" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390853046">(Sep 14 2023 at 04:58)</a>:</h4>
<p>So either, we need to change the allocator to allocate extra bytes and store the size of the allocation on the heap, or we need to always pass the size information into <code>roc_dealloc</code>.</p>



<a name="390853188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390853188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390853188">(Sep 14 2023 at 05:00)</a>:</h4>
<p>Not necessarily surprising, just inconvenient. To be fair, I think this is the same issue with the rust allocator api. Which is why we tend to just call malloc and free directly in rust platforms.</p>



<a name="390853443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390853443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390853443">(Sep 14 2023 at 05:02)</a>:</h4>
<p>given our only dynamic data structures are built on lists and strings (which know their exact size), I think it may be worth revisiting if we should pass the size into <code>roc_dealloc</code>. We already have to pass the size into <code>roc_realloc</code></p>



<a name="390860490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390860490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390860490">(Sep 14 2023 at 06:19)</a>:</h4>
<p>Yeah I've often thought we should pass the size to roc_dealloc. The current signature feels like it's modelled specifically on libc <code>free</code>. It forces the allocator to remember the size. But it's easy for us to generate code to load the size.</p>



<a name="390900680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390900680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390900680">(Sep 14 2023 at 10:31)</a>:</h4>
<p>I think there was a reason we couldn't always have access to the size when calling free - and I think it was seamless slices?</p>



<a name="390900786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390900786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390900786">(Sep 14 2023 at 10:32)</a>:</h4>
<p>but I also think we wanted to start storing capacity on the heap, which would address that</p>



<a name="390983268"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390983268" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390983268">(Sep 14 2023 at 16:56)</a>:</h4>
<p>So update list/str representation that store the capacity on heap when going from 1 to 2 RC. Then when freeing (roc 1 to 0), if a proper list, just use capacity stored on stack. If seamless slices, use the capacity on the heap.</p>
<p>Then update roc_dealloc to also take a size?</p>



<a name="390991827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390991827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390991827">(Sep 14 2023 at 17:52)</a>:</h4>
<p>I think we might as well always store capacity on the heap, because we have to leave room for it either way</p>



<a name="390991856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390991856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390991856">(Sep 14 2023 at 17:52)</a>:</h4>
<p>because it's at the start of the allocation rather than the end</p>



<a name="390991969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/390991969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#390991969">(Sep 14 2023 at 17:53)</a>:</h4>
<p>I forget if we talked about storing it at the end, but that's actually interesting if we only did it when RC &gt; 1 because it could mean smaller heap allocation sizes if your thing is never shared <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="391018148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/391018148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#391018148">(Sep 14 2023 at 21:05)</a>:</h4>
<p>But then you would have to reallocate on sharing if you don't have capacity?</p>



<a name="391018669"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/391018669" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#391018669">(Sep 14 2023 at 21:10)</a>:</h4>
<p>yep</p>



<a name="391018958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/391018958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#391018958">(Sep 14 2023 at 21:12)</a>:</h4>
<p>oh wait, if it's a slice it wouldn't know where to find that capacity bc it wouldn't know the original length or the original capacity ahead of time</p>



<a name="391018971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/391018971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#391018971">(Sep 14 2023 at 21:13)</a>:</h4>
<p>so I guess it would have to be next to the refcount</p>



<a name="391021734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/391021734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#391021734">(Sep 14 2023 at 21:36)</a>:</h4>
<p>Good catch</p>



<a name="391021830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/391021830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#391021830">(Sep 14 2023 at 21:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.200.2E11/near/390991827">said</a>:</p>
<blockquote>
<p>I think we might as well always store capacity on the heap, because we have to leave room for it either way</p>
</blockquote>
<p>Oh also, the reason I didn't say to always store it is to avoid wasting trips to memory. Only write it when there is a chance it will be needed</p>



<a name="392407955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392407955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392407955">(Sep 21 2023 at 23:04)</a>:</h4>
<p>So I changed the allocator stuff for the testing allocator in the standard library instead of trying to update the slice representation. Want to take a serious look at switching to zig 0.11 and llvm 16 with the easy path. Avoid us falling farther and farther behind on versioning. So for now, fine changing the allocator impl or switching to malloc and free if necessary.</p>



<a name="392408053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392408053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392408053">(Sep 21 2023 at 23:05)</a>:</h4>
<p>A lot of gen tests that call zig functions that format numbers to strings are stack overflowing. Really unsure as to why. Did some testing directly in zig and the equivalent tests pass just fine. Not really sure what I am missing at the moment.</p>



<a name="392408658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392408658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392408658">(Sep 21 2023 at 23:11)</a>:</h4>
<p>Interesting. Could it be something in the test setup on the rust side? Folkert mentioned that he is suspicious of that part of our code which might be causing issues with windows. Something about rust dropping things that were allocated in zig.</p>



<a name="392409185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392409185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392409185">(Sep 21 2023 at 23:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281543">Folkert de Vries</span> <a href="#narrow/stream/395097-compiler-development/topic/Casual.20Conversation/near/392122386">said</a>:</p>
<blockquote>
<p>we know the cause of these issues right?</p>
<ul>
<li>we use zig in a tempdir, which means nothing gets cached between builds. The solution is to have a tempdir per thread, not per test, so after the first test most zig stuff is cached</li>
<li>we know that there is a segfault when rust tries to deallocate strings/lists that were allocated by a zig builtin.</li>
</ul>
</blockquote>



<a name="392409678"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392409678" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392409678">(Sep 21 2023 at 23:22)</a>:</h4>
<p>I don't think this is the same. This is apparently only on m1 Mac, not on x86. And it is a stack overflow that looks to be happening in the bufPrint function in zig.</p>



<a name="392410151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392410151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392410151">(Sep 21 2023 at 23:27)</a>:</h4>
<p>Also, apparently on m1 macs, dec is now <code>[2 x i64] %arg</code>, but on x86, it is <code>i64 %hi, i64 %lo</code>...that's just kinda inconvenient.</p>



<a name="392414088"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392414088" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392414088">(Sep 22 2023 at 00:11)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> related to your type erasure stuff, so maybe you have an idea. Do you know how we can get the type of the refcounter here. It is a pointer to a function, but we need to know the type of the underlying function, which is no longer stored with pointers in llvm anymore.</p>
<p><a href="https://github.com/roc-lang/roc/blob/e91b50acf9e68ae84720e039c90ee2023c434788/crates/compiler/gen_llvm/src/llvm/refcounting.rs#L469">old code</a></p>
<p><a href="https://github.com/roc-lang/roc/blob/3a989d10d8b8cf8ff99c3b45418a9d5a20744dee/crates/compiler/gen_llvm/src/llvm/refcounting.rs#L469">Current wrong testing code</a>. I had test just using the <code>fn_val</code> that was passed in, but it doesn have the right function signiture based on the generated llvm ir and is failing some capture tests.</p>



<a name="392424170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392424170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392424170">(Sep 22 2023 at 01:43)</a>:</h4>
<p>i’m not 100% sure i follow. what is the difference between the two codes you shared you’re trying to reconcile? is one compiling with llvm opaque pointers?</p>



<a name="392427948"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392427948" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392427948">(Sep 22 2023 at 02:29)</a>:</h4>
<p>The old code could just use <code>build_call</code> which under the hood would understand the function pointer type and make a indirect call. The new version has to make the indirect call via <code>build_indirect_call</code>. That requires us to specify the function type since it is no longer possible to just grab it from the pointer. So yes, the second one is with opaque pointers and I think I am feeding the wrong function type to it, but I am not sure where I could get the correct one from.</p>



<a name="392441141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392441141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392441141">(Sep 22 2023 at 05:14)</a>:</h4>
<p>nvm, figured it out. tests are passing now.</p>



<a name="392442756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392442756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392442756">(Sep 22 2023 at 05:35)</a>:</h4>
<p>Also the tests that are stack overflowing are only doing so on my m1 mac. Somehow it is caused by the memcpy implementatoin or by how it is being called.</p>



<a name="392442867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392442867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392442867">(Sep 22 2023 at 05:36)</a>:</h4>
<p>maybe I updated it to zig 0.11 wrong and it infinitely loops somehow or maybe it is exposed incorrectly.</p>



<a name="392444115"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392444115" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392444115">(Sep 22 2023 at 05:49)</a>:</h4>
<p>Also, fun failing test case: <code>tan 1f64</code> on m1 mac: <code>1.5574077246549023</code>. Same thing on x86 linux: <code>1.5574077246549020</code>. Off by the lowest bit.</p>
<p>The answers rounded opposite directions and thus are now failing on one device or the other. Interestingly, this fails starting with the newer version of zig/llvm, but was passing in the past.</p>



<a name="392446051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392446051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392446051">(Sep 22 2023 at 06:05)</a>:</h4>
<p>Figured out the memcpy issue as well. The musl fallback memcpy was being optimized such that it was calling memcpy recursively. Definetly should long term look into disabling the promote to memcpy optimization here. But was able to work around it overall.</p>



<a name="392480611"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392480611" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392480611">(Sep 22 2023 at 09:44)</a>:</h4>
<p>Awesome work Brendan!</p>



<a name="392552326"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392552326" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392552326">(Sep 22 2023 at 15:57)</a>:</h4>
<p>This branch is actually turning out better than I expected.</p>
<p>On x86 linux<br>
<del><code>cargo test</code> on has only one failure. It is related to the dev backend and is probably due to incorrect cabi to a builtin (looks to be with returning a Result of a Dec).</del><br>
<code>cargo test</code> is passing</p>
<p>On m1 mac,<br>
<del>3 cli run tests related to parsing are failing (not sure why yet,  still a memcpy issue) And</del><br>
Just 1 gen test due to float rounding.</p>
<p>wasm... is really broken right now (both dev and llvm, probably cabi and wasm-ld changes).</p>
<p>But given <del>essentially</del> all cli run tests are working, I am pretty positive that we should be able to fix up these bugs and actually finally merge an update to zig and llvm. <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="392560075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392560075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392560075">(Sep 22 2023 at 16:29)</a>:</h4>
<p>Oh wow, excellent stuff!</p>



<a name="392560181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392560181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392560181">(Sep 22 2023 at 16:29)</a>:</h4>
<p>If I remember correctly, lots of things changed on the wasm side in Zig.</p>



<a name="392560238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392560238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392560238">(Sep 22 2023 at 16:29)</a>:</h4>
<p>I think they fixed a load of CABI problems that we had workarounds for</p>



<a name="392560328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392560328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392560328">(Sep 22 2023 at 16:30)</a>:</h4>
<p>Those were originally meant to be 0.10 but didn't make it... I think</p>



<a name="392560374"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392560374" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392560374">(Sep 22 2023 at 16:30)</a>:</h4>
<p>anyway I had a branch for this at some point and I got the Wasm stuff working</p>



<a name="392560563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392560563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392560563">(Sep 22 2023 at 16:31)</a>:</h4>
<p>I'll dig around and see if I can find something useful!</p>



<a name="392561191"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392561191" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392561191">(Sep 22 2023 at 16:33)</a>:</h4>
<p>This is the PR I was thinking of. <a href="https://github.com/roc-lang/roc/pull/3856">https://github.com/roc-lang/roc/pull/3856</a></p>



<a name="392561560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392561560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392561560">(Sep 22 2023 at 16:34)</a>:</h4>
<p>There are lots of comments and I haven't gone through them to remember what's relevant or not</p>



<a name="392561825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392561825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392561825">(Sep 22 2023 at 16:36)</a>:</h4>
<p>I'll start looking at the commits and see if I can pull in the wasm related changes.</p>



<a name="392570704"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392570704" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392570704">(Sep 22 2023 at 17:29)</a>:</h4>
<p>Cherrypicking worked for the most part, dev wasm is mostly happy. It has just a couple of failures left:</p>
<div class="codehilite"><pre><span></span><code>failures:
    gen_list::list_range_length_overflow
    gen_list::release_excess_capacity
    gen_list::release_excess_capacity_empty
    gen_list::release_excess_capacity_with_len
    gen_refcount::non_nullable_unwrapped_alignment_8
    gen_refcount::union_recursive_inc
    wasm_linking::test_linking_with_dce
    wasm_linking::test_linking_without_dce
</code></pre></div>
<p>After those, I think all that is left should be llvm wasm updates. It has the wrong abi now in many cases.</p>



<a name="392595269"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392595269" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392595269">(Sep 22 2023 at 20:23)</a>:</h4>
<p>Oh cool! I'm glad those commits finally got used, a year later, and worked!</p>



<a name="392596316"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392596316" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392596316">(Sep 22 2023 at 20:32)</a>:</h4>
<p>I don't recognise those particular <code>gen_list</code> tests, they might be "new" since then.<br>
The refcount stuff involves that module in mono, <code>code_gen_help</code> or whatever I called it, and at the very lowest level it does call Zig builtins to do the dec or inc operation.<br>
The wasm_linking tests, as you would guess, are for the Wasm surgical linking functionality. I guess that must be some change in the ABI where we link to builtins.</p>



<a name="392615245"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392615245" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392615245">(Sep 22 2023 at 23:20)</a>:</h4>
<p>yooooooo this is so great!!!</p>



<a name="392624340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392624340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392624340">(Sep 23 2023 at 00:57)</a>:</h4>
<p>If you have any issues with windows I am happy to assist where I can. I know Folkert and I discovered some differences between register use between zig versions which shouldn't be too hard to fix.</p>



<a name="392624432"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392624432" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392624432">(Sep 23 2023 at 00:58)</a>:</h4>
<p>We left a note where to change it on zig version update.</p>



<a name="392627570"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392627570" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392627570">(Sep 23 2023 at 01:26)</a>:</h4>
<p>Thanks. will definitely need help there. Though I think I have a computer that can boot windows, I don't know if it works and it definitely does not have roc setup.</p>



<a name="392627581"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392627581" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392627581">(Sep 23 2023 at 01:26)</a>:</h4>
<p>Currently getting everything else working first.</p>



<a name="392628408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392628408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392628408">(Sep 23 2023 at 01:34)</a>:</h4>
<p>Just got the llvm wasm tests passing. Hopefully that covers the full abi.</p>



<a name="392630347"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392630347" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392630347">(Sep 23 2023 at 01:54)</a>:</h4>
<p>So it looks like we are down to:</p>
<ul>
<li>the 8 broken dev wasm tests (haven't looked into them yet)</li>
<li>a handful a dev backend tests that hitting invalid frees.</li>
<li>anything broken on windows</li>
</ul>



<a name="392635757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392635757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392635757">(Sep 23 2023 at 02:55)</a>:</h4>
<p>Which branch are you working on?</p>



<a name="392636862"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392636862" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392636862">(Sep 23 2023 at 03:08)</a>:</h4>
<p>I think it is <code>zig-11-llvm-16</code>. Not at home to double check the name rn</p>



<a name="392643257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392643257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392643257">(Sep 23 2023 at 04:32)</a>:</h4>
<p>I had forgotten how much wrangling it was to get LLVM set up correctly... <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="392644222"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392644222" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392644222">(Sep 23 2023 at 04:44)</a>:</h4>
<p>Also, I think I am getting to a point were the last few tests will be much harder for me to fix cause I don't know enough about them. I will definitely try to tinker with them, but I may need others to take over for some subsets of tests. The gen dev failures seem to be related to lambda sets, which I am not really familiar with. The wasm failures that are left are so far not obvious to me.</p>



<a name="392645623"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392645623" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392645623">(Sep 23 2023 at 05:03)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> I'm updating <code>roc-lang/llvm-package-windows</code> to build <code>16.0.4</code> for Windows</p>



<a name="392702551"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392702551" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392702551">(Sep 23 2023 at 13:59)</a>:</h4>
<p>I've built 16.0.6 for windows because that's also the version nix is using<br>
<a href="https://github.com/roc-lang/llvm-package-windows/releases/tag/v16.0.6">https://github.com/roc-lang/llvm-package-windows/releases/tag/v16.0.6</a></p>



<a name="392742706"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392742706" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392742706">(Sep 23 2023 at 21:51)</a>:</h4>
<p>Thank you Anton, I'll test using that.</p>



<a name="392745259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392745259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392745259">(Sep 23 2023 at 22:24)</a>:</h4>
<p>Any idea what might be causing this issue?</p>
<div class="codehilite"><pre><span></span><code>error: failed to run custom build command for `roc_bitcode v0.0.1 (C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode)`

Caused by:
  process didn&#39;t exit successfully: `C:\Users\bosyl\Documents\GitHub\roc\target\release\build\roc_bitcode-1e59ee36b356bf6b\build-script-build` (exit code: 101)
  --- stdout
  cargo:rerun-if-changed=build.rs
  Compiling zig object `object` to: C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-out\builtins-host.obj

  --- stderr
  An internal compiler expectation was broken.
  This is definitely a compiler bug.
  Please file an issue here: https://github.com/roc-lang/roc/issues/new/choose
  thread &#39;main&#39; panicked at &#39;zig build object -Drelease=true failed with:

    error(mingw): clang exited with code 1 and stderr: error: unknown target triple &#39;x86-unknown-windows-gnu&#39;, please use -triple or -arch

  error(mingw): clang exited with code 1 and stderr: error: unknown target triple &#39;x86-unknown-windows-gnu&#39;, please use -triple or -arch

  error(mingw): clang exited with code 1 and stderr: error: unknown target triple &#39;x86-unknown-windows-gnu&#39;, please use -triple or -arch

  error: unable to generate DLL import .lib file for advapi32: ClangPreprocessorFailed

  &#39;, crates\compiler\builtins\bitcode\build.rs:188:21
  note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="392745664"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392745664" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392745664">(Sep 23 2023 at 22:30)</a>:</h4>
<p>See if that target is still in <code>zig targets</code></p>



<a name="392747240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747240">(Sep 23 2023 at 22:49)</a>:</h4>
<p>I'm pretty sure it isn't, <a href="https://gist.github.com/lukewilliamboswell/afa9481513eed23e7796dc64a8340d07">here</a> is the output from <code>zig targets</code> on my windows machine using zig version <code>0.11.0</code>.</p>



<a name="392747304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747304">(Sep 23 2023 at 22:50)</a>:</h4>
<p>But I don't see any triples in the output... so I'm not sure</p>



<a name="392747336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747336">(Sep 23 2023 at 22:51)</a>:</h4>
<p><code>x86_64-windows-gnu</code></p>



<a name="392747339"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747339" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747339">(Sep 23 2023 at 22:51)</a>:</h4>
<p>From the output</p>



<a name="392747349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747349">(Sep 23 2023 at 22:51)</a>:</h4>
<p>But this seems like an issue with forwarding that info to clang rather than directly from zig</p>



<a name="392747414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747414">(Sep 23 2023 at 22:52)</a>:</h4>
<p>Though maybe we are feeding in the unknown and need to remove it</p>



<a name="392747638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747638">(Sep 23 2023 at 22:56)</a>:</h4>
<p>I can definitely see arch contains <code>x86_64</code>, os contains <code>windows</code>, and abi contains <code>gnu</code>, also libc contains <code>x86-windows-gnu</code> so it should be all ok</p>



<a name="392747689"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747689" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747689">(Sep 23 2023 at 22:57)</a>:</h4>
<p>Yeah, but that is not the zig side</p>



<a name="392747693"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747693" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747693">(Sep 23 2023 at 22:57)</a>:</h4>
<p>It is failing when calling mingw clang</p>



<a name="392747719"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747719" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747719">(Sep 23 2023 at 22:58)</a>:</h4>
<p>So we probably need to see what that expects and that it is the right version</p>



<a name="392747821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392747821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392747821">(Sep 23 2023 at 22:59)</a>:</h4>
<p><a href="https://gist.github.com/lukewilliamboswell/90cb90805bad05c745f5cb7f90afdbfa">Here</a> is all of the error it gives. I think I left some important details out before</p>



<a name="392748474"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392748474" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392748474">(Sep 23 2023 at 23:08)</a>:</h4>
<p>I still think it is an issue on the clang side or on the zig passing info to clang. Cause I think this error is that the builtins are failing to compile. Though not really sure why it needs clang at all</p>



<a name="392748475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392748475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392748475">(Sep 23 2023 at 23:08)</a>:</h4>
<p>It should be using the 16.0.6 version <span class="user-mention" data-user-id="361169">@Anton</span> built and I've added an environment variable <code>LLVM_SYS_160_PREFIX</code> pointing to it right?</p>



<a name="392748530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392748530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392748530">(Sep 23 2023 at 23:09)</a>:</h4>
<p>Does zig use clang? maybe it has a different version compared to llvm we are using?</p>



<a name="392748693"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392748693" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392748693">(Sep 23 2023 at 23:11)</a>:</h4>
<p>In <code>crates\compiler\builtins\bitcode\build.zig</code> this might be related?</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">// TODO zig 0.9 can generate .bc directly, switch to that when it is released!</span>
<span class="k">fn</span><span class="w"> </span><span class="n">generateLlvmIrFile</span><span class="p">(</span><span class="w"> </span><span class="p">...</span>
</code></pre></div>



<a name="392749310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392749310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392749310">(Sep 23 2023 at 23:20)</a>:</h4>
<p>I updated that file but didn't pay attention to comments, so that may be stale now</p>



<a name="392749597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392749597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392749597">(Sep 23 2023 at 23:25)</a>:</h4>
<p>I'm not very familiar with zig build but it has a <code>.use_llvm = true</code> option which makes me think it is using llvm -- which is clang right?</p>



<a name="392750723"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392750723" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392750723">(Sep 23 2023 at 23:43)</a>:</h4>
<p>Pretty sure this is an issue locally with my zig setup</p>



<a name="392751026"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392751026" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392751026">(Sep 23 2023 at 23:48)</a>:</h4>
<p>I can also reproduce the error with </p>
<div class="codehilite"><pre><span></span><code>PS C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode&gt; zig build
error(mingw): clang exited with code 1 and stderr: error: unknown target triple &#39;x86-unknown-windows-gnu&#39;, please use -triple or -arch

Semantic Analysis [1742] error(mingw): clang exited with code 1 and stderr: error: unknown target triple &#39;x86-unknown-windows-gnu&#39;, please use -triple or -arch

Semantic Analysis [5018] error(mingw): clang exited with code 1 and stderr: error: unknown target triple &#39;x86-unknown-windows-gnu&#39;, please use -triple or -arch

error: unable to generate DLL import .lib file for advapi32: ClangPreprocessorFailed
</code></pre></div>



<a name="392752779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392752779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392752779">(Sep 24 2023 at 00:11)</a>:</h4>
<p>Figured out a workaround, I had been downloading zig binaries from the zig downloads page which was giving me the above error. I installed using the scoop package manager and it it now building zig ok.</p>



<a name="392752813"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392752813" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392752813">(Sep 24 2023 at 00:12)</a>:</h4>
<p>Interesting</p>



<a name="392752876"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392752876" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392752876">(Sep 24 2023 at 00:12)</a>:</h4>
<p>So use llvm is because they use the llvm backend instead of the new zig backends</p>



<a name="392752897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392752897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392752897">(Sep 24 2023 at 00:12)</a>:</h4>
<p>So not related to clang, but related to llvm the same way that roc uses llvm</p>



<a name="392752974"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392752974" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392752974">(Sep 24 2023 at 00:13)</a>:</h4>
<p>We need it to generate bc and llvm ir files.</p>



<a name="392752982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392752982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392752982">(Sep 24 2023 at 00:13)</a>:</h4>
<p>Or at least I assume we need it</p>



<a name="392752990"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392752990" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392752990">(Sep 24 2023 at 00:13)</a>:</h4>
<p>Haven't tested otherwise</p>



<a name="392753075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392753075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392753075">(Sep 24 2023 at 00:14)</a>:</h4>
<p>Getting a different error now</p>
<div class="codehilite"><pre><span></span><code>error: failed to run custom build command for `roc_bitcode v0.0.1 (C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode)`

Caused by:
  process didn&#39;t exit successfully: `C:\Users\bosyl\Documents\GitHub\roc\target\release\build\roc_bitcode-1e59ee36b356bf6b\build-script-build` (exit code: 101)
  --- stdout
  cargo:rerun-if-changed=build.rs
  Compiling zig object `object` to: C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-out\builtins-host.obj
  Moving zig object `object` to: C:\Users\bosyl\Documents\GitHub\roc\target\release\build\roc_bitcode-be7313a61ad78acf\out\builtins-host.obj

  --- stderr
  An internal compiler expectation was broken.
  This is definitely a compiler bug.
  Please file an issue here: https://github.com/roc-lang/roc/issues/new/choose
  thread &#39;main&#39; panicked at &#39;Failed to copy object file C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-out\builtins-host.obj to C:\Users\bosyl\Documents\GitHub\roc\target\release\build\roc_bitcode-be7313a61ad78acf\out\builtins-host.obj: Os { code: 2, kind: NotFound, message: &quot;The system cannot find the file specified.&quot; }&#39;, crates\compiler\builtins\bitcode\build.rs:85:9
  note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
warning: build failed, waiting for other jobs to finish...
error: failed to run custom build command for `roc_bitcode v0.0.1 (C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode)`

Caused by:
  process didn&#39;t exit successfully: `C:\Users\bosyl\Documents\GitHub\roc\target\release\build\roc_bitcode-1e59ee36b356bf6b\build-script-build` (exit code: 101)
  --- stdout
  cargo:rerun-if-changed=build.rs
  Compiling zig object `object` to: C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-out\builtins-host.obj

  --- stderr
  An internal compiler expectation was broken.
  This is definitely a compiler bug.
  Please file an issue here: https://github.com/roc-lang/roc/issues/new/choose
  thread &#39;main&#39; panicked at &#39;zig build object -Drelease=true failed with:

    install generated to builtins-host.o: error: unable to update file from &#39;C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-cache\o\bd7e129e78e30bd9f9a6e12129f6341d\builtins-host.obj&#39; to &#39;C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-out\builtins-host.o&#39;: AccessDenied
  Build Summary: 1/3 steps succeeded; 1 failed (disable with --summary none)
  object transitive failure
  +- install generated to builtins-host.o failure
  error: the following build command failed with exit code 1:
  C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-cache\o\574ac17d089f96475a6e004e49db08e1\build.exe C:\Users\bosyl\scoop\apps\zig\current\zig.exe C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode C:\Users\bosyl\Documents\GitHub\roc\crates\compiler\builtins\bitcode\zig-cache C:\Users\bosyl\AppData\Local\zig object -Drelease=true

  &#39;, crates\compiler\builtins\bitcode\build.rs:188:21
  note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="392753202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392753202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392753202">(Sep 24 2023 at 00:15)</a>:</h4>
<p>Oh, do we need to change <code>.o</code> to <code>.obj</code>? I thought I already had that.</p>



<a name="392753303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392753303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392753303">(Sep 24 2023 at 00:16)</a>:</h4>
<p>Is <a href="https://github.com/ziglang/zig/issues/8362#issuecomment-1033407110">this issue</a> related?</p>



<a name="392753498"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392753498" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392753498">(Sep 24 2023 at 00:18)</a>:</h4>
<p>Oh, actually yeah, it is failing to write the file to the output directory</p>



<a name="392753513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392753513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392753513">(Sep 24 2023 at 00:18)</a>:</h4>
<p>Though also, it is trying to name it wrong</p>



<a name="392755578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392755578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392755578">(Sep 24 2023 at 00:38)</a>:</h4>
<p>As a workaround I changed from <code>builtins-host.obj</code> to <code>builtins-host.o</code> in <code>crates\compiler\builtins\bitcode\build.rs</code> and was able to finish building roc using <code>cargo build --release --locked</code> with no further issues. <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="392755661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392755661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392755661">(Sep 24 2023 at 00:39)</a>:</h4>
<p>I'm guessing we need zig to write the host as <code>.obj</code> when compiling on windows. There is the below, which I think is related, but not sure why it isn't working</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">var</span><span class="w"> </span><span class="n">suffix</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">os_tag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="n">windows</span><span class="p">)</span>
<span class="w">        </span><span class="s">"obj"</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="s">"o"</span><span class="p">;</span>
</code></pre></div>



<a name="392756560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392756560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392756560">(Sep 24 2023 at 00:47)</a>:</h4>
<p>Adding the debug print below...</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">// Targets</span>
<span class="kr">const</span><span class="w"> </span><span class="n">host_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">standardTargetOptions</span><span class="p">(.{</span>
<span class="w">    </span><span class="p">.</span><span class="n">default_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CrossTarget</span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">cpu_model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">baseline</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">});</span>

<span class="n">std</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="s">"{?}"</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">host_target</span><span class="p">});</span>
</code></pre></div>
<p>Gives <code>debug: zig.CrossTarget{ .. other stuff, .os_tag = null, ...}</code>. However we use <code>target.os_tag</code> in <code>generateObjectFile</code> to determine the suffix.</p>



<a name="392756773"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392756773" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392756773">(Sep 24 2023 at 00:49)</a>:</h4>
<p>From the docs, <code>os_tag: ?Target.Os.Tag = null</code>, null means native.</p>



<a name="392759850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392759850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392759850">(Sep 24 2023 at 01:16)</a>:</h4>
<p>Pushed a fix for this, now builds without any issues. Running the other tests now.</p>



<a name="392760159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392760159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392760159">(Sep 24 2023 at 01:19)</a>:</h4>
<p>All the llvm backend tests look like they are failing with the same issue <code>error: unrecognized parameter: '--strip'</code></p>
<div class="codehilite"><pre><span></span><code>--- STDERR:              test_gen::test_gen gen_compare::list_neq_nested ---
error: unrecognized parameter: &#39;--strip&#39;
thread &#39;gen_compare::list_neq_nested&#39; panicked at &#39;
___________
Linking command failed with status ExitStatus(ExitStatus(1)):

  Child { stdin: None, stdout: None, stderr: None, .. }
___________
&#39;, crates\compiler\build\src\link.rs:1305:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="392760808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392760808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392760808">(Sep 24 2023 at 01:25)</a>:</h4>
<p>All the Zig tests are still passing on Windows</p>



<a name="392761941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392761941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392761941">(Sep 24 2023 at 01:36)</a>:</h4>
<p>Fixed the linking issue for Windows by removing the "--strip" option.</p>



<a name="392764495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392764495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392764495">(Sep 24 2023 at 02:08)</a>:</h4>
<p>I updated the github workflows for Windows to reference the correct dependencies.</p>



<a name="392764631"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392764631" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392764631">(Sep 24 2023 at 02:10)</a>:</h4>
<p>Almost all the CI tests for windows pass; however there are a few <code>cli_run</code> tests that are now failing with the same issue <code>I don't know the address of the libc.memcpy_decision function</code></p>
<div class="codehilite"><pre><span></span><code>---- cli_run::hello_gui stdout ----
thread &#39;cli_run::hello_gui&#39; panicked at &#39;
___________
The roc command:

  &quot;C:\\Users\\bosyl\\Documents\\GitHub\\roc\\target\\debug\\roc.exe build --optimize C:\\Users\\bosyl\\Documents\\GitHub\\roc\\examples\\gui\\helloBROKEN.roc --&quot;

had unexpected stderr:

  🔨 Rebuilding platform...
I don&#39;t know the address of the libc.memcpy_decision function! this may cause segfaults
I don&#39;t know the address of the libc.memcpy_decision function! this may cause segfaults

___________
&#39;, crates\cli\tests\cli_run.rs:148:13
</code></pre></div>



<a name="392772930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392772930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392772930">(Sep 24 2023 at 04:01)</a>:</h4>
<p>I found this <a href="https://ziglang.org/download/0.10.0/release-notes.html#compiler-rt">0.10.0/release-notes</a> which may be related and explain why we are seeing this issue now.</p>
<blockquote>
<p>Started consolidating libc functions that codegen depends on into compiler-rt (<a href="https://github.com/roc-lang/roc/issues/7265">#7265</a>)<br>
Compiler backends want to emit calls to e.g. memcpy or sqrt. These are typically provided by libc, but they might not be in the case of freestanding, or depending on which third party libc is linked against.<br>
Therefore Zig has started to provide all possible symbols with weak linkage, meaning that these symbols will be overridden by libc if provided. This means the only necessary runtime library that Zig objects need to be linked against is compiler-rt, no matter the target.</p>
</blockquote>



<a name="392775296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392775296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392775296">(Sep 24 2023 at 04:26)</a>:</h4>
<p>Oh, that's really cool. May Mena for some libc functions we can just depend on zig and not provide our own if we want to cut out libc.</p>



<a name="392775330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/392775330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#392775330">(Sep 24 2023 at 04:27)</a>:</h4>
<p>Though that depends on if they do highly optimized libc impls and if we want those</p>



<a name="393597008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393597008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393597008">(Sep 28 2023 at 01:40)</a>:</h4>
<p><span class="user-mention" data-user-id="281543">@Folkert de Vries</span> I was working on Windows fixes for this branch with <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> and we made some good progress fixing some LLVM backend issues in <a href="https://github.com/roc-lang/roc/commit/ba0e203816a54d6eefe2e94098a460f4c3c3085f">this commit</a>. We were able to find a fix for the dec issues but we weren't sure the best way to generalise it. Brendan can probably explain this much better than I. Also our assumption that .reloc is the final section for relocations doesn't hold so that it another issue. I am happy to work on this with you when you are back online and have some free time. <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="393802078"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393802078" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393802078">(Sep 28 2023 at 20:41)</a>:</h4>
<p>This PR feels so close. I think we are down to just dev wasm bugs.</p>



<a name="393825048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393825048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393825048">(Sep 29 2023 at 00:34)</a>:</h4>
<p>I updated to macOS Sonoma and I can't build roc anymore because zig 0.9.1 doesn't seem to support it. I naively started to update <code>bitcode/build.zig</code> to work with zig 0.11, but it looks like it wasn't that easy and you folks are already on it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="393825149"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393825149" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393825149">(Sep 29 2023 at 00:35)</a>:</h4>
<p>I should pay more attention to Zulip</p>



<a name="393855968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393855968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393855968">(Sep 29 2023 at 05:25)</a>:</h4>
<p>Figured out a little bit with the wasm tests. Somehow, calling roc_alloc is corrupting memory. It ends up messing up bytes in random places (for example changing bytes in a constant string). That then progagates to the output and thus we have broken tests.</p>



<a name="393857135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393857135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393857135">(Sep 29 2023 at 05:36)</a>:</h4>
<p>Maybe we are linking wrong and it is leading to malloc scratch memory overlapping with some roc constants? <span class="user-mention" data-user-id="431893">@Brian Carroll</span> any thoughts?</p>



<a name="393857518"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393857518" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393857518">(Sep 29 2023 at 05:39)</a>:</h4>
<p>I guess this also points to: first fix any linking related bugs, then turn back to look at other tests. Cause fixing the linker may end up fixing everything else.</p>



<a name="393866176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393866176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393866176">(Sep 29 2023 at 06:42)</a>:</h4>
<p>Yeah I agree. Everything else is way more confusing when there are linking bugs so it's worth fixing them first. Dev Wasm only uses its own linking. I wonder if there's some new kind of relocation used with roc_alloc that we don't support yet...</p>



<a name="393866945"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393866945" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393866945">(Sep 29 2023 at 06:47)</a>:</h4>
<p>There is just one memory block, all with the same permissions. So yeah it's possible in theory for the stack to overflow into constants. There is no segmentation fault if that happens.</p>
<p>Our memory organisation is:<br>
Constants are at low addresses.<br>
Then the stack, which grows downward.<br>
Then the heap, which grows upwards when we extend the size of our total memory.</p>



<a name="393915618"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393915618" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393915618">(Sep 29 2023 at 11:49)</a>:</h4>
<p>There's a source file called <code>linking.rs</code> and I think I put in comments with URLs of relevant docs.</p>



<a name="393915846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/393915846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#393915846">(Sep 29 2023 at 11:51)</a>:</h4>
<p>Also copied and pasted some relevant parts of the docs</p>



<a name="394763940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/394763940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#394763940">(Oct 04 2023 at 05:57)</a>:</h4>
<p>Unrelated to the current bugs but I just noticed the following comment in <code>crates/compiler/build/src/link.rs</code>, might be worth removing in this PR?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// some examples need the compiler-rt in the app object file.</span>
<span class="c1">// but including it on windows causes weird crashes, at least</span>
<span class="c1">// when we use zig 0.9. It looks like zig 0.10 is going to fix</span>
<span class="c1">// this problem for us, so this is a temporary workaround</span>
<span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">target</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">"windows"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">zig_cmd</span><span class="p">.</span><span class="n">args</span><span class="p">([</span>
<span class="w">        </span><span class="c1">// include the zig runtime</span>
<span class="w">        </span><span class="s">"-fcompiler-rt"</span><span class="p">,</span>
<span class="w">    </span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div>



<a name="394769711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/394769711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#394769711">(Oct 04 2023 at 06:46)</a>:</h4>
<p>I would say we should first find out if we still need the code. Try deleting and see what happens. But we might want to get everything else green first so that if it goes red, we know it's because of this.<br>
Then if we still need the code, we update the comment to reflect the current reality.<br>
If we don't need the code, we delete code and comment.</p>



<a name="396392617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396392617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396392617">(Oct 13 2023 at 01:05)</a>:</h4>
<p><code>valgrind: the 'impossible' happened</code></p>



<a name="396392697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396392697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396392697">(Oct 13 2023 at 01:06)</a>:</h4>
<p>When valgrind itself crashes as doesn't know why... the "impossible" happened</p>



<a name="396392912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396392912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396392912">(Oct 13 2023 at 01:07)</a>:</h4>
<p>#goals</p>



<a name="396392916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396392916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396392916">(Oct 13 2023 at 01:07)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> can you double check that valgrind is fully updated on the ci server?</p>



<a name="396393011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396393011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396393011">(Oct 13 2023 at 01:08)</a>:</h4>
<p>Whichever server would run this test: <a href="https://github.com/roc-lang/roc/actions/runs/6502213723/job/17660877316?pr=5851">https://github.com/roc-lang/roc/actions/runs/6502213723/job/17660877316?pr=5851</a></p>



<a name="396394457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396394457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396394457">(Oct 13 2023 at 01:18)</a>:</h4>
<p>I wonder if that one of the tests that was failing for the aarch64 dev backend stuff, might be related.</p>



<a name="396397354"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396397354" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396397354">(Oct 13 2023 at 01:42)</a>:</h4>
<p>I checked my results and it doesn't look like it was one of the aarch64 test failures</p>



<a name="396399751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396399751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396399751">(Oct 13 2023 at 02:02)</a>:</h4>
<p>So trying to dig into the wasm issues currently. Somehow we are getting memory corruption. It happens when calling <code>malloc</code>.</p>



<a name="396400102"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396400102" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396400102">(Oct 13 2023 at 02:04)</a>:</h4>
<p>At least that is my understanding currently</p>



<a name="396416076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396416076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396416076">(Oct 13 2023 at 03:53)</a>:</h4>
<p>I assume this is just the manifestation of a linking bug, but will be interesting to dig into</p>



<a name="396453288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396453288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396453288">(Oct 13 2023 at 08:17)</a>:</h4>
<blockquote>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> can you double check that valgrind is fully updated on the ci server?</p>
</blockquote>
<p>I've upgraded valgrind on the CI machine from 3.18 to 3.21 and restarted the job.</p>



<a name="396468831"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396468831" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396468831">(Oct 13 2023 at 09:38)</a>:</h4>
<p>The error is very similar with the new valgrind but it did add names to the stacktrace instead of <code>???</code>:</p>
<div class="codehilite"><pre><span></span><code>host stacktrace:
==167378==    at 0x5819CDAA: getUChar (guest_amd64_toIR.c:524)
==167378==    by 0x5819CDAA: dis_ESC_NONE (guest_amd64_toIR.c:19967)
==167378==    by 0x581BEA29: disInstr_AMD64_WRK (guest_amd64_toIR.c:32515)
==167378==    by 0x581BF2D3: disInstr_AMD64 (guest_amd64_toIR.c:32683)
==167378==    by 0x5814A176: disassemble_basic_block_till_stop (guest_generic_bb_to_IR.c:956)
==167378==    by 0x5814B2C2: bb_to_IR (guest_generic_bb_to_IR.c:1365)
==167378==    by 0x5812EE72: LibVEX_FrontEnd (main_main.c:583)
==167378==    by 0x5812F7E0: LibVEX_Translate (main_main.c:1235)
==167378==    by 0x5805B0D2: vgPlain_translate (m_translate.c:1831)
==167378==    by 0x580A0679: handle_tt_miss (scheduler.c:1136)
==167378==    by 0x580A0679: vgPlain_scheduler (scheduler.c:1526)
==167378==    by 0x580E6A0D: thread_wrapper (syswrap-linux.c:102)
==167378==    by 0x580E6A0D: run_a_thread_NORETURN (syswrap-linux.c:155)
</code></pre></div>



<a name="396518675"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396518675" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396518675">(Oct 13 2023 at 14:39)</a>:</h4>
<p>So we are crashing valgrind on that machine, but not on any other machines...fun</p>



<a name="396520283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396520283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396520283">(Oct 13 2023 at 14:48)</a>:</h4>
<p>what are the other differences between that machine and the others? OS version? CPU architecture?</p>



<a name="396525144"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396525144" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396525144">(Oct 13 2023 at 15:15)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span>  should know, I think he mentioned that it compiles for the specific cpu instead of generic x86 for example</p>



<a name="396525313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396525313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396525313">(Oct 13 2023 at 15:16)</a>:</h4>
<p>That one runs without nix, so I believe some dependency difference to eventually result in this behavior. I'll do some digging.</p>



<a name="396526843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396526843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396526843">(Oct 13 2023 at 15:24)</a>:</h4>
<p>I'm also going to a <code>apt update &amp;&amp; upgrade</code> on that server, you never know...</p>



<a name="396673080"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396673080" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396673080">(Oct 14 2023 at 19:30)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> for the bus error issue. I do know of an issue in the zig platform in roc_panic, the arg should be a *RocStr not *anyopaque. Maybe that is the issue here? I found this when working on my zig platform, but forgot to submit a PR for it as it seemed really minor.</p>



<a name="396673433"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396673433" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396673433">(Oct 14 2023 at 19:37)</a>:</h4>
<p>Here is a roc_panic that works well, sorry on my phone <a href="https://github.com/lukewilliamboswell/roc-graphics-mach/blob/76a6aa57e972ab82aab309b8bb0fa59bb95d96cd/platform/src/roc.zig#L51">LINK</a></p>



<a name="396712412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396712412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396712412">(Oct 15 2023 at 04:28)</a>:</h4>
<p>I've been looking at the *RocStr thing and I cannot reproduce the issue I was having with the zig platform. I'm not sure how a pointer to <code>[*:0]const u8</code> and a pointer to RocStr can both print out correctly.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">RocStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">str_bytes</span><span class="o">:</span><span class="w"> </span><span class="o">?</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="n">str_len</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">str_capacity</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>The issue I saw was roc_panic would print out garbage but I am not seeing that on the current example at <code>crates/cli_testing_examples/expects/expects.roc</code> so :<span aria-label="man shrugging" class="emoji emoji-1f937-200d-2642" role="img" title="man shrugging">:man_shrugging:</span></p>



<a name="396714637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396714637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396714637">(Oct 15 2023 at 04:44)</a>:</h4>
<p>If the error is a small string, they would have the same format</p>



<a name="396714743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396714743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396714743">(Oct 15 2023 at 04:45)</a>:</h4>
<p>Ah that makes sense. Can confirm that it does mess things up with a large string. I'll make the changes and push to the zig-11 branch, and maybe that will help with our bug.</p>



<a name="396736170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/396736170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#396736170">(Oct 15 2023 at 09:25)</a>:</h4>
<p>I've edited the bus error issue (<a href="https://github.com/roc-lang/roc/issues/5904">#5904</a>) to clarify things. For using dbg with <code>roc dev</code> we use <a href="https://github.com/roc-lang/roc/blob/1c37d8adb1fadf7262711054d0238175fc08e8ec/crates/cli/src/lib.rs#L1074">two "connected" processes</a>. If you don't set up the two processes correctly, like when manually running the executable produced by dev, you also get a bus error. So I think <a href="https://github.com/roc-lang/roc/blob/1c37d8adb1fadf7262711054d0238175fc08e8ec/crates/cli/src/lib.rs#L1090">something in this code</a> is going wrong on the zig-11-llvm-16 branch on the CI machine.</p>



<a name="397948878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/397948878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#397948878">(Oct 22 2023 at 14:34)</a>:</h4>
<p>this might get fixed by replacing the current <code>dbg</code> implementation with one that uses <code>Inspect</code> (once that's auto-derived, which is WIP on a branch but has bugs and doesn't work yet)</p>



<a name="397948915"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/397948915" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#397948915">(Oct 22 2023 at 14:35)</a>:</h4>
<p>at that point we no longer have the "two connected processes" design anymore (which has been basically the entire reason we've had so many <code>dbg</code> issues)</p>



<a name="398202008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398202008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398202008">(Oct 24 2023 at 04:31)</a>:</h4>
<p>It looks like all the test now pass on CI, awesome work <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> this will make a big difference I think.</p>



<a name="398202847"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398202847" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398202847">(Oct 24 2023 at 04:37)</a>:</h4>
<p>Oh wow...yeah. We pushed off 2 issues for a later time (related to dbg rework and a specific wasm issue).</p>



<a name="398202859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398202859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398202859">(Oct 24 2023 at 04:37)</a>:</h4>
<p>That said, I think we are ready to merge</p>



<a name="398202937"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398202937" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398202937">(Oct 24 2023 at 04:38)</a>:</h4>
<p>We also may eventually need to update debugir as well, but again, that has no need to block this branch</p>



<a name="398203067"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398203067" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398203067">(Oct 24 2023 at 04:40)</a>:</h4>
<p>Given this is a bigger change <span class="user-mention" data-user-id="281383">@Richard Feldman</span>, if you want to give a review to approve the merge, that would be great. <a href="https://github.com/roc-lang/roc/issues/5851">#5851</a></p>
<p>Otherwise, if you have any concerns or blockers, please comment as so.</p>



<a name="398203202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398203202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398203202">(Oct 24 2023 at 04:42)</a>:</h4>
<p>Also, thanks <span class="user-mention" data-user-id="361169">@Anton</span>, <span class="user-mention" data-user-id="431893">@Brian Carroll</span> and <span class="user-mention" data-user-id="281543">@Folkert de Vries</span>!</p>
<p>You all helped fix various bugs on this branch to make it a reality.</p>



<a name="398206247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398206247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398206247">(Oct 24 2023 at 05:23)</a>:</h4>
<p>Woohoo! This is great! Well done to you <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> for taking on this huge piece of work and pushing through it to the end!</p>



<a name="398543523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398543523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398543523">(Oct 25 2023 at 18:50)</a>:</h4>
<p>this is now merged!!! <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span>  <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span>  <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span></p>



<a name="398543587"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398543587" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398543587">(Oct 25 2023 at 18:50)</a>:</h4>
<p>thank you so much to everyone who helped make this happen!</p>



<a name="398548097"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398548097" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398548097">(Oct 25 2023 at 19:23)</a>:</h4>
<p>Yay!!!</p>



<a name="398548782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398548782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398548782">(Oct 25 2023 at 19:29)</a>:</h4>
<p>woohoo I can build on Sonoma <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="398549878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398549878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398549878">(Oct 25 2023 at 19:38)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="453336">@Joshua Warner</span> I think this was also blocking you on macOS?</p>



<a name="398549936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398549936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398549936">(Oct 25 2023 at 19:38)</a>:</h4>
<p>Woot!</p>



<a name="398550012"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398550012" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398550012">(Oct 25 2023 at 19:39)</a>:</h4>
<p>Been very busy recently with the process of buying and managing renovations on a house, but will look soon.</p>



<a name="398551695"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%200.11/near/398551695" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.200.2E11.html#398551695">(Oct 25 2023 at 19:52)</a>:</h4>
<p>whoa, awesome - congrats on the house! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>slow build with lots of `?` Â· compiler development Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html">slow build with lots of `?`</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="523083520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523083520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523083520">(Jun 09 2025 at 12:42)</a>:</h4>
<p>Continuing from <a class="message-link" href="/#narrow/channel/395097-compiler-development/topic/casual.20conversation/near/522887294">#compiler development &gt; casual conversation @ ðŸ’¬</a>  <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> </p>
<p>long_15 is for <code>roc build</code> on this code:</p>
<div class="codehilite"><pre><span></span><code>app [main!] { cli: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/0.19.0/Hj-J_zxz7V9YurCSTFcFdu6cQJie4guzsPMUi5kBYUk.tar.br&quot; }

import cli.Stdout
import cli.Arg exposing [Arg]

main! : List Arg =&gt; Result {} _
main! = |_args|
    Stdout.line!(&quot;1&quot;)?
    Stdout.line!(&quot;2&quot;)?
    Stdout.line!(&quot;3&quot;)?
    Stdout.line!(&quot;4&quot;)?
    Stdout.line!(&quot;5&quot;)?
    Stdout.line!(&quot;6&quot;)?
    Stdout.line!(&quot;7&quot;)?
    Stdout.line!(&quot;8&quot;)?
    Stdout.line!(&quot;9&quot;)?
    Stdout.line!(&quot;10&quot;)?
    Stdout.line!(&quot;11&quot;)?
    Stdout.line!(&quot;12&quot;)?
    Stdout.line!(&quot;13&quot;)?
    Stdout.line!(&quot;14&quot;)?
    Stdout.line!(&quot;15&quot;)
</code></pre></div>
<p>20 is the same thing with 5 more <code>Stdout.line!</code> calls. The flamegraph for 15 looks normal but for 20 it looks off. It spends a lot of time in handle_mm_fault though so that may be what is going wrong.</p>
<p><a href="/user_uploads/22008/udfXIsM1VF3pz94TyoXmrfNx/flamegraph_long_15.svg">flamegraph_long_15.svg</a><br>
<a href="/user_uploads/22008/vmc-DEtTV4MJyWdqVjnWRawa/flamegraph_long_20.svg">flamegraph_long_20.svg</a></p>



<a name="523250638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523250638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523250638">(Jun 10 2025 at 09:49)</a>:</h4>
<p>The potential call explosion does seem clear from the 15 flamegraph.</p>



<a name="523255346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523255346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523255346">(Jun 10 2025 at 10:15)</a>:</h4>
<p>Based on the heaptrack data; deep recursion looks likely <br>
<a href="/user_uploads/22008/c2cwK0XqjWngOet3CWwA5BhG/heaptrack_15vs20.png">heaptrack_15vs20.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/c2cwK0XqjWngOet3CWwA5BhG/heaptrack_15vs20.png" title="heaptrack_15vs20.png"><img data-original-content-type="image/png" data-original-dimensions="1184x466" src="/user_uploads/thumbnail/22008/c2cwK0XqjWngOet3CWwA5BhG/heaptrack_15vs20.png/840x560.webp"></a></div>



<a name="523255377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523255377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523255377">(Jun 10 2025 at 10:15)</a>:</h4>
<p>I'll see if ftrace can give me some nice stats</p>



<a name="523320081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523320081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523320081">(Jun 10 2025 at 15:37)</a>:</h4>
<p>uftrace tells a very different and more plausible story than the flamegraph:</p>
<div class="codehilite"><pre><span></span><code># uftrace diff
#  [0] base: uftrace.data       (from uftrace record --filter roc_* ./target/debug/roc build temp_long_15.roc)
#  [1] diff: uftrace20.data/    (from uftrace record --filter roc_* ./target/debug/roc build temp_long_20.roc)
#
    Total time     Self time         Calls   Function
   ===========   ===========   ===========   ====================
    +13.007  m     +0.084 us            +0   roc_build::program::build_file
    +13.007  m     +0.497 us            +0   roc_cli::build
    +13.007  m    +14.717 us            +0   roc::main
    +13.007  m     +0.385 us            +0   roc_load::load
    +13.007  m     +0.218 us            +0   roc_load::load_and_monomorphize
    +13.007  m    +23.707 us            +0   roc_load_internal::file::load_single_threaded
    +13.007  m     -1.656 us            +0   roc_load_internal::file::load
    +13.007  m    +39.427 us            +0   roc_load_internal::file::state_thread_step
    +13.007  m   +101.288 us            +0   roc_load_internal::file::update
    +13.007  m     +2.436 us            +0   roc_mono::inc_dec::insert_inc_dec_operations
    +13.007  m     +4.556 us            +0   roc_mono::inc_dec::insert_inc_dec_operations_proc
    +13.007  m    +10.585  s      +4571136   roc_mono::inc_dec::insert_refcount_operations_stmt
     +7.007  m     +2.716  s     +11681792   roc_mono::inc_dec::insert_refcount_operations_stmt::_{{closure}}
     +5.042  m    +16.057  s     +65704457   core::hash::BuildHasher::hash_one
     +5.015  m     +4.405  s     +67737523   core::hash::impls::_&lt;impl core::hash::Hash for &amp;T&gt;::hash
     +4.053  m   +190.553 ms      +2031656   _&lt;core::iter::adapters::rev::Rev&lt;I&gt;&gt;::fold
     +4.053  m     +1.089  s      +2031656   core::iter::traits::double_ended::DoubleEndedIterator::rfold
     +4.048  m    +10.363  s     +65700970   _&lt;roc_module::symbol::Symbol&gt;::hash
     +4.027  m    +59.520  s     +135469517   _&lt;wyhash::traits::WyHash&gt;::write
     +4.026  m     +8.766  s     +131405247   core::hash::Hasher::write_u32
     +3.027  m     +9.369  s      +5079040   roc_mono::inc_dec::insert_refcount_operations_binding
     +3.013  m     +4.815  s     +27426891   hashbrown::map::HashMap&lt;K,V,S,A&gt;::contains_key
     +2.048  m     +1.880  s     +11681792   roc_mono::inc_dec::SymbolRcTypes::get
     +2.046  m     +3.340  s     +14222412   hashbrown::map::HashMap&lt;K,V,S,A&gt;::insert
     +2.046  m     +1.857  s     +23363644   std::collections::hash::set::HashSet&lt;T,S&gt;::contains
     +2.022  m     +5.588  s     +65704262   core::hash::impls::_&lt;impl core::hash::Hash for u32&gt;::hash
     +2.015  m     +5.469  s     +65700985   _&lt;core::num::nonzero::NonZero&lt;u32&gt;&gt;::hash
     +2.010  m   +234.683 ms      +1524052   bumpalo::collections::vec::Vec&lt;T&gt;::from_iter_in
     +2.009  m   +831.661 ms      +1524247   _&lt;bumpalo::collections::vec::Vec&lt;T&gt;&gt;::extend
     +2.004  m     +1.001  m     +135469517   wyhash::functions::wyhash_core
     +2.002  m   +714.215 ms      +9651156   std::collections::hash::map::HashMap&lt;K,V,S&gt;::insert
     +1.059  m   +337.363 ms      +2038914   _&lt;core::iter::adapters::map::Map&lt;I,F&gt;&gt;::next
     +1.059  m     +8.820  s     +51200480   _&lt;hashbrown::map::HashMap&lt;K,V,S,A&gt;&gt;::clone
     +1.059  m   +117.193 ms      +1020568   core::ops::function::impls::_&lt;impl core::ops::function::FnOnce&lt;A&gt; for &amp;mut F&gt;::call_once
     +1.057  m   +393.806 ms      +5586944   roc_mono::inc_dec::RefcountEnvironment::add_symbol
     +1.056  m   +607.791 ms      +5586944   roc_mono::inc_dec::RefcountEnvironment::add_symbol_with
     +1.049  m     +8.621  s     +51200480   _&lt;hashbrown::raw::RawTable&lt;T,A&gt;&gt;::clone
     +1.047  m   +102.891 ms      +1015828   bumpalo::collections::collect_in::CollectIn::collect_in
     +1.047  m    +83.509 ms      +1015828   _&lt;bumpalo::collections::vec::Vec&lt;T&gt;&gt;::from_iter_in
     +1.045  m   +547.355 ms      +5588649   core::iter::traits::iterator::Iterator::collect
     +1.044  m     +1.318  s      +5586949   _&lt;std::collections::hash::set::HashSet&lt;T,S&gt;&gt;::from_iter
     +1.043  m     +1.095  s      +7110656   roc_mono::inc_dec::RefcountEnvironment::get_symbol_rc_type
     +1.043  m     +1.366  s      +5586949   _&lt;hashbrown::set::HashSet&lt;T,S,A&gt;&gt;::extend
     +1.041  m     +1.801  s      +5586964   _&lt;hashbrown::map::HashMap&lt;K,V,S,A&gt;&gt;::extend
     +1.039  m   +590.532 ms      +6096312   _&lt;core::iter::adapters::map::Map&lt;I,F&gt;&gt;::fold
     +1.036  m   +532.162 ms      +6603467   core::iter::traits::iterator::Iterator::for_each
     +1.030  m     +2.694  s     +14222412   hashbrown::raw::RawTable&lt;T,A&gt;::find_or_find_insert_slot
     +1.024  m     +4.486  s     +54755838   _&lt;hashbrown::raw::RawTable&lt;T,A&gt;&gt;::drop
     +1.022  m   +412.975 ms      +2539520   _&lt;roc_mono::inc_dec::RefcountEnvironment&gt;::clone
     +1.022  m    +21.982  s     +44698317   hashbrown::raw::RawTable&lt;T,A&gt;::find
     +1.022  m   +401.394 ms      +5079495   _&lt;std::collections::hash::map::HashMap&lt;K,V,S&gt;&gt;::clone
     +1.020  m   +705.180 ms      +9144322   std::collections::hash::map::HashMap&lt;K,V,S&gt;::get
     +1.019  m     +6.564  s     +54755838   hashbrown::raw::RawTableInner::drop_inner_table
     +1.019  m     +1.780  s      +9144437   hashbrown::map::HashMap&lt;K,V,S,A&gt;::get
     +1.015  m     +1.023  s     +28901461   _&lt;hashbrown::raw::RawTable&lt;T,A&gt;&gt;::clone_from_spec
     +1.014  m     +8.608  s      +2539575   hashbrown::raw::RawTable&lt;T,A&gt;::clone_from_impl
     +1.013  m    +25.222  s     +270939034   _&lt;core::slice::iter::Chunks&lt;T&gt;&gt;::next
     +1.010  m   +438.165 ms      +5079040   roc_mono::inc_dec::RefcountEnvironment::consume_rc_symbol
     +1.010  m     +2.412  s     +36570443   hashbrown::raw::RawTable&lt;T,A&gt;::get
     +1.008  m   +443.216 ms      +4063252   _&lt;core::iter::adapters::filter::Filter&lt;I,P&gt;&gt;::fold
     +1.005  m   +943.156 ms      +3047424   roc_mono::inc_dec::RefcountEnvironment::borrowed_usages
     +1.004  m   +475.935 ms      +2539520   core::ptr::drop_in_place&lt;roc_mono::inc_dec::RefcountEnvironment&gt;
     +1.003  m   +374.460 ms      +2031616   roc_mono::inc_dec::RefcountEnvironment::consume_symbol
     +1.002  m     +1.004  s     +21333133   hashbrown::raw::RawTable&lt;T,A&gt;::reserve
     +1.001  m   +467.025 ms      +3555368   core::iter::adapters::filter::filter_fold::_{{closure}}
     +1.001  m     +5.078  s      +8175857   hashbrown::raw::RawTable&lt;T,A&gt;::reserve_rehash
     +1.000  m   +268.364 ms      +2539520   core::ptr::drop_in_place&lt;std::collections::hash::map::HashMap&lt;roc_mono::ir::JoinPointId,std::collections::hash::set::HashSet&lt;roc_module::symbol::Symbol,core::hash::BuildHasherDefault&lt;wyhash::traits::WyHash&gt;&gt;,core::hash::BuildHasherDefault&lt;wyhash::traits::WyHash&gt;&gt;&gt;
     +1.000  m   +234.728 ms      +2539520   core::ptr::drop_in_place&lt;hashbrown::map::HashMap&lt;roc_mono::ir::JoinPointId,std::collections::hash::set::HashSet&lt;roc_module::symbol::Symbol,core::hash::BuildHasherDefault&lt;wyhash::traits::WyHash&gt;&gt;,core::hash::BuildHasherDefault&lt;wyhash::traits::WyHash&gt;&gt;&gt;
</code></pre></div>



<a name="523320463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523320463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523320463">(Jun 10 2025 at 15:39)</a>:</h4>
<p>I'm going to see if I can reproduce this with a simple platform, basic-cli may cause a bunch of distractions when debugging.</p>



<a name="523342958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523342958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523342958">(Jun 10 2025 at 17:52)</a>:</h4>
<p>Reproduction with simple platform <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span><br>
The list argument is key, even though it is unused! It does not happen with <code>myargs = 5</code> or <code>{}</code>, but it does also happen with <code>""</code>.</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nx">app</span><span class="w"> </span><span class="p">[</span><span class="nx">main</span><span class="o">!</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">pf</span><span class="o">:</span><span class="w"> </span><span class="nx">platform</span><span class="w"> </span><span class="s">"../test-platform-effects-zig/main.roc"</span><span class="w"> </span><span class="p">}</span>

<span class="nx">import</span><span class="w"> </span><span class="nx">pf</span><span class="p">.</span><span class="nx">Effect</span>

<span class="nx">main</span><span class="o">!</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="nx">main</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="p">{}</span><span class="o">|</span>
<span class="w">    </span><span class="nv">myargs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="nx">wrapper</span><span class="o">!</span><span class="p">(</span><span class="nx">myargs</span><span class="p">)</span><span class="w"> </span><span class="o">is</span>
<span class="w">        </span><span class="nx">Ok</span><span class="nf">(he) -&gt;</span><span class="w"> </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">put_line</span><span class="o">!</span><span class="p">(</span><span class="nx">Inspect</span><span class="p">.</span><span class="nx">to_str</span><span class="p">(</span><span class="nx">he</span><span class="p">))</span>
<span class="w">        </span><span class="nx">Err</span><span class="nf">(e) -&gt;</span><span class="w"> </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">put_line</span><span class="o">!</span><span class="p">(</span><span class="nx">Inspect</span><span class="p">.</span><span class="nx">to_str</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span>

<span class="nx">wrapper</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">_args</span><span class="o">|</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"3"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"4"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"5"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"6"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"7"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"8"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"9"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"10"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"11"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"12"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"13"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"14"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"15"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"16"</span><span class="p">)</span><span class="o">?</span>
<span class="w">    </span><span class="nx">Effect</span><span class="p">.</span><span class="nx">foo_line</span><span class="o">!</span><span class="p">(</span><span class="s">"17"</span><span class="p">)</span>
</code></pre></div>



<a name="523346727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523346727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523346727">(Jun 10 2025 at 18:15)</a>:</h4>
<p>Using <code>myargs = []</code> instead of <code>myargs = 0</code> leads to 73628 more calls of <code>roc_mono::inc_dec::insert_refcount_operations_stmt</code></p>



<a name="523348672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523348672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523348672">(Jun 10 2025 at 18:28)</a>:</h4>
<p>Wow....crazy <span aria-label="rolling on the floor laughing" class="emoji emoji-1f923" role="img" title="rolling on the floor laughing">:rolling_on_the_floor_laughing:</span></p>



<a name="523350593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523350593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523350593">(Jun 10 2025 at 18:40)</a>:</h4>
<p>I wonder what we are scanning over that explodes like that</p>



<a name="523350671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523350671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523350671">(Jun 10 2025 at 18:40)</a>:</h4>
<p>Or recursiving over</p>



<a name="523387917"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523387917" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523387917">(Jun 10 2025 at 23:38)</a>:</h4>
<p>is this still doing the closure thing?</p>



<a name="523387933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523387933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523387933">(Jun 10 2025 at 23:38)</a>:</h4>
<p>where Effect is a continuation monad</p>



<a name="523387942"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523387942" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523387942">(Jun 10 2025 at 23:38)</a>:</h4>
<p>if so, that's probably why</p>



<a name="523393503"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523393503" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523393503">(Jun 11 2025 at 00:46)</a>:</h4>
<p>Ah yeah, I thought it didn't have closures, but probably has repeat calls to <code>Result.try</code></p>



<a name="523393516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523393516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523393516">(Jun 11 2025 at 00:46)</a>:</h4>
<p>Otherwise, it is a gigantic nested when is</p>



<a name="523620277"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523620277" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523620277">(Jun 11 2025 at 18:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/channel/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60/near/523387917">said</a>:</p>
<blockquote>
<p>is this still doing the closure thing?</p>
</blockquote>
<p>Yeah it's using closures, but do you know why that would result in a massive difference depending on the type of myargs?</p>



<a name="523620625"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523620625" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523620625">(Jun 11 2025 at 18:53)</a>:</h4>
<p>Lists are refcount</p>



<a name="523620661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523620661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523620661">(Jun 11 2025 at 18:54)</a>:</h4>
<p>Ints and records are not</p>



<a name="523620704"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523620704" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523620704">(Jun 11 2025 at 18:54)</a>:</h4>
<p>And all values are being nestedly captured for each closure</p>



<a name="523620776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523620776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523620776">(Jun 11 2025 at 18:54)</a>:</h4>
<p>Still really should not explode like that....feels exponential...probably a bad algorithm.</p>



<a name="523620798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523620798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523620798">(Jun 11 2025 at 18:55)</a>:</h4>
<p>Thanks Brendan :)<br>
On a further simplified example I did find it was repeating the same lengthy "recursive walk" multiple times so memoization is possible</p>



<a name="523620861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523620861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523620861">(Jun 11 2025 at 18:55)</a>:</h4>
<p>Ah, makes sense</p>



<a name="523994978"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/523994978" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#523994978">(Jun 13 2025 at 18:24)</a>:</h4>
<p>I know how I want to solve this, I'm currently entangled in a web of algorithmic and lifetime complexity <span aria-label="web" class="emoji emoji-1f578" role="img" title="web">:web:</span> <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="524079400"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524079400" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524079400">(Jun 14 2025 at 18:02)</a>:</h4>
<p>The optimizations I tried where either not significant or resulted in wrong reference counts when running all tests. Let's make sure to write unit tests for complicated functions in the new compiler :p <br>
I'm going to give it one more day to see if I can skip work for unused variables.</p>



<a name="524080992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524080992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524080992">(Jun 14 2025 at 18:32)</a>:</h4>
<p>Did you try changing the desugaring to use when is instead of result.try (assuming it is currently using result.try)?</p>



<a name="524239612"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524239612" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524239612">(Jun 16 2025 at 11:58)</a>:</h4>
<p>No, not yet, that's a good idea. I'll explore that for a bit.</p>



<a name="524245024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524245024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524245024">(Jun 16 2025 at 12:27)</a>:</h4>
<p>Turns out they are actually using when. It goes: TrySuffix &gt; LowLevelTry &gt; Try &gt;  <a href="https://github.com/roc-lang/roc/blob/bba2103882a8124f3887da6adaaa44cf2b728c3e/crates/compiler/mono/src/ir.rs#L5934">When</a>.  Earlier I was looking at the IR after specialization and it wasn't clear to me that the problematic IR came from when expressions.</p>



<a name="524250071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524250071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524250071">(Jun 16 2025 at 12:53)</a>:</h4>
<p>I like the overview we get of the output all phases with the snapshots in the new compiler, it requires substantial effort to get that output for some phases from the old compiler.</p>



<a name="524280044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524280044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524280044">(Jun 16 2025 at 15:20)</a>:</h4>
<p>Interesting.... So this isn't from nested closures</p>



<a name="524284149"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524284149" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524284149">(Jun 16 2025 at 15:43)</a>:</h4>
<p>it's due to nested joins:</p>
<div class="codehilite"><pre><span></span><code>procedure : `#UserApp.wrapper!` [C {}, C {}]
procedure = `#UserApp.wrapper!` (`#UserApp.7`: List []):
    joinpoint `#UserApp.70` `#UserApp.66`:
        joinpoint `#UserApp.58` `#UserApp.54`:
            joinpoint `#UserApp.46` `#UserApp.42`:
                joinpoint `#UserApp.34` `#UserApp.30`:
                    joinpoint `#UserApp.22` `#UserApp.18`:
                        let `#UserApp.17` : Str = &quot;6&quot;;
                        let `#UserApp.16` : [C {}, C {}] = CallByName `pf.Effect.foo_line!` `#UserApp.17`;
                        ret `#UserApp.16`;
                    in
                    let `#UserApp.29` : Str = &quot;5&quot;;
                    let `#UserApp.21` : [C {}, C {}] = CallByName `pf.Effect.foo_line!` `#UserApp.29`;
                    let `#UserApp.26` : U8 = 1i64;
                    let `#UserApp.27` : U8 = GetTagId `#UserApp.21`;
                    let `#UserApp.28` : Int1 = lowlevel Eq `#UserApp.26` `#UserApp.27`;
                    if `#UserApp.28` then
                        let `#UserApp.19` : {} = UnionAtIndex (Id 1) (Index 0) `#UserApp.21`;
                        jump `#UserApp.22` `#UserApp.19`;
                    else
                        let `#UserApp.20` : {} = UnionAtIndex (Id 0) (Index 0) `#UserApp.21`;
                        let `#UserApp.25` : [C {}, C {}] = TagId(0) `#UserApp.20`;
                        ret `#UserApp.25`;
                in
                let `#UserApp.41` : Str = &quot;4&quot;;
                let `#UserApp.33` : [C {}, C {}] = CallByName `pf.Effect.foo_line!` `#UserApp.41`;
                let `#UserApp.38` : U8 = 1i64;
                let `#UserApp.39` : U8 = GetTagId `#UserApp.33`;
                let `#UserApp.40` : Int1 = lowlevel Eq `#UserApp.38` `#UserApp.39`;
                if `#UserApp.40` then
                    let `#UserApp.31` : {} = UnionAtIndex (Id 1) (Index 0) `#UserApp.33`;
                    jump `#UserApp.34` `#UserApp.31`;
                else
                    let `#UserApp.32` : {} = UnionAtIndex (Id 0) (Index 0) `#UserApp.33`;
                    let `#UserApp.37` : [C {}, C {}] = TagId(0) `#UserApp.32`;
                    ret `#UserApp.37`;
            in
            let `#UserApp.53` : Str = &quot;3&quot;;
            let `#UserApp.45` : [C {}, C {}] = CallByName `pf.Effect.foo_line!` `#UserApp.53`;
            let `#UserApp.50` : U8 = 1i64;
            let `#UserApp.51` : U8 = GetTagId `#UserApp.45`;
            let `#UserApp.52` : Int1 = lowlevel Eq `#UserApp.50` `#UserApp.51`;
            if `#UserApp.52` then
                let `#UserApp.43` : {} = UnionAtIndex (Id 1) (Index 0) `#UserApp.45`;
                jump `#UserApp.46` `#UserApp.43`;
            else
                let `#UserApp.44` : {} = UnionAtIndex (Id 0) (Index 0) `#UserApp.45`;
                let `#UserApp.49` : [C {}, C {}] = TagId(0) `#UserApp.44`;
                ret `#UserApp.49`;
        in
        let `#UserApp.65` : Str = &quot;2&quot;;
        let `#UserApp.57` : [C {}, C {}] = CallByName `pf.Effect.foo_line!` `#UserApp.65`;
        let `#UserApp.62` : U8 = 1i64;
        let `#UserApp.63` : U8 = GetTagId `#UserApp.57`;
        let `#UserApp.64` : Int1 = lowlevel Eq `#UserApp.62` `#UserApp.63`;
        if `#UserApp.64` then
            let `#UserApp.55` : {} = UnionAtIndex (Id 1) (Index 0) `#UserApp.57`;
            jump `#UserApp.58` `#UserApp.55`;
        else
            let `#UserApp.56` : {} = UnionAtIndex (Id 0) (Index 0) `#UserApp.57`;
            let `#UserApp.61` : [C {}, C {}] = TagId(0) `#UserApp.56`;
            ret `#UserApp.61`;
    in
    let `#UserApp.77` : Str = &quot;1&quot;;
    let `#UserApp.69` : [C {}, C {}] = CallByName `pf.Effect.foo_line!` `#UserApp.77`;
    let `#UserApp.74` : U8 = 1i64;
    let `#UserApp.75` : U8 = GetTagId `#UserApp.69`;
    let `#UserApp.76` : Int1 = lowlevel Eq `#UserApp.74` `#UserApp.75`;
    if `#UserApp.76` then
        let `#UserApp.67` : {} = UnionAtIndex (Id 1) (Index 0) `#UserApp.69`;
        jump `#UserApp.70` `#UserApp.67`;
    else
        let `#UserApp.68` : {} = UnionAtIndex (Id 0) (Index 0) `#UserApp.69`;
        let `#UserApp.73` : [C {}, C {}] = TagId(0) `#UserApp.68`;
        ret `#UserApp.73`;
</code></pre></div>



<a name="524288536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524288536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524288536">(Jun 16 2025 at 16:06)</a>:</h4>
<p>It's <a href="https://github.com/roc-lang/roc/blob/bba2103882a8124f3887da6adaaa44cf2b728c3e/crates/compiler/mono/src/inc_dec.rs#L745">this loop</a> specifically.</p>



<a name="524505413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524505413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524505413">(Jun 17 2025 at 18:14)</a>:</h4>
<p>Alright, I was able to hack together a fix for my specific problematic file as proof of concept :)<br>
I should be able to turn this proof of concept into a proper fix <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="524622662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524622662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524622662">(Jun 18 2025 at 02:48)</a>:</h4>
<p>Congrats <span class="user-mention" data-user-id="361169">@Anton</span>  <span aria-label="sparkler" class="emoji emoji-1f387" role="img" title="sparkler">:sparkler:</span></p>



<a name="524628653"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524628653" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524628653">(Jun 18 2025 at 04:29)</a>:</h4>
<p>what was the issue?</p>



<a name="524662730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524662730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524662730">(Jun 18 2025 at 09:16)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/bba2103882a8124f3887da6adaaa44cf2b728c3e/crates/compiler/mono/src/inc_dec.rs#L745">This loop</a> does expensive fixed point iteration even when all variables that could potentially be reference counted are unused.</p>



<a name="524734118"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524734118" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524734118">(Jun 18 2025 at 15:31)</a>:</h4>
<p>I made a tool so that I can understand how the recursion iterates over the code :)<br>
<a href="/user_uploads/22008/3vc_tjOomXLKLunXgomT3Gv4/debug_tool.mp4">debug_tool.mp4</a></p>
<div class="message_inline_image message_inline_video"><a href="/user_uploads/22008/3vc_tjOomXLKLunXgomT3Gv4/debug_tool.mp4" title="debug_tool.mp4"><video preload="metadata" src="/user_uploads/22008/3vc_tjOomXLKLunXgomT3Gv4/debug_tool.mp4"></video></a></div>



<a name="524757705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/524757705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#524757705">(Jun 18 2025 at 17:59)</a>:</h4>
<p>This is awesome.  I want to know how you built it!</p>



<a name="525003928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525003928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525003928">(Jun 20 2025 at 09:02)</a>:</h4>
<p>Here is the source code <a href="/user_uploads/22008/pxTNiaX7f71iTzrpVmseT2Lq/index.html">index.html</a></p>



<a name="525004483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525004483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525004483">(Jun 20 2025 at 09:06)</a>:</h4>
<p>I used the regular Claude web interface to start, for js you can have a live preview on the side so that is very useful. This was my initial back and forth with claude: <a href="https://claude.ai/share/7ff2aacf-b7a5-40ad-839c-46b0e70b1882">https://claude.ai/share/7ff2aacf-b7a5-40ad-839c-46b0e70b1882</a></p>



<a name="525004961"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525004961" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525004961">(Jun 20 2025 at 09:09)</a>:</h4>
<p>Claude servers were overloaded so then I switched to the latest gemini pro 2.5 (free on <a href="https://aistudio.google.com">https://aistudio.google.com</a>). I don't think it has the same live js preview, so I had to a bunch of manual copy, paste and run. In between I did some good old fashion human brain debugging and that's it :)</p>



<a name="525005547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525005547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525005547">(Jun 20 2025 at 09:13)</a>:</h4>
<p>From several past experiments, I've found vanilla js to improve things a lot. Models can have a difficult time fixing React errors, but they often default to React if you don't specify what to use.</p>



<a name="525005753"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525005753" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525005753">(Jun 20 2025 at 09:15)</a>:</h4>
<p>I've had good experiences using Elm. Though I haven't built anything substantial with it, mostly just smaller demo things.</p>



<a name="525006186"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525006186" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525006186">(Jun 20 2025 at 09:17)</a>:</h4>
<p>Good to know, I should give roc htmx a try as well :)</p>



<a name="525387761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525387761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525387761">(Jun 23 2025 at 18:28)</a>:</h4>
<p>status update: I'm trying to achieve a more ambitious improvement then earlier, doing less work for unused variables is pretty easy. I'm now also trying to prevent work for vars after their last use. There is a way to this with a lot of reasonably simple code changes but I'm trying to see if I can make it work with a lot less code changes.</p>
<p>This nested joinpoint case is very common in current Roc and blows up 2^n so it's worth spending some time on in my opinion.</p>
<p>I believe we still plan on doing perceus refcounting in the new compiler <span class="user-mention" data-user-id="281383">@Richard Feldman</span>?</p>



<a name="525401247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/525401247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#525401247">(Jun 23 2025 at 20:11)</a>:</h4>
<p>for sure!</p>



<a name="526120196"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/526120196" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#526120196">(Jun 27 2025 at 16:42)</a>:</h4>
<p>It is done <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="fireworks" class="emoji emoji-1f386" role="img" title="fireworks">:fireworks:</span> <span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span> <a href="https://github.com/roc-lang/roc/pull/7884">PR#7884</a><br>
<a href="/user_uploads/22008/GOlwsin29VBQSV8x06zSSlie/fix_comparison_plot.png">fix_comparison_plot.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/GOlwsin29VBQSV8x06zSSlie/fix_comparison_plot.png" title="fix_comparison_plot.png"><img data-original-content-type="image/png" data-original-dimensions="775x512" src="/user_uploads/thumbnail/22008/GOlwsin29VBQSV8x06zSSlie/fix_comparison_plot.png/840x560.webp"></a></div>



<a name="526123818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/526123818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#526123818">(Jun 27 2025 at 17:05)</a>:</h4>
<p>wooooooooow, amazing <span class="user-mention" data-user-id="361169">@Anton</span>!!!</p>



<a name="526132034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/526132034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#526132034">(Jun 27 2025 at 18:06)</a>:</h4>
<p>great job <span class="user-mention" data-user-id="361169">@Anton</span> '</p>



<a name="526183234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/526183234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#526183234">(Jun 28 2025 at 06:42)</a>:</h4>
<p>Wait....but I thought the goal of all graphs was to go up and to the right.....</p>



<a name="526183259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/526183259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#526183259">(Jun 28 2025 at 06:42)</a>:</h4>
<p><span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span> Congrats on fixing this <span class="user-mention" data-user-id="361169">@Anton</span></p>



<a name="526191164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/slow%20build%20with%20lots%20of%20%60%3F%60/near/526191164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60.html#526191164">(Jun 28 2025 at 09:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/slow.20build.20with.20lots.20of.20.60.3F.60/near/526183234">said</a>:</p>
<blockquote>
<p>Wait....but I thought the goal of all graphs was to go up and to the right.....</p>
</blockquote>
<p>I should have plotted the speedup % :p</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
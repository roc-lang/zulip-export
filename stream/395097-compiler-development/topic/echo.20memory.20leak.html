<html>
<head><meta charset="utf-8"><title>echo memory leak · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/echo.20memory.20leak.html">echo memory leak</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="561491661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/echo%20memory%20leak/near/561491661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/echo.20memory.20leak.html#561491661">(Dec 02 2025 at 18:33)</a>:</h4>
<p>This "fixes" the memory leak in the echo example of Luke's zig platform but I think it may be a bad idea <span class="user-mention" data-user-id="281383">@Richard Feldman</span> <span class="user-mention" data-user-id="515757">@Luke Boswell</span> </p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/platform/host.zig b/platform/host.zig</span>
<span class="gh">index fa18c29..502236a 100644</span>
<span class="gd">--- a/platform/host.zig</span>
<span class="gi">+++ b/platform/host.zig</span>
<span class="gu">@@ -206,21 +206,9 @@ fn hostedStdinLine(ops: *builtins.host_abi.RocOps, ret_ptr: *anyopaque, args_ptr</span>
<span class="w"> </span>        line = line[0 .. line.len - 1];
<span class="w"> </span>    }

<span class="gd">-    // Allocate through Roc's allocation system to ensure proper size-tracking metadata</span>
<span class="gd">-    var roc_alloc_args = builtins.host_abi.RocAlloc{</span>
<span class="gd">-        .alignment = 1,</span>
<span class="gd">-        .length = line.len,</span>
<span class="gd">-        .answer = undefined,</span>
<span class="gd">-    };</span>
<span class="gd">-    ops.roc_alloc(&amp;roc_alloc_args, ops.env);</span>
<span class="gd">-</span>
<span class="gd">-    // Copy line data to the Roc-allocated memory</span>
<span class="gd">-    const line_copy: [*]u8 = @ptrCast(roc_alloc_args.answer);</span>
<span class="gd">-    @memcpy(line_copy[0..line.len], line);</span>
<span class="gd">-</span>
<span class="w"> </span>    // Create RocStr from the read line and return it
<span class="w"> </span>    const result: *RocStr = @ptrCast(@alignCast(ret_ptr));
<span class="gd">-    result.* = RocStr.init(line_copy, line.len, ops);</span>
<span class="gi">+    result.* = RocStr.fromSlice(line, ops);</span>
<span class="w"> </span>}

<span class="w"> </span>/// Hosted function: Stdout.line! (index 2 - sorted alphabetically)
</code></pre></div>
<p>From <a href="https://github.com/Anton-4/roc-platform-template-zig/pull/2">https://github.com/Anton-4/roc-platform-template-zig/pull/2</a></p>



<a name="561492224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/echo%20memory%20leak/near/561492224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/echo.20memory.20leak.html#561492224">(Dec 02 2025 at 18:36)</a>:</h4>
<p>oh yeah that sounds scary <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="561492252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/echo%20memory%20leak/near/561492252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/echo.20memory.20leak.html#561492252">(Dec 02 2025 at 18:36)</a>:</h4>
<p>pretty sure there's UB there haha</p>



<a name="561496372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/echo%20memory%20leak/near/561496372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/echo.20memory.20leak.html#561496372">(Dec 02 2025 at 18:58)</a>:</h4>
<p>I wonder if the bug there is that we're not decref-ing tag union payloads correctly</p>



<a name="561496497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/echo%20memory%20leak/near/561496497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/echo.20memory.20leak.html#561496497">(Dec 02 2025 at 18:58)</a>:</h4>
<p>like because the <code>Str</code> is inside a <code>Try</code>, when we decref the <code>Try</code> it doesn't go in and decref (and free) the <code>Str</code> inside the <code>Ok</code>?</p>



<a name="561604920"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/echo%20memory%20leak/near/561604920" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/echo.20memory.20leak.html#561604920">(Dec 03 2025 at 10:05)</a>:</h4>
<p>Luke fixed it: <a href="https://github.com/lukewilliamboswell/roc-platform-template-zig/commit/b68e3f427d51acb5d2e76425f6e0fb8b21bdedfc">https://github.com/lukewilliamboswell/roc-platform-template-zig/commit/b68e3f427d51acb5d2e76425f6e0fb8b21bdedfc</a></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
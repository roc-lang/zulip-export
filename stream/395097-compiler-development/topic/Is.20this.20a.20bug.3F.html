<html>
<head><meta charset="utf-8"><title>Is this a bug? · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html">Is this a bug?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="434512394"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434512394" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434512394">(Apr 20 2024 at 15:42)</a>:</h4>
<p>Spinoff from <a class="stream-topic" data-stream-id="231634" href="/#narrow/stream/231634-beginners/topic/combining.20open.20unions">#beginners &gt; combining open unions</a>, is the following a bug?</p>
<div class="codehilite" data-code-language="Elixir"><pre><span></span><code><span class="n">interface</span><span class="w"> </span><span class="nc">Test</span>
<span class="w">    </span><span class="n">exposes</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="n">imports</span><span class="w"> </span><span class="p">[]</span>

<span class="n">generateOpenOkStr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">Str</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="nc">Ok</span><span class="w"> </span><span class="nc">Str</span><span class="p">]</span><span class="o">*</span>
<span class="n">generateOpenOkStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">s</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="nc">Ok</span><span class="w"> </span><span class="n">s</span>

<span class="n">restrictsToClosed</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nc">Ok</span><span class="w"> </span><span class="nc">Str</span><span class="p">]</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Bool</span>
<span class="n">restrictsToClosed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nc">Ok</span><span class="w"> </span><span class="n">s</span><span class="o">-&gt;</span>
<span class="w">    </span><span class="o">!</span><span class="p">(</span><span class="nc">Str</span><span class="o">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">s</span><span class="p">)</span>

<span class="n">expect</span>
<span class="w">    </span><span class="c1"># `in` is an open tag union, returned as `[Ok Str]*`.</span>
<span class="w">    </span><span class="c1"># Yet, if I type it as such, it breaks due to type mismatch</span>
<span class="w">    </span><span class="ow">in</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nc">Ok</span><span class="w"> </span><span class="nc">Str</span><span class="p">]</span><span class="o">*</span>
<span class="w">    </span><span class="ow">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generateOpenOkStr</span><span class="w"> </span><span class="s2">""</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restrictsToClosed</span><span class="w"> </span><span class="ow">in</span>
<span class="w">    </span><span class="n">out</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nc">Bool</span><span class="o">.</span><span class="no">false</span>
</code></pre></div>



<a name="434512554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434512554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434512554">(Apr 20 2024 at 15:42)</a>:</h4>
<div class="codehilite"><pre><span></span><code>This 1st argument to restrictsToClosed has an unexpected type:

18│      out = restrictsToClosed in
                                 ^^

This in value is a:

    […]*

But restrictsToClosed needs its 1st argument to be:

    […]
</code></pre></div>



<a name="434512627"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434512627" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434512627">(Apr 20 2024 at 15:43)</a>:</h4>
<p>Works if <code>in : [Ok Str]*</code> is commented out.</p>



<a name="434513081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434513081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434513081">(Apr 20 2024 at 15:47)</a>:</h4>
<p>It does work with <code>in : [Ok Str]_</code> I think it's that bug, I'll check if we have an issue for that.</p>



<a name="434513535"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434513535" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434513535">(Apr 20 2024 at 15:54)</a>:</h4>
<p>No, <a href="https://github.com/roc-lang/roc/issues/5660">#5660</a> is different, perhaps this is intended behavior, given that the error message states:</p>
<div class="codehilite"><pre><span></span><code>(The * means something different when the tag union is an argument to a
function, though!)
</code></pre></div>



<a name="434513697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434513697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434513697">(Apr 20 2024 at 15:57)</a>:</h4>
<p>Yeah, it may be a proper error. That said, it definitely feels wrong as a proper error given I am returning a <code>[Ok Str]*</code> from the function.</p>



<a name="434513760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434513760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434513760">(Apr 20 2024 at 15:58)</a>:</h4>
<p>Am I storing the return type <code>[Ok Str]*</code> or the argument type <code>[Ok Str]*</code>? Very unclear.</p>



<a name="434513786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434513786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434513786">(Apr 20 2024 at 15:58)</a>:</h4>
<p>Whatever the case, I definitely think we need a clearer explanation here at a minimum.</p>



<a name="434521401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434521401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434521401">(Apr 20 2024 at 17:51)</a>:</h4>
<p>I think this is a reasonable way for <code>*</code> and <code>_</code> to work. I can reproduce this behavior with <code>List *</code> and <code>List _</code> and I think it makes sense</p>
<div class="codehilite"><pre><span></span><code>constructList : List _
constructList =
    empty : List _
    empty = []
    list1 : List _
    list1 = List.append empty 1 # no error
    list1

constructList2 : List *
constructList2 =
    empty : List *
    empty = []
    list1 : List *
    list1 = List.append empty 1 # ERROR (mismatch between Num * and *)
    list1
</code></pre></div>



<a name="434521528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434521528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434521528">(Apr 20 2024 at 17:53)</a>:</h4>
<p>The mental model here is that within a top-level declaration, <code>*</code> is a placeholder instantiated by each caller and <code>_</code> is a placeholder which we get to instantiate</p>



<a name="434521648"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434521648" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434521648">(Apr 20 2024 at 17:54)</a>:</h4>
<p>Any time you write <code>myLocal = myTopLevel</code> where <code>myTopLevel : MyType *</code>, you get <code>myLocal : MyType _</code>. This is exactly what it means that <code>*</code> is chosen by each caller; we are a caller of <code>myTopLevel</code>, so now we get to choose how to instantiate the <code>*</code></p>



<a name="434521770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434521770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434521770">(Apr 20 2024 at 17:56)</a>:</h4>
<p>I agree that without function calls, that all makes sense. I think it feels the worst when returning something from a function:</p>
<div class="codehilite" data-code-language="Elixir"><pre><span></span><code><span class="ss">getEmpty</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="o">*</span>
<span class="n">getEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="p">{}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">[]</span>

<span class="c1"># I know why this doesn't work, but it feels like it should work.</span>
<span class="c1"># `empty` is simply specifying the exact same type as what was returned by `getEmpty`</span>
<span class="n">constructList</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="bp">_</span>
<span class="n">constructList</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">empty</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="o">*</span>
<span class="w">    </span><span class="n">empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getEmpty</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="n">list1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">append</span><span class="w"> </span><span class="n">empty</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1"># ERROR (mismatch between Num * and *)</span>
<span class="w">    </span><span class="n">list1</span>
</code></pre></div>
<p>I wonder if it would help to have some sort of explicit input type vs return type <code>*</code>....not sure, but this definitely is confusing even if it can be logically explained.</p>



<a name="434521815"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434521815" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434521815">(Apr 20 2024 at 17:57)</a>:</h4>
<p>But <code>constructList</code> can't possibly have type <code>List *</code> there, right? The list it returns always include a number</p>



<a name="434521858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434521858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434521858">(Apr 20 2024 at 17:57)</a>:</h4>
<p>Sorry, meant <code>List _</code> or <code>List (Num *)</code> there.</p>



<a name="434522316"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434522316" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434522316">(Apr 20 2024 at 18:03)</a>:</h4>
<p>What if we changed the meaning of <code>*</code> inside of type annotations for locals to mean the same thing as <code>_</code>?</p>



<a name="434522439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434522439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434522439">(Apr 20 2024 at 18:05)</a>:</h4>
<p>I don't think that would result in any new type errors, because we can always assign <code>_</code> to <code>*</code> if needed. e.g. the following typechecks</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">takesAnyList</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="nv">takesAnyList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">anyList</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">underscoreList</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">_</span>
<span class="w">    </span><span class="nv">underscoreList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">anyList</span><span class="w"> </span><span class="c1"># no error</span>
<span class="w">    </span><span class="p">{}</span>
</code></pre></div>



<a name="434522537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434522537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434522537">(Apr 20 2024 at 18:06)</a>:</h4>
<p>But it has the downside of losing some precision in what type annotation are expressible. You could no longer assert that a local has a type which is indeed chosen by the caller.</p>



<a name="434522918"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434522918" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434522918">(Apr 20 2024 at 18:11)</a>:</h4>
<p>Ooh there is some interesting non-uniformity with how local function definitions behave here</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">myNested</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U32</span>
<span class="nv">myNested</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nv">myEmpty</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span>
<span class="w">    </span><span class="nv">myEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="nx">List</span><span class="p">.</span><span class="nx">append</span><span class="w"> </span><span class="p">(</span><span class="nx">myEmpty</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="c1"># no error, but if we change to `myEmpty : List *` we get an error like before</span>
</code></pre></div>



<a name="434523221"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434523221" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434523221">(Apr 20 2024 at 18:15)</a>:</h4>
<p>oh actually this non-uniformity is observable even without type annotations:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">nestedPolymorphism</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">List</span><span class="w"> </span><span class="nx">U32</span><span class="p">,</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">Str</span><span class="p">)</span>
<span class="nv">nestedPolymorphism</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1"># myEmpty : {} -&gt; List *</span>
<span class="w">    </span><span class="nv">myEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">(</span><span class="nx">List</span><span class="p">.</span><span class="nx">append</span><span class="w"> </span><span class="p">(</span><span class="nx">myEmpty</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">List</span><span class="p">.</span><span class="nx">append</span><span class="w"> </span><span class="p">(</span><span class="nx">myEmpty</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="s">"1"</span><span class="p">)</span>

<span class="nv">failedPolymorhpism</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">List</span><span class="w"> </span><span class="nx">U32</span><span class="p">,</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">Str</span><span class="p">)</span>
<span class="nv">failedPolymorhpism</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="c1"># myEmpty : List _</span>
<span class="w">    </span><span class="nv">myEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">(</span><span class="nx">List</span><span class="p">.</span><span class="nx">append</span><span class="w"> </span><span class="nx">myEmpty</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">List</span><span class="p">.</span><span class="nx">append</span><span class="w"> </span><span class="nx">myEmpty</span><span class="w"> </span><span class="s">"1"</span><span class="p">)</span><span class="w"> </span><span class="c1"># ERROR (mismatch between Str and Num *)</span>
</code></pre></div>
<p>I guess local function definitions can be polymorphic but local values cannot</p>



<a name="434523458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434523458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434523458">(Apr 20 2024 at 18:19)</a>:</h4>
<p>Yeah, requiring functions for polymorphism was something <span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> did for complexity and compile time reasons.</p>
<p>Top levels are special to allow polymorphism. They are always turned into functions.</p>



<a name="434524013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434524013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434524013">(Apr 20 2024 at 18:27)</a>:</h4>
<p>Oh wait, it seems like <code>*</code> in local annotations is currently completely useless, because it doesn't even specify which caller-chosen variable it's referring to</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">twoEmptyLists</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">List</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span><span class="p">)</span>
<span class="nv">twoEmptyLists</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nv">empty1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="c1"># The two `*` in the signature are distinct variables. Which one are we referring to?</span>
<span class="w">    </span><span class="nv">empty1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="nv">empty2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span>
<span class="w">    </span><span class="nv">empty2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">(</span><span class="nx">empty1</span><span class="p">,</span><span class="w"> </span><span class="nx">empty2</span><span class="p">)</span><span class="w"> </span><span class="c1"># ERROR (mismatch between (List *, List *) and (List *, List *))</span>
</code></pre></div>
<p>In fact, you get the same error (albeit with a better message) even if there's only one <code>*</code> in the signature</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">myEmpty</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span>
<span class="nv">myEmpty</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nv">empty</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span>
<span class="w">    </span><span class="nv">empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="nx">empty</span><span class="w"> </span><span class="c1"># ERROR</span>
</code></pre></div>



<a name="434524183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434524183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434524183">(Apr 20 2024 at 18:29)</a>:</h4>
<p>I think the only way to use <code>*</code> in a type annotation for a local successfully is if the enclosing function has <code>_</code>s in its type</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">myEmpty2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">_</span>
<span class="nv">myEmpty2</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nv">empty</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span>
<span class="w">    </span><span class="nv">empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="nx">empty</span><span class="w"> </span><span class="c1"># no error</span>
</code></pre></div>



<a name="434524246"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434524246" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434524246">(Apr 20 2024 at 18:30)</a>:</h4>
<p>Yeah, so maybe the error should say "Putting <code>*</code> in a type definition is not really useful. Consider using <code>_</code> instead." The only cases where <code>*</code> is really useful is for function inputs.</p>



<a name="434524290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434524290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434524290">(Apr 20 2024 at 18:31)</a>:</h4>
<p>That may not be a totally fair statement, but I do think it is mostly accurate</p>



<a name="434535289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434535289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434535289">(Apr 20 2024 at 21:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F/near/434523458">said</a>:</p>
<blockquote>
<p>Top levels are special to allow polymorphism. They are always turned into functions.</p>
</blockquote>
<p>Is this accurate? I just read <a href="https://rwx.notion.site/Let-generalization-Let-s-not-742a3ab23ff742619129dcc848a271cf#0929c77b98ab47b0be4f534d7ec4dc04">Let-generalization: Let’s not?</a> and it seems to specify that only lambdas and numerals can be polymorphic, regardless of whether they're top-level or local. Isn't the fact that top-levels constants can't always be polymorphic exactly why we have <code>Dict.empty {}</code> instead of just <code>Dict.empty</code>?</p>



<a name="434535386"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434535386" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434535386">(Apr 20 2024 at 21:33)</a>:</h4>
<p>I think the bug tracked at <a href="https://github.com/roc-lang/roc/issues/5536">https://github.com/roc-lang/roc/issues/5536</a> is the same as the bug in this thread. In that example it's actually a top-level definition being annotated!</p>



<a name="434535609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434535609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434535609">(Apr 20 2024 at 21:37)</a>:</h4>
<p>I thought we made all top levels into thunks to help with this</p>



<a name="434535613"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434535613" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434535613">(Apr 20 2024 at 21:37)</a>:</h4>
<p>But I don't know all the details</p>



<a name="434537686"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434537686" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434537686">(Apr 20 2024 at 22:13)</a>:</h4>
<p>only values that are syntactic functions or numbers can be polymorphic, regardless of whether they're on the toplevel or not</p>



<a name="434537694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434537694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434537694">(Apr 20 2024 at 22:13)</a>:</h4>
<p>And in nested contexts, only syntactic functions can be polymorphic</p>



<a name="434537854"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434537854" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434537854">(Apr 20 2024 at 22:16)</a>:</h4>
<p>To the original post, I think the program should fail to compile, but the bug is that you should not be able to type <code>in : [Ok Str]*</code>. That type doesn't make any sense in Roc, since it claims that <code>in</code> is polymorphic, but it's not.</p>



<a name="434540477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434540477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434540477">(Apr 20 2024 at 23:04)</a>:</h4>
<p>Thanks for the clarity</p>



<a name="434541915"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434541915" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434541915">(Apr 20 2024 at 23:32)</a>:</h4>
<p>ok cool, so it sounds like the fix here is to make a new compiler error for annotations of this form, yeah?</p>



<a name="434542307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434542307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434542307">(Apr 20 2024 at 23:39)</a>:</h4>
<p>yeah I think so. I'm kind of surprised such a check isn't already around</p>



<a name="434695544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434695544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434695544">(Apr 22 2024 at 09:06)</a>:</h4>
<p>I want to make an issue for this, can someone summarize in which cases an annotation containing <code>]*</code> needs to error?</p>



<a name="434784298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434784298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434784298">(Apr 22 2024 at 15:43)</a>:</h4>
<p>If an annotation contains <code>*</code> or introduces a new type variable, the associated definition must be either a syntactic function or a number. So e.g.</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="c1"># OK. It's a number</span>
<span class="nv">three</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Int</span><span class="w"> </span><span class="o">*</span>
<span class="nv">three</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>

<span class="c1"># OK. It's a function</span>
<span class="nv">returnEmpty</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span>
<span class="nx">returnEmpty</span><span class="w"> </span><span class="err">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">[]</span>

<span class="c1"># Error. It's a list literal</span>
<span class="nv">empty</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="o">*</span>
<span class="nv">empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="c1"># Error. It's a tag</span>
<span class="nv">red</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">Red</span><span class="p">,</span><span class="w"> </span><span class="nx">Green</span><span class="p">,</span><span class="w"> </span><span class="nx">Blue</span><span class="p">]</span><span class="o">*</span>
<span class="nv">red</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">Red</span>

<span class="c1"># Error. It's a division operation</span>
<span class="nv">pi</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Frac</span><span class="w"> </span><span class="o">*</span>
<span class="nv">pi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">7</span>
</code></pre></div>



<a name="434784944"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434784944" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434784944">(Apr 22 2024 at 15:46)</a>:</h4>
<p><a href="https://rwx.notion.site/Let-generalization-Let-s-not-742a3ab23ff742619129dcc848a271cf#0929c77b98ab47b0be4f534d7ec4dc04">Let-generalization: Let’s not?</a> has an error message we could use as a starting point for all these cases:</p>
<blockquote>
<p><div class="codehilite"><pre><span></span><code>-- NUMBER IS NOT POLYMORPHIC --

The type annotation on `piApprox` suggests that it can be used polymorphically:

1 | piApprox : Frac *
2 | piApprox = 22 / 7

Unfortunately, I can&#39;t use `piApprox` as any fractional type! I can only use it
as exactly one of `Dec`, `F32`, or `F64`.

If you want me to infer the fractional type that should be used, you can use an
inference annotation instead of `*`:

  piApprox : Frac _

If you explicitly want `piApprox` to be able to be used polymorphically, consider
making it a thunk:

  piApprox : {} -&gt; Frac *
  piApprox = \{} -&gt; 22 / 7
</code></pre></div><br>
</p>
</blockquote>



<a name="434795532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Is%20this%20a%20bug%3F/near/434795532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Is.20this.20a.20bug.3F.html#434795532">(Apr 22 2024 at 16:33)</a>:</h4>
<p>Lovely thanks <span class="user-mention" data-user-id="636541">@timotree</span>! I made <a href="https://github.com/roc-lang/roc/issues/6663">#6663</a></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
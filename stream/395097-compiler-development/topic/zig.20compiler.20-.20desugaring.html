<html>
<head><meta charset="utf-8"><title>zig compiler - desugaring · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html">zig compiler - desugaring</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="519377817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519377817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519377817">(May 20 2025 at 12:56)</a>:</h4>
<p>I want to take a crack at getting desugaring going so that we have a sugar-free IR to work with canonicalization.  Is the correct approach here to just use the existing Parse IR and walk through and just move nodes in that have no sugar, and then break down sugar and insert it?</p>



<a name="519378279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519378279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519378279">(May 20 2025 at 12:58)</a>:</h4>
<p>And also, do we even have enough sugar at this point to warrant a whole separate step in the compiler for it? And if we should, should we try to minimize the number of modules that we touch in desugar by marking a Parse IR struct as "needing desugaring" when we insert nodes that require it?</p>



<a name="519378817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519378817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519378817">(May 20 2025 at 13:00)</a>:</h4>
<p>I think it would even be nice if we can track nodes that need desugaring and literally just mutate the existing IR (a downside being those nodes then are probably quite a ways away from each other more likely in larger files)</p>



<a name="519379050"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519379050" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519379050">(May 20 2025 at 13:01)</a>:</h4>
<blockquote>
<p>to warrant a whole separate step in the compiler for it</p>
</blockquote>
<p>I am in favor of a separate step. I feel like it would help maintainability. It's nice for on-boarding and debugging to have a place where all the desugaring is happening, vs having it intertwined with a bunch of other stuff.</p>



<a name="519379212"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519379212" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519379212">(May 20 2025 at 13:02)</a>:</h4>
<p>Another approach could be to have the sugar nodes describe themselves for the purposes of formatting and parse error reporting, but also insert the sugar when we insert the node and then node would have a link to it - and then Can can just skip past it's details and fetch the real nodes</p>



<a name="519379240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519379240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519379240">(May 20 2025 at 13:02)</a>:</h4>
<blockquote>
<p>should we try to minimize the number of modules that we touch in desugar</p>
</blockquote>
<p>That seems like something we could leave for later if need be?</p>



<a name="519379377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519379377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519379377">(May 20 2025 at 13:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20desugaring/near/519379240">said</a>:</p>
<blockquote>
<blockquote>
<p>should we try to minimize the number of modules that we touch in desugar</p>
</blockquote>
<p>That seems like something we could leave for later if need be?</p>
</blockquote>
<p>Yeah, I'm trying not to OVERLY optimize too early, but I think this is plain perf lying on the floor if we are using the same IR</p>



<a name="519379549"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519379549" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519379549">(May 20 2025 at 13:04)</a>:</h4>
<blockquote>
<p>sugar nodes describe themselves for the purposes of formatting and parse error reporting</p>
</blockquote>
<p>How does this work in the old compiler?</p>



<a name="519379724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519379724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519379724">(May 20 2025 at 13:05)</a>:</h4>
<p>We just walk the entire AST and return new AST nodes that are still Parse AST nodes</p>



<a name="519379881"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519379881" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519379881">(May 20 2025 at 13:05)</a>:</h4>
<p>(And just a note, I'm not going to start on this today - just trying to line up some tasks for the coming weeks.  I want to have a broad high-level consensus before I put hands on keyboard)</p>



<a name="519380471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519380471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519380471">(May 20 2025 at 13:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20desugaring/near/519379212">said</a>:</p>
<blockquote>
<p>Another approach could be to have the sugar nodes describe themselves for the purposes of formatting and parse error reporting, but also insert the sugar when we insert the node and then node would have a link to it - and then Can can just skip past it's details and fetch the real nodes</p>
</blockquote>
<p>That seems like a reasonable approach but it's not my area of expertise</p>



<a name="519382482"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519382482" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519382482">(May 20 2025 at 13:17)</a>:</h4>
<p>I think it's fine to start as a separate step</p>



<a name="519382624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519382624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519382624">(May 20 2025 at 13:18)</a>:</h4>
<p>I have a vague intuition that our current set of sugar can all be done during canonicalization without a separate pass (which was not true of our pre-0.1.0 sugar!)</p>



<a name="519382747"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519382747" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519382747">(May 20 2025 at 13:18)</a>:</h4>
<p>but if that turns out to be true, then it should be super easy to just take the separate pass and incorporate it into canonicalization anyway, so having it as a separate pass shouldn't be a significant downside</p>



<a name="519383057"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519383057" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519383057">(May 20 2025 at 13:19)</a>:</h4>
<p>I could be misremembering, but I think we already did Pratt parsing to resolve operator precedence during parsing, right?</p>



<a name="519383227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519383227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519383227">(May 20 2025 at 13:20)</a>:</h4>
<p>if so, I assume the only remaining concern is associativity (and reporting errors there), which can be a desugaring thing</p>



<a name="519398217"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519398217" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519398217">(May 20 2025 at 14:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring/near/519383227">said</a>:</p>
<blockquote>
<p>if so, I assume the only remaining concern is associativity (and reporting errors there), which can be a desugaring thing</p>
</blockquote>
<p>i thought pratt parsing took associativity into account?  no?</p>



<a name="519398349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519398349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519398349">(May 20 2025 at 14:19)</a>:</h4>
<p>i implemented that so long ago i forgot the specifics and im not at my machine</p>



<a name="519412717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519412717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519412717">(May 20 2025 at 15:17)</a>:</h4>
<p>oh maybe it does, I forget too <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="519715224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519715224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519715224">(May 21 2025 at 22:56)</a>:</h4>
<p>i've been digging through the Canoncalization code wrapping my mind around what <span class="user-mention" data-user-id="461444">@Sam Mohr</span> has already built.  fixed a number of assumptions that have changed since then, but there is a lot around the way idents, modules, and aliases are handled that i'm having a whale of a time wrapping my mind around</p>



<a name="519715494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519715494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519715494">(May 21 2025 at 22:59)</a>:</h4>
<p><span class="user-mention" data-user-id="781658">@Anthony Bullard</span> want to chat about it? I'm free in like 30 min</p>



<a name="519715551"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519715551" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519715551">(May 21 2025 at 22:59)</a>:</h4>
<p>i'd love to!  i have a "wellbeing day" on friday and would love to use it to make some progress while the kids are at school</p>



<a name="519742709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519742709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519742709">(May 22 2025 at 04:05)</a>:</h4>
<p>I can also answer one off question in DMs or in the channel</p>



<a name="519742940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/519742940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#519742940">(May 22 2025 at 04:07)</a>:</h4>
<p>Though I'm sure Richard knows what he's talking about</p>



<a name="520088359"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520088359" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520088359">(May 23 2025 at 16:18)</a>:</h4>
<p>I am going to take you up on this <span class="user-mention" data-user-id="461444">@Sam Mohr</span> I'm trying to understand how you imagined the Can IR working in later stages.  It seems that it stores things in a way that makes it difficult to walk down through the AST in order - but maybe I'm missing something</p>



<a name="520102854"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520102854" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520102854">(May 23 2025 at 17:51)</a>:</h4>
<p>This is my initial PR with some basic tests on adding idents and being able to see if they are or are not in scope</p>



<a name="520103010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520103010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520103010">(May 23 2025 at 17:52)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/7806">https://github.com/roc-lang/roc/pull/7806</a></p>



<a name="520103716"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520103716" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520103716">(May 23 2025 at 17:56)</a>:</h4>
<p>In a convo I had with <span class="user-mention" data-user-id="281383">@Richard Feldman</span>  and <span class="user-mention" data-user-id="515757">@Luke Boswell</span> , we talked about not needing typevars in the Can IR.  I also think we should probably move to a Node/Extra Data structure like we did for parse</p>



<a name="520103807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520103807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520103807">(May 23 2025 at 17:57)</a>:</h4>
<p>As opposed to today where every type of node has its own list</p>



<a name="520104215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520104215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520104215">(May 23 2025 at 18:00)</a>:</h4>
<p>yeah I think if we start with "<code>TypeVar</code> is just a type alias for Can IR Node Index" then a lot of things will fall out of that</p>



<a name="520104390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520104390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520104390">(May 23 2025 at 18:01)</a>:</h4>
<p>e.g. if all the info we need to store for 1 node doesn't fit in 1 node slot (without the size of one node getting unacceptably large), such as an <code>if</code> node, then ideally we use multiple node slots to store that extra info</p>



<a name="520106180"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520106180" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520106180">(May 23 2025 at 18:12)</a>:</h4>
<p>so for example, in the case of <code>if</code>, the information we need is:</p>
<ul>
<li>what's the index of the can IR node for the conditional</li>
<li>what are the indices of the can IR nodes for the branches</li>
<li>what's the index of the can IR node for the final <code>else</code> branch, if there is one</li>
</ul>
<p>in the Rust compiler's <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/can/src/expr.rs#L194-L199"><code>If</code> node</a>, we store an explicit type variable for the condition and another for the branches.</p>



<a name="520106187"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520106187" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520106187">(May 23 2025 at 18:12)</a>:</h4>
<p>We don't need to store one for the conditional anymore, because the node index of the condition is automatically a type variable, so we just use that.</p>



<a name="520106295"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520106295" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520106295">(May 23 2025 at 18:13)</a>:</h4>
<p>We also don't need to store one for the branches, because we're going to unify all the branches together anyway, so we just need to know what the first one's variable is and we're all set. And if we have the node ID of the first branch, then we know its variable, because in this design they're the same.</p>



<a name="520107757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520107757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520107757">(May 23 2025 at 18:23)</a>:</h4>
<p>so an example of how we could do <code>If</code> completely inline:</p>
<ul>
<li>we have an <code>If</code> node which stores the node index of the first <code>else</code> branch and that's it</li>
<li>immediately after that node (as in, right at the <code>If</code> node's index + 1 in the flat array of nodes) we have the conditional IR node. We don't need to write down its index because we already know it's just at our own index + 1.</li>
<li>in the interpreter, type checker, and code generator, we will always traverse the entire conditional before doing anything with any branches, so at that point we'll be at the end of the conditional</li>
<li>if we make sure to put the <code>then</code> branch immediately after the conditional, then we don't need to store an index for that either because we'll be right there as soon as we finish processing the conditional</li>
<li>the interpreter does need to know where the <code>else</code> branch is (without traversing the whole <code>then</code> branch) because if the conditional is false, it will want to jump straight there - but fortunately, that's the one index we <em>did</em> write down in the original node, so we're all set there</li>
<li>if it's an <code>else if</code>, then the <code>else</code> branch will immediately begin with an <code>if</code>, and this whole pattern repeats</li>
<li>if this is an <code>if</code> without an <code>else</code>, we can record that in the original node (e.g. have a different discriminant for <code>if</code> and <code>if_without_else</code> and they work slightly differently)</li>
</ul>



<a name="520107821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520107821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520107821">(May 23 2025 at 18:24)</a>:</h4>
<p>so basically what we're building is kind of like a linked list of nested <code>if</code>/<code>else</code>s, except it's all inline in the one flat array of nodes, no side tables needed</p>



<a name="520107892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520107892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520107892">(May 23 2025 at 18:24)</a>:</h4>
<p>and all the info necessary is already there for traversing it, checking its types (including type vars), interpreting it, code-genning it, etc.</p>



<a name="520107977"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520107977" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520107977">(May 23 2025 at 18:25)</a>:</h4>
<p>and memory locality is pretty much as good as we can get it because it's all contiguous in one flat array</p>



<a name="520113447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520113447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520113447">(May 23 2025 at 19:01)</a>:</h4>
<p>this would seem to work pretty well but unless we return the last node we touched when fetching the "usable struct" that represents the node, we will run into problems with any say conditional that's more than a simple expr</p>



<a name="520113594"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520113594" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520113594">(May 23 2025 at 19:02)</a>:</h4>
<p>say "getExpr" would need to return the Expr union member AND the last node index we touched constructing it</p>



<a name="520113796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520113796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520113796">(May 23 2025 at 19:04)</a>:</h4>
<p>which actually would require building out (or at least traversing ) the entire expr tree to find thst</p>



<a name="520113900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520113900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520113900">(May 23 2025 at 19:05)</a>:</h4>
<p>which would require pointers since it would be a recursive data structure</p>



<a name="520113997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520113997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520113997">(May 23 2025 at 19:06)</a>:</h4>
<p>or if you want to avoid that, walking the nodes for a complex expression over and over to to get the child nodes all the way down</p>



<a name="520114165"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520114165" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520114165">(May 23 2025 at 19:07)</a>:</h4>
<p>whereas storing the span of the referenced nodes avoids the need for that</p>



<a name="520116400"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520116400" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520116400">(May 23 2025 at 19:24)</a>:</h4>
<p>For instance, take a <code>if</code> expression like this:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="n">something</span><span class="o">.</span><span class="n">foo</span><span class="p">(</span><span class="s2">"Hello"</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="no">Stdout</span><span class="o">.</span><span class="n">line!</span><span class="p">(</span><span class="s2">"Branch A"</span><span class="p">)</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="no">Stdout</span><span class="o">.</span><span class="n">line!</span><span class="p">(</span><span class="s2">"Branch B"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Would result (with the straight-line left-to-right approach you lay out above) in the following node layout</p>
<div class="codehilite"><pre><span></span><code>IF_THEN_ELSE, STATIC_DISPATCH(args=2), IDENT, IDENT, STRING(parts=1), STRING_PART, INT,
APPLY(args=1), QUALIFIED_IDENT, STRING(parts=1), STRING_PART,
APPLY(args=1), QUALIFIED_IDENT, STRING(parts=1), STRING_PART
</code></pre></div>
<p>To know how to get the else body would require traversing through the conditional and the then body, and would to wanting to collecting something like</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">conditional</span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span>
<span class="w">    </span><span class="s">"@then"</span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span>
<span class="w">    </span><span class="s">"@else"</span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span>
<span class="p">}</span>

<span class="kr">const</span><span class="w"> </span><span class="n">this_if</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">If</span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">conditional</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="s">"@then"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="s">"@else"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<p>And when you fetch the conditional, you'd have to run through all the nodes again (until we have two args) to get something like</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">StaticDispatch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">subject</span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span>
<span class="w">    </span><span class="s">"@callee"</span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span>
<span class="w">   </span><span class="n">args</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span><span class="n">Node</span><span class="p">.</span><span class="n">Idx</span><span class="p">,</span>
<span class="p">};</span>

<span class="kr">const</span><span class="w"> </span><span class="n">this_sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StaticDispatch</span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="s">"@callee"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">.{</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">}</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<p>Since we have to skip the STRING_PART at Index 5.</p>
<p>So we've already walked through nodes 1-6 twice.  I don't think that's a big deal, but is that we want to be doing?  We'd have to have <code>walk*</code> methods as well as <code>get*</code> methods so that we walk through the nodes without building intermediate structs that we will through away (they would instead return the last node idx touched)</p>



<a name="520117081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520117081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520117081">(May 23 2025 at 19:29)</a>:</h4>
<p>I think the structure of having a Node that stores a primary piece of data, and a span of extra data in a side array allows us to basically "memoize" that node traversal at the cost of moving between two arrays (I would assume the loaded chunks of those arrays could both fit nice and cozy in the L1 cache of most modern processors for most expressions (or even an average decl))</p>



<a name="520117225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520117225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520117225">(May 23 2025 at 19:30)</a>:</h4>
<p>So I guess my preference is to lean heavily on the structure of the Parse IR which seems to be incredibly fast and the mechanics of it are easy to understand</p>



<a name="520121565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520121565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520121565">(May 23 2025 at 20:02)</a>:</h4>
<p>looking at it while thinking about TypeVars, I think that should work fine <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="520121677"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520121677" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520121677">(May 23 2025 at 20:03)</a>:</h4>
<p>I'd say go for it!</p>



<a name="520134071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520134071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520134071">(May 23 2025 at 21:51)</a>:</h4>
<p>Push up the broken rough draft state of where I'm headed with the IR - again heavily based on Parse IR</p>



<a name="520134151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520134151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520134151">(May 23 2025 at 21:52)</a>:</h4>
<p>Anything outside of the NodeStore is probably incorrect or only partially correct.  Most likely out of date</p>



<a name="520134198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520134198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520134198">(May 23 2025 at 21:52)</a>:</h4>
<p>So just focus on the high-level API of the NodeStore</p>



<a name="520134351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520134351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520134351">(May 23 2025 at 21:54)</a>:</h4>
<p>I'm done for the day, hope to have some time tomorrow morning to clean up some of the broken stuff and then fill in the minimal details to get my can tests (and any other broken tests and code) working again</p>



<a name="520155824"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520155824" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520155824">(May 24 2025 at 02:58)</a>:</h4>
<p>I gave it a quick read - looking good so far! <span aria-label="raised hands" class="emoji emoji-1f64c" role="img" title="raised hands">:raised_hands:</span></p>



<a name="520262423"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520262423" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520262423">(May 25 2025 at 05:50)</a>:</h4>
<p>Reading through the PR now, it seems like we've removed the ownership of the <code>ModuleEnv</code> from the <code>can.IR</code>. Are we not planning on doing the two syscall caching of the Can IR, maybe instead opting for a manual (de)serialization?</p>



<a name="520262450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520262450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520262450">(May 25 2025 at 05:51)</a>:</h4>
<p>If not, then the <code>ModuleEnv</code> should continue to be owned by the <code>can.IR</code></p>



<a name="520280982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520280982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520280982">(May 25 2025 at 10:31)</a>:</h4>
<p>it's a decision i'm going back on <span aria-label="rolling on the floor laughing" class="emoji emoji-1f923" role="img" title="rolling on the floor laughing">:rolling_on_the_floor_laughing:</span></p>



<a name="520281066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281066">(May 25 2025 at 10:32)</a>:</h4>
<p>i still don't understand how we can do it in two syscalls with all of the pointers going on here</p>



<a name="520281120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281120">(May 25 2025 at 10:33)</a>:</h4>
<p>but it's just not the kind of thing i have experience with</p>



<a name="520281135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281135">(May 25 2025 at 10:33)</a>:</h4>
<p>but module work is forcing my<br>
hand</p>



<a name="520281210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281210">(May 25 2025 at 10:34)</a>:</h4>
<p>Do you agree with the ModuleWork mechanism?</p>



<a name="520281237"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281237" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281237">(May 25 2025 at 10:35)</a>:</h4>
<p>Its goal is to allow simple parallel compilation that doesn't require complex/non-trivial lookup of compilation artifacts from other compiler phases</p>



<a name="520281278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281278">(May 25 2025 at 10:36)</a>:</h4>
<p>it  seems fine every if i haven't read through it all</p>



<a name="520281298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281298">(May 25 2025 at 10:36)</a>:</h4>
<p>Yeah, okay</p>



<a name="520281300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281300">(May 25 2025 at 10:36)</a>:</h4>
<p>I think another mechanism could work</p>



<a name="520281310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281310">(May 25 2025 at 10:36)</a>:</h4>
<p>But high level seems good</p>



<a name="520281318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281318">(May 25 2025 at 10:36)</a>:</h4>
<p>possibly but i'm hyper focused on getting Can moving at the moment</p>



<a name="520281331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281331">(May 25 2025 at 10:37)</a>:</h4>
<p>That's great, thanks for picking up the slack!</p>



<a name="520281333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281333">(May 25 2025 at 10:37)</a>:</h4>
<p>I'm gonna try again to read through the new IR shape</p>



<a name="520281441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281441">(May 25 2025 at 10:38)</a>:</h4>
<p>I'm feeling like the new IR has further indirection from the underlying concept of a syntax tree</p>



<a name="520281447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281447">(May 25 2025 at 10:38)</a>:</h4>
<p>Which makes programming with it harder to get correct</p>



<a name="520281499"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281499" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281499">(May 25 2025 at 10:39)</a>:</h4>
<p>The old IR is basically just a tree, but instead of every node being behind a heap allocation, they're instead indices into arrays of the right node type</p>



<a name="520281555"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281555" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281555">(May 25 2025 at 10:40)</a>:</h4>
<p>This mechanism flattens everything into a single bucket, and the <code>Node</code> needs to be interacted with via some unwrapping API for interaction with the syntax tree</p>



<a name="520281577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281577">(May 25 2025 at 10:41)</a>:</h4>
<p>Is there a reasonable perf benefit to the parse style IR over the old IR?</p>



<a name="520281775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281775">(May 25 2025 at 10:44)</a>:</h4>
<p>Well you are more likely to have cache locality if all of the nodes are in one contiguous block of memory, whereas the different slices we had before could have their backing storage allocated all over the place.  But that's more theory (and me watching Matt Lugg's talks about Zig's compiler) than anything else.</p>



<a name="520281820"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281820" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281820">(May 25 2025 at 10:45)</a>:</h4>
<p>And they will be in one contiguous block since we created the nodes in order while running through the tree</p>



<a name="520281913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281913">(May 25 2025 at 10:46)</a>:</h4>
<p>The ParseIR design has also been shown to be very fast, and I know how to work with it - and someone that learns one IR can translate that knowledge towards understanding the second</p>



<a name="520281963"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520281963" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520281963">(May 25 2025 at 10:47)</a>:</h4>
<p>And during unification/type checking we can just add the typevars off row using the same index as the original node</p>



<a name="520282018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282018">(May 25 2025 at 10:48)</a>:</h4>
<p>(Richard said he wanted to avoid having TypeVars in the CanIR, unlike what we did with the Rust compiler)</p>



<a name="520282040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282040">(May 25 2025 at 10:49)</a>:</h4>
<p>But I want your feedback if you are willing and able <span class="user-mention" data-user-id="461444">@Sam Mohr</span> I trust your opinion and design sense.</p>



<a name="520282380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282380">(May 25 2025 at 10:54)</a>:</h4>
<p>Yeah, cache locality is the argument that drives all of this array-backed storage in the first place</p>



<a name="520282443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282443">(May 25 2025 at 10:55)</a>:</h4>
<p>In this case, it <em>feels</em> like the parse IR approach (do you have a better name for the pattern?) would have better spatial locality</p>



<a name="520282544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282544">(May 25 2025 at 10:57)</a>:</h4>
<p>The bias I have towards the existing pattern is that it lets the compiler check we're doing things correctly at the type level</p>



<a name="520282560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282560">(May 25 2025 at 10:57)</a>:</h4>
<p>And that's not really true of the parse IR, its runtime benefits notwithstanding</p>



<a name="520282574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282574">(May 25 2025 at 10:57)</a>:</h4>
<p>We have to really get it right in terms of putting in and taking out the right data for the right IR node</p>



<a name="520282625"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282625" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282625">(May 25 2025 at 10:58)</a>:</h4>
<p>However, this is compiler dev</p>



<a name="520282628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282628">(May 25 2025 at 10:58)</a>:</h4>
<p>And two rules are important to consider:</p>



<a name="520282651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282651">(May 25 2025 at 10:59)</a>:</h4>
<ol>
<li>We aren't trying to use standard maintainability rules because perf is more important at a line-by-line level than a normal project by far</li>
</ol>



<a name="520282665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282665">(May 25 2025 at 10:59)</a>:</h4>
<ol start="2">
<li>We don't have that much ongoing contribution, so code that does what we want is better than idealized code that doesn't exist</li>
</ol>



<a name="520282755"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282755" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282755">(May 25 2025 at 11:00)</a>:</h4>
<p>So if you're working on it and no one else is, then getting something that works, has the right behavior, and won't need to be made more performant in the future sounds good to me</p>



<a name="520282943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520282943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520282943">(May 25 2025 at 11:03)</a>:</h4>
<p>Last memory-related thought: the single, mother Node approach means that all nodes have the same size, which is the minimum required to represent the largest node type</p>



<a name="520283017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283017">(May 25 2025 at 11:04)</a>:</h4>
<p>But with heterogeneous storage of IR nodes, only a few nodes (e.g. <code>if</code> and <code>when</code>) need a lot of memory, and the rest can just be small pointers to those</p>



<a name="520283040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283040">(May 25 2025 at 11:05)</a>:</h4>
<p>So as much as we probably store children closer to their parents, we probably use more memory</p>



<a name="520283055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283055">(May 25 2025 at 11:05)</a>:</h4>
<p>No idea how much that trade-off is though <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span></p>



<a name="520283079"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283079" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283079">(May 25 2025 at 11:05)</a>:</h4>
<p>But those nodes are made minimal and just point (through extra_data an array of just u32s) to other nodes which contain the other information</p>



<a name="520283148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283148">(May 25 2025 at 11:06)</a>:</h4>
<p>If they are larger than what we consider minimal</p>



<a name="520283200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283200">(May 25 2025 at 11:07)</a>:</h4>
<p>Ah, my memory was off</p>



<a name="520283202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283202">(May 25 2025 at 11:07)</a>:</h4>
<p>A modern CPU core can fit I think I counted a chunk of 1000 nodes and a chunk of 1000 extra_data into L1 cache and still have plenty of room for the stack</p>



<a name="520283218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283218">(May 25 2025 at 11:07)</a>:</h4>
<p>Something I guess I hadn't done yet was the extraction of all the bigger nodes to their own lists</p>



<a name="520283297"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283297" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283297">(May 25 2025 at 11:08)</a>:</h4>
<p>Basically, you have <code>data_1</code>, <code>data_2</code>, and <code>data_3</code> on every node. How few <code>data</code> fields could you get away with if you moved the bigger node types to their own arrays?</p>



<a name="520283299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283299">(May 25 2025 at 11:08)</a>:</h4>
<p>I think that being able to just grab numbers off a chunk likely in L1 cache to lookup a node that is probably also in L1 cache is going to be ridiculously fast.</p>



<a name="520283339"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283339" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283339">(May 25 2025 at 11:09)</a>:</h4>
<p>Yeah, I'll admit that I am much more strongly motivated by the "have the code look like the domain model" argument than the perf argument, and that first argument doesn't matter as much</p>



<a name="520283348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283348">(May 25 2025 at 11:09)</a>:</h4>
<p>Both should be very fast, and your approach is <em>probably</em> faster</p>



<a name="520283350"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283350" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283350">(May 25 2025 at 11:09)</a>:</h4>
<p>You use three data <del>nodes</del> fields.  One is for primary data (the main business of the node), and data_2 and data_3 will be either used for ancillary data or storing a Span for accessing a chunk of extra_data that points to more nodes</p>



<a name="520283429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283429">(May 25 2025 at 11:10)</a>:</h4>
<p>You can look at how we store if_then_else exprs in the Parse IR</p>



<a name="520283463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283463">(May 25 2025 at 11:11)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/main/src/check/parse/IR.zig#L1189">https://github.com/roc-lang/roc/blob/main/src/check/parse/IR.zig#L1189</a> &lt;- Add the node</p>



<a name="520283476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283476">(May 25 2025 at 11:11)</a>:</h4>
<p>But if 50% of nodes only need 2 <code>data</code> fields, then you could save 4 / 2 = 2 bytes per IR node on average</p>



<a name="520283492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283492">(May 25 2025 at 11:12)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/main/src/check/parse/IR.zig#L1916">https://github.com/roc-lang/roc/blob/main/src/check/parse/IR.zig#L1916</a> &lt;- Get the node</p>



<a name="520283530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283530">(May 25 2025 at 11:12)</a>:</h4>
<p><del>That's the same line number</del></p>



<a name="520283547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283547">(May 25 2025 at 11:12)</a>:</h4>
<p>And then the owner of the IR can lazily grab the other bits as it needs it</p>



<a name="520283560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283560">(May 25 2025 at 11:13)</a>:</h4>
<p>I understand this</p>



<a name="520283568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283568">(May 25 2025 at 11:13)</a>:</h4>
<p>snark not intended</p>



<a name="520283585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283585">(May 25 2025 at 11:13)</a>:</h4>
<p>It's true, but then we would more likely have to create more nodes</p>



<a name="520283586"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283586" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283586">(May 25 2025 at 11:13)</a>:</h4>
<p>It's relatively simple, yes, it just leaves us open to math errors in a way that a more typed approach doesn't</p>



<a name="520283646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283646">(May 25 2025 at 11:14)</a>:</h4>
<p>It's probably not an exact science, but we can measure and adapt the size of the nodes as we find things working</p>



<a name="520283649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283649">(May 25 2025 at 11:14)</a>:</h4>
<p>Yes, agreed</p>



<a name="520283658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283658">(May 25 2025 at 11:14)</a>:</h4>
<p>I think that this is a pretty modular part of the compiler</p>



<a name="520283662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283662">(May 25 2025 at 11:14)</a>:</h4>
<p>The nice thing is the way things can go bad is small and it's limited to these API functiosn</p>



<a name="520283704"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283704" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283704">(May 25 2025 at 11:15)</a>:</h4>
<p>So the surface error of type unsafety is very contained for the amount of simplicity we get</p>



<a name="520283717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283717">(May 25 2025 at 11:15)</a>:</h4>
<p>You just have to communicate that direct interaction with the underlying data should never be done</p>



<a name="520283725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283725">(May 25 2025 at 11:15)</a>:</h4>
<p>This sounds like a job for Captain Encapsulation!</p>



<a name="520283779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283779">(May 25 2025 at 11:16)</a>:</h4>
<p>I just want to trust that compiler devs are smart enough to understand that :-). And that thorough snapshot testing will have our backs</p>



<a name="520283788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283788">(May 25 2025 at 11:16)</a>:</h4>
<p>Well, better to not rely on trust</p>



<a name="520283791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283791">(May 25 2025 at 11:16)</a>:</h4>
<p>I believe in our testing suite</p>



<a name="520283797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283797">(May 25 2025 at 11:17)</a>:</h4>
<p>And some asserts</p>



<a name="520283803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283803">(May 25 2025 at 11:17)</a>:</h4>
<p>maybe even a lot of asserts at scale</p>



<a name="520283804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283804">(May 25 2025 at 11:17)</a>:</h4>
<p>How would our testing suite prevent someone from directly reading/writing to an array?</p>



<a name="520283817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283817">(May 25 2025 at 11:17)</a>:</h4>
<p>If you do something wrong - the snapshots will change in a pretty profound and noticable way</p>



<a name="520283877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283877">(May 25 2025 at 11:18)</a>:</h4>
<p>I think you can make things work properly by manually manipulating the data, even if it's more effort than using the provided APIs</p>



<a name="520283882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520283882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520283882">(May 25 2025 at 11:18)</a>:</h4>
<p>Do you think that encapsulation is actively bad here?</p>



<a name="520284007"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284007" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284007">(May 25 2025 at 11:21)</a>:</h4>
<p>No, that's why I provide the API I do</p>



<a name="520284017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284017">(May 25 2025 at 11:21)</a>:</h4>
<p>Zig doesn't really believe in encapsulation</p>



<a name="520284025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284025">(May 25 2025 at 11:21)</a>:</h4>
<p>Yeah, that's the underlying issue, isn't it</p>



<a name="520284079"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284079" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284079">(May 25 2025 at 11:22)</a>:</h4>
<p>Cause I'd say that API is only half of a solution, like a jar without a lid</p>



<a name="520284081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284081">(May 25 2025 at 11:22)</a>:</h4>
<p>Andrew seems to not be the biggest fan of the concept</p>



<a name="520284088"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284088" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284088">(May 25 2025 at 11:22)</a>:</h4>
<p>You can't encapsulate without privacy</p>



<a name="520284092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284092">(May 25 2025 at 11:22)</a>:</h4>
<p>It's kind like, you wouldn't touch the <code>items</code> pointer in a slice, would you?</p>



<a name="520284146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284146">(May 25 2025 at 11:23)</a>:</h4>
<p>So much of the Rust compiler's development seemed to be done by people inferring how it worked based on what they saw in undocumented code</p>



<a name="520284159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284159">(May 25 2025 at 11:23)</a>:</h4>
<p>...</p>



<a name="520284171"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284171" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284171">(May 25 2025 at 11:24)</a>:</h4>
<p>I guess if it's not a problem, it's not a problem</p>



<a name="520284252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284252">(May 25 2025 at 11:24)</a>:</h4>
<p>I'd just <em>always</em> look for a low-cost way to rely on zero trust, or less trust if that's what I can get</p>



<a name="520284281"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284281" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284281">(May 25 2025 at 11:25)</a>:</h4>
<p>But Zig doesn't make that easy without awkwardly naming fields <code>itemsDontTouchMePlease</code></p>



<a name="520284303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284303">(May 25 2025 at 11:25)</a>:</h4>
<p>So maybe it's not worth it</p>



<a name="520284313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284313">(May 25 2025 at 11:25)</a>:</h4>
<p>I search for "Andrew Kelley on Zig encapsulation" and AI gave me this, I wonder if Andrew would agree with the slop:</p>
<blockquote>
<p>Andrew Kelley, the creator of the <a href="https://www.google.com/search?sca_esv=ac42a23dc90a30b7&amp;cs=1&amp;sxsrf=AE3TifOrpCBYYR6BkpWKt2sBMmxOtMLCCQ%3A1748172223621&amp;q=Zig+programming+language&amp;sa=X&amp;ved=2ahUKEwicpPqCwb6NAxVmvokEHeLCFW8QxccNegQIAhAB&amp;mstk=AUtExfALGH5_h8bEwomKcr_lPpNpg9eAqjlLOGUeJSKpWau_oI10U_tVnILPQuBwQV5ngm2dyMD26G0FgQ6-CorGxbiX6lFnT3bzGU8JHOA2MP1oeD1ny6xZceGV5nfeAob6SlGHPazqmcjvTKXPkIVms5HKEfi7VSw4cVlACkFYmemHDVi4oEygFJqDydNniJY7-jI2iVIFxNKsE4GfG090c_JXCtcDNopdzfm-k3m68KwYWfvYvNUqSPT_mpoB9En--YwzP7Q9PIJ8gZ-xh7zNEFjO4het9Y9PLTVOzNgCgF-kgw&amp;csui=3">Zig programming language</a>, has not specifically addressed encapsulation in the same way as other languages like C++ or Java. However, Zig does offer features that enable encapsulation through other mechanisms. Kelley's focus is on a system-level programming language that emphasizes safety and performance, with encapsulation being a secondary concern. </p>
<p>Here's a breakdown of how encapsulation works in Zig and what Kelley's perspective is:</p>
<ol>
<li>Encapsulation through Modules and Structures:</li>
</ol>
<ul>
<li>Zig uses modules to group related functions and data, providing a basic level of encapsulation.</li>
<li>Structures (like <code>struct</code>) are used to define data types, and while they don't have the same access modifiers as other languages, they can be used to create data-hiding mechanisms.</li>
</ul>
<ol start="2">
<li>Implicit vs. Explicit Encapsulation:</li>
</ol>
<ul>
<li>Zig doesn't have explicit access modifiers (like <code>public</code>, <code>private</code>, <code>protected</code>).</li>
<li>Encapsulation is achieved through a combination of module organization, structure definition, and coding practices.</li>
</ul>
<ol start="3">
<li>Kelley's Emphasis on Safety and Performance:</li>
</ol>
<ul>
<li>Kelley's primary focus is on creating a language that is safe by default and provides excellent performance.</li>
<li>This means that while encapsulation is important, it's not the central focus in the same way as in languages that prioritize object-oriented programming.</li>
</ul>
<ol start="4">
<li>Alternative Encapsulation Techniques:</li>
</ol>
<ul>
<li>Zig developers can use techniques like using private functions within modules, using unions for data representation, and employing memory-safe allocation methods to achieve levels of encapsulation.</li>
</ul>
<ol start="5">
<li>Kelley's Views on Encapsulation:</li>
</ol>
<ul>
<li>While Kelley doesn't have a strong emphasis on traditional object-oriented encapsulation, he does understand its importance in building complex and robust software.</li>
<li>He has suggested that Zig's structure and module system allow for a reasonable degree of encapsulation without sacrificing the language's focus on safety and performance.</li>
</ul>
<p>In essence, Zig's approach to encapsulation is more functional and less object-oriented, with encapsulation being achieved through a combination of modules, structures, and coding practices. Kelley's focus on safety and performance means that while encapsulation is important, it's not the primary driver in the same way as in other languages.</p>
</blockquote>



<a name="520284398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284398">(May 25 2025 at 11:26)</a>:</h4>
<p>A lot of what's said there mirrors my memory of what he has said on the topic before</p>



<a name="520284464"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284464" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284464">(May 25 2025 at 11:27)</a>:</h4>
<p>And I know that big Zig users like TigerBeetle solve this through a HEAVY use of Asserts and some very sophisticated testing techniques</p>



<a name="520284479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284479">(May 25 2025 at 11:27)</a>:</h4>
<p>Here's his reason from the mouth (finger mouth?): <a href="https://github.com/ziglang/zig/issues/9909#issuecomment-942686366">https://github.com/ziglang/zig/issues/9909#issuecomment-942686366</a></p>



<a name="520284574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284574">(May 25 2025 at 11:29)</a>:</h4>
<blockquote>
<p>the more effective strategy is to provide <strong>composable abstraction layers</strong>.</p>
</blockquote>



<a name="520284687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284687">(May 25 2025 at 11:31)</a>:</h4>
<p>The current IR feels like it follows that better by not requiring the half of encapsulation that Zig lets us implement, but again, it should be <em>good enough</em> to do it the way you've outlined, as well as faster and in line with the proven effective approach in the parse code</p>



<a name="520284715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284715">(May 25 2025 at 11:31)</a>:</h4>
<p>We could try this approach if you are really concerned: <a href="https://github.com/ziglang/zig/issues/9909#issuecomment-2679366674">https://github.com/ziglang/zig/issues/9909#issuecomment-2679366674</a></p>



<a name="520284730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284730">(May 25 2025 at 11:31)</a>:</h4>
<p>Lmao let's not</p>



<a name="520284808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284808">(May 25 2025 at 11:32)</a>:</h4>
<p>I'm not really concerned. I'm continuing this conversation because it seems like you're more interested in us finding alignment, but I don't strongly hold my fundamentally different opinion</p>



<a name="520284809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284809">(May 25 2025 at 11:32)</a>:</h4>
<p>It's pretty simple.  Just a bitCast inside every method that needs the private field (NodeStore here)</p>



<a name="520284818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284818">(May 25 2025 at 11:32)</a>:</h4>
<p>Cool</p>



<a name="520284857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520284857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520284857">(May 25 2025 at 11:34)</a>:</h4>
<p>I'm just trying to ride with wave of what Zig does, and since I am working on it with very smart people - hoping that we will all be striving for understanding before moving and all row the boat in the right direction</p>



<a name="520285039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520285039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520285039">(May 25 2025 at 11:36)</a>:</h4>
<p>Yeah, that's part of it, I like doing what Zig devs people would do, let's work with the language instead of against it</p>



<a name="520285049"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520285049" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520285049">(May 25 2025 at 11:36)</a>:</h4>
<p>Agreed <span aria-label="handshake" class="emoji emoji-1f91d" role="img" title="handshake">:handshake:</span></p>



<a name="520285065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520285065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520285065">(May 25 2025 at 11:37)</a>:</h4>
<p>But now my kids woke up, so I'll have to actually code later ;-)</p>



<a name="520285066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520285066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520285066">(May 25 2025 at 11:37)</a>:</h4>
<p>kk</p>



<a name="520285271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520285271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520285271">(May 25 2025 at 11:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20desugaring/near/520281066">said</a>:</p>
<blockquote>
<p>i still don't understand how we can do it in two syscalls with all of the pointers going on here</p>
</blockquote>
<p>Just to get back to this, the goal is to save/load cache data at a module level (and maybe for other data) as quickly possible. We can manually write serializers and deserializers to do this, but then they need to write to a file on the scale of bytes at a time, rather than all of the memory we care about all at once.</p>
<p>Luckily for us, Richard had an idea (coming from discussion with Andrew, I think) that if all of the memory that we want to cache exists in one contiguous array, we can just write that to a file directly. And even better, we can read it directly back to memory on cache load with no deserialization step!</p>
<p>This only works if we have all of the memory we want in a single block with no pointers (pointers will be wrong if the heap is different in different runs, but indices are fine). That's why <code>ModuleEnv</code> is owned by <code>can.IR</code>: then everything is in one place!</p>



<a name="520288528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520288528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520288528">(May 25 2025 at 12:30)</a>:</h4>
<p>just a quick note - the approach <span class="user-mention" data-user-id="341568">@Jared Ramirez</span> used in <a href="https://github.com/roc-lang/roc/pull/7772">https://github.com/roc-lang/roc/pull/7772</a> checks all these boxes!</p>



<a name="520288716"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520288716" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520288716">(May 25 2025 at 12:33)</a>:</h4>
<ul>
<li>everything is index-based</li>
<li>types can be nested (just like the tree of canonical IR nodes)</li>
<li>there is a statically-known number of pointers in the whole data structure (they're all <a href="https://github.com/roc-lang/roc/pull/7772/files#diff-1cd1b9ba7bb1e34989361cb881940bc31b7513ba1476d893cc0d82a65bd21606R49-R60">right here</a>) so after the one read syscall, all we have to do is go update these 9 pointers and we're done - and it's always exactly 9 pointers, as opposed to having to traverse the entire structure and update a number of pointers that grows with the size of the deserialized data</li>
</ul>



<a name="520478400"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520478400" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520478400">(May 26 2025 at 15:18)</a>:</h4>
<p>Hmm, I thought the design of the new compiler's canonicalize pass was already very similar to just 'desugaring'. What's the delta between those?</p>



<a name="520640996"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520640996" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520640996">(May 27 2025 at 11:13)</a>:</h4>
<p>That's likely what we will get Joshua</p>



<a name="520641085"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520641085" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520641085">(May 27 2025 at 11:14)</a>:</h4>
<p>But right now I'm dealing with a clean compile that crashes with a SIGBUS error</p>



<a name="520641110"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520641110" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520641110">(May 27 2025 at 11:14)</a>:</h4>
<p>So that's a lot of fun</p>



<a name="520644110"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520644110" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520644110">(May 27 2025 at 11:28)</a>:</h4>
<p>Does zig crash or does our (partial) compilation of a roc file crash?</p>



<a name="520646243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520646243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520646243">(May 27 2025 at 11:39)</a>:</h4>
<p>a test crashes</p>



<a name="520646266"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520646266" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520646266">(May 27 2025 at 11:39)</a>:</h4>
<p>net new to my change</p>



<a name="520646403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520646403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520646403">(May 27 2025 at 11:40)</a>:</h4>
<p>it's some sort of alignment issue, but it's not clear what's the cause</p>



<a name="520646436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520646436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520646436">(May 27 2025 at 11:40)</a>:</h4>
<p>there is no stack trace</p>



<a name="520646600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520646600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520646600">(May 27 2025 at 11:41)</a>:</h4>
<p>Sounds tough, I can take a look if you put up a branch :)</p>



<a name="520648260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520648260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520648260">(May 27 2025 at 11:50)</a>:</h4>
<p>valgrind should help you get additional info</p>



<a name="520659095"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520659095" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520659095">(May 27 2025 at 12:43)</a>:</h4>
<p>I've got a theory that I'll test, then try valgrind, then I'll phone a friend <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="520659943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520659943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520659943">(May 27 2025 at 12:47)</a>:</h4>
<p>I'm going to have to push the branch anyway to run this on my Linux machine since I valgrind doesn't work on macos</p>



<a name="520677031"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520677031" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520677031">(May 27 2025 at 14:03)</a>:</h4>
<p>Even tearing my test down to being pretty minimal (not calling the actual can method) I've went from SIGBUS to SIGSEGV to now a SIGTRAP</p>



<a name="520680569"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520680569" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520680569">(May 27 2025 at 14:19)</a>:</h4>
<p>Back to seg fault :-)</p>



<a name="520680611"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520680611" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520680611">(May 27 2025 at 14:19)</a>:</h4>
<p>It has something to do with deinit'ing an ArrayListUnmanaged</p>



<a name="520680634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520680634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520680634">(May 27 2025 at 14:19)</a>:</h4>
<p>I'll have to figure it out tomorrow</p>



<a name="520680685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520680685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520680685">(May 27 2025 at 14:19)</a>:</h4>
<p>This is a good thing for me to struggle with, since there is obviously something I don't understand</p>



<a name="520684908"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520684908" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520684908">(May 27 2025 at 14:38)</a>:</h4>
<p>This might be why <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span> : </p>
<blockquote>
<p>Deinit levels backing arraylist with 16562106820025843780 items</p>
</blockquote>



<a name="520686947"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520686947" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520686947">(May 27 2025 at 14:47)</a>:</h4>
<p>What's weird is that it "just happens all the sudden", here's all the logs at every place we handle it until deinit'ing that array:</p>
<blockquote>
<p>Enter with 0 levels...Returning a scope with 1 levels...can has a scope with 1 levels...Deinit levels...Deinit levels backing arraylist with 7484431091188432957 items...Segmentation fault at address 0x67de0a6c582d003d</p>
</blockquote>



<a name="520687085"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520687085" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520687085">(May 27 2025 at 14:48)</a>:</h4>
<p>And you can see the number of items has changed, which tells me the items array has junk in it</p>



<a name="520687406"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520687406" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520687406">(May 27 2025 at 14:49)</a>:</h4>
<p>That's also not addressable in even 64 bytes (7 quintillion???)</p>



<a name="520688397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520688397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520688397">(May 27 2025 at 14:53)</a>:</h4>
<p>This code:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Self</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">can_ir</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">parse_ir</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"can has a scope with {d} levels..."</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">can</span><span class="p">.</span><span class="n">scope</span><span class="p">.</span><span class="n">levels</span><span class="p">.</span><span class="n">levels</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">len</span><span class="p">});</span>
<span class="w">    </span><span class="n">can</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Deinit for can</span>
<span class="w">    </span><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">deinit</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">Self</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Can has a scope with {d} levels at deinit..."</span><span class="p">,</span><span class="w"> </span><span class="p">.{</span><span class="n">self</span><span class="p">.</span><span class="n">scope</span><span class="p">.</span><span class="n">levels</span><span class="p">.</span><span class="n">levels</span><span class="p">.</span><span class="n">items</span><span class="p">.</span><span class="n">len</span><span class="p">});</span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">scope</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>Will produce this:</p>
<blockquote>
<p>can has a scope with 1 levels...Can has a scope with 4371552663 levels at deinit...</p>
</blockquote>



<a name="520689801"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520689801" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520689801">(May 27 2025 at 14:59)</a>:</h4>
<p>It's something with pointers....</p>



<a name="520698182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520698182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520698182">(May 27 2025 at 15:35)</a>:</h4>
<p>It's that the Scope was created internally by Can in an init function, but not heap allocated so it fell off the stack and the pointer did in fact point to garbage.</p>



<a name="520698350"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520698350" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520698350">(May 27 2025 at 15:36)</a>:</h4>
<p>Oh interesting</p>



<a name="520764674"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520764674" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520764674">(May 27 2025 at 21:49)</a>:</h4>
<p>Yeah, the issue I have now is leaks.</p>



<a name="520765352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520765352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520765352">(May 27 2025 at 21:54)</a>:</h4>
<p>There seems to be some contention between wanting the ModuleEnv to be owned by Can IR and not having issues with memory leaks</p>



<a name="520765425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520765425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520765425">(May 27 2025 at 21:55)</a>:</h4>
<p>Or a skill issue on my part (probably the most likely answer)</p>



<a name="520765656"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520765656" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520765656">(May 27 2025 at 21:57)</a>:</h4>
<p>And...I think I just solved it</p>



<a name="520768031"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520768031" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520768031">(May 27 2025 at 22:19)</a>:</h4>
<p>Finally:</p>
<div class="codehilite"><pre><span></span><code>Build Summary: 4/4 steps succeeded; 117/117 tests passed
test success
└─ run test 117 passed 318ms MaxRSS:3M
   └─ zig test Debug native success 2s MaxRSS:535M
      └─ options cached
</code></pre></div>



<a name="520769010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520769010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520769010">(May 27 2025 at 22:29)</a>:</h4>
<p>Updated my PR</p>



<a name="520769029"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520769029" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520769029">(May 27 2025 at 22:29)</a>:</h4>
<p>And now....to actually do canonicalization stuff</p>



<a name="520772533"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520772533" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520772533">(May 27 2025 at 23:09)</a>:</h4>
<p>for binops and unaries, two questions:</p>
<ol>
<li>should i desugar them to "normal" functions or special dispatch?</li>
<li>if normal do i need to add the module that encloses that function to the imports?</li>
</ol>



<a name="520772646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520772646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520772646">(May 27 2025 at 23:10)</a>:</h4>
<p>and specifically for ?? do we want to continue desugaring to match or a function call?</p>



<a name="520772767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520772767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520772767">(May 27 2025 at 23:12)</a>:</h4>
<p>i'm also assuming <code>return</code> will need to do a pretty substantial rewrite when desugaring?</p>



<a name="520772939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520772939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520772939">(May 27 2025 at 23:14)</a>:</h4>
<p>normal functions by default, but not if control flow is involved</p>



<a name="520772960"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520772960" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520772960">(May 27 2025 at 23:15)</a>:</h4>
<p><code>return</code> shouldn't be sugar, it should be a first-class thing</p>



<a name="520772985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520772985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520772985">(May 27 2025 at 23:15)</a>:</h4>
<p>so <code>and</code>, <code>or</code>, <code>?</code>, and <code>??</code> all desugar to control flow</p>



<a name="520773214"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773214" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773214">(May 27 2025 at 23:18)</a>:</h4>
<p>that said, I actually kinda wonder if we should skip desugaring until later</p>



<a name="520773223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773223">(May 27 2025 at 23:18)</a>:</h4>
<p>that said, I actually kinda wonder if we should skip desugaring until later</p>



<a name="520773231"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773231" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773231">(May 27 2025 at 23:18)</a>:</h4>
<p>like just keep all of those first-class for now</p>



<a name="520773245"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773245" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773245">(May 27 2025 at 23:19)</a>:</h4>
<p>in canonicalization</p>



<a name="520773374"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773374" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773374">(May 27 2025 at 23:21)</a>:</h4>
<p>because we already do <code>CalledVia</code> to distinguish between plain function calls and desugared operators, so are we actually saving ourselves anything to desugar at this point, or are we just making <code>roc check</code> do unnecessary work?</p>



<a name="520773392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773392">(May 27 2025 at 23:21)</a>:</h4>
<p>when that work could be deferred to actual builds instead</p>



<a name="520773637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773637">(May 27 2025 at 23:24)</a>:</h4>
<p>Oh that would make can much simpler</p>



<a name="520773649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520773649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520773649">(May 27 2025 at 23:24)</a>:</h4>
<p>If it's easy enough to type check those constructs, that's fine with me</p>



<a name="520774158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520774158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520774158">(May 27 2025 at 23:31)</a>:</h4>
<p>I think as far as unifying types goes, <code>and</code>, <code>or</code>, <code>?</code> and <code>??</code> should be fine – we'll just have to internally give them the same type as what the functions they desugar to when generating constraints</p>



<a name="520774752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520774752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520774752">(May 27 2025 at 23:39)</a>:</h4>
<p>it feels like Can is doing work that 90% of which COULD be done at parse time</p>



<a name="520774788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520774788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520774788">(May 27 2025 at 23:39)</a>:</h4>
<p><del>1 is Dispatch</del></p>



<a name="520774933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520774933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520774933">(May 27 2025 at 23:41)</a>:</h4>
<p>The dispatch type checking should be checking the type of the first arg, so desugaring to a method call is just extra work for later</p>



<a name="520775148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775148">(May 27 2025 at 23:44)</a>:</h4>
<p>wait</p>



<a name="520775205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775205">(May 27 2025 at 23:45)</a>:</h4>
<p>Okay, so <code>foo.bar()</code> doesn't just desugar to <code>bar(foo)</code> or <code>foo-&gt;bar()</code> since it really means <code>Foo.bar(foo)</code></p>



<a name="520775260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775260">(May 27 2025 at 23:46)</a>:</h4>
<p>Meaning that if I write <code>foo + bar</code>, that needs to turn into <code>Foo.add(foo, bar)</code></p>



<a name="520775413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775413">(May 27 2025 at 23:48)</a>:</h4>
<p>I think there's a benefit to desugaring, because the <code>canonicalize</code> stage of the compiler is cached and the <code>resolve_imports</code> stage is not</p>



<a name="520775451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775451">(May 27 2025 at 23:49)</a>:</h4>
<p>Literally any work that we can do before caching without having to read any files outside of the current file should be done in <code>can</code> (and maybe a future <code>solo_typecheck</code>)</p>



<a name="520775696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775696">(May 27 2025 at 23:52)</a>:</h4>
<p>A more complex caching mechanism was discussed at some point to allow for caching of work from later stages  (at least <code>check_types</code>) to recognize a tree of dependencies, AKA if <code>Foo.roc</code> imports <code>Bar.roc</code> then <code>Foo.roc</code> can be loaded so long as <code>Bar.roc</code> hasn't changed</p>



<a name="520775756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775756">(May 27 2025 at 23:53)</a>:</h4>
<p>Anyway, for now, I think desugaring should be done at the beginning of or during <code>canonicalize</code> because it will almost always require less work overall</p>



<a name="520775987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520775987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520775987">(May 27 2025 at 23:57)</a>:</h4>
<p>I dunno, I hear what you're saying Sam - but I'd like to try deferring it and see how it goes</p>



<a name="520776015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520776015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520776015">(May 27 2025 at 23:57)</a>:</h4>
<p>maybe I'm wrong in practice but I'd like to try it that way as a first pass</p>



<a name="520776104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520776104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520776104">(May 27 2025 at 23:58)</a>:</h4>
<p>We can definitely try it!</p>



<a name="520776152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520776152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520776152">(May 27 2025 at 23:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring/near/520774752">said</a>:</p>
<blockquote>
<p>it feels like Can is doing work that 90% of which COULD be done at parse time</p>
</blockquote>
<p>you mean as in resolving names based on scope?</p>



<a name="520776560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520776560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520776560">(May 28 2025 at 00:02)</a>:</h4>
<p>there's another piece we haven't gotten to, which is building a dependency graph between top level decls so we can sort them before type checking (which is very important for type checking correctness)</p>



<a name="520776787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520776787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520776787">(May 28 2025 at 00:05)</a>:</h4>
<p>I presume you could do that by notating <em>any</em> idents used in the body of a decl and seeing what they point to, not needing to maintain a graph within the decls</p>



<a name="520776920"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520776920" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520776920">(May 28 2025 at 00:06)</a>:</h4>
<p>I know you're more getting at the macro recipe of can, just throwing that out</p>



<a name="520776992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520776992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520776992">(May 28 2025 at 00:07)</a>:</h4>
<p>right, I just mean conceptually</p>



<a name="520777626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520777626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520777626">(May 28 2025 at 00:15)</a>:</h4>
<p>how do we solve for mutual recursion?</p>



<a name="520777714"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520777714" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520777714">(May 28 2025 at 00:16)</a>:</h4>
<p>i thought the solve their was just walking the top level decls collecting the idents, and then just assigning each one a type var</p>



<a name="520777738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520777738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520777738">(May 28 2025 at 00:16)</a>:</h4>
<p>and then walking them again to solve them</p>



<a name="520777989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520777989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520777989">(May 28 2025 at 00:19)</a>:</h4>
<p>and then you just have to have cycle checking for condition less mutual recursion(no base case) like</p>
<p>a = |x| b(x)<br>
b = |x| a(x)</p>



<a name="520778130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520778130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520778130">(May 28 2025 at 00:20)</a>:</h4>
<p>which is silly and diabolical if done earnestly</p>



<a name="520778217"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520778217" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520778217">(May 28 2025 at 00:21)</a>:</h4>
<p>You look for SCCs</p>



<a name="520778273"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520778273" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520778273">(May 28 2025 at 00:22)</a>:</h4>
<p>And think in terms of those, unless the SCC is size 1</p>



<a name="520778305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520778305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520778305">(May 28 2025 at 00:22)</a>:</h4>
<p>Have you seen how we handle those in the Rust code?</p>



<a name="520778720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520778720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520778720">(May 28 2025 at 00:27)</a>:</h4>
<p>I think recursion can be allowed if all the decls are functions, and pretty sure they are not allowed if they are all constants, not sure about a mix</p>



<a name="520782308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520782308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520782308">(May 28 2025 at 01:10)</a>:</h4>
<p>yep, exactly</p>



<a name="520783148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783148">(May 28 2025 at 01:18)</a>:</h4>
<p>ok, not familiar with the term SCC</p>



<a name="520783317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783317">(May 28 2025 at 01:20)</a>:</h4>
<p>you mean from graph theory?</p>



<a name="520783322"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783322" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783322">(May 28 2025 at 01:20)</a>:</h4>
<p>strongly connected component</p>



<a name="520783325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783325">(May 28 2025 at 01:20)</a>:</h4>
<p>yeah</p>



<a name="520783344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783344">(May 28 2025 at 01:20)</a>:</h4>
<p>oh ok</p>



<a name="520783380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783380">(May 28 2025 at 01:21)</a>:</h4>
<p>i think i've implemented these without knowing they existed</p>



<a name="520783419"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783419" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783419">(May 28 2025 at 01:21)</a>:</h4>
<p>basically you input all the "a depends on b" relationships and it outputs all the groups of cycles</p>



<a name="520783447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783447">(May 28 2025 at 01:21)</a>:</h4>
<p>if a group has a size of 1 then it's not involved in any cycles</p>



<a name="520783455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20desugaring/near/520783455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20desugaring.html#520783455">(May 28 2025 at 01:21)</a>:</h4>
<p>etc</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>host crash and stack overflow recovery · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html">host crash and stack overflow recovery</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="532323360"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532323360" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532323360">(Aug 01 2025 at 14:54)</a>:</h4>
<p>I want to write down some notes on how hosts should handle the roc program either performing a <code>crash</code> or stack overflowing. this is going to be kinda unstructured; I just want to get it down in one place and we can talk about whatever aspects of it <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="532323445"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532323445" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532323445">(Aug 01 2025 at 14:54)</a>:</h4>
<p>so wasm and non-wasm targets need totally different things, so let's start with Windows because it's the most straightforward</p>



<a name="532323620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532323620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532323620">(Aug 01 2025 at 14:55)</a>:</h4>
<p>outside wasm, the way stack overflows get detected is that the host decides how much stack space to reserve, and then "reserves" it by telling the OS to mark a page of memory just past that point as readonly</p>



<a name="532323671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532323671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532323671">(Aug 01 2025 at 14:55)</a>:</h4>
<p>e.g. if you want 2MB of stack space, you set the memory page right after the 2MB mark to be readonly</p>



<a name="532323785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532323785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532323785">(Aug 01 2025 at 14:56)</a>:</h4>
<p>the CPU is really fast and efficient at bumping the stack pointer, but it's also really dumb. it doesn't do any checking whatsoever about whether it has run out of stack space</p>



<a name="532323819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532323819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532323819">(Aug 01 2025 at 14:56)</a>:</h4>
<p>so what happens is that eventually it bumps its way into the readonly memory, causing a segfault</p>



<a name="532323985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532323985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532323985">(Aug 01 2025 at 14:57)</a>:</h4>
<p>(in contrast, heap allocation - which makes sure not to allocate into the 2MB of reserved space, or the readonly guard page, and which can explicitly do conditionals and give an OOM error if it has run out - does not need to cause a segfault on purpose like this)</p>



<a name="532324442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532324442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532324442">(Aug 01 2025 at 15:00)</a>:</h4>
<p>so, to recover from the stack overflow, there are a few things that need to happen:</p>
<ul>
<li><em>before</em> running the code that could stack overflow (this is true of both host code and roc code), the host needs to register a segfault handler function with the OS</li>
<li>the OS segfault handler function will get called when the segfault happens, and it will receive some info about what happened, including the memory address that segfaulted</li>
<li>the handler can then see if this address is inside the readonly guard page; if so, then this segfault must have been a stack overflow and we can proceed to handle the stack overflow</li>
</ul>



<a name="532325306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532325306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532325306">(Aug 01 2025 at 15:04)</a>:</h4>
<p>at this point, when the "handle stack overflow" logic is running, the system is in a weird state because:</p>
<ul>
<li>when you're inside a segfault handler function like this, there are certain OS operations you're not supposed to do (I'm actually not sure what they are, but I think a lot of syscalls?)</li>
<li>we just overflowed the stack a moment ago, which means we are extremely low on stack space - we might not even have any. if our segfault handler also overflows the stack, we're toast, so we ideally would be using so few variables etc. that everything happens in registers and our generated code doesn't even end up attempting to bump the stack pointer for the entire handler.</li>
<li>the Roc application function still has its entire stack in memory, and we need to get rid of it because the application has crashed and we want the stack to go back to where it was before the Roc function started executing</li>
<li>despite all this, we still want to report a nice stack trace to the end user</li>
</ul>



<a name="532325637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532325637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532325637">(Aug 01 2025 at 15:06)</a>:</h4>
<p>also, once we're done handling everything, we need to clean up all the resources and get back to a normal host state</p>



<a name="532326094"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532326094" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532326094">(Aug 01 2025 at 15:08)</a>:</h4>
<p>I mention this stack overflow case first, because:</p>
<ul>
<li>in theory we could have Roc's <code>crash</code> do a bunch of automatic fancy cleanup stuff for the host (e.g. making every Roc call return a <code>Result</code>), but even if we did that, the host would already need to do all this tricky stuff to handle stack overflows anyway</li>
<li>since handling stack overflows is strictly harder than handling the current design for <code>crash</code> (where we just call a host function that says "Roc crashed; do whatever you want to do to handle that right now!") it seems best to <em>not</em> attempt to automatically do fancy cleanup stuff, and instead just let the host reuse code for stack overflow handling and <code>crash</code> handling</li>
</ul>



<a name="532326228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532326228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532326228">(Aug 01 2025 at 15:09)</a>:</h4>
<p>ok so let's start with recovering and cleaning up, and get to showing a trace later</p>



<a name="532326674"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532326674" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532326674">(Aug 01 2025 at 15:11)</a>:</h4>
<p>the simplest way to recover from a stack overflow (and this works for <code>crash</code> too) is:</p>
<ul>
<li>before calling the Roc function, the host does a <code>setjmp</code> - which basically just copies all the current CPU registers, including the stack pointer, to some threadlocal memory</li>
<li>later, in either the segfault handler where we detected a stack overflow, or in the function we give the roc app to run when a <code>crash</code> occurs, we do a <code>longjmp</code> - which basically just takes that memory we stored earlier and puts everything back in the registers again</li>
<li>at this point, all the contents of memory are the same, but the stack is back where it was before, and the CPU happily continues executing from right after the original <code>setjmp</code></li>
</ul>



<a name="532326878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532326878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532326878">(Aug 01 2025 at 15:13)</a>:</h4>
<p>so we can use that to get execution back where we want it, but there's still the matter that the Roc program may have allocated heap memory or opened file handles, and this doesn't clean any of that up</p>



<a name="532326999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532326999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532326999">(Aug 01 2025 at 15:13)</a>:</h4>
<p>I think the best solution there is that the host should not share a single global allocator between itself and Roc, but rather provide a dedicated allocator just for the Roc program</p>



<a name="532327219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532327219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532327219">(Aug 01 2025 at 15:14)</a>:</h4>
<p>and if there are multiple Roc entrypoints running concurrently, they should each have their own allocators</p>



<a name="532327267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532327267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532327267">(Aug 01 2025 at 15:15)</a>:</h4>
<p>this way, if one of them crashes or stack overflows, the host can just reset that allocator and cleanup has been achieved</p>



<a name="532327372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532327372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532327372">(Aug 01 2025 at 15:15)</a>:</h4>
<p>separately, if it's doing file handle stuff, that should be tracked somewhere the host can access it, so that it can iterate through the open file handles and close them</p>



<a name="532327434"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532327434" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532327434">(Aug 01 2025 at 15:16)</a>:</h4>
<p>we can model all of this in <code>basic-cli</code> and <code>basic-webserver</code> so host authors can have a good example to follow</p>



<a name="532328300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532328300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532328300">(Aug 01 2025 at 15:21)</a>:</h4>
<p>ok, so at this point we have a way for the host to:</p>
<ul>
<li>detect stack overflows in the roc program</li>
<li>recover from them by restoring execution to the proper place</li>
<li>clean up memory and other resources the Roc program was using</li>
<li>do the same things for <code>crash</code></li>
</ul>



<a name="532328810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532328810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532328810">(Aug 01 2025 at 15:24)</a>:</h4>
<p>of note, an alternative to <code>setjmp</code>/<code>longjmp</code> is to do stack unwinding - e.g. <code>libunwind</code> (~100KB dependency) lets you avoid the <code>setjmp</code> up front (maybe like a dozen CPU instructions), but that seems not worth it to me considering <code>setjmp</code> and <code>longjmp</code> are much simpler</p>



<a name="532328831"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532328831" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532328831">(Aug 01 2025 at 15:24)</a>:</h4>
<p>ok so now the backtrace</p>



<a name="532328969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532328969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532328969">(Aug 01 2025 at 15:25)</a>:</h4>
<p>on Windows, there's a built-in API for getting backtraces - <a href="https://learn.microsoft.com/en-us/windows/win32/debug/capturestackbacktrace">https://learn.microsoft.com/en-us/windows/win32/debug/capturestackbacktrace</a></p>



<a name="532329142"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532329142" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532329142">(Aug 01 2025 at 15:26)</a>:</h4>
<p>however, it isn't aware of debuginfo, so it wouldn't give things like line numbers etc.</p>



<a name="532329485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532329485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532329485">(Aug 01 2025 at 15:27)</a>:</h4>
<p>however, there's a more advanced one that does get you debug info - <a href="https://learn.microsoft.com/en-us/windows/win32/api/dbghelp/nf-dbghelp-stackwalk64">https://learn.microsoft.com/en-us/windows/win32/api/dbghelp/nf-dbghelp-stackwalk64</a> - but to get that, the host has to dynamically link <code>dbghelp.dll</code> (which does ship with Windows, fortunately)</p>



<a name="532330470"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532330470" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532330470">(Aug 01 2025 at 15:33)</a>:</h4>
<p>unfortunately,  this is a pretty complex function that does use stack memory itself, and if we're in the middle of a stack overflow, it's possible that trying to walk the stack could result in  another stack overflow, at which point we're toast</p>



<a name="532332070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332070">(Aug 01 2025 at 15:41)</a>:</h4>
<p>so we need to be really really conservative in what we do</p>



<a name="532332371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332371">(Aug 01 2025 at 15:43)</a>:</h4>
<p>one thing that helps is that Windows automatically converts the guard page to be writable again (so, no longer a guard page) at which point we can grow our stack into it</p>



<a name="532332496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332496">(Aug 01 2025 at 15:44)</a>:</h4>
<p>so we get one more page (at least 4096B) of memory to work with, for just the stack walking and recording it somewhere else (most likely a threadlocal that we pre-reserved and can access after the longjmp to display the recorded stack trace to the end user in whatever way we like)</p>



<a name="532332583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332583">(Aug 01 2025 at 15:44)</a>:</h4>
<p>however, this does mean that if we don't want to "leak" guard pages, we need to manually change that page back to a guard page after the longjmp - which is doable, it's just something the host needs to do</p>



<a name="532332797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332797">(Aug 01 2025 at 15:46)</a>:</h4>
<p>one more note: the interpreter just does all this stuff itself and reports a stack overflow as a normal <code>crash</code></p>



<a name="532332818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332818">(Aug 01 2025 at 15:46)</a>:</h4>
<p>because it's managing its own "stack"</p>



<a name="532332891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332891">(Aug 01 2025 at 15:46)</a>:</h4>
<p>ok so that's Windows - we can recover from stack overflows and <code>crash</code>es, including showing the end user a backtrace</p>



<a name="532332913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332913">(Aug 01 2025 at 15:46)</a>:</h4>
<p>which includes debuginfo, so function names and line numbers etc.</p>



<a name="532332980"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532332980" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532332980">(Aug 01 2025 at 15:47)</a>:</h4>
<p>on UNIX, we can follow the same basic strategy but with less built-in behavior</p>



<a name="532333309"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333309" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333309">(Aug 01 2025 at 15:49)</a>:</h4>
<p>specifically:</p>
<ul>
<li>to get a backtrace with debuginfo, we need <code>libbacktrace</code> (adds ~50KB to the binary), which parses DWARF debuginfo.</li>
<li>the guard page isn't automatically switched to writable during the segfault handler, so we need to do that ourselves (and then set it back to being a guard page after the longjmp, just like we do on Windows)</li>
</ul>



<a name="532333545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333545">(Aug 01 2025 at 15:50)</a>:</h4>
<p>since the backtrace-obtaining functionality is completely different for interpreter vs optimized build, I think the compiled roc application should expose a <code>backtrace()</code> symbol the host can link and call, and it will have the same API regardless of whether we're interpreting or running an optimized build (the optimized build will use <code>libbacktrace</code>, which we'll need to bundle along with our builtins, and then the interpreter will do its own thing with its own stack memory)</p>



<a name="532333579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333579">(Aug 01 2025 at 15:51)</a>:</h4>
<p>ok so that's Windows and UNIX...now for wasm!</p>



<a name="532333615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333615">(Aug 01 2025 at 15:51)</a>:</h4>
<p>wasm is totally different from either of those</p>



<a name="532333699"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333699" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333699">(Aug 01 2025 at 15:51)</a>:</h4>
<p>the wasm binary is not allowed to look at its own bytes, so it can't do its own stack unwinding or generate its own backtrace</p>



<a name="532333791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333791">(Aug 01 2025 at 15:52)</a>:</h4>
<p>however, the things we need to happen can be done outside the wasm vm (so, in the browser that means JS can do it)</p>



<a name="532333859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333859">(Aug 01 2025 at 15:52)</a>:</h4>
<p>for simplicity I'll talk about the browser, but hopefully other wasm vms will have equivalent ways of doing these things</p>



<a name="532333946"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532333946" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532333946">(Aug 01 2025 at 15:53)</a>:</h4>
<p>when a stack overflow occurs in wasm, execution immediately halts and JS gets a runtime exception, which it can catch with <code>try</code>/ <code>catch</code></p>



<a name="532334127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532334127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532334127">(Aug 01 2025 at 15:54)</a>:</h4>
<p>that exception includes the backtrace info, and as long as the binary was built with source maps (which can be either included in the wasm binary itself or can be hosted separate from the binary and the browser can download it), JS can use the source maps to get line numbers etc.</p>



<a name="532334246"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532334246" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532334246">(Aug 01 2025 at 15:55)</a>:</h4>
<p>for <code>crash</code>, wasm can call out to an external JS function, and JS can inspect the current wasm stack while it's paused - and again can use source maps to get debuginfo</p>



<a name="532334299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532334299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532334299">(Aug 01 2025 at 15:55)</a>:</h4>
<p>JS can also just cancel the entire wasm process, which takes care of stack memory cleanup, execution, etc.</p>



<a name="532334490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532334490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532334490">(Aug 01 2025 at 15:56)</a>:</h4>
<p>for the interpreter inside the browser, it gets slightly trickier because we can't just be like "here is my <code>backtrace()</code> function and I'll give you what you want regardless of whether I'm an interpreter or an optimized build"</p>



<a name="532334547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532334547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532334547">(Aug 01 2025 at 15:56)</a>:</h4>
<p>because although the interpreter can offer that, the optimized build can't (because it can't see its own executable bytes like it can outside of wasm)</p>



<a name="532334708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532334708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532334708">(Aug 01 2025 at 15:57)</a>:</h4>
<p>so instead, basically I think what we need to do in wasm is make it so that when we call the "I crashed" host handler (in JS), if we're the interpreter, we automatically create a backtrace and pass it to JS, so JS can just use that</p>



<a name="532334837"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532334837" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532334837">(Aug 01 2025 at 15:58)</a>:</h4>
<p>but if we're an optimized build, we just pass <code>null</code>, and then JS in the host can check for that and see "oh, there's a <code>null</code> backtrace here, so that must mean I need to go inspect the currently-running wasm stack myself and build my own trace"</p>



<a name="532335845"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532335845" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532335845">(Aug 01 2025 at 16:04)</a>:</h4>
<p>for the stack overflow scenario it's actually more straightforward, because that's naturally a thrown exception with backtrace info in the exception, so in theory we can have the interpreter just handcraft one of those exceptions, except including all the backtrace info from the interpreter</p>



<a name="532335864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532335864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532335864">(Aug 01 2025 at 16:04)</a>:</h4>
<p>ok I think that's everything!</p>



<a name="532336263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532336263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532336263">(Aug 01 2025 at 16:06)</a>:</h4>
<p>I think the key here is having good examples of how to do all of that in <code>basic-cli</code>, <code>basic-webserver</code>, and wasm hosts too, so that other platform authors can treat everything I just described as just some general boilerplate stuff they set up and then backtraces for stack overflows and <code>crash</code> Just Work as if this were an interpreted language or a language with a VM, except without the VM overhead <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="532351122"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532351122" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532351122">(Aug 01 2025 at 17:38)</a>:</h4>
<p>Couple thoughts:</p>
<ol>
<li>We may want to consider abstracting stack overflow a _bit_, such that the host doesn't have to know about both the interpreter and the compiler.</li>
<li>We should use a frame pointer, which (as long as all code on the stack is Roc code) makes backtraces relatively trivial to compute.</li>
</ol>



<a name="532353081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532353081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532353081">(Aug 01 2025 at 17:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532351122">said</a>:</p>
<blockquote>
<ol start="2">
<li>We should use a frame pointer, which (as long as all code on the stack is Roc code) makes backtraces relatively trivial to compute.</li>
</ol>
</blockquote>
<p>the problem with that is that then inlined functions disappear completely, whereas e.g. DWARF has metadata about "here's the function that was inlined here" so you can get a more useful stack trace even if things were inlined. also we want the DWARF metadata anyway for line numbers etc.</p>
<p>I haven't actually implemented a stack walker with or without libbactrace, but from what I've read, if you want to get the DWARF metadata anyway, that's the whole hard part - and at that point you might as well rely on that as the source of truth instead of the frame pointer, even if you have one</p>



<a name="532353192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532353192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532353192">(Aug 01 2025 at 17:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532351122">said</a>:</p>
<blockquote>
<ol>
<li>We may want to consider abstracting stack overflow a _bit_, such that the host doesn't have to know about both the interpreter and the compiler.</li>
</ol>
</blockquote>
<p>in theory I'd like to do this, but it doesn't seem possible for the <code>crash</code> scenario in wasm (at least based on my research) to avoid the host having to do something different in one scenario vs the other one</p>



<a name="532353332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532353332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532353332">(Aug 01 2025 at 17:53)</a>:</h4>
<p>and outside of wasm, I think the stack overflow <em>handler</em> has to be installed by the host, because Roc functions are (and ought to be) stateless, plus the host might have other signal handlers that could conflict with ours if we installed it ourselves</p>



<a name="532353407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532353407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532353407">(Aug 01 2025 at 17:54)</a>:</h4>
<p>and the interpreter can just do a normal <code>crash</code> for signalling that a stack overflow has happened</p>



<a name="532353513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532353513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532353513">(Aug 01 2025 at 17:54)</a>:</h4>
<p>so from that perspective, the only thing I think we could really abstract is <code>backtrace()</code> - but honestly I actually think I'd rather do the same thing we do with wasm there, where we say "here's a backtrace if I'm an interpreter, but otherwise I just give you <code>null</code> and you need to go walk the stack yourself"</p>



<a name="532353610"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532353610" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532353610">(Aug 01 2025 at 17:55)</a>:</h4>
<p>because that way we don't have to staple a 50KB <code>libbacktrace</code>static dependency to every optimized Roc app, when the host might already have that dependency themselves and just be able to use the one they already have</p>



<a name="532367466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532367466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532367466">(Aug 01 2025 at 19:34)</a>:</h4>
<p>Hmm, tbh I wouldn't optimize for making backtraces perfect in the presence of inlining and optimization.</p>



<a name="532367508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532367508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532367508">(Aug 01 2025 at 19:35)</a>:</h4>
<p>There never going to be perfect anyway</p>



<a name="532367551"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532367551" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532367551">(Aug 01 2025 at 19:35)</a>:</h4>
<p>I'd just keep track of which functions have other functions inlined into them, and make a note of that in the backtrace</p>



<a name="532367595"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532367595" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532367595">(Aug 01 2025 at 19:36)</a>:</h4>
<p>e.g.</p>
<div class="codehilite"><pre><span></span><code>foo
bar (*contains inlined functions)
baz
</code></pre></div>



<a name="532368081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532368081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532368081">(Aug 01 2025 at 19:39)</a>:</h4>
<p>In other words, what I'd do is:</p>
<ol>
<li>guarantee you can always get some kind of backtrace via frame pointers. The runtime code is pretty minimal. You may or may not have symbols, and that's fine. Image base offset, image UUID, and return addresses are sufficient to fully reconstruct the stack more properly later (e.g. in a tool we ship with the roc binary, or cobbling together other open source tools)</li>
<li>allow the host to link libbacktrace if it wants more full functionality</li>
</ol>



<a name="532369599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532369599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532369599">(Aug 01 2025 at 19:50)</a>:</h4>
<p>ah that's interesting</p>



<a name="532369710"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532369710" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532369710">(Aug 01 2025 at 19:51)</a>:</h4>
<p>so basically give up a slight amount of perf (reserving 1 register for the duration of the roc call) for the benefit of hosts having the option to do simple backtrace without line numbers on optimized builds</p>



<a name="532369771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532369771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532369771">(Aug 01 2025 at 19:52)</a>:</h4>
<p>I could also see that being a <code>platform</code> module knob maybe</p>



<a name="532369805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532369805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532369805">(Aug 01 2025 at 19:52)</a>:</h4>
<p>like they can request a frame pointer or not (if they're not gonna use it anyway, might as well take the extra perf improvement)</p>



<a name="532372637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532372637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532372637">(Aug 01 2025 at 20:15)</a>:</h4>
<p><a href="https://www.brendangregg.com/blog/2024-03-17/the-return-of-the-frame-pointers.html?utm_source=chatgpt.com">https://www.brendangregg.com/blog/2024-03-17/the-return-of-the-frame-pointers.html?utm_source=chatgpt.com</a></p>



<a name="532372686"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532372686" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532372686">(Aug 01 2025 at 20:15)</a>:</h4>
<p>lol, utm outing me <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="532372873"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532372873" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532372873">(Aug 01 2025 at 20:16)</a>:</h4>
<p>I would actually say that unless we find a strong case that really really needs that register, we should not even make it an option</p>



<a name="532372997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532372997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532372997">(Aug 01 2025 at 20:18)</a>:</h4>
<p>Note that line numbers can work just fine with frame pointer backtraces</p>



<a name="532373030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532373030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532373030">(Aug 01 2025 at 20:18)</a>:</h4>
<p>All you need is <code>addr2line</code> at that point</p>



<a name="532373054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532373054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532373054">(Aug 01 2025 at 20:18)</a>:</h4>
<p>(either the tool itself, or functionality thereof)</p>



<a name="532373701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532373701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532373701">(Aug 01 2025 at 20:23)</a>:</h4>
<p>TIL about <code>addr2line</code> - but apparently it's basically the same thing as <code>libbacktrace</code> except it's designed to be invoked in a separate process on a file that's a memory dump of the frame?</p>



<a name="532376018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532376018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532376018">(Aug 01 2025 at 20:42)</a>:</h4>
<p>Yep!</p>



<a name="532376050"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532376050" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532376050">(Aug 01 2025 at 20:42)</a>:</h4>
<p>And, most importantly IMO, it doesn't require linking, and can even be done after the fact</p>



<a name="532376081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532376081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532376081">(Aug 01 2025 at 20:42)</a>:</h4>
<p>(doesn't require symbols being embedded in the binary, or even being on the machine where the crash happened)</p>



<a name="532381323"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532381323" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532381323">(Aug 01 2025 at 21:27)</a>:</h4>
<p>hm, but wouldn't the best UX normally be getting the stack trace immediately?</p>



<a name="532381436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532381436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532381436">(Aug 01 2025 at 21:28)</a>:</h4>
<p>I mean if all we have to do is enable stack frames to get it, then sure, might as well, but wouldn't host authors pretty much always want to use <code>libbacktrace</code> anyway for runtime stack traces? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="532382720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532382720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532382720">(Aug 01 2025 at 21:41)</a>:</h4>
<p>I don't think it is safe to longjmp from a segfault handler, but you can modify the return address to go to a temp function and then longjmp.</p>
<p>Also, of note, you want to leave segfault handlers as fast as possible. So all of the stuff discussed here should be deferred and outside of the segfault handler.</p>
<blockquote>
<p>and if there are multiple Roc entrypoints running concurrently, they should each have their own allocators</p>
</blockquote>
<p>I wonder how expensive that would be... A lot of perf is gained from things like tcmalloc (thread cache malloc) with its smart reuse of memory.</p>
<blockquote>
<p>if it's doing file handle stuff, that should be tracked somewhere the host can access it, so that it can iterate through the open file handles and close them</p>
</blockquote>
<p>Or we implement standard exceptions in roc. Use debug info to walk the stack and run destructors on the roc values. Stack walking is slower when there is an exception but greatly reduces the cost when no exceptions happen.</p>
<blockquote>
<p>of note, an alternative to <code>setjmp</code>/<code>longjmp</code> is to do stack unwinding - e.g. <code>libunwind</code> (~100KB dependency) lets you avoid the <code>setjmp</code> up front (maybe like a dozen CPU instructions), but that seems not worth it to me considering <code>setjmp</code> and <code>longjmp</code> are much simpler</p>
</blockquote>
<p>I'm not sold due to all the extra cost of the host needing to manually track every resource that roc uses....</p>
<blockquote>
<p>one more note: the interpreter just does all this stuff itself and reports a stack overflow as a normal <code>crash</code></p>
</blockquote>
<p>Yeah, interpreter should be super simple here. And should be able to give nicer errors.</p>
<blockquote>
<p>since the backtrace-obtaining functionality is completely different for interpreter vs optimized build, I think the compiled roc application should expose a <code>backtrace()</code> symbol the host can link and call, and it will have the same API regardless of whether we're interpreting or running an optimized build (the optimized build will use <code>libbacktrace</code>, which we'll need to bundle along with our builtins, and then the interpreter will do its own thing with its own stack memory)</p>
</blockquote>
<p>If compiled binaries are just for optimized builds, why not just not have backtraces? It is really common to leave out debug info in release builds anyway. Leave that for the interpreter.</p>



<a name="532382900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532382900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532382900">(Aug 01 2025 at 21:43)</a>:</h4>
<blockquote>
<p>guarantee you can always get some kind of backtrace via frame pointers</p>
</blockquote>
<p>Frame pointer is a waste in my opinion (hurts perf for little gain most of the time, should be optional and not default). Just don't have debug info in release builds and use the interpreter which is better suited for this anyway. Give a super crude trace for anything optimized</p>



<a name="532387993"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532387993" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532387993">(Aug 01 2025 at 22:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> [said](<a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recov">https://roc.zulipchat.com/#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recov</a></p>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532382720">said</a>:</p>
<blockquote>
<p>I don't think it is safe to longjmp from a segfault handler, but you can modify the return address to go to a temp function and then longjmp.</p>
<p>Also, of note, you want to leave segfault handlers as fast as possible. So all of the stuff discussed here should be deferred and outside of the segfault handler.</p>
</blockquote>
<p>hm, how would this work for purposes of getting a backtrace? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> </p>
<p>modify return address, go to temp function, then do backtrace, then longjmp?</p>
<p>I assume by default <code>libbacktrace</code> would not work post-longjmp, since the backtrace code itself would be potentially stomping over the previous stack memory <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="532388142"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532388142" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532388142">(Aug 01 2025 at 22:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532382900">said</a>:</p>
<blockquote>
<blockquote>
<p>guarantee you can always get some kind of backtrace via frame pointers</p>
</blockquote>
<p>Frame pointer is a waste in my opinion (hurts perf for little gain most of the time, should be optional and not default). Just don't have debug info in release builds and use the interpreter which is better suited for this anyway. Give a super crude trace for anything optimized</p>
</blockquote>
<p>I think that would be fine for some use cases but pretty bad for others - e.g. if my web server <code>crash</code>es, I really want as real backtrace in my logs as I can get without sacrificing optimizations <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="532388493"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532388493" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532388493">(Aug 01 2025 at 22:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532382720">said</a>:</p>
<blockquote>
<blockquote>
<p>if it's doing file handle stuff, that should be tracked somewhere the host can access it, so that it can iterate through the open file handles and close them</p>
</blockquote>
<p>Or we implement standard exceptions in roc. Use debug info to walk the stack and run destructors on the roc values. Stack walking is slower when there is an exception but greatly reduces the cost when no exceptions happen.</p>
</blockquote>
<p>I dunno, I know we've talked about this a bunch over the years, but I just keep coming back to:</p>
<ul>
<li>the described above is way, way faster than exceptions if you do actually need to clean up</li>
<li>it's also way simpler to just give Roc stuff its own allocator</li>
<li>the host might want to decouple those anyway because a different allocator might be better for Roc's allocation patterns compared to the rest of the host</li>
<li>it's astronomically simpler for the compiler</li>
</ul>
<p>it just feels like exceptions would be a way to make host authors do a bit less work for the tradeoff of having worse perf when there's an exception and a ton of added complexity</p>



<a name="532388622"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532388622" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532388622">(Aug 01 2025 at 22:40)</a>:</h4>
<p>btw I don't actually think cleaning up file handles would be much work for the host</p>



<a name="532388788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532388788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532388788">(Aug 01 2025 at 22:42)</a>:</h4>
<p>they already need to be tracked somewhere for the whole "refcounted fd via <code>roc_alloc</code> that cleans itself up" design, so even in the worst case scenario where you have a bunch of roc functions running at once and they're passing the handles between one another, even then all you have to do is just make sure to keep a running list of which fds a given roc function is executing, and you just go through and decref those if it crashes.</p>



<a name="532388852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532388852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532388852">(Aug 01 2025 at 22:43)</a>:</h4>
<p>feels like stack overflow handling is the big burden here, and I don't know of a way to make that burden easier without sacrificing flexibility (e.g. host can have their own signal handlers without worrying about roc installing its own that conflict with the host's) and/or some huge perf penalty like introducing a vm or something</p>



<a name="532395594"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532395594" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532395594">(Aug 02 2025 at 00:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532387993">said</a>:</p>
<blockquote>
<p>hm, how would this work for purposes of getting a backtrace? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> </p>
<p>modify return address, go to temp function, then do backtrace, then longjmp?</p>
<p>I assume by default <code>libbacktrace</code> would not work post-longjmp, since the backtrace code itself would be potentially stomping over the previous stack memory <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>Yeah, I think something like that. Savinging the old stack address when you do so </p>
<p>Maybe all the ceremony isn't required but I remember seeing something like this in go when dealing with stack swapping (which happens on a signal from a timer if a go routine runs for top long)</p>



<a name="532395832"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532395832" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532395832">(Aug 02 2025 at 00:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532388622">said</a>:</p>
<blockquote>
<p>btw I don't actually think cleaning up file handles would be much work for the host</p>
</blockquote>
<p>No, I assume the memory allocator cleanup would be the bigger hassle (and having state per thread). Specifically if you just want a gpa and not arenas</p>



<a name="532396010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532396010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532396010">(Aug 02 2025 at 00:13)</a>:</h4>
<blockquote>
<p>it just feels like exceptions would be a way to make host authors do a bit less work for the tradeoff of having worse perf when there's an exception and a ton of added complexity</p>
</blockquote>
<p>I mean I would hope exceptions are truly exceptional and roc rarely crashes in production, but I guess that may vary a lot by use case.</p>



<a name="532396194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532396194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532396194">(Aug 02 2025 at 00:15)</a>:</h4>
<p>And for backrraces in release builds, it definitely is true that having full dwarf info and backrraces from debug info is the most friendly.</p>



<a name="532397393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532397393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532397393">(Aug 02 2025 at 00:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532395832">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532388622">said</a>:</p>
<blockquote>
<p>btw I don't actually think cleaning up file handles would be much work for the host</p>
</blockquote>
<p>No, I assume the memory allocator cleanup would be the bigger hassle (and having state per thread). Specifically if you just want a gpa and not arenas</p>
</blockquote>
<p>hm, why would that be hard? seems like e.g. mimalloc, jemalloc, snmalloc all have a concept of making an allocator instance</p>



<a name="532399152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399152">(Aug 02 2025 at 00:58)</a>:</h4>
<p>I don't think you actually want a new allocator per coroutine</p>



<a name="532399235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399235">(Aug 02 2025 at 00:59)</a>:</h4>
<p>That could be hundreds of thousands of allocator instances in a webserver.</p>



<a name="532399302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399302">(Aug 02 2025 at 01:00)</a>:</h4>
<p>not per coroutine, per roc entrypoint</p>



<a name="532399312"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399312" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399312">(Aug 02 2025 at 01:00)</a>:</h4>
<p>so per request handler</p>



<a name="532399337"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399337" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399337">(Aug 02 2025 at 01:00)</a>:</h4>
<p>Yeah, that is per coroutine. Each coroutine would be running a roc request</p>



<a name="532399488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399488">(Aug 02 2025 at 01:02)</a>:</h4>
<p>hm, why would that be bad? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="532399520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399520">(Aug 02 2025 at 01:02)</a>:</h4>
<p>having a separate heap for each of them</p>



<a name="532399532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399532">(Aug 02 2025 at 01:02)</a>:</h4>
<p>e.g. seems to work great for Erlang <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="532399547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399547">(Aug 02 2025 at 01:03)</a>:</h4>
<p>Maybe it wouldn't be, but it would be a lot more overhead than what is normal.</p>



<a name="532399599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399599">(Aug 02 2025 at 01:03)</a>:</h4>
<p>Cause they won't share pages for example. So each will end up claim some number of pages even if very little memory is used by roc.</p>



<a name="532399828"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399828" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399828">(Aug 02 2025 at 01:06)</a>:</h4>
<p>yeah that's fair</p>



<a name="532399836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399836">(Aug 02 2025 at 01:06)</a>:</h4>
<p>I mean we can try it out and see how it does</p>



<a name="532399887"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532399887" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532399887">(Aug 02 2025 at 01:07)</a>:</h4>
<p>can also try that out alongside arenas per request</p>



<a name="532400011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532400011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532400011">(Aug 02 2025 at 01:09)</a>:</h4>
<p>I mean, to be clear, Folkert and I spent a ton of hours trying to get C++ style exceptions working without a libc++ dependency, everyone I asked about it said what we were trying to do was a huge mistake, and scrapping it really made things a lot simpler - so I'm not saying we could never do it, just that I think the downside is very serious, so the upside really needs to justify it <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="532400165"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532400165" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532400165">(Aug 02 2025 at 01:11)</a>:</h4>
<p>Yeah, totally fair around exceptions.</p>



<a name="532400659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532400659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532400659">(Aug 02 2025 at 01:18)</a>:</h4>
<p>Also, to be fair, most languages just don't recover from stack overflows. Like no attempt is made at all</p>



<a name="532400669"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532400669" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532400669">(Aug 02 2025 at 01:18)</a>:</h4>
<p>Same as OOMs</p>



<a name="532400678"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532400678" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532400678">(Aug 02 2025 at 01:18)</a>:</h4>
<p>Just classes of bugs that are accepted as fatal generally</p>



<a name="532400748"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532400748" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532400748">(Aug 02 2025 at 01:19)</a>:</h4>
<p>But I guess you still need some solution to calls to crash....so <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span>, may need this kind of heavy handed solution.</p>



<a name="532400951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532400951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532400951">(Aug 02 2025 at 01:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery/near/532400659">said</a>:</p>
<blockquote>
<p>Also, to be fair, most languages just don't recover from stack overflows. Like no attempt is made at all</p>
</blockquote>
<p>that's true of like C and C++ and Rust, sure, but not the garbage collected languages we're competing directly with</p>



<a name="532401024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401024">(Aug 02 2025 at 01:23)</a>:</h4>
<p>like if you hit a stack overflow in Java, C#, JavaScript, Ruby, Python, they all definitely let you gracefully recover - and normally they translate it to a normal exception</p>



<a name="532401031"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401031" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401031">(Aug 02 2025 at 01:23)</a>:</h4>
<p>I don't know about Go but given its approach to stacks I assume so too</p>



<a name="532401044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401044">(Aug 02 2025 at 01:23)</a>:</h4>
<p>like a whole webserver going down because one request handler stack overflowed would be a deal-breaker I think</p>



<a name="532401064"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401064" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401064">(Aug 02 2025 at 01:24)</a>:</h4>
<p>and if we solve it for hosts in that use case, then we have a solution for all hosts <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="532401692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401692">(Aug 02 2025 at 01:30)</a>:</h4>
<blockquote>
<p>I don't know about Go but given its approach to stacks I assume so too</p>
</blockquote>
<p>Go doesn't have stack overflows. Just OOMs. Stack will keep growing until OOM. At least that is my recollection</p>



<a name="532401728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401728">(Aug 02 2025 at 01:31)</a>:</h4>
<p>ahh right</p>



<a name="532401729"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401729" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401729">(Aug 02 2025 at 01:31)</a>:</h4>
<p>Also, it might just be the case that we have to hack something like mimalloc or tcmalloc to instead of being thread local, being coroutine local. That may work to avoid the overhead, but give good cleanup.</p>



<a name="532401752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/host%20crash%20and%20stack%20overflow%20recovery/near/532401752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/host.20crash.20and.20stack.20overflow.20recovery.html#532401752">(Aug 02 2025 at 01:31)</a>:</h4>
<p>ooh interesting!</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
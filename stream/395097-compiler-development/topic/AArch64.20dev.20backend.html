<html>
<head><meta charset="utf-8"><title>AArch64 dev backend · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html">AArch64 dev backend</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="394897321"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/394897321" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#394897321">(Oct 04 2023 at 18:41)</a>:</h4>
<p>Folkert introduced me to the AArch backend work. Last night, after about 5 hours of staring at Assembly in <code>gdb</code>, I found the two-character change I needed to fix 114 tests <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> </p>
<p><a href="https://github.com/roc-lang/roc/pull/5886">https://github.com/roc-lang/roc/pull/5886</a></p>



<a name="394897511"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/394897511" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#394897511">(Oct 04 2023 at 18:42)</a>:</h4>
<p>It was actually a 3-lines change originally, but today Folkert mentioned I could simplify it</p>



<a name="394907808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/394907808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#394907808">(Oct 04 2023 at 19:56)</a>:</h4>
<p>Nice work finding that.</p>



<a name="395486745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395486745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395486745">(Oct 08 2023 at 04:07)</a>:</h4>
<p>Down to 36 test failures. We're getting close <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> </p>
<p><a href="https://github.com/roc-lang/roc/pull/5896">https://github.com/roc-lang/roc/pull/5896</a></p>



<a name="395487262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395487262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395487262">(Oct 08 2023 at 04:14)</a>:</h4>
<p>So excited to use this. Will be a nice speedup for silicon macs! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="395504706"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395504706" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395504706">(Oct 08 2023 at 07:46)</a>:</h4>
<p>a good number of them should be tests that should panic. I'm working on the setjmp/longjmp logic that we need for that</p>



<a name="395504721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395504721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395504721">(Oct 08 2023 at 07:46)</a>:</h4>
<p>then it's the long tail of subtle segfaults, probably</p>



<a name="395536430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395536430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395536430">(Oct 08 2023 at 12:16)</a>:</h4>
<p>we got it down to </p>
<div class="codehilite"><pre><span></span><code>Summary [ 506.665s] 901 tests run: 870 passed (2 slow), 31 failed, 7 skipped
</code></pre></div>



<a name="395574962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395574962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395574962">(Oct 08 2023 at 20:45)</a>:</h4>
<p>I'm down to one failing test on the pi. it seems related to some other tests that still fail on the M2. I've nailed it down to</p>
<div class="codehilite"><pre><span></span><code>test gen_list::list_map2_different_lengths has been running for over 60 seconds
==56630==
==56630== Process terminating with default action of signal 11 (SIGSEGV)
==56630==  Bad permissions for mapped region at address 0x4D17000
==56630==    at 0x7B5FE7C: str.RocStr.reallocateFresh (in /tmp/.tmpqbDNId/app.so.1.0)
</code></pre></div>



<a name="395577319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395577319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395577319">(Oct 08 2023 at 21:27)</a>:</h4>
<p>it's very inconsistent</p>
<div class="codehilite"><pre><span></span><code>==59022== Invalid write of size 8
==59022==    at 0x7B48494: #UserApp_main_2777513159257922988 (in /tmp/.tmpBdWYSq/app.so.1.0)
==59022==  Address 0x30 is not stack&#39;d, malloc&#39;d or (recently) free&#39;d
==59022==
==59022==
==59022== Process terminating with default action of signal 11 (SIGSEGV)
==59022==  Access not within mapped region at address 0x30
==59022==    at 0x7B48494: #UserApp_main_2777513159257922988 (in /tmp/.tmpBdWYSq/app.so.1.0)
</code></pre></div>



<a name="395579030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395579030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395579030">(Oct 08 2023 at 21:57)</a>:</h4>
<p>allright, well it's late so I should stop but I got this down to</p>
<div class="codehilite"><pre><span></span><code>        // Run both with and without lazy literal optimization.
        {
            assert_evals_to!($src, $expected, $ty, $transform, $leak, false);
        }
        {
            assert_evals_to!($src, $expected, $ty, $transform, $leak, true);
        }
</code></pre></div>
<p>the top one works, the bottom one does not. I suspect it's (big?) string constants? <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> any ideas here? </p>
<p>also <span class="user-mention" data-user-id="515757">@Luke Boswell</span> this just looks a lot like the windows issues too</p>



<a name="395579253"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395579253" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395579253">(Oct 08 2023 at 22:01)</a>:</h4>
<p>Nice work, I can have a look later and see if I can find anything.</p>



<a name="395579651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395579651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395579651">(Oct 08 2023 at 22:08)</a>:</h4>
<p>so what is happening here is that we write the end of a string "ggg" into memory, then write its total length 28 into memory, and then copy it to some other place. The problem is that the x16 register contains NULL, so moving data there obviously fails. </p>
<div class="codehilite"><pre><span></span><code>   0x7ff78a8468 &lt;#UserApp_main_2777513159257922988+408&gt;    mov     x17, #0x67                      // #103
   0x7ff78a846c &lt;#UserApp_main_2777513159257922988+412&gt;    sturb   w17, [x8, #25]
   0x7ff78a8470 &lt;#UserApp_main_2777513159257922988+416&gt;    mov     x17, #0x67                      // #103
   0x7ff78a8474 &lt;#UserApp_main_2777513159257922988+420&gt;    sturb   w17, [x8, #26]
   0x7ff78a8478 &lt;#UserApp_main_2777513159257922988+424&gt;    mov     x17, #0x67                      // #103
   0x7ff78a847c &lt;#UserApp_main_2777513159257922988+428&gt;    sturb   w17, [x8, #27]
   0x7ff78a8480 &lt;#UserApp_main_2777513159257922988+432&gt;    stur    x8, [x29, #-104]
   0x7ff78a8484 &lt;#UserApp_main_2777513159257922988+436&gt;    mov     x17, #0x1c                      // #28
   0x7ff78a8488 &lt;#UserApp_main_2777513159257922988+440&gt;    stur    x17, [x29, #-96]
   0x7ff78a848c &lt;#UserApp_main_2777513159257922988+444&gt;    stur    x17, [x29, #-88]
   0x7ff78a8490 &lt;#UserApp_main_2777513159257922988+448&gt;    ldur    x8, [x29, #-104]
  &gt;0x7ff78a8494 &lt;#UserApp_main_2777513159257922988+452&gt;    stur    x8, [x16, #48]
   0x7ff78a8498 &lt;#UserApp_main_2777513159257922988+456&gt;    ldur    x8, [x29, #-96]
   0x7ff78a849c &lt;#UserApp_main_2777513159257922988+460&gt;    stur    x8, [x16, #56]
   0x7ff78a84a0 &lt;#UserApp_main_2777513159257922988+464&gt;    ldur    x8, [x29, #-88]
   0x7ff78a84a4 &lt;#UserApp_main_2777513159257922988+468&gt;    stur    x8, [x16, #64]
   0x7ff78a84a8 &lt;#UserApp_main_2777513159257922988+472&gt;    stur    x16, [x29, #-128]
</code></pre></div>
<p>this could be a general register allocation bug, or maybe it's something specific to the literals</p>



<a name="395699169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395699169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395699169">(Oct 09 2023 at 13:25)</a>:</h4>
<p>got it (2 bugs actuallly), so now</p>
<div class="codehilite"><pre><span></span><code>------------
     Summary [ 816.378s] 902 tests run: 902 passed (1 slow), 7 skipped
</code></pre></div>
<p>it works on my machine!</p>



<a name="395707461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395707461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395707461">(Oct 09 2023 at 14:08)</a>:</h4>
<p>wooooo!!!</p>



<a name="395707505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395707505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395707505">(Oct 09 2023 at 14:08)</a>:</h4>
<p>does that mean it can be activated for the repl? <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span></p>



<a name="395707562"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395707562" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395707562">(Oct 09 2023 at 14:08)</a>:</h4>
<p>(on aarch64)</p>



<a name="395715843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395715843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395715843">(Oct 09 2023 at 14:49)</a>:</h4>
<p>almost? this fails on CI</p>
<div class="codehilite"><pre><span></span><code>------------
     Summary [ 142.098s] 314 tests run: 313 passed, 1 failed, 595 skipped
     SIGABRT [   1.484s] test_gen::test_gen gen_tags::recursive_tag_id_in_allocation_eq
error: test run failed
</code></pre></div>
<p>but it works on the pi so needs some debugging on an M1/M2 still I think</p>



<a name="395720438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395720438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395720438">(Oct 09 2023 at 15:12)</a>:</h4>
<p>nvm it does trigger these valgrind warnings</p>
<div class="codehilite"><pre><span></span><code>test gen_tags::recursive_tag_id_in_allocation_eq has been running for over 60 seconds
==73198== Thread 2 gen_tags::recur:
==73198== Invalid write of size 8
==73198==    at 0x7747ED0: #UserApp_x_8352987475006511248 (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==  Address 0x69cb0a0 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E8EB: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==
==73198== Invalid read of size 1
==73198==    at 0x7748278: #UserApp_#help0_Eq_InLayout(25)_1 (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==  Address 0x69cb0a0 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E8EB: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==
==73198== Invalid read of size 1
==73198==    at 0x774827C: #UserApp_#help0_Eq_InLayout(25)_1 (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==  Address 0x69d63a0 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E8EB: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==
==73198== Invalid read of size 1
==73198==    at 0x77484A4: #UserApp_#help1_Dec_InLayout(25)_1 (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==  Address 0x69d63a0 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E8EB: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==
==73198== Invalid write of size 8
==73198==    at 0x77481F0: #UserApp_y_8352987475006511248 (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==  Address 0x6a10b60 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E8EB: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpuIFUPW/app.so.1.0)
==73198==


==73198== Invalid read of size 1
==73198==    at 0x7748268: #UserApp_#help0_Eq_InLayout(25)_1 (in /tmp/.tmpU2tUPy/app.so.1.0)
==73198==  Address 0x505b090 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E91B: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpU2tUPy/app.so.1.0)
==73198==
==73198== Invalid read of size 1
==73198==    at 0x774826C: #UserApp_#help0_Eq_InLayout(25)_1 (in /tmp/.tmpU2tUPy/app.so.1.0)
==73198==  Address 0x50c8170 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E91B: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpU2tUPy/app.so.1.0)
==73198==
==73198== Invalid read of size 1
==73198==    at 0x77484D4: #UserApp_#help1_Dec_InLayout(25)_1 (in /tmp/.tmpU2tUPy/app.so.1.0)
==73198==  Address 0x50c8170 is 0 bytes after a block of size 16 alloc&#39;d
==73198==    at 0x4849E4C: malloc (vg_replace_malloc.c:307)
==73198==    by 0x775E91B: roc_builtins.utils.allocate_with_refcount (in /tmp/.tmpU2tUPy/app.so.1.0)
==73198==
</code></pre></div>



<a name="395734102"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395734102" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395734102">(Oct 09 2023 at 16:35)</a>:</h4>
<p>fixed it (turns out it was an issue on x86 too). I expect <a href="https://github.com/roc-lang/roc/pull/5839">https://github.com/roc-lang/roc/pull/5839</a> to pass now</p>



<a name="395736209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395736209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395736209">(Oct 09 2023 at 16:50)</a>:</h4>
<p>also I can run the repl on the pi no problem, which based on the source code will use the dev backend already</p>
<div class="codehilite"><pre><span></span><code>    #[cfg(not(target_os = &quot;linux&quot;))]
    let (lib, main_fn_name, subs, layout_interner) =
        mono_module_to_dylib_llvm(&amp;arena, target, loaded, opt_level)
            .expect(&quot;we produce a valid Dylib&quot;);

    #[cfg(target_os = &quot;linux&quot;)]
    let (lib, main_fn_name, subs, layout_interner) =
        mono_module_to_dylib_asm(&amp;arena, target, loaded, opt_level)
            .expect(&quot;we produce a valid Dylib&quot;);
</code></pre></div>



<a name="395736257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395736257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395736257">(Oct 09 2023 at 16:51)</a>:</h4>
<p>so someone on an M1/M2 can just try that I guess</p>



<a name="395740376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395740376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395740376">(Oct 09 2023 at 17:25)</a>:</h4>
<p>Yeah, works on m1</p>



<a name="395742590"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395742590" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395742590">(Oct 09 2023 at 17:45)</a>:</h4>
<p>The REPL running on AArch64 dev backend (M1)! <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>  </p>
<p><a href="/user_uploads/22008/UZ3b8YT_u12QU_etS_Vm8S1J/CleanShot-2023-10-09-at-14.44.472x.png">CleanShot-2023-10-09-at-14.44.472x.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/UZ3b8YT_u12QU_etS_Vm8S1J/CleanShot-2023-10-09-at-14.44.472x.png" title="CleanShot-2023-10-09-at-14.44.472x.png"><img src="/user_uploads/22008/UZ3b8YT_u12QU_etS_Vm8S1J/CleanShot-2023-10-09-at-14.44.472x.png"></a></div>



<a name="395745293"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395745293" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395745293">(Oct 09 2023 at 18:12)</a>:</h4>
<p>ci passed on the PR now</p>



<a name="395757973"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395757973" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395757973">(Oct 09 2023 at 20:15)</a>:</h4>
<p>With my M2 mac on <code>beed1e3d6ea093f3cbc6281b04c655449ff88109</code> I get the following for <code>cargo nextest-gen-dev --no-fail-fast</code></p>
<div class="codehilite"><pre><span></span><code>Summary [ 574.116s] 902 tests run: 900 passed (2 slow), 2 failed, 7 skipped
        FAIL [   0.164s] test_gen::test_gen gen_list::list_ends_with_empty
        FAIL [   0.163s] test_gen::test_gen gen_list::list_starts_with_empty
</code></pre></div>
<p>So close !! <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="395758141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395758141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395758141">(Oct 09 2023 at 20:17)</a>:</h4>
<p><del>Actually... this might be a nix issue on my part, I'll re-run</del> Looks like we still have a couple to go</p>



<a name="395766286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395766286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395766286">(Oct 09 2023 at 21:42)</a>:</h4>
<p>a hunch, in <code>crates/compiler/gen_dev/src/generic64/mod.rs</code> can you uncomment the and here</p>
<div class="codehilite"><pre><span></span><code>    fn build_not(&amp;mut self, dst: &amp;Symbol, src: &amp;Symbol, arg_layout: &amp;InLayout&lt;&#39;a&gt;) {
        match self.interner().get_repr(*arg_layout) {
            LayoutRepr::BOOL =&gt; {
                let dst_reg = self.storage_manager.claim_general_reg(&amp;mut self.buf, dst);
                let src_reg = self.storage_manager.load_to_general_reg(&amp;mut self.buf, src);

                ASM::mov_reg64_imm64(&amp;mut self.buf, dst_reg, 1);
                ASM::xor_reg64_reg64_reg64(&amp;mut self.buf, src_reg, src_reg, dst_reg);

                // we may need to mask out other bits in the end? but a boolean should be 0 or 1.
                // if that invariant is upheld, this mask should not be required
                // ASM::and_reg64_reg64_reg64(&amp;mut self.buf, src_reg, src_reg, dst_reg);

                ASM::mov_reg64_reg64(&amp;mut self.buf, dst_reg, src_reg);
            }
            x =&gt; todo!(&quot;Not: layout, {:?}&quot;, x),
        }
    }
</code></pre></div>



<a name="395766387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395766387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395766387">(Oct 09 2023 at 21:44)</a>:</h4>
<p>valgrind is ok with it at least so I'm not sure what else to do</p>



<a name="395766397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395766397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395766397">(Oct 09 2023 at 21:44)</a>:</h4>
<div class="codehilite"><pre><span></span><code>admin@raspberrypi ~/roc (aarch-records)&gt; valgrind --track-origins=yes target/debug/deps/test_gen-f2c946b9d248f5c7 list_ends_with_empty
==89204== Memcheck, a memory error detector
==89204== Copyright (C) 2002-2017, and GNU GPL&#39;d, by Julian Seward et al.
==89204== Using Valgrind-3.16.1 and LibVEX; rerun with -h for copyright info
==89204== Command: target/debug/deps/test_gen-f2c946b9d248f5c7 list_ends_with_empty
==89204==

running 1 test
test gen_list::list_ends_with_empty has been running for over 60 seconds
test gen_list::list_ends_with_empty ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 785 filtered out; finished in 342.49s

==89204==
==89204== HEAP SUMMARY:
==89204==     in use at exit: 3,746,224 bytes in 17,229 blocks
==89204==   total heap usage: 437,310 allocs, 420,081 frees, 264,614,202 bytes allocated
==89204==
==89204== LEAK SUMMARY:
==89204==    definitely lost: 3,271,420 bytes in 15,096 blocks
==89204==    indirectly lost: 182,040 bytes in 21 blocks
==89204==      possibly lost: 119,592 bytes in 7 blocks
==89204==    still reachable: 173,172 bytes in 2,105 blocks
==89204==         suppressed: 0 bytes in 0 blocks
==89204== Rerun with --leak-check=full to see details of leaked memory
==89204==
==89204== For lists of detected and suppressed errors, rerun with: -s
==89204== ERROR SUMMARY: 0 errors from 0 contexts (suppressed: 0 from 0)
</code></pre></div>



<a name="395766460"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395766460" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395766460">(Oct 09 2023 at 21:45)</a>:</h4>
<p>but it may be that we need to task the boolean, which uncommenting that line should do. (I'm assuming the result of the test is an empty list?)</p>



<a name="395767458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395767458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395767458">(Oct 09 2023 at 21:54)</a>:</h4>
<p>I can look at this again later this evening around <time datetime="2023-10-10T08:00:00Z">2023-10-10T19:00:00+11:00</time></p>



<a name="395769286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395769286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395769286">(Oct 09 2023 at 22:12)</a>:</h4>
<p>I'm pretty busy today so I probably won't have time to debug this properly but at least in my machine this fails at link time:</p>
<div class="codehilite"><pre><span></span><code>--- STDERR:              test_gen::test_gen gen_list::list_ends_with_empty ---
ld: invalid r_symbolnum=32 in &#39;/private/tmp/nix-shell.yttg98/.tmpnHbSn5/app.o&#39;
</code></pre></div>



<a name="395769601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395769601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395769601">(Oct 09 2023 at 22:15)</a>:</h4>
<p>a thought: there might be some sort of "enable more debug info" environment variable for the linker that could help here</p>



<a name="395769761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395769761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395769761">(Oct 09 2023 at 22:18)</a>:</h4>
<p>Will try that. I'll post an objdump too, there's something weird with a reloc.</p>



<a name="395770412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395770412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395770412">(Oct 09 2023 at 22:24)</a>:</h4>
<p><a href="https://gist.github.com/agu-z/554090ab7c5ed5c6e83bd8b170af7e74#file-list_ends_with_empty-s-L582-L583">https://gist.github.com/agu-z/554090ab7c5ed5c6e83bd8b170af7e74#file-list_ends_with_empty-s-L582-L583</a></p>



<a name="395770459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395770459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395770459">(Oct 09 2023 at 22:25)</a>:</h4>
<p>That looks interesting to me. That symbol (<code>_#UserApp_#help0_Eq_InLayout(VOID)_1</code>) only shows up in the reloc and not as a label.</p>



<a name="395772055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395772055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395772055">(Oct 09 2023 at 22:48)</a>:</h4>
<p>Hm. It looks like we also have it for Linux, though:</p>
<div class="codehilite"><pre><span></span><code> 100:   94000000    bl  0 &lt;#UserApp_#help0_Eq_InLayout(23)_1&gt;
            100: R_AARCH64_CALL26   #UserApp_#help0_Eq_InLayout(VOID)_1
</code></pre></div>



<a name="395772365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395772365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395772365">(Oct 09 2023 at 22:52)</a>:</h4>
<p><code>ld</code> with <code>-v</code> just printed some more irrelevant info</p>



<a name="395867294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395867294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395867294">(Oct 10 2023 at 12:01)</a>:</h4>
<p>well-spotted! indeed, we don't generate that function. On linux that is apparently fine because the function call is never reached</p>



<a name="395867342"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395867342" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395867342">(Oct 10 2023 at 12:01)</a>:</h4>
<p>but macos does not let you get away with that (arguably the better approach)</p>



<a name="395868649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395868649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395868649">(Oct 10 2023 at 12:08)</a>:</h4>
<p><code>Summary [  46.667s] 136 tests run: 136 passed, 2 skipped</code> REPL tests using aarch64 dev backend (using some changes that Folkert will add soon)</p>



<a name="395872611"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395872611" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395872611">(Oct 10 2023 at 12:30)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/5897">https://github.com/roc-lang/roc/pull/5897</a> enables all tests on apple silicon, and should pass</p>



<a name="395900741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395900741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395900741">(Oct 10 2023 at 14:49)</a>:</h4>
<p>It did! <span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span> </p>
<div class="codehilite"><pre><span></span><code>Summary [ 309.074s] 903 tests run: 903 passed, 6 skipped
</code></pre></div>



<a name="395901087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/AArch64%20dev%20backend/near/395901087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/AArch64.20dev.20backend.html#395901087">(Oct 10 2023 at 14:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281543">Folkert de Vries</span> <a href="#narrow/stream/395097-compiler-development/topic/AArch64.20dev.20backend/near/395867342">said</a>:</p>
<blockquote>
<p>but macos does not let you get away with that (arguably the better approach)</p>
</blockquote>
<p>Agreed. What a bad error message, though. These lower-level macOS tools leave much to be desired <span aria-label="upside down" class="emoji emoji-1f643" role="img" title="upside down">:upside_down:</span></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
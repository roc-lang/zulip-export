<html>
<head><meta charset="utf-8"><title>Host Refcounting of List with Size on Heap · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html">Host Refcounting of List with Size on Heap</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="431538049"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431538049" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431538049">(Apr 05 2024 at 14:38)</a>:</h4>
<p>So one piece that is gonna be more annoying to design around is the host language specific libraries. One important piece of this change is that knowledge around refcounting is even more ingrained into the handling of a list. My thought is to essentially add a trait (rust)/comptime function (zig) (will need to be generated by glue) on each roc type to specify if it is refcounted or not. It will also contain an inc and dec function. This is definitely a case where it will suck to duplicate this logic into each host language. It would be nicer if roc could expose the inc and dec functions for every single type exposed via the host api (just to makes sure the function is always correct), but that is probably a lot more work to enable.</p>
<p>Note: lists in host specific libraries should really know about this anyway. It is required if you ever want to properly interact with a list of refcounted roc things instead of simply deallocate it.</p>
<p>Any general thoughts on this?</p>
<p>Relatedly, once we have explicit allocators, a drop function in rust won't be possible anymore. All drops will need the allocator passed in, which is incompatible with rusts drop api.</p>
<p>Part of me thinks that it may be worth analyzing the host api and exposing all of the primitives from roc to the host. That way the logic is all centralized in roc. Don't need to expose all functions, but the complex underlying pieces around refcounting and getting access to the data.</p>



<a name="431538141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431538141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431538141">(Apr 05 2024 at 14:38)</a>:</h4>
<p>I hit this cause freeing a list now requires knowing whether or not the elements in the list are refcounted.</p>



<a name="431578735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431578735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431578735">(Apr 05 2024 at 18:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Host.20Refcounting/near/431538049">said</a>:</p>
<blockquote>
<p>Relatedly, once we have explicit allocators, a drop function in rust won't be possible anymore. All drops will need the allocator passed in, which is incompatible with rusts drop api.</p>
</blockquote>
<p>that's a great point - they should probably all be <code>ManuallyDrop</code> anyway</p>



<a name="431578810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431578810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431578810">(Apr 05 2024 at 18:01)</a>:</h4>
<p>but exposing <code>dealloc</code> methods for convenience, which accept an allocator</p>



<a name="431578948"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431578948" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431578948">(Apr 05 2024 at 18:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Host.20Refcounting/near/431538049">said</a>:</p>
<blockquote>
<p>My thought is to essentially add a trait (rust)/comptime function (zig) (will need to be generated by glue) on each roc type to specify if it is refcounted or not. It will also contain an inc and dec function.</p>
</blockquote>
<p>couldn't the inc/dec functions always be there, but sometimes be no-ops?</p>



<a name="431579445"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431579445" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431579445">(Apr 05 2024 at 18:05)</a>:</h4>
<p>It's fine if the functions are always there, but not particularly useful. We need to know if the elements are refcounted. So it would then be inc, dec, and is_refcounted on every type.</p>



<a name="431579560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431579560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431579560">(Apr 05 2024 at 18:06)</a>:</h4>
<p>Is the element type is refcounted, we have to store the full list length on the heap so that a seamless slice can free the elements in the underlying list.</p>



<a name="431579661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431579661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431579661">(Apr 05 2024 at 18:06)</a>:</h4>
<p>Cause the slice may not reference all elements.</p>



<a name="431579746"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431579746" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431579746">(Apr 05 2024 at 18:07)</a>:</h4>
<p>Instead of changing all lists to have space to store the full list length on the heap, only lists with refcounted elements are changed.</p>



<a name="431582164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431582164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431582164">(Apr 05 2024 at 18:24)</a>:</h4>
<p>Huh, I don't think rust can do what I wanted without an unstable feature. I was thinking of essentially:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RocList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">T</span>: <span class="nc">RocRefcounted</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">// impl with refcounting.</span>
<span class="p">}</span>

<span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Drop</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RocList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="w">   </span><span class="c1">// impl without refcounting.</span>
<span class="p">}</span>
</code></pre></div>



<a name="431585307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431585307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431585307">(Apr 05 2024 at 18:47)</a>:</h4>
<p>There is a way to make this work in stable rust, but it is definitely odd... <a href="https://github.com/dtolnay/case-studies/blob/master/autoref-specialization/README.md">https://github.com/dtolnay/case-studies/blob/master/autoref-specialization/README.md</a></p>



<a name="431590814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431590814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431590814">(Apr 05 2024 at 19:26)</a>:</h4>
<p>If I understand correctly, which I totally might not, the autoref thing doesn't work generic types that implement other traits. So it wouldn't work with <code>RocList&lt;T&gt;</code>.</p>
<p>So I guess my current proposal here to simply get something in is:<br>
1) Add a <code>RocRefcounted</code> trait</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">RocRefcounted</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>: <span class="kt">usize</span><span class="p">);</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">dec</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_refcounted</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>2) Force all list element types to implement the trait</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RocList</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">T</span>: <span class="nc">RocRefcounted</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>3) Use a macro to implement <code>RocRefcounted</code> as a no-op for all of the stardard rust types (integers mostly, but anything that might be in a <code>RocList</code> that is part of the rust std).</p>
<p>4) Write implementations of <code>RocRefcounted</code> for the types in <code>roc_std</code> (<code>RocStr</code>, <code>RocList</code>, etc)</p>
<p>5) Update <code>RustGlue.roc</code> to generate an implementation for all generated types.</p>
<p>6) With <code>RocRefcounted</code> implemented everywhere, types will be usable with <code>RocList</code> and <code>RocList</code> will be able to proper deal with all refcounting and deallocation stuff.</p>



<a name="431623919"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431623919" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431623919">(Apr 06 2024 at 00:52)</a>:</h4>
<p>This is what requiring <code>RocRefcounted</code> looks like: <a href="https://github.com/roc-lang/roc/commit/05fb172348b9520a8500ed5ca618d9423068dc41">https://github.com/roc-lang/roc/commit/05fb172348b9520a8500ed5ca618d9423068dc41</a></p>
<p>I am not exactly a fan, but it seems to be the most practical solution currently....</p>
<p>Ideas very welcome.</p>



<a name="431623977"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431623977" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431623977">(Apr 06 2024 at 00:53)</a>:</h4>
<p>Oh, also with this change, only 19 failing tests in the full test_gen for llvm:</p>
<div class="codehilite"><pre><span></span><code>1277 tests run: 1258 passed, 19 failed, 19 skipped
</code></pre></div>
<p>Still probably many memory leaks/mistakes/other bugs...and two other backends, but almost to parity for llvm backend.</p>



<a name="431805063"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431805063" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431805063">(Apr 07 2024 at 18:42)</a>:</h4>
<p>Progress... <span aria-label="hundred" class="emoji emoji-1f4af" role="img" title="hundred">:hundred:</span>% passing test-gen-llvm</p>
<div class="codehilite"><pre><span></span><code>Summary [ 167.284s] 1277 tests run: 1277 passed, 19 skipped
</code></pre></div>
<p>Still need to:</p>
<ol>
<li>Update <code>RustGlue.roc</code> to generate  <code>RocRefcounted</code> for all types. Still kinda want a different solution than <code>RocRefcounted</code>, but it works.</li>
<li>Make sure all the examples work without memory leaks.</li>
<li>Update the dev backend</li>
<li>Update the wasm backend</li>
</ol>



<a name="431805112"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431805112" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431805112">(Apr 07 2024 at 18:43)</a>:</h4>
<p>Will be interesting once I have this wired up E2E and can actually measure the perf difference for something like <code>Dict Str U64</code>. Should be huge!</p>



<a name="431994479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431994479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431994479">(Apr 08 2024 at 15:06)</a>:</h4>
<p>So I just manually did some wiring up to get the examples working and make it so that I can test the perf gains.</p>
<p>Wrote a really simple app. Just counts word occurrences in text. The text is 43MB. I basically wrote an implementation of this blog: <a href="https://benhoyt.com/writings/count-words/">https://benhoyt.com/writings/count-words/</a> in roc. Though I skipped the lowercasing and I didn't try to optimize it at all.</p>
<p>Anyway....the perf diff:</p>
<p>Current main: 59min<br>
This branch: 1.6s</p>
<p>So ~2,200 times faster.</p>
<p>For more reasonable perf rough benchmark, I ran an equivalent go and python implementation. For this test though, I removed the sorting (we have a bug that hurts sorting perf). Just counting and printing. Loading the file in bulk in all languages. So pretty apples to apples...we do eh, ok-ish.</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="go">Benchmark 1: ./count-go</span>
<span class="go">  Time (mean ± σ):     348.6 ms ±   3.4 ms    [User: 366.8 ms, System: 47.4 ms]</span>
<span class="go">  Range (min … max):   344.4 ms … 353.6 ms    10 runs</span>

<span class="go">Benchmark 2: ./count-roc</span>
<span class="go">  Time (mean ± σ):     769.8 ms ±   7.0 ms    [User: 746.0 ms, System: 19.5 ms]</span>
<span class="go">  Range (min … max):   760.3 ms … 782.5 ms    10 runs</span>

<span class="go">Benchmark 3: python /tmp/count.py</span>
<span class="go">  Time (mean ± σ):      1.026 s ±  0.030 s    [User: 0.930 s, System: 0.085 s]</span>
<span class="go">  Range (min … max):    0.991 s …  1.086 s    10 runs</span>

<span class="go">Summary</span>
<span class="go">  './count-go' ran</span>
<span class="go">    2.21 ± 0.03 times faster than './count-roc'</span>
<span class="go">    2.94 ± 0.09 times faster than 'python /tmp/count.py'</span>
</code></pre></div>
<p>Haven't done any analysis as to why we are 2.2x slower than Go. Might be a bad implementation of <code>splitWhiteSpace</code> on my part (probably this I think I am doing extra unicode verification that is costing, why a builtin may be needed here). Might be needing borrow inference to get some refcounting out of hot loops. Might be other dictionary perf issues.</p>
<p>We do at least use way less memory:<br>
Roc: 85MB<br>
Go: 213MB<br>
Python: 588MB</p>



<a name="431994905"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431994905" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431994905">(Apr 08 2024 at 15:07)</a>:</h4>
<p><a href="/user_uploads/22008/jvwp4NJW8i74f0tJD39ge1qi/Screenshot-2024-04-08-at-11.07.27AM.png">Screenshot-2024-04-08-at-11.07.27AM.png</a><br>
<span aria-label="rolling on the floor laughing" class="emoji emoji-1f923" role="img" title="rolling on the floor laughing">:rolling_on_the_floor_laughing:</span></p>
<div class="message_inline_image"><a href="/user_uploads/22008/jvwp4NJW8i74f0tJD39ge1qi/Screenshot-2024-04-08-at-11.07.27AM.png" title="Screenshot-2024-04-08-at-11.07.27AM.png"><img src="/user_uploads/22008/jvwp4NJW8i74f0tJD39ge1qi/Screenshot-2024-04-08-at-11.07.27AM.png"></a></div>



<a name="431995313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431995313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431995313">(Apr 08 2024 at 15:08)</a>:</h4>
<p>amazing work <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span>!!!!</p>



<a name="431995480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431995480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431995480">(Apr 08 2024 at 15:09)</a>:</h4>
<p><span class="user-mention" data-user-id="281543">@Folkert de Vries</span> do you have borrow inference far enough on a branch that we could try it with this?</p>



<a name="431996781"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431996781" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431996781">(Apr 08 2024 at 15:12)</a>:</h4>
<p>maybe? there are bugs but maybe it works for some examples</p>



<a name="431998414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/431998414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#431998414">(Apr 08 2024 at 15:17)</a>:</h4>
<p>I don't think it would help yet cause it wouldn't work on Dict. Cause Dict is not a List, it is a container that holds a List. So far it is just implemented for raw Lists and Strs.</p>



<a name="432040805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/432040805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#432040805">(Apr 08 2024 at 18:22)</a>:</h4>
<p>So got a bit of a breakdown of the perf (all precentages are of total execution time for the program):</p>
<ul>
<li>~50%: Dict.update for counting (11% of that is refcounting that might get removed with borrow inference)</li>
<li>~35%: spent walking the string and figuring out word splitting. This is a char at a time checking whitespace and then doing sublist to use seamless slices. Intermediate state is just <code>(Dict Str U64, [Valid U64, InValid])</code>. The Valid invalid is used to track word status and indices. (2.5% is refcounting)</li>
<li>~10%: spent in <code>Str.fromUtf8</code>. So that is the extra validation cost.</li>
<li>~ 5%: spent just loading the file into memory on the rust side.</li>
</ul>



<a name="432041288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/432041288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#432041288">(Apr 08 2024 at 18:24)</a>:</h4>
<p>In case I am missing something and there is a better way to do this. Here is the current impl to count words</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>countWords impl</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite" data-code-language="Elixir"><pre><span></span><code><span class="n">countWords</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="nc">U8</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Dict</span><span class="w"> </span><span class="nc">Str</span><span class="w"> </span><span class="nc">U64</span>
<span class="n">countWords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">text</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="p">(</span><span class="n">countsFinal</span><span class="p">,</span><span class="w"> </span><span class="n">validFinal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="nc">List</span><span class="o">.</span><span class="n">walkWithIndex</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="p">(</span><span class="nc">Dict</span><span class="o">.</span><span class="n">empty</span><span class="w"> </span><span class="p">{},</span><span class="w"> </span><span class="nc">InValid</span><span class="p">)</span><span class="w"> </span><span class="err">\</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span><span class="w"> </span><span class="n">lastValid</span><span class="p">),</span><span class="w"> </span><span class="n">char</span><span class="p">,</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">isWhiteSpace</span><span class="w"> </span><span class="n">char</span><span class="w"> </span><span class="n">then</span>
<span class="w">                </span><span class="ow">when</span><span class="w"> </span><span class="n">lastValid</span><span class="w"> </span><span class="n">is</span>
<span class="w">                    </span><span class="nc">Valid</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="c1"># get work i (inclusive) to index (exclusive)</span>
<span class="w">                        </span><span class="n">wordUtf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">sublist</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="p">{</span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">}</span>
<span class="w">                        </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Str</span><span class="o">.</span><span class="n">fromUtf8</span><span class="w"> </span><span class="n">wordUtf8</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">unwrap</span>
<span class="w">                        </span><span class="n">countsUpdated</span><span class="w"> </span><span class="o">=</span>
<span class="w">                            </span><span class="nc">Dict</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="n">counts</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="err">\</span><span class="n">present</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                </span><span class="ow">when</span><span class="w"> </span><span class="n">present</span><span class="w"> </span><span class="n">is</span>
<span class="w">                                    </span><span class="nc">Present</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                        </span><span class="nc">Present</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                                    </span><span class="nc">Missing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                                        </span><span class="nc">Present</span><span class="w"> </span><span class="mi">1</span>
<span class="w">                        </span><span class="p">(</span><span class="n">countsUpdated</span><span class="p">,</span><span class="w"> </span><span class="nc">InValid</span><span class="p">)</span>
<span class="w">                    </span><span class="nc">InValid</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="p">(</span><span class="n">counts</span><span class="p">,</span><span class="w"> </span><span class="nc">InValid</span><span class="p">)</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="ow">when</span><span class="w"> </span><span class="n">lastValid</span><span class="w"> </span><span class="n">is</span>
<span class="w">                    </span><span class="nc">Valid</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="p">(</span><span class="n">counts</span><span class="p">,</span><span class="w"> </span><span class="nc">Valid</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="nc">InValid</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="p">(</span><span class="n">counts</span><span class="p">,</span><span class="w"> </span><span class="nc">Valid</span><span class="w"> </span><span class="n">index</span><span class="p">)</span>

<span class="w">    </span><span class="ow">when</span><span class="w"> </span><span class="n">validFinal</span><span class="w"> </span><span class="n">is</span>
<span class="w">        </span><span class="nc">Valid</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">wordUtf8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">sublist</span><span class="w"> </span><span class="n">text</span><span class="w"> </span><span class="p">{</span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="nc">List</span><span class="o">.</span><span class="n">len</span><span class="w"> </span><span class="n">text</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">}</span>
<span class="w">            </span><span class="n">word</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Str</span><span class="o">.</span><span class="n">fromUtf8</span><span class="w"> </span><span class="n">wordUtf8</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">unwrap</span>
<span class="w">            </span><span class="nc">Dict</span><span class="o">.</span><span class="n">update</span><span class="w"> </span><span class="n">countsFinal</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="err">\</span><span class="n">present</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                </span><span class="ow">when</span><span class="w"> </span><span class="n">present</span><span class="w"> </span><span class="n">is</span>
<span class="w">                    </span><span class="nc">Present</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="nc">Present</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                    </span><span class="nc">Missing</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">                        </span><span class="nc">Present</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="nc">InValid</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="n">countsFinal</span>



<span class="n">isWhiteSpace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">char</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="n">char</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">' '</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">char</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">char</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">char</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">char</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'</span><span class="se">\t</span><span class="s1">'</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">char</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">13</span>

<span class="n">unwrap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">res</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="ow">when</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="n">is</span>
<span class="w">        </span><span class="nc">Ok</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="nc">Err</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">crash</span><span class="w"> </span><span class="s2">"failed to unwrap $(Inspect.toStr e)"</span>
</code></pre></div>
</div></div>



<a name="432385665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/432385665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#432385665">(Apr 10 2024 at 02:53)</a>:</h4>
<p>Just an update on status of implementation:</p>
<p>llvm -&gt; looks all good e2e (need to double check potential mem leaks)<br>
dev -&gt; not implemented<br>
wasm -&gt; not implemented</p>
<p>RustGlue.roc -&gt; needs update to generate <code>RocRefcounted</code> for all types (probably the biggest part of this work if I implement it for every single type, could leave some of it as todo and still merge the PR)</p>



<a name="432808003"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/432808003" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#432808003">(Apr 12 2024 at 00:23)</a>:</h4>
<p>Down to 47 failing dev wasm tests. Most (if I'm lucky, all) because I haven't updated the auto generated refcounting.</p>
<p>Dev...may be a rougher lift. I have been updating it along with wasm, but it has many more failures, 204. All sig aborts. My gut feeling is that some of the auto generated reference counting function pointers are broken/done wrong. So anytime zig tries to increment a refcount of an element in a list it is crashing.</p>



<a name="433010911"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/433010911" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#433010911">(Apr 13 2024 at 03:19)</a>:</h4>
<p>In an interesting turn of events, I update the autogenerated refcounting functions and the test numbers essentially switched between wasm and dev</p>
<p>wasm: 229 failing<br>
dev: 45 failing</p>
<p>IIUC, most of the wasm tests are failing in roc's wasm interpreter. Not sure if I am revealing an interpreter bug or if this is a bug in my code gen. Theoretically the new functions are just calling into zig. So feels strange that they would be wrong. But I easily could have mis-wired something</p>
<p>Most wasm errors look like this now:</p>
<div class="codehilite"><pre><span></span><code>panicked at &#39;index out of bounds: the len is 1254 but the index is 1254&#39;, crates/wasm_module/src/lib.rs:460:34
</code></pre></div>



<a name="435054384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/435054384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#435054384">(Apr 23 2024 at 19:30)</a>:</h4>
<p>That particular line of code is in <code>trace_live_functions</code> which is used for dead code elimination. It's possible to turn off DCE using the DEBUG_SETTINGS struct <a href="https://github.com/roc-lang/roc/blob/main/crates/wasm_module/src/lib.rs#L912">here</a>.</p>



<a name="435054892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/435054892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#435054892">(Apr 23 2024 at 19:34)</a>:</h4>
<p>That particular error means that it's trying to trace a function call but the function index is out of bounds, so the function doesn't exist, or the index is wrong somehow.</p>



<a name="435056583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/435056583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#435056583">(Apr 23 2024 at 19:44)</a>:</h4>
<p>Thanks for the info. Will take a look</p>



<a name="449697647"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449697647" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449697647">(Jul 07 2024 at 18:03)</a>:</h4>
<p>I am looking at this PR a bit again. One thing I am unsure of that maybe <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> or <span class="user-mention" data-user-id="431893">@Brian Carroll</span> know. For the refcounting function code gen. I can generate a symbol for a proc. (In this case a proc to decrement the elements in a list). Do we have a way to load that symbol into a pointer for passing to zig?</p>
<p>context: <a href="https://github.com/roc-lang/roc/blob/46be989f5b42a59a331f1f63b150088735c86723/crates/compiler/mono/src/code_gen_help/refcount.rs#L1019-L1032">https://github.com/roc-lang/roc/blob/46be989f5b42a59a331f1f63b150088735c86723/crates/compiler/mono/src/code_gen_help/refcount.rs#L1019-L1032</a></p>
<p>I know both dev backends have ways to do this, but not sure if anything is actually exposed such that I could do that here. Maybe I just need to somehow give the function symbol a pointer layout?</p>



<a name="449699952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449699952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449699952">(Jul 07 2024 at 18:21)</a>:</h4>
<p>I think we only do that for lowlevels so it's baked into the backends, not something we can currently do in mono</p>



<a name="449700143"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449700143" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449700143">(Jul 07 2024 at 18:23)</a>:</h4>
<p>Ok</p>



<a name="449700158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449700158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449700158">(Jul 07 2024 at 18:23)</a>:</h4>
<p>I should be fine to add it as a low level?</p>



<a name="449700191"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449700191" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449700191">(Jul 07 2024 at 18:23)</a>:</h4>
<p>Just function symbol arg to pointer?</p>



<a name="449700299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449700299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449700299">(Jul 07 2024 at 18:24)</a>:</h4>
<p>Or I guess I could make this whole chunk of list recounting code call a low-level that the backends deal with</p>



<a name="449700313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449700313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449700313">(Jul 07 2024 at 18:24)</a>:</h4>
<p>yea some <code>ToFunctionPointer</code> should be fine</p>



<a name="449702557"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449702557" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449702557">(Jul 07 2024 at 18:50)</a>:</h4>
<p>If this is for decrementing elements of lists then we should know the type of those elements at compile time in mono, so we should know what function to call. So why is it a function pointer at runtime and not just a call to a known function?</p>



<a name="449702619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449702619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449702619">(Jul 07 2024 at 18:51)</a>:</h4>
<p>Only cause the logic is complex enough now that I didn't want to port it all to mono. Instead just passing off to the zig builtin</p>



<a name="449702719"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449702719" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449702719">(Jul 07 2024 at 18:53)</a>:</h4>
<p>OK</p>



<a name="449702742"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449702742" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449702742">(Jul 07 2024 at 18:53)</a>:</h4>
<p>Where's the logic now?</p>



<a name="449702919"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449702919" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449702919">(Jul 07 2024 at 18:55)</a>:</h4>
<p>On main, it is written in mono (and I guess duplicated in zig). With this branch, it become more complex so I want to have one source of truth in zig if possible.</p>



<a name="449703066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449703066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449703066">(Jul 07 2024 at 18:55)</a>:</h4>
<p>OK. Well we do already have lowlevels for casting integer to pointer and back. But I don't think we have a lowlevel for function pointers because they were always known at compile time.</p>



<a name="449704194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449704194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449704194">(Jul 07 2024 at 19:01)</a>:</h4>
<p>But as you mentioned, the wasm dev backend does pass function indices to Zig already.<br>
<a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/gen_wasm/src/backend.rs#L2103-L2134">This</a> seems like a good place to refer to.</p>



<a name="449704354"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449704354" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449704354">(Jul 07 2024 at 19:01)</a>:</h4>
<p>Thanks</p>



<a name="449735801"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449735801" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449735801">(Jul 07 2024 at 23:41)</a>:</h4>
<p>hey <span class="user-mention" data-user-id="281543">@Folkert de Vries</span>, do you recall symbols from <code>debug_symbol</code> in the dev backend need to be freed? My understanding was that it generates a unique symbol just with whatever name as like a prefix, so freeing shouldn't be needed. But maybe I am incorrect about how that is implemented.</p>



<a name="449738006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/449738006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#449738006">(Jul 07 2024 at 23:52)</a>:</h4>
<p>Also, one thing that really confuses me with <code>list-size-on-heap</code> is that a lot of the newly failing gen_dev tests are not even touching lists and the refcount path. I don't know what I broke, but really feels like I may have accidentally modify something unrelated to lists for that backend (same for gen_wasm) I guess. Hopefully, that means the fix is unrelated and pretty minor. The fact that llvm is 100% working only gen_wasm/gen_dev have issues definitely a tad annoying. Want to get this merged for people to be able to use it.</p>



<a name="450563389"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450563389" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450563389">(Jul 10 2024 at 20:59)</a>:</h4>
<p>I decided to open a Draft PR for the list size on heap work(<a href="https://github.com/roc-lang/roc/issues/6894">#6894</a>). If anyone has time to look over the code changes in <code>gen_dev</code>, <code>gen_wasm</code> or <code>mono/code_gen_help</code>, it would be much appreciated. Given the PR is passing for the llvm backend, it suggests that the issues I am still hitting are coming from those folders. Extra eyes to leave comments, attempt to debug, or give general suggestions of code I should check over again would be quite helpful.</p>
<p>Hopefully I can figure out the last chunk of issues and finally get this submitted. It is a huge perf gain for any lists of refcounted types.</p>



<a name="450598955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450598955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450598955">(Jul 11 2024 at 00:26)</a>:</h4>
<p>Oh! Just had a big breakthrough on wasm. I was generating a bunch of direct refcounting functions when I needed indirect ones!. Changing over fixed a number of tests. That said, also revealed some incorrect args I need to update.</p>



<a name="450600628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450600628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450600628">(Jul 11 2024 at 00:34)</a>:</h4>
<p>Eh, less big than I thought, but still a chunk better. That said, there is definitely a DCE bug. approximately 120 tests fail with DCE enabled. I assume it is related to passing function pointers to zig and those being DCE'd when they shouldn't be.</p>



<a name="450604266"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450604266" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450604266">(Jul 11 2024 at 01:22)</a>:</h4>
<p>Hmm, for wasm it seems that some indirect refcounting function my not be getting added to the function table in general. (No idea why currently). As such, we end up passing an incorrect function pointer around. Maybe it is related to the nested nature (like outer function getting added but not inner or something similar)</p>



<a name="450606158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450606158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450606158">(Jul 11 2024 at 01:51)</a>:</h4>
<p>Ok. Can confirm issue is caused by indirect helper procs calling direct helper procs. Wasm backend is only emitting one of these procs and not the other. I attempted to naively recursively generate helper procs, but that clearly isn't correct. Some functions are generating forever.</p>



<a name="450613514"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450613514" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450613514">(Jul 11 2024 at 03:10)</a>:</h4>
<p>Hmm, we also seem to have a chicken and egg problem. Even if I explicitly generate the element helper procs when generating the list helper procs, they won't be known when generating the helper procs. This is because the helper procs are taken from the code generator. So they don't exist when building the helper procs themselves. Only when generating the main procs.</p>



<a name="450616637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450616637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450616637">(Jul 11 2024 at 03:49)</a>:</h4>
<p>I think I fixed one of the main recursion cases leaded to inner procs not actually being generated. Down from 200ish dev wasm failures to 50ish.</p>
<p>Most failures still look to be due to missing helper procs leading to index out of bounds when trying to load a proc...not sure why at this point though.</p>



<a name="450618211"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450618211" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450618211">(Jul 11 2024 at 04:08)</a>:</h4>
<p>Oh haha, actually those issues were due to forgetting to pass an arg to the function. Not sure why it manifested that way. Down to 18 gen wasm tests failing.</p>



<a name="450619328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450619328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450619328">(Jul 11 2024 at 04:20)</a>:</h4>
<p>Sounds like good progress!<br>
I will have a look in a couple of hours.<br>
What do you mean by "<em>indirect</em> ref counting function"?</p>



<a name="450620384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450620384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450620384">(Jul 11 2024 at 04:31)</a>:</h4>
<p>Indirect: take a pointer to the thing to refcount and call the direct refcounting function</p>



<a name="450620392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450620392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450620392">(Jul 11 2024 at 04:31)</a>:</h4>
<p>Essentially all the refcount functions we pass to zig are indirect.</p>



<a name="450620643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450620643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450620643">(Jul 11 2024 at 04:35)</a>:</h4>
<p>So at this point, the failures are down to two types:</p>
<ol>
<li>cases where the refcounting proc I am trying to load a function pointer to isn't found and we panic on an unwrap.</li>
<li><code>gen_refcount</code> functions that are no longer correct in how they load the rc. Cause lists with refcounted elements are now <code>|size|rc|elements ...|</code>. So <code>gen_refcount</code> is loading the size on heap instead of the rc.</li>
</ol>



<a name="450621567"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450621567" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450621567">(Jul 11 2024 at 04:44)</a>:</h4>
<p>So for the gen_refcount tests. All of the the sizes on heap never actually get initialized. So, by zeroing out the the allocation with <code>calloc</code> instead of <code>malloc</code>, all of the lists end up having their refcount read as <code>Constant</code> cause it is reading the 0 size on heap. I guess I can special case that. Definitely a bit jank, but should be consistent and a good test.</p>



<a name="450623131"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450623131" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450623131">(Jul 11 2024 at 05:05)</a>:</h4>
<p>Ok, fixed all the <code>gen_refcount</code> tests to recognize when the load the size on heap (it's always positive) and if so load the value after it as the refcount.</p>



<a name="450625382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450625382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450625382">(Jul 11 2024 at 05:34)</a>:</h4>
<p>Oh wow, down to 2 in gen wasm. Both due to not having a matching refcount proc for a layout. Though for 1, I think the layouts are the same, it's just that they have to be check recursively to be known equal. I'm not sure why this ends up happening.  Like they have different internal InLayouts, but the runtime reprs of those InLayouts are the same. So the types really are the same.</p>



<a name="450628240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450628240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450628240">(Jul 11 2024 at 06:07)</a>:</h4>
<p>So yeah, we have 1 test where we request 1 refcount layout, but the function takes a different layout (that I'm pretty sure is equavalent:</p>
<div class="codehilite"><pre><span></span><code>[crates/compiler/gen_wasm/src/backend.rs:2123:25] self.layout_interner.runtime_representation(inner) = Union(
    NonRecursive(
        [
            [
                InLayout(STR),
                InLayout(
                    27,
                ),
            ],
            [
                InLayout(
                    30,
                ),
                InLayout(UNIT),
            ],
        ],
    ),
)
[crates/compiler/gen_wasm/src/backend.rs:2123:25] layout_repr = Union(
    NonRecursive(
        [
            [
                InLayout(STR),
                InLayout(
                    29,
                ),
            ],
            [
                InLayout(
                    32,
                ),
                InLayout(UNIT),
            ],
        ],
    ),
)
</code></pre></div>
<p>Then we have a test where we are generating the correct refcount function, but it seems to be missing when we try to loading it. Maybe it just isn't being registered in the wasm backend for some reason... There is a function of the same name with a different layout for this second test. Given this is for a recursive tag, I think that function is for refcounting the inner elements. So I think that is why it has the same name.</p>



<a name="450829158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450829158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450829158">(Jul 11 2024 at 22:51)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> it's awesome seeing your progress with this. Hype for the extra <span aria-label="racecar" class="emoji emoji-1f3ce" role="img" title="racecar">:racecar:</span> boost.</p>



<a name="450829392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450829392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450829392">(Jul 11 2024 at 22:52)</a>:</h4>
<p>fingers crossed that I can actually close it out. Really hoping that ironing out wasm (which is more debuggable) will pave the path for fixing the dev backend as well.</p>



<a name="450831261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450831261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450831261">(Jul 11 2024 at 23:02)</a>:</h4>
<p>Should <code>List.map*</code> take ownership of the input lists?</p>
<p>I guess the theory is that if:</p>
<ol>
<li>one of the lists has the same element size as the output element size</li>
<li>That list has a refcount of 1</li>
</ol>
<p>The zig builtin could reuse that allocation instead of allocating an output list.</p>
<p>Currently we don't do any of these sort of optimizations. On top of that, except for maybe <code>List.map</code> (the single element version) I would assume they would be exceptionally rare to trigger.</p>
<p>Just realizing that we have to pass in way more args if <code>List.map*</code> are also responsible for free every single list that is passed in.</p>



<a name="450837994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450837994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450837994">(Jul 12 2024 at 00:10)</a>:</h4>
<p>Hmm...actually with I'm a bit confused. Setting it to <code>Borrowed</code> or <code>Owned</code> doesn't seem to chaing our recfcount codegen...something feels off here. Either way, it seems to be <code>Borrowed</code> The lists are passed in and then decrefed after the call....</p>



<a name="450845771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450845771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450845771">(Jul 12 2024 at 01:15)</a>:</h4>
<p><span class="user-mention" data-user-id="281543">@Folkert de Vries</span> do you know where we ensure that closure passed to <code>List.map*</code> have the correct borrow signiture? As in, I noticed that in one <code>List.map2</code> case, the closure was dealing with incrementing the element refcount, but in another <code>List.map</code> case, the closure was not dealing with incrementing the refcount.</p>
<p>I definitely prefer for the closure to assume it is borrowing all args and be required to increment the refcount if the arg is used, but I'm not sure where this logic lives.</p>
<p>To get concrete, these are the examples: The first test here the <code>List.map</code> closure does not  increment the refcount. In the second case, the closure is incrementing the refcount.</p>



<a name="450847517"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450847517" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450847517">(Jul 12 2024 at 01:28)</a>:</h4>
<p>Lol, forgot to post the link: <a href="https://github.com/roc-lang/roc/blob/d4880cc438decdbe1bb5588706e682ff33daa24f/crates/compiler/test_gen/src/gen_refcount.rs#L127-L167">https://github.com/roc-lang/roc/blob/d4880cc438decdbe1bb5588706e682ff33daa24f/crates/compiler/test_gen/src/gen_refcount.rs#L127-L167</a></p>



<a name="450859493"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450859493" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450859493">(Jul 12 2024 at 02:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap/near/450831261">said</a>:</p>
<blockquote>
<p>Should <code>List.map*</code> take ownership of the input lists?</p>
<p>I guess the theory is that if:</p>
<ol>
<li>one of the lists has the same element size as the output element size</li>
<li>That list has a refcount of 1</li>
</ol>
<p>The zig builtin could reuse that allocation instead of allocating an output list.</p>
<p>Currently we don't do any of these sort of optimizations. On top of that, except for maybe <code>List.map</code> (the single element version) I would assume they would be exceptionally rare to trigger.</p>
</blockquote>
<p>I'd like to do it for single-element <code>List.map</code> for that reason, but I agree that for the others it's not likely to come up</p>



<a name="450859592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450859592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450859592">(Jul 12 2024 at 02:59)</a>:</h4>
<p>but as an example, a common thing is to <code>List.map</code> to transform a list of strings into other strings</p>



<a name="450865785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450865785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450865785">(Jul 12 2024 at 03:33)</a>:</h4>
<p>Also, don't know if it was <span class="user-mention" data-user-id="431893">@Brian Carroll</span>, <span class="user-mention" data-user-id="281543">@Folkert de Vries</span>, or someone else. But many thanks to whoever made <code>gen_refcount</code> for the wasm backend. Very useful for adding extra test cases and debugging my changes.</p>



<a name="450880769"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450880769" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450880769">(Jul 12 2024 at 05:31)</a>:</h4>
<p>That was me. Glad you like it!</p>



<a name="450882397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450882397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450882397">(Jul 12 2024 at 05:49)</a>:</h4>
<p>Also, periodic reminder that we have a HTML page in <code>test_gen/</code> that can load the Wasm file for a test into the browser so we can use their debug tools. Whenever I had a really hard Wasm bug, it always ended up being helpful.</p>



<a name="450928878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450928878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450928878">(Jul 12 2024 at 10:10)</a>:</h4>
<blockquote>
<p>do you know where we ensure that closure passed to <code>List.map*</code> have the correct borrow signiture</p>
</blockquote>
<p>hmm, should we maybe just move that over to roc itself finally? then lambda sets (or whatever else we use) will just handle that automatically</p>



<a name="450928987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450928987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450928987">(Jul 12 2024 at 10:10)</a>:</h4>
<p>because the actual answer is that I may have missed that in the recent borrow inference changes (and none of our test cases catch that?!)</p>



<a name="450941230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450941230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450941230">(Jul 12 2024 at 11:07)</a>:</h4>
<p>I'd still rather not add special syntax for that <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="450941319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450941319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450941319">(Jul 12 2024 at 11:07)</a>:</h4>
<p>I know it would make this sort of thing nicer, but I think if it's exposed in syntax then there will be requests for moving it to userspace</p>



<a name="450980482"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450980482" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450980482">(Jul 12 2024 at 13:45)</a>:</h4>
<p>syntax for what? I'm not proposing syntax?</p>



<a name="450980667"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450980667" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450980667">(Jul 12 2024 at 13:46)</a>:</h4>
<p>we can write <code>List.map</code> in pure roc in the standard library. There is a minor performance hit (or there was, years ago now) but it really simplifies the backends</p>



<a name="450993299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/450993299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#450993299">(Jul 12 2024 at 14:31)</a>:</h4>
<p>oh nm I misunderstood</p>



<a name="451007851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451007851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451007851">(Jul 12 2024 at 15:20)</a>:</h4>
<p>Ah, so move <code>List.map</code> into roc and let roc generate recounting for calling and what not automatically. That said, any other zig builtin that take lambdas may still hit this. Like sort with </p>
<p>Also, I'm gonna guess that this was broken before your recent change, but I can double check.</p>



<a name="451008427"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451008427" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451008427">(Jul 12 2024 at 15:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281543">Folkert de Vries</span> <a href="#narrow/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap/near/450980667">said</a>:</p>
<blockquote>
<p>we can write <code>List.map</code> in pure roc in the standard library. There is a minor performance hit (or there was, years ago now) but it really simplifies the backends</p>
</blockquote>
<p>I could see doing this for now, and then in the future finding a way to improve the perf (e.g. optimizations that apply to that roc code, maybe introducing a new builtins-only primitive that can speed it up, etc.)</p>



<a name="451079039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451079039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451079039">(Jul 12 2024 at 21:33)</a>:</h4>
<p>Yeah, I guess we want the inplace optimization, so moving to roc maybe doesn't make sense. We will just end up moving it back out eventually.</p>



<a name="451079192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451079192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451079192">(Jul 12 2024 at 21:34)</a>:</h4>
<p>I guess it could be represented in pure roc if we add a built-in to check the uniqueness. If unique, can read and write directly to the single list</p>



<a name="451079200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451079200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451079200">(Jul 12 2024 at 21:34)</a>:</h4>
<p>So actually that sounds fine</p>



<a name="451079224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451079224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451079224">(Jul 12 2024 at 21:34)</a>:</h4>
<p>Yeah, probably gonna move it to full roc.</p>



<a name="451101456"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451101456" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451101456">(Jul 13 2024 at 00:37)</a>:</h4>
<p>Moved <code>List.map*</code> to roc and fixed a refcounting bug in dev_wasm.<br>
I also added new tests (so that has increased the number of failing tests), but currently at:</p>
<ul>
<li>llvm -&gt; 100% functional (had a few temporary breaks)</li>
<li>dev wasm -&gt; 2 failing: both due to <code>"WebAssembly 'unreachable' instruction at file offset 0x...</code>. Maybe related to dec functions passed into <code>List.decref</code> for non-refcounted types?</li>
<li>dev native -&gt; 37 failing: No idea why...just sigabrts.</li>
<li>regular tests (all the non-backend tests) -&gt; 2 failing: Both due to needing to update <code>RustGlue.roc</code> to generate the <code>RocRefcounted</code> trait.</li>
</ul>



<a name="451104059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451104059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451104059">(Jul 13 2024 at 00:53)</a>:</h4>
<p>dev wasm at 100% passing!</p>



<a name="451104673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451104673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451104673">(Jul 13 2024 at 00:57)</a>:</h4>
<p>yooooooo</p>



<a name="451104702"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451104702" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451104702">(Jul 13 2024 at 00:57)</a>:</h4>
<p>this is so exciting! <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span></p>



<a name="451107930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451107930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451107930">(Jul 13 2024 at 01:28)</a>:</h4>
<p>dev native 100% passing!</p>



<a name="451108036"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451108036" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451108036">(Jul 13 2024 at 01:30)</a>:</h4>
<p>So now all that is left is updating <code>RustGlue.roc</code>. Should be easy but tedious.</p>



<a name="451108790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451108790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451108790">(Jul 13 2024 at 01:41)</a>:</h4>
<p>Wow, moving quickly</p>



<a name="451112857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451112857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451112857">(Jul 13 2024 at 02:14)</a>:</h4>
<p>Looks like there is also some sort of memory issue in <code>parser-movies-csv.roc</code> on linux</p>



<a name="451114968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451114968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451114968">(Jul 13 2024 at 02:39)</a>:</h4>
<p>looks like we have some invalid writes during <code>decrement_refcounted_ptr_8</code>. Probably means I am either treating something like a list when I shouldn't or the reverse.</p>



<a name="451115166"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451115166" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451115166">(Jul 13 2024 at 02:41)</a>:</h4>
<p>Ah wait, might actually be use after free. So bad refcounting.</p>



<a name="451115179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451115179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451115179">(Jul 13 2024 at 02:41)</a>:</h4>
<p>Anyway, guess that also needs to be fixed</p>



<a name="451119820"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451119820" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451119820">(Jul 13 2024 at 03:33)</a>:</h4>
<p>Cool, just a minor mistake in <code>List.sublist</code> leading to a use after free. All good now.</p>



<a name="451123846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451123846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451123846">(Jul 13 2024 at 04:26)</a>:</h4>
<p>CI is green!!!</p>
<p>So that means all that is left is:</p>
<ol>
<li>update glue and re-enable the 2 failing glue tests</li>
<li>Maybe do something about <code>-ld_classic</code>. Cause I think for many people with updated macs, they will need that flag. (EDIT: might need to do something like this where we query xcode version: <a href="https://github.com/godotengine/godot/pull/83088/files">https://github.com/godotengine/godot/pull/83088/files</a>)</li>
</ol>



<a name="451123866"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451123866" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451123866">(Jul 13 2024 at 04:26)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> just curious if you have any thoughts about <code>-ld_classic</code> and macos versioning.</p>



<a name="451132539"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451132539" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451132539">(Jul 13 2024 at 06:30)</a>:</h4>
<p>Glue generation is not very robust for refcounting (mostly unimplemented) and I haven't dealt with <code>-ld_classic</code>, but I think <a href="https://github.com/roc-lang/roc/issues/6894">#6894</a> is technically mergable now (minus whichever test I just broke...).</p>



<a name="451186327"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451186327" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451186327">(Jul 13 2024 at 15:12)</a>:</h4>
<blockquote>
<p>might need to do something like this where we query xcode version</p>
</blockquote>
<p>Yeah, I would use the same approach, add <code>-ld_classic</code> for xcode 15 and up</p>



<a name="451198461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451198461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451198461">(Jul 13 2024 at 16:59)</a>:</h4>
<p>So with this change, it mostly doesn't affect the ecosystem. That said, it will subtly break a few effects in various platforms. Anything with refcounted things in lists will now be incorrect. So <code>dirList</code> in <code>basic-cli</code> and <code>basic-webserver</code>. Also <code>sqliteExecute</code> in <code>basic-webserver</code>. Both take/return nested lists.</p>
<p>So they will need glue regenerated. Or, at a minimum some copy over the new <code>roc_std/</code> and potentially do a tiny bit of manual tweaking.</p>



<a name="451198930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451198930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451198930">(Jul 13 2024 at 17:02)</a>:</h4>
<p>My thought is that we should merge this and follow quickly with updates to <code>basic-cli</code> and <code>basic-webserver</code>.</p>
<p>Given the small amount of effects that it will affect, I am not too worried about just getting this in. We can post an announcement that warns users of the breaking change and asks them to stay on an older version of nightlies (if they run into it) until these platforms are updates.</p>



<a name="451203387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451203387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451203387">(Jul 13 2024 at 17:40)</a>:</h4>
<blockquote>
<p>My thought is that we should merge this and follow quickly with updates to <code>basic-cli</code> and <code>basic-webserver</code>.</p>
</blockquote>
<p>Yeah, we can hold off on uploading new nightlies until the new releases are ready. I can make the releases a top priority on monday.</p>



<a name="451203523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451203523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451203523">(Jul 13 2024 at 17:41)</a>:</h4>
<p>Hopefully updating plays smoothly. If not, let me know. Most likely issues are with things missing the <code>RocRefcounted</code> trait.</p>



<a name="451210891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451210891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451210891">(Jul 13 2024 at 18:45)</a>:</h4>
<p>Ok, I'm happy with <a href="https://github.com/roc-lang/roc/issues/6894">#6894</a>.</p>
<p>Glue could be updated more, but I am fine with leaving complex uncommon types with some unimplement RocRefcounted methods.</p>



<a name="451219983"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451219983" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451219983">(Jul 13 2024 at 19:57)</a>:</h4>
<p>Can we lump the breaking change in with the refactor host and task as builtin PRs? Then all the breaking changes are in one release</p>



<a name="451220051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220051">(Jul 13 2024 at 19:58)</a>:</h4>
<p>As far as I know those changes are gtg right?</p>



<a name="451220077"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220077" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220077">(Jul 13 2024 at 19:59)</a>:</h4>
<p>We could delay nightlies for that grouping together. Sure.</p>
<p>I just want to get this in before anything else moves too much. Don't want it to live too long and get stale.</p>



<a name="451220123"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220123" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220123">(Jul 13 2024 at 19:59)</a>:</h4>
<p>Totally.</p>



<a name="451220252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220252">(Jul 13 2024 at 20:00)</a>:</h4>
<p>Also, the glue code gen package is kind of the source for a bunch of platforms which have build scripts. So we can update there and it should be straightforward to update the others.</p>



<a name="451220626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220626">(Jul 13 2024 at 20:03)</a>:</h4>
<p>I can update the code gen package in a few hours time, and I'll update the refactor host PRs with the latest glue and align and test with your branch.</p>



<a name="451220635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220635">(Jul 13 2024 at 20:03)</a>:</h4>
<p>Yeah, I updated glue bar some more complex recounting that I don't think any platform uses.</p>



<a name="451220713"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220713" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220713">(Jul 13 2024 at 20:04)</a>:</h4>
<p>The glue code gen package literally just delivers a vendored roc_std and zig builtins for now.</p>



<a name="451220744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220744">(Jul 13 2024 at 20:05)</a>:</h4>
<p>Ah, I see. Makes sense</p>



<a name="451220752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220752">(Jul 13 2024 at 20:05)</a>:</h4>
<p>ooo, this means we can pass allocation size to roc_dealloc, right?</p>



<a name="451220832"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220832" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220832">(Jul 13 2024 at 20:05)</a>:</h4>
<p>because now even slices know it</p>



<a name="451220844"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220844" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220844">(Jul 13 2024 at 20:05)</a>:</h4>
<p>Yeah, I think we could.</p>



<a name="451220847"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220847" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220847">(Jul 13 2024 at 20:05)</a>:</h4>
<p>niiiiice</p>



<a name="451220894"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220894" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220894">(Jul 13 2024 at 20:06)</a>:</h4>
<p>that means Rust hosts will be able to use the global allocator for dealloc!</p>



<a name="451220918"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220918" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220918">(Jul 13 2024 at 20:06)</a>:</h4>
<p>which requires being passed that size</p>



<a name="451220964"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451220964" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451220964">(Jul 13 2024 at 20:06)</a>:</h4>
<p>that will be valuable for rust hosts that aren't just using malloc/free</p>



<a name="451221221"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451221221" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451221221">(Jul 13 2024 at 20:08)</a>:</h4>
<p>Actually, no, this still doesn't fix it.</p>



<a name="451221248"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451221248" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451221248">(Jul 13 2024 at 20:09)</a>:</h4>
<p>Cause it is number of refcounted elements rather than total allocation size.</p>



<a name="451221711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451221711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451221711">(Jul 13 2024 at 20:12)</a>:</h4>
<p>ah ok</p>



<a name="451221719"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451221719" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451221719">(Jul 13 2024 at 20:12)</a>:</h4>
<p>So will older basic-cli work with these changes? I think not</p>



<a name="451221889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451221889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451221889">(Jul 13 2024 at 20:14)</a>:</h4>
<p>Thought: <br>
Pass in an optional to alloc/dealloc size. If it is none, the allocator can allocate a bit of extra space to store the size.</p>



<a name="451221980"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451221980" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451221980">(Jul 13 2024 at 20:14)</a>:</h4>
<p>Old basic CLI will work with size on heap except for dirList. I think that is the only effect that will break</p>



<a name="451222070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451222070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451222070">(Jul 13 2024 at 20:15)</a>:</h4>
<p>This change only affects lists of refcounted things (list list, list str, dict str, set str).</p>



<a name="451222493"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451222493" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451222493">(Jul 13 2024 at 20:19)</a>:</h4>
<p>I'll see if it breaks the roc build scripts, but it sounds like it wont which makes things easier. </p>
<p>I definitely would prefer we keep the current 0.12.0 basic-cli release (even if it stays in pre-release), and jump to 0.13 with this update, builtin task, and refactor host.</p>



<a name="451222747"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451222747" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451222747">(Jul 13 2024 at 20:21)</a>:</h4>
<p>Is there any chance we could make another branch on roc that includes both this and task as builtin changes?</p>



<a name="451225029"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451225029" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451225029">(Jul 13 2024 at 20:42)</a>:</h4>
<p>Personally, I would just merge them into main, main is unstable and that is fine. If we need, we can delay nightlies or explicitly tell users to pin to the nightly from yesterday until everything else is ready.</p>



<a name="451226463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451226463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451226463">(Jul 13 2024 at 21:06)</a>:</h4>
<p>yeah I think it's fine to merge now and disable nightlies temporarily</p>



<a name="451226652"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451226652" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451226652">(Jul 13 2024 at 21:09)</a>:</h4>
<p>that way nobody who happens to try out roc for the first time has a bad experience</p>



<a name="451226734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451226734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451226734">(Jul 13 2024 at 21:10)</a>:</h4>
<p>(and based on multiple people joining Zulip daily, people trying out Roc every day seems to be a thing that now happens!)</p>



<a name="451331751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451331751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451331751">(Jul 14 2024 at 07:57)</a>:</h4>
<ul>
<li>roc <a href="https://github.com/lukewilliamboswell/roc/releases/tag/glue-0.2">glue package</a> release</li>
<li><a href="https://github.com/lukewilliamboswell/roc-glue-code-gen/releases/download/0.4.0/E6x8uVSMI0YQ9CgpMww6Cj2g3BlN1lV8H04UEZh_-QA.tar.br">roc-glue-code-gen</a> release</li>
<li><a href="https://github.com/lukewilliamboswell/roc-wasm4/pull/27">roc-wasm4</a> updated</li>
</ul>



<a name="451332081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332081">(Jul 14 2024 at 08:01)</a>:</h4>
<p>For roc-wasm4 -- I had to downgrade back to zig 0.11.0 from 0.12.0. I started trying to update the builtins to 0.13.0 and thought I might contribute that back but got stuck on some non-trivial things I wasn't sure how to change. I could get through the many </p>
<div class="codehilite"><pre><span></span><code>package/zig-builtins/str.zig:1946:9: note: consider using &#39;const&#39;
package/zig-builtins/str.zig:1962:9: error: local variable is never mutated
</code></pre></div>
<p>But things like below seemed too important and so I stopped.</p>
<div class="codehilite"><pre><span></span><code>package/zig-builtins/dec.zig:317:62: error: expected error union type, found &#39;u128&#39;
        const self_u128 = @as(u128, @intCast(@abs(self_i128) catch {
</code></pre></div>
<p><a href="/user_uploads/22008/cz66Pe__2BaddgfCugszz8ht/Screenshot-2024-07-14-at-18.00.15.png">Screenshot-2024-07-14-at-18.00.15.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/cz66Pe__2BaddgfCugszz8ht/Screenshot-2024-07-14-at-18.00.15.png" title="Screenshot-2024-07-14-at-18.00.15.png"><img src="/user_uploads/22008/cz66Pe__2BaddgfCugszz8ht/Screenshot-2024-07-14-at-18.00.15.png"></a></div><p>I would really like it if we could upgrade roc to 0.12.0 or 0.13.0 soon. <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="451332300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332300">(Jul 14 2024 at 08:04)</a>:</h4>
<p>Probably depends on updating inkwell and llvm</p>



<a name="451332306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332306">(Jul 14 2024 at 08:04)</a>:</h4>
<p>Should be quite doable though</p>



<a name="451332417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332417">(Jul 14 2024 at 08:06)</a>:</h4>
<p>Also, how do I fix this?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0277</span><span class="p">]:</span><span class="w"> </span><span class="nc">the</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="err">`</span><span class="n">Header</span><span class="p">:</span><span class="w"> </span><span class="nc">RocRefcounted</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">satisfied</span>
<span class="w">   </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">roc_host</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">760</span><span class="p">:</span><span class="mi">14</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">760</span><span class="w"> </span><span class="o">|</span><span class="w">     </span><span class="n">headers</span><span class="p">:</span><span class="w"> </span><span class="nc">RocList</span><span class="o">&lt;</span><span class="n">Header</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="o">|</span><span class="w">              </span><span class="o">^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="err">`</span><span class="n">RocRefcounted</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">implemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">Header</span><span class="err">`</span>
<span class="w">    </span><span class="o">|</span>
<span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">help</span><span class="p">:</span><span class="w"> </span><span class="nc">the</span><span class="w"> </span><span class="n">following</span><span class="w"> </span><span class="n">other</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="err">`</span><span class="n">RocRefcounted</span><span class="err">`</span><span class="p">:</span>
<span class="w">              </span><span class="p">()</span>
<span class="w">              </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">)</span>
<span class="w">            </span><span class="n">and</span><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="n">others</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">required</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="err">`</span><span class="n">RocList</span><span class="err">`</span>
</code></pre></div>



<a name="451332460"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332460" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332460">(Jul 14 2024 at 08:06)</a>:</h4>
<p>Header is </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Header</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="nc">RocStr</span><span class="p">,</span>
<span class="w">    </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="nc">RocStr</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="451332476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332476">(Jul 14 2024 at 08:07)</a>:</h4>
<p>Is there a way to auto derive like we would in Roc?</p>



<a name="451332610"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332610" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332610">(Jul 14 2024 at 08:09)</a>:</h4>
<p>Glue should generate correctly for that type</p>



<a name="451332638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332638">(Jul 14 2024 at 08:09)</a>:</h4>
<p>Anyway, it should be super simple for that type </p>
<p>Recounted true<br>
Inc increments both strings<br>
Dec decrements both strings</p>



<a name="451332703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332703">(Jul 14 2024 at 08:10)</a>:</h4>
<p>There is no glue in basic-cli anymore... so I had a crack </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">roc_std</span><span class="p">::</span><span class="n">RocRefcounted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Header</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">dec</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">dec</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>I think I figured it out</p>



<a name="451332713"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332713" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332713">(Jul 14 2024 at 08:10)</a>:</h4>
<p>Theoretically it could auto derive, but I don't know how to write an auto derive macro in rust</p>



<a name="451332714"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332714" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332714">(Jul 14 2024 at 08:10)</a>:</h4>
<p>Thank you rust-analyser</p>



<a name="451332740"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332740" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332740">(Jul 14 2024 at 08:10)</a>:</h4>
<p>Yeah, perfect impl</p>



<a name="451332743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332743">(Jul 14 2024 at 08:10)</a>:</h4>
<p>And we've killed RocDict?</p>



<a name="451332761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332761">(Jul 14 2024 at 08:11)</a>:</h4>
<p>I think you may have mentioned it before, the plan is to do them later?</p>



<a name="451332774"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332774" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332774">(Jul 14 2024 at 08:11)</a>:</h4>
<p>It was being used in <code>roc_fx_envDict</code></p>



<a name="451332776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332776">(Jul 14 2024 at 08:11)</a>:</h4>
<p>The <code>roc_std</code> type was totally wrong and dict changed a lot (plus is mildly complex)</p>



<a name="451332794"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332794" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332794">(Jul 14 2024 at 08:11)</a>:</h4>
<p>My current thought is pass in a list of tuples and have roc turn it into a dict</p>



<a name="451332854"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451332854" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451332854">(Jul 14 2024 at 08:12)</a>:</h4>
<p>Ok, I'll switch it to a <code>RocList&lt;(RocStr, RocStr)&gt;</code> I guess</p>



<a name="451333044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451333044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451333044">(Jul 14 2024 at 08:15)</a>:</h4>
<p>Ok, I've got basic-cli working again</p>



<a name="451333329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451333329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451333329">(Jul 14 2024 at 08:17)</a>:</h4>
<p>I'll see if I can make a pre-release by cross-compiling from my mac</p>



<a name="451333389"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451333389" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451333389">(Jul 14 2024 at 08:18)</a>:</h4>
<p>Because it's broken, we have to manually step through the build steps by hand</p>



<a name="451333457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451333457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451333457">(Jul 14 2024 at 08:19)</a>:</h4>
<p>Though I'm not sure if we need the prebuilt surgical host's for CI to pass on main roc. I think we do which could be a challenge</p>



<a name="451333561"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451333561" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451333561">(Jul 14 2024 at 08:20)</a>:</h4>
<p>I don't think the main roc repo tests depended on anything in basic cli that broke.</p>



<a name="451333825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451333825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451333825">(Jul 14 2024 at 08:25)</a>:</h4>
<p>Curious... I can run basic scripts, but the build.roc script in basic cli isn't happy using the current 0.12.0</p>
<div class="codehilite"><pre><span></span><code>$ roc build.roc
roc_app_binary(53940,0x201c58c00) malloc: *** error for object 0x60000348f698: pointer being freed was not allocated
roc_app_binary(53940,0x201c58c00) malloc: *** set a breakpoint in malloc_error_break to debug
</code></pre></div>



<a name="451334115"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451334115" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451334115">(Jul 14 2024 at 08:29)</a>:</h4>
<p>NVM -- figured that out. PEBKAC</p>



<a name="451335802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451335802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451335802">(Jul 14 2024 at 08:52)</a>:</h4>
<ul>
<li>basic-cli <a href="https://github.com/roc-lang/basic-cli/pull/194">refactor-host branch</a> now includes the updates for latest roc. <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span>  </li>
</ul>
<p>CI is failing because it needs a pre-release of basic-cli to pass. </p>
<p><span class="user-mention" data-user-id="361169">@Anton</span> I added a new file in this PR called <code>jump-start.sh</code> which enables us to build basic-cli locally from a breaking change in roc.</p>



<a name="451336408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451336408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451336408">(Jul 14 2024 at 09:02)</a>:</h4>
<p><span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span> </p>
<div class="codehilite"><pre><span></span><code>$ roc --prebuilt-platform examples/args.roc div -n 5 -d 20
roc_app_binary(61803,0x201c58c00) malloc: Heap corruption detected, free list is damaged at 0x60000229c110
*** Incorrect guard value: 185616897523983
roc_app_binary(61803,0x201c58c00) malloc: *** set a breakpoint in malloc_error_break to debug
</code></pre></div>



<a name="451336462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451336462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451336462">(Jul 14 2024 at 09:02)</a>:</h4>
<p>For some reason, the args example is broken</p>



<a name="451336750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451336750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451336750">(Jul 14 2024 at 09:06)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> or if anyone else would like to reproduce this, you just need to checkout the <a href="https://github.com/roc-lang/basic-cli/pull/194">refactor-host</a> branch on basic-cli, then run <code>bash jump-start.sh</code>, and then  <code>roc --prebuilt-platform examples/args.roc div -n 5 -d 20</code>.</p>



<a name="451338284"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451338284" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451338284">(Jul 14 2024 at 09:28)</a>:</h4>
<p>I've staged the update for <a href="https://github.com/lukewilliamboswell/basic-ssg/pull/5">basic-ssg</a> and tested locally with everything looking good. However, if the above arg issue is serious and we need to regenerate/change roc_std then I will have to do another release so I'll just wait to see how we go with basic-cli.</p>



<a name="451345479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451345479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451345479">(Jul 14 2024 at 11:03)</a>:</h4>
<p>I think this may be something we missed </p>
<div class="codehilite"><pre><span></span><code>error[E0599]: no method named `inc` found for struct `RocResult` in the current scope
</code></pre></div>



<a name="451347114"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451347114" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451347114">(Jul 14 2024 at 11:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0277]: the trait bound `SQLiteBindings: RocRefcounted` is not satisfied
</code></pre></div>



<a name="451368393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451368393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451368393">(Jul 14 2024 at 17:03)</a>:</h4>
<p>Oh, looks like there may be some missed updates on initializing lists in RocRefcounted</p>



<a name="451368527"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451368527" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451368527">(Jul 14 2024 at 17:05)</a>:</h4>
<p>Ah, specifically with <code>elems_with_capacity</code></p>



<a name="451368601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451368601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451368601">(Jul 14 2024 at 17:06)</a>:</h4>
<p>hmm, nvm, that looks correct</p>



<a name="451370111"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451370111" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451370111">(Jul 14 2024 at 17:35)</a>:</h4>
<p>Probably need to run things with valgrind and debug. Trying to fix my linux machine. Broke it yesterday with an update</p>



<a name="451386898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451386898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451386898">(Jul 14 2024 at 22:43)</a>:</h4>
<p>So will debug more later, but looks like we have a refcounting bug that is leading to use after free. Maybe in List.walkTry? Maybe in somt other builtin running before the call to List.walkTry. That or I missed that heapsize offset somewhere.</p>



<a name="451467830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Host%20Refcounting%20of%20List%20with%20Size%20on%20Heap/near/451467830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Host.20Refcounting.20of.20List.20with.20Size.20on.20Heap.html#451467830">(Jul 15 2024 at 10:47)</a>:</h4>
<blockquote>
<p>and jump to 0.13 with this update, builtin task, and refactor host.</p>
</blockquote>
<p>Would bundling all of them not make debugging much harder because there are many more possible causes for a bug?</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>surgical macho linker · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html">surgical macho linker</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="491076591"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491076591" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491076591">(Dec 28 2024 at 09:13)</a>:</h4>
<p>Hey folks! Over the last couple of weeks, I have been looking at the macho surgical linker, on and off. I haven't yet got anywhere near it actually doing a full surgical link on arm64 macOS but I have done some refactors and cleanups to the macho linker. My question now is, would it be something that you would like to see upstreamed in its current form? I will abstain from submitting a PR just yet, however you can have a look at the my WIP here -&gt; <a href="https://github.com/roc-lang/roc/compare/main...kubkon:roc:macho-surgery?expand=1">https://github.com/roc-lang/roc/compare/main...kubkon:roc:macho-surgery?expand=1</a></p>



<a name="491076688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491076688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491076688">(Dec 28 2024 at 09:14)</a>:</h4>
<p>Oh, and a fun fact, I did manage to get Roc as a Rust project to link with <a href="https://github.com/kubkon/bold"><code>bold</code> linker</a> (used to be <code>zld</code> a while back) ;-)</p>



<a name="491079197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491079197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491079197">(Dec 28 2024 at 09:53)</a>:</h4>
<p>So awesome to hear you've been looking at this. It will be really nice to have surgical linking for macos some day.</p>
<p>What would be easiest for you? Are you looking for feedback on your work so far? Is there anything we could do to help you with this?</p>
<p>I've tried to poke around at the surgical likner, but it's like black magic to me. I've always asked <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> to help guide me through getting things set up for the surgical linker from the platform development side of things. I'm sure he will be interested in your work here. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="491081431"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491081431" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491081431">(Dec 28 2024 at 10:27)</a>:</h4>
<p>Let me flip the question and ask what is better for you and the project? I would prefer to submit small incremental PRs so that they are easier to review and other folks can contribute if they feel like it too. Also, I have only limited time to work on this which would probably align itself best with doing small incremental bits at a time.</p>



<a name="491082841"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491082841" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491082841">(Dec 28 2024 at 10:50)</a>:</h4>
<p>Yeah, I think smaller incremental PRs are always a good approach.</p>



<a name="491083306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491083306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491083306">(Dec 28 2024 at 10:58)</a>:</h4>
<p>Nice, so lemme try and clean the changeset up a little bit (I have some of my own debugging inserts floating around which probably should not make it into the repo) and submit a PR and go through the review process. Does that sound good?</p>



<a name="491104772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491104772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491104772">(Dec 28 2024 at 16:46)</a>:</h4>
<p>Yeah, happy to accept anything. The project is really just a port of the elf surgical linker and definitely is not working currently. Anything to push it towards working or to clean it up is highly welcome.</p>



<a name="491119554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491119554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491119554">(Dec 28 2024 at 20:54)</a>:</h4>
<p>Alright then, PR up and ready for review <a href="https://github.com/roc-lang/roc/pull/7424">https://github.com/roc-lang/roc/pull/7424</a> I have highlighted bits I was unsure of in comments.</p>



<a name="491209657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491209657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491209657">(Dec 29 2024 at 21:43)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> what if instead of having an env var for overriding <code>supported(..)</code> output and in particular <code>Target::MacArm64</code> arm to return <code>true</code> for development purposes, that function return an enum such that <code>supported(..) -&gt; SupportLevel</code> where <code>enum SupportLevel { Full, Dev, None }</code> and <code>SupportLevel::Full</code> would correspond to current <code>true</code>, <code>SupportLevel::None</code> to <code>false</code> and <code>SupportLevel::Dev</code> would allow enabling the surgical linker with a warning message that it is a work-in-progress, so don't expect much, or something like that.</p>



<a name="491210240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491210240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491210240">(Dec 29 2024 at 21:52)</a>:</h4>
<p><code>SupportLevel::Dev</code> could be <code>SupportLevel::Wip</code> or something</p>



<a name="491211721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491211721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491211721">(Dec 29 2024 at 22:16)</a>:</h4>
<p>Sure. As long as it falls back on the legacy linker when the files are available that sounds fine.</p>



<a name="491212098"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491212098" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491212098">(Dec 29 2024 at 22:23)</a>:</h4>
<p>Lemme cook up a PR and discuss it there over something more concrete then.</p>



<a name="491212544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491212544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491212544">(Dec 29 2024 at 22:30)</a>:</h4>
<p>PR is up <a href="https://github.com/roc-lang/roc/pull/7433">https://github.com/roc-lang/roc/pull/7433</a></p>



<a name="491258508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491258508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491258508">(Dec 30 2024 at 09:16)</a>:</h4>
<p>Pushed two more commits that I think solve the immediate issue. The tl;dr is:  if no user <code>--linker</code> flag was specified and linker support level is below <code>SupportLevel::Full</code> (i.e., <code>SupportLevel::Wip</code> or <code>SupportLevel::None</code>) we fall back to the legacy linker by default. If <code>--linker=surgical</code> was specified <em>and</em> <code>SupportLevel::Wip</code> then we will warn the user and use the surgical linker.</p>



<a name="491283262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491283262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491283262">(Dec 30 2024 at 13:38)</a>:</h4>
<p><span class="user-mention" data-user-id="455461">@Jakub Konka</span> I had to revert <a href="https://github.com/roc-lang/roc/pull/7424">PR#7424</a> (in <a href="https://github.com/roc-lang/roc/pull/7435">PR#7435</a>), you can reproduce the <a href="https://github.com/roc-lang/roc/actions/runs/12539613708/job/34968119194">test failures</a> with <code>cargo test --release -p roc_cli cli_tests</code>.</p>
<p>The PR got merged even though CI failed because we've been having a lot of flaky failures on macos lately and this appeared to be a typical flaky failure and so the merge was forced due to human error.</p>



<a name="491289572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491289572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491289572">(Dec 30 2024 at 14:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/stream/395097-compiler-development/topic/surgical.20macho.20linker/near/491283262">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="455461">Jakub Konka</span> I had to revert <a href="https://github.com/roc-lang/roc/pull/7424">PR#7424</a> (in <a href="https://github.com/roc-lang/roc/pull/7435">PR#7435</a>), you can reproduce the <a href="https://github.com/roc-lang/roc/actions/runs/12539613708/job/34968119194">test failures</a> with <code>cargo test --release -p roc_cli cli_tests</code>.</p>
<p>The PR got merged even though CI failed because we've been having a lot of flaky failures on macos lately and this appeared to be a typical flaky failure and so the merge was forced due to human error.</p>
</blockquote>
<p>No probs, I will resubmit the changes with <a href="https://github.com/roc-lang/roc/issues/7433">#7433</a> which actually fixes macos tests after my PR got merged.</p>



<a name="491295788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491295788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491295788">(Dec 30 2024 at 15:34)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> Revert of revert with test fixes up in <a href="https://github.com/roc-lang/roc/pull/7436">https://github.com/roc-lang/roc/pull/7436</a></p>



<a name="491302468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491302468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491302468">(Dec 30 2024 at 16:32)</a>:</h4>
<p>I noticed that signed commits are required in the repo - I will make sure to sign my commits from now on. Apologies for not having done that till now!</p>



<a name="491302766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491302766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491302766">(Dec 30 2024 at 16:35)</a>:</h4>
<p>No worries. Happens to everyone.</p>



<a name="491319512"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491319512" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491319512">(Dec 30 2024 at 19:21)</a>:</h4>
<p>I just realized this is a Surgical linker for Mach-O, not a in-some-way brawnier version of the surgical linker</p>



<a name="491319646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491319646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491319646">(Dec 30 2024 at 19:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/395097-compiler-development/topic/surgical.20macho.20linker/near/491319512">said</a>:</p>
<blockquote>
<p>I just realized this is a Surgical linker for Mach-O, not a in-some-way brawnier version of the surgical linker</p>
</blockquote>
<p>brawny == macho? Bit of a stretch but maybe? ;-)</p>



<a name="491319705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491319705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491319705">(Dec 30 2024 at 19:23)</a>:</h4>
<p>jokes aside, it's my fault, I just tend to drop the hyphen</p>



<a name="491319809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491319809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491319809">(Dec 30 2024 at 19:24)</a>:</h4>
<p>I never type the hyphen either. Also, it is a more macho problem. Mach-o is simply more complex than elf.</p>



<a name="491338289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491338289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491338289">(Dec 30 2024 at 22:47)</a>:</h4>
<p>another PR up and ready for review - all commits signed this time! <a href="https://github.com/roc-lang/roc/pull/7441">https://github.com/roc-lang/roc/pull/7441</a></p>



<a name="491671025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491671025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491671025">(Jan 02 2025 at 21:57)</a>:</h4>
<p>So I was toying with the idea of using <code>gimli-rs/object</code>'s provided <code>LoadCommandIterator</code> to iterate over the load commands but given how the preprocess step really wants very low-level control over what to copy over, I think that's a bad idea. Nevertheless, if anyone's interested what that entails, here's where it would lead: <a href="https://github.com/roc-lang/roc/compare/main...kubkon:roc:use-macho-iterator">kubkon:roc:use-macho-iterator</a></p>



<a name="491673320"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491673320" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491673320">(Jan 02 2025 at 22:19)</a>:</h4>
<p>I'll definitely have to take a look. Also, is gimli fully functional for macho now. I feel like when I first started the macho surgical linker it was still missing a lot of macho.</p>



<a name="491675032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491675032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491675032">(Jan 02 2025 at 22:35)</a>:</h4>
<p>It seems like it is. I am still unclear if it's worth using though (for parsing) rather than sticking to <code>load_struct_in_place</code> with some helpers sprinkled around. gimli uses <code>Cow&lt;..&gt;</code> under-the-hood for reading which means it should be zero-cost, however since surgical linker is a lot about manipulation at a byte level, it may be not worth it. Dunno, I cannot make up my mind... yet <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="491675181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491675181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491675181">(Jan 02 2025 at 22:37)</a>:</h4>
<p>Anyhow, I'd be curious to learn what you think about it!</p>



<a name="491945325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491945325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491945325">(Jan 05 2025 at 07:34)</a>:</h4>
<p>I'm trying to grasp the surgical linker pipeline in the compiler, and I don't seem to understand what the purpose of <code>libapp.dylib</code> actually is. So far I see that we emit it in <code>spawn_surgical_host_build_thread</code> where we:</p>
<ol>
<li>emit <code>libapp.dylib</code></li>
<li>rebuild host (presumably somehow related to step 1., but dunno how exactly just yet)</li>
<li>preprocess host from 2. by stripping dynamic refs to <code>libapp.dylib</code> and symbols it exports<br>
Could anyone shed some more light at what the flow of data here is, and how the steps are interconnected at the compiler/link level?</li>
</ol>



<a name="491945391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491945391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491945391">(Jan 05 2025 at 07:35)</a>:</h4>
<p>While here I've also noticed that the number of dynamic system dependencies of <code>libapp.dylib</code> and rebuilt host are different (ignoring host dependence on <code>libapp.dylib</code>) which is surprising as somehow I thought they should match but I am probably not understanding the build process well yet.</p>



<a name="491946310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491946310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491946310">(Jan 05 2025 at 07:50)</a>:</h4>
<p>Does this diagram help at all? <a href="https://github.com/roc-lang/basic-cli/blob/main/basic-cli-build-steps.png">https://github.com/roc-lang/basic-cli/blob/main/basic-cli-build-steps.png</a></p>
<div class="message_inline_image"><a href="https://github.com/roc-lang/basic-cli/blob/main/basic-cli-build-steps.png"><img src="https://uploads.zulipusercontent.net/046409e258551c0a14ac7af9015189e6df9080c5/68747470733a2f2f7261772e67697468756275736572636f6e74656e742e636f6d2f726f632d6c616e672f62617369632d636c692f6d61696e2f62617369632d636c692d6275696c642d73746570732e706e67"></a></div>



<a name="491946344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491946344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491946344">(Jan 05 2025 at 07:51)</a>:</h4>
<p>My understanding is that libapp.dylib is all the roc stuff gets compiled to a shared library.</p>



<a name="491946365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491946365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491946365">(Jan 05 2025 at 07:51)</a>:</h4>
<p>Then it gets linked to the host, so the host executable is expecting to be dynamically linked to a shared library.</p>



<a name="491946448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491946448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491946448">(Jan 05 2025 at 07:53)</a>:</h4>
<p>Then the "preprocess" host step takes the compiled host executable (which is dynamically linking the roc app), and does some surgical magic to it so we can swap out those parts later with a different roc app (that still uses the same platform/API).</p>



<a name="491946526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491946526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491946526">(Jan 05 2025 at 07:54)</a>:</h4>
<p>This is my layman's understanding. <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> is definitely the expert on how it works on a technical level.</p>



<a name="491949507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491949507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491949507">(Jan 05 2025 at 08:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/surgical.20macho.20linker/near/491946344">said</a>:</p>
<blockquote>
<p>My understanding is that libapp.dylib is all the roc stuff gets compiled to a shared library.</p>
</blockquote>
<p>"all the roc stuff" is that a dummy app or similar written in roc?</p>



<a name="491950082"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491950082" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491950082">(Jan 05 2025 at 08:53)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="515757">@Luke Boswell</span> ! I had a look at that diagram but it still left some questions unanswered. Perhaps if we go over an example from <code>basic-cli</code>? Say I am trying to run <code>examples/echo.roc</code>. In it, I specify <code>platform/main.roc</code> which corresponds to the <code>cli</code> <em>platform</em>, correct? So there are 3 components at play here: user program (<code>echo.roc</code>) &lt;-&gt; platform (<code>cli</code>) &lt;-&gt; host (??). </p>
<p>The first node (user program) is expected to be pluggable by the user as far as I understand, but what does it compile too? An object file or an executable that links against <code>platform + host</code>, or something else?</p>
<p>Next, <code>platform &lt;-&gt; host</code> are prebuilt. Am I correct here? And this is where <code>host</code>initially is linking dynamically against <code>libapp.dylib</code> which really is <code>libplatform.dylib</code>. We then surgically <em>merge</em> <code>host</code> with <code>libapp.dylib</code> to emit <code>platform</code> as a dynamically linked executable (on macOS, since we always link at the very least against <code>libSystem.dylib</code>). How am I doing so far?</p>



<a name="491951989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491951989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491951989">(Jan 05 2025 at 09:25)</a>:</h4>
<p>Thanks for the chat <span class="user-mention" data-user-id="455461">@Jakub Konka</span>, let me know if I can help in any other way.</p>



<a name="491972029"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491972029" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491972029">(Jan 05 2025 at 14:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/395097-compiler-development/topic/surgical.20macho.20linker/near/491951989">said</a>:</p>
<blockquote>
<p>Thanks for the chat <span class="user-mention silent" data-user-id="455461">Jakub Konka</span>, let me know if I can help in any other way.</p>
</blockquote>
<p>Thank you! It was very helpful!</p>



<a name="491975684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491975684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491975684">(Jan 05 2025 at 15:31)</a>:</h4>
<p>Ok, so I'm sure we mix up our own wording sometimes, but here are some details.</p>
<p>Firstly, naming.  A roc executable is generated from 2 parts, the platform (basic-cli) and the application (echo.roc + any packages it uses). The platform is made out of two parts, the host (the part written in another language, rust for basic cli) and the roc API.</p>



<a name="491975788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491975788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491975788">(Jan 05 2025 at 15:32)</a>:</h4>
<p>From a compilation and linking perspective, it is probably best to think of the split instead as host (again, the part in another language like rust or zig) and everything else (which is all written in roc)</p>



<a name="491975838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491975838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491975838">(Jan 05 2025 at 15:32)</a>:</h4>
<p>The goal with the surgical linker was to get as close to a completed executable as possible without compiling anything in a <code>.roc</code> file. Then to simply hack in the roc part of the code.</p>



<a name="491975892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491975892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491975892">(Jan 05 2025 at 15:33)</a>:</h4>
<p>The closest thing to a completed executable, is a dynamically linked executable where the host is completely compiled, and it attaches to a shared libraries that contains all the roc code.</p>



<a name="491975940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491975940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491975940">(Jan 05 2025 at 15:34)</a>:</h4>
<p>That is what we have the host compile into</p>



<a name="491976103"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491976103" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491976103">(Jan 05 2025 at 15:36)</a>:</h4>
<p>We have it link to a dummy shared library that just has all the correct headings to look like a correct roc app + platform for apis. We also could just emit a shared library containing a real application.</p>



<a name="491976389"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491976389" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491976389">(Jan 05 2025 at 15:40)</a>:</h4>
<p>Oh, also, to clarify, one of your questions above, all <code>.roc</code> files compile into a single object file.</p>



<a name="491976537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491976537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491976537">(Jan 05 2025 at 15:42)</a>:</h4>
<p>Ok, so the process is essentially:</p>
<ol>
<li>generate a dummy dynamic library (could also just generate a shared library from a real app)</li>
<li>create a host that dynamically links to the library above</li>
<li>Preprocess the host by rip out all the dynamic parts and recording useful info for completing linking quickly</li>
<li>compile the roc code to an object file</li>
<li>merge that with the preprocessed host fixing up everything</li>
</ol>



<a name="491976596"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491976596" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491976596">(Jan 05 2025 at 15:43)</a>:</h4>
<p>generating the dummy shared lib was required to get host languages to generate a complete executables</p>



<a name="491998179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/491998179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#491998179">(Jan 05 2025 at 21:00)</a>:</h4>
<p>That's excellent, thank you <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> and <span class="user-mention" data-user-id="515757">@Luke Boswell</span> I think the bit I was missing was the fact that the host is dynamically linking against a dynamic library so that the linker synthesises all relevant bits which the surgical linker can then substitute with static references to an Roc app. As discussed with Luke already, this implies that any Roc app that is compiled into the host must not depend on any additional libc/framework symbols. This however does not match what I've seen so far for MachO where the app does contain references to <code>_setjmp</code> and <code>_longjmp</code>. I haven't investigated why or where that happens but will post it here once I find out more.</p>



<a name="492008123"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492008123" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492008123">(Jan 05 2025 at 23:37)</a>:</h4>
<p>I thought they were only used for tests and not regular roc....hmm</p>



<a name="492008219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492008219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492008219">(Jan 05 2025 at 23:38)</a>:</h4>
<p>And a lot of the other functions we force the platform to implement like memcpy, malloc, etc</p>



<a name="492041949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492041949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492041949">(Jan 06 2025 at 06:23)</a>:</h4>
<p>I will try digging in. It definitely feels like a bug somewhere now that I know how's it supposed to work under-the-hood.</p>



<a name="492052488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492052488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492052488">(Jan 06 2025 at 07:52)</a>:</h4>
<p>Looks like genuine roc (glue or builtins?) symbols missing from the platform<br>
<a href="/user_uploads/22008/YNZmFioivBZNJ-ShEaIw9Rw-/Screenshot-2025-01-06-at-08.49.52.png">Screenshot 2025-01-06 at 08.49.52.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/YNZmFioivBZNJ-ShEaIw9Rw-/Screenshot-2025-01-06-at-08.49.52.png" title="Screenshot 2025-01-06 at 08.49.52.png"><img data-original-dimensions="1518x366" src="/user_uploads/thumbnail/22008/YNZmFioivBZNJ-ShEaIw9Rw-/Screenshot-2025-01-06-at-08.49.52.png/840x560.webp"></a></div>



<a name="492053601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492053601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492053601">(Jan 06 2025 at 08:00)</a>:</h4>
<p>oh ok, these seemingly come from <code>crates/compiler/builtins/bitcode/src/main.zig</code></p>



<a name="492055443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492055443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492055443">(Jan 06 2025 at 08:12)</a>:</h4>
<p>to my inexperienced eyes it seems to match <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> intuition - <code>_setjmp</code> and <code>_longjmp</code> are referenced by <code>__roc_force_setjmp</code> and <code>__roc_force_longjmp</code> which seem to be force into a translation unit (when using llvm) in loop <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/gen_llvm/src/llvm/build.rs#L1056-L1083">https://github.com/roc-lang/roc/blob/main/crates/compiler/gen_llvm/src/llvm/build.rs#L1056-L1083</a></p>



<a name="492055585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492055585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492055585">(Jan 06 2025 at 08:13)</a>:</h4>
<p>yep, confirmed, commenting out <code>__roc_force_setjmp</code> and <code>__roc_force_longjmp</code> from the <code>must_keep</code> list does not emit refs to <code>setjmp</code> and <code>longjmp</code></p>



<a name="492055624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492055624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492055624">(Jan 06 2025 at 08:13)</a>:</h4>
<p><a href="/user_uploads/22008/StgcJBdQLch7Uak2Vb3sZF2d/Screenshot-2025-01-06-at-09.13.35.png">Screenshot 2025-01-06 at 09.13.35.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/StgcJBdQLch7Uak2Vb3sZF2d/Screenshot-2025-01-06-at-09.13.35.png" title="Screenshot 2025-01-06 at 09.13.35.png"><img data-original-dimensions="1522x230" src="/user_uploads/thumbnail/22008/StgcJBdQLch7Uak2Vb3sZF2d/Screenshot-2025-01-06-at-09.13.35.png/840x560.webp"></a></div>



<a name="492055778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492055778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492055778">(Jan 06 2025 at 08:14)</a>:</h4>
<p>so the remaining question is why this happens in the first place especially if it is assumed they should only be kept for test binaries (or similar)</p>



<a name="492056019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492056019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492056019">(Jan 06 2025 at 08:16)</a>:</h4>
<p>on re-reading the comments tho, are they really tests only? it seems they are special functions that should resolve to an LLVM intrinsic but for some reason they do not, at least not on <code>aarch64-macos</code></p>



<a name="492057840"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492057840" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492057840">(Jan 06 2025 at 08:29)</a>:</h4>
<p>I haven't checked what happens on <code>x86_64-linux</code> - could anyone confirm for me if <code>setjmp</code> is present in <code>echo.o</code> built with <code>roc build --no-link echo.roc</code>? Perhaps it gets lowered to an actual in-place implementation by llvm, whereas on aarch64 (maybe only macos) to a libc call?</p>



<a name="492058436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492058436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492058436">(Jan 06 2025 at 08:33)</a>:</h4>
<p>I am not sure what Brendan meant by "tests" by presumably building tests in a roc app will require a platform with some extended functionality which provides PLT entries for those symbols (on arm64 macos), so perhaps when not building tests we could either:<br>
1) check if we are indeed building a test app and check for <code>__roc_force_setjmp</code> only then, or<br>
2) always link apps with <code>-undefined dynamic_lookup</code></p>



<a name="492058592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492058592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492058592">(Jan 06 2025 at 08:34)</a>:</h4>
<p>The latter carries the risk of not erroring out on undefined symbols that were meant to be resolved at link time though.</p>



<a name="492058639"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492058639" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492058639">(Jan 06 2025 at 08:34)</a>:</h4>
<p><span class="user-mention" data-user-id="281543">@Folkert de Vries</span> may be able to answer these questions</p>



<a name="492144483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492144483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492144483">(Jan 06 2025 at 17:03)</a>:</h4>
<p>Yeah, I have a few notes:</p>
<ol>
<li>when I said only used in tests, I mean that is is only used when calling <code>roc test ...</code> (which doesn't actually link to a platform at all).</li>
<li>It looks like we only emit setjmp and longjmp with the builtins for <code>aarch64</code>...no idea why.</li>
<li>The must keep is supposed to stop them from getting dead code eliminated too early. I thought llvm still removed them later if they were unused.</li>
</ol>



<a name="492145760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492145760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492145760">(Jan 06 2025 at 17:10)</a>:</h4>
<p>Looking into this a bit more, I think a lot of this is actually outdated infrastructure</p>



<a name="492145806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492145806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492145806">(Jan 06 2025 at 17:10)</a>:</h4>
<p>nowadays panicking in roc calls the platform exposed <code>roc_panic</code>.</p>



<a name="492145855"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492145855" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492145855">(Jan 06 2025 at 17:10)</a>:</h4>
<p>It used to be that panicking in roc was done via <code>setjmp</code> <code>longjmp</code></p>



<a name="492146573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492146573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492146573">(Jan 06 2025 at 17:15)</a>:</h4>
<p>Hmm...I'm not actually sure if <code>setjmp</code> and <code>longjmp</code> are needed in roc anymore at all. That said, it appears in a lot of locations due to old infra that I think can get ripped out.</p>



<a name="492148171"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492148171" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492148171">(Jan 06 2025 at 17:23)</a>:</h4>
<p>That said, I still think some of our tests use <code>setjmp</code> <code>longjmp</code>. So unwinding this may be a bit complex...</p>



<a name="492148651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492148651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492148651">(Jan 06 2025 at 17:25)</a>:</h4>
<p>I don't think they should be needed unless we decide to make <code>roc_panic</code> automatically get translated into the original function call returning a <code>Result</code> to the host</p>



<a name="492148844"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492148844" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492148844">(Jan 06 2025 at 17:26)</a>:</h4>
<p>that said, I know that for <code>nea</code> Folkert has also implemented architecture-specific setjmp and longjmp using assembly that doesn't require a libc dependency, so that could be an option if we decide to do that</p>



<a name="492148862"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492148862" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492148862">(Jan 06 2025 at 17:26)</a>:</h4>
<p>either way, I don't think we should need to link them</p>



<a name="492150684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492150684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492150684">(Jan 06 2025 at 17:35)</a>:</h4>
<p>Yeah, I think they are just still used in many places across the compiler. Like all the gen-tests use them. Also <code>roc test</code> may use them, but not 100% sure.</p>



<a name="492151170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492151170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492151170">(Jan 06 2025 at 17:38)</a>:</h4>
<p>i think roc test uses it for expects</p>



<a name="492151191"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492151191" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492151191">(Jan 06 2025 at 17:38)</a>:</h4>
<p>and they are used for gen tests to catch errors</p>



<a name="492152866"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492152866" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492152866">(Jan 06 2025 at 17:48)</a>:</h4>
<p>hm, why would inline expects need to longjmp? <span aria-label="face with raised eyebrow" class="emoji emoji-1f928" role="img" title="face with raised eyebrow">:face_with_raised_eyebrow:</span></p>



<a name="492152892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492152892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492152892">(Jan 06 2025 at 17:48)</a>:</h4>
<p>they don't halt the test, they just record that the test should fail, report the failure, and keep going</p>



<a name="492152915"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492152915" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492152915">(Jan 06 2025 at 17:48)</a>:</h4>
<p>and top-level expects should just run the code to completion</p>



<a name="492156071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492156071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492156071">(Jan 06 2025 at 18:06)</a>:</h4>
<p>For roc test, I think it is used to return back to main execution on a panic.</p>
<p>So run top level expect, It fails due to hitting a panic. Long jump to code to print the failure and continue to the next top level expect</p>



<a name="492156275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492156275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492156275">(Jan 06 2025 at 18:07)</a>:</h4>
<p>For gen_test, I think we should be able to implement <code>roc_panic</code> in "platform". And it can use setjmp and longjmp. Avoiding needing it in the builtins.</p>



<a name="492157446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492157446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492157446">(Jan 06 2025 at 18:15)</a>:</h4>
<p>ahh that makes sense</p>



<a name="492185424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492185424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492185424">(Jan 06 2025 at 21:08)</a>:</h4>
<p>So here's my understanding of the situation based on the discussion above:</p>
<ul>
<li>emitting libc calls to <code>setjmp</code> and <code>longjmp</code> is <code>aarch64</code>-specific</li>
<li>they are referenced from <code>__roc_force_setjmp</code> and <code>__roc_force_longjmp</code> which are Roc's builtins used exclusively for tests - in particular, <code>roc_panic</code> in tests is implemented using them</li>
<li>they are now obsolete and can be phased out (but this seems like a non-trivial task)</li>
<li>hitting this issue in the arm64 Mach-O linker has nothing to do with Mach-O and it would surface in <code>aarch64-linux</code> surgical linker too but this one is not implemented yet</li>
<li>because <code>__roc_force_setjmp</code> and <code>__roc_force_longjmp</code> are builtins/compiler-rt symbols for the Roc compiler and Roc has a very specialised compiler pipeline, compiler-rt is always inlined in the sense that it is never linked in as a static archive but rather always part of the emitted <code>app.o</code> object file - this then makes emitting those symbols conditionally depending if <code>roc test</code> was called non-trivial to implement)</li>
</ul>



<a name="492185915"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492185915" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492185915">(Jan 06 2025 at 21:11)</a>:</h4>
<p>Since bullet point 3 is going to happen sooner or later, I am thinking of simply special-casing those two externs (<code>setjmp</code> and <code>longjmp</code>) in the linker and simply ignoring them. If nothing apart from <code>__roc_force_setjmp</code> and <code>__roc_force_longjmp</code> is referencing them, then it should not impact linking in any way. This way, once bullet point 3 lands, updating the linker amounts to removing this special casing and nothing else. Is this a viable temporary workaround?</p>



<a name="492193649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492193649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492193649">(Jan 06 2025 at 21:59)</a>:</h4>
<p>Proposed change to the macho linker <a href="https://github.com/roc-lang/roc/pull/7474">https://github.com/roc-lang/roc/pull/7474</a></p>



<a name="492199612"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/492199612" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#492199612">(Jan 06 2025 at 22:37)</a>:</h4>
<p>That sounds good</p>



<a name="493030763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/493030763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#493030763">(Jan 10 2025 at 21:49)</a>:</h4>
<p>I don't think there is any need in shifting loadable segments in file offsets/memory when preprocessing host. Instead, it should be fine to rely on the linker to emit enough padding between the end of load commands and the start of the first section to insert the required Roc load commands. Then during surgical link we would put the segments after the last existing loadable segment but before the <code>__LINKEDIT</code> segment - <code>__LINKEDIT</code> segment always has to come last so there's nothing we can do about that anyhow.</p>
<p>Proposed changes <a href="https://github.com/roc-lang/roc/pull/7499">7499</a></p>



<a name="493030979"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/493030979" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#493030979">(Jan 10 2025 at 21:51)</a>:</h4>
<p>I wonder if elf has lower alignment constraints for this. I think with elf there was regularly not enough space (thus all the shifting)</p>



<a name="493031067"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/493031067" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#493031067">(Jan 10 2025 at 21:52)</a>:</h4>
<p>As a note, we may also need a few more sections eventually. <code>.data</code> and potentially both of <code>.tbss</code> and <code>.tdata</code></p>



<a name="493031093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/493031093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#493031093">(Jan 10 2025 at 21:52)</a>:</h4>
<p>Yeah, very possibly. For MachO this is so common to want to add new load commands that there is a linker flag for just that <code>-headerpad size</code>.</p>



<a name="493031144"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/surgical%20macho%20linker/near/493031144" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jakub Konka <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/surgical.20macho.20linker.html#493031144">(Jan 10 2025 at 21:53)</a>:</h4>
<p>Yeah, I expect more sections, but for the time being let's do something simple(r) and get it working first.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
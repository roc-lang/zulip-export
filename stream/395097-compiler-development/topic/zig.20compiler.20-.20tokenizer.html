<html>
<head><meta charset="utf-8"><title>zig compiler - tokenizer · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html">zig compiler - tokenizer</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="504243804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504243804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504243804">(Mar 08 2025 at 06:56)</a>:</h4>
<p>I'm just tinkering with tokenizing fuzzing bugs. Decided to pull into a separate thread to not clutter other discussions.</p>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> how would you expect a numeric base without any follow digits to tokenize?<br>
<code>0x.</code> for example. Should we generate some sort of malformed node or error if the base is not followed by a number?</p>
<p>Currently this is one of the tokenizer fuzzer failures and I was just trying to clean it up.</p>



<a name="504244258"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504244258" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504244258">(Mar 08 2025 at 07:02)</a>:</h4>
<p>example failure: <code>zig build repro-tokenize -- -b MHguMA== -v</code></p>



<a name="504292307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504292307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504292307">(Mar 08 2025 at 16:09)</a>:</h4>
<p>Yeah that looks malformed to me</p>



<a name="504451236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504451236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504451236">(Mar 10 2025 at 01:13)</a>:</h4>
<p>Found an issue from a fuzz crash. Made a small test that is failing, and investigating now. It tokenizes the <code>]</code> as a <code>CloseCurly</code> instead of an <code>CloseSquare</code>.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="k">try</span><span class="w"> </span><span class="n">testTokenization</span><span class="p">(</span>
<span class="w">        </span><span class="n">gpa</span><span class="p">,</span>
<span class="w">        </span><span class="sh">\\f{o,</span>
<span class="w">        </span><span class="sh">\\     ]</span>
<span class="w">        </span><span class="sh">\\</span>
<span class="w">        </span><span class="sh">\\foo =</span>
<span class="w">        </span><span class="sh">\\</span>
<span class="w">        </span><span class="sh">\\    "onmo %</span>
<span class="w">    </span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">Token</span><span class="p">.</span><span class="n">Tag</span><span class="p">{</span>
<span class="w">            </span><span class="p">.</span><span class="n">LowerIdent</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">OpenCurly</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">LowerIdent</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">Comma</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">Newline</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">CloseSquare</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">Newline</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">LowerIdent</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">OpAssign</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">Newline</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">StringStart</span><span class="p">,</span>
<span class="w">            </span><span class="p">.</span><span class="n">StringPart</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">);</span>
</code></pre></div>



<a name="504453882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504453882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504453882">(Mar 10 2025 at 01:43)</a>:</h4>
<p>Optimistically, I think that ought to detect the mismatched brackets, infer the intent was to have the correct closing bracket there, emit a message, and continue.</p>
<p>That said, it feels a bit more likely that that’s just an accident at this point.</p>



<a name="504462556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504462556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504462556">(Mar 10 2025 at 03:21)</a>:</h4>
<p>Yeah, you're correct. I hadn't noticed the Diagnostic was being correctly reported for Mismatched braces.</p>



<a name="504462610"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504462610" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504462610">(Mar 10 2025 at 03:22)</a>:</h4>
<p>I had a break for lunch, but almost finished re-wiring the way I'm dealing with Problems in the snapshots so these issues are surfaced easier.</p>



<a name="504584691"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504584691" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504584691">(Mar 10 2025 at 13:39)</a>:</h4>
<p>From your other post <span class="user-mention" data-user-id="515757">@Luke Boswell</span> :</p>
<div class="codehilite"><pre><span></span><code>~~~PROBLEMS
check.parse.tokenize.Diagnostic.Tag.AsciiControl
check.parse.tokenize.Diagnostic.Tag.MismatchedBrace
check.parse.tokenize.Diagnostic.Tag.UnclosedString
</code></pre></div>



<a name="504584791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504584791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504584791">(Mar 10 2025 at 13:39)</a>:</h4>
<p>Looks like it's there just fine.  We just don't seem to short circuit the input when we have tokenize errors</p>



<a name="504584830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504584830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504584830">(Mar 10 2025 at 13:39)</a>:</h4>
<p>I hope we do for parse errors</p>



<a name="504584986"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504584986" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504584986">(Mar 10 2025 at 13:40)</a>:</h4>
<p>THe invariant should be: For any fuzz input that has no tokenization or parse errors, it should have stable formatting</p>



<a name="504585023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504585023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504585023">(Mar 10 2025 at 13:40)</a>:</h4>
<p>And a stable AST</p>



<a name="504629236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504629236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504629236">(Mar 10 2025 at 16:07)</a>:</h4>
<p>We just call the parser directly passing in the source. It calls the tokenizer. Not sure where the tokenizer errors end up. But currently only the errors returned by parse are checked. This is where one global list of all errors that builds up with each new stage would be nice likely</p>



<a name="504688862"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504688862" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504688862">(Mar 10 2025 at 21:15)</a>:</h4>
<p>I think I agree that after a stage any stage errors should be added to a tagged union list of some sort and then the next stage can choose to proceed or not based on it being non-empty</p>



<a name="504689988"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504689988" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504689988">(Mar 10 2025 at 21:23)</a>:</h4>
<p>Yeah, may even switch on type of error. Cause we want to attempt to compile even with many classes of errors.</p>



<a name="504690214"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504690214" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504690214">(Mar 10 2025 at 21:24)</a>:</h4>
<p>I've done this in my latest PR for review. Probably needs adjustment, but its a start.</p>



<a name="504691372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504691372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504691372">(Mar 10 2025 at 21:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer/near/504688862">said</a>:</p>
<blockquote>
<p>I think I agree that after a stage any stage errors should be added to a tagged union list of some sort and then the next stage can choose to proceed or not based on it being non-empty</p>
</blockquote>
<p>Pretty much every kind of error should be continued from, the only places I can think of this not being true are:</p>
<ul>
<li>The file passed to <code>roc check/build/etc</code> not being found</li>
<li>The platform package not being found</li>
<li>The command being <code>roc build</code> and having type errors</li>
<li>The platform not receiving a valid "provides" function (or none at all)</li>
</ul>



<a name="504698461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504698461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504698461">(Mar 10 2025 at 22:20)</a>:</h4>
<p>There are definitely classes of malformed nodes for example where it would not make sense to continue...</p>



<a name="504698508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504698508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504698508">(Mar 10 2025 at 22:20)</a>:</h4>
<p>Not to mention illegal tokens</p>



<a name="504703909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504703909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504703909">(Mar 10 2025 at 23:00)</a>:</h4>
<p>Can you give an example of the former? Illegal tokens could make sense, but I think we'd still want to allow running the code with malformed nodes, it'd just crash quickly</p>



<a name="504704068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704068">(Mar 10 2025 at 23:01)</a>:</h4>
<p>It feels like these are cases where we'd now be deciding "surely the user doesn't want to run code that is malformed" for them</p>



<a name="504704275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704275">(Mar 10 2025 at 23:02)</a>:</h4>
<p>But they should be free to decide for themselves</p>



<a name="504704300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704300">(Mar 10 2025 at 23:02)</a>:</h4>
<p>If I have a malformed expression in a list literal, how do I run that?</p>



<a name="504704322"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704322" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704322">(Mar 10 2025 at 23:02)</a>:</h4>
<p>I crash</p>



<a name="504704334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704334">(Mar 10 2025 at 23:03)</a>:</h4>
<p>Just like I do for a type error</p>



<a name="504704363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704363">(Mar 10 2025 at 23:03)</a>:</h4>
<p>Canonicalization will generate a runtime error for that whole node</p>



<a name="504704407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704407">(Mar 10 2025 at 23:03)</a>:</h4>
<p>Sure but that seems a little silly to me</p>



<a name="504704473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704473">(Mar 10 2025 at 23:04)</a>:</h4>
<p>I’m using a strongly typed, compiled language to shift errors to the left</p>



<a name="504704490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704490">(Mar 10 2025 at 23:04)</a>:</h4>
<p>What if that function is barely called?</p>



<a name="504704515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704515">(Mar 10 2025 at 23:04)</a>:</h4>
<p>I think you might be missing the second paradigm of using Roc</p>



<a name="504704528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704528">(Mar 10 2025 at 23:04)</a>:</h4>
<p>I’d still want to know closer to when I wrote it</p>



<a name="504704531"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704531" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704531">(Mar 10 2025 at 23:04)</a>:</h4>
<p>The first is the one we both like and mainly care about</p>



<a name="504704547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704547">(Mar 10 2025 at 23:04)</a>:</h4>
<p>Then when it just happens to get called - maybe a week later</p>



<a name="504704592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704592">(Mar 10 2025 at 23:05)</a>:</h4>
<p>Oh, I understand the disconnect</p>



<a name="504704642"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704642" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704642">(Mar 10 2025 at 23:05)</a>:</h4>
<p>The runtime error would be paired with a compiler error that would give a non-zero exit code on <code>roc build</code></p>



<a name="504704743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704743">(Mar 10 2025 at 23:06)</a>:</h4>
<p>You can still use the binary, but you'd know immediately that you have a positive number of errors and probably should fix those</p>



<a name="504704777"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704777" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704777">(Mar 10 2025 at 23:06)</a>:</h4>
<p>During dev, you want to be able to run anyway</p>



<a name="504704792"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704792" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704792">(Mar 10 2025 at 23:06)</a>:</h4>
<p>And 99% of people will fix the error</p>



<a name="504704821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704821">(Mar 10 2025 at 23:07)</a>:</h4>
<p>But doing we really want to block the 1% of people that want to run anyway?</p>



<a name="504704885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704885">(Mar 10 2025 at 23:07)</a>:</h4>
<p>If we decide against supporting that, then I truly have misaligned on "always inform, never block"</p>



<a name="504704926"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504704926" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504704926">(Mar 10 2025 at 23:08)</a>:</h4>
<p>yeah that's idea is "always inform, never block" - report the compiler error so you know there's a problem, but always let you have the choice to run it anyway</p>



<a name="504705016"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504705016" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504705016">(Mar 10 2025 at 23:08)</a>:</h4>
<p>you shift left while also simultaneously not shifting left if you don't want to. it's like Schrödinger's Shift Left</p>



<a name="504709644"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504709644" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504709644">(Mar 10 2025 at 23:51)</a>:</h4>
<p>Got it.  I'm just not the target audience for that paradigm.  I get enough runtime errors writing JavaScript</p>



<a name="504724589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/504724589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#504724589">(Mar 11 2025 at 02:14)</a>:</h4>
<p>really simple example of where this is nice at even the lexing level: I'm trying to merge in a branch and see if it fixes what I'm working on. There are merge conflicts in a part of the code base I'm not working on, creating syntax errors with all their <code>======</code>s etc.</p>
<p>I would still like to be able to run tests on my unrelated part of the code base, so I can tell where it's worth my time to fix those merge conflicts or whether that branch doesn't fix my problem. If the merge conflicts block me from trying it out, I have no choice but to fix them first before I know whether that'll be a waste of time!</p>



<a name="505042945"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505042945" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505042945">(Mar 12 2025 at 06:46)</a>:</h4>
<p>After some digging, I found the Newline tokens don't have region information set. I think this might be the cause of challenges getting the correct offsets for AST nodes.</p>
<p>From what I've discovered so far, I think it's because we are using the offset field to store the indentation. I'm wondering if we could use the <code>extra</code> field for this instead. </p>
<div class="codehilite"><pre><span></span><code>pub fn pushNewline(self: *TokenizedBuffer, indent: u32) void {
    self.tokens.append(self.env.gpa, .{
        .tag = .Newline,
        .offset = indent, // store the indent in the offset field
        .extra = .{ .length = 0 },
    }) catch |err| exitOnOom(err);
}
</code></pre></div>



<a name="505042986"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505042986" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505042986">(Mar 12 2025 at 06:47)</a>:</h4>
<p>(deleted) -- i think that example is just going to cause more confusion</p>



<a name="505043350"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505043350" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505043350">(Mar 12 2025 at 06:50)</a>:</h4>
<p>Yeah, instead of having an offset, newlines store the indentation of the following line</p>



<a name="505043375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505043375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505043375">(Mar 12 2025 at 06:50)</a>:</h4>
<p>So I think the parser needs to make sure not to use locations from newlines</p>



<a name="505043413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505043413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505043413">(Mar 12 2025 at 06:50)</a>:</h4>
<p>It needs to take the token before or after the newline depending on its goal</p>



<a name="505043516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505043516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505043516">(Mar 12 2025 at 06:51)</a>:</h4>
<p>But yeah, probably could move indents to the extra field instead</p>



<a name="505043609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505043609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505043609">(Mar 12 2025 at 06:52)</a>:</h4>
<p>That sounds cleaner. Especially since we have the space anyway for it.</p>



<a name="505043909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505043909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505043909">(Mar 12 2025 at 06:54)</a>:</h4>
<p>Yeah, I'm just starting with <code>module []</code> and trying to figure out why the region for that isn't what I expect. </p>
<p>I think the issue is that <code>self.expect(.CloseSquare) catch { ...}</code> calls <code>advance</code> which moves <code>self.pos</code> forward n steps (we don't know how many) until the next non-newline token. So after parsing the module header, we set the region to be the start of the next non-newline token, instead of the end of the <code>]</code>.</p>



<a name="505044018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505044018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505044018">(Mar 12 2025 at 06:55)</a>:</h4>
<p>I have an idea which might fix it</p>



<a name="505046850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505046850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505046850">(Mar 12 2025 at 07:12)</a>:</h4>
<p>Actually I found the fix, change <code>_ = self.parseCollectionSpan</code> to <code>const end = self.parseCollectionSpan</code>, and use that for the region. <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="505285825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505285825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505285825">(Mar 13 2025 at 00:53)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> how do you think we should handle something like <code>0u8.0</code> in the tokenizer?</p>
<p>Currently, we convert it into <code>111.1</code> which leads to it retokenizing as a float which fails. I'm debating using the extra field of the token to store the suffix. Would be an enum of <code>none</code>, <code>u8</code>, <code>i8</code>, etc. We could actually still store the length as well assuming we limit int literals to less than 2^28 characters.</p>



<a name="505285959"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505285959" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505285959">(Mar 13 2025 at 00:54)</a>:</h4>
<p>exact repro for context: <code>zig build repro-tokenize -- -b MHU4LjA= -v</code></p>



<a name="505289925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505289925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505289925">(Mar 13 2025 at 01:20)</a>:</h4>
<p>Also, is <code>.7</code> a valid float? I assume we should just make it a float and then reformat it. Though I could also see it mapping to a recoverable malformed node for missing the leading zero.</p>



<a name="505293518"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505293518" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505293518">(Mar 13 2025 at 01:48)</a>:</h4>
<p>I think <code>.7</code> should not be valid</p>



<a name="505293535"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505293535" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505293535">(Mar 13 2025 at 01:48)</a>:</h4>
<p>I think <code>.7</code> should not be valid</p>



<a name="505293946"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505293946" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505293946">(Mar 13 2025 at 01:51)</a>:</h4>
<p>I guess the question is how is it invalid. As in, if we see <code>.7</code>, I am 99% sure that we want the formatter to output <code>0.7</code>. so simply treating it as a valid float in the compiler without any sort of malformed node may be the best bet? I guess we should still push a message. That way we can raise a warning?</p>



<a name="505293990"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505293990" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505293990">(Mar 13 2025 at 01:51)</a>:</h4>
<p>I guess I'm not fully sure when we want a malformed node vs a message vs etc</p>



<a name="505295007"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505295007" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505295007">(Mar 13 2025 at 01:59)</a>:</h4>
<p>today <code>.7</code> is a tuple accessor function, but I believe we discussed how that syntax needs to change to <code>_.7</code></p>



<a name="505295042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505295042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505295042">(Mar 13 2025 at 01:59)</a>:</h4>
<p>so if it's not a tuple accessor, it seems fine to have it be a number literal</p>



<a name="505295068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505295068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505295068">(Mar 13 2025 at 01:59)</a>:</h4>
<p>but yeah I'd have the formatter add the <code>0</code></p>



<a name="505295895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505295895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505295895">(Mar 13 2025 at 02:05)</a>:</h4>
<p>totally forgot about tuple accessors</p>



<a name="505312717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505312717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505312717">(Mar 13 2025 at 04:02)</a>:</h4>
<p>I would expect <code>0u8.0</code> to be: 0u8 (an int literal), then a NoSpaceDotInt token</p>



<a name="505320154"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505320154" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505320154">(Mar 13 2025 at 05:06)</a>:</h4>
<p>Yeah, so the issue here is technically reprinting for the fuzzer. Gets turned into <code>111.1</code>.</p>



<a name="505323802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505323802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505323802">(Mar 13 2025 at 05:37)</a>:</h4>
<p>hmm, yeah, I think we need smarter number reprinting. Another example failure that is really the reprinting:<br>
<code>0o0.0</code> becomes <code>111.1</code>.  First parses as an int and then a NoSpaceDotInt. The second parses as a float.</p>



<a name="505589527"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505589527" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505589527">(Mar 14 2025 at 05:37)</a>:</h4>
<p>How do people feel about adding a <code>FileStart</code> token that is always the first, in the zero'th position?</p>
<p>For something like a <code>.missing_header</code> diagnostic, it would make more sense to attach that to the whole file than to a single token. Maybe there are other errors that apply to the whole file?</p>
<p>Or should we special case the error in this case and if something comes up in future that we want to apply for the whole file, we revisit?</p>



<a name="505589699"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505589699" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505589699">(Mar 14 2025 at 05:39)</a>:</h4>
<p>Here is a fuzz crash I was looking at. To get formatting stable, we will need to format something for these malformed nodes. </p>
<p>The question is what. </p>
<p>My first thought was just write out the original bytes. </p>
<div class="codehilite"><pre><span></span><code>~~~SOURCE
4o|
~~~PROBLEMS
PARSER: missing_header
PARSER: unexpected_token
~~~TOKENS
MalformedNumberBadSuffix(1:1-1:3),OpBar(1:3-1:4),EndOfFile(1:4-1:4),
~~~PARSE
(file (1:1-1:4)
    (malformed_header (1:1-1:3) &quot;missing_header&quot;)
    (malformed_expr (1:3-1:4) &quot;unexpected_token&quot;))
</code></pre></div>



<a name="505589754"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505589754" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505589754">(Mar 14 2025 at 05:39)</a>:</h4>
<p>I would start by just not formatting on failures like this</p>



<a name="505589819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505589819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505589819">(Mar 14 2025 at 05:40)</a>:</h4>
<p>You have problems, so don't format at all. Just stop after parse</p>



<a name="505589863"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505589863" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505589863">(Mar 14 2025 at 05:40)</a>:</h4>
<p>This is what I'm looking at... is this just a <code>repro-parse</code> specific thing then?</p>
<div class="codehilite"><pre><span></span><code>$ zig build repro-parse -- /private/tmp/corpus/default/crashes.2025-03-14-16:15:46/id:000003,sig:06,src:000007,time:57864030,execs:42508956,op:havoc,rep:4
Reading bytes for repro from /private/tmp/corpus/default/crashes.2025-03-14-16:15:46/id:000003,sig:06,src:000007,time:57864030,execs:42508956,op:havoc,rep:4
slices differ. first difference occurs at index 0 (0x0)

============ expected this output: =============  len: 2 (0x2)

[0]: check.parse.IR.Diagnostic{ .tag = check.parse.IR.Diagnostic.Tag.missing_header, .region = check.parse.IR.Region{ .start = 0, .end = 0 } }
[1]: check.parse.IR.Diagnostic{ .tag = check.parse.IR.Diagnostic.Tag.unexpected_token, .region = check.parse.IR.Region{ .start = 1, .end = 2 } }

============= instead found this: ==============  len: 0 (0x0)


================================================
</code></pre></div>



<a name="505589867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505589867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505589867">(Mar 14 2025 at 05:40)</a>:</h4>
<p>Long term, we do want to support formatting even with some problems, but that is likely to be a larger project (I guess you totally could take it on now if you want).</p>



<a name="505589956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505589956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505589956">(Mar 14 2025 at 05:41)</a>:</h4>
<p>Interesting. I assumed we were already doing that because it seems the fuzzer is checking things even with errors.</p>



<a name="505590121"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590121" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590121">(Mar 14 2025 at 05:42)</a>:</h4>
<p>It's not supported to</p>



<a name="505590243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590243">(Mar 14 2025 at 05:43)</a>:</h4>
<p>Root error starts here:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="n">std</span><span class="p">.</span><span class="n">testing</span><span class="p">.</span><span class="n">expectEqualSlices</span><span class="p">(</span><span class="n">IR</span><span class="p">.</span><span class="n">Diagnostic</span><span class="p">,</span><span class="w"> </span><span class="n">parse_ast</span><span class="p">.</span><span class="n">errors</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="n">_</span><span class="p">]</span><span class="n">IR</span><span class="p">.</span><span class="n">Diagnostic</span><span class="p">{})</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">error</span><span class="p">.</span><span class="n">ParseFailed</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>
</code></pre></div>
<p>Should bubble up through:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">formatted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="n">parseAndFmt</span><span class="p">(</span><span class="n">gpa</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">debug</span><span class="p">);</span>
</code></pre></div>
<p>Then should be ignored here:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="w">            </span><span class="k">error</span><span class="p">.</span><span class="n">ParseFailed</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// No issue. Just bad input we couldn't parse.</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">},</span>
</code></pre></div>



<a name="505590389"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590389" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590389">(Mar 14 2025 at 05:44)</a>:</h4>
<p>Ah I see. We're not pushing the errors into ModuleEnv yet.</p>



<a name="505590468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590468">(Mar 14 2025 at 05:45)</a>:</h4>
<p>Oh, I don't think this checks module env errors yet, is that the issue?</p>



<a name="505590484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590484">(Mar 14 2025 at 05:45)</a>:</h4>
<p>Or maybe the opposite, we are pushing into the ModuleEnv but in the fuzzer it's still checking in the IR</p>



<a name="505590761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590761">(Mar 14 2025 at 05:47)</a>:</h4>
<p>This test case <code>4o|</code> is passing the fuzzer</p>



<a name="505590769"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590769" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590769">(Mar 14 2025 at 05:47)</a>:</h4>
<p>It just prints out a parse error</p>



<a name="505590853"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590853" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590853">(Mar 14 2025 at 05:48)</a>:</h4>
<p>Due to first pars failing, it exits early (and considers it a success)</p>



<a name="505590900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590900">(Mar 14 2025 at 05:48)</a>:</h4>
<p><code> zig build repro-parse -- -b NG98Cg== -v &amp;&amp; echo "all passed"</code></p>



<a name="505590957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590957">(Mar 14 2025 at 05:49)</a>:</h4>
<p>I guess that debug print had me confused. Thanks for explaining that</p>



<a name="505590969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590969">(Mar 14 2025 at 05:49)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ echo $?
0
</code></pre></div>



<a name="505590997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505590997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505590997">(Mar 14 2025 at 05:49)</a>:</h4>
<p>Maybe in verbose mode we should print out  a message to clarify that on first parse failure we just exit.</p>



<a name="505591100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505591100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505591100">(Mar 14 2025 at 05:50)</a>:</h4>
<p>That or maybe add a flag, that just uses some sort of mem eql instead of the testing version that prints on error</p>



<a name="505591139"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505591139" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505591139">(Mar 14 2025 at 05:50)</a>:</h4>
<p>Yeah, someone else is going to get tripped up on this too I'm sure</p>



<a name="505593788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505593788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505593788">(Mar 14 2025 at 06:13)</a>:</h4>
<p>How should we handle malformed tokens? here is an example.<br>
<a href="/user_uploads/22008/by5PH3_T0Sfze9Fza2lgKV74/Screenshot-2025-03-14-at-17.08.52.png">Screenshot 2025-03-14 at 17.08.52.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/by5PH3_T0Sfze9Fza2lgKV74/Screenshot-2025-03-14-at-17.08.52.png" title="Screenshot 2025-03-14 at 17.08.52.png"><img data-original-content-type="image/png" data-original-dimensions="724x406" src="/user_uploads/thumbnail/22008/by5PH3_T0Sfze9Fza2lgKV74/Screenshot-2025-03-14-at-17.08.52.png/840x560.webp"></a></div><p>That currently gives us these tokens -- there isn't anything for the NUL byte</p>
<div class="codehilite"><pre><span></span><code>~~~TOKENS
KwModule(1:1-1:7),OpenSquare(1:8-1:9),CloseSquare(1:9-1:10),Newline(1:1-1:1),
LowerIdent(2:1-2:4),EndOfFile(2:5-2:5),
~~~PARSE
(file (1:1-2:5)
    (module (1:1-1:10))
    (ident (2:1-2:4) "" "foo"))
</code></pre></div>



<a name="505593886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505593886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505593886">(Mar 14 2025 at 06:13)</a>:</h4>
<p>Oh wait.. I think I see other MalformedXXX tokens <span aria-label="man facepalming" class="emoji emoji-1f926-200d-2642" role="img" title="man facepalming">:man_facepalming:</span></p>



<a name="505594476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/505594476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#505594476">(Mar 14 2025 at 06:18)</a>:</h4>
<p>Might just be <code>.MalformedUnknownToken</code></p>



<a name="506533430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/506533430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#506533430">(Mar 18 2025 at 16:59)</a>:</h4>
<p>Random comment from Loris that I think is a good idea when we consider making more intensely optimized parsers via simd or only using start offset or similar:</p>
<p>Keep around the naive path. It makes a great fuzz oracle.</p>
<p>That might be a long time in the future, but something to consider for more invasive changes.</p>



<a name="506546428"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/506546428" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#506546428">(Mar 18 2025 at 18:00)</a>:</h4>
<p>Yes!</p>



<a name="506633605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/506633605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#506633605">(Mar 19 2025 at 04:51)</a>:</h4>
<p>Also good read on optimizing a tokenizer in zig: <a href="https://iridescence.me/2025/03/14/elyra-part-1-optimal-tokenization/">https://iridescence.me/2025/03/14/elyra-part-1-optimal-tokenization/</a></p>



<a name="528573087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528573087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528573087">(Jul 14 2025 at 01:45)</a>:</h4>
<p>Thus far the tokenizer is surprisingly resistant to my attemps to simd-ify individual functions, e.g. chompTrivia/etc). I kinda suspect llvm already doing a decent job of vectorizing the obvious things.</p>



<a name="528573718"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528573718" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528573718">(Jul 14 2025 at 01:57)</a>:</h4>
<p>I would be stunned it chomp trivia uses simd. Way too many conditionals for llvm to work through</p>



<a name="528573767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528573767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528573767">(Jul 14 2025 at 01:58)</a>:</h4>
<p>if you've got free time, the SIMDjson is my favorite paper I've ever read</p>



<a name="528573785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528573785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528573785">(Jul 14 2025 at 01:58)</a>:</h4>
<p>it's really mind-expanding and it's not something you can just pick up anytime</p>



<a name="528573799"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528573799" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528573799">(Jul 14 2025 at 01:58)</a>:</h4>
<p>really need time to digest it and play around with the concepts imo</p>



<a name="528573967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528573967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528573967">(Jul 14 2025 at 02:00)</a>:</h4>
<p>also since that paper was written, Daniel Lemire posted how to do one of the critical vectorized classification techniques mentioned in the paper: <a href="https://lemire.me/blog/2025/06/01/easy-vectorized-classification-with-z3/">https://lemire.me/blog/2025/06/01/easy-vectorized-classification-with-z3/</a></p>



<a name="528574642"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528574642" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528574642">(Jul 14 2025 at 02:10)</a>:</h4>
<p>Yeah, no simd in current <code>chompTrivia</code>: <a href="https://zig.godbolt.org/z/PGeveEP1d">https://zig.godbolt.org/z/PGeveEP1d</a></p>



<a name="528574668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528574668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528574668">(Jul 14 2025 at 02:11)</a>:</h4>
<p>Also double checked <a href="https://zig.godbolt.org/z/cnbfhqnfx">a simple function</a> to make sure that godbolt zig is setup to allow llvm to automatically add simd</p>



<a name="528574810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528574810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528574810">(Jul 14 2025 at 02:14)</a>:</h4>
<p>Also, I just realized that we limit the tokenizer to 128 diagnostics, but the rest of the stack is handled differently. Probably something to make consistent</p>



<a name="528576448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528576448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528576448">(Jul 14 2025 at 02:39)</a>:</h4>
<p>Of note, I just use tracy to plot the number of bytes being consumed by chomp trivia. The max number of bytes consumed at once is 20 and most of the time, I think it is only 1 byte. So you have a very very short loop to take advantage of simd. (this is with one of my basic million line files).</p>



<a name="528576475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528576475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528576475">(Jul 14 2025 at 02:39)</a>:</h4>
<p>That makes the problem harder if only looking at that thin slice of the problem and not turning the whole parser to simd where you can be more consistent.</p>



<a name="528577822"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528577822" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528577822">(Jul 14 2025 at 03:05)</a>:</h4>
<p>If you look at something like <code>List.roc</code> the distribution is<br>
82% 1 char -&gt; simd probably makes this slower, in best case same (unless simd changes it to branchless then maybe faster, but still unlikely)<br>
8% 4 char<br>
5% 8 char<br>
3% 12 char<br>
1% 16 char<br>
&lt;1% 20 or 24 char</p>



<a name="528577850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528577850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528577850">(Jul 14 2025 at 03:05)</a>:</h4>
<p>I'm kinda confused why all of these are multiples of 4. (oh...that's tabbing via spaces, isn't it)</p>



<a name="528577932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528577932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528577932">(Jul 14 2025 at 03:07)</a>:</h4>
<p>Oh wait...sorry...that distribution is wrong, it missed the new line early exit from chompTrivia (so is probably missing every comment which ends in a newline)</p>



<a name="528579462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579462">(Jul 14 2025 at 03:39)</a>:</h4>
<p>Ok, corrected distributions:<br>
75% 1 char<br>
5% 4 char<br>
3% 8 char<br>
2% 3 char<br>
2% 12 char<br>
1% 7 char<br>
1% 10 char</p>
<p>~10% 13 to 90 char<br>
So these are the comments. Looks like ~1 sample for most things 10 to about 90 characters. (all of these definitely should see benefit from simd)</p>



<a name="528579539"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579539" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579539">(Jul 14 2025 at 03:40)</a>:</h4>
<p>But yeah, 75% 1 char means that simd will be hard to show value on this function alone. Cause 75% of the time we likely are doing more work because of simd.</p>



<a name="528579573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579573">(Jul 14 2025 at 03:41)</a>:</h4>
<p>Switching from the manual loop looking for newlines after comments to indexOfScalarPos instead (which is vectorized internally), seemed to have basically no difference (even a slight regression actually).</p>



<a name="528579613"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579613" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579613">(Jul 14 2025 at 03:42)</a>:</h4>
<p>What corpus are you using?</p>



<a name="528579644"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579644" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579644">(Jul 14 2025 at 03:42)</a>:</h4>
<p>Yeah, good point about doing the simd-ification at the level of the outer loop</p>



<a name="528579652"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579652" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579652">(Jul 14 2025 at 03:42)</a>:</h4>
<p>That distribution is just from <code>List.roc</code>. I wanted to see roughly what a normal (but highly commented file) would map to.</p>



<a name="528579666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579666">(Jul 14 2025 at 03:42)</a>:</h4>
<p>Cause <code>List.roc</code> is approximately the best case.</p>



<a name="528579777"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528579777" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528579777">(Jul 14 2025 at 03:45)</a>:</h4>
<blockquote>
<p>Switching from the manual loop looking for newlines after comments to indexOfScalarPos instead (which is vectorized internally), seemed to have basically no difference (even a slight regression actually).</p>
</blockquote>
<p>Might turn into a case where it ends up being hardware/dataset dependent for if it is a win. Might also only be a win for cpus that are in performance mode rather than standard power management settings.</p>
<p>One of the really hard parts of simd is that if only a small part of a program is simd, even if that part is faster, it might cause enough heat that the cpu down clocks. That then leads to all the rest of the program running slower. This is part of the reason why just having a tiny bit of simd can often fail.</p>



<a name="528580210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580210">(Jul 14 2025 at 03:53)</a>:</h4>
<p>Does zig have simd intrinsics?</p>



<a name="528580352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580352">(Jul 14 2025 at 03:55)</a>:</h4>
<p><code>@Vector</code> I think is guaranteed to map to simd.</p>



<a name="528580367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580367">(Jul 14 2025 at 03:55)</a>:</h4>
<p>At least it is the intended type to use to get simd.</p>



<a name="528580407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580407">(Jul 14 2025 at 03:56)</a>:</h4>
<p>The basic simd stuff like <code>@Vector/@select/etc</code> is sufficient for a lot of cases, but I don't see any of the table lookup stuff (e.g. vqtbl4q_u8)</p>



<a name="528580409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580409">(Jul 14 2025 at 03:56)</a>:</h4>
<p>Oh, though also yes under <a href="https://ziglang.org/documentation/master/std/#std.simd">std.simd</a></p>



<a name="528580607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580607">(Jul 14 2025 at 03:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer/near/528579573">said</a>:</p>
<blockquote>
<p>Switching from the manual loop looking for newlines after comments to indexOfScalarPos instead (which is vectorized internally), seemed to have basically no difference (even a slight regression actually).</p>
</blockquote>
<p>Just tested this on my M1 mac I see just under an 8% gain in performance for tokenizing the 1 million lines of code duplicated version of List.roc (and that is on battery, though plug in makes no difference)</p>



<a name="528580870"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580870" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580870">(Jul 14 2025 at 04:02)</a>:</h4>
<p>For tokenizing normal <code>List.roc</code>, I see a 3% gain, but that may be noise.</p>



<a name="528580900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528580900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528580900">(Jul 14 2025 at 04:02)</a>:</h4>
<p>runs so fast that it might be other things causing the perf change.</p>



<a name="528581715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/528581715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#528581715">(Jul 14 2025 at 04:15)</a>:</h4>
<p>I think maybe my current benchmark is too small</p>



<a name="529392838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529392838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529392838">(Jul 18 2025 at 05:29)</a>:</h4>
<p>I finally figured out how to an almost-fully-vectorized version of _most_ of the tokenizer (in particular, excluding comments and strings)</p>



<a name="529392926"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529392926" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529392926">(Jul 18 2025 at 05:30)</a>:</h4>
<p><a href="https://github.com/joshuawarner32/roc/blob/improve-tokenize/tokenize_experimental.zig">https://github.com/joshuawarner32/roc/blob/improve-tokenize/tokenize_experimental.zig</a></p>



<a name="529392962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529392962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529392962">(Jul 18 2025 at 05:30)</a>:</h4>
<p>For a baseline, on my machine the current tokenizer does about 250 megabytes a second</p>



<a name="529393017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393017">(Jul 18 2025 at 05:31)</a>:</h4>
<p>If I don't try to _store_ the tokenized results - just leave them in the computed bitsets, this one gets ~700 mbps</p>



<a name="529393035"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393035" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393035">(Jul 18 2025 at 05:31)</a>:</h4>
<p>... but when I do store, the perf tanks :/</p>



<a name="529393053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393053">(Jul 18 2025 at 05:32)</a>:</h4>
<p>It only gets ~140 mbps</p>



<a name="529393101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393101">(Jul 18 2025 at 05:32)</a>:</h4>
<p>I have a suspicion avx512 instructions may be more conducive to this than neon</p>



<a name="529393184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393184">(Jul 18 2025 at 05:33)</a>:</h4>
<p>If someone can figure out how to do <a href="https://github.com/joshuawarner32/roc/blob/improve-tokenize/tokenize_experimental.zig#L250">this</a> faster... that's the main bottleneck.</p>



<a name="529393283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393283">(Jul 18 2025 at 05:35)</a>:</h4>
<p>Also note that this is not capturing any info about idents/nums/etc - and for example is completely omitting ident interning for instance.</p>



<a name="529393319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393319">(Jul 18 2025 at 05:35)</a>:</h4>
<p>Ident interning is the slowest part of the current tokenizer, and removing that brings its perf up to ~375 mbps or so</p>



<a name="529393399"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393399" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393399">(Jul 18 2025 at 05:36)</a>:</h4>
<p>Oh and this one is missing keyword checking too</p>



<a name="529393482"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393482" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393482">(Jul 18 2025 at 05:37)</a>:</h4>
<p>Fun experiment. <span aria-label="racecar" class="emoji emoji-1f3ce" role="img" title="racecar">:racecar:</span></p>



<a name="529393525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393525">(Jul 18 2025 at 05:37)</a>:</h4>
<p>Yep, and I learned some things!</p>



<a name="529393696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393696">(Jul 18 2025 at 05:39)</a>:</h4>
<p>I think the actual answer is to do substantially less simd stuff and break out quicker into regular code</p>



<a name="529393788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529393788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529393788">(Jul 18 2025 at 05:40)</a>:</h4>
<p>It's unclear as of yet whether this idea of processing things in chunks, 64 bytes at a time has any legs.</p>



<a name="529495308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529495308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529495308">(Jul 18 2025 at 16:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="453336">Joshua Warner</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer/near/529393035">said</a>:</p>
<blockquote>
<p>If I don't try to _store_ the tokenized results - just leave them in the computed bitsets, this one gets ~700 mbps<br>
... but when I do store, the perf tanks :/</p>
</blockquote>
<p>can't we turn them into parse IR nodes and not store the tokens at all?</p>



<a name="529495398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529495398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529495398">(Jul 18 2025 at 16:41)</a>:</h4>
<p>in other words, we materialize parse IR nodes but we never actually construct a full list of tokens; they only exist emphemerally in these 64B chunks (give or take 1 extra node for lookahead or something if necessary)</p>



<a name="529495514"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529495514" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529495514">(Jul 18 2025 at 16:42)</a>:</h4>
<p>this would also mean we could just keep a running total of "current region" and only actually store <code>Region</code> nodes in memory when it's time to create an actual AST nodes</p>



<a name="529495752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529495752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529495752">(Jul 18 2025 at 16:44)</a>:</h4>
<p>Ah - so the parser is directly reading from this bitset representation? <img alt=":think-spin:" class="emoji" src="https://avatars.zulip.com/22008/emoji/images/8dd6d877.gif" title="think-spin"></p>



<a name="529495807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529495807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529495807">(Jul 18 2025 at 16:44)</a>:</h4>
<p>yep!</p>



<a name="529496066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496066">(Jul 18 2025 at 16:46)</a>:</h4>
<p>basically have the parser be a function that's called like "chomp token" and it takes the current parser state, the current byte position in the source code, the byte length of the token, and maybe optionally the next token if we need to lookahead</p>



<a name="529496165"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496165" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496165">(Jul 18 2025 at 16:47)</a>:</h4>
<p>so we only ever have one 64B bitset worth of tokens in memory at a time (again give or take an extra token for lookahead)</p>



<a name="529496220"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496220" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496220">(Jul 18 2025 at 16:47)</a>:</h4>
<p>Hmm, why invert the control of the parser like that?</p>



<a name="529496288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496288">(Jul 18 2025 at 16:48)</a>:</h4>
<p>I think this could be done with the parser pulling from the tokenizer rather than the tokenizer pushing to the parser</p>



<a name="529496335"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496335" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496335">(Jul 18 2025 at 16:48)</a>:</h4>
<p>Given the complex recursion going on in the parser, it'll be much better from a code perspective to have that be driving things</p>



<a name="529496823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496823">(Jul 18 2025 at 16:51)</a>:</h4>
<p>I think we will need at least two tokens of lookahead actually materialized</p>



<a name="529496852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496852">(Jul 18 2025 at 16:52)</a>:</h4>
<p>(not in the bitset)</p>



<a name="529496888"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496888" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496888">(Jul 18 2025 at 16:52)</a>:</h4>
<p>Otherwise lookahead becomes very complicated</p>



<a name="529496976"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529496976" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529496976">(Jul 18 2025 at 16:52)</a>:</h4>
<p>There are cases where we need to check what's after the immediate next token, and we may need to do that repeatedly so we don't want to do linear-time search thru the bitset repeatedly.</p>



<a name="529497276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529497276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529497276">(Jul 18 2025 at 16:55)</a>:</h4>
<p>sure, either way</p>



<a name="529497364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529497364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529497364">(Jul 18 2025 at 16:56)</a>:</h4>
<p>I mean another way to think of "lookahead" is like "I'm not ready to proceed yet, so just write down the token temporarily and give me the next one"</p>



<a name="529497508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529497508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529497508">(Jul 18 2025 at 16:57)</a>:</h4>
<p>so when you need to lookahead multiple tokens, what that means in practice is that you start building up a list of tokens in memory - but just the ones you actually need, not materializing the entire token list - and then after you're ready to go back and process the original one, then you continue going through that list until it's exhausted, and then you're done and ready to go back to the non-materialized token stream</p>



<a name="529497545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529497545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529497545">(Jul 18 2025 at 16:57)</a>:</h4>
<p>so in practice I assume you'd end up materializing way way less than today</p>



<a name="529500419"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529500419" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529500419">(Jul 18 2025 at 17:20)</a>:</h4>
<p>this is also relevant to:</p>
<p><span class="user-mention silent" data-user-id="584248">Kiryl Dziamura</span> <a href="#narrow/channel/316715-contributing/topic/Optimizing.20Tokenization.20vs.20Canonicalization/near/529437987">said</a>:</p>
<blockquote>
<p>I don't feel good about replacing region info with numeric data in <code>extra</code>. the other options are always pushing this data to a separate collection (as with interned), or extending token size which of course is a terrible idea.</p>
</blockquote>
<p>because it would mean we could store extra info that AST nodes want more directly and not have to move them around so much</p>



<a name="529508128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/529508128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#529508128">(Jul 18 2025 at 18:17)</a>:</h4>
<p>separately, I really want to get regions out of our string interner so we can just directly compare interned indices to know for sure whether the underlying strings are equal; that really comes up a lot in later stages of the compiler!</p>



<a name="534627534"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534627534" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534627534">(Aug 15 2025 at 09:56)</a>:</h4>
<p>Hi, I was looking to start contributing to the zig compiler, and looked through the tests to see what each part is doing. In the tokenizer I saw the following test and was confused:</p>
<div class="codehilite"><pre><span></span><code>try testTokenization(
        gpa,
        \\&quot;&quot;&quot;abc
        \\&quot;&quot;&quot;def
    ,
        &amp;[_]Token.Tag{ .MultilineStringStart, .StringPart, .Newline, .MultilineStringStart, .StringPart },
    );
</code></pre></div>
<p>I would have guessed this would tokenize to </p>
<div class="codehilite"><pre><span></span><code>{ .MultilineStringStart, .StringPart, .MultilineStringEnd, .LowerIdent }
</code></pre></div>
<p>Is this just me not understanding, or is this a bug? I could implement a fix.</p>



<a name="534627988"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534627988" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534627988">(Aug 15 2025 at 10:00)</a>:</h4>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span></p>



<a name="534633332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534633332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534633332">(Aug 15 2025 at 10:47)</a>:</h4>
<p>I think the new syntax for multi line strings is each line starts with <code>"""</code></p>



<a name="534633345"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534633345" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534633345">(Aug 15 2025 at 10:47)</a>:</h4>
<p>I can't find any good examples though</p>



<a name="534634092"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534634092" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534634092">(Aug 15 2025 at 10:53)</a>:</h4>
<p><a class="message-link" href="/#narrow/channel/304641-ideas/topic/multiline.20string.20syntax/near/499130632">#ideas &gt; multiline string syntax @ 💬</a></p>



<a name="534634128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534634128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534634128">(Aug 15 2025 at 10:53)</a>:</h4>
<p>I wouldn't say we came to a completely solid position... but my recollection wasn't too far off. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="534634379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534634379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534634379">(Aug 15 2025 at 10:56)</a>:</h4>
<p>I guess we just haven't implemented it yet. I'm sure Anthony would probably remember where we got to with that.</p>



<a name="534634873"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534634873" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534634873">(Aug 15 2025 at 11:00)</a>:</h4>
<p>Thanks for link to the discussion, I could not find it earlier. Reading that discussion, it kind of makes sense to use """ on each line.</p>



<a name="534642861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534642861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534642861">(Aug 15 2025 at 12:15)</a>:</h4>
<p>yeah I think <code>"""</code> at the start of each like is what we should do</p>



<a name="534642892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534642892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534642892">(Aug 15 2025 at 12:15)</a>:</h4>
<p>seems to have the best tradeoffs of all the options we discussed</p>



<a name="534654241"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534654241" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534654241">(Aug 15 2025 at 13:36)</a>:</h4>
<p>Yep, I think i just forgot to add multiline strings to the parser</p>



<a name="534654276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534654276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534654276">(Aug 15 2025 at 13:36)</a>:</h4>
<p>It's an easy add though</p>



<a name="534656609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534656609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534656609">(Aug 15 2025 at 13:50)</a>:</h4>
<p>I could try to add it.</p>



<a name="534660608"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534660608" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534660608">(Aug 15 2025 at 14:15)</a>:</h4>
<p>Should there be an additional multiline_string for the AST or should the string be reused?</p>



<a name="534664961"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534664961" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534664961">(Aug 15 2025 at 14:44)</a>:</h4>
<p>I think we want a separate AST node</p>



<a name="534668381"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534668381" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534668381">(Aug 15 2025 at 15:06)</a>:</h4>
<p>i agree</p>



<a name="534706262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/534706262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#534706262">(Aug 15 2025 at 20:02)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/issues/8200">#8200</a> Multiline string parsing seems to work, format has bugs I think, but I could probably fix those myself. But I would like to know what to do in Can. That's probably the point where it gets combined with normal strings?</p>



<a name="535315616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535315616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535315616">(Aug 20 2025 at 13:35)</a>:</h4>
<p>So my PR <a href="https://github.com/roc-lang/roc/issues/8200">#8200</a> introduced a bug (that fuzzer is crazy cool!):</p>
<div class="codehilite"><pre><span></span><code>$ zig build repro-parse -- -b bW9kdWxlW11sPSIiIiI= -v
Using bytes as base64 encoded repro: bW9kdWxlW11sPSIiIiI=
Original:
==========
module[]l=&quot;&quot;&quot;&quot;
==========

Formatted:
==========
module []
l = &quot;&quot;&quot;&quot;&quot;&quot;&quot;
==========
</code></pre></div>
<p>the original gets tokenized as <code>MultilineStringStart, StringPart(")</code>.<br>
But since this is a single line, the formatter adds <code>"""</code> as an <code>MultilineStringEnd</code>.<br>
But this then get's tokenized as <code>MultilineStringStart, MultilineStringEnd, StringStart</code>, which is obviously a problem.</p>
<p>So how should this be fixed?</p>
<ol>
<li>Improve the formatter to not add <code>"""</code> at the end, if it wasn`t there already?</li>
<li>Change the tokenizer to tokenize <code>"""""""</code> into  <code>MultilineStringStart, StringPart("),MultilineStringEnd</code>?</li>
<li>Both 1. and 2. ?</li>
<li>Remove the MultilineStringEnd feature all together?</li>
</ol>
<p>I think 2. would be good anyway, because if  <code>""""quotes" I want to escape"""</code> works, why shouldn't <code>"""I want to escape "quotes""""</code>?</p>



<a name="535332114"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535332114" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JRI98 <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535332114">(Aug 20 2025 at 14:51)</a>:</h4>
<p>To me, the existence of <code>MultilineStringEnd</code> is kind of confusing, because it ends up being optional.</p>



<a name="535380835"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535380835" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535380835">(Aug 20 2025 at 19:50)</a>:</h4>
<p>I think it might be useful for not having to escape quotes like <code>some_fn("""some "quotes " in "this" string""", other_var)</code>. However I have no idea how useful that is in practice. But to be honest, it's quite a nice feature in Python to be able to switch between double and single quotes to not have to escape the other, so people might miss it.</p>



<a name="535381199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535381199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535381199">(Aug 20 2025 at 19:53)</a>:</h4>
<p>You don't have to escape quotes already - except insofar as they don't come exactly at the end of the multiline string.</p>



<a name="535386159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535386159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535386159">(Aug 20 2025 at 20:34)</a>:</h4>
<p>I feel we likely should just not allow single line multiline strings. I feel it is more confusing...but just a rough opinion.</p>



<a name="535386722"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535386722" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535386722">(Aug 20 2025 at 20:39)</a>:</h4>
<p>It's not just single-line ones - it's how you indicate you don't want your string terminated by a newline</p>



<a name="535386829"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535386829" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535386829">(Aug 20 2025 at 20:40)</a>:</h4>
<p>e.g.</p>
<div class="codehilite"><pre><span></span><code>foo = &quot;&quot;&quot;line one
      &quot;&quot;&quot;line two, with trailing newline

bar = &quot;&quot;&quot;line one
      &quot;&quot;&quot;line two, without trailing newline&quot;&quot;&quot;
</code></pre></div>



<a name="535386885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535386885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535386885">(Aug 20 2025 at 20:40)</a>:</h4>
<p>I suppose we could adopt a different syntax for that - perhaps a trailing backslash instead?</p>



<a name="535386900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535386900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535386900">(Aug 20 2025 at 20:40)</a>:</h4>
<p>e.g. </p>
<div class="codehilite"><pre><span></span><code>bar = &quot;&quot;&quot;line one
      &quot;&quot;&quot;line two, without trailing newline\
</code></pre></div>



<a name="535386941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535386941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535386941">(Aug 20 2025 at 20:41)</a>:</h4>
<p>That's more generalizable to any line in the string, so seems maybe better?</p>



<a name="535387032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535387032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535387032">(Aug 20 2025 at 20:41)</a>:</h4>
<p>e.g. you could maybe do:</p>
<div class="codehilite"><pre><span></span><code>bar = &quot;&quot;&quot;line one \
      &quot;&quot;&quot;,still the same line!
</code></pre></div>



<a name="535387500"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535387500" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JRI98 <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535387500">(Aug 20 2025 at 20:45)</a>:</h4>
<p>In Zig, for example, the newline is added as part of starting the next line in a multiline string, as opposed to including the one at the end of the line <a href="https://ziglang.org/documentation/master/#Multiline-String-Literals">https://ziglang.org/documentation/master/#Multiline-String-Literals</a></p>



<a name="535387582"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535387582" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535387582">(Aug 20 2025 at 20:46)</a>:</h4>
<p>Ahhh interesting, so if you want a newline, you put a """ (with nothing after) on the next line. <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I could get behind that.</p>



<a name="535388833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535388833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535388833">(Aug 20 2025 at 20:56)</a>:</h4>
<p>Yeah, exactly that</p>



<a name="535388988"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535388988" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535388988">(Aug 20 2025 at 20:58)</a>:</h4>
<p>Also, I guess single line is technically fine, I guess I more suggest no termination.</p>
<p>So this is fine by me</p>
<div class="codehilite"><pre><span></span><code>foo = &quot;&quot;&quot;Single line multiline string
</code></pre></div>
<p>But this is not</p>
<div class="codehilite"><pre><span></span><code>bar(&quot;&quot;&quot;single line terminated multiline string&quot;&quot;&quot;)
</code></pre></div>



<a name="535389012"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535389012" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535389012">(Aug 20 2025 at 20:58)</a>:</h4>
<p>I guess that is my default preference</p>



<a name="535410177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535410177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535410177">(Aug 21 2025 at 00:53)</a>:</h4>
<p>I like using single line multi line strings so that I don’t have to escape quotes. Very convenient sometimes</p>



<a name="535426063"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535426063" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535426063">(Aug 21 2025 at 04:16)</a>:</h4>
<p>Maybe better to have a proper raw string syntax, to avoid escaping all together? e.g. with something like rust's <code>r#"foo"#</code> (with a variable number of #'s), lua's <code>[=[foo]=]</code> (with a variable number of ='s), etc.</p>



<a name="535427052"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535427052" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535427052">(Aug 21 2025 at 04:29)</a>:</h4>
<p>What is a single line multi line string?</p>



<a name="535427189"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535427189" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535427189">(Aug 21 2025 at 04:30)</a>:</h4>
<p>I guess the idea is that you include a string verbatim and the <code>"</code> don't need escaping</p>



<a name="535427328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535427328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535427328">(Aug 21 2025 at 04:31)</a>:</h4>
<p>Right, except it does need to be escaped if it's at the end of the string, which seems like a significant foot-gun. (in fact, that's the foot gun that started this convo!)</p>



<a name="535427523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535427523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535427523">(Aug 21 2025 at 04:32)</a>:</h4>
<p>Does the Zig approach with an extra <code>"""</code> solve this for us?</p>



<a name="535427590"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535427590" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535427590">(Aug 21 2025 at 04:32)</a>:</h4>
<div class="codehilite"><pre><span></span><code>foo = &quot;&quot;&quot;single line followed by a newline
      &quot;&quot;&quot;
</code></pre></div>



<a name="535427642"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535427642" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535427642">(Aug 21 2025 at 04:33)</a>:</h4>
<p>Yes and no. It removes the footgun, but it doesn't  solve <span class="user-mention" data-user-id="611722">@Isaac Van Doren</span> 's desire for a way to have a single-line string they don't need to escape quotes in.</p>



<a name="535439931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535439931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535439931">(Aug 21 2025 at 06:48)</a>:</h4>
<p>You can have single line "multiline" strings even without the MultilineStringEnd. You just cannot have anything after it in the same line, because it will be considered part of the line. </p>
<p>So declarations work, which is the main use case.</p>
<p>I think removing MultilineStringEnd is the way to go, and if I understand correctly this is the consensus here. I will do that when I get time.</p>



<a name="535484363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535484363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535484363">(Aug 21 2025 at 11:32)</a>:</h4>
<p>Yeah it doesn’t come up that often to need one on a single line with code after, just convenient every now and then. It doesn’t seem worth adding a new raw string syntax just to support that</p>



<a name="535659730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535659730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535659730">(Aug 22 2025 at 11:00)</a>:</h4>
<p>That fuzzer finds everything. So the next problem with the multiline strings is if they are inside any type of collection. The formatter adds a <code>,</code> at the end of every entry at the end of a line, which then becomes part of the string.</p>
<div class="codehilite"><pre><span></span><code>(
    &quot;&quot;&quot;Hello
    , &quot;there&quot;
)
</code></pre></div>
<p>formats to </p>
<div class="codehilite"><pre><span></span><code>(
    &quot;&quot;&quot;Hello,
    &quot;there&quot;,
)
</code></pre></div>
<p>which is a parser error.</p>
<p>Solution could be to allow multiline strings only in top level assignments, or have a special multiline string rule in the collection formatter.</p>



<a name="535662091"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535662091" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535662091">(Aug 22 2025 at 11:17)</a>:</h4>
<p>special rule makes sense to me - probably put the commas on their own line</p>



<a name="535662607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20-%20tokenizer/near/535662607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JRI98 <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20-.20tokenizer.html#535662607">(Aug 22 2025 at 11:21)</a>:</h4>
<p>Small aside, the fuzzer found other crashes <a href="https://roc-lang.github.io/roc-compiler-fuzz">https://roc-lang.github.io/roc-compiler-fuzz</a></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
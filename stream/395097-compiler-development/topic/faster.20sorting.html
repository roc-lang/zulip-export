<html>
<head><meta charset="utf-8"><title>faster sorting Â· compiler development Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html">faster sorting</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="453535559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453535559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453535559">(Jul 23 2024 at 21:49)</a>:</h4>
<p>Given I had already started on <code>quadsort</code> for <code>blitsort</code>, I am just transitioning over to working on <code>quadsort</code> for <code>fluxsort</code>. The differencen being that <code>fluxsort</code> uses more memory for more performance.</p>
<p>It will definitely be slow to port <code>quadsort</code> cause it has a lot of low level optimization to be branchless where possible. This tends to be a large perf win for random data where the branch predictor is just constantly wrong. It also has some low level routines for small arrays to make them really fast.</p>
<p>This is <code>tiny_sort</code> in zig: <a href="https://godbolt.org/z/q5PTnr13z">https://godbolt.org/z/q5PTnr13z</a></p>
<p>It is for arrays of length 0 to 7.</p>
<p>It is just really cool to see the assembly. It has one jump table for the size of the input. It has 4 conditional branches (all for early returns when data happens to be sorted, only 1 can be hit for a given size array). All other control flow is unconditional jumps/calls.</p>



<a name="453536429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453536429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453536429">(Jul 23 2024 at 21:53)</a>:</h4>
<p>The other nice part of these primitives for quadsort is that they should be transferable to any other sort. Like if we use powersort/glidesort in the future, it still would be a gain to drop into these really optimized routines for sub arrays that are tiny.</p>



<a name="453821005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453821005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453821005">(Jul 25 2024 at 00:19)</a>:</h4>
<p>promising first results:</p>
<p>mergesort from <a class="stream-topic" data-stream-id="231634" href="/#narrow/stream/231634-beginners/topic/Obvious.20inefficiencies.20in.20merge.20sort.20algorithm.3F">#beginners &gt; Obvious inefficiencies in merge sort algorithm?</a>:</p>
<div class="codehilite"><pre><span></span><code>List sorted correctly!
Sorted 1000000 integers in 100 milliseconds.
</code></pre></div>
<p>quadsort (not fully implemented, and still a few bugs, but enough to run first tests):</p>
<div class="codehilite"><pre><span></span><code>List sorted correctly!
Sorted 1000000 integers in 41 milliseconds.
</code></pre></div>
<p>And this is just quadsort. Fluxsort wrapper theoretically can make it even faster.</p>



<a name="453822502"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453822502" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453822502">(Jul 25 2024 at 00:33)</a>:</h4>
<p>Main reason for gains:</p>
<div class="codehilite"><pre><span></span><code>branch_misses ... âš¡- 99.4% Â±  0.0%
</code></pre></div>



<a name="453822511"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453822511" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453822511">(Jul 25 2024 at 00:33)</a>:</h4>
<p>almost 100% less branch misses</p>



<a name="453822593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453822593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453822593">(Jul 25 2024 at 00:34)</a>:</h4>
<p>Quadsort is actually more instructions overall:</p>
<div class="codehilite"><pre><span></span><code>instructions ... ðŸ’© + 27.3% Â±  0.0%
</code></pre></div>



<a name="453822631"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453822631" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453822631">(Jul 25 2024 at 00:35)</a>:</h4>
<p>also:</p>
<div class="codehilite"><pre><span></span><code>cache_misses ...  âš¡- 70.8% Â±  1.0%
</code></pre></div>



<a name="453836877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453836877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453836877">(Jul 25 2024 at 03:03)</a>:</h4>
<p>This stuff just feels like black magic to me.</p>



<a name="453836962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453836962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453836962">(Jul 25 2024 at 03:04)</a>:</h4>
<p>I love how we can tune the performance and see such amazing results.</p>



<a name="453836969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453836969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453836969">(Jul 25 2024 at 03:04)</a>:</h4>
<p>1 more point of comparison.</p>
<p>The raw C quadsort on the same size list of longs, task <code>27ms</code> if the comparison is inlined and <code>99ms</code> if the comparison is not inlined.</p>



<a name="453852250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453852250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453852250">(Jul 25 2024 at 04:41)</a>:</h4>
<p>wow, so you got it to 41ms when a pure C implementation is 27ms? <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="453852644"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453852644" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453852644">(Jul 25 2024 at 04:44)</a>:</h4>
<p>Yeah, though llvm is doing a ton of heavy lifting. It manages to inline the comparison function even though we pass it into zig as a pointer.</p>
<p>Also, I haven't done any perf tuning yet. I know of at least one location where for sure the zig is not generating quite the same as the gotos in C. I bet there are other locations as well.</p>



<a name="453852855"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453852855" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453852855">(Jul 25 2024 at 04:47)</a>:</h4>
<p>Also, I currently have a broken case. Not sure what is going wrong. Just disabled the case for now. Re-enabling it should be some form of perf gain assuming it was getting hit. With it disabled, the sort is falling back to branchless fully unordered mode more often.</p>



<a name="453852879"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453852879" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453852879">(Jul 25 2024 at 04:47)</a>:</h4>
<p>Also, I guess it must have been getting hit, otherwise, it wouldn't be able to break things.</p>



<a name="453863120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453863120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453863120">(Jul 25 2024 at 06:23)</a>:</h4>
<p>I don't want to admit how much time I spent to fix this bug:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-                        arr_ptr += 8;</span>
<span class="gi">+                        arr_ptr += 8 * element_width;</span>
</code></pre></div>



<a name="453863335"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453863335" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453863335">(Jul 25 2024 at 06:25)</a>:</h4>
<p>Down to 34ms. So 34 vs 27ms.</p>



<a name="453863406"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453863406" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453863406">(Jul 25 2024 at 06:26)</a>:</h4>
<p>Also, fluxsort is at 20ms.</p>



<a name="453863428"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453863428" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453863428">(Jul 25 2024 at 06:26)</a>:</h4>
<p>So definitely still more gains from adding the wrapper layer (it also is much simpler than quadsort)</p>



<a name="453864053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453864053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453864053">(Jul 25 2024 at 06:33)</a>:</h4>
<p>So quadsort is fully working now.</p>
<p>I still need to:</p>
<ol>
<li><del>add a fallback path for when elements are super large. Instead of sorting the array, will generate and sort an array of pointers.</del></li>
<li>wire through incrementing the refcount (will make it specialized based on if refcouting is required). This will definitely be a pain. The easy way would be to increment at every compare, but I will probably try to group incrementing where I can to lower the cost. 2 new args to every function and a lot of extra noise in conditionals. (could be done in a different PR, main is broken for this anyway)</li>
<li>Add fluxsort wrapper (definitely could be done in a different PR)</li>
<li><del>Maybe should fuzz it to make sure it is correct. Though I have a lot of tests, there are a ton of cases in general.</del> DONE</li>
<li><del>Performance tune? I mean it's pretty darn close to the c, but while it's fresh in my brain maybe should look at diff in more detail. (My biggest guess is most of the cost is related to the element width not being known at compile time, but maybe llvm is propagating it everywhere correctly, followed by a go-to that I know is a function call rn, but just guesses).</del> (more debugging on M1 should be done, but perf is good enough that I'm leaving it be for now).</li>
</ol>



<a name="453922059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453922059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453922059">(Jul 25 2024 at 11:20)</a>:</h4>
<p>yooo this is awesome!!!</p>



<a name="453982261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/453982261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#453982261">(Jul 25 2024 at 15:39)</a>:</h4>
<p>Interesting, our perf is way worse on m1 mac than on x86.... still better than merge sort, but much farther from the C version.</p>



<a name="454069340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454069340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454069340">(Jul 25 2024 at 23:23)</a>:</h4>
<p>I can't seem to get flamegraphs from roc into zig working on my mac. So pretty hard to debug the perf.</p>



<a name="454069600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454069600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454069600">(Jul 25 2024 at 23:26)</a>:</h4>
<p>But yeah, on m1 mac we are like 90ms, but the C is 25ms. Even C with the comparison as no inline is 75ms.</p>



<a name="454070408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454070408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454070408">(Jul 25 2024 at 23:36)</a>:</h4>
<p>If I average 10 runs, it is 67ms, which is a lot closer, but still not 25ms. and much farther away than the 34ms I get on linux.</p>



<a name="454070888"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454070888" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454070888">(Jul 25 2024 at 23:40)</a>:</h4>
<p><a href="/user_uploads/22008/jMBU8BlpEcHZpIuijaU-yjNR/Screenshot-2024-07-25-at-4.38.35PM.png">Sad Flamegraph...</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/jMBU8BlpEcHZpIuijaU-yjNR/Screenshot-2024-07-25-at-4.38.35PM.png" title="Sad Flamegraph..."><img data-original-dimensions="636x163" src="/user_uploads/thumbnail/22008/jMBU8BlpEcHZpIuijaU-yjNR/Screenshot-2024-07-25-at-4.38.35PM.png/840x560.webp"></a></div>



<a name="454075583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075583">(Jul 26 2024 at 00:14)</a>:</h4>
<p>Sad because all the time is spent in one function. And we can't see into that function, because that's the boundary where roc calls into zig?</p>



<a name="454075727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075727">(Jul 26 2024 at 00:16)</a>:</h4>
<p>Yeah</p>



<a name="454075739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075739">(Jul 26 2024 at 00:16)</a>:</h4>
<p>I'm pretty sure that function is just the sort function</p>



<a name="454075808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075808">(Jul 26 2024 at 00:17)</a>:</h4>
<p>That's with me turning off strip on the zig builtins. So I feel like there should be debug info</p>



<a name="454075874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075874">(Jul 26 2024 at 00:18)</a>:</h4>
<p>How are you building it? Is roc driving the linking? Maybe you could <code>--no-link</code> and then use zig to <code>build-exe</code>?</p>



<a name="454075892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075892">(Jul 26 2024 at 00:18)</a>:</h4>
<p>Oh wait... nvm, this is inside roc</p>



<a name="454075908"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075908" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075908">(Jul 26 2024 at 00:18)</a>:</h4>
<p>I probably could build a zig app that just directly imports <code>sort.zig</code>. That probably would give me info.</p>



<a name="454075933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454075933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454075933">(Jul 26 2024 at 00:19)</a>:</h4>
<p>That's a good way to isolate the sort impl</p>



<a name="454087557"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454087557" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454087557">(Jul 26 2024 at 00:27)</a>:</h4>
<p>Probably will want to do that anyway at some point for direct fuzzing.</p>



<a name="454141312"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454141312" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454141312">(Jul 26 2024 at 01:32)</a>:</h4>
<p>Apparently essentially all of the time is spent in the copy function...which confuses me cause I'm pretty sure it is getting inlined, so not really sure why it is taking up so much time.</p>



<a name="454141926"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454141926" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454141926">(Jul 26 2024 at 01:39)</a>:</h4>
<p>Hmm, I just hit a segfault on linux. Maybe I have a bug and sorting is looping like crazy sorting mem outside of the array or incrementing incorrectly somehow</p>



<a name="454190146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454190146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454190146">(Jul 26 2024 at 07:01)</a>:</h4>
<p>Using a zig app as the driver, I have managed to fix a few bugs. That said, I am still confused by the perf.</p>
<p>On M1 mac, the zig version takes around 70ms. The c++ around 25ms.<br>
If I bench the zig version or run it with a profiler, it takes around 45ms.<br>
If I use a cycle profiler to compare the two, they are within 10% cycle count wise.</p>
<p>I don't know of a good equivalent to perf on mac to get time spent on cache misses and waiting on data.<br>
Probably gonna move on soon and just work on other things.</p>



<a name="454191449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454191449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454191449">(Jul 26 2024 at 07:02)</a>:</h4>
<p>Oh, also, in the profiler, almost all the time is spent copying data (which I wouldn't expect C to do better assuming I implemented the algorithm correctly and am copying the same data around).</p>
<p>Given it runs good on x86, that also suggests that I implemented the algorithm correctly.</p>



<a name="454191855"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454191855" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454191855">(Jul 26 2024 at 07:03)</a>:</h4>
<p>But maybe llvm is optimizing poorly for us on m1 mac for some reason</p>



<a name="454335823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454335823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454335823">(Jul 26 2024 at 16:42)</a>:</h4>
<p>Got fuzzing working. Ran it overnight. Definitely found a few edge cases. That said, for 213 million  runs, a 552 test cases isn't bad. And I would guess that many test cases have the same root cause.</p>



<a name="454400855"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454400855" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454400855">(Jul 27 2024 at 01:14)</a>:</h4>
<p>So turns out the bug was a non-bug. I turned a comment in the original C into an assert. Turns out the comment was slightly off. Updated the comment and assert. Running more fuzzing. I think we may be bug free!</p>



<a name="454447272"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454447272" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454447272">(Jul 27 2024 at 09:01)</a>:</h4>
<p>Down to the last two pieces:</p>
<ol>
<li><del>wiring <code>inc_n_data</code> and <code>data_is_owned</code> through everything such that an owning closure could be used. (probably should fuzz that works correctly, basically, make the owned data an incrementing int and make sure it equals the number of times compare is called).</del></li>
<li>adding the <code>fluxsort</code> wrapper around <code>quadsort</code> (and fuzzing it)</li>
</ol>
<p><code>quadsort</code> is working, fuzzed, and can fallback to sort indirectly for giant values.</p>



<a name="454544310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454544310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454544310">(Jul 28 2024 at 00:05)</a>:</h4>
<p>Definitely a bit of a pervasive PR, but we have refcounting using a comptime bool to add the code or not. Also, did my best to minimize the times we actually call to increment the refcount. Attempt to batch wherever possible. So plenty of places where we increment by 4 or 16 for example.</p>



<a name="454544316"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454544316" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454544316">(Jul 28 2024 at 00:05)</a>:</h4>
<p>Now just need to add that into the fuzzer.</p>



<a name="454544390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454544390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454544390">(Jul 28 2024 at 00:06)</a>:</h4>
<p>Most places where we have to increment by only 1 are in compares that are used with short circuit evaluation. So if the first compare fails, the rest won't run.</p>



<a name="454544395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454544395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454544395">(Jul 28 2024 at 00:06)</a>:</h4>
<p>And no way to get around that.</p>



<a name="454546806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454546806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454546806">(Jul 28 2024 at 00:37)</a>:</h4>
<p>Ran it through my existing fuzz corpus and also a bit after. Missed one refcount location, but otherwise, refcounting seems to work happily.</p>



<a name="454546855"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454546855" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454546855">(Jul 28 2024 at 00:38)</a>:</h4>
<p>Down to just the fluxsort wrapper and testing/fuzzing for it.</p>



<a name="454673509"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454673509" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454673509">(Jul 28 2024 at 22:31)</a>:</h4>
<p>Printing out the breakdown of sorting is kinda cool:</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>sort strategies</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite"><pre><span></span><code>quicksort 1000 elems
median of nine: 2938417487880084056
partition strategy: default
    quicksort 332 elems
    median of nine: 6817335681333689882
    partition strategy: default
        quicksort 120 elems
        median of nine: 7738655368416626995
        partition strategy: default
            mergesort 78 elems
            mergesort 42 elems
        quicksort 212 elems
        median of nine: 3983938187880039198
        partition strategy: default
            quicksort 163 elems
            median of nine: 5445429211482806183
            partition strategy: default
                mergesort 82 elems
                mergesort 81 elems
            mergesort 49 elems
    quicksort 668 elems
    median of nine: -4781184063276946074
    partition strategy: default
        quicksort 426 elems
        median of nine: 764764259046233900
        partition strategy: default
            quicksort 117 elems
            median of nine: 2096483146860794127
            partition strategy: default
                mergesort 45 elems
                mergesort 72 elems
            quicksort 309 elems
            median of nine: -1875810895047206237
            partition strategy: default
                quicksort 137 elems
                median of nine: -254467376449306342
                partition strategy: default
                    mergesort 48 elems
                    mergesort 89 elems
                quicksort 172 elems
                median of nine: -3930025406165151116
                partition strategy: default
                    quicksort 121 elems
                    median of nine: -3020111438722416420
                    partition strategy: default
                        mergesort 66 elems
                        mergesort 55 elems
                    mergesort 51 elems
        quicksort 242 elems
        median of nine: -7138956423631159883
        partition strategy: default
            quicksort 137 elems
            median of nine: -5931406857942076890
            partition strategy: default
                mergesort 68 elems
                mergesort 69 elems
            quicksort 105 elems
            median of nine: -7657208392615692120
            partition strategy: default
                mergesort 29 elems
                mergesort 76 elems
</code></pre></div>
</div></div>



<a name="454673690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454673690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454673690">(Jul 28 2024 at 22:33)</a>:</h4>
<p>With fluxsort, the more random the data is, the more it uses quicksort.  If many elements of the input have the same value, it will use dual pivot quicksort to skip large chunks of sorting. If the array is relatively ordered or is simply small, will fallback to mergesort.</p>
<p>Also has some smart handling for reversed data.</p>



<a name="454689336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454689336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454689336">(Jul 29 2024 at 01:05)</a>:</h4>
<p>So besides an issue with the surgical linker for the fallback to sorting pointers if the element size is too large, I think I have full fluxsort working.</p>



<a name="454691106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454691106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454691106">(Jul 29 2024 at 01:24)</a>:</h4>
<p>that's awesome!</p>



<a name="454705605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454705605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454705605">(Jul 29 2024 at 03:33)</a>:</h4>
<p>So final perf numbers.</p>
<p><strong>Summary</strong><br>
x86_64:</p>
<ul>
<li>4x faster than mergesort written in pure roc.</li>
<li>tied with c++ (actually maybe a tiny bit faster and less memory).</li>
</ul>
<p>M1:</p>
<ul>
<li>2x faster than mergesort written in pure roc.</li>
<li>2x slower than c++.</li>
</ul>
<hr>
<div class="spoiler-block"><div class="spoiler-header">
<p>M1 (Still not sure why roc is slower here)</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite"><pre><span></span><code>Benchmark 1: ./roc-mergesort
  Time (mean Â± Ïƒ):      77.6 ms Â±   0.6 ms    [User: 73.6 ms, System: 2.5 ms]
  Range (min â€¦ max):    76.7 ms â€¦  80.9 ms    100 runs

Benchmark 2: ./roc-builtinsort
  Time (mean Â± Ïƒ):      40.3 ms Â±   0.5 ms    [User: 36.9 ms, System: 2.1 ms]
  Range (min â€¦ max):    39.6 ms â€¦  44.0 ms    100 runs

Benchmark 3: ./cc-quadsort
  Time (mean Â± Ïƒ):      31.1 ms Â±   0.9 ms    [User: 27.6 ms, System: 2.3 ms]
  Range (min â€¦ max):    30.1 ms â€¦  35.6 ms    100 runs

Benchmark 4: ./cc-fluxsort
  Time (mean Â± Ïƒ):      21.0 ms Â±   0.4 ms    [User: 18.0 ms, System: 2.0 ms]
  Range (min â€¦ max):    20.5 ms â€¦  23.1 ms    100 runs

Summary
  ./cc-fluxsort ran
    1.48 Â± 0.05 times faster than ./cc-quadsort
    1.92 Â± 0.04 times faster than ./roc-builtinsort
    3.70 Â± 0.07 times faster than ./roc-mergesort
</code></pre></div>
</div></div>
<div class="spoiler-block"><div class="spoiler-header">
<p>x86_64 intel i7-8750H gaming laptop (amazing results)</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="spoiler-block"><div class="spoiler-header">
<p>hyperfine</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite"><pre><span></span><code>Benchmark 1: ./roc-mergesort
  Time (mean Â± Ïƒ):      99.4 ms Â±   2.9 ms    [User: 96.2 ms, System: 3.2 ms]
  Range (min â€¦ max):    96.2 ms â€¦ 121.6 ms    100 runs

Benchmark 2: ./roc-builtinsort
  Time (mean Â± Ïƒ):      25.4 ms Â±   0.5 ms    [User: 23.1 ms, System: 2.3 ms]
  Range (min â€¦ max):    24.7 ms â€¦  27.7 ms    100 runs

Benchmark 3: ./cc-quadsort
  Time (mean Â± Ïƒ):      35.9 ms Â±   1.5 ms    [User: 31.6 ms, System: 4.3 ms]
  Range (min â€¦ max):    33.1 ms â€¦  38.1 ms    100 runs

Benchmark 4: ./cc-fluxsort
  Time (mean Â± Ïƒ):      26.5 ms Â±   0.5 ms    [User: 22.4 ms, System: 4.1 ms]
  Range (min â€¦ max):    25.5 ms â€¦  28.0 ms    100 runs

Summary
  ./roc-builtinsort ran
    1.04 Â± 0.03 times faster than ./cc-fluxsort
    1.42 Â± 0.07 times faster than ./cc-quadsort
    3.92 Â± 0.14 times faster than ./roc-mergesort
</code></pre></div>
</div></div>
<div class="spoiler-block"><div class="spoiler-header">
<p>poop</p>
</div><div class="spoiler-content" aria-hidden="true">
<div class="codehilite"><pre><span></span><code>Benchmark 1 (50 runs): ./roc-mergesort
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          98.5ms Â± 1.11ms    97.1ms â€¦  104ms          5 (10%)        0%
  peak_rss           16.3MB Â± 66.0KB    16.3MB â€¦ 16.4MB          0 ( 0%)        0%
  cpu_cycles          377M  Â± 1.07M      376M  â€¦  383M           1 ( 2%)        0%
  instructions        385M  Â± 8.40       385M  â€¦  385M           2 ( 4%)        0%
  cache_references   11.6M  Â± 43.1K     11.5M  â€¦ 11.7M           0 ( 0%)        0%
  cache_misses       5.58M  Â±  203K     5.40M  â€¦ 6.67M           4 ( 8%)        0%
  branch_misses      9.50M  Â± 5.82K     9.49M  â€¦ 9.52M           0 ( 0%)        0%
Benchmark 2 (182 runs): ./roc-builtinsort
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          26.6ms Â±  766us    25.1ms â€¦ 28.4ms          0 ( 0%)        âš¡- 73.0% Â±  0.3%
  peak_rss           12.9MB Â±  748KB    12.5MB â€¦ 14.7MB         29 (16%)        âš¡- 20.9% Â±  1.3%
  cpu_cycles         95.5M  Â± 2.94M     90.5M  â€¦  102M           0 ( 0%)        âš¡- 74.7% Â±  0.2%
  instructions        281M  Â±  321K      280M  â€¦  281M           2 ( 1%)        âš¡- 27.1% Â±  0.0%
  cache_references   4.16M  Â± 46.2K     4.06M  â€¦ 4.27M           0 ( 0%)        âš¡- 64.1% Â±  0.1%
  cache_misses        637K  Â± 60.0K      526K  â€¦  956K           3 ( 2%)        âš¡- 88.6% Â±  0.6%
  branch_misses       289K  Â± 60.9K      187K  â€¦  362K           0 ( 0%)        âš¡- 97.0% Â±  0.2%
Benchmark 3 (139 runs): ./cc-quadsort
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          34.8ms Â± 1.01ms    33.9ms â€¦ 39.2ms         12 ( 9%)        âš¡- 64.6% Â±  0.3%
  peak_rss           18.4MB Â± 76.4KB    18.2MB â€¦ 18.6MB          9 ( 6%)        ðŸ’©+ 12.5% Â±  0.1%
  cpu_cycles          117M  Â±  807K      115M  â€¦  120M          11 ( 8%)        âš¡- 69.0% Â±  0.1%
  instructions        283M  Â±  173       283M  â€¦  283M          18 (13%)        âš¡- 26.5% Â±  0.0%
  cache_references   6.70M  Â± 59.4K     6.62M  â€¦ 6.88M           8 ( 6%)        âš¡- 42.2% Â±  0.2%
  cache_misses       1.82M  Â±  126K     1.60M  â€¦ 2.18M           2 ( 1%)        âš¡- 67.4% Â±  0.9%
  branch_misses      53.3K  Â± 2.28K     47.0K  â€¦ 61.0K          20 (14%)        âš¡- 99.4% Â±  0.0%
Benchmark 4 (172 runs): ./cc-fluxsort
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          28.1ms Â± 2.17ms    26.2ms â€¦ 49.8ms          8 ( 5%)        âš¡- 71.5% Â±  0.6%
  peak_rss           18.4MB Â± 80.3KB    18.2MB â€¦ 18.6MB          7 ( 4%)        ðŸ’©+ 12.6% Â±  0.1%
  cpu_cycles         92.5M  Â± 4.48M     88.1M  â€¦  130M           2 ( 1%)        âš¡- 75.5% Â±  0.3%
  instructions        267M  Â±  186K      267M  â€¦  268M           3 ( 2%)        âš¡- 30.6% Â±  0.0%
  cache_references   4.35M  Â± 70.5K     4.21M  â€¦ 4.90M           3 ( 2%)        âš¡- 62.5% Â±  0.2%
  cache_misses        822K  Â±  120K      682K  â€¦ 2.04M           7 ( 4%)        âš¡- 85.3% Â±  0.8%
  branch_misses       263K  Â± 65.8K      193K  â€¦  370K           0 ( 0%)        âš¡- 97.2% Â±  0.2%
</code></pre></div>
</div></div>
</div></div>



<a name="454706950"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454706950" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454706950">(Jul 29 2024 at 03:39)</a>:</h4>
<p>PR: <a href="https://github.com/roc-lang/roc/issues/6932">#6932</a></p>



<a name="454713494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454713494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454713494">(Jul 29 2024 at 04:20)</a>:</h4>
<p>Nice work, this is really cool. Love how you explored the performance and shared what you learnt along the way. </p>
<p>I found it super interesting to follow along with, and now I really want to understand the perf characteristics more with my code.</p>



<a name="454735127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454735127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454735127">(Jul 29 2024 at 06:32)</a>:</h4>
<p>I'm going to leave this fuzzing overnight, but everything is ready for review and merge here.</p>



<a name="454798867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454798867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454798867">(Jul 29 2024 at 11:12)</a>:</h4>
<p>I thought I might try and run this (or something similar) and see what I see on my M2 mac. </p>
<p>Based on my results, I'm guessing this isn't the correct way to test this. </p>
<h2>test program</h2>
<p>I used this program inspired by <a href="https://github.com/roc-lang/roc/issues/6294">#6294</a> -- it's not the same because the API has changed a lot since then.</p>
<div class="codehilite"><pre><span></span><code>app [main] {
    pf: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/0.13.0/nW9yMRtZuCYf1Oa9vbE5XoirMwzLbtoSgv7NGhUlqYA.tar.br&quot;,
}

import pf.Task

main =
    n = 86896
    list = List.range { start: At n, end: Before 0 }

    actual = List.sortWith list Num.compare
    expected = List.range { start: At 1, end: At n }

    if actual == expected then
        Task.ok {}
    else
        Task.err NotSorted
</code></pre></div>
<h2>results M2 mac</h2>
<div class="codehilite"><pre><span></span><code>$ hyperfine ./sort
Benchmark 1: ./sort
  Time (mean Â± Ïƒ):      40.4 ms Â±  93.3 ms    [User: 10.0 ms, System: 1.3 ms]
  Range (min â€¦ max):     9.3 ms â€¦ 305.9 ms    10 runs

$ hyperfine ./sort-opt
Benchmark 1: ./sort-opt
  Time (mean Â± Ïƒ):     164.6 ms Â± 502.0 ms    [User: 3.9 ms, System: 1.7 ms]
  Range (min â€¦ max):     3.1 ms â€¦ 1593.4 ms    10 runs

$ hyperfine -m 1000 ./sort
Benchmark 1: ./sort
  Time (mean Â± Ïƒ):       9.3 ms Â±   0.2 ms    [User: 7.9 ms, System: 0.8 ms]
  Range (min â€¦ max):     8.8 ms â€¦   9.7 ms    1000 runs

$ hyperfine -m 1000 ./sort-opt
Benchmark 1: ./sort-opt
  Time (mean Â± Ïƒ):       3.0 ms Â±   0.2 ms    [User: 1.8 ms, System: 0.7 ms]
  Range (min â€¦ max):     2.6 ms â€¦   5.3 ms    1000 runs
</code></pre></div>



<a name="454799045"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454799045" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454799045">(Jul 29 2024 at 11:12)</a>:</h4>
<p><code>sort-opt</code> was built using <code>--optimize</code></p>



<a name="454859512"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454859512" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454859512">(Jul 29 2024 at 14:58)</a>:</h4>
<p>Try running <code>./bench.sh</code> from this repo: <a href="https://github.com/bhansconnect/roc-sorting">https://github.com/bhansconnect/roc-sorting</a></p>



<a name="454859782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454859782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454859782">(Jul 29 2024 at 14:59)</a>:</h4>
<p>And yeah, that benchmark isn't good cause fluxsort will detect the entire list is reversed and just flip it</p>



<a name="454870446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454870446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454870446">(Jul 29 2024 at 15:39)</a>:</h4>
<blockquote>
<p>leave this fuzzing overnight</p>
</blockquote>
<p>250 million executions later with 0 crashes. There were some timeouts (no hangs), but that's expected. Timeouts are expected cause with a large enough input, sorting will get slow. Timeouts just mean it took longer than expected, but still finished in a reasonable time. Hangs are if it takes so long that the fuzzer decides to kill it.</p>



<a name="454923847"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454923847" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454923847">(Jul 29 2024 at 19:13)</a>:</h4>
<p>So looked at the M1 story a bit more:</p>
<p>A raw zig version using our new builtin sort is essentially as fast as the C sort on M1.</p>
<div class="codehilite"><pre><span></span><code>Summary
  ./cc-fluxsort ran
    1.04 Â± 0.02 times faster than ./zig-raw-builtinsort
</code></pre></div>
<p>So it is somehow due to the code roc is generating. Maybe llvm is not inlining the compare or copy for llvm on m1 (I don't think this is the case, would be way slower)? Maybe the compare isn't generating branchless? Maybe some other complexity of llvm ir is leading to an optimization failing to apply?</p>



<a name="454955149"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/454955149" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#454955149">(Jul 29 2024 at 21:37)</a>:</h4>
<p>Super exciting! <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="455021204"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/455021204" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#455021204">(Jul 30 2024 at 04:23)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> if you get a chance, I'd be curious what your M2 results are for this:</p>
<blockquote>
<p>Try running <code>./bench.sh</code> from this repo: <a href="https://github.com/bhansconnect/roc-sorting">https://github.com/bhansconnect/roc-sorting</a></p>
</blockquote>



<a name="455021346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/455021346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#455021346">(Jul 30 2024 at 04:24)</a>:</h4>
<p>Should run on latest main with zig 0.11 and any form of clang++.</p>



<a name="455023239"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/455023239" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#455023239">(Jul 30 2024 at 04:33)</a>:</h4>
<p>M2 macbook air</p>
<div class="codehilite"><pre><span></span><code>Benchmark 1: ./roc-mergesort
  Time (mean Â± Ïƒ):      71.1 ms Â±   0.8 ms    [User: 68.1 ms, System: 1.9 ms]
  Range (min â€¦ max):    69.9 ms â€¦  72.1 ms    100 runs

Benchmark 2: ./roc-builtinsort
  Time (mean Â± Ïƒ):      36.6 ms Â±   0.5 ms    [User: 34.4 ms, System: 1.5 ms]
  Range (min â€¦ max):    35.8 ms â€¦  37.3 ms    100 runs

Benchmark 3: ./zig-raw-builtinsort
  Time (mean Â± Ïƒ):      33.7 ms Â±   0.4 ms    [User: 32.4 ms, System: 1.0 ms]
  Range (min â€¦ max):    33.0 ms â€¦  34.3 ms    100 runs

Benchmark 4: ./cc-quadsort
  Time (mean Â± Ïƒ):      27.1 ms Â±   0.3 ms    [User: 25.3 ms, System: 1.5 ms]
  Range (min â€¦ max):    26.8 ms â€¦  27.8 ms    100 runs

Benchmark 5: ./cc-fluxsort
  Time (mean Â± Ïƒ):      19.0 ms Â±   0.1 ms    [User: 17.3 ms, System: 1.3 ms]
  Range (min â€¦ max):    18.7 ms â€¦  19.3 ms    100 runs

Summary
  ./cc-fluxsort ran
    1.43 Â± 0.02 times faster than ./cc-quadsort
    1.78 Â± 0.02 times faster than ./zig-raw-builtinsort
    1.93 Â± 0.03 times faster than ./roc-builtinsort
    3.75 Â± 0.05 times faster than ./roc-mergesort
</code></pre></div>



<a name="455024701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/455024701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#455024701">(Jul 30 2024 at 04:42)</a>:</h4>
<p>And on the WIP LLVM 18 branch -- this is a great way to confirm that the optimisation passes I removed are definitely still required... so don't take these results seriously</p>
<div class="codehilite"><pre><span></span><code>Benchmark 1: ./roc-mergesort
  Time (mean Â± Ïƒ):     431.0 ms Â±   2.7 ms    [User: 425.4 ms, System: 2.4 ms]
  Range (min â€¦ max):   425.5 ms â€¦ 445.8 ms    100 runs

Benchmark 2: ./roc-builtinsort
  Time (mean Â± Ïƒ):     203.1 ms Â±   0.9 ms    [User: 200.1 ms, System: 1.4 ms]
  Range (min â€¦ max):   198.0 ms â€¦ 206.5 ms    100 runs
</code></pre></div>



<a name="455028961"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/faster%20sorting/near/455028961" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/faster.20sorting.html#455028961">(Jul 30 2024 at 05:10)</a>:</h4>
<p>ok, so still a gap from c++ to zig/roc. Not sure why the perf diff would be apple silicon specific, but good to know it is consistent.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
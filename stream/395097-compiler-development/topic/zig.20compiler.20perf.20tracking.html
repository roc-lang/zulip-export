<html>
<head><meta charset="utf-8"><title>zig compiler perf tracking Â· compiler development Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html">zig compiler perf tracking</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="527858009"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858009" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858009">(Jul 09 2025 at 10:35)</a>:</h4>
<blockquote>
<p>If I run <code>roc check New-List.roc</code> it kills my terminal after a while :p </p>
</blockquote>
<p>Turns out this is because it's trying eat all my RAM (64 GB)</p>



<a name="527858200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858200">(Jul 09 2025 at 10:36)</a>:</h4>
<p>Yeah, we need to implement some kind of cut-off or streaming for the problem reports</p>



<a name="527858324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858324">(Jul 09 2025 at 10:37)</a>:</h4>
<p>It's strange that Brendan didn't experience any issues, he's probably on macos</p>



<a name="527858363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858363">(Jul 09 2025 at 10:37)</a>:</h4>
<p>He mentioned that he did</p>



<a name="527858459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858459">(Jul 09 2025 at 10:38)</a>:</h4>
<p>He said there was thousands of errors I recall</p>



<a name="527858490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858490">(Jul 09 2025 at 10:38)</a>:</h4>
<p><a class="message-link" href="/#narrow/channel/395097-compiler-development/topic/casual.20conversation/near/527224557">#compiler development &gt; casual conversation @ ðŸ’¬</a></p>



<a name="527858584"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858584" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858584">(Jul 09 2025 at 10:38)</a>:</h4>
<p>I meant memory issues, lots of Roc errors is ok to test our perf</p>



<a name="527858871"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527858871" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527858871">(Jul 09 2025 at 10:40)</a>:</h4>
<blockquote>
<p>60s -&gt; generating diagnostic from can (this is after my fix that made this part way way faster)</p>
</blockquote>
<p>Perhaps this perf fix is not yet merged in <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span>?</p>



<a name="527859034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859034">(Jul 09 2025 at 10:41)</a>:</h4>
<p>Ok no, looks like it's merged in <a href="https://github.com/roc-lang/roc/pull/7938">https://github.com/roc-lang/roc/pull/7938</a></p>



<a name="527859233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859233">(Jul 09 2025 at 10:43)</a>:</h4>
<p><a href="/user_uploads/22008/mV0h5DDG5GGA8nrabswLpPyq/Screenshot-2025-07-09-at-20.42.21.png">Screenshot 2025-07-09 at 20.42.21.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/mV0h5DDG5GGA8nrabswLpPyq/Screenshot-2025-07-09-at-20.42.21.png" title="Screenshot 2025-07-09 at 20.42.21.png"><img data-original-content-type="image/png" data-original-dimensions="1496x280" src="/user_uploads/thumbnail/22008/mV0h5DDG5GGA8nrabswLpPyq/Screenshot-2025-07-09-at-20.42.21.png/840x560.webp"></a></div>



<a name="527859251"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859251" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859251">(Jul 09 2025 at 10:43)</a>:</h4>
<p>I killed it at 8GB</p>



<a name="527859278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859278">(Jul 09 2025 at 10:43)</a>:</h4>
<p><code>./zig-out/bin/roc check ~/Documents/New-List.roc</code></p>



<a name="527859382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859382">(Jul 09 2025 at 10:44)</a>:</h4>
<p>Hmm, could this difference in behavior be due to a recent commit?</p>



<a name="527859455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859455">(Jul 09 2025 at 10:44)</a>:</h4>
<p>Definitely could be</p>



<a name="527859463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859463">(Jul 09 2025 at 10:44)</a>:</h4>
<p>I'll try with Brendan's perf fix PR</p>



<a name="527859648"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859648" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859648">(Jul 09 2025 at 10:45)</a>:</h4>
<p>I'm running on my PR branch which includes the module caching stuff, but other than that I can't think of any significant changes since Brendan's analysis</p>



<a name="527859759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527859759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527859759">(Jul 09 2025 at 10:45)</a>:</h4>
<p>Could be due to zig 0.14.1 instead of 0.14.0</p>



<a name="527860306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527860306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527860306">(Jul 09 2025 at 10:49)</a>:</h4>
<p>Running with a smaller file <a href="https://gist.github.com/lukewilliamboswell/532f48c70cfc3bca866c239cad291378">https://gist.github.com/lukewilliamboswell/532f48c70cfc3bca866c239cad291378</a></p>



<a name="527860384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527860384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527860384">(Jul 09 2025 at 10:49)</a>:</h4>
<p>Looks like maybe PackedDataSpan is an issue, or at least we exceeded the assumptions we made using that.</p>



<a name="527860673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527860673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527860673">(Jul 09 2025 at 10:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20perf.20tracking/near/527859463">said</a>:</p>
<blockquote>
<p>I'll try with Brendan's perf fix PR</p>
</blockquote>
<p>That gives me a panic:</p>
<div class="codehilite"><pre><span></span><code>thread 12630 panic: reached unreachable code
/home/username/Downloads/zig-linux-x86_64-0.14.0/lib/std/debug.zig:522:14: 0x109d64d in assert (roc)
    if (!ok) unreachable; // assertion failure
             ^
/home/username/gitrepos/roc/src/check/canonicalize/NodeStore.zig:1274:33: 0x120e3fa in addExpr (roc)
                std.debug.assert(PackedDataSpan.FunctionArgs.canFit(args.span));
</code></pre></div>



<a name="527860757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527860757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527860757">(Jul 09 2025 at 10:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/zig.20compiler.20perf.20tracking/near/527860306">said</a>:</p>
<blockquote>
<p>Running with a smaller file <a href="https://gist.github.com/lukewilliamboswell/532f48c70cfc3bca866c239cad291378">https://gist.github.com/lukewilliamboswell/532f48c70cfc3bca866c239cad291378</a></p>
</blockquote>
<p>Oh yeah, that's my panic too :p</p>



<a name="527861078"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527861078" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527861078">(Jul 09 2025 at 10:53)</a>:</h4>
<p>I added that PackedDataSpan ... but definitely wasn't thinking about mammoth files like this when I did that</p>



<a name="527861628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527861628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527861628">(Jul 09 2025 at 10:56)</a>:</h4>
<p>That's <strong>47,028</strong> dot access expressions (<code>List.something</code>)! Each one creates a <code>e_dot_access</code> node in the CIR, and if each has arguments, it needs to store a span. This is exactly what's causing the memory explosion.</p>
<h2>Summary</h2>
<h3><strong>Root Cause</strong></h3>
<ol>
<li><strong>File Structure</strong>: The 10MB file contains ~47,000 dot access expressions (like <code>List.len</code>, <code>List.get_unsafe</code>, etc.)</li>
<li><strong>Memory Explosion</strong>: Each dot access expression creates a <code>e_dot_access</code> node that requires storing argument spans</li>
<li><strong>Limit Exceeded</strong>: The <code>PackedDataSpan.FunctionArgs</code> configuration (20 bits start, 12 bits length) can only handle start positions up to ~1M, but the large number of expressions causes the data structure indices to exceed this limit</li>
</ol>



<a name="527861813"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527861813" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527861813">(Jul 09 2025 at 10:58)</a>:</h4>
<p>I've got an idea</p>



<a name="527866100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527866100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527866100">(Jul 09 2025 at 11:24)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/7980">https://github.com/roc-lang/roc/pull/7980</a></p>



<a name="527866696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527866696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527866696">(Jul 09 2025 at 11:27)</a>:</h4>
<p>My idea was to stop creating new malformed nodes after a certain threshold and just re-use one node.</p>



<a name="527866732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527866732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527866732">(Jul 09 2025 at 11:28)</a>:</h4>
<p>That doesn't seem to have completely solved our problem</p>



<a name="527871315"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527871315" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527871315">(Jul 09 2025 at 11:54)</a>:</h4>
<p>I think I found another problem causing exponential growth in CIR nodes</p>



<a name="527873934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527873934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527873934">(Jul 09 2025 at 12:08)</a>:</h4>
<p>Something strange is defintely happening somewhere. I'm using ~3GB for around 1_000_000 nodes.</p>



<a name="527876720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527876720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527876720">(Jul 09 2025 at 12:24)</a>:</h4>
<p>Some stats <a href="https://gist.github.com/lukewilliamboswell/cc52a944807ef16cd357356eda438ecb">https://gist.github.com/lukewilliamboswell/cc52a944807ef16cd357356eda438ecb</a></p>



<a name="527886468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527886468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527886468">(Jul 09 2025 at 13:17)</a>:</h4>
<blockquote>
<p>Total CIR nodes created: 1023040</p>
</blockquote>
<p>that's fascinating - so this is about 1M CIR nodes for about 1M LoC of non-comments</p>



<a name="527886617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527886617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527886617">(Jul 09 2025 at 13:18)</a>:</h4>
<p>I would assumed a much higher average of CIR nodes per line, even with a lot of lines being just closing delimiters</p>



<a name="527886667"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527886667" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527886667">(Jul 09 2025 at 13:18)</a>:</h4>
<p>or blank lines I guess</p>



<a name="527887463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527887463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527887463">(Jul 09 2025 at 13:22)</a>:</h4>
<p>that's wild bc it suggests 16-bit indices would work for modules up to like 30-60K LoC depending on how much type instantiation was happening</p>



<a name="527959235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527959235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527959235">(Jul 09 2025 at 20:19)</a>:</h4>
<p>After sleeping on this issue, I think I know the problem. It may be easy to fix our memory problem.</p>



<a name="527961114"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527961114" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527961114">(Jul 09 2025 at 20:32)</a>:</h4>
<p>When I measured, I think I saw 3GB of RAM, which is still quite high, but nothing like 64</p>



<a name="527975590"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527975590" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527975590">(Jul 09 2025 at 22:32)</a>:</h4>
<p>To fix this memory thing properly. This is what I think we need to do. </p>
<p>Have a counter, and increment every time we push a diagnostic </p>
<p>Once that counter hits a threshold ~10_000 errors or something</p>
<p>We then no longer allocate any memory for new diagnostics. We use a placeholder malformed node (the same one can be re-used) that just says "TOO MANY ERRORS".</p>
<p>It's a bit of a mechanical change, but I think it's necessary so we don't keep allocating strings and random things that we'll never use or need later.</p>



<a name="527975962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527975962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527975962">(Jul 09 2025 at 22:37)</a>:</h4>
<p>Here's is an example of the culprit which is common across Can. We're allocating a new string and allocating another Node in the store. Both of these will never be needed if we have thousands of errors already. </p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="p">.</span><span class="n">crash</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">|</span><span class="n">crash_stmt</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Not valid at top-level</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">string_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">can_ir</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">strings</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">can_ir</span><span class="p">.</span><span class="n">env</span><span class="p">.</span><span class="n">gpa</span><span class="p">,</span><span class="w"> </span><span class="s">"crash"</span><span class="p">);</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">parse_ir</span><span class="p">.</span><span class="n">tokenizedRegionToRegion</span><span class="p">(</span><span class="n">crash_stmt</span><span class="p">.</span><span class="n">region</span><span class="p">);</span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">can_ir</span><span class="p">.</span><span class="n">pushDiagnostic</span><span class="p">(</span><span class="n">CIR</span><span class="p">.</span><span class="n">Diagnostic</span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">invalid_top_level_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.{</span>
<span class="w">        </span><span class="p">.</span><span class="n">stmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string_idx</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">region</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="n">last_type_anno</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span><span class="w"> </span><span class="c1">// Clear on non-annotation statement</span>
<span class="p">},</span>
</code></pre></div>



<a name="527976234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527976234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527976234">(Jul 09 2025 at 22:40)</a>:</h4>
<p>I'd like some thoughts on this before I try and implement this. It's a pretty mechanical change, I guess I could start with just the counter and a just few high priority areas, then gradually implement in later PR's.</p>



<a name="527976622"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527976622" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527976622">(Jul 09 2025 at 22:47)</a>:</h4>
<p>I think that's fine; lots of compilers do it, and it's not like anyone can usefully process 400K errors at once anyway <span aria-label="stuck out tongue" class="emoji emoji-1f61b" role="img" title="stuck out tongue">:stuck_out_tongue:</span></p>



<a name="527978682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527978682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527978682">(Jul 09 2025 at 23:14)</a>:</h4>
<p>Hmm....is that the root cause of the memory issue?</p>



<a name="527978796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527978796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527978796">(Jul 09 2025 at 23:16)</a>:</h4>
<p>Also, arent string deduplicated? On top of that, static strings like "crash" we should just never allocate ever</p>



<a name="527978982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/527978982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#527978982">(Jul 09 2025 at 23:19)</a>:</h4>
<p>Like we still should limit diagnostics, but I don't think it is the root cause of the 64 gb oom</p>



<a name="528007344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528007344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528007344">(Jul 10 2025 at 06:09)</a>:</h4>
<p>Found another related issue...  we are getting Regions start at <code>0</code> and end somewhere in the middle of the file. When we slice that for our reports we utf-8 validate the whole thing, over and over again thousands of times.</p>
<div class="codehilite"><pre><span></span><code>$ wasmtime --dir=. --profile=guest zig-out/bin/roc.wasm check New-List-Cutoff_10MB.roc
WARNING: Large region detected: start=0 end=43906 size=43906 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=44523 size=44523 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=50011 size=50011 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=99849 size=99849 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=100466 size=100466 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=105954 size=105954 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=155792 size=155792 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=156409 size=156409 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=161897 size=161897 - may cause slow UTF-8 validation
WARNING: Large region detected: start=0 end=211735 size=211735 - may cause slow UTF-8 validation
</code></pre></div>
<p>This goes on for thousands of lines.</p>



<a name="528011733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528011733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528011733">(Jul 10 2025 at 06:50)</a>:</h4>
<p>Here is a fix/workaround <a href="https://github.com/roc-lang/roc/pull/7995">https://github.com/roc-lang/roc/pull/7995</a></p>



<a name="528012039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528012039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528012039">(Jul 10 2025 at 06:52)</a>:</h4>
<p>This fixes the memory issues entirely for me. The profiling for <code>New-List-Cutoff_10MB.roc</code> looks completely normal and is no longer dominated by utf-8 validation. It runs to completion though prints out all 1,000 errors to the terminal. </p>
<div class="codehilite"><pre><span></span><code>Found 35197 error(s) and 17939 warning(s) in 21785.9 ms for New-List-Cutoff_10MB.roc.
</code></pre></div>



<a name="528012260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528012260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528012260">(Jul 10 2025 at 06:54)</a>:</h4>
<p>Correction .. I hit a debug assertion and it crashes. But in ReleaseSmall it runs fine. Time to track down the next issue I guess <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="528012571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528012571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528012571">(Jul 10 2025 at 06:56)</a>:</h4>
<p>I'm not really for that workaround. I think we should just correct newlines to have proper region info. That or we should correct parsing to not include new lines as the starting and ending tokens for nodes that we will report diagnostic on.</p>



<a name="528012611"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528012611" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528012611">(Jul 10 2025 at 06:56)</a>:</h4>
<p>This solution feels more bug prone and like it might just randomly bite us later</p>



<a name="528012914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528012914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528012914">(Jul 10 2025 at 06:58)</a>:</h4>
<blockquote>
<p>I'm not sure if they should be... it may have been a performance optimization</p>
</blockquote>
<p>Correct functionality before random performance optmizations that may or may not work.</p>



<a name="528014532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528014532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528014532">(Jul 10 2025 at 07:10)</a>:</h4>
<p>I don't love this solution, but it's only temporary I think. It resolves the immediate memory issue, and is noisy (but not blocking) to help us track down any issues.</p>
<p>I've also resolved the debug assertion, and added a limit on the number of warnings we print.</p>



<a name="528014619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528014619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528014619">(Jul 10 2025 at 07:10)</a>:</h4>
<p>I'm avoiding significant changes in the Parser while <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> works on his refactor.</p>



<a name="528014683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528014683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528014683">(Jul 10 2025 at 07:11)</a>:</h4>
<p>I'm also totally up for giving them proper regions.</p>



<a name="528015006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528015006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528015006">(Jul 10 2025 at 07:14)</a>:</h4>
<p>At least with this workaround, we can see the next perf issue which is our CIR diagnostics... it looks like they need the same treatment we just gave AST diagnostics. We should limit the amount we create and re-use a common malformed node after a certain number.</p>



<a name="528144967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528144967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528144967">(Jul 10 2025 at 19:14)</a>:</h4>
<p>I would actually like to get rid of newline tokens all together</p>



<a name="528148647"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528148647" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528148647">(Jul 10 2025 at 19:43)</a>:</h4>
<p>yeah what do we still use them for?</p>



<a name="528148659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528148659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528148659">(Jul 10 2025 at 19:43)</a>:</h4>
<p>formatter heuristics?</p>



<a name="528148973"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528148973" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528148973">(Jul 10 2025 at 19:45)</a>:</h4>
<p>That's all I think</p>



<a name="528149095"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528149095" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528149095">(Jul 10 2025 at 19:46)</a>:</h4>
<p>The parser completely skips them, and even so sometimes they cause weird bugs (or at least the potential for bugs) in the parser</p>



<a name="528150116"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528150116" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528150116">(Jul 10 2025 at 19:54)</a>:</h4>
<p>fair, although <span class="user-mention" data-user-id="361169">@Anton</span> made the point that not having any control over newlines (e.g. wanting to put blank lines between some assignments and not others) would be a pain.</p>
<p>is there some other way we could do that? e.g. use Region info in the formatter to scan for newlines between assignments and if there's more than 1 that means you want a blank line?</p>



<a name="528150828"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528150828" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528150828">(Jul 10 2025 at 19:59)</a>:</h4>
<p>Newlines significant only in some particular places? It makes sense to leave them only where user can contol them for having gaps.</p>
<p>Also, can things like if/else have a parameter <code>is_multiline</code>? It would save tokens in such places. Maybe it's an obvious idea</p>



<a name="528164359"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528164359" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528164359">(Jul 10 2025 at 21:51)</a>:</h4>
<p>Or, if parse ast and cir have the same indexes, newlines aren't needed indeed (because they're noop). It's possible to have a parrallel vector for newline gaps that will contain only indexes of the tokens after which user want to have a gap (on the other hand, u32 per gap is not that great? But this collection would have no region info so memory consumption would be 50% less)</p>



<a name="528167442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528167442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528167442">(Jul 10 2025 at 22:24)</a>:</h4>
<p>So I'm wondering if we should merge this workaround PR <a href="https://github.com/roc-lang/roc/pull/7995">https://github.com/roc-lang/roc/pull/7995</a> I don't feel strongly about it, it was helpful to understand why we were chewing up all that memory.</p>
<p>If we've got a solid plan to move forward with removing newlines or fixing regions then our perf/memory issue won't be a problem for long, and would only a delay our ability to use the profiler effectively until we resolve the underlying root cause.</p>
<p>Is anyone interesting in fixing these?</p>



<a name="528169298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528169298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528169298">(Jul 10 2025 at 22:43)</a>:</h4>
<blockquote>
<p>is there some other way we could do that? e.g. use Region info in the formatter to scan for newlines between assignments and if there's more than 1 that means you want a blank line?</p>
</blockquote>
<p>The formatter already needs to look at the original source to pull out comments, so of course it can still look there to check whether there's a double (or multiple) newline and preserve that if we want.</p>



<a name="528169789"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528169789" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528169789">(Jul 10 2025 at 22:48)</a>:</h4>
<p>yikes, that's how we're doing comments? <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="528169890"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528169890" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528169890">(Jul 10 2025 at 22:50)</a>:</h4>
<p>Tell me more about that 'yikes'</p>



<a name="528169994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528169994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528169994">(Jul 10 2025 at 22:51)</a>:</h4>
<p>It avoids a whole bunch of issues with comment tracking and placement that the parser and AST are now freed from</p>



<a name="528170026"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528170026" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528170026">(Jul 10 2025 at 22:51)</a>:</h4>
<p>All that complexity is concentrated in the formatter, which is the only place that cares about this</p>



<a name="528170141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528170141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528170141">(Jul 10 2025 at 22:52)</a>:</h4>
<p>Consistent comment tracking was probably the <a href="https://github.com/roc-lang/roc/issues/1">#1</a> hardest thing to get right in the old parser</p>



<a name="528171186"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171186" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171186">(Jul 10 2025 at 23:03)</a>:</h4>
<p>maybe I'm misremembering, but I thought the plan was going to be:</p>
<ul>
<li>give the tokenizer a flag where it tokenizes comments into a side table by just storing their Regions (instead of discarding them, which it would do if the flag is false)</li>
<li>then when the formatter is going through emitting things, it can compare the current regions it's working with to those regions in the side table to figure out where the comments are and interleave them back in</li>
</ul>



<a name="528171218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171218">(Jul 10 2025 at 23:03)</a>:</h4>
<p>that sounded pretty simple to me, but maybe I'm misremembering or misunderstanding something <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="528171289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171289">(Jul 10 2025 at 23:04)</a>:</h4>
<p>the yikes is just about re-tokenizing in the middle of formatting, sounds like a lot of extra processing to do</p>



<a name="528171305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171305">(Jul 10 2025 at 23:04)</a>:</h4>
<p>I totally agree that the way we did comments in the previous compiler should not be repeated</p>



<a name="528171434"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171434" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171434">(Jul 10 2025 at 23:05)</a>:</h4>
<p>There's no retokenizing necessary; we're just looking at the space between tokens</p>



<a name="528171462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171462">(Jul 10 2025 at 23:05)</a>:</h4>
<p>(based on token regions)</p>



<a name="528171502"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171502" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171502">(Jul 10 2025 at 23:06)</a>:</h4>
<p>Also no side-table necessary either!</p>



<a name="528171662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171662">(Jul 10 2025 at 23:07)</a>:</h4>
<p>I see, so I guess we're kind of assuming that the space between the tokens is all comments and/or whitespace, since those are the things we discarded</p>



<a name="528171680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171680">(Jul 10 2025 at 23:07)</a>:</h4>
<p>and everything else would have gotten an actual token</p>



<a name="528171815"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171815" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171815">(Jul 10 2025 at 23:09)</a>:</h4>
<p>It's possible there are some sneaky edge-cases there with errors <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="528171850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171850">(Jul 10 2025 at 23:09)</a>:</h4>
<p>e.g. I think mismatched braces currently don't make it into the token stream</p>



<a name="528171864"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528171864" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528171864">(Jul 10 2025 at 23:09)</a>:</h4>
<p>(but they should)</p>



<a name="528172039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528172039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528172039">(Jul 10 2025 at 23:11)</a>:</h4>
<p>yeah, makes sense!</p>



<a name="528172472"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528172472" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528172472">(Jul 10 2025 at 23:16)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> </p>
<blockquote>
<p>If we've got a solid plan to move forward with removing newlines</p>
</blockquote>
<p>Let me take a swing at this to judge how hard this will actually be...</p>



<a name="528172844"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528172844" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528172844">(Jul 10 2025 at 23:20)</a>:</h4>
<p>Sounds good <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> thank you</p>



<a name="528182677"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528182677" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528182677">(Jul 11 2025 at 01:32)</a>:</h4>
<p>Still a few bugs to fix up, but getting pretty close: <a href="https://github.com/roc-lang/roc/pull/8000">https://github.com/roc-lang/roc/pull/8000</a></p>



<a name="528182688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528182688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528182688">(Jul 11 2025 at 01:32)</a>:</h4>
<p>(nice round number there!)</p>



<a name="528182971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528182971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528182971">(Jul 11 2025 at 01:37)</a>:</h4>
<p><a href="/user_uploads/22008/z9_mhX76HUCJtk8OfNo1G7y0/over-8.jpg">over-8.jpg</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/z9_mhX76HUCJtk8OfNo1G7y0/over-8.jpg" title="over-8.jpg"><img data-original-content-type="image/jpeg" data-original-dimensions="640x640" src="/user_uploads/thumbnail/22008/z9_mhX76HUCJtk8OfNo1G7y0/over-8.jpg/840x560.webp"></a></div>



<a name="528187638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528187638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528187638">(Jul 11 2025 at 02:47)</a>:</h4>
<p>I like this way of going much more!!!</p>



<a name="528479018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528479018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528479018">(Jul 12 2025 at 19:15)</a>:</h4>
<p>This is a crazy histogram. What an absolutely crazy long tail</p>
<p><a href="/user_uploads/22008/ZWvyLk77mviO818xcNYt9Bh9/Screenshot-2025-07-12-at-12.15.13PM.png">Screenshot 2025-07-12 at 12.15.13â€¯PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/ZWvyLk77mviO818xcNYt9Bh9/Screenshot-2025-07-12-at-12.15.13PM.png" title="Screenshot 2025-07-12 at 12.15.13â€¯PM.png"><img data-original-content-type="image/png" data-original-dimensions="2526x488" src="/user_uploads/thumbnail/22008/ZWvyLk77mviO818xcNYt9Bh9/Screenshot-2025-07-12-at-12.15.13PM.png/840x560.webp"></a></div>



<a name="528479052"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528479052" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528479052">(Jul 12 2025 at 19:16)</a>:</h4>
<p>This is the time per call to <code>diagnosticToReport</code> for one of the mega files that takes like 2 minutes to run.</p>



<a name="528479348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528479348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528479348">(Jul 12 2025 at 19:22)</a>:</h4>
<p>General question. Why do we make reports at all? Why don't we just stream the output diagnostics and print them right away? Why waste any allocations or memory at all building report objects?</p>



<a name="528479410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528479410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528479410">(Jul 12 2025 at 19:23)</a>:</h4>
<p>Seems that each report is ~1KB of memory use and requires like 10 allocations and 5 frees to make.</p>



<a name="528479689"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528479689" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528479689">(Jul 12 2025 at 19:27)</a>:</h4>
<p>What is that a histogram of?</p>



<a name="528479803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528479803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528479803">(Jul 12 2025 at 19:29)</a>:</h4>
<p>Histogram of execution times of a single call to <code>diagnosticToReport</code></p>



<a name="528479851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528479851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528479851">(Jul 12 2025 at 19:30)</a>:</h4>
<p>When checking one of my gigantic 1 million line of code files that makes a metric ton of errors</p>



<a name="528480448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528480448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528480448">(Jul 12 2025 at 19:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking/near/528479348">said</a>:</p>
<blockquote>
<p>General question. Why do we make reports at all? Why don't we just stream the output diagnostics and print them right away? Why waste any allocations or memory at all building report objects?</p>
</blockquote>
<p>I think what we ideally want is: </p>
<ul>
<li>some abstraction for how we format reports and where we output them, so we can e.g. stream to stderr or send to a language server or send to a UI in a browser or GUI app using Roc for plugins, and also we can use different formats (e.g. ANSI escape codes for terminal, html for browser, something else for editors)</li>
<li>buffering so that we aren't doing a gazillion syscalls</li>
<li>sorting based on module graph so that when you're rebuilding the same project over and over you don't see the same errors jumping around in terms of ordering; rather, they're stable in terms of ordering </li>
<li>streaming, so we flush the buffers as soon as we can (and decide to)</li>
</ul>



<a name="528480530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528480530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528480530">(Jul 12 2025 at 19:44)</a>:</h4>
<p>so for example when writing reports to stderr I think it would be good to have an array of string buffers, one per module, and then when we decide to flush, we can do one <code>pwritev</code> to send them all to stderr in one syscall</p>



<a name="528480562"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528480562" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528480562">(Jul 12 2025 at 19:44)</a>:</h4>
<p>but yeah I don't think there's any reason to make actual heap allocations for the reports, just for the string buffer so we're not making tons of tiny syscalls</p>



<a name="528480870"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528480870" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528480870">(Jul 12 2025 at 19:50)</a>:</h4>
<p>I think currently we still have full source in memory, so reports don't necessarily need any allocations or strings, more just need instructions on how to render</p>



<a name="528480885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528480885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528480885">(Jul 12 2025 at 19:51)</a>:</h4>
<p>Also, I guess I considered diagnostics the list we would sort and pass to tools and what not</p>



<a name="528480896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528480896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528480896">(Jul 12 2025 at 19:51)</a>:</h4>
<p>So why also make a list of reports</p>



<a name="528480903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig%20compiler%20perf%20tracking/near/528480903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig.20compiler.20perf.20tracking.html#528480903">(Jul 12 2025 at 19:51)</a>:</h4>
<p>But I guess they have richer info to pass to an lsp or something</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
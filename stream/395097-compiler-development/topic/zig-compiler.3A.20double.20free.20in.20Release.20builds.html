<html>
<head><meta charset="utf-8"><title>zig-compiler: double free in Release builds · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html">zig-compiler: double free in Release builds</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="545162558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/545162558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#545162558">(Oct 16 2025 at 03:49)</a>:</h4>
<p>This might be hard to debug. I have a sample roc file here: <a href="https://github.com/bhansconnect/chip8_op_test/blob/main/chip8_test_rom.roc">https://github.com/bhansconnect/chip8_op_test/blob/main/chip8_test_rom.roc</a></p>
<p>with a debug build of the compiler <code>roc check</code> works just fine. I have been running with <code>--verbose --no-cache</code> as well.</p>
<p>With a release build of the compiler, it segfaults due to a double free.</p>
<p>If i use a debug allocator in the release build to hopefully get a stack trace,  but it just hangs.</p>
<hr>
<p>I tried to debug this a little bit the other day.<br>
This is where it hangs:<br>
<a href="/user_uploads/22008/2y_Y2v8wbtusQmrucmVyr5K_/Captura-de-pantalla-2025-10-15-a-las-8.33.08p.m..png">Captura de pantalla 2025-10-15 a la(s) 8.33.08 p.m..png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/2y_Y2v8wbtusQmrucmVyr5K_/Captura-de-pantalla-2025-10-15-a-las-8.33.08p.m..png" title="Captura de pantalla 2025-10-15 a la(s) 8.33.08 p.m..png"><img data-original-content-type="image/png" data-original-dimensions="1824x772" src="/user_uploads/thumbnail/22008/2y_Y2v8wbtusQmrucmVyr5K_/Captura-de-pantalla-2025-10-15-a-las-8.33.08p.m..png/840x560.webp"></a></div><p>Which is the same location the double free happens:</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>lldb backtrace</p>
</div><div aria-hidden="true" class="spoiler-content">
<div class="codehilite"><pre><span></span><code>(lldb) bt
* thread #1, queue = 'com.apple.main-thread', stop reason = signal SIGABRT
  * frame #0: 0x000000019282e5b0 libsystem_kernel.dylib`__pthread_kill + 8
    frame #1: 0x0000000192868888 libsystem_pthread.dylib`pthread_kill + 296
    frame #2: 0x000000019276e808 libsystem_c.dylib`abort + 124
    frame #3: 0x000000019266d208 libsystem_malloc.dylib`malloc_vreport + 892
    frame #4: 0x0000000192670f38 libsystem_malloc.dylib`malloc_report + 64
    frame #5: 0x0000000192675db8 libsystem_malloc.dylib`___BUG_IN_CLIENT_OF_LIBMALLOC_POINTER_BEING_FREED_WAS_NOT_ALLOCATED + 76
    frame #6: 0x0000000102947fc0 roc`mem.Allocator.rawFree at Allocator.zig:147:25 [opt]
    frame #7: 0x0000000102947fb0 roc`mem.Allocator.free__anon_18865 at Allocator.zig:418:17 [opt] [inlined]
    frame #8: 0x0000000102947fb0 roc`multi_array_list.MultiArrayList(gpa=mem.Allocator @ 0x0000000c1ecc43e8).deinit at multi_array_list.zig:189:21 [opt] [inlined]
    frame #9: 0x0000000102947fa8 roc`safe_list.SafeMultiList(gpa=mem.Allocator @ 0x0000000c1ecc43e8).deinit at safe_list.zig:412:30 [opt] [inlined]
    frame #10: 0x0000000102947fa8 roc`store.DescStore.deinit(gpa=mem.Allocator @ 0x0000000c1ecc43e8) at store.zig:1032:28 [opt] [inlined]
    frame #11: 0x0000000102947fa8 roc`store.Store.deinit(self=0x0000000c1ecc43e8) at store.zig:121:26 [opt]
    frame #12: 0x00000001028d707c roc`ModuleEnv.deinit(self=0x0000000c1ecc4320) at ModuleEnv.zig:137:22 [opt]
    frame #13: 0x00000001029953d8 roc`compile_package.ModuleState.deinit(self=0x0000000c1ecc4300) at compile_package.zig:109:36 [opt] [inlined]
    frame #14: 0x00000001029953c4 roc`compile_package.PackageEnv.deinit(self=0x0000000c1ecb4000) at compile_package.zig:192:22 [opt]
    frame #15: 0x000000010299538c roc`compile_build.BuildEnv.deinit(self=0x000000016fdfdf20) at compile_build.zig:409:26 [opt]
    frame #16: 0x0000000102934a94 roc`main.checkFileWithBuildEnv(allocs=&lt;unavailable&gt;, cache_config=&lt;unavailable&gt;) at main.zig:2744:27 [opt] [inlined]
    frame #17: 0x0000000102934a84 roc`main.rocCheck(allocs=&lt;unavailable&gt;, args=cli_args.CheckArgs @ 0x000000016fdfc260) at main.zig:2819:45 [opt] [inlined]
    frame #18: 0x0000000102934a84 roc`main.mainArgs(allocs=&lt;unavailable&gt;) at main.zig:415:40 [opt]
    frame #19: 0x000000010293d62c roc`main.main at main.zig:365:28 [opt] [inlined]
    frame #20: 0x000000010293d53c roc`start.callMain at start.zig:660:37 [opt] [inlined]
    frame #21: 0x000000010293d53c roc`start.callMainWithArgs at start.zig:620:20 [opt]
    frame #22: 0x000000010293d53c roc`start.main(c_argc=&lt;unavailable&gt;, c_argv=&lt;unavailable&gt;, c_envp=&lt;unavailable&gt;) at start.zig:635:28 [opt]
    frame #23: 0x00000001924a9d54 dyld`start + 7184
</code></pre></div>
</div></div>
<p>I'm not sure what is going on, but if I add prints to <code>ModuleEnv.deinit</code>, I can see that it is called twice in release builds, but only once in debug builds.</p>
<div class="spoiler-block"><div class="spoiler-header">
<p>release free locations</p>
</div><div aria-hidden="true" class="spoiler-content">
<div class="codehilite"><pre><span></span><code>/Users/bren077s/Projects/roc/zig-out/bin/roc check --verbose --no-cache /Users/bren077s/Projects/chip8/chip8_test_rom.roc


========== deinit ModuleEnv@16dde74b8 ==========
/Users/bren077s/Projects/roc/src/canonicalize/ModuleEnv.zig:137:36: 0x1048eb133 in deinit (roc)
    std.debug.dumpCurrentStackTrace(null);
                                   ^
/Users/bren077s/Projects/roc/src/compile/compile_build.zig:738:25: 0x10496b6bf in parseHeaderDeps (roc)
        defer env.deinit();
                        ^
/Users/bren077s/Projects/roc/src/compile/compile_build.zig:470:51: 0x1049a66eb in build (roc)
        var header_info = try self.parseHeaderDeps(root_abs);
                                                  ^
/Users/bren077s/Projects/roc/src/cli/main.zig:2755:24: 0x10494758f in mainArgs (roc)
    try build_env.build(filepath);
                       ^
/Users/bren077s/Projects/roc/src/cli/main.zig:365:28: 0x104950b83 in main (roc)
    const result = mainArgs(&amp;allocs, args);
                           ^
???:?:?: 0x1924a9d53 in ??? (???)
???:?:?: 0x0 in ??? (???)


========== deinit ModuleEnv@738c64320 ==========
/Users/bren077s/Projects/roc/src/canonicalize/ModuleEnv.zig:137:36: 0x1048eb133 in deinit (roc)
    std.debug.dumpCurrentStackTrace(null);
                                   ^
/Users/bren077s/Projects/roc/src/compile/compile_package.zig:109:36: 0x1049a9553 in deinit (roc)
        if (self.env) |*e| e.deinit();
                                   ^
/Users/bren077s/Projects/roc/src/cli/main.zig:2744:27: 0x104947feb in mainArgs (roc)
    defer build_env.deinit();
                          ^
/Users/bren077s/Projects/roc/src/cli/main.zig:365:28: 0x104950b83 in main (roc)
    const result = mainArgs(&amp;allocs, args);
                           ^
???:?:?: 0x1924a9d53 in ??? (???)
???:?:?: 0x0 in ??? (???)
roc(36278,0x1ff214800) malloc: *** error for object 0x738810000: pointer being freed was not allocated
roc(36278,0x1ff214800) malloc: *** set a breakpoint in malloc_error_break to debug
zsh: abort      /Users/bren077s/Projects/roc/zig-out/bin/roc check --verbose --no-cache
</code></pre></div>
</div></div>
<div class="spoiler-block"><div class="spoiler-header">
<p>debug frees</p>
</div><div aria-hidden="true" class="spoiler-content">
<div class="codehilite"><pre><span></span><code>/Users/bren077s/Projects/roc/zig-out/bin/roc check --verbose --no-cache /Users/bren077s/Projects/chip8/chip8_test_rom.roc


========== deinit ModuleEnv@16f023410 ==========
/Users/bren077s/vendor/zig-0.14.1/lib/std/debug.zig:337:31: 0x10450fd37 in dumpCurrentStackTrace (roc)
        writeCurrentStackTrace(stderr, debug_info, io.tty.detectConfig(io.getStdErr()), start_addr) catch |err| {
                              ^
/Users/bren077s/Projects/roc/src/canonicalize/ModuleEnv.zig:137:36: 0x1045af11b in deinit (roc)
    std.debug.dumpCurrentStackTrace(null);
                                   ^
/Users/bren077s/Projects/roc/src/compile/compile_build.zig:738:25: 0x1046787e7 in parseHeaderDeps (roc)
        defer env.deinit();
                        ^
/Users/bren077s/Projects/roc/src/compile/compile_build.zig:470:51: 0x1046ca5a7 in build (roc)
        var header_info = try self.parseHeaderDeps(root_abs);
                                                  ^
/Users/bren077s/Projects/roc/src/cli/main.zig:2755:24: 0x1045e3413 in checkFileWithBuildEnv (roc)
    try build_env.build(filepath);
                       ^
/Users/bren077s/Projects/roc/src/cli/main.zig:2819:45: 0x1045e205f in rocCheck (roc)
    var check_result = checkFileWithBuildEnv(
                                            ^
/Users/bren077s/Projects/roc/src/cli/main.zig:415:40: 0x1046196af in mainArgs (roc)
        .check =&gt; |check_args| rocCheck(allocs, check_args),
                                       ^
/Users/bren077s/Projects/roc/src/cli/main.zig:365:28: 0x10461bdc7 in main (roc)
    const result = mainArgs(&amp;allocs, args);
                           ^
/Users/bren077s/vendor/zig-0.14.1/lib/std/start.zig:660:37: 0x10461c373 in main (roc)
            const result = root.main() catch |err| {
                                    ^
???:?:?: 0x1924a9d53 in ??? (???)
???:?:?: 0x0 in ??? (???)
No errors found in 241.6 ms for /Users/bren077s/Projects/chip8/chip8_test_rom.roc%
</code></pre></div>
</div></div>
<p>Anyone have thoughts?</p>



<a name="545163243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/545163243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#545163243">(Oct 16 2025 at 03:53)</a>:</h4>
<p>I'm really not sure</p>



<a name="545163518"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/545163518" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#545163518">(Oct 16 2025 at 03:55)</a>:</h4>
<p>Also, of note, the error specifically comes from freeing part of the type checking state I think. The DescStore in the TypeStore. So it could also be related to something type checking specfic and not moduleenv technically.</p>



<a name="545163734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/545163734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#545163734">(Oct 16 2025 at 03:56)</a>:</h4>
<p>It's the debug vs release thing that has me a little stumped</p>



<a name="545163772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/545163772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#545163772">(Oct 16 2025 at 03:56)</a>:</h4>
<p>So I see two confusions:</p>
<ol>
<li>Why doesn't debug free things here? What is the delta?</li>
<li>It isn't the entire moduleenv being double freed. just the DescStore. What is special about it?</li>
</ol>



<a name="546257521"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546257521" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546257521">(Oct 21 2025 at 14:48)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> you should test gpt 5 codex high on this one</p>



<a name="546272295"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546272295" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546272295">(Oct 21 2025 at 15:50)</a>:</h4>
<p>I will :)<br>
On what OS did you hit the segfault, macOS?</p>



<a name="546276729"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546276729" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546276729">(Oct 21 2025 at 16:11)</a>:</h4>
<p>Ok, I was able to reproduce it on macOS</p>



<a name="546294666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546294666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546294666">(Oct 21 2025 at 17:40)</a>:</h4>
<p>Success :)</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code>❯ git diff
<span class="gh">diff --git a/src/eval/interpreter.zig b/src/eval/interpreter.zig</span>
<span class="gh">index a6e61957bb..42254a1dcf 100644</span>
<span class="gd">--- a/src/eval/interpreter.zig</span>
<span class="gi">+++ b/src/eval/interpreter.zig</span>
<span class="gu">@@ -92,6 +92,11 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>        }
<span class="w"> </span>    };
<span class="w"> </span>    const Binding = struct { pattern_idx: can.CIR.Pattern.Idx, value: StackValue };
<span class="gi">+    const DefInProgress = struct {</span>
<span class="gi">+        pattern_idx: can.CIR.Pattern.Idx,</span>
<span class="gi">+        expr_idx: can.CIR.Expr.Idx,</span>
<span class="gi">+        value: ?StackValue,</span>
<span class="gi">+    };</span>
<span class="w"> </span>    allocator: std.mem.Allocator,
<span class="w"> </span>    runtime_types: *types.store.Store,
<span class="w"> </span>    runtime_layout_store: layout.Store,
<span class="gu">@@ -127,6 +132,7 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>    builtins: BuiltinTypes,
<span class="w"> </span>    /// Map from module name to ModuleEnv for resolving e_lookup_external expressions
<span class="w"> </span>    imported_modules: std.StringHashMap(*const can.ModuleEnv),
<span class="gi">+    def_stack: std.array_list.Managed(DefInProgress),</span>

<span class="w"> </span>    pub fn init(allocator: std.mem.Allocator, env: *can.ModuleEnv, builtin_types: BuiltinTypes, imported_modules_map: ?*const std.AutoHashMap(base_pkg.Ident.Idx, can.Can.AutoImportedType)) !Interpreter {
<span class="w"> </span>        // Convert imported modules map to other_envs slice
<span class="gu">@@ -184,6 +190,7 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>            .scratch_tags = try std.array_list.Managed(types.Tag).initCapacity(allocator, 8),
<span class="w"> </span>            .builtins = builtin_types,
<span class="w"> </span>            .imported_modules = std.StringHashMap(*const can.ModuleEnv).init(allocator),
<span class="gi">+            .def_stack = try std.array_list.Managed(DefInProgress).initCapacity(allocator, 4),</span>
<span class="w"> </span>        };
<span class="w"> </span>        result.runtime_layout_store = try layout.Store.init(env, result.runtime_types);

<span class="gu">@@ -195,6 +202,14 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>        return try self.evalExprMinimal(expr_idx, roc_ops, null);
<span class="w"> </span>    }

<span class="gi">+    fn registerDefValue(self: *Interpreter, expr_idx: can.CIR.Expr.Idx, value: StackValue) void {</span>
<span class="gi">+        if (self.def_stack.items.len == 0) return;</span>
<span class="gi">+        var top = &amp;self.def_stack.items[self.def_stack.items.len - 1];</span>
<span class="gi">+        if (top.expr_idx == expr_idx and top.value == null) {</span>
<span class="gi">+            top.value = value;</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="w"> </span>    pub fn startTrace(self: *Interpreter) void {
<span class="w"> </span>        _ = self;
<span class="w"> </span>    }
<span class="gu">@@ -1236,6 +1251,7 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>                // Expect a closure layout from type-to-layout translation
<span class="w"> </span>                if (closure_layout.tag != .closure) return error.NotImplemented;
<span class="w"> </span>                const value = try self.pushRaw(closure_layout, 0);
<span class="gi">+                self.registerDefValue(expr_idx, value);</span>
<span class="w"> </span>                // Initialize the closure header
<span class="w"> </span>                if (value.ptr) |ptr| {
<span class="w"> </span>                    const header: *layout.Closure = @ptrCast(@alignCast(ptr));
<span class="gu">@@ -1298,7 +1314,24 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>                        for (all_defs) |def_idx| {
<span class="w"> </span>                            const def = self_interp.env.store.getDef(def_idx);
<span class="w"> </span>                            if (def.pattern == cap.pattern_idx) {
<span class="gi">+                                var k: usize = self_interp.def_stack.items.len;</span>
<span class="gi">+                                while (k &gt; 0) {</span>
<span class="gi">+                                    k -= 1;</span>
<span class="gi">+                                    const entry = self_interp.def_stack.items[k];</span>
<span class="gi">+                                    if (entry.pattern_idx == cap.pattern_idx) {</span>
<span class="gi">+                                        if (entry.value) |val| {</span>
<span class="gi">+                                            return val;</span>
<span class="gi">+                                        }</span>
<span class="gi">+                                    }</span>
<span class="gi">+                                }</span>
<span class="w"> </span>                                // Found the def! Evaluate it to get the captured value
<span class="gi">+                                const new_entry = DefInProgress{</span>
<span class="gi">+                                    .pattern_idx = def.pattern,</span>
<span class="gi">+                                    .expr_idx = def.expr,</span>
<span class="gi">+                                    .value = null,</span>
<span class="gi">+                                };</span>
<span class="gi">+                                self_interp.def_stack.append(new_entry) catch return null;</span>
<span class="gi">+                                defer _ = self_interp.def_stack.pop();</span>
<span class="w"> </span>                                return self_interp.evalMinimal(def.expr, ops) catch null;
<span class="w"> </span>                            }
<span class="w"> </span>                        }
<span class="gu">@@ -1309,14 +1342,16 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>                for (caps, 0..) |cap_idx, i| {
<span class="w"> </span>                    const cap = self.env.store.getCapture(cap_idx);
<span class="w"> </span>                    field_names[i] = cap.name;
<span class="gd">-                    const captured_val = resolveCapture(self, cap, roc_ops) orelse return error.NotImplemented;</span>
<span class="gd">-                    field_layouts[i] = captured_val.layout;</span>
<span class="gi">+                    const cap_ct_var = can.ModuleEnv.varFrom(cap.pattern_idx);</span>
<span class="gi">+                    const cap_rt_var = try self.translateTypeVar(self.env, cap_ct_var);</span>
<span class="gi">+                    field_layouts[i] = try self.getRuntimeLayout(cap_rt_var);</span>
<span class="w"> </span>                }

<span class="w"> </span>                const captures_layout_idx = try self.runtime_layout_store.putRecord(field_layouts, field_names);
<span class="w"> </span>                const captures_layout = self.runtime_layout_store.getLayout(captures_layout_idx);
<span class="w"> </span>                const closure_layout = Layout.closure(captures_layout_idx);
<span class="w"> </span>                const value = try self.pushRaw(closure_layout, 0);
<span class="gi">+                self.registerDefValue(expr_idx, value);</span>

<span class="w"> </span>                // Initialize header
<span class="w"> </span>                if (value.ptr) |ptr| {
<span class="gu">@@ -3321,6 +3356,7 @@ pub const Interpreter = struct {</span>
<span class="w"> </span>        self.stack_memory.deinit();
<span class="w"> </span>        self.bindings.deinit();
<span class="w"> </span>        self.active_closures.deinit();
<span class="gi">+        self.def_stack.deinit();</span>
<span class="w"> </span>        self.scratch_tags.deinit();
<span class="w"> </span>        self.imported_modules.deinit();
<span class="w"> </span>    }
</code></pre></div>



<a name="546295134"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546295134" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546295134">(Oct 21 2025 at 17:42)</a>:</h4>
<p>Can you confirm that this is a sensible fix <span class="user-mention" data-user-id="281383">@Richard Feldman</span>?</p>



<a name="546296370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546296370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546296370">(Oct 21 2025 at 17:48)</a>:</h4>
<p>I put it up in <a href="https://github.com/roc-lang/roc/pull/8315">https://github.com/roc-lang/roc/pull/8315</a></p>



<a name="546309589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546309589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546309589">(Oct 21 2025 at 19:09)</a>:</h4>
<p>A fix for a roc check fail is in the interpreter? I didn't realize roc check hit the interpreter. Interesting.</p>



<a name="546310273"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546310273" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546310273">(Oct 21 2025 at 19:13)</a>:</h4>
<p>Just ran the fix to double check. It's fixed!</p>
<p>Color me impressed.</p>



<a name="546316392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546316392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546316392">(Oct 21 2025 at 19:54)</a>:</h4>
<p>yeah the interpreter runs to do compile-time evaluation of constants</p>



<a name="546316432"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546316432" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546316432">(Oct 21 2025 at 19:55)</a>:</h4>
<p>that exists already! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="546316520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546316520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546316520">(Oct 21 2025 at 19:55)</a>:</h4>
<p>crashes and dbgs and failed expects all get reported at build time as part of <code>roc check</code>'s normal output</p>



<a name="546321328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/zig-compiler%3A%20double%20free%20in%20Release%20builds/near/546321328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/zig-compiler.3A.20double.20free.20in.20Release.20builds.html#546321328">(Oct 21 2025 at 20:26)</a>:</h4>
<p>This was broken before compile time evaluation of constants existed (assuming that just got added with the PR shared the other day). I wonder if compile time evaluation of constants shifted the issue.</p>
<p>Either way, awesome it is fixed</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
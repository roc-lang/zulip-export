<html>
<head><meta charset="utf-8"><title>upgrade-llvm-zig Â· compiler development Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html">upgrade-llvm-zig</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="453602243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453602243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453602243">(Jul 24 2024 at 05:55)</a>:</h4>
<p>I managed to learn just enough nix to update the flakes and get a dev shell set up with the correct dependencies for llvm17 and zig12, I pushed it to <a href="https://github.com/roc-lang/roc/tree/llvm17-zig12">the llvm17-zig12 branch</a>.</p>



<a name="453602573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453602573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453602573">(Jul 24 2024 at 05:59)</a>:</h4>
<p>Actually... maybe not. I'm close though</p>



<a name="453605048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605048">(Jul 24 2024 at 06:17)</a>:</h4>
<p>Should we go straight for llvm18 and zig13?</p>



<a name="453605071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605071">(Jul 24 2024 at 06:17)</a>:</h4>
<p>They are both out, right?</p>



<a name="453605085"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605085" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605085">(Jul 24 2024 at 06:17)</a>:</h4>
<p>Yeah, I looked at that. The only thing I wasn't 100% on was inkwell</p>



<a name="453605148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605148">(Jul 24 2024 at 06:18)</a>:</h4>
<p>If we pin to tag 0.4.0 then it looks like that includes 17, but 18 is still sitting in a CI branch and I'm guessing not ready</p>



<a name="453605151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605151">(Jul 24 2024 at 06:18)</a>:</h4>
<p>inkwell github says it support llvm 18</p>



<a name="453605282"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605282" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605282">(Jul 24 2024 at 06:19)</a>:</h4>
<p>I know it in the README, but I couldn't make cargo happy. It was saying it didn't exist</p>



<a name="453605351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605351">(Jul 24 2024 at 06:19)</a>:</h4>
<p>Ah, I see, that is master. 0.4.0 is only to llvm 17</p>



<a name="453605773"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605773" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605773">(Jul 24 2024 at 06:21)</a>:</h4>
<p>I'm currently fumbling around trying to understand the differences between rust's llvm-sys, and why is needs a very specific binary to check the llvm version. That binary isn't provided in the newer <a href="https://search.nixos.org/packages?channel=24.05&amp;from=0&amp;size=50&amp;sort=relevance&amp;type=packages&amp;query=llvmPackages_18.clang">llvmPackages_18.clangUseLLVM</a></p>



<a name="453605778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605778">(Jul 24 2024 at 06:21)</a>:</h4>
<p>Yeah, looks like they have everything update for 18, but haven't cut a release yet</p>



<a name="453605908"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453605908" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453605908">(Jul 24 2024 at 06:22)</a>:</h4>
<p>Honestly, I would just pin the release to a git commit for now, update to llvm18 and avoid the need for two separate updates.</p>



<a name="453606008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453606008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453606008">(Jul 24 2024 at 06:22)</a>:</h4>
<p>Or fork and tag in a fork. I know we've done this before, not sure the exact mechanism though.</p>



<a name="453606315"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453606315" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453606315">(Jul 24 2024 at 06:24)</a>:</h4>
<p>I know the zig upgrade to 12/13 was quite painless before the recent refcount changes. I can motor through to bulk of that, but there's some low level stuff I can't fixup. One example was we are using overflow flag from a builtin (I think) and it's no longer available in the later versions.</p>



<a name="453606416"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453606416" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453606416">(Jul 24 2024 at 06:24)</a>:</h4>
<p>I spent a bit of time trying to update our builtins for the roc-wasm4 stuff, and that was the point I got stuck and deferred for a laterday.</p>



<a name="453606619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453606619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453606619">(Jul 24 2024 at 06:25)</a>:</h4>
<p>I figure, first stop is just getting our nix dependencies happy and working from there. </p>
<p>I don't have any experience with these kind of upgrades... just learning as I go</p>



<a name="453607759"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453607759" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453607759">(Jul 24 2024 at 06:30)</a>:</h4>
<p>Can we just track master maybe, and as we get closer we can pin to a specific tag, or maybe a later release?</p>



<a name="453608648"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453608648" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453608648">(Jul 24 2024 at 06:35)</a>:</h4>
<p>From the llvm-sys crate docs</p>
<blockquote>
<p>llvm-sys requires a copy ofÂ <code>llvm-config</code>Â corresponding to the desired version of LLVM to build:Â <code>llvm-config</code>Â allows it to probe what libraries need to be linked and what compiler options are required.</p>
</blockquote>
<blockquote>
<p>Binary distributions of LLVM (including the official release packages) generally<strong>do not</strong>Â include a copy ofÂ <code>llvm-config</code>, making them unsuited to use for building programs withÂ <code>llvm-sys</code>. Known exceptions (thatÂ <em>do</em>Â include a copy ofÂ <code>llvm-config</code>) include:<br>
* Official Debian/Ubuntu packages fromÂ <a href="https://apt.llvm.org/">apt.llvm.org</a><br>
* Arch Linux'sÂ <a href="https://archlinux.org/packages/extra/x86_64/llvm/"><code>llvm</code></a>Â package</p>
</blockquote>
<blockquote>
<p>If a suitable binary package is not available for your platform, compiling from source is usually the best option. SeeÂ <a href="https://crates.io/crates/llvm-sys#compiling-llvm">Compiling LLVM in this document</a>Â for details.</p>
</blockquote>
<p>How would we work around this if nix doesn't provide that binary?</p>



<a name="453609101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453609101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453609101">(Jul 24 2024 at 06:37)</a>:</h4>
<blockquote>
<p>Can we just track master maybe, and as we get closer we can pin to a specific tag, or maybe a later release?</p>
</blockquote>
<p>Yeah, I think that's fine. At a minimum it's fine for local testing</p>



<a name="453609169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453609169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453609169">(Jul 24 2024 at 06:38)</a>:</h4>
<blockquote>
<p>How would we work around this if nix doesn't provide that binary?</p>
</blockquote>
<p>Should be part of the llvm nix package I believe</p>



<a name="453609488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453609488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453609488">(Jul 24 2024 at 06:41)</a>:</h4>
<p>nvm, I was using the wrong nix package and output. It's <strong>llvmPackages_18.libllvm.dev</strong> not <strong>llvmPackages_18.clangUseLLVM.out</strong></p>



<a name="453609555"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453609555" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453609555">(Jul 24 2024 at 06:41)</a>:</h4>
<p>Great, now Im through to actual roc code issues.</p>



<a name="453609904"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453609904" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453609904">(Jul 24 2024 at 06:45)</a>:</h4>
<p>There isn't a nix package for zig 13 yet. But I'll just leave it as 12 for now as they are very similar, and it should be really easy to upgrade when there is a release.</p>



<a name="453609976"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453609976" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453609976">(Jul 24 2024 at 06:45)</a>:</h4>
<p>Ah, then I guess you have to use llvm17. I think our version of llvm has to match zigs....though it may be fine if our version of llvm is newer than zigs. Cause llvm probably can load old llvm ir.</p>



<a name="453610055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453610055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453610055">(Jul 24 2024 at 06:46)</a>:</h4>
<p>Also pushed to a new branch that is less confusing <a href="https://github.com/roc-lang/roc/tree/upgrade-llvm-zig">https://github.com/roc-lang/roc/tree/upgrade-llvm-zig</a></p>



<a name="453610098"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453610098" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453610098">(Jul 24 2024 at 06:46)</a>:</h4>
<p>I forgot about that</p>



<a name="453610852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453610852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453610852">(Jul 24 2024 at 06:53)</a>:</h4>
<p>Ok, based on my 2 minutes research... We have zig producing LLVM bitcode. Zig 12 produces LLVM 17.0.6, so I think we should keep them paired just in case.</p>



<a name="453611688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453611688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453611688">(Jul 24 2024 at 07:00)</a>:</h4>
<blockquote>
<p><code>Cause llvm probably can load old llvm ir.</code> </p>
</blockquote>
<p>does this help? <a href="https://releases.llvm.org/18.1.0/docs/ReleaseNotes.html#changes-to-the-llvm-ir">https://releases.llvm.org/18.1.0/docs/ReleaseNotes.html#changes-to-the-llvm-ir</a></p>



<a name="453611899"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453611899" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453611899">(Jul 24 2024 at 07:01)</a>:</h4>
<p>I just search all of the builtins bitcode <code>.ll</code> files and none of these are used. So maybe we should be fine.</p>



<a name="453622479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453622479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453622479">(Jul 24 2024 at 07:57)</a>:</h4>
<p>Ok, so back to a happy place. <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>I've got to the following point;</p>
<ul>
<li>Updated flakes to give us llvm 18, and zig 13 (also added zls 13) </li>
<li>I switched to using the zig and zls overlays which look to build from source, so we can get any version we want much easier.</li>
</ul>
<p>Now I'm up to cargo build crashing at the builtins, which is because of the obvious changes between zig versions.</p>



<a name="453622684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453622684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453622684">(Jul 24 2024 at 07:58)</a>:</h4>
<p><span class="user-mention" data-user-id="666594">@John Murray</span>  -- it's been a while, but wondering if you would be able to skim through my flake changes and let me know if there is anything I've probably broken?? <a href="https://github.com/roc-lang/roc/tree/upgrade-llvm-zig">https://github.com/roc-lang/roc/tree/upgrade-llvm-zig</a></p>



<a name="453648353"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453648353" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453648353">(Jul 24 2024 at 09:48)</a>:</h4>
<p>zig 13 is on the latest nix unstable which we can easily use by updating to a more recent commit <a href="https://github.com/roc-lang/roc/blob/d5db3137a3d8da46f92c31b6bf088bc495f759c2/flake.nix#L5">here</a>. It's just called zig, not zig_0_13. I'd prefer to use that over the overlay because it's less complex.</p>



<a name="453674778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453674778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453674778">(Jul 24 2024 at 12:02)</a>:</h4>
<p>Ok, sounds good. </p>
<p>What is the difference between a release like <code>24.05</code> and <code>unstable</code>? Is it like tracking main but we can still pin to a specific commit? With the intention to switch to a release later when it's available.</p>



<a name="453676021"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/453676021" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#453676021">(Jul 24 2024 at 12:07)</a>:</h4>
<blockquote>
<p>Is it like tracking main but we can still pin to a specific commit?</p>
</blockquote>
<p>Yes, exactly. I think the main benefit of using e.g. 24.05 is better caching and build times.</p>



<a name="454143028"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454143028" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454143028">(Jul 26 2024 at 01:51)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> -- I had a crack at switching back to using the unstable branch. I had a few issues though. For some reason that <code>llvm_18</code> package doesn't include the same folder structure. It doesn't include a <code>/lib</code>, and it's missing <code>lld</code>. I've just left it using zig-overlay for now.</p>



<a name="454150846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454150846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Basile Henry <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454150846">(Jul 26 2024 at 02:48)</a>:</h4>
<p>It has multiple outputs, I would try <code>llvm_18.dev</code> or <code>llvm_18.lib</code></p>



<a name="454547309"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454547309" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454547309">(Jul 28 2024 at 00:42)</a>:</h4>
<p>Quick update on this. </p>
<p>To get the compiler compiling, all we needed to do was comment out a few calls to different LLVM optimisation passes, as these are no longer exposed in the new Inkwell API. I ran the gen-llvm tests and had only 1 failure. Our examples seems to run fine. But I think we should investigate what impact the API change has, and if we need to do something differently to turn optimisations on, or if it's just on by default now. </p>
<p>The next issue with this change is that zig has changed it's cli arguments, and the <code>--mod</code> and <code>--deps</code> arguments are no longer available. We used these to pass in the zig builtins "glue" code for each of the platform's hosts. </p>
<p>Thanks to <span class="user-mention" data-user-id="453714">@Ryan Barth</span> who helped me come up with a really simple way to workaround this issue. I had been exploring using zig packages, and build scripts and all kinds of things but thankfully these aren't necessary. </p>
<p>We can simply use a bash script and copy the zig src files into the platform directories. There doesn't need to be any big changes, and this also plays nicely with the refactor host PR. We can gitignore the copied files, and when the script re-runs it will overwrite these.</p>
<p>So I'm just working on making this script and having it called once before the tests are run. Then we should be able to run the full test suite and see if anything breaks.</p>



<a name="454580377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454580377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454580377">(Jul 28 2024 at 07:29)</a>:</h4>
<p>Ok, so I think I have all of the fiddly and tedious bits out of the way. We've upgraded the test platforms, zig builtins etc. </p>
<p>I've left the CI parts to work through with Anton later, as we may want to do things differently -- but that should be really straightforward I think.</p>
<p>I'm only seeing 1 test failure when running gen-test-llvm, <code>num_to_str_f32</code> -- I'm thinking this will be a simple fix, but haven't really looked at the IR or anything yet. (not that I know what I'm looking for <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> )</p>
<div class="codehilite"><pre><span></span><code>---- gen_num::num_to_str_f32 stdout ----
thread &#39;gen_num::num_to_str_f32&#39; panicked at crates/compiler/test_gen/src/helpers/llvm.rs:575:13:
assertion `left == right` failed: LLVM test failed
  left: &quot;340282350000000000000000000000000000000&quot;
 right: &quot;340282346638528860000000000000000000000&quot;


failures:
    gen_num::num_to_str_f32

test result: FAILED. 1293 passed; 1 failed; 17 ignored; 0 measured; 0 filtered out; finished in 612.91s
</code></pre></div>
<p>The only other tests that are failing now are in <code>roc_glue</code> which all look to be related to the same issue. I think its related to zig builtin linking -- maybe zig changed the way it does things or something about remove dead code maybe.</p>
<div class="codehilite"><pre><span></span><code>$ ./target/debug/roc build crates/glue/tests/fixtures/basic-record/app.roc
ðŸ”¨ Rebuilding platform...
Undefined symbols for architecture arm64:
  &quot;_roc_getppid&quot;, referenced from:
      _roc_builtins.utils.expect_failed_start_shared_file in roc_appNDMFxA.o
      _roc_builtins.utils.read_env_shared_buffer in roc_appNDMFxA.o
  &quot;_roc_mmap&quot;, referenced from:
      _roc_builtins.utils.expect_failed_start_shared_file in roc_appNDMFxA.o
      _roc_builtins.utils.read_env_shared_buffer in roc_appNDMFxA.o
  &quot;_roc_shm_open&quot;, referenced from:
      _roc_builtins.utils.expect_failed_start_shared_file in roc_appNDMFxA.o
      _roc_builtins.utils.read_env_shared_buffer in roc_appNDMFxA.o
ld: symbol(s) not found for architecture arm64
crates/glue/tests/fixtures/basic-record/app: is already signed
thread &#39;main&#39; panicked at crates/compiler/build/src/program.rs:1031:17:
not yet implemented: gracefully handle `ld` (or `zig` in the case of wasm with --optimize) returning exit code Some(1)
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>



<a name="454580710"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454580710" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454580710">(Jul 28 2024 at 07:34)</a>:</h4>
<p>Also, I would appreciate assistance from anyone with rust or LLVM knowledge to look at the changes in <code>crates/compiler/gen_llvm/src/llvm/build.rs</code> and help me investigate what the changes mean. </p>
<p>I think <a href="https://releases.llvm.org/17.0.1/docs/ReleaseNotes.html#changes-to-llvm-infrastructure">this is the relevant part</a> of the release notes. </p>
<blockquote>
<ul>
<li>The legacy optimization pipeline (<code>PassManagerBuilder.h</code>) has been removed. See theÂ <a href="https://llvm.org/docs/NewPassManager.html">new pass manager docs</a>Â for how to use the new pass manager APIs.</li>
</ul>
</blockquote>



<a name="454580935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454580935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454580935">(Jul 28 2024 at 07:39)</a>:</h4>
<p>I bet that zig changed there float printing algorim and how it rounds</p>



<a name="454580936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454580936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454580936">(Jul 28 2024 at 07:39)</a>:</h4>
<p>So I bet the test case is incorrect now.</p>



<a name="454597015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454597015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454597015">(Jul 28 2024 at 10:34)</a>:</h4>
<p>What a guess. Looks like your correct <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>
<h2>0.11.0</h2>
<div class="codehilite"><pre><span></span><code>$ zig build run
All your 340282346638528860000000000000000000000 are belong to us.
Run `zig build test` to run the tests.
</code></pre></div>
<h2>0.13.0</h2>
<div class="codehilite"><pre><span></span><code>(nix:nix-shell-env) 192-168-1-103:zig-test-13 luke$ zig build-exe src/main.zig &amp;&amp; ./main
All your 340282350000000000000000000000000000000 are belong to us.
</code></pre></div>



<a name="454633865"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454633865" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454633865">(Jul 28 2024 at 16:29)</a>:</h4>
<p>I work with floats a lot in ml....that just looked correct to be the minimum length float that still would parse back to the original value</p>



<a name="454774325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/454774325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#454774325">(Jul 29 2024 at 09:25)</a>:</h4>
<blockquote>
<p>Also, I would appreciate assistance from anyone with rust or LLVM knowledge to look at the changes</p>
</blockquote>
<p>I would try to find other rust projects that use inkwell and that have already performed this update to the new pass manager.</p>



<a name="455206066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455206066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455206066">(Jul 30 2024 at 19:43)</a>:</h4>
<p>Thanks to <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> we're down to one issue blocking a run at CI now I think -- just the "Undefined symbols for architecture arm64" thing above which I haven't looked into yet.</p>
<p>We got the optimisation passes back (or at least hacked in) and working for llvm, and fixed the <code>gen_num::num_to_str_f32</code> test.</p>



<a name="455283086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455283086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455283086">(Jul 31 2024 at 04:50)</a>:</h4>
<p>Ok, 100% tests are <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span>  passing on my mac <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="455283385"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455283385" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455283385">(Jul 31 2024 at 04:52)</a>:</h4>
<p>I might give CI a run just to see if everything passes there too. </p>
<p>Still need to cleanup the LLVM stuff, mostly ripping out the unused things, and also fixing up the pointer types which are giving us a warning now -- but should be pretty straight forward.</p>



<a name="455283732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455283732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455283732">(Jul 31 2024 at 04:54)</a>:</h4>
<p>We are still using the zig and zls overlays... I couldn't get the nixpkgs thing working when I tried. I might defer changing that back to someone who knows what they are doing.</p>



<a name="455283913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455283913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455283913">(Jul 31 2024 at 04:55)</a>:</h4>
<p>Also, there are documentation and various references to the old LLVM 16 which need to be updated</p>



<a name="455286040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455286040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455286040">(Jul 31 2024 at 05:13)</a>:</h4>
<p>Ok, CI fails with this. Which I think means I've done something wrong in <code>nix/builder.nix</code> </p>
<div class="codehilite"><pre><span></span><code>$ nix build
warning: Git tree &#39;/Users/luke/Documents/GitHub/roc&#39; is dirty
warning: input &#39;rust-overlay&#39; has an override for a non-existent input &#39;flake-utils&#39;
error: builder for &#39;/nix/store/gi3j8vs8qq54zy5vv0zji6h2l6cdrqsv-roc_cli-0.0.1.drv&#39; failed with exit code 101;
       last 25 log lines:
       &gt;    Compiling roc_bitcode_bc v0.0.1 (/private/tmp/nix-build-roc_cli-0.0.1.drv-0/source/crates/compiler/builtins/bitcode/bc)
       &gt;    Compiling packed_struct v0.10.1
       &gt;    Compiling inkwell v0.4.0 (https://github.com/TheDan64/inkwell?rev=89e06af#89e06af9)
       &gt; error: No suitable version of LLVM was found system-wide or pointed
       &gt;               to by LLVM_SYS_180_PREFIX.
       &gt;
</code></pre></div>
<p><code>nix develop</code> work for me, so it's just a nix setup thing.</p>



<a name="455288125"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455288125" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455288125">(Jul 31 2024 at 05:35)</a>:</h4>
<p>I think I (actually Claude) found a solution.</p>



<a name="455543313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455543313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455543313">(Aug 01 2024 at 03:59)</a>:</h4>
<p>Awesome thing about the llvm 18 upgrade. Nice perf gain:</p>
<div class="codehilite"><pre><span></span><code>Summary
  ./cc-fluxsort ran
    1.20 Â± 0.02 times faster than ./roc-builtinsort-new
    1.36 Â± 0.02 times faster than ./cc-quadsort
    1.64 Â± 0.02 times faster than ./roc-builtinsort-old
</code></pre></div>
<p>Not quite up to speed with raw c++ on m1 mac, but now in the same ballpark.</p>



<a name="455576376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/455576376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#455576376">(Aug 01 2024 at 07:38)</a>:</h4>
<p>I think we also just run more passes now maybe? anyway that is really nice</p>



<a name="456244994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/456244994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#456244994">(Aug 04 2024 at 00:31)</a>:</h4>
<p>(deleted)</p>



<a name="456262994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/456262994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#456262994">(Aug 04 2024 at 03:36)</a>:</h4>
<p>Update with this PR. </p>
<p>It's passing all tests on macos in the nix shell for me locally. I've kicked off CI to see if it passes there too. </p>
<p>Our CI machines don't have ZIG 13 and LLVM 18 installed, so I expect the non-nix machines to fail.</p>
<p>I've cleaned up all of the LLVM issues, and updated the stray references to LLVM 16 -- there's some work here to upgrade the CI machines and build scripts. I don't think I can make progress this part without Anton.</p>
<p>There is one blocking issue on linux that needs further investigation. Unfortunately, I don't think I can make much progress to investigate this. It looks to be related to absolute relocations in the surgical linker. <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> and I thought we fixed it by adding an llvm <code>globaldce</code> pass, but it's still an issue.</p>
<div class="codehilite"><pre><span></span><code>___________
The roc command:

  &quot;/home/lb-dev/Documents/Github/roc/target/release/roc --max-threads=1 /home/lb-dev/Documents/Github/roc/examples/helloWorld.roc --&quot;

had unexpected stderr:

  The surgical linker currently has issue #3609 and would fail linking your app.
Please use `--linker=legacy` to avoid the issue for now.

___________
</code></pre></div>
<p><strong>TLDR</strong> - we're really close, one linux surgical linker issue and then just CI admin to go. <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="456299376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/456299376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#456299376">(Aug 04 2024 at 10:20)</a>:</h4>
<p>New linux specific issue</p>
<div class="codehilite"><pre><span></span><code>thread &#39;cli_run::expects_dev_and_test&#39; panicked at crates/cli/tests/cli_run.rs:153:13:

___________
The roc command:

  &quot;/home/lb-dev/Documents/Github/roc/target/debug/roc dev --max-threads=1 /home/lb-dev/Documents/Github/roc/crates/cli/tests/expects/expects.roc --&quot;

had unexpected stderr:

  ðŸ”¨ Rebuilding platform...
thread 220007 panic: cast causes pointer to be null
/nix/store/5yk32f31879lfsnyv0yhl0af0v2dz9dz-zig-0.13.0/lib/zig/std/start.zig:497:40: 0x55555560ee46 in main (host)
    return callMainWithArgs(@as(usize, @intCast(c_argc)), @as([*][*:0]u8, @ptrCast(c_argv)), envp);
                                       ^
???:?:?: 0x7ffff7df214d in ??? (libc.so.6)
Unwind information for `libc.so.6:0x7ffff7df214d` was not available, trace may be incomplete


___________
</code></pre></div>



<a name="456305286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/456305286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#456305286">(Aug 04 2024 at 10:58)</a>:</h4>
<p>I think I found the issue -- hard to know until I get the changes across to my linux machine and run a full test suite. But basically zig is stricter now with exporting symbols I think -- and the ABI of those symbols. So you can't have a host with signature <code>pub fn main() !void {</code> any longer, it needs to be <code>pub export fn main() u8</code> to link correctly with the roc side.</p>



<a name="456434626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/456434626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#456434626">(Aug 05 2024 at 04:18)</a>:</h4>
<p>I've got most of the CI tests passing on macos/linux now. </p>
<p>I'm down to the wasm repl tests and we've got a bunch of errors like</p>
<div class="codehilite"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at crates/repl_wasm/src/repl.rs:265:86:
called `Result::unwrap()` on an `Err` value: ParseError { offset: 469912, message: &quot;Unknown relocation type 0x b&quot; }
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</code></pre></div>
<p>I haven't figured out where this is coming from.</p>
<p>My best guess is that zig 13 behaves differently -- and the way are using zig to build the test platform, get wasi-libc, and linking things together needs to be investigated. </p>
<p>I've tested the cli repl manually and it looks like there is no issue. I haven't figured out how to spool up a wasm repl to test that manually. </p>
<p>I can repro the test failures locally in nix using <code>bash crates/repl_test/test_wasm.sh</code>.</p>



<a name="456478339"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/456478339" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#456478339">(Aug 05 2024 at 08:31)</a>:</h4>
<p>Lots of progress <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> I'll try to install the CI dependencies today</p>



<a name="456656570"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/456656570" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#456656570">(Aug 05 2024 at 17:11)</a>:</h4>
<p>zig 13 and llvm 18 have been installed on all machines</p>



<a name="467702525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/467702525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#467702525">(Sep 05 2024 at 02:34)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Run curl.exe -f -L -O -H &quot;Authorization: token ***&quot; https://github.com/roc-lang/llvm-package-windows/releases/download/v18.1.8/LLVM-18.1.8-win64.7z
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (22) The requested URL returned error: 404
</code></pre></div>
<p><span class="user-mention" data-user-id="361169">@Anton</span> -- when you get some time, can you please load LLVM 18 for windows onto <code>roc-lang/llvm-package-windows</code>.</p>



<a name="467705877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/467705877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#467705877">(Sep 05 2024 at 03:01)</a>:</h4>
<p>I commented all the jobs out in CI manager (GH workflows) except the nix-linux-x64 and nix-macos-apple-silicon jobs. I just want to see if we can get this PR to pass all the tests on those first and add the others back once we know it's working correctly.</p>



<a name="467706937"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/467706937" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#467706937">(Sep 05 2024 at 03:10)</a>:</h4>
<p>I've spent some time looking at this PR today. I merged main, and ran through the tests and pushed to see how it runs against CI.</p>
<p>My conclusion is that we should wait until after the build-host PR lands before trying to land this. There are issues that affect both, and fixing them over there first, and then merging will be much simpler.</p>



<a name="468133351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/468133351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#468133351">(Sep 06 2024 at 09:32)</a>:</h4>
<blockquote>
<p>can you please load LLVM 18 for windows onto <code>roc-lang/llvm-package-windows</code></p>
</blockquote>
<p><a href="https://github.com/roc-lang/llvm-package-windows/releases/tag/v18.1.8">Done</a></p>



<a name="475504155"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/475504155" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#475504155">(Oct 08 2024 at 08:09)</a>:</h4>
<p>Just merged main, and ran a full test using nix on macos and linux with both passing.</p>
<div class="codehilite"><pre><span></span><code>$ nix develop
$ cargo test --release
</code></pre></div>



<a name="482048153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/482048153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#482048153">(Nov 12 2024 at 22:08)</a>:</h4>
<p>Ok, merged main in... let's see how CI fairs. It's looking pretty good <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="482048676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/482048676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#482048676">(Nov 12 2024 at 22:12)</a>:</h4>
<p>We talked about making a zig package in <a href="#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/481816535">https://roc.zulipchat.com/#narrow/channel/304902-show-and-tell/topic/Advent.20of.20Code.20platform/near/481816535</a> <span class="user-mention" data-user-id="477725">@Jasper Woudenberg</span> </p>
<p>I think this is a great idea, though we can probably live with my workaround for the purpose of landing this change. Essentially, I've made a rust crate that copies the zig glue files into each of the test platforms once per test run. It works, but it would be nice to use the zig ecosystem properly and cleanup these zig test platforms (and also improve the zig platform dev experience).</p>



<a name="482056698"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/482056698" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#482056698">(Nov 12 2024 at 23:20)</a>:</h4>
<p>Everything is <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> for me locally on my mac.</p>
<p>I think all that's left to land this is some code review, minor cleanup, and fixing the GH actions (making sure the zig 13, llvm deps are correct etc).</p>



<a name="482131030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/482131030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#482131030">(Nov 13 2024 at 09:52)</a>:</h4>
<p>I'll check it out :)</p>



<a name="485177199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/485177199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#485177199">(Nov 30 2024 at 00:39)</a>:</h4>
<p>Ok, I've got this PR <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> on both apple silicon macos, and x64 linux running in Nix. I think we are on the home stretch. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="488528628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488528628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488528628">(Dec 12 2024 at 00:26)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> we need to merge the latest changes. </p>
<p>I haven't got around to investigating why the nix CI's are failing tests now. I thought they were good. </p>
<p>I'm expecting the only failure that should remain is <code>CI manager / start-ubuntu-x86-64-tests / test zig, rust, wasm...</code> that looks to be failing with this which needs investigation.</p>
<div class="codehilite"><pre><span></span><code>+ zig test -target wasm32-wasi-musl -O ReleaseFast src/main.zig --test-cmd ../../../../target/release/roc_wasm_interp --test-cmd-bin
thread &#39;main&#39; panicked at crates/wasm_interp/src/wasi.rs:142:26:
not yet implemented: WASI fd_fdstat_get([I32(2), I32(16777168)])
</code></pre></div>



<a name="488528677"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488528677" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488528677">(Dec 12 2024 at 00:27)</a>:</h4>
<p>I'm still messing around with basic-cli and basic-webserver, just wanted to give you an update</p>



<a name="488529026"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488529026" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488529026">(Dec 12 2024 at 00:30)</a>:</h4>
<p>Did we leave in some sort of debug printing that might call <code>fd_fdstat_get</code>?</p>



<a name="488529061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488529061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488529061">(Dec 12 2024 at 00:31)</a>:</h4>
<p>Accidentally compiling it into the zig bitcode for wasm?</p>



<a name="488529247"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488529247" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488529247">(Dec 12 2024 at 00:32)</a>:</h4>
<p>Oh, also looks like we have special cased <code>stdout</code> for <code>fd_fdstat_get</code>, but don't have anything for <code>stderr</code>. So if it isn't an accidental extra debug print, looks easy to add the functionality.</p>



<a name="488529794"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488529794" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488529794">(Dec 12 2024 at 00:38)</a>:</h4>
<p>don't see any debug prints. Let me try to push a fix</p>



<a name="488535058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488535058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488535058">(Dec 12 2024 at 01:39)</a>:</h4>
<p>Ok. Pushed a handful of changes. I'm hopeful</p>



<a name="488537575"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488537575" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488537575">(Dec 12 2024 at 02:09)</a>:</h4>
<p>Benchmarks are failing in a way that doesn't make sense to me: <a href="https://github.com/roc-lang/roc/actions/runs/12288409183/job/34292167154?pr=6921">https://github.com/roc-lang/roc/actions/runs/12288409183/job/34292167154?pr=6921</a></p>



<a name="488537592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488537592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488537592">(Dec 12 2024 at 02:09)</a>:</h4>
<p>It is failing in a function that no longer exists on the branch somehow:</p>
<div class="codehilite"><pre><span></span><code>cannot find `glue.zig`. Check the source code in find_zig_glue_path() to show all the paths I tried.
Location: crates/compiler/build/src/link.rs:95:5
</code></pre></div>



<a name="488537696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488537696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488537696">(Dec 12 2024 at 02:11)</a>:</h4>
<p>oh, it's in <code>bench-folder-main</code>...that makes sense</p>



<a name="488537827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488537827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488537827">(Dec 12 2024 at 02:12)</a>:</h4>
<p>So now <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="488543152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488543152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488543152">(Dec 12 2024 at 03:16)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> any idea for <a href="https://github.com/roc-lang/roc/actions/runs/12288516921/job/34292459513?pr=6921">https://github.com/roc-lang/roc/actions/runs/12288516921/job/34292459513?pr=6921</a></p>
<div class="codehilite"><pre><span></span><code>  zig build ir -Drelease=true failed with:

    ir
  +- install generated to builtins-host.ll
     +- zig build-obj builtins-host ReleaseFast native-macos failure
  error: error: CacheUnavailable
</code></pre></div>
<p>looks to only happen for nix macos on CI. Note, zig cache dir is now <code>.zig-cache</code></p>



<a name="488545834"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488545834" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488545834">(Dec 12 2024 at 03:49)</a>:</h4>
<p>Normally I just restart the runs when this happens and it fixes itself</p>



<a name="488545873"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488545873" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488545873">(Dec 12 2024 at 03:49)</a>:</h4>
<p>I've seen it multiple times in a row now, but hopefully goes away</p>



<a name="488545922"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488545922" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488545922">(Dec 12 2024 at 03:50)</a>:</h4>
<p>Ah that's a pain</p>



<a name="488548360"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488548360" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488548360">(Dec 12 2024 at 04:17)</a>:</h4>
<p>Yeah, seems to be hit 100% of the time on the mac builder during <code>nix-build</code></p>



<a name="488549634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488549634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488549634">(Dec 12 2024 at 04:28)</a>:</h4>
<p>Also, I'm hopeful that's soon to be the last error...but hitting relocation issues in wasm and benchmarking issue due to glue.zig being removed. I think I have a fix for both, but hard to say.</p>



<a name="488559489"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488559489" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488559489">(Dec 12 2024 at 06:13)</a>:</h4>
<p>I have been poking at this for a while and am not having luck.</p>
<p><code>nix-build</code> on apple silicon is failing with: <a href="https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069385?pr=6921">https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069385?pr=6921</a></p>
<div class="codehilite"><pre><span></span><code>   zig build ir -Drelease=true failed with:

    ir
  +- install generated to builtins-host.ll
     +- zig build-obj builtins-host ReleaseFast native-macos failure
  error: error: CacheUnavailable
</code></pre></div>
<p>I can't repro locallly. Probably related to <a href="https://github.com/ziglang/zig/issues/20501">https://github.com/ziglang/zig/issues/20501</a></p>
<hr>
<p>the benchmark job is failing due to main being unable to find <code>glue.zig</code>: <a href="https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069754?pr=6921">https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298069754?pr=6921</a></p>
<p>I get that we removed the file, but there are multiple search paths in find glue and I'm pretty sure it should be finding the file.</p>
<hr>
<p>Lastly, <code>wasm_test_platform.wasm</code> is broken with the new version of zig building it. I have no idea why, but it is now emitting new types of relocations we don't support. I tried toggling PIC related flags and thought I had figured it out, but it is still broken. I can repro this one locally, but have not found a fix.</p>
<p><a href="https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298070201?pr=6921">https://github.com/roc-lang/roc/actions/runs/12290625251/job/34298070201?pr=6921</a></p>
<hr>
<p>Overall, feels close, but it is hard to tell if these issues will be minor flag changes or major drags to figure out.</p>



<a name="488563777"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488563777" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488563777">(Dec 12 2024 at 06:56)</a>:</h4>
<p>I think this will fix the benchmarking issue. It needs to land in main such that the main reference loaded for benchmarking is correct:<br>
<a href="https://github.com/roc-lang/roc/pull/7349">https://github.com/roc-lang/roc/pull/7349</a></p>



<a name="488744798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488744798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488744798">(Dec 13 2024 at 00:52)</a>:</h4>
<p>So ended up not fully fixing the benchmarking issue. Realized that the current failure is due to all benchmarks running in the context of the new nix flake. This means that all benchmarks are trying to run with zig 0.13.0. Given main is only at zig 0.11.0 this breaks. I don't think this is worth fixing now though (just think it is too much hassle for something that only matter every zig upgrade). So I think once the other two issues are fixed, we should land this PR with the benchmark failing.</p>



<a name="488744971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488744971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488744971">(Dec 13 2024 at 00:54)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> when you get the chance can you look at the macos failure with the unavailable cache? I feel like you will be most likely to figure out how to workaround that.</p>



<a name="488746643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488746643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488746643">(Dec 13 2024 at 01:11)</a>:</h4>
<p>I'm digging into gen-wasm issue now. <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="488750149"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488750149" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488750149">(Dec 13 2024 at 01:51)</a>:</h4>
<p>I think gen wasm should be fixed now</p>



<a name="488750156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488750156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488750156">(Dec 13 2024 at 01:51)</a>:</h4>
<p>So if we can fix the mac cache issue, I think we can land</p>



<a name="488756545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488756545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488756545">(Dec 13 2024 at 03:10)</a>:</h4>
<p>Figured out the mac cache issue <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>That said, turns out that wasm isn't fully fixed. Still has 1 test failing after the previous fix.</p>



<a name="488757115"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757115" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757115">(Dec 13 2024 at 03:17)</a>:</h4>
<p>Which test?</p>



<a name="488757168"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757168" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757168">(Dec 13 2024 at 03:18)</a>:</h4>
<p>linking_with_dce</p>



<a name="488757409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757409">(Dec 13 2024 at 03:21)</a>:</h4>
<p>reverting the platform change fixes it</p>



<a name="488757516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757516">(Dec 13 2024 at 03:22)</a>:</h4>
<p>So <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span> that this next ci run passes everything but benchmarking</p>



<a name="488757523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757523">(Dec 13 2024 at 03:23)</a>:</h4>
<p>I thought I had to change that for zig 13, maybe that was only required in another platform -- or a specific OS/Arch</p>



<a name="488757554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757554">(Dec 13 2024 at 03:23)</a>:</h4>
<p>I mean... I think it should be required</p>



<a name="488757583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757583">(Dec 13 2024 at 03:24)</a>:</h4>
<p>Actually, I guess not. Cause zig is controlling the main. There is no c main needed, right?</p>



<a name="488757644"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757644" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757644">(Dec 13 2024 at 03:24)</a>:</h4>
<p>So I think for anything wasi, this should be fine</p>



<a name="488757654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757654">(Dec 13 2024 at 03:24)</a>:</h4>
<p>I guess for anything called into by js, it is probably required to do things differently</p>



<a name="488757851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757851">(Dec 13 2024 at 03:27)</a>:</h4>
<p>I suspect it may be something like we build <code>wasm_linking_test_host.zig</code> using zig cli into an object and not a static library.</p>



<a name="488757975"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757975" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757975">(Dec 13 2024 at 03:28)</a>:</h4>
<p>in this case, we build it into an exe</p>



<a name="488757987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488757987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488757987">(Dec 13 2024 at 03:28)</a>:</h4>
<p>so that is probably why <code>main() !void</code> is allowed</p>



<a name="488758106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488758106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488758106">(Dec 13 2024 at 03:30)</a>:</h4>
<p>Yeah, something like that. It's building into an object file <code>build-obj</code>, and then into an exe using <code>build-exe</code> in two steps. I suspect where we build a static library zig doesn't like the <code>!void</code></p>



<a name="488758190"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488758190" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488758190">(Dec 13 2024 at 03:31)</a>:</h4>
<p>Digging into that stuff was hella confusing, the combination of different options, exporting vs not exporting, static library vs exectuable, zig 0.11 vs zig .13.</p>



<a name="488758192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488758192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488758192">(Dec 13 2024 at 03:31)</a>:</h4>
<p>makes sense. Expects to follow c-abi cause static lib is not expected to have a main</p>



<a name="488758365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488758365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488758365">(Dec 13 2024 at 03:33)</a>:</h4>
<p>All the wasm tests pass for me locally.</p>



<a name="488758484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488758484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488758484">(Dec 13 2024 at 03:35)</a>:</h4>
<p>I'm going to read through all the changes and see if we've missed anything obvious</p>



<a name="488759830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488759830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488759830">(Dec 13 2024 at 03:53)</a>:</h4>
<p>I haven't found anything blocking... </p>
<p>there was one TODO left where we verify the LLVM IR, should we measure the impact on performance?  </p>
<p>we need to verify/test some of the building from source README changes, like is the llvm-18 package available on fedora etc</p>
<p>The <code>sort</code> -&gt; <code>instertion</code> change in <code>crates/compiler/builtins/benchmark-dec.zig</code> may have broken things, but I guess we can fix this in a follow up and also resolve the issue preventing the benchmark CI runner from completing.</p>



<a name="488759962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488759962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488759962">(Dec 13 2024 at 03:54)</a>:</h4>
<p>Also, just making notes here to summarise as that PR is so massive my browser struggles to find things</p>



<a name="488761300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488761300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488761300">(Dec 13 2024 at 04:10)</a>:</h4>
<p>We did it <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> </p>
<p><a href="/user_uploads/22008/SkBTLYv50IalttO6aYLqGCk3/Screenshot-2024-12-13-at-15.09.49.png">Screenshot 2024-12-13 at 15.09.49.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/SkBTLYv50IalttO6aYLqGCk3/Screenshot-2024-12-13-at-15.09.49.png" title="Screenshot 2024-12-13 at 15.09.49.png"><img data-original-dimensions="1936x950" src="/user_uploads/thumbnail/22008/SkBTLYv50IalttO6aYLqGCk3/Screenshot-2024-12-13-at-15.09.49.png/840x560.webp"></a></div>



<a name="488761321"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488761321" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488761321">(Dec 13 2024 at 04:10)</a>:</h4>
<blockquote>
<p>there was one TODO left where we verify the LLVM IR, should we measure the impact on performance?</p>
</blockquote>
<p>I think it is fine to leave in the todo for now. I added more color in the PR.</p>



<a name="488761347"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488761347" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488761347">(Dec 13 2024 at 04:10)</a>:</h4>
<p>let's merge this!</p>



<a name="488761393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488761393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488761393">(Dec 13 2024 at 04:11)</a>:</h4>
<p><a href="/user_uploads/22008/bRXsPV8uOQ73f028sAjp8Ve5/Screenshot-2024-12-13-at-15.11.18.png">Screenshot 2024-12-13 at 15.11.18.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/bRXsPV8uOQ73f028sAjp8Ve5/Screenshot-2024-12-13-at-15.11.18.png" title="Screenshot 2024-12-13 at 15.11.18.png"><img data-original-dimensions="1490x218" src="/user_uploads/thumbnail/22008/bRXsPV8uOQ73f028sAjp8Ve5/Screenshot-2024-12-13-at-15.11.18.png/840x560.webp"></a></div>



<a name="488761471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488761471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488761471">(Dec 13 2024 at 04:12)</a>:</h4>
<p><span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="488761523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488761523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488761523">(Dec 13 2024 at 04:13)</a>:</h4>
<p>Looks like it is time to brush off my static Roc branch</p>



<a name="488761614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488761614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488761614">(Dec 13 2024 at 04:14)</a>:</h4>
<p>Don't need to ask me twice <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> </p>
<p>Thank you <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> <span class="user-mention" data-user-id="361169">@Anton</span> <span class="user-mention" data-user-id="461444">@Sam Mohr</span> <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> for all the work to land this. </p>
<p>For anyone interested, this change ;</p>
<ul>
<li>unlocks some performance gains for roc</li>
<li>enables fully statically linked roc cli binaries </li>
<li>enables roc to produce statically linked binaries</li>
<li>enables us to build a roc_std zig package for all the platforms</li>
</ul>



<a name="488762673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488762673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488762673">(Dec 13 2024 at 04:26)</a>:</h4>
<p>We also may have broken some things or made a typo in the building from source documentation, so if you are able to do that (especially any non-nix users on different os/arch's) and can report any success/failures, that would be really helpful. </p>
<p>Also apologies in advance <span class="user-mention" data-user-id="361169">@Anton</span> if our scripts for making a release are broken at all, I'm pretty sure they're all good, but I couldn't fully check them. I figure we can give it a test run with the prerelease for the new PI basic-cli</p>



<a name="488765938"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488765938" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488765938">(Dec 13 2024 at 05:01)</a>:</h4>
<p>That static linking could be really nice for weird deployments!</p>



<a name="488766363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488766363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488766363">(Dec 13 2024 at 05:04)</a>:</h4>
<p>I'm thankful to the people that did real work on this and made me look like I did something <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="488766382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488766382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488766382">(Dec 13 2024 at 05:05)</a>:</h4>
<p>Moral support counts <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="488779100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488779100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488779100">(Dec 13 2024 at 07:15)</a>:</h4>
<p>Was the inline expect change part of this PR? Or how is it possible to static link a roc binaries with an inline expect?</p>



<a name="488779494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488779494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488779494">(Dec 13 2024 at 07:18)</a>:</h4>
<p>inline expects are not emitted in output object files or libaries</p>



<a name="488779523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488779523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488779523">(Dec 13 2024 at 07:18)</a>:</h4>
<p>They are only emitted when running with <code>roc main.roc</code> or <code>roc dev main.roc</code></p>



<a name="488783821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/upgrade-llvm-zig/near/488783821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/upgrade-llvm-zig.html#488783821">(Dec 13 2024 at 07:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/upgrade-llvm-zig/near/488762673">said</a>:</p>
<blockquote>
<p>We also may have broken some things or made a typo in the building from source documentation, so if you are able to do that (especially any non-nix users on different os/arch's) and can report any success/failures, that would be really helpful.</p>
</blockquote>
<p>Linux x86_64 checking in (Arch BTW). Successfully compiled roc with llvm 18.1.8 and zig 0.13.0 <span aria-label="sign of the horns" class="emoji emoji-1f918" role="img" title="sign of the horns">:sign_of_the_horns:</span> . Got a mostly passing test suite. It hung with</p>
<div class="codehilite"><pre><span></span><code>test cli_tests::test_platform_simple_zig::module_params_multiline_pattern has been running for over 60 seconds
</code></pre></div>
<p>I also had a few</p>
<div class="codehilite"><pre><span></span><code>test cli_tests::test_platform_basic_cli::combine_tasks_with_record_builder ... ignored, broken when running in nix CI, TODO replace with a zig test platform
</code></pre></div>
<p>despite not using nix.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
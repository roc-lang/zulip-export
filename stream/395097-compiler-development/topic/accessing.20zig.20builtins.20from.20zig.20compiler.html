<html>
<head><meta charset="utf-8"><title>accessing zig builtins from zig compiler · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html">accessing zig builtins from zig compiler</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="519271689"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519271689" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519271689">(May 20 2025 at 02:20)</a>:</h4>
<p>right now all the zig builtins live in <code>crates/</code> which makes them inaccessible to the zig compiler...should we to move them to <code>src/builtins</code> or something?</p>



<a name="519271740"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519271740" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519271740">(May 20 2025 at 02:20)</a>:</h4>
<p>I would just fork and split</p>



<a name="519271786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519271786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519271786">(May 20 2025 at 02:21)</a>:</h4>
<p>They have to change anyway due to zig version and new API with explicit function pointers passed in</p>



<a name="519271967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519271967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519271967">(May 20 2025 at 02:22)</a>:</h4>
<p>And yeah, sec/builtins sounds like a good dir for it</p>



<a name="519272882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519272882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519272882">(May 20 2025 at 02:28)</a>:</h4>
<p>cool, sounds good! <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="519275135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519275135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519275135">(May 20 2025 at 02:44)</a>:</h4>
<p>it'll also need quite a rewrite with all of the new syntax</p>



<a name="519276181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519276181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519276181">(May 20 2025 at 02:51)</a>:</h4>
<p>Is this something I can help with? Do we have something minimal like Bool or maybe Str we need?</p>



<a name="519276701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519276701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519276701">(May 20 2025 at 02:55)</a>:</h4>
<p>sure! Here's a WIP PR with just that change: <a href="https://github.com/roc-lang/roc/pull/7802">https://github.com/roc-lang/roc/pull/7802</a></p>



<a name="519276720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519276720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519276720">(May 20 2025 at 02:55)</a>:</h4>
<p>if you want to try to get it updated and tests passing, that would be awesome! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="519277787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519277787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519277787">(May 20 2025 at 03:02)</a>:</h4>
<p><code>Str</code> would be enough for hello world, but probably at that point you've gotten all the hard parts anyway <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="519279285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519279285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519279285">(May 20 2025 at 03:13)</a>:</h4>
<p>We're not doing the shared memory buffer thing anymore with <code>expect</code> right?</p>



<a name="519279324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519279324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519279324">(May 20 2025 at 03:14)</a>:</h4>
<p>You've copied the the builtins verbatim and we can cut out things we don't need right?</p>



<a name="519279688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519279688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519279688">(May 20 2025 at 03:16)</a>:</h4>
<p>yes and yes!</p>



<a name="519279756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519279756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519279756">(May 20 2025 at 03:17)</a>:</h4>
<p><code>expect</code> will just work the same way <code>dbg</code> does, where the host exposes a function for "this gets called whenever an inline <code>expect</code> fails, and it's up to the host to decide what to do with that"</p>



<a name="519303659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519303659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519303659">(May 20 2025 at 06:46)</a>:</h4>
<p>I've got the tests passing now... but it's not really being used anywhere yet so it's hard to know if it's all ok. </p>
<p>Are we still planning on compiling the builtins to bitcode and then linking with our code gen somehow? I'm interested to know whats next from here... would this PR be good to merge like this and we'll start using it sometime, somehow.</p>



<a name="519361528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519361528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519361528">(May 20 2025 at 11:35)</a>:</h4>
<p>yeah we'll still need to compile them to bitcode so LLVM can import them</p>



<a name="519361569"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519361569" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519361569">(May 20 2025 at 11:35)</a>:</h4>
<p>but for now, the interpreter needs them in a general "just import them and start using them directly" sense</p>



<a name="519381843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519381843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519381843">(May 20 2025 at 13:14)</a>:</h4>
<p>very cool! <span class="user-mention" data-user-id="515757">@Luke Boswell</span> looks like CI is still failing on a bunch of missing doc comments <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="519484194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519484194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519484194">(May 20 2025 at 22:27)</a>:</h4>
<p>I think this <code>typos</code> check is getting a bit carried away... </p>
<div class="codehilite"><pre><span></span><code>error: `numer` should be `number`
  --&gt; ./src/builtins/dec.zig:797:56
    |
797 |         sr = 1 + N_UDWORD_BITS + denom_leading_zeros - numer_hi_leading_zeros;
    |                                                        ^^^^^
    |
</code></pre></div>



<a name="519484568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519484568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519484568">(May 20 2025 at 22:30)</a>:</h4>
<p>Or another example from CI failure</p>
<div class="codehilite"><pre><span></span><code>error: `fo` should be `of`, `for`, `do`, `go`, `to`
  --&gt; ./src/builtins/str.zig:1198:34
     |
1198 |     const fo = RocStr.fromSlice(&quot;fo&quot;);
     |                                  ^^
     |
</code></pre></div>



<a name="519484594"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519484594" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519484594">(May 20 2025 at 22:30)</a>:</h4>
<p>There must be a config we're missing somewhere</p>



<a name="519494813"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519494813" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519494813">(May 21 2025 at 00:19)</a>:</h4>
<p>What is unfortunate about this PR, is that they are all new files... so it's hard to see the individual changes from the originals.</p>



<a name="519496227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519496227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519496227">(May 21 2025 at 00:35)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> I have found an issue I think with our builtins. We're now running the zig tests on Windows ARM.</p>
<blockquote>
<p>The test is being run on Windows with ARM64 architecture, but the inline assembly code in <code>main.zig</code> is written for x86_64 architecture (using registers like <code>%rcx</code>, <code>%rdx</code>, etc. which are specific to x86_64).</p>
</blockquote>
<p>I'm thinking of asking Claude for help making an implementation, or maybe stubbing it out for ARM. I'm not really sure here. Another option is to ignore the tests on Windows ARM... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="519496341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519496341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519496341">(May 21 2025 at 00:36)</a>:</h4>
<p>what are we using that for again? setjmp/longjmp?</p>



<a name="519496407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519496407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519496407">(May 21 2025 at 00:37)</a>:</h4>
<p>and yeah I think Claude 3.7 Sonnet has a reasonable chance of translating it if it's pretty small, although at that point we do need to be pretty confident that our tests are exercising it sufficiently <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="519496485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519496485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519496485">(May 21 2025 at 00:38)</a>:</h4>
<p>Yes, and yeah it's tiny</p>



<a name="519496496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519496496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519496496">(May 21 2025 at 00:38)</a>:</h4>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">comptime</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">builtin</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">tag</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="n">windows</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">builtin</span><span class="p">.</span><span class="n">target</span><span class="p">.</span><span class="n">cpu</span><span class="p">.</span><span class="n">arch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">.</span><span class="n">x86_64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">asm</span><span class="w"> </span><span class="p">(</span>
<span class="w">            </span><span class="sh">\\.global windows_longjmp;</span>
<span class="w">            </span><span class="sh">\\windows_longjmp:</span>
<span class="w">            </span><span class="sh">\\  movq 0x00(%rcx), %rdx</span>
<span class="w">            </span><span class="sh">\\  movq 0x08(%rcx), %rbx</span>
<span class="w">            </span><span class="sh">\\  # note 0x10 is not used yet!</span>
<span class="w">            </span><span class="sh">\\  movq 0x18(%rcx), %rbp</span>
<span class="w">            </span><span class="sh">\\  movq 0x20(%rcx), %rsi</span>
<span class="w">            </span><span class="sh">\\  movq 0x28(%rcx), %rdi</span>
<span class="w">            </span><span class="sh">\\  movq 0x30(%rcx), %r12</span>
<span class="w">            </span><span class="sh">\\  movq 0x38(%rcx), %r13</span>
<span class="w">            </span><span class="sh">\\  movq 0x40(%rcx), %r14</span>
<span class="w">            </span><span class="sh">\\  movq 0x48(%rcx), %r15</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  # restore stack pointer</span>
<span class="w">            </span><span class="sh">\\  movq 0x10(%rcx), %rsp</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  # load jmp address</span>
<span class="w">            </span><span class="sh">\\  movq 0x50(%rcx), %r8</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  # set up return value</span>
<span class="w">            </span><span class="sh">\\  movq %rbx, %rax</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  movdqu 0x60(%rcx), %xmm6</span>
<span class="w">            </span><span class="sh">\\  movdqu 0x70(%rcx), %xmm7</span>
<span class="w">            </span><span class="sh">\\  movdqu 0x80(%rcx), %xmm8</span>
<span class="w">            </span><span class="sh">\\  movdqu 0x90(%rcx), %xmm9</span>
<span class="w">            </span><span class="sh">\\  movdqu 0xa0(%rcx), %xmm10</span>
<span class="w">            </span><span class="sh">\\  movdqu 0xb0(%rcx), %xmm11</span>
<span class="w">            </span><span class="sh">\\  movdqu 0xc0(%rcx), %xmm12</span>
<span class="w">            </span><span class="sh">\\  movdqu 0xd0(%rcx), %xmm13</span>
<span class="w">            </span><span class="sh">\\  movdqu 0xe0(%rcx), %xmm14</span>
<span class="w">            </span><span class="sh">\\  movdqu 0xf0(%rcx), %xmm15</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  jmp *%r8</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\.global windows_setjmp;</span>
<span class="w">            </span><span class="sh">\\windows_setjmp:</span>
<span class="w">            </span><span class="sh">\\  movq %rdx, 0x00(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movq %rbx, 0x08(%rcx)</span>
<span class="w">            </span><span class="sh">\\  # note 0x10 is not used yet!</span>
<span class="w">            </span><span class="sh">\\  movq %rbp, 0x18(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movq %rsi, 0x20(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movq %rdi, 0x28(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movq %r12, 0x30(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movq %r13, 0x38(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movq %r14, 0x40(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movq %r15, 0x48(%rcx)</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  # the stack location right after the windows_setjmp call</span>
<span class="w">            </span><span class="sh">\\  leaq 0x08(%rsp), %r8</span>
<span class="w">            </span><span class="sh">\\  movq %r8, 0x10(%rcx)</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  movq (%rsp), %r8</span>
<span class="w">            </span><span class="sh">\\  movq %r8, 0x50(%rcx)</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm6,  0x60(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm7,  0x70(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm8,  0x80(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm9,  0x90(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm10, 0xa0(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm11, 0xb0(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm12, 0xc0(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm13, 0xd0(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm14, 0xe0(%rcx)</span>
<span class="w">            </span><span class="sh">\\  movdqu %xmm15, 0xf0(%rcx)</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">            </span><span class="sh">\\  xorl %eax, %eax</span>
<span class="w">            </span><span class="sh">\\  ret</span>
<span class="w">            </span><span class="sh">\\</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="519497089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519497089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519497089">(May 21 2025 at 00:46)</a>:</h4>
<p>worth a try I guess!</p>



<a name="519497120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519497120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519497120">(May 21 2025 at 00:46)</a>:</h4>
<p>could also ask a new Claude chat afterwards to review the generated code, look for problems etc</p>



<a name="519502041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519502041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519502041">(May 21 2025 at 01:36)</a>:</h4>
<p>No real luck unfortunately... I've got an ARM and x86 Windows machines, I might compile something and objdump that to see what zig does for setjmp and longjmp and use that asm as inspiration for our implementation. </p>
<p>I've added a test for setjmp and longjmp that seems to be working well on all the non-Windows machines, but fails on Windows... so I'm also guessing our existing Windows impl may not be right either.</p>
<p>Should be able to look at this sometime later in the week.</p>



<a name="519504094"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519504094" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519504094">(May 21 2025 at 01:58)</a>:</h4>
<p>I feel like we shouldn't need those anymore</p>



<a name="519504721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519504721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519504721">(May 21 2025 at 02:03)</a>:</h4>
<p>That sounds much easier... I'm not sure where we used it tbh</p>



<a name="519508630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519508630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519508630">(May 21 2025 at 02:42)</a>:</h4>
<p>if I remember right, we needed them so that if a <code>crash</code> happens in a <code>roc test</code> test, we can turn that into a failed test rather than taking out the entire <code>roc test</code> run</p>



<a name="519508670"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519508670" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519508670">(May 21 2025 at 02:43)</a>:</h4>
<p>not sure how else we'd handle that scenario other than something really heavyweight liek spawning separate OS threads or processes <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="519508893"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519508893" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519508893">(May 21 2025 at 02:45)</a>:</h4>
<p>Sure, but it can be in the platform instead of in the builtins</p>



<a name="519508981"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519508981" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519508981">(May 21 2025 at 02:46)</a>:</h4>
<p>Or we can do other hacks when <code>roc_crash</code> is called.</p>



<a name="519509117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509117">(May 21 2025 at 02:47)</a>:</h4>
<p>hm, does that help us? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="519509178"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509178" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509178">(May 21 2025 at 02:48)</a>:</h4>
<p>I guess the compiler itself can use libc's <code>setjmp</code> and <code>longjmp</code> maybe</p>



<a name="519509248"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509248" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509248">(May 21 2025 at 02:49)</a>:</h4>
<p>Yeah</p>



<a name="519509421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509421">(May 21 2025 at 02:50)</a>:</h4>
<p>Or if the crash is always put at the end of a test, we might be able to set a global and the just return from the crash....but that depends on a lot of things.</p>



<a name="519509439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509439">(May 21 2025 at 02:50)</a>:</h4>
<p>And maybe would break things</p>



<a name="519509479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509479">(May 21 2025 at 02:51)</a>:</h4>
<p>Oh wait, we'll be running the the interpreter for most tests, right? So like probably can just have it set state and then return.</p>



<a name="519509493"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509493" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509493">(May 21 2025 at 02:51)</a>:</h4>
<p>Idk...just ideas</p>



<a name="519509508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519509508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519509508">(May 21 2025 at 02:51)</a>:</h4>
<p>I'm just not a fan of having that code in the bultins</p>



<a name="519511177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519511177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519511177">(May 21 2025 at 03:09)</a>:</h4>
<p>The <code>roc test</code> use case is really fuzzy for me. Would it be possible to step through it in a few dot points? </p>
<ul>
<li><code>roc test</code> from the cli</li>
<li>compile app.roc into machine code test exectuable, linking with builtins (bitcode) </li>
<li>run each test in sequence (or a single test with an argument) by calling the test executable in a child process</li>
<li>it the test crashes record it as a failure</li>
</ul>
<p>^^ is this even remotely close?</p>



<a name="519511495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519511495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519511495">(May 21 2025 at 03:13)</a>:</h4>
<p>Oh wait, I was thinking of our internal unit tests, not <code>roc test</code></p>



<a name="519511523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519511523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519511523">(May 21 2025 at 03:13)</a>:</h4>
<p>In my imagining here.. the <code>roc_crashed</code> implementation just returns from the process with a non-zero exit code</p>



<a name="519511550"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519511550" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519511550">(May 21 2025 at 03:13)</a>:</h4>
<p>For <code>roc test</code>, I 100% think we should use subprocesses</p>



<a name="519511903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519511903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519511903">(May 21 2025 at 03:17)</a>:</h4>
<p>2 main reasons:</p>
<ol>
<li>It allows us to have parallelism configs</li>
<li>It means we can clean up memory leaks from crashes and not have cascading memory failures.</li>
</ol>



<a name="519512089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512089">(May 21 2025 at 03:19)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> your not worried about spawning processes being heavyweight which I think Richard was referring to?</p>



<a name="519512236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512236">(May 21 2025 at 03:20)</a>:</h4>
<p>For tests, not really. Tests run on the human scale. Humans are slow.</p>



<a name="519512299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512299">(May 21 2025 at 03:21)</a>:</h4>
<p>And you don't need a process per test, you can group things.</p>



<a name="519512305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512305">(May 21 2025 at 03:21)</a>:</h4>
<p>So it will be amortized</p>



<a name="519512518"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512518" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512518">(May 21 2025 at 03:24)</a>:</h4>
<p>Also... the primary dev loop can probably use the interpreter for running tests. So I can imagine <code>roc test</code>  uses that, and <code>roc test --opt full</code> compiles a test exectuable using llvm and then runs the tests.</p>



<a name="519512571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512571">(May 21 2025 at 03:25)</a>:</h4>
<p>Probably compiles a shared library for the llvm case, but yeah</p>



<a name="519512644"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512644" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512644">(May 21 2025 at 03:26)</a>:</h4>
<p>Oh, actually, for roc, we probably don't even need full process, I think we can just use threads. They just need separate memory allocators. A gpa per thread.</p>



<a name="519512682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512682">(May 21 2025 at 03:26)</a>:</h4>
<p>Cause roc can't segfaults or crash except via <code>roc_crash</code> and <code>roc_expect_failed</code> and we can handle those cleanly.</p>



<a name="519512743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512743">(May 21 2025 at 03:27)</a>:</h4>
<p>Only need a process if you are afraid of real segfaults and crashes (which correct roc code should never do and in tests, we can make memory allocation failures be treated like crashes)</p>



<a name="519512807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512807">(May 21 2025 at 03:28)</a>:</h4>
<p>It's beautiful...</p>



<a name="519512811"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512811" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512811">(May 21 2025 at 03:28)</a>:</h4>
<p>Only exception is stack overflows.....oh....I guess we need procresses to handle stack overflows</p>



<a name="519512821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512821">(May 21 2025 at 03:28)</a>:</h4>
<p>Cause those will kill a full procress</p>



<a name="519512830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512830">(May 21 2025 at 03:28)</a>:</h4>
<p>And can still exist in valid roc code</p>



<a name="519512866"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512866" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512866">(May 21 2025 at 03:29)</a>:</h4>
<p>Didn't we plan to leave those... and just have a timer or interrupt to check if it's still going</p>



<a name="519512899"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519512899" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519512899">(May 21 2025 at 03:29)</a>:</h4>
<p>Not infinite loops, but stack overflows which I think kill the full process....though maybe they just kill a single thread....need to test</p>



<a name="519513032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513032">(May 21 2025 at 03:31)</a>:</h4>
<p>So you fork one child process, which then runs everything in threads. If any of them stack overflow you can recover and report it.</p>



<a name="519513066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513066">(May 21 2025 at 03:31)</a>:</h4>
<p>Yeah, stack overflow kills full processes, so we need process isolation to catch them</p>



<a name="519513147"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513147" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513147">(May 21 2025 at 03:32)</a>:</h4>
<p>And yeah we could do that, but then you don't know which test led to the overflow (also, I guess the interpreter can catch what would ne stack overflows and report them directly)</p>



<a name="519513202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513202">(May 21 2025 at 03:33)</a>:</h4>
<p>If you had a write only log each time you started/completed a test or ran the tests one at a time or something you could maybe report which one is the issue (or narrow it down)</p>



<a name="519513283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513283">(May 21 2025 at 03:34)</a>:</h4>
<p><img alt=":nod-yes:" class="emoji" src="https://avatars.zulip.com/22008/emoji/images/a8fe64af.gif" title="nod-yes"></p>



<a name="519513312"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513312" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513312">(May 21 2025 at 03:34)</a>:</h4>
<p>Frankly, I'm really not to worried about the cost of processes. So I would vote for starting simple first.</p>



<a name="519513348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513348">(May 21 2025 at 03:35)</a>:</h4>
<p>Just use process isolation for catching issues and improve with thread strategies later if it actually has issues.</p>



<a name="519513496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513496">(May 21 2025 at 03:36)</a>:</h4>
<p>Spawning a process takes a few millisecond generally. And the single process can then run many tests only needing to relaunch on a stack overflow.</p>



<a name="519513553"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513553" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513553">(May 21 2025 at 03:37)</a>:</h4>
<p>Well we've come a long way around... but I'm reasonably convinced we don't need setjmp and longjmp in the builtins anymore. We can add it back easily enough if that changes. Simplest way forward to land this PR and the builtins is just to remove it.</p>



<a name="519513629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519513629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519513629">(May 21 2025 at 03:38)</a>:</h4>
<p>I like the idea of the platform (or test implementation) handling everything through our nice clean host ABI interface instead</p>



<a name="519562030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519562030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519562030">(May 21 2025 at 09:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler/near/519484594">said</a>:</p>
<blockquote>
<p>There must be a config we're missing somewhere</p>
</blockquote>
<p>It's <a href="https://github.com/roc-lang/roc/blob/main/typos.toml">typos.toml</a> at the root of the repo.</p>



<a name="519573452"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519573452" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519573452">(May 21 2025 at 10:11)</a>:</h4>
<p>Yeah I played with that a bit but ended up just renaming things</p>



<a name="519592197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519592197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519592197">(May 21 2025 at 11:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler/near/519513147">said</a>:</p>
<blockquote>
<p>And yeah we could do that, but then you don't know which test led to the overflow (also, I guess the interpreter can catch what would ne stack overflows and report them directly)</p>
</blockquote>
<p>our greenthreads approach can do that!</p>



<a name="519592464"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519592464" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519592464">(May 21 2025 at 11:54)</a>:</h4>
<p>we'd have a global segfault handler, but it would be able to tell from the address of the segfault which guard page (on which greenthread) caused the fault, which in turn would tell us which test overflowed its stack</p>



<a name="519592560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519592560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519592560">(May 21 2025 at 11:54)</a>:</h4>
<p>I think it would be really great to pursue that approach, because it's something we know we want to get working anyway for Roc hosts</p>



<a name="519592592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519592592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519592592">(May 21 2025 at 11:54)</a>:</h4>
<p>and this is a way we could unblock getting it really working and robust right now</p>



<a name="519593645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519593645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519593645">(May 21 2025 at 12:00)</a>:</h4>
<p>because we could set up tests in our code base where we:</p>
<ul>
<li>build a dylib (from a separate source file) that exposes a function which follows the new <code>host_abi.zig</code> type (e.g. varargs of pointers)</li>
<li><code>dlopen</code> that dylib</li>
<li>spawn a new greenthread</li>
<li>call the function in the dylib</li>
</ul>



<a name="519594034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519594034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519594034">(May 21 2025 at 12:02)</a>:</h4>
<p>at that point, we can have different dylib source code files which simulate different conditions in a test, e.g.</p>
<ul>
<li>stack overflow</li>
<li><code>crash</code></li>
<li><code>dbg</code></li>
<li><code>expect</code> failed</li>
</ul>
<p>and then we can make tests which verify that we're doing things like capturing <code>dbg</code> and failed <code>epxect</code>s, recovering from <code>crash</code> and stack overflows, etc.</p>



<a name="519594228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519594228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519594228">(May 21 2025 at 12:02)</a>:</h4>
<p>and since they're green threads, we definitely wouldn't need setjmp/longjmp because all we'd do when one of them stack overflows or crashes is to just have them yield</p>



<a name="519594360"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519594360" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519594360">(May 21 2025 at 12:03)</a>:</h4>
<p>and then the caller can say "cool, all the memory in the arena we gave them is now garbage and we can reset the arena for another test, and all the stack memory we gave them in the greenthread is also garbage and can be reused for another greenthread too"</p>



<a name="519594390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519594390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519594390">(May 21 2025 at 12:03)</a>:</h4>
<p>in other words, the cleanup is just "those resources are available for something else now"</p>



<a name="519633133"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519633133" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519633133">(May 21 2025 at 14:50)</a>:</h4>
<p>I don't think we should use arenas for tests</p>



<a name="519633183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519633183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519633183">(May 21 2025 at 14:50)</a>:</h4>
<p>But otherwise, yeah, agree</p>



<a name="519633708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519633708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519633708">(May 21 2025 at 14:52)</a>:</h4>
<p>We should not use arenas cause we don't know what code the user is testing and if it will actually run on arenas<br>
 If the tests lead to tons of reallocations, they might oom with arenas, but work fine with a standard allocator. I think we likely want a standard allocator per thread.</p>



<a name="519635764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519635764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519635764">(May 21 2025 at 15:00)</a>:</h4>
<p>That said, I do think the test platform could be a lot simpler than a full green thread platform.. cause it only has compute heavy work and no async requests to wait on. So it really just needs a process per core and a single fake stack per process to avoid stack overflows. Then would just hot loop perform compute for tests.</p>



<a name="519635910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519635910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519635910">(May 21 2025 at 15:01)</a>:</h4>
<p>But we could still build out a full green thread base if we prefer, just to really push and build out the primitives.</p>



<a name="519637516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519637516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519637516">(May 21 2025 at 15:07)</a>:</h4>
<p>Oh, other big opportunity. Tests have no inputs, can we make the interpreter able to just run them. No dylib or linking at all, and smarter debug info around things like stack overflows and maybe eventually other things?</p>



<a name="519692749"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519692749" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519692749">(May 21 2025 at 20:05)</a>:</h4>
<p>yeah I think so!</p>



<a name="519693062"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519693062" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519693062">(May 21 2025 at 20:07)</a>:</h4>
<p>and yeah I agree about greenthreads not being strictly a requirement here, but it seems to me like:</p>
<ul>
<li>greenthreads are something we know we want</li>
<li>this is a way we can start getting them in place and tested across targets that is totally unblocked</li>
<li>they check all the boxes in terms of what we need for tests (stack overflow handling etc)</li>
</ul>



<a name="519722243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519722243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519722243">(May 22 2025 at 00:08)</a>:</h4>
<p>Yep</p>



<a name="519723069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519723069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519723069">(May 22 2025 at 00:18)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> do you have any interest in trying that out, based on the greenthread code you've already done? I think you're the foremost expert in greenthreads right now! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="519724263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519724263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519724263">(May 22 2025 at 00:31)</a>:</h4>
<p>Yes, though not sure I have the time currently</p>



<a name="519724733"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519724733" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519724733">(May 22 2025 at 00:37)</a>:</h4>
<p>cool cool!</p>



<a name="519743466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519743466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519743466">(May 22 2025 at 04:14)</a>:</h4>
<p>Do the green threads thing work for Windows?</p>



<a name="519743481"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519743481" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519743481">(May 22 2025 at 04:14)</a>:</h4>
<p>I'm just wondering if it's similar i.e. with dlopen and a dynamic library</p>



<a name="519743488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519743488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519743488">(May 22 2025 at 04:14)</a>:</h4>
<p>Maybe we need to start with a subprocess anyway</p>



<a name="519746288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519746288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519746288">(May 22 2025 at 04:49)</a>:</h4>
<p>Green threads should work on windows the same as Linux</p>



<a name="519746298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519746298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519746298">(May 22 2025 at 04:49)</a>:</h4>
<p>Only place they won't work is wasm</p>



<a name="519746326"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519746326" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519746326">(May 22 2025 at 04:49)</a>:</h4>
<p>All they are is a chunk of memory for a call stack and a tiny bit of assembly to jump into it</p>



<a name="519806778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/519806778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#519806778">(May 22 2025 at 11:07)</a>:</h4>
<p>I remember looking into wasm and concluding it was possible but required getting JS involved behind the scenes</p>



<a name="520483552"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520483552" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520483552">(May 26 2025 at 15:39)</a>:</h4>
<p>You can compile green threads into a state machine, similar to what happens with rust futures or Quasar from the Java world</p>



<a name="520484300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520484300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520484300">(May 26 2025 at 15:43)</a>:</h4>
<p>I feel like that would just be for cooperative green threads</p>



<a name="520484348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520484348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520484348">(May 26 2025 at 15:43)</a>:</h4>
<p>But don't actually know for sure</p>



<a name="520484507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520484507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520484507">(May 26 2025 at 15:44)</a>:</h4>
<p>By cooperative, do you mean non-preemptable?</p>



<a name="520484567"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520484567" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520484567">(May 26 2025 at 15:44)</a>:</h4>
<p>Yes</p>



<a name="520484617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520484617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520484617">(May 26 2025 at 15:45)</a>:</h4>
<p>The compiler can always do things like insert yields at the start of recursive functions (and loops), so if you want it to be preemptable, it can be made so.</p>



<a name="520485043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520485043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520485043">(May 26 2025 at 15:47)</a>:</h4>
<p>Yeah, but that tends not to work well in practice. I mean it isn't terrible or anything, but after years of trying to avoid it, go added preemption. Either you have too much overhead or you risk getting stuck in a single rogue thread (even if not fully stuck, you often can get locked in major latency ruining and CPU unfair splits)</p>



<a name="520485639"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520485639" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520485639">(May 26 2025 at 15:50)</a>:</h4>
<p>Yeah there's definitely a bunch of overhead in adding yields all over the place - but my point was just that it's possible to "compile-in" pre-emptability; it doesn't actually have to be a native property of the system you're running on</p>



<a name="520485979"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520485979" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520485979">(May 26 2025 at 15:53)</a>:</h4>
<p>That can be made lower overhead by not yielding if it hasn't been over some configurable amount of "time" (e.g. a count of candidate yields passed, or an approximate instruction count, etc)</p>



<a name="520491734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/accessing%20zig%20builtins%20from%20zig%20compiler/near/520491734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/accessing.20zig.20builtins.20from.20zig.20compiler.html#520491734">(May 26 2025 at 16:27)</a>:</h4>
<p>Yep</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
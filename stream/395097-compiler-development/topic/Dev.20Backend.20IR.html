<html>
<head><meta charset="utf-8"><title>Dev Backend IR · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html">Dev Backend IR</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="419345319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419345319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419345319">(Feb 01 2024 at 22:33)</a>:</h4>
<p>This is a pretty open thought, but I am questioning if we should change the Dev backend to have an ir that can be stored in a flat array (rather than a tree structure/not existing), that is essentially a portable assembly (one op per function in the <a href="https://github.com/roc-lang/roc/blob/fc6b519b5948023981ac5751d2f6ee48bcef2316/crates/compiler/gen_dev/src/generic64/mod.rs#L153-L742">current Assembler trait</a>).</p>
<p>So it would kinda be akin to llvm ir, but just what we need to support the dev backend. It would also just be for defining within a single procedure and any jmp type instructions would just use a integer as the target that is which other instruction in the array to jump to.</p>
<hr>
<p>The main gain of doing this is for future minor optimizations that we want to run on the ir. The big one being register allocation. With the current IR, register allocation, and lifetimes in general, are very much not a clean problem. Mono is a tree. It also is not nearly as fine grain as individual assembly instructions. So it is very hard to have any idea how many registers will be needed for a specific mono ir node.</p>
<p>I think that we should have a very fast pass that runs over mono and blits out a flat array of assembly like instructions. (essentially will be equivalent to the current dev backend but less complex due to having infinite registers for example).</p>
<p>Then we would run register allocation on the flat array (lots of good algorithms with linear time exist for this). Given the assembly ir won't perfectly match to assembly instructions, we will have a backend dependent function that will label exactly how many temporary registers an instruction will need. That is all the information we should need to deal with register allocations.</p>
<p>Once that works, we can consider other minor but fast optimizations:</p>
<ul>
<li>grouping instructions for final output</li>
<li>intentionally reusing source and dest reg to avoid extra data movement instructions</li>
<li>freeing up the base pointer by calculating all offsets with the stack pointer</li>
<li>storing some aggregate values in registers if available instead of on the stack</li>
<li>maybe some minor and quick rewrites.</li>
</ul>
<p>Especially given we generate at the procedure level, it should be possible to run this part of the dev backend in parallel. Only merging the final generated assembly into an output object file.</p>
<p>I think this will help clean up some of the complexities of the dev backend related to where data is stored and how it is loaded. It should help separate that  work cleanly from the rest of the ir selection at a minimum. It also gives us some opportunities for minor but important optimization passes over dev backend ir.</p>
<hr>
<p>What are people's thoughts on this? I would guess <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> and <span class="user-mention" data-user-id="281383">@Richard Feldman</span> would have the most input.</p>



<a name="419351123"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419351123" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419351123">(Feb 01 2024 at 23:19)</a>:</h4>
<p>so my default thinking on anything to do with the dev backend is "fewer passes is faster, so let's minimize passes"</p>



<a name="419351254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419351254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419351254">(Feb 01 2024 at 23:20)</a>:</h4>
<p>obviously there can possibly exist a way to take a given implementation and actually make a faster implementation which does more passes, but by default it's going to be slower</p>



<a name="419351318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419351318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419351318">(Feb 01 2024 at 23:21)</a>:</h4>
<p>so my immediate reaction is "to what extent could we achieve some of these goals without introducing any new passes or IRs?"</p>



<a name="419352159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419352159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419352159">(Feb 01 2024 at 23:27)</a>:</h4>
<p>I think it is important to start with, we definitely want ok register allocation in the long term. It will be important to get enough performance that end users actually want to use the dev backend for reasonably sized projects. On top of that, it will be useful for making the dev backend output assembly easier to read and debug.</p>



<a name="419352349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419352349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419352349">(Feb 01 2024 at 23:28)</a>:</h4>
<p>I don't think it will be feasible to generate ok register allocation while depending only on Mono IR.</p>
<p>Or more accurately, we probably could find a way to force it to happen, but it would be exceptionally messy. The current super simple register and stack allocation strategy built on mono is already messy.</p>



<a name="419352373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419352373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419352373">(Feb 01 2024 at 23:28)</a>:</h4>
<p>I'll just say that in principle I'm on board with this idea. The current register allocation is fundamentally limited, I don't think there is a (good) way to traverse the tree structure and perform the register allocation in one pass</p>



<a name="419353346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419353346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419353346">(Feb 01 2024 at 23:37)</a>:</h4>
<blockquote>
<p>so my default thinking on anything to do with the dev backend is "fewer passes is faster, so let's minimize passes"</p>
</blockquote>
<p>My general thoughts are:</p>
<ol>
<li>The dev backend is already fast. Frontend and typechecking and such is likely to be the bottleneck by a large margin currently.</li>
<li>The dev backend can easily be n times faster by running procedures in parallel.</li>
<li>This change should make the dev backend simplier and easier to maintain my avoiding intermixing the handling of multiple different concerns.</li>
<li>This is practically required to do ok register allocation</li>
<li>All "extra" optimizations can be evaluated one at a time to see if they meet our tradeoffs.</li>
</ol>



<a name="419355097"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419355097" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419355097">(Feb 01 2024 at 23:50)</a>:</h4>
<p>so could it be done in 1 extra pass?</p>



<a name="419355151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419355151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419355151">(Feb 01 2024 at 23:50)</a>:</h4>
<p>as in:</p>
<ul>
<li>today we do mono IR -&gt; bytes</li>
<li>in this world we do mono IR -&gt; new IR -&gt; bytes</li>
</ul>



<a name="419355334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419355334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419355334">(Feb 01 2024 at 23:52)</a>:</h4>
<p>Yeah. Though technically today we do one pass on mono to record lifetimes and in the new form we would do one pass on the new ir to do register allocation instead.</p>



<a name="419356935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419356935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419356935">(Feb 02 2024 at 00:04)</a>:</h4>
<p>that sounds good to me then! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="419357407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/419357407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#419357407">(Feb 02 2024 at 00:07)</a>:</h4>
<p>One extra note, if we do any of the other extra optimizations that I mentioned, they would all run on this IR (and some may actually just be extensions to the linear register allocator pass). So definitely no other IRs.</p>



<a name="485962338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485962338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485962338">(Dec 03 2024 at 22:02)</a>:</h4>
<p>What's the status of this?</p>



<a name="485963024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485963024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485963024">(Dec 03 2024 at 22:06)</a>:</h4>
<p>nobody is working on it right now, as far as I know</p>



<a name="485963054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485963054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485963054">(Dec 03 2024 at 22:06)</a>:</h4>
<p>but it would be awesome if anyone wanted to get it going! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="485964341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485964341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485964341">(Dec 03 2024 at 22:15)</a>:</h4>
<p>Yeah, totally unstarted</p>



<a name="485964357"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485964357" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485964357">(Dec 03 2024 at 22:15)</a>:</h4>
<p>Just documented</p>



<a name="485967405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485967405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485967405">(Dec 03 2024 at 22:35)</a>:</h4>
<p>also how would this pass / perserve registers when jumps happen (what's the calling convention)?</p>



<a name="485968227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485968227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485968227">(Dec 03 2024 at 22:41)</a>:</h4>
<p>Jumps or calls?</p>



<a name="485968685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485968685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485968685">(Dec 03 2024 at 22:44)</a>:</h4>
<p>Any, calls sound be c calling convention</p>



<a name="485968788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485968788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485968788">(Dec 03 2024 at 22:45)</a>:</h4>
<p>Jumps are up to us but theoretically can keep everything alive.</p>



<a name="485969000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969000">(Dec 03 2024 at 22:46)</a>:</h4>
<p>If stashing out happen inside a loop from a join point, we would just want to hoist whatever possible before the join point so it isn't stashing on repeat in the loop</p>



<a name="485969030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969030">(Dec 03 2024 at 22:47)</a>:</h4>
<p>calls</p>



<a name="485969053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969053">(Dec 03 2024 at 22:47)</a>:</h4>
<p>Of course still might have stashing in a loop due to locals for the loop</p>



<a name="485969064"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969064" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969064">(Dec 03 2024 at 22:47)</a>:</h4>
<p>Yeah, calls are just c abi.</p>



<a name="485969108"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969108" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969108">(Dec 03 2024 at 22:47)</a>:</h4>
<p>c is just preserve the arguement on a stack right?</p>



<a name="485969122"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969122" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969122">(Dec 03 2024 at 22:48)</a>:</h4>
<p>Anytime one comes up, we just ban a list of registers and have to stash what's in them</p>



<a name="485969179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969179">(Dec 03 2024 at 22:48)</a>:</h4>
<p>Yeah, we stash to the stack whenever out of register space</p>



<a name="485969199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969199">(Dec 03 2024 at 22:48)</a>:</h4>
<p>got it</p>



<a name="485969528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485969528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485969528">(Dec 03 2024 at 22:50)</a>:</h4>
<p>In the GitHub issue, I link to some good article on linear time register allocation passes</p>



<a name="485978254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485978254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485978254">(Dec 03 2024 at 23:57)</a>:</h4>
<p><span class="user-mention" data-user-id="782426">@Wizard ish</span> are you interested in diving into this? <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="485978925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485978925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485978925">(Dec 04 2024 at 00:01)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> Perhaps, although I'll have to freshen up on my assembly first</p>



<a name="485979785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485979785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485979785">(Dec 04 2024 at 00:06)</a>:</h4>
<p>that's awesome! feel free to post any questions here! <span aria-label="grinning face with smiling eyes" class="emoji emoji-1f601" role="img" title="grinning face with smiling eyes">:grinning_face_with_smiling_eyes:</span></p>



<a name="485998547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485998547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485998547">(Dec 04 2024 at 02:37)</a>:</h4>
<p>For the most part you should not have to generate any assembly directly. Cause we already have the assembler trait. That said, brushing up on assembly will definitely help use the trait, map it to an ir, and debug issues.</p>



<a name="485998630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485998630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485998630">(Dec 04 2024 at 02:37)</a>:</h4>
<p>yeah and i also want to re-famaliarize myself with just the whole thing yk</p>



<a name="485998684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485998684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485998684">(Dec 04 2024 at 02:38)</a>:</h4>
<p>been like a year or two since ive done any assembly</p>



<a name="485999158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/485999158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#485999158">(Dec 04 2024 at 02:42)</a>:</h4>
<p>Makes sense</p>



<a name="486206798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486206798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486206798">(Dec 05 2024 at 01:12)</a>:</h4>
<p>only one thing i really disagree with, and that's that the ir should use a integer as the target for jumps, which, given that the whole point would be for optimization, seems like it would be pretty hard to deal with (i would make essientally "label" no-ops that are used when generating the actual machine code, so basically like assembly). For instance, if we have a function that is (this is a very contrived example and also i didn't test that this on any assembler (note that destination first is used)):</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">store</span><span class="w"> </span><span class="no">LOC</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="c1">;0</span>
<span class="nf">add</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="c1">;1</span>
<span class="nf">load</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="p">[</span><span class="no">LOC</span><span class="p">]</span><span class="w"> </span><span class="c1">;2</span>
<span class="nl">JumpTo:</span><span class="w"> </span><span class="c1">;3</span>
<span class="nf">sub</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#1</span><span class="w"> </span><span class="c1">;4</span>
<span class="nf">cmp</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#5</span><span class="w"> </span><span class="c1">;5</span>
<span class="nf">jge</span><span class="w"> </span><span class="no">JumpTo</span><span class="w"> </span><span class="c1">;6</span>
</code></pre></div>
<p>if we <em>first</em> transform the labels to the instructions they refrence (technically LOC is also a label but that's not important) we get:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">store</span><span class="w"> </span><span class="no">LOC</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="c1">;0</span>
<span class="nf">add</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="c1">;1</span>
<span class="nf">load</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="p">[</span><span class="no">LOC</span><span class="p">]</span><span class="w"> </span><span class="c1">;2</span>
<span class="nf">nop</span><span class="w"> </span><span class="c1">;3</span>
<span class="nf">sub</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#1</span><span class="w"> </span><span class="c1">;4</span>
<span class="nf">cmp</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#5</span><span class="w"> </span><span class="c1">;5</span>
<span class="nf">jge</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="c1">;6</span>
</code></pre></div>
<p>Then when optimized, we get </p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">add</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="c1">;0</span>
<span class="nf">sub</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#1</span><span class="w"> </span><span class="c1">;1</span>
<span class="nf">cmp</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#5</span><span class="w"> </span><span class="c1">;2</span>
<span class="nf">jge</span><span class="w"> </span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="c1">;3</span>
</code></pre></div>
<p>Where the <code>jge</code> is now a loop, not the desired behavior! However, if we looked up the labels after, it is first optimized to:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">add</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="c1">;0</span>
<span class="nl">JumpTo:</span><span class="w"> </span><span class="c1">;1</span>
<span class="nf">sub</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#1</span><span class="w"> </span><span class="c1">;2</span>
<span class="nf">cmp</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#5</span><span class="w"> </span><span class="c1">;3</span>
<span class="nf">jge</span><span class="w"> </span><span class="no">JumpTo</span><span class="w"> </span><span class="c1">;4</span>
</code></pre></div>
<p>Then we realize the labels:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">add</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="no">eax</span><span class="w"> </span><span class="c1">;0</span>
<span class="nf">nop</span><span class="w"> </span><span class="c1">;1</span>
<span class="nf">sub</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#1</span><span class="w"> </span><span class="c1">;2</span>
<span class="nf">cmp</span><span class="w"> </span><span class="no">ebx</span><span class="w"> </span><span class="mi">#5</span><span class="w"> </span><span class="c1">;3</span>
<span class="nf">jge</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="c1">;4</span>
</code></pre></div>
<p>We fix the problem</p>



<a name="486208331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208331">(Dec 05 2024 at 01:30)</a>:</h4>
<p>I dont think we plan to support those kinds of optimizations</p>



<a name="486208360"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208360" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208360">(Dec 05 2024 at 01:30)</a>:</h4>
<p>Moving a nodes index is really expensive. Would requiring shifting all later nodes in the array.</p>



<a name="486208394"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208394" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208394">(Dec 05 2024 at 01:31)</a>:</h4>
<p>Not if it was a linked list</p>



<a name="486208425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208425">(Dec 05 2024 at 01:31)</a>:</h4>
<p>That is a lot of unnecessary cost</p>



<a name="486208449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208449">(Dec 05 2024 at 01:32)</a>:</h4>
<p>We only want something super slim</p>



<a name="486208493"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208493" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208493">(Dec 05 2024 at 01:32)</a>:</h4>
<p>This is the dev backend</p>



<a name="486208511"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208511" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208511">(Dec 05 2024 at 01:32)</a>:</h4>
<p>got it</p>



<a name="486208550"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208550" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208550">(Dec 05 2024 at 01:33)</a>:</h4>
<p>We can pattern match on final assembly generation if we want, but I don't think we want any passes that actually mutate this array in large ways (like inserting or deleting a node)</p>



<a name="486208601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208601">(Dec 05 2024 at 01:33)</a>:</h4>
<p>Register and stack info probably will be sideband to avoid inserting a bunch of load and store instructions into the ir.</p>



<a name="486208654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208654">(Dec 05 2024 at 01:34)</a>:</h4>
<p>At least that is the hope if it works out in practice</p>



<a name="486208701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208701">(Dec 05 2024 at 01:35)</a>:</h4>
<p>Just one quick write to go from mono to a flat array of roughly assembly. N passes that just edit nodes inplace or add sideband info. A final pass to take all that info and actually generate the final assembly.</p>



<a name="486208718"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486208718" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486208718">(Dec 05 2024 at 01:35)</a>:</h4>
<p>That's roughly the theory and hope.</p>



<a name="486209280"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486209280" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486209280">(Dec 05 2024 at 01:42)</a>:</h4>
<p>Note: I totally could be off about a constraint here. I have not thought about this in a long time or dug through it in a ton of detail. For background context. There was debate around if we should even add another ir. What we do currently is super adhoc, but it generates assembly crazy fast. We really want to keep as much of that speed as possible, just get slightly more reasonable dev assembly.</p>



<a name="486209304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486209304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486209304">(Dec 05 2024 at 01:42)</a>:</h4>
<p>But the target is still roughly <code>-O0</code> assembly</p>



<a name="486211437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486211437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486211437">(Dec 05 2024 at 02:06)</a>:</h4>
<p>oh yeah i thought it was gonna be something that would act as an IR for all the backends, so in other words, <code>Roc -&gt; IR</code> , and then <code>IR -&gt; LLVM</code>, <code>IR -&gt; WASM</code>, and, for the dev backend, just have an evaluator to get rid of the giant overhead of compilation</p>



<a name="486211505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486211505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486211505">(Dec 05 2024 at 02:07)</a>:</h4>
<p>but that makes a lot less sense now that i think about it</p>



<a name="486381396"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486381396" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486381396">(Dec 05 2024 at 19:45)</a>:</h4>
<p>Also why isn’t the dev backend just an interpreter? Wouldn’t that make it much faster</p>



<a name="486385192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385192">(Dec 05 2024 at 20:09)</a>:</h4>
<p>Roc isn't limited to being used through the cli, you can also compile it and embed it in other things. Also this interpreter would need to be platform specific.</p>



<a name="486385334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385334">(Dec 05 2024 at 20:10)</a>:</h4>
<p>No simply for the dev backend, as the idea for it is to be used for... devoloping. So keep LLVM, use that for release builds, and use <code>dev</code> for debugging.</p>



<a name="486385414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385414">(Dec 05 2024 at 20:10)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="453714">@Ryan Barth</span> had some interesting ideas in this direction. Not sure where we got to with that.</p>



<a name="486385500"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385500" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385500">(Dec 05 2024 at 20:10)</a>:</h4>
<p>ok, also, just because i feel like there is definitly something I'm doing wrong in <a href="https://github.com/roc-lang/roc/issues/7249">#7249</a>, how does one sign old commits that have already been pushed</p>



<a name="486385725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385725">(Dec 05 2024 at 20:12)</a>:</h4>
<p>An admin can bypass and merge, or you can interactively rebase and sign. I have a note on my laptop how to do it if you want to try that.</p>



<a name="486385762"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385762" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385762">(Dec 05 2024 at 20:12)</a>:</h4>
<p>yeah the rebasing, ive tried that a couple times but for some reason it appears to not fix the issue...</p>



<a name="486385803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385803">(Dec 05 2024 at 20:13)</a>:</h4>
<p>Nvm, I just realised what we were talking about. All done <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="486385877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385877">(Dec 05 2024 at 20:13)</a>:</h4>
<p>Thanks for working on that, and your patience</p>



<a name="486385902"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486385902" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486385902">(Dec 05 2024 at 20:14)</a>:</h4>
<p>ok ty and np (alas this is why i need to read the fine print of stuff...)</p>



<a name="486449115"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486449115" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486449115">(Dec 06 2024 at 06:29)</a>:</h4>
<p>Pro tip, you can do <code>git rebase --exec 'git commit --amend --no-edit -S' main</code> to rebase on main and sign all your commits.</p>



<a name="486489441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486489441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486489441">(Dec 06 2024 at 11:04)</a>:</h4>
<p>It can be a lot more complicated if you got merges in your commits as well</p>



<a name="486496237"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486496237" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486496237">(Dec 06 2024 at 11:44)</a>:</h4>
<p>Merges?  I thought we lived in a civilized world?</p>



<a name="486496664"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486496664" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486496664">(Dec 06 2024 at 11:47)</a>:</h4>
<p>Sorry I did not see your comment, I did a force push after my rebase :p</p>



<a name="486496810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486496810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486496810">(Dec 06 2024 at 11:48)</a>:</h4>
<p>Hopefully no one else is working on my feature branch :-)</p>



<a name="486549663"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486549663" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486549663">(Dec 06 2024 at 16:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/395097-compiler-development/topic/Dev.20Backend.20IR/near/486496237">said</a>:</p>
<blockquote>
<p>Merges?  I thought we lived in a civilized world?</p>
</blockquote>
<p>I think that a rebase only world is delightful, but I have really learned that many people can't cope with rebase. To be fair, rebase gets absolutely horrid if you make millions of small commits. (Which I think is way more common in open source).</p>
<p>Also, gits and GitHub are only mid at best. If they were better, rebasing might be more common.</p>



<a name="486681700"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486681700" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486681700">(Dec 07 2024 at 16:00)</a>:</h4>
<p>Should 128-bit registers be part of this IR? as far as I understand, 128-bit values have to be moved to stack, then mov'd to 2 64-bit registers in our current design, but if we're going to have some abstract IR register map to chip register anyway, I wonder how tricky it would be to allow 1 IR register to map to one or two chip registers based on the size?</p>



<a name="486687805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486687805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486687805">(Dec 07 2024 at 17:15)</a>:</h4>
<p>I don't think so. Cause you don't necessarily have to have both parts loaded at the same time. And that can enable better register use.</p>



<a name="486687825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486687825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486687825">(Dec 07 2024 at 17:15)</a>:</h4>
<p>So better to see it as a tuple of 2 u64</p>



<a name="486692310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486692310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486692310">(Dec 07 2024 at 18:17)</a>:</h4>
<p>do you have an example in mind? I suspect it won't be useful at the Mono-&gt;IR translation level to split across two IR registers, but rather something we do when translating IR-&gt;asm In other words, it's not useful to work on one half at a time in <code>gen_dev/generic64/mod.rs</code> which is where I imagine translating Mono to IR happens, but rather in <code>gen_dev/generic64/x86_64.rs</code> where translating IR to x86 asm happens.</p>



<a name="486692427"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486692427" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486692427">(Dec 07 2024 at 18:19)</a>:</h4>
<p>(I'm assuming also that allocating registers happens in the IR-&gt;asm steps)</p>



<a name="486692936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486692936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486692936">(Dec 07 2024 at 18:26)</a>:</h4>
<p>I actually think that it should just be registers are unspecified in size, and however large they need to be is specified at IR-&gt;Asm according to how large it needs to be according to instruction size, with perhaps a ‘extend’ and ‘truncate’ op, as it dosent really seem to be about “how much can we optimize instructions as “how much can we optimize memory usage” but that’s just my opinion</p>



<a name="486693520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486693520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486693520">(Dec 07 2024 at 18:34)</a>:</h4>
<p>The main goal is to avoid tons of extra instructions that are just spilling and loading from stack.</p>



<a name="486693583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486693583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486693583">(Dec 07 2024 at 18:34)</a>:</h4>
<p>Not really about memory usage, more about huge time sink and perf hit</p>



<a name="486693607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486693607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486693607">(Dec 07 2024 at 18:35)</a>:</h4>
<p>Just too heavy to be reasonable in a loop</p>



<a name="486693731"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486693731" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486693731">(Dec 07 2024 at 18:36)</a>:</h4>
<p>ASM doesn't work on 128 but values. Only register size or less values. I think keeping that abstraction is useful to make the target as simple as possible</p>



<a name="486693823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486693823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486693823">(Dec 07 2024 at 18:37)</a>:</h4>
<p>That said, infinite sized registers are common with more complex register allocation algorithms.</p>



<a name="486693843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486693843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486693843">(Dec 07 2024 at 18:37)</a>:</h4>
<p>So maybe would be valuable, haven't thought this through fully</p>



<a name="486694037"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486694037" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486694037">(Dec 07 2024 at 18:39)</a>:</h4>
<p>Given that, due to following c abi, most things will be required on the stack anyway, I had leaned towards keeping it simple and storing the true value of more things on the stack (like is done today). Then only solve register allocation for live subvalues that are actually being acted on.</p>



<a name="486694128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486694128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486694128">(Dec 07 2024 at 18:40)</a>:</h4>
<p>Definitely possible to do the reverse. Just changes the infrastructure father away from the simpler and more direct design of today (everything large has space on the stack and we only ever load register sized chunks of it)</p>



<a name="486694251"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486694251" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486694251">(Dec 07 2024 at 18:42)</a>:</h4>
<p>I could be wrong, but I think with infinite sized registers, you likely need more passes and a more complex algorithm to complete register allocation</p>



<a name="486699139"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699139" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699139">(Dec 07 2024 at 19:50)</a>:</h4>
<p>fair, and just to be clear, I haven't thought much past my recent attempt to implement add/sub/mul x checked/overflow/wrap for u128/i128 as asm rather than bitcode call. It feels like it would make those cases simpler, but raised the question here because that's a pretty narrow view.</p>



<a name="486699353"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699353" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699353">(Dec 07 2024 at 19:53)</a>:</h4>
<p>Hmmm yeah that makes sense, although abstracting that way makes it fundamentally harder to translate it to 32 bit</p>



<a name="486699443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699443">(Dec 07 2024 at 19:54)</a>:</h4>
<p>And also it might save a bit of memory by splitting registers (which would only be possible if we weren’t assuming each register is 64 bits)</p>



<a name="486699454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699454">(Dec 07 2024 at 19:54)</a>:</h4>
<p>But that would undoubtedly make it much more complex</p>



<a name="486699513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699513">(Dec 07 2024 at 19:55)</a>:</h4>
<p>One thing that would be hard to implement w/o memory apart from 64 bit registers are structs</p>



<a name="486699520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699520">(Dec 07 2024 at 19:55)</a>:</h4>
<p>As you’d need to use mutiple registers</p>



<a name="486699579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699579">(Dec 07 2024 at 19:56)</a>:</h4>
<p>Although you could just have “large registers” that will probably just become memory locations</p>



<a name="486699785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699785">(Dec 07 2024 at 19:59)</a>:</h4>
<p>re "following c abi, most things will be required on the stack", for the very specific case of those arithmetic functions that only take two u128/i128 arguments, they fit entirely in registers; and the return fits in rax+rdx as well. I haven't found a way to work with u128/i128 args that doesn't first push them to stack, so that's a case where not having 128bit registers (or a way to say "give me the two 64bit registers that this 128bit argument has been already loaded into") ends up with more mov's between stack/register.</p>



<a name="486699932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486699932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486699932">(Dec 07 2024 at 20:00)</a>:</h4>
<p>This could also be over-optimizing an edge case. I don't know how much roc code will be using <code>Num.mul</code> on u128/i128, but maybe <code>Dec</code>?</p>



<a name="486700238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700238">(Dec 07 2024 at 20:05)</a>:</h4>
<p>Yeah I do think that having registers of diffrent sizes would be useful, even if it was a little more complex, either with or without splitting them, and yeah ‘Dec’ is a case, and a very large case, of where a 128 bit registers would be useful (though frankly I think if performance is a concern f64 or perhaps Frac should be used instead)</p>



<a name="486700372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700372">(Dec 07 2024 at 20:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="782426">Wizard ish</span> <a href="#narrow/stream/395097-compiler-development/topic/Dev.20Backend.20IR/near/486699579">said</a>:</p>
<blockquote>
<p>Although you could just have “large registers” that will probably just become memory locations</p>
</blockquote>
<p>Yeah, I guess this is essentially what we have now</p>



<a name="486700420"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700420" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700420">(Dec 07 2024 at 20:07)</a>:</h4>
<p>Perhaps a way to “unsplit” registers, ie, if one did ‘rax’ and ‘rbx’ become a 128bit ‘rabx’</p>



<a name="486700480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700480">(Dec 07 2024 at 20:08)</a>:</h4>
<p>if an example is any help, here's the change to <a href="https://github.com/shua/roc/commit/03dd480de4997509d1cdc56ac23d12eca81c66e3#diff-23699c56834955756a70ebbe1514d93b91f31073cbc15bc78a352ab70292b2c5R1437-R1470">impl add u128/i128 as asm</a>.</p>



<a name="486700680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700680">(Dec 07 2024 at 20:11)</a>:</h4>
<p>I don't quite follow that change, why is the argument pushed onto the stack? If it is already in registers, couldn't it be just used directly from those registers?</p>



<a name="486700709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700709">(Dec 07 2024 at 20:11)</a>:</h4>
<p>We could have it so the virtual registers can have “hints” for the max size so if they’re moved into memory they can be smaller then the regular guarantee (ie if a register is used in a add 32 and mul 16 instructions and it has to at that point be moved into memory, instead of giving it a full 64 bits, it could just be given a 32 bit slot of memory (this would happen is IR-&gt;Backend</p>



<a name="486700790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700790">(Dec 07 2024 at 20:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/Dev.20Backend.20IR/near/486700680">said</a>:</p>
<blockquote>
<p>I don't quite follow that change, why is the argument pushed onto the stack? If it is already in registers, couldn't it be just used directly from those registers?</p>
</blockquote>
<p>that's just my not understanding how is the best way to get u128 args. I couldn't find any examples using registers, only other things that pushed to stack, then read what was pushed.</p>



<a name="486700802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700802">(Dec 07 2024 at 20:13)</a>:</h4>
<p>ok</p>



<a name="486700958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486700958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486700958">(Dec 07 2024 at 20:15)</a>:</h4>
<p>Also, I had assumed this ir would be just for generic64, I guess if it is for all of gen dev and a future theoretical generic32, it would need a more featured solution</p>



<a name="486701032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701032">(Dec 07 2024 at 20:16)</a>:</h4>
<p>That said, if it is too generic, it can't do register allocation</p>



<a name="486701058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701058">(Dec 07 2024 at 20:16)</a>:</h4>
<p>For example, you can't register allocate until you know if an i64 fits in a register or belongs on the stack</p>



<a name="486701076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701076">(Dec 07 2024 at 20:17)</a>:</h4>
<p>If it belongs on the stack you have to generate multiple instructions to handle the addition</p>



<a name="486701086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701086">(Dec 07 2024 at 20:17)</a>:</h4>
<p>And that set of instructions needs register alloctions</p>



<a name="486701208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701208">(Dec 07 2024 at 20:19)</a>:</h4>
<p>Given we don't want too much complexity, it is nice to have the abstraction that everything larger than a register is always on the stack. An optimization would be to allow things to be partially on the stack and partially loaded. A different optimization would be to use 2 registers as the cut off cause that matches c abi (this is the issue referenced with adding u128 currently and requiring dumping to stack). I'm not sure any of those optimizations need to be in the dev backend</p>



<a name="486701287"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701287" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701287">(Dec 07 2024 at 20:20)</a>:</h4>
<p>My biggest concern is with being too generic is that it will lead to more required transformation and a significant cost in time to generate a binary with the dev backend.</p>



<a name="486701300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701300">(Dec 07 2024 at 20:20)</a>:</h4>
<p>Yeah that’s the thing ain’t it, can’t be to complex</p>



<a name="486701310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701310">(Dec 07 2024 at 20:20)</a>:</h4>
<p>That is why I would learn towards just solving a bespoke solution for generic64 and not worring about 32 bit at all</p>



<a name="486701333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701333">(Dec 07 2024 at 20:21)</a>:</h4>
<p>32bit really needs a different asm trait. Which means it needs an entirely different ir.</p>



<a name="486701340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701340">(Dec 07 2024 at 20:21)</a>:</h4>
<p>yeah, I don't know what the right answer is, but "complex structs on the stack, primitives in registers" sounds correct. The question is what to do with u128/i128 and Dec. Are these primitives or complex?</p>



<a name="486701438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701438">(Dec 07 2024 at 20:22)</a>:</h4>
<p>Although I feel that the stack should be abstracted as “struct registers” just to be the abstraction, although that might cause a performance problem</p>



<a name="486701454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701454">(Dec 07 2024 at 20:22)</a>:</h4>
<p>I think you are probably right</p>



<a name="486701459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701459">(Dec 07 2024 at 20:23)</a>:</h4>
<p>About the abstraction</p>



<a name="486701603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701603">(Dec 07 2024 at 20:24)</a>:</h4>
<p>The assembly would have functions to load from and store to "struct registers". Then it would have tons more functions to operate on normal registers. It would later calculate stack offsets for all struct registers (maybe even using lifetime analysis to reuse stack space)</p>



<a name="486701631"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701631" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701631">(Dec 07 2024 at 20:25)</a>:</h4>
<p>Wait so I was right about it being a good idea or a bad idea?</p>



<a name="486701650"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701650" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701650">(Dec 07 2024 at 20:25)</a>:</h4>
<p>Also it could just have functions to go from struct to normal</p>



<a name="486701654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486701654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486701654">(Dec 07 2024 at 20:25)</a>:</h4>
<p>That having struct registers as an abstraction for the stack is a good idea</p>



<a name="486702255"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486702255" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486702255">(Dec 07 2024 at 20:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="722031">shua</span> <a href="#narrow/stream/395097-compiler-development/topic/Dev.20Backend.20IR/near/486701340">said</a>:</p>
<blockquote>
<p>yeah, I don't know what the right answer is, but "complex structs on the stack, primitives in registers" sounds correct. The question is what to do with u128/i128 and Dec. Are these primitives or complex?</p>
</blockquote>
<p>I think they have to be seen as complex due to no real assembly operations being available for them. If we want to do a minor optimization, we could make a special optimization to allow storing them in 2 registers.</p>



<a name="486703471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486703471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486703471">(Dec 07 2024 at 20:53)</a>:</h4>
<p>I think you're right. I only have one counterpoint which is in x86_64, <code>mul rcx</code> will have as dest, <code>rax</code> and <code>rdx</code> which is a 128bit value split over two 64bit registers.</p>



<a name="486709438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486709438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486709438">(Dec 07 2024 at 22:16)</a>:</h4>
<p>Yeah, it is definitely imperfect. We need a smart way for assembly operations to claim registers temporarily.</p>



<a name="486717413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486717413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486717413">(Dec 08 2024 at 00:14)</a>:</h4>
<p>Hmmm well for the meantime tomorrow ill write up something to describe it just so we’re all on the same page</p>



<a name="486718692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486718692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486718692">(Dec 08 2024 at 00:35)</a>:</h4>
<p><span aria-label="folded hands" class="emoji emoji-1f64f" role="img" title="folded hands">:folded_hands:</span></p>



<a name="486790650"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486790650" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486790650">(Dec 08 2024 at 18:09)</a>:</h4>
<p>Oh, and one final thing, how should results be given, should they (all the following all accomplish </p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>C</mi><mo>=</mo><mi>A</mi><mo>+</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">C=A+B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span></p>
<ol>
<li>Be stored in an Accumulator (<code>ACC</code>)</li>
</ol>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">add</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span>
<span class="nf">mov</span><span class="w"> </span><span class="no">C</span><span class="w"> </span><span class="no">ACC</span>
</code></pre></div>
<ol start="2">
<li>Be stored in a operand (to the function itself) </li>
</ol>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">mov</span><span class="w"> </span><span class="no">C</span><span class="w"> </span><span class="no">A</span>
<span class="nf">add</span><span class="w"> </span><span class="no">C</span><span class="w"> </span><span class="no">B</span>
</code></pre></div>
<ol start="3">
<li>Or stored in a operand given seperatly </li>
</ol>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">add</span><span class="w"> </span><span class="no">C</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span>
</code></pre></div>



<a name="486791392"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486791392" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486791392">(Dec 08 2024 at 18:19)</a>:</h4>
<p>also IMO it shoud be called ROAR :) <br>
ROAR = Roc Optimizable Abstract Representation</p>



<a name="486793727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486793727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486793727">(Dec 08 2024 at 18:51)</a>:</h4>
<p>I would suggest (2)</p>



<a name="486793858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486793858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486793858">(Dec 08 2024 at 18:53)</a>:</h4>
<p>yeah that is the most common, but i also like option 1, as it allows for calls to functions and their returns to be modeled quite simply, although of course that increases complexity</p>



<a name="486796599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796599">(Dec 08 2024 at 19:31)</a>:</h4>
<p>Current assembly is all 3 arg like arm</p>



<a name="486796610"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796610" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796610">(Dec 08 2024 at 19:31)</a>:</h4>
<p>I think that is nicest</p>



<a name="486796620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796620">(Dec 08 2024 at 19:31)</a>:</h4>
<p>Encode result register in the ASM directly</p>



<a name="486796645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796645">(Dec 08 2024 at 19:31)</a>:</h4>
<p>i think all have their merits personally</p>



<a name="486796653"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796653" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796653">(Dec 08 2024 at 19:31)</a>:</h4>
<p>So it all matches 3 today</p>



<a name="486796708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796708">(Dec 08 2024 at 19:32)</a>:</h4>
<p>although given it's purpose 3 is probably the best (it makes it very apparent what registers are being <em>modified</em>)</p>



<a name="486796734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796734">(Dec 08 2024 at 19:32)</a>:</h4>
<p>Given risc v and arm are both 3 and x86 is the only special on (and it is trivial to decompose to x86), I would push for 3.</p>



<a name="486796761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796761">(Dec 08 2024 at 19:33)</a>:</h4>
<p>ok then itll be 3 :)</p>



<a name="486796785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796785">(Dec 08 2024 at 19:33)</a>:</h4>
<p>so i think thats it, which is to say in about fifteen minutes ill probably have another question :)</p>



<a name="486796788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486796788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486796788">(Dec 08 2024 at 19:33)</a>:</h4>
<p>Also, you can always do (<code>add a a b</code> for I place if register allocation realizes it is ok)</p>



<a name="486805883"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486805883" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486805883">(Dec 08 2024 at 21:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="782426">Wizard ish</span> <a href="#narrow/channel/395097-compiler-development/topic/Dev.20Backend.20IR/near/486791392">said</a>:</p>
<blockquote>
<p>also IMO it shoud be called ROAR :) <br>
ROAR = Roc Optimizable Abstract Representation</p>
</blockquote>
<p>Also what yall think, yae or nae for <em>ROAR</em></p>



<a name="486805962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486805962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486805962">(Dec 08 2024 at 21:46)</a>:</h4>
<p>I'm here for the name. It's fun to pick something like that and have it persist for a decade or so and have people take it seriously</p>



<a name="486816803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486816803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486816803">(Dec 09 2024 at 00:26)</a>:</h4>
<p>Made a first draft of the <a href="https://github.com/wizard7377/roc/blob/29f2cdfb823fef8c7513b43300441ccf9cd19a0f/design/language/Roar.md">proposal</a></p>



<a name="486821769"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486821769" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486821769">(Dec 09 2024 at 01:34)</a>:</h4>
<p>Looking great, thanks for taking the time to do this design work. I think it will really help to clarify things.</p>
<p>I've copied some random notes from skimming back through the thread. </p>
<p>I think it would be helpful to provide a little more context/background or a summary to motivate this change. We can talk about how the dev backend is currently very fast but maybe fragile or overly complicated... (my words, no idea if this is accurate). </p>
<ul>
<li>
<p>Goal: reduce complexity of the dev backend related to where data is stored and how it is loaded</p>
</li>
<li>
<p>Goal: maintain fast compilation speed for the development backend, while improving runtime performance.</p>
</li>
</ul>
<blockquote>
<p>we definitely want ok register allocation in the long term. It will be important to get enough performance that end users actually want to use the dev backend for reasonably sized projects.</p>
</blockquote>
<ul>
<li>Goal: provide register allocation </li>
</ul>
<blockquote>
<p>it will be useful for making the dev backend output assembly easier to read and debug.</p>
</blockquote>
<ul>
<li>Goal: improve maintainability for dev backend</li>
</ul>
<p>Does this improve our ability to test things? should we mention that? </p>
<blockquote>
<p>change the Dev backend to have an ir that can be stored in a flat array (rather than a tree structure/not existing), that is essentially a portable assembly (one op per function in the current Assembler trait). Main gain of doing this is for future minor optimizations that we want to run on the ir. The big one being register allocation. With the current IR, register allocation, and lifetimes in general, are very much not a clean problem. Mono is a tree. It also is not nearly as fine grain as individual assembly instructions. So it is very hard to have any idea how many registers will be needed for a specific mono ir node.</p>
</blockquote>
<p>Should we include this motivation in the ROAR proposal?</p>
<ul>
<li>used only for 64-bit development backends</li>
</ul>
<p>I may have missed it, but is this mentioned in the ROAR proposal? 32-bit architectures are out of scope.</p>
<blockquote>
<p>"It would also just be for defining within a single procedure and any jmp type instructions would just use a integer as the target that is which other instruction in the array to jump to."</p>
</blockquote>
<p>Is this covered in the proposal?</p>
<blockquote>
<p>Possible future optimisations<br>
- grouping instructions for final output<br>
- intentionally reusing source and dest reg to avoid extra data movement instructions<br>
- freeing up the base pointer by calculating all offsets with the stack pointer<br>
- storing some aggregate values in registers if available instead of on the stack<br>
- maybe some minor and quick rewrites.</p>
</blockquote>
<p>Would be good to include future work in the context of ROAR</p>
<blockquote>
<p>All "extra" optimizations can be evaluated one at a time to see if they meet our tradeoffs.</p>
</blockquote>
<p>Future optimizations can be evaluated individually. how would we do this? is this something we can benchmark easily?</p>
<blockquote>
<p>it should be possible to run this part of the dev backend in parallel. Only merging the final generated assembly into an output object file.</p>
</blockquote>
<p>Is this possible or a goal? would be good to mention it.</p>



<a name="486823158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/486823158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#486823158">(Dec 09 2024 at 01:52)</a>:</h4>
<p>Ok, yeah Ill get to adding those (thanks for taking time to review it)</p>



<a name="487077940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487077940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487077940">(Dec 09 2024 at 19:14)</a>:</h4>
<p>Sorry for being slow about commenting on this (energy for roc has been low lately). Will try to write up more comprehensive comments hopefully this afternoon PST.</p>



<a name="487104842"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487104842" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487104842">(Dec 09 2024 at 21:41)</a>:</h4>
<p>I have two ideas, both of which involve function calls, that I'm interested to hear your opionions on:</p>
<ol>
<li>While local jumps have been covered as being absolute addresses, I think that there should be a more adressing modes. As mentioned before, ROAR will diffenitly be split up into functions, with each one being a discrete chunk of code. However, I think we should also have larger <em>segments</em>, with those being groups of function, each one reperesenting a single program unit (a library or file, perhaps)</li>
<li>Relatedly, ROAR does not have a way to deal with IO and other specific needs. As the goal of ROAR is to be simple, I would propose a simple "black box" instruction, <code>int N</code> (derived from the instruction in x86 for interupts) which would be do a special action N, which can't be modeled in ROAR. IMO this would go right along with Roc's notion of "platforms", and they could be correlated (although this isn't substantiated by any logical reason, just a general sort of feeling)<br>
So yeah what do yall think about these?</li>
</ol>



<a name="487122370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487122370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487122370">(Dec 09 2024 at 23:38)</a>:</h4>
<p>also just making sure about this (because its a pretty big thing) the goal would be to go from <code>Roc-&gt;ROAR-&gt;Bin</code> as opposed to the current <code>Roc-&gt;Mono-&gt;Bin</code>?</p>



<a name="487122674"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487122674" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487122674">(Dec 09 2024 at 23:40)</a>:</h4>
<p>Not an expert, but presumably it'd be <code>Roc-&gt;Mono-&gt;ROAR-&gt;Bin</code></p>



<a name="487122726"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487122726" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487122726">(Dec 09 2024 at 23:40)</a>:</h4>
<p>Monomorphization is the process that takes generic functions and spits out statically typed functions</p>



<a name="487122778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487122778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487122778">(Dec 09 2024 at 23:41)</a>:</h4>
<p>It's probably not worth having to duplicate that effort in ROAR</p>



<a name="487122843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487122843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487122843">(Dec 09 2024 at 23:42)</a>:</h4>
<p>Let me read the proposal first</p>



<a name="487122942"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487122942" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487122942">(Dec 09 2024 at 23:42)</a>:</h4>
<p>wait a moment, is Roc Mono diffrent from .Net Mono?</p>



<a name="487122979"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487122979" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487122979">(Dec 09 2024 at 23:42)</a>:</h4>
<p>it's not like an extension?</p>



<a name="487123010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123010">(Dec 09 2024 at 23:43)</a>:</h4>
<p>I don't know dot net's Mono</p>



<a name="487123024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123024">(Dec 09 2024 at 23:43)</a>:</h4>
<p>But Roc mono is a lot like Rust's mono</p>



<a name="487123059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123059">(Dec 09 2024 at 23:43)</a>:</h4>
<p>oh that's why a lot of stuff about it didn't make much sense</p>



<a name="487123087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123087">(Dec 09 2024 at 23:44)</a>:</h4>
<p>It's a phase of the compiler after type checking where we take type checked code and spit out IR that is simple yet concrete</p>



<a name="487123175"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123175" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123175">(Dec 09 2024 at 23:44)</a>:</h4>
<p>So if I have a function that typechecked to <code>numToStr : Num * -&gt; Str</code></p>



<a name="487123202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123202">(Dec 09 2024 at 23:44)</a>:</h4>
<p>And I use it with the inputs <code>U64</code> and <code>I8</code></p>



<a name="487123250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123250">(Dec 09 2024 at 23:45)</a>:</h4>
<p>I'll get two functions out of mono, <code>numToStr : U64 -&gt; Str</code> and <code>numToStr : I8 -&gt; Str</code></p>



<a name="487123321"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123321" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123321">(Dec 09 2024 at 23:45)</a>:</h4>
<p>Yeah that makes more sense...<br>
I was wondering why Roc used the Microsoft IR, but this makes way more sense</p>



<a name="487123329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123329">(Dec 09 2024 at 23:45)</a>:</h4>
<p>Now, that's based on my incomplete understanding of what:</p>
<ul>
<li>The part of the code I've read said</li>
<li>How I understand Rust's mono works</li>
<li>How I've have our code explained at a high level</li>
</ul>



<a name="487123395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123395">(Dec 09 2024 at 23:46)</a>:</h4>
<p><a href="https://en.wikipedia.org/wiki/Monomorphization">https://en.wikipedia.org/wiki/Monomorphization</a></p>



<a name="487123440"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123440" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123440">(Dec 09 2024 at 23:46)</a>:</h4>
<p>Monomorphization is good because it trades a larger binary size for better performance</p>



<a name="487123473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123473">(Dec 09 2024 at 23:47)</a>:</h4>
<p>If you don't do monomorphization, you end up with a single function that needs to check the input's type at runtime</p>



<a name="487123493"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123493" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123493">(Dec 09 2024 at 23:47)</a>:</h4>
<p>More or less</p>



<a name="487123935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487123935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487123935">(Dec 09 2024 at 23:50)</a>:</h4>
<p>I thought Mono Ir refered to <a href="https://www.mono-project.com/docs/advanced/runtime/docs/linear-ir/">this</a> <span aria-label="speechless" class="emoji emoji-1f636" role="img" title="speechless">:speechless:</span></p>



<a name="487124073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124073">(Dec 09 2024 at 23:51)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/tree/main/crates#roc-compiler-stages">https://github.com/roc-lang/roc/tree/main/crates#roc-compiler-stages</a></p>
<p>This might be helpful</p>



<a name="487124157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124157">(Dec 09 2024 at 23:52)</a>:</h4>
<p>Specialize is the term in that diagram</p>



<a name="487124198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124198">(Dec 09 2024 at 23:52)</a>:</h4>
<p>yeah that was my bad for <em>really</em> reading things too quickly</p>



<a name="487124210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124210">(Dec 09 2024 at 23:52)</a>:</h4>
<p>As in "take each specific use of generic entities and make a specialized version"</p>



<a name="487124229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124229">(Dec 09 2024 at 23:52)</a>:</h4>
<p>Welcome to the club</p>



<a name="487124292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124292">(Dec 09 2024 at 23:53)</a>:</h4>
<p>Don't worry about it too much. I think the more important part is that you're helping us make a big improvement part to a tricky part of the compiler. That's awesome!</p>



<a name="487124437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124437">(Dec 09 2024 at 23:54)</a>:</h4>
<p>yeah, well fourtanetly it dosen't actually affect my understanding of it that much, as the idea is basically the same, but thank you for the patience :)</p>



<a name="487124460"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487124460" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487124460">(Dec 09 2024 at 23:55)</a>:</h4>
<p>Of course</p>



<a name="487134726"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487134726" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487134726">(Dec 10 2024 at 01:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="782426">Wizard ish</span> <a href="#narrow/channel/395097-compiler-development/topic/Dev.20Backend.20IR/near/487104842">said</a>:</p>
<blockquote>
<p>I have two ideas, both of which involve function calls, that I'm interested to hear your opionions on:</p>
<ol>
<li>While local jumps have been covered as being absolute addresses, I think that there should be a more adressing modes. As mentioned before, ROAR will diffenitly be split up into functions, with each one being a discrete chunk of code. However, I think we should also have larger <em>segments</em>, with those being groups of function, each one reperesenting a single program unit (a library or file, perhaps)</li>
<li>Relatedly, ROAR does not have a way to deal with IO and other specific needs. As the goal of ROAR is to be simple, I would propose a simple "black box" instruction, <code>int N</code> (derived from the instruction in x86 for interupts) which would be do a special action N, which can't be modeled in ROAR. IMO this would go right along with Roc's notion of "platforms", and they could be correlated (although this isn't substantiated by any logical reason, just a general sort of feeling)<br>
So yeah what do yall think about these?</li>
</ol>
</blockquote>
<p>I don't think we'll have a need for either. The dev backend already has solutions for both.</p>
<p>The dev backend only ever worries about generating a single procedure at a time. As such, each procedure can be 100% self contained without any worry of what other procedures are doing. So we never need long jumps or other special things like segments. I think it would be 100% fine for ROAR to slot in such that it is only used during single function compilation. I think that it will actually fit best there.</p>
<p>This is the same for io. There is no need to worry about it. We never do it directly in roc. All of this will always go through a function call. So the call instruction is all you will need.</p>
<p>Using relocations + call instructions solve all of the above nicely.</p>



<a name="487134916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487134916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487134916">(Dec 10 2024 at 01:21)</a>:</h4>
<p>So I would imagine the compilation process as:</p>
<ol>
<li>roc source</li>
<li>roc compilation to mono</li>
<li>For each function in mono, run the dev backend. This consists of:<ol>
<li>convert to ROAR</li>
<li>run register allocation (plus any other future passes)</li>
<li>output assembly + relocations</li>
</ol>
</li>
</ol>



<a name="487135467"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487135467" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487135467">(Dec 10 2024 at 01:27)</a>:</h4>
<p>You say each "function in mono", which is currently all top-level values, since we convert (at least most) top-level constants to thunks with <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/mono/src/ir.rs#L8186">force_thunk</a> AFAICT. I presume this strategy would work if/when we decided to move towards non-thunked top level constants, but just wanna call that out in case there would be an issue</p>



<a name="487135565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487135565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487135565">(Dec 10 2024 at 01:27)</a>:</h4>
<p>Sure, we should either force thunks for the dev backend or we would also have to do constant generation, but for constants, we wouldn't need ROAR at all.</p>



<a name="487136173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487136173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487136173">(Dec 10 2024 at 01:32)</a>:</h4>
<p>Maybe I missed something in the discussion, but it would still need to translate complex constants, right? We said above that even I128 would get multiple "registers", so a struct/discriminated union would need to be loaded like any other variable that was stored in a prior register. This should be very minor compared to the main scope of ROAR, though</p>



<a name="487136718"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487136718" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487136718">(Dec 10 2024 at 01:37)</a>:</h4>
<p>no, they will all just be equivalent to the constant stored on the stack. So they are just a chunk of bytes that we get the address of and load data from.</p>



<a name="487136792"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487136792" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487136792">(Dec 10 2024 at 01:38)</a>:</h4>
<p>So they would in the roar proposal just be represented as a structured register (which is really just a pointer to memory)</p>



<a name="487136965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487136965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487136965">(Dec 10 2024 at 01:39)</a>:</h4>
<p>Oh and relating to your comment on the PR, I've moved the proposal to it's own repo <a href="https://github.com/wizard7377/ROAR">here</a></p>



<a name="487137183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487137183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487137183">(Dec 10 2024 at 01:42)</a>:</h4>
<p>comments on the proposal:</p>
<ol>
<li>main idea around instructions and operands sounds great.</li>
<li>abstract registers and the lack of types sounds perfect</li>
<li>I think we should iterate on the abstract stack. I think that by default that ROAR should not care about saving registers for call instructions. I think it is safe to just use the callee saved registers first followed by the caller saved registers. When generating a call assembly, the backend assembly can add in all of the pushes and pops. If we later find this to be a bottleneck, we can add caller and callee saved register info into the register allocation pass to make it a bit smarter. Either way, this info would not be need in the IR and would likely just be part of an optimization pass. I need to think more about jump instructions, but I think due to how roc organizes ir, something similar should hold true. I belive that roc explicitly labels all data that needs to be passed to a jump instruction (such that it looks like a call instruction as well). Need to double check on that, but I think we can get away with something simple here.</li>
<li>For structured registers, I think that we should use an explicit load and store instruction instead of overloading the move instruction. I think it will help keep things clean and clear. We also will need some way to represent data that starts on the stack due to the c calling convention. So I think we likely need to actually store these outside of the core ir. I would propose that we have a flat dictionary of structured registers/stack values. It would be initialized with the arguments to the function that are on the stack. Instead of having a create instruction, it would be a function that adds a new index to this map. Each value in the map will hold where the data is stored and how large it is. For starters, most data will not have a real location, at some point, we will have to map all of that data to concrete stack locations (likely with a pass very similar to register allocation). Hopefully this rough idea makes sense. It essentially allows the almost everything to think in registers, but when it doesn't think in registers, it thinks in abstract memory that it can just call load and store instructions to. Later the abstract memory is mapped to real memory, but no need to change the ir, just the list of memory locations. Also, just realized, doesn't need to be a map, would just be a list where the index is the structured register number.</li>
</ol>



<a name="487140809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487140809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487140809">(Dec 10 2024 at 02:14)</a>:</h4>
<p>Just one thing, if registers aren’t being explicitly saved, how will the program differentiate registers that are set to for the purpose of returning values and those that simply hold intermediate values? Would the plan be for the return and call op take an argument that is what register should be returned / saved to?</p>



<a name="487146385"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487146385" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487146385">(Dec 10 2024 at 02:54)</a>:</h4>
<p>Oh, this is actually a really good point I hadn't full though through. In the current design, due to having access to mono, a call or return instruction is given a list of symbols. Those symbols are the loaded and dealt with according to the c abi for that system. If we are abstracting into ROAR, we have to decide how to deal with that mapping and call convention. Hmm.</p>
<p>So that gives three main options I can think of:</p>
<ol>
<li>Define a restricted machine agnostic call convention such that roar deals with the call conv including stack vs register.</li>
<li>Have roar be partially machine specific. It would query the backend to learn about it's call conv and then inserts structure register stores and data swaps to prep everything for the call.</li>
<li>For call and return instructions, keep a mapping to the original mono nodes in roar. When generating assembly for a call instruction we pass in the layout info from mono along with a list of abstract and structural registers for the arguments. The backend then deals with loading those to match the calling convention.</li>
</ol>
<p>I lean 3, but am open to other opinions and ideas for sure.</p>



<a name="487240520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487240520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487240520">(Dec 10 2024 at 12:47)</a>:</h4>
<p>Personally I think 1 is better, as it keeps the process pure (ie, machine agnostic and seperate from mono), which would probably help with maintainability</p>



<a name="487286867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487286867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487286867">(Dec 10 2024 at 16:00)</a>:</h4>
<p>Also if we restricted ROAR functions to returning one argument, we could just have ‘call’ instructions take an output register that would the be set to a corresponding register returned with ‘ret’<br>
As for passing arguments, this could be even more simple, just pass them in registers, and only differentiate it from the original once it’s been set</p>



<a name="487288914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487288914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487288914">(Dec 10 2024 at 16:09)</a>:</h4>
<p>It definitely has to learn to speak c abi no matter what, sadly. It has to be callable from the platform and be able to call the zig builtins and platform effects.</p>



<a name="487291833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487291833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487291833">(Dec 10 2024 at 16:22)</a>:</h4>
<p>This is why the dev backend currently speaks c abi. I found it easier to be consistent than makes exceptions for the edges.</p>



<a name="487333034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487333034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487333034">(Dec 10 2024 at 20:11)</a>:</h4>
<p>but shouldn't this be abstracted as part of the <code>ROAR-&gt;Binary</code> interface, given that one of the primary goals is to be platform agnostic? (which ccould be solved by somethig like <a href="#narrow/channel/395097-compiler-development/topic/Dev.20Backend.20IR/near/487104842">this</a>?)</p>



<a name="487341802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487341802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487341802">(Dec 10 2024 at 21:11)</a>:</h4>
<p>I don't think the goal of roar is really to be platform agnostic. It is trying to abstract away a level of assembly details, but register allocation (which will run on roar) is platform specific. On top of that specific handling of the stack, that will come out of converting from structured registers to stack use is also platform specific.</p>
<p>So roar should be expected to pull in platform details. That said, I think that 3 is platform agnostic. Roar will simply record the information it needs to pass to the final assembly generation for it to deal with generating the correct call conv.</p>



<a name="487342169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487342169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487342169">(Dec 10 2024 at 21:14)</a>:</h4>
<p>The reason I don't think we need something like black box. is that nothing is black box. They are just function calls. The same as any other function call.</p>



<a name="487342522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487342522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487342522">(Dec 10 2024 at 21:17)</a>:</h4>
<p>ok got it</p>



<a name="487343060"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487343060" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487343060">(Dec 10 2024 at 21:21)</a>:</h4>
<p>I'm not sure how much you have look at the current traits, but we actually have one for assembly and a second for callconv. If you look at a callconv trait impl this is what making a function call looks like today: <a href="https://github.com/roc-lang/roc/blob/f8b0be725c1677dd1c39cc68723fe4ad5ce09ade/crates/compiler/gen_dev/src/generic64/x86_64.rs#L292-L337">https://github.com/roc-lang/roc/blob/f8b0be725c1677dd1c39cc68723fe4ad5ce09ade/crates/compiler/gen_dev/src/generic64/x86_64.rs#L292-L337</a></p>
<p>ROAR could call essentially the same primitive.</p>



<a name="487343245"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487343245" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487343245">(Dec 10 2024 at 21:23)</a>:</h4>
<p>Just instead of using <code>Symbol</code> from mono, it would use abstract and struct registers.</p>



<a name="487345311"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487345311" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487345311">(Dec 10 2024 at 21:37)</a>:</h4>
<p>so if i'm understanding correctly you would just have the call function accept any number of args, including one for where to place the return value?</p>



<a name="487345793"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487345793" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487345793">(Dec 10 2024 at 21:41)</a>:</h4>
<p>yep</p>



<a name="487345887"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/487345887" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#487345887">(Dec 10 2024 at 21:41)</a>:</h4>
<p>With the minor caveat that we may want to handle storage in a special way to avoid bloating the roar enum in rust. Don't want to take up too many bytes per assembly instruction</p>



<a name="488538572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488538572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488538572">(Dec 12 2024 at 02:22)</a>:</h4>
<p>I've been making a little progress with the proposal, just wanted to make sure I'm putting down correctly what yall mean, in particular about the function calls <a href="https://github.com/wizard7377/ROAR">https://github.com/wizard7377/ROAR</a></p>



<a name="488552411"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488552411" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488552411">(Dec 12 2024 at 04:57)</a>:</h4>
<p>I'm really liking how this is looking!</p>



<a name="488552547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488552547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488552547">(Dec 12 2024 at 04:58)</a>:</h4>
<p>I'm not sure the value of making <code>cmp</code>, <code>jmp</code>, <code>ret</code>, etc functions return a null value, but if in practice it helps build out a consistent interface, that sounds fine. I assume the assembly will map to rust enum. The powerful pattern matching in rust should make it ok for some ops to differ.</p>



<a name="488552711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488552711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488552711">(Dec 12 2024 at 05:00)</a>:</h4>
<blockquote>
<p>ROAR is that every function is pure (with respect to registers)</p>
</blockquote>
<p>I'm not 100% sure the caveats of the meanings here, but it is important to note that some values passed into function will get mutated. That said, it will never be a register value. It will always be a pointer to data on the heap that gets mutated (like a list with a refcount of one).</p>



<a name="488552762"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488552762" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488552762">(Dec 12 2024 at 05:00)</a>:</h4>
<p>I think this likely falls into what you are saying, but wanted to clarify</p>



<a name="488552856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488552856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488552856">(Dec 12 2024 at 05:02)</a>:</h4>
<p>Also, for structured registers (at least as roc exists today), all loads and stores should be to a compile time known offset. Also, we will need the ability to load at different widths, but that can just be a <code>load8</code> vs <code>load32</code> vs <code>load64</code>.</p>



<a name="488552978"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488552978" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488552978">(Dec 12 2024 at 05:02)</a>:</h4>
<p>And roc will make sure that all loads are properly aligned based on the layout of the data. So we should have no concerns there.</p>



<a name="488553076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488553076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488553076">(Dec 12 2024 at 05:03)</a>:</h4>
<p>Also, for jumps, I know that roc only has structured loops, so we may be able to take advantage of something there. But I'm not sure what exactly. Just noting.</p>



<a name="488553198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488553198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488553198">(Dec 12 2024 at 05:05)</a>:</h4>
<p>Oh, one other note for jmps. Roc's jumps technically have arguments, but we should be able to map that into editing the same roar registers over and over again.</p>



<a name="488651257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488651257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488651257">(Dec 12 2024 at 14:53)</a>:</h4>
<p>Yeah, I might’ve forgotten about the references not being mutated dosent correlate to the referents being mutated</p>



<a name="488652042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488652042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488652042">(Dec 12 2024 at 14:56)</a>:</h4>
<p>Also can you explain a little bit more about what you mean about them taking arguments, do you mean they should be similar to RISC branch instructions (ie, the instruction contains the condition)</p>



<a name="488673593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488673593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488673593">(Dec 12 2024 at 16:32)</a>:</h4>
<p>I just mean that in mono ir, jumps look a lot like function calls.</p>



<a name="488674106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488674106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488674106">(Dec 12 2024 at 16:34)</a>:</h4>
<p>There is a block declared with a joinpout. The join point has a list of args. Within the block you can access any constants from before the jointpoint and the args as well. At some point in the main code flow, it calls a jump instruction to a join point with a list of args.</p>



<a name="488674583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488674583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488674583">(Dec 12 2024 at 16:37)</a>:</h4>
<p>In roar, this could be modeled as raw assembly style jumps with register updates before the jump to set the args. Or it could be modeled closer to a function call. Not sure either is better, just worth noting and thinking about.</p>



<a name="488710896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488710896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488710896">(Dec 12 2024 at 20:15)</a>:</h4>
<p>yeah personally im much more familiar with <code>x86</code> and <code>6502</code> assembly, and in those, <code>jmp</code>s basically only change the instruction pointer, so that just seems more natrual to me, but only because that's the only thing ive ever encountered</p>



<a name="488714609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488714609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488714609">(Dec 12 2024 at 20:41)</a>:</h4>
<p>Yeah, rocs mono isn't trying to be assembly. So makes sense it has a high level concept</p>



<a name="488923772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488923772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488923772">(Dec 13 2024 at 21:27)</a>:</h4>
<p>should ROAR have seperate floating point registers?</p>



<a name="488924497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488924497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488924497">(Dec 13 2024 at 21:32)</a>:</h4>
<p>Would be nice for a tiny bit of extra safety, but would be fine to start with unified registers and then only convert to float vs general registers during allocation.</p>
<p>So I think either is fine before register allocation. I lean slightly towards just having them</p>



<a name="488925884"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/488925884" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#488925884">(Dec 13 2024 at 21:44)</a>:</h4>
<p>yeah i also lean on having them, theyre isnt really a reason not to and basically all systems do so it probably will be more efficient</p>



<a name="489133383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489133383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489133383">(Dec 16 2024 at 01:45)</a>:</h4>
<p>Did some work on the proposal (still not done)... and i may have just realized gh md has a diagramming feature... <a href="https://github.com/wizard7377/ROAR#optimizations">https://github.com/wizard7377/ROAR#optimizations</a></p>



<a name="489391619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489391619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489391619">(Dec 17 2024 at 02:44)</a>:</h4>
<p>Ok I <em>think</em> <a href="https://github.com/wizard7377/ROAR">this</a> is the first draft, is there anything any of you think needs to be added to this (obviously needs to be cleaned up a lot)</p>



<a name="489392084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489392084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489392084">(Dec 17 2024 at 02:47)</a>:</h4>
<p>I'll read through it when I get the chance, but packing tonight and traveling tomorrow.</p>



<a name="489392169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489392169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489392169">(Dec 17 2024 at 02:48)</a>:</h4>
<p>nice safe travels :)</p>



<a name="489392349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489392349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489392349">(Dec 17 2024 at 02:49)</a>:</h4>
<p>Also, on the llvm side, I think I am going to greatly simplify abi (including the c abi we generate). Dev backend may want to do the same (might not really affect the proposal). The core change is that all aggregate types will be passed by const ref. Then only enums and numeric types are passed in registers.</p>



<a name="489392508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489392508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489392508">(Dec 17 2024 at 02:50)</a>:</h4>
<p>if anything that actually works with the proposal quite nicely</p>



<a name="489396076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489396076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489396076">(Dec 17 2024 at 03:18)</a>:</h4>
<p>I don't know very much about c abi, but I can say that this was a well-written doc that even a mid-wit (as regards assembly) like myself could understand</p>



<a name="489396519"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489396519" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489396519">(Dec 17 2024 at 03:23)</a>:</h4>
<p>Thank you :)</p>



<a name="489396684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489396684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489396684">(Dec 17 2024 at 03:24)</a>:</h4>
<p>So could I say (as a midwit as noted above) that this is a SSA representation that's meant to be a level higher than say LLVMIR because it can assume a lot of Roc's language semantics?</p>



<a name="489396812"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489396812" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489396812">(Dec 17 2024 at 03:25)</a>:</h4>
<p>But still low-level enough that we can use those semantics to drive efficient optimization passes before codegen?</p>



<a name="489396904"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489396904" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489396904">(Dec 17 2024 at 03:26)</a>:</h4>
<p>Yes, that is the primary purpose</p>



<a name="489396941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489396941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489396941">(Dec 17 2024 at 03:26)</a>:</h4>
<p>Ok, I passed my comprehension test.  I'm going to bed now :-)</p>



<a name="489396991"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489396991" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489396991">(Dec 17 2024 at 03:27)</a>:</h4>
<p>I'll be following the (assumed) implementation of this, as I am very interested in learning a lot in this area</p>



<a name="489624433"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489624433" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489624433">(Dec 18 2024 at 05:50)</a>:</h4>
<p>A few thoughts on the ROAR document:</p>
<ul>
<li>+1 on abstract registers. Unless the stack+register allocation model should be consistent between all targets (which is maybe reasonable), I think it is wise to try to avoid modeling finite registers or the stack.</li>
<li>I would suggest removing the null register. My impression is that this will not make it easier to operate over the IR, unless nodes that write to the null register are strictly typed - in which case, it's equivalent to not typing the null register at all. This is based on experience of writing IRs for languages to translation to C/Asm (C-&gt;asm translation is fairly trivial besides regalloc). One way model this without null registers is have <code>type Stmt { Load (Register, Expr), Store (Register, Expr), Ret, ...}</code> and <code>type Expr { Add (Register, Register), Sub (Register, Register), ... }</code></li>
<li>Whenever possible I would suggest favoring convenience to translation of machine code over convenience for optimizations. I don't think the dev backend should be for producing good machine code - it should be for producing machine code quickly in dev builds. High-level optimizations should happen earlier in the compilation pipeline, and low-level optimizations (e.g. elision) are best served by LLVM or another general-purpose toolkit that has already solved this problem. For example, in the proposal, I would remove all variants of <code>jmp</code> other than <code>jmp</code> itself, and model conditional jumps via branches to basic blocks. Reducing the number of nodes in the IR makes it easier to implement a backend, which I think is the best cost function for the IR.</li>
<li>I would suggest taking a look at the Mono IR and figuring out where the delta between that today and what the dev backends need to lower is, and what subset is best served by covering in ROAR. In my head, the biggest common threads are (1) lowering low-levels and (2) lowering ref-counting and equality operations - I would optimize the ROAR instruction set for those.</li>
</ul>



<a name="489748348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489748348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489748348">(Dec 18 2024 at 12:37)</a>:</h4>
<p>I personally think the null register is quite important. It allows statements to be consistent internally as one structure, rather than having expressions which can be statements, which would significantly complicate the process of obtaining modified registers. In addition, sometimes one wants to have expressions which don’t write to anything, for example on x64 ‘cmp’ vs ‘sub’, where the only difference is whether they write to something or just set flags. In addition, the null register wouldn’t be that hard to implement, and in case this wasent clear the null register can’t be read, it just serves as a “trash” register</p>



<a name="489750408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489750408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489750408">(Dec 18 2024 at 12:49)</a>:</h4>
<p>Also the purpose of this is to be stored in a flat array, which wouldn’t allow for nested expressions</p>



<a name="489750951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489750951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489750951">(Dec 18 2024 at 12:51)</a>:</h4>
<p>(Note, refer back to the first message in this channel)</p>



<a name="489751100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/489751100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#489751100">(Dec 18 2024 at 12:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/395097-compiler-development/topic/Dev.20Backend.20IR/near/419345319">said</a>:</p>
<blockquote>
<p>This is a pretty open thought, but I am questioning if we should change the Dev backend to have an ir that can be stored in a flat array (rather than a tree structure/not existing), that is essentially a portable assembly (one op per function in the <a href="https://github.com/roc-lang/roc/blob/fc6b519b5948023981ac5751d2f6ee48bcef2316/crates/compiler/gen_dev/src/generic64/mod.rs#L153-L742">current Assembler trait</a>).</p>
<p>So it would kinda be akin to llvm ir, but just what we need to support the dev backend. It would also just be for defining within a single procedure and any jmp type instructions would just use a integer as the target that is which other instruction in the array to jump to.</p>
<hr>
<p>The main gain of doing this is for future minor optimizations that we want to run on the ir. The big one being register allocation. With the current IR, register allocation, and lifetimes in general, are very much not a clean problem. Mono is a tree. It also is not nearly as fine grain as individual assembly instructions. So it is very hard to have any idea how many registers will be needed for a specific mono ir node.</p>
<p>I think that we should have a very fast pass that runs over mono and blits out a flat array of assembly like instructions. (essentially will be equivalent to the current dev backend but less complex due to having infinite registers for example).</p>
<p>Then we would run register allocation on the flat array (lots of good algorithms with linear time exist for this). Given the assembly ir won't perfectly match to assembly instructions, we will have a backend dependent function that will label exactly how many temporary registers an instruction will need. That is all the information we should need to deal with register allocations.</p>
<p>Once that works, we can consider other minor but fast optimizations:</p>
<ul>
<li>grouping instructions for final output</li>
<li>intentionally reusing source and dest reg to avoid extra data movement instructions</li>
<li>freeing up the base pointer by calculating all offsets with the stack pointer</li>
<li>storing some aggregate values in registers if available instead of on the stack</li>
<li>maybe some minor and quick rewrites.</li>
</ul>
<p>Especially given we generate at the procedure level, it should be possible to run this part of the dev backend in parallel. Only merging the final generated assembly into an output object file.</p>
<p>I think this will help clean up some of the complexities of the dev backend related to where data is stored and how it is loaded. It should help separate that  work cleanly from the rest of the ir selection at a minimum. It also gives us some opportunities for minor but important optimization passes over dev backend ir.</p>
<hr>
<p>What are people's thoughts on this? I would guess <span class="user-mention silent" data-user-id="281543">Folkert de Vries</span> and <span class="user-mention silent" data-user-id="281383">Richard Feldman</span> would have the most input.</p>
</blockquote>



<a name="490220738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490220738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490220738">(Dec 20 2024 at 19:43)</a>:</h4>
<p>Also, just making sure of something: ROAR would require reimplementating the Backend trait, but not the Assembler and CallConv trait (as the backend trait takes in mono as input)</p>



<a name="490224544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490224544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490224544">(Dec 20 2024 at 20:15)</a>:</h4>
<p>Yeah, might even end up replacing the backend trait with just a raw method to go from mono to roar and a separate method that directly calls out to the assembler and call conv traits</p>



<a name="490225755"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490225755" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490225755">(Dec 20 2024 at 20:25)</a>:</h4>
<p>also was just thinking, it might be useful to have a concept of "true global variables" in ROAR. While struct register persist, they require refrences being passed around, and what I'm thinking of would just be accessed with it's symbol. This wouldn't be prefered (ie, local vars would still be in abstract registers) but i think might make it a lot more clean</p>



<a name="490232515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490232515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490232515">(Dec 20 2024 at 21:25)</a>:</h4>
<p>oh also if no one has anymore comments on this, ill probably start working on it tommorow</p>



<a name="490233875"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490233875" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490233875">(Dec 20 2024 at 21:36)</a>:</h4>
<blockquote>
<p>While struct register persist, they require refrences being passed around, and what I'm thinking of would just be accessed with it's symbol.</p>
</blockquote>
<p>I'm not sure I fully follow what you are suggesting here</p>



<a name="490234075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490234075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490234075">(Dec 20 2024 at 21:38)</a>:</h4>
<p>basically having things like struct registers, but instead of symbols being dynamically generated their symbols persist from mono</p>



<a name="490234480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490234480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490234480">(Dec 20 2024 at 21:42)</a>:</h4>
<p>I think most of the symbols in mono are locals. There are true globals. For those, we will need some solution. The final output is a chunk of data and a relocation to load that data locally in a function.</p>



<a name="490234964"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490234964" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490234964">(Dec 20 2024 at 21:47)</a>:</h4>
<p>Also, my only main comment on the proposal is that I would try to stay very close to the assembler trait to start with (in terms of which operations to support). For example, it looks like we currently only need a <code>jmp</code> and <code>jne</code> instruction. Clearly more optimizations are possible and in some cases other jump instructions might map better, but I think it will make the transition smoothest if we start as close as possible. Then incrementally make things more powerful.</p>



<a name="490236946"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490236946" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490236946">(Dec 20 2024 at 22:04)</a>:</h4>
<p>Oh and instead of using things like u32 directly, wrap them in nominal types to avoid using an index as a register or a float register as an int register etc</p>



<a name="490236984"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490236984" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490236984">(Dec 20 2024 at 22:05)</a>:</h4>
<p>I think that was already the plan, just explicitly clarifying</p>



<a name="490302341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490302341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490302341">(Dec 21 2024 at 14:20)</a>:</h4>
<p>also just so yall can comment if you like, i made a draft pr at <a href="https://github.com/roc-lang/roc/issues/7397">#7397</a></p>



<a name="490305385"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490305385" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490305385">(Dec 21 2024 at 15:02)</a>:</h4>
<p>first piece of ROAR (handcoded into rust), only the printing is done</p>
<div class="codehilite"><pre><span></span><code>[%32] {
    %78 &lt;- addu %73 %32
    _ &lt;- subs %73 %32
}
</code></pre></div>
<p>also i do plan to make the code not break every single style guideline possible</p>



<a name="490314680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490314680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490314680">(Dec 21 2024 at 17:16)</a>:</h4>
<p>Left a handful of comments</p>



<a name="490317661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490317661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490317661">(Dec 21 2024 at 18:02)</a>:</h4>
<p>ok, yeah i wasn't thinking that much about the 128 bit types, those might be a small problem</p>



<a name="490317683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490317683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490317683">(Dec 21 2024 at 18:03)</a>:</h4>
<p>actually having the abstract registers be sized might not be that bad of an idea</p>



<a name="490317810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490317810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490317810">(Dec 21 2024 at 18:05)</a>:</h4>
<p>also maybe seperating structure refrences from regular registers</p>



<a name="490318532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490318532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490318532">(Dec 21 2024 at 18:17)</a>:</h4>
<p>I think it should be fine to see 128 bit values as a structured registers containing two 64bit registers</p>



<a name="490318574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490318574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490318574">(Dec 21 2024 at 18:18)</a>:</h4>
<p>That is how operations function on them anyways</p>



<a name="490318589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490318589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490318589">(Dec 21 2024 at 18:18)</a>:</h4>
<p>okay</p>



<a name="490318594"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490318594" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490318594">(Dec 21 2024 at 18:18)</a>:</h4>
<p>Mostly called them out to make sure they are being thought of</p>



<a name="490404845"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490404845" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490404845">(Dec 22 2024 at 17:22)</a>:</h4>
<p>Relating to your comment <a href="https://github.com/roc-lang/roc/pull/7397#discussion_r1894657437">here</a>, what do you think should be the max size per instruction?</p>



<a name="490407955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490407955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490407955">(Dec 22 2024 at 18:08)</a>:</h4>
<p>I would hope it can fit into 4 u64s, but that may not be realistic.</p>
<p>1 for op code and any sort of metadata<br>
1 for output register<br>
2 for input registers</p>
<p>If an op might need more than 2 input registers. The input u64s would be instead a pointer and length to a sideband array of extra inputs.</p>



<a name="490416089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490416089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490416089">(Dec 22 2024 at 20:23)</a>:</h4>
<p>i dont it will be naccasary to have them actually modeled as inputs, as they should be consant, and therefore are not a part of the internal logic</p>



<a name="490417809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490417809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490417809">(Dec 22 2024 at 20:50)</a>:</h4>
<p>also just realized it was never discussed if function pointers should be included or not</p>



<a name="490419187"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490419187" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490419187">(Dec 22 2024 at 21:13)</a>:</h4>
<p>I think a function pointer can be treated the same as an int constant with a special op to create it.</p>



<a name="490419214"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490419214" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490419214">(Dec 22 2024 at 21:14)</a>:</h4>
<p>ok!</p>



<a name="490432862"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490432862" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490432862">(Dec 23 2024 at 00:56)</a>:</h4>
<p>why does roc use bump allocation? It does seem to speed it up, but it makes the code much less clean (same thing with layout interning)</p>



<a name="490433123"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490433123" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490433123">(Dec 23 2024 at 01:00)</a>:</h4>
<p>Cause we want a really fast compiler. That is also why it is written in rust</p>



<a name="490433154"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490433154" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490433154">(Dec 23 2024 at 01:00)</a>:</h4>
<p>Obviously there is still large room for improvement, but we care a lot about compile time.</p>



<a name="490433163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490433163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490433163">(Dec 23 2024 at 01:00)</a>:</h4>
<p>fair enough</p>



<a name="490800882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490800882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490800882">(Dec 25 2024 at 18:54)</a>:</h4>
<p>Also, I won’t be able to work on this for a couple days</p>



<a name="490800895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490800895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490800895">(Dec 25 2024 at 18:54)</a>:</h4>
<p>On a related note, anyone know of any cheap, small, low-middle end pc’s?</p>



<a name="490800992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490800992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490800992">(Dec 25 2024 at 18:56)</a>:</h4>
<p>(I somehow managed to break my laptops keyboard by cleaning it… so now the whole thing is crippled)</p>



<a name="490892719"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/490892719" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#490892719">(Dec 26 2024 at 16:08)</a>:</h4>
<p>update on this, the classic strategy of doing nothing about it has worked, and now my keyboard is working again <span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span></p>



<a name="494579874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494579874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494579874">(Jan 18 2025 at 23:15)</a>:</h4>
<p>Hey everyone, sorry about the slow progress, it’s just that school takes up a lot of my time, and in particular recently I’ve just been doing way too much stuff, hopefully however I’ll be able to do more work on ROAR this week (and after that) :)</p>



<a name="494579949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494579949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494579949">(Jan 18 2025 at 23:16)</a>:</h4>
<p>It's alg, we're all volunteers here juggling life things. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="494667262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494667262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494667262">(Jan 19 2025 at 18:54)</a>:</h4>
<div class="codehilite"><pre><span></span><code>error[E0515]: cannot return value referencing local variable `env`
   --&gt; crates/compiler/build/src/program.rs:589:5
    |
577 |           roc_gen_dev::build_module(&amp;env, &amp;mut interns, &amp;mut layout_interner, target, procedures);
    |                                     ---- `env` is borrowed here
...
589 | /     (
590 | |         CodeObject::Vector(module_out),
591 | |         CodeGenTiming {
592 | |             generate_final_ir,
...   |
600 | |         },
601 | |     )
    | |_____^ returns a value referencing data owned by the current function

error[E0515]: cannot return value referencing local variable `layout_interner`
   --&gt; crates/compiler/build/src/program.rs:589:5
    |
577 |           roc_gen_dev::build_module(&amp;env, &amp;mut interns, &amp;mut layout_interner, target, procedures);
    |                                                         -------------------- `layout_interner` is borrowed here
...
589 | /     (
590 | |         CodeObject::Vector(module_out),
591 | |         CodeGenTiming {
592 | |             generate_final_ir,
...   |
600 | |         },
601 | |     )
    | |_____^ returns a value referencing data owned by the current function

error[E0515]: cannot return value referencing local variable `interns`
   --&gt; crates/compiler/build/src/program.rs:589:5
    |
577 |           roc_gen_dev::build_module(&amp;env, &amp;mut interns, &amp;mut layout_interner, target, procedures);
    |                                           ------------ `interns` is borrowed here
...
589 | /     (
590 | |         CodeObject::Vector(module_out),
591 | |         CodeGenTiming {
592 | |             generate_final_ir,
...   |
600 | |         },
601 | |     )
    | |_____^ returns a value referencing data owned by the current function

error[E0505]: cannot move out of `interns` because it is borrowed
   --&gt; crates/compiler/build/src/program.rs:597:13
    |
549 |   fn gen_from_mono_module_dev_assembly&lt;&#39;a&gt;(
    |                                        -- lifetime `&#39;a` defined here
...
562 |           mut interns,
    |           ----------- binding `interns` declared here
...
577 |           roc_gen_dev::build_module(&amp;env, &amp;mut interns, &amp;mut layout_interner, target, procedures);
    |                                           ------------ borrow of `interns` occurs here
...
589 | /     (
590 | |         CodeObject::Vector(module_out),
591 | |         CodeGenTiming {
592 | |             generate_final_ir,
...   |
597 | |             interns,
    | |             ^^^^^^^ move out of `interns` occurs here
...   |
600 | |         },
601 | |     )
    | |_____- returning this value requires that `interns` is borrowed for `&#39;a`

error[E0505]: cannot move out of `layout_interner` because it is borrowed
   --&gt; crates/compiler/build/src/program.rs:598:13
    |
549 |   fn gen_from_mono_module_dev_assembly&lt;&#39;a&gt;(
    |                                        -- lifetime `&#39;a` defined here
...
564 |           mut layout_interner,
    |           ------------------- binding `layout_interner` declared here
...
577 |           roc_gen_dev::build_module(&amp;env, &amp;mut interns, &amp;mut layout_interner, target, procedures);
    |                                                         -------------------- borrow of `layout_interner` occurs here
...
589 | /     (
590 | |         CodeObject::Vector(module_out),
591 | |         CodeGenTiming {
592 | |             generate_final_ir,
...   |
598 | |             layout_interner,
    | |             ^^^^^^^^^^^^^^^ move out of `layout_interner` occurs here
599 | |             expectations: loaded.expectations,
600 | |         },
601 | |     )
    | |_____- returning this value requires that `layout_interner` is borrowed for `&#39;a`

Some errors have detailed explanations: E0505, E0515.
For more information about an error, try `rustc --explain E0505`.
</code></pre></div>
<p>anyone know how to fix this? (full state is here <a href="https://github.com/wizard7377/roc/tree/roar">https://github.com/wizard7377/roc/tree/roar</a>)</p>



<a name="494667397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494667397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494667397">(Jan 19 2025 at 18:55)</a>:</h4>
<p>(note the change in this signature <a href="https://github.com/wizard7377/roc/blob/d4de3b1545fcfd3bbb4c6ccc0ee7b918c663208d/crates/compiler/gen_dev/src/object_builder.rs#L49">https://github.com/wizard7377/roc/blob/d4de3b1545fcfd3bbb4c6ccc0ee7b918c663208d/crates/compiler/gen_dev/src/object_builder.rs#L49</a>)</p>



<a name="494816213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494816213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494816213">(Jan 20 2025 at 13:52)</a>:</h4>
<p>anyone can help (rust should definitly have something to bypass the borrow check in development...)</p>



<a name="494827203"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494827203" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494827203">(Jan 20 2025 at 14:39)</a>:</h4>
<p>I can look when I'm done with <a href="https://github.com/roc-lang/roc/issues/7530">#7530</a></p>



<a name="494827403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494827403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494827403">(Jan 20 2025 at 14:40)</a>:</h4>
<p>thank you! <br>
(this has been driving me insane)</p>



<a name="494851071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494851071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494851071">(Jan 20 2025 at 16:22)</a>:</h4>
<p><span class="user-mention" data-user-id="782426">@Wizard ish</span> using the latest roar branch commit I currently only get a mismatched types error at crates/compiler/build/src/program.rs:456:17. That's with <code>cargo build --release</code>. How can I produce your borrow checker errors?</p>



<a name="494851423"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494851423" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494851423">(Jan 20 2025 at 16:24)</a>:</h4>
<p>run with <code>-F use_roar</code></p>



<a name="494851512"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494851512" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494851512">(Jan 20 2025 at 16:25)</a>:</h4>
<p>(the flag is temporary and will be replaced with a sensible build system later)</p>



<a name="494852278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494852278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494852278">(Jan 20 2025 at 16:29)</a>:</h4>
<p>also if it's helpful this is the mess that i use to compile it <code>clear &amp;&amp; RUSTFLAGS="-Awarnings" cargo run -F use_roar -- --dev ../tests/fizzbuzz.roc </code></p>



<a name="494875013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494875013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494875013">(Jan 20 2025 at 17:41)</a>:</h4>
<p>sorry it's really a mess</p>



<a name="494888533"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494888533" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494888533">(Jan 20 2025 at 18:20)</a>:</h4>
<p>No problem, we all have to learn by doing :)</p>



<a name="494889649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494889649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494889649">(Jan 20 2025 at 18:27)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">build_module_help</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">r</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">r</span><span class="w"> </span><span class="nc">Env</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">interns</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">r</span><span class="w"> </span><span class="nc">mut</span><span class="w"> </span><span class="n">Interns</span><span class="p">,</span>
<span class="w">    </span><span class="n">layout_interner</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">r</span><span class="w"> </span><span class="nc">mut</span><span class="w"> </span><span class="n">STLayoutInterner</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">target</span><span class="p">:</span><span class="w"> </span><span class="nc">Target</span><span class="p">,</span>
<span class="w">    </span><span class="n">procedures</span><span class="p">:</span><span class="w"> </span><span class="nc">MutMap</span><span class="o">&lt;</span><span class="p">(</span><span class="n">symbol</span><span class="p">::</span><span class="n">Symbol</span><span class="p">,</span><span class="w"> </span><span class="n">ProcLayout</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">),</span><span class="w"> </span><span class="n">Proc</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Object</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>Why are <code>'a</code> and <code>'r</code> linked? I don't think that is correct. <code>'r : 'a</code>. Not that I 100% know what that syntax means.</p>
<p>Anyway, I think you should be able to fully remove <code>'r</code>?</p>



<a name="494890071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494890071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494890071">(Jan 20 2025 at 18:30)</a>:</h4>
<p>yeah it was that i changed it bc in the Converter it (the borrow checker) required <code>'b</code> to outlive <code>'a</code> (the Converter's <code>'a</code>), which then required <code>'r</code> to outlive <code>'a</code> (of the above funciton)</p>



<a name="494890302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494890302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494890302">(Jan 20 2025 at 18:32)</a>:</h4>
<p>Something is definitely wrong is <code>'r</code> needs to outlive <code>'a</code>. <code>'a</code> is essentially a global lifetime. <code>'r</code> is temporary for the current function. So the code creating that requirement must be wrong</p>



<a name="494890628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494890628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494890628">(Jan 20 2025 at 18:34)</a>:</h4>
<p>Oh wait <span aria-label="skull" class="emoji emoji-1f480" role="img" title="skull">:skull:</span> i somehow forgot the most crucial point, without that requirement, i get this error</p>
<div class="codehilite"><pre><span></span><code>error: lifetime may not live long enough
   --&gt; crates/compiler/gen_dev/src/roar/convert.rs:240:22
    |
162 | ...c, &#39;a: &#39;c, &#39;b: &#39;c&gt; Converter&lt;&#39;a, &#39;b&gt;
    |       --      -- lifetime `&#39;b` defined here
    |       |
    |       lifetime `&#39;a` defined here
...
240 | ...          &amp;mut sym_map.insert(*sym, (Output::Register(new_reg.clone()), repr, form...
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ argument requires that `&#39;b` must outlive `&#39;a`
    |
    = help: consider adding the following bound: `&#39;b: &#39;a`

error: could not compile `roc_gen_dev` (lib) due to 1 previous error
</code></pre></div>



<a name="494890692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494890692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494890692">(Jan 20 2025 at 18:34)</a>:</h4>
<p>(all the random lifetimes are me just trying to fix this)</p>



<a name="494891303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494891303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494891303">(Jan 20 2025 at 18:38)</a>:</h4>
<p>I think you have a loop that is angering rust. env -&gt; arena -&gt; converter -&gt; back to env.</p>



<a name="494891374"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494891374" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494891374">(Jan 20 2025 at 18:39)</a>:</h4>
<p>That in general won't work</p>



<a name="494891408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494891408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494891408">(Jan 20 2025 at 18:39)</a>:</h4>
<p>likely converter shouldn't be allocated in the env at all</p>



<a name="494891420"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494891420" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494891420">(Jan 20 2025 at 18:39)</a>:</h4>
<p>Should just be passed around on the stack</p>



<a name="494891464"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494891464" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494891464">(Jan 20 2025 at 18:40)</a>:</h4>
<p>Then just <code>converter -&gt; env, interner, etc</code></p>



<a name="494891504"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494891504" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494891504">(Jan 20 2025 at 18:40)</a>:</h4>
<p>no loop</p>



<a name="494891654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494891654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494891654">(Jan 20 2025 at 18:41)</a>:</h4>
<p>ok</p>



<a name="494892209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494892209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494892209">(Jan 20 2025 at 18:45)</a>:</h4>
<p>Wait so onlyy the converter object or also everything created by it</p>



<a name="494892378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494892378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494892378">(Jan 20 2025 at 18:46)</a>:</h4>
<p>I assume most things can be created in the env. The problem with converter is specifically the loop.</p>



<a name="494892407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494892407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494892407">(Jan 20 2025 at 18:46)</a>:</h4>
<p>so just converter</p>



<a name="494892672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494892672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494892672">(Jan 20 2025 at 18:48)</a>:</h4>
<p>And I think you will be a able to remove a bunch of type variable like <code>&amp;'c mut self</code> will just be <code>&amp;mut self</code></p>



<a name="494892916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494892916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494892916">(Jan 20 2025 at 18:49)</a>:</h4>
<p>And I think <code>proc_queue: RefCell&lt;Vec&lt;'b, (symbol::Symbol, &amp;'b ir::ProcLayout&lt;'b&gt;, &amp;'b ir::Proc&lt;'b&gt;)&gt;&gt;,</code> Likely should be all <code>'a</code>? Cause those are all allocated in the env. So they have a lifetime same as the bump in the env.</p>



<a name="494893177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494893177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494893177">(Jan 20 2025 at 18:51)</a>:</h4>
<p>yeah this is a little bit of a mess...</p>



<a name="494893274"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/494893274" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#494893274">(Jan 20 2025 at 18:51)</a>:</h4>
<p>Part of learning rust in a codebase that uses arenas (thus tons of extra lifetimes to manage)</p>



<a name="496018929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/496018929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#496018929">(Jan 27 2025 at 01:12)</a>:</h4>
<p>the good news is it's fixed :)<br>
the bad news is that it was fixed by using incredibly bad practice to get around the borrow checker...</p>



<a name="497276792"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497276792" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497276792">(Feb 02 2025 at 17:55)</a>:</h4>
<p>Hey, given the plans to completly rewrite the compiler, does it make sense to continue this project in Rust (as opposed to switching it to Zig)?</p>



<a name="497277352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497277352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497277352">(Feb 02 2025 at 18:02)</a>:</h4>
<p>I'd say switch to zig!</p>



<a name="497277398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497277398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497277398">(Feb 02 2025 at 18:02)</a>:</h4>
<p>okay :)</p>



<a name="497277564"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497277564" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497277564">(Feb 02 2025 at 18:05)</a>:</h4>
<p>As a note, some of the rewrite plans may make this project obsolete. As part of the switch, we want to try using an interpreter instead of the dev backend.</p>



<a name="497277659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497277659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497277659">(Feb 02 2025 at 18:06)</a>:</h4>
<p>We need an interpreter anyway for constant folding and some other work and we think that an interpreter should be capable of running fast enough that it makes the dev backend a lot less useful as a proposition</p>



<a name="497277683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497277683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497277683">(Feb 02 2025 at 18:06)</a>:</h4>
<p>So we want to start by trying to only have the interpreter and skipping the dev backend.</p>



<a name="497277749"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497277749" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497277749">(Feb 02 2025 at 18:07)</a>:</h4>
<p>hmmm okay, although still might be useful as a sort of in between for the interpreter and the new mono ir</p>



<a name="497278243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497278243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497278243">(Feb 02 2025 at 18:14)</a>:</h4>
<p>Interpreter is planned to run higher up the stack (it may still want a specific IR, but haven't thought through the details yet).</p>



<a name="497278293"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497278293" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497278293">(Feb 02 2025 at 18:15)</a>:</h4>
<p>Totally will be lots of things to help with and IR design work, just might not map straight to roar.</p>



<a name="497278978"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497278978" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497278978">(Feb 02 2025 at 18:24)</a>:</h4>
<p>I'm really sorry about this and any time that was wasted. The big zig rewrite seems like the best time to try something like only using an interpreter? Assuming only using an interpreter dosen't work out or if we end up wanting a dev backend again, this work would revive, but at least for now, the hope is to avoid any dev backends if possible.</p>



<a name="497280897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497280897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wizard ish <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497280897">(Feb 02 2025 at 18:50)</a>:</h4>
<p>Nah it’s all cool, plus I’ve been putting off learning zig so this’ll be fun</p>



<a name="497280930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Dev%20Backend%20IR/near/497280930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Dev.20Backend.20IR.html#497280930">(Feb 02 2025 at 18:50)</a>:</h4>
<p>I appreciate your having an awesome attitude about it! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
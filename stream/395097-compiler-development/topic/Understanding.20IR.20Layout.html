<html>
<head><meta charset="utf-8"><title>Understanding IR Layout · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html">Understanding IR Layout</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="495316954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495316954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495316954">(Jan 22 2025 at 15:58)</a>:</h4>
<p>I'm trying to understand this Debug output for a Layout:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Function</span><span class="p">(</span>
<span class="w">    </span><span class="p">[],</span>
<span class="w">    </span><span class="n">LambdaSet</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">set</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">(</span><span class="w"> </span><span class="n">Test</span><span class="p">.</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">InLayout</span><span class="p">(</span><span class="n">STR</span><span class="p">)]),</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="n">ret</span><span class="p">:</span><span class="w"> </span><span class="nc">InLayout</span><span class="p">(</span><span class="n">STR</span><span class="p">),</span>
<span class="w">        </span><span class="n">representation</span><span class="p">:</span><span class="w"> </span><span class="nc">InLayout</span><span class="p">(</span><span class="n">STR</span><span class="p">),</span>
<span class="w">        </span><span class="n">full_layout</span><span class="p">:</span><span class="w"> </span><span class="nc">InLayout</span><span class="p">(</span>
<span class="w">            </span><span class="mi">22</span><span class="p">,</span>
<span class="w">        </span><span class="p">),</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">InLayout</span><span class="p">(</span><span class="n">STR</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></div>
<p>I took this as a function layout with no args, returning a string.  But the lambda set has a function that has a string argument.  Am I understanding this wrong (without reading all 10k+ lines of mono/src/ir.rs)?</p>



<a name="495317148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495317148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495317148">(Jan 22 2025 at 15:59)</a>:</h4>
<p>This is a RawFunctionLayout to be clear</p>



<a name="495317388"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495317388" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495317388">(Jan 22 2025 at 16:00)</a>:</h4>
<p>The source of the entire program is:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="w">            </span><span class="nv">app</span><span class="w"> </span><span class="s">"test"</span><span class="w"> </span><span class="nv">provides</span><span class="w"> </span><span class="p">[</span><span class="nv">main</span><span class="p">]</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="s">"./platform"</span>

<span class="w">            </span><span class="nv">main</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span>
<span class="w">            </span><span class="nv">main</span><span class="w"> </span><span class="nf">=</span>
<span class="w">                </span><span class="nv">g</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span>
<span class="w">                </span><span class="nv">g</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="s">"hello world"</span>

<span class="w">                </span><span class="nv">get_g</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
<span class="w">                </span><span class="nv">get_g</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">||</span><span class="w"> </span><span class="nv">g</span>

<span class="w">                </span><span class="nv">get_g</span><span class="p">()</span>
</code></pre></div>
<p>And this layout is for <code>get_g</code>, a zero-arg closure defined inside main</p>



<a name="495317795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495317795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495317795">(Jan 22 2025 at 16:02)</a>:</h4>
<p>My assumption is that the layout should make sure to include the argument for the string which is captured - assuming that since there is a single capture we don't wrap it in a struct/tuple/record.</p>



<a name="495318791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495318791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495318791">(Jan 22 2025 at 16:06)</a>:</h4>
<p>It feels like for zero arg closure, we have to ensure that the arg layout of the function _always_ includes the capture value (here a string, but often a struct)</p>



<a name="495319001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319001">(Jan 22 2025 at 16:07)</a>:</h4>
<p>The lambda set lists all function values that could be referenced by a value of a function type. In your case, <code>get_g</code> is a function with a lambda set that is a singleton that contains just <code>get_g</code>. The lambda set also encodes any captures of the function, and <code>get_g</code> captures <code>g</code>  so you can think of it as <code>[get_g Str]</code> if it were a tag. </p>
<div class="codehilite"><pre><span></span><code>Function(
    [],
    LambdaSet {
        set: [
            ( Test.2, [InLayout(STR)]), # get_g, with capture Str
        ],
        args: [],
        ret: InLayout(STR), # return type
        representation: InLayout(STR), # representation of the lambda set at runtime - the get_g function and captures (unwrapped to just Str because there is only one function and one capture)
        full_layout: InLayout(
            22,
        ),
    },
    InLayout(STR), # return type
)
</code></pre></div>



<a name="495319014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319014">(Jan 22 2025 at 16:07)</a>:</h4>
<p>I know that there is like 3 maybe 4 people on the core team that deeply understand this code, but I'd like to get to the point where I could be a +1 to that tally in six months - year</p>



<a name="495319100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319100">(Jan 22 2025 at 16:08)</a>:</h4>
<p>Interesting</p>



<a name="495319275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319275">(Jan 22 2025 at 16:08)</a>:</h4>
<p>What you are saying makes sense, but with this mono layout, you get this in gen_llvm:</p>
<div class="codehilite"><pre><span></span><code>Error in alias analysis: error in module ModName(&quot;UserApp&quot;), function definition FuncName(&quot;\x10\x00\x00\x00\x00\x00\x00\x00l\x08\x12\xd4g1\x9bl&quot;), definition of value binding ValueId(4): expected type &#39;((heap_cell,),)&#39;, found type &#39;()&#39;
</code></pre></div>



<a name="495319362"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319362" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319362">(Jan 22 2025 at 16:09)</a>:</h4>
<p>And here is the morphic program:</p>
<div class="codehilite"><pre><span></span><code>program {
  mod &quot;UserApp&quot; {
    const &quot;\x06\x00\x00\x00\x0e\x00\x00\x00&quot;: type_1 = {
      let val_0 = new_heap_cell ();
      let val_1 = make_tuple (val_0);
      val_1
    } where {
      type type_0 = heap_cell;
      type type_1 = (type_0);
    }

    const &quot;THIS IS A STATIC LIST&quot;: type_4 = {
      let val_0 = new_heap_cell ();
      let val_1 = empty_bag&lt;type_0&gt; ();
      let val_2 = make_tuple (val_0, val_1);
      val_2
    } where {
      type type_0 = ();
      type type_1 = ();
      type type_2 = heap_cell;
      type type_3 = bag&lt;type_1&gt;;
      type type_4 = (type_2, type_3);
    }

    fn &quot;&quot; (val_0: type_3) -&gt; type_3 {
      let val_6 = choice {
        case {
          let val_1 = make_tuple ();
          let val_2 = make_union&lt;type_1, type_0&gt; 0 (val_1);
          let val_3 = unwrap_union 1 (val_2);
          let val_4 = call[&quot;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&quot;] &quot;UserApp&quot;::&quot;\x10\x00\x00\x00\x00\x00\x00\x00l\x08\x12\xd4g1\x9bl&quot; (val_3);
          let val_5 = unknown_with&lt;type_2&gt; (val_4);
          val_5
        },
      } ();
      val_6
    } where {
      type type_0 = ();
      type type_1 = ();
      type type_2 = ();
      type type_3 = ();
    }

    fn &quot;\x10\x00\x00\x00\x00\x00\x00\x00l\x08\x12\xd4g1\x9bl&quot; (val_0: type_0) -&gt; type_2 {
      let val_1 = const_ref &quot;UserApp&quot;::&quot;\x06\x00\x00\x00\x0e\x00\x00\x00&quot; ();
      let val_2 = recursive_touch (val_1);
      let val_3 = make_tuple ();
      let val_4 = call[&quot;\x01\x00\x00\x00&quot;] &quot;UserApp&quot;::&quot;\x10\x00\x00\x00\x02\x00\x00\x00\xac]\xc2\&#39;o)\xaf]&quot; (val_3);
      val_4
    } where {
      type type_0 = ();
      type type_1 = heap_cell;
      type type_2 = (type_1);
    }

    fn &quot;\x10\x00\x00\x00\x02\x00\x00\x00\xac]\xc2\&#39;o)\xaf]&quot; (val_0: type_2) -&gt; type_4 {
      let val_1 = get_tuple_field 0 (val_0);
      val_1
    } where {
      type type_0 = heap_cell;
      type type_1 = (type_0);
      type type_2 = (type_1);
      type type_3 = heap_cell;
      type type_4 = (type_3);
    }
  }

  entry_point &quot;&quot; = &quot;UserApp&quot;::&quot;&quot;;
}
</code></pre></div>



<a name="495319566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319566">(Jan 22 2025 at 16:10)</a>:</h4>
<p>And If I'm reading things even <em>close</em> to right, <code>\x10\x00\x00\x00\x02\x00\x00\x00\xac]\xc2\'o)\xaf]</code> is the function that corresponds to <code>get_g</code> in the source</p>



<a name="495319632"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319632" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319632">(Jan 22 2025 at 16:10)</a>:</h4>
<p>right so that's a bug in the morphic construction</p>



<a name="495319737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319737">(Jan 22 2025 at 16:10)</a>:</h4>
<div class="codehilite"><pre><span></span><code>      let val_3 = make_tuple ();
      let val_4 = call[&quot;\x01\x00\x00\x00&quot;] &quot;UserApp&quot;::&quot;\x10\x00\x00\x00\x02\x00\x00\x00\xac]\xc2\&#39;o)\xaf]&quot; (val_3);
</code></pre></div>
<p>this isn't passing the capture</p>



<a name="495319853"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319853" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319853">(Jan 22 2025 at 16:11)</a>:</h4>
<p><code>(val_3)</code> isn't the capture?</p>



<a name="495319891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495319891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495319891">(Jan 22 2025 at 16:11)</a>:</h4>
<p>Oh, it's a plain tuple!</p>



<a name="495320058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495320058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495320058">(Jan 22 2025 at 16:12)</a>:</h4>
<p>Should it be <code>make_tuple (val_2)</code>?</p>



<a name="495320215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495320215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495320215">(Jan 22 2025 at 16:13)</a>:</h4>
<p>I see that it's expecting val_0 to be a (heap_cell), and then it unwraps the first element.</p>



<a name="495320398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495320398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495320398">(Jan 22 2025 at 16:13)</a>:</h4>
<p>I need to read up on what a "recursive_touch" is.  I'm assuming it's a ref increment recursively?</p>



<a name="495320577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495320577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495320577">(Jan 22 2025 at 16:14)</a>:</h4>
<p>I really have to go to work, but I'll check back in at lunch</p>



<a name="495320702"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495320702" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495320702">(Jan 22 2025 at 16:15)</a>:</h4>
<p>Thanks for your help Ayaz, it makes me feel better know that it is on the morphic generation side, and not all the way back in mono still</p>



<a name="495328212"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495328212" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495328212">(Jan 22 2025 at 16:50)</a>:</h4>
<p><span class="user-mention" data-user-id="461444">@Sam Mohr</span> fyi</p>



<a name="495329593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495329593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495329593">(Jan 22 2025 at 16:58)</a>:</h4>
<p>i would check that the mono IR looks right first</p>



<a name="495329677"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495329677" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495329677">(Jan 22 2025 at 16:58)</a>:</h4>
<p>you can also run with <code>ROC_CHECK_MONO_IR=1</code> which runs a type checker over the IR and spits out if there is a bug</p>



<a name="495329716"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495329716" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495329716">(Jan 22 2025 at 16:58)</a>:</h4>
<p>Sweet. Thanks</p>



<a name="495329861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495329861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495329861">(Jan 22 2025 at 16:59)</a>:</h4>
<p>It’d be cool if we had an omnibus flag for debugging all things in a phase</p>



<a name="495377236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495377236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495377236">(Jan 22 2025 at 21:30)</a>:</h4>
<p>Here's the mono::Proc:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Proc</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nc">LambdaName</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="err">`</span><span class="p">#</span><span class="n">UserApp</span><span class="p">.</span><span class="n">get_g</span><span class="err">`</span><span class="p">,</span>
<span class="w">                    </span><span class="n">niche</span><span class="p">:</span><span class="w"> </span><span class="nc">Niche</span><span class="p">(</span>
<span class="w">                        </span><span class="n">Captures</span><span class="p">(</span>
<span class="w">                            </span><span class="p">[</span>
<span class="w">                                </span><span class="n">InLayout</span><span class="p">(</span><span class="n">STR</span><span class="p">),</span>
<span class="w">                            </span><span class="p">],</span>
<span class="w">                        </span><span class="p">),</span>
<span class="w">                    </span><span class="p">),</span>
<span class="w">                </span><span class="p">},</span>
<span class="w">                </span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="p">(</span>
<span class="w">                        </span><span class="n">InLayout</span><span class="p">(</span>
<span class="w">                            </span><span class="mi">22</span><span class="p">,</span>
<span class="w">                        </span><span class="p">),</span>
<span class="w">                        </span><span class="err">`</span><span class="p">#</span><span class="n">UserApp</span><span class="p">.</span><span class="n">g</span><span class="err">`</span><span class="p">,</span>
<span class="w">                    </span><span class="p">),</span>
<span class="w">                </span><span class="p">],</span>
<span class="w">                </span><span class="n">body</span><span class="p">:</span><span class="w"> </span><span class="nc">Ret</span><span class="p">(</span>
<span class="w">                    </span><span class="err">`</span><span class="p">#</span><span class="n">UserApp</span><span class="p">.</span><span class="n">g</span><span class="err">`</span><span class="p">,</span>
<span class="w">                </span><span class="p">),</span>
<span class="w">                </span><span class="n">closure_data_layout</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span>
<span class="w">                    </span><span class="n">InLayout</span><span class="p">(</span>
<span class="w">                        </span><span class="mi">22</span><span class="p">,</span>
<span class="w">                    </span><span class="p">),</span>
<span class="w">                </span><span class="p">),</span>
<span class="w">                </span><span class="n">ret_layout</span><span class="p">:</span><span class="w"> </span><span class="nc">InLayout</span><span class="p">(</span><span class="n">STR</span><span class="p">),</span>
<span class="w">                </span><span class="n">is_self_recursive</span><span class="p">:</span><span class="w"> </span><span class="nc">NotSelfRecursive</span><span class="p">,</span>
<span class="w">                </span><span class="n">is_erased</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>



<a name="495377367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495377367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495377367">(Jan 22 2025 at 21:31)</a>:</h4>
<p>Running with <code>ROC_CHECK_MONO_IR=1</code> didn't output anything different</p>



<a name="495377484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495377484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495377484">(Jan 22 2025 at 21:32)</a>:</h4>
<p>This looks like get_g should take an arg.  The closure_data_layout looks curious to me though</p>



<a name="495377626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495377626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495377626">(Jan 22 2025 at 21:32)</a>:</h4>
<p>But it does line up with what I see in the morphic program...</p>



<a name="495377707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495377707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495377707">(Jan 22 2025 at 21:33)</a>:</h4>
<p>So it looks like part of building the IR thinks it will take a string arg for the captures, but something else is creating a new layout for it</p>



<a name="495378204"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495378204" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495378204">(Jan 22 2025 at 21:37)</a>:</h4>
<p><code>get_g</code> should take the lambdaset as its only arg</p>



<a name="495378262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495378262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495378262">(Jan 22 2025 at 21:37)</a>:</h4>
<p>Which it looks like is the case</p>



<a name="495378364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495378364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495378364">(Jan 22 2025 at 21:38)</a>:</h4>
<p>I presume that <code>InLayout</code> is a single-variant union with the payload of a STR</p>



<a name="495378404"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495378404" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495378404">(Jan 22 2025 at 21:38)</a>:</h4>
<p>Which is why it would not say <code>InLayout(STR)</code> but instead <code>InLayout(22)</code></p>



<a name="495378829"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495378829" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495378829">(Jan 22 2025 at 21:42)</a>:</h4>
<p>I wish it were easy to figure out what that layout is</p>



<a name="495379597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495379597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495379597">(Jan 22 2025 at 21:47)</a>:</h4>
<p>After changing visibility of a method and wrapping a call it in unsafe:</p>
<div class="codehilite"><pre><span></span><code>Layout 22: Layout {
    repr: Direct(
        LambdaSet(
            LambdaSet {
                set: [
                    ( Test.2, [InLayout(STR)]),
                ],
                args: [],
                ret: InLayout(STR),
                representation: InLayout(STR),
                full_layout: InLayout(
                    22,
                ),
            },
        ),
    ),
    semantic: None,
}
</code></pre></div>



<a name="495384895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495384895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495384895">(Jan 22 2025 at 22:26)</a>:</h4>
<p>Hmmm...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">::</span><span class="n">Call</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">call_type</span><span class="p">:</span><span class="w"> </span><span class="nc">CallType</span><span class="p">::</span><span class="n">ByName</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nc">proc_name</span><span class="p">,</span>
<span class="w">                        </span><span class="n">ret_layout</span><span class="p">:</span><span class="w"> </span><span class="nc">function_layout</span><span class="p">.</span><span class="n">result</span><span class="p">,</span>
<span class="w">                        </span><span class="n">arg_layouts</span><span class="p">:</span><span class="w"> </span><span class="nc">function_layout</span><span class="p">.</span><span class="n">arguments</span><span class="p">,</span>
<span class="w">                        </span><span class="n">specialization_id</span><span class="p">:</span><span class="w"> </span><span class="nc">env</span><span class="p">.</span><span class="n">next_call_specialization_id</span><span class="p">(),</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="n">arguments</span><span class="p">:</span><span class="w"> </span><span class="nc">field_symbols</span><span class="p">,</span>
<span class="w">                </span><span class="p">};</span>
</code></pre></div>



<a name="495384988"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495384988" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495384988">(Jan 22 2025 at 22:27)</a>:</h4>
<p>Do we really need to explicitly add the closure struct to <code>field_symbols</code>?</p>



<a name="495385620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495385620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495385620">(Jan 22 2025 at 22:32)</a>:</h4>
<p>But <code>call_specialized_proc</code> thinks we should do this because it thinks we are getting <code>get_g</code> here <em>because</em> the field_symbols is empty</p>



<a name="495392202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495392202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495392202">(Jan 22 2025 at 23:30)</a>:</h4>
<p>We figure this one out</p>



<a name="495392208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495392208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495392208">(Jan 22 2025 at 23:30)</a>:</h4>
<p>Now....</p>



<a name="495392227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495392227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495392227">(Jan 22 2025 at 23:30)</a>:</h4>
<p>Can someone ELI5 borrow signatures to me?</p>



<a name="495392285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495392285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495392285">(Jan 22 2025 at 23:31)</a>:</h4>
<p>This panics on not having a borrow signature:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="w">            </span><span class="n">app</span><span class="w"> </span><span class="s2">"test"</span><span class="w"> </span><span class="n">provides</span><span class="w"> </span><span class="o">[</span><span class="n">main</span><span class="o">]</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="s2">"./platform"</span>

<span class="w">            </span><span class="no">Effect</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">a</span>

<span class="w">            </span><span class="n">succeed</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">Effect</span><span class="w"> </span><span class="n">a</span>
<span class="w">            </span><span class="n">succeed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="vi">@Effect</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>

<span class="w">            </span><span class="n">run_effect</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">Effect</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">a</span>
<span class="w">            </span><span class="n">run_effect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="vi">@Effect</span><span class="p">(</span><span class="n">thunk</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">thunk</span><span class="p">()</span>

<span class="w">            </span><span class="n">foo</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">Effect</span><span class="w"> </span><span class="no">F64</span><span class="w"> </span><span class="c1"># &lt;----- This has no borrow signature</span>
<span class="w">            </span><span class="n">foo</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">succeed</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="mi">23</span><span class="p">)</span>

<span class="w">            </span><span class="n">main</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">F64</span>
<span class="w">            </span><span class="n">main</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">run_effect</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
</code></pre></div>



<a name="495392575"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495392575" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495392575">(Jan 22 2025 at 23:33)</a>:</h4>
<p>I have the high level understanding that this is how we determine something about Refcounting around a closure?</p>



<a name="495393638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495393638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495393638">(Jan 22 2025 at 23:44)</a>:</h4>
<p>Basically it is away to avoid tons of extra refcount increments and decrements especially in hot loops.</p>



<a name="495393834"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495393834" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495393834">(Jan 22 2025 at 23:45)</a>:</h4>
<p>All it does is track whether a list is passed into a function that requests ownership (anything that wants to update the list in place). If so, it is owned. If not, it is borrowed. If it is borrowed, we can pass it all the way down the call stack without ever incrementing or decrementing the refcount. Just keeping the single refcount at the top of the stack</p>



<a name="495393852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495393852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495393852">(Jan 22 2025 at 23:45)</a>:</h4>
<p>I think all non-list types are always owned/ignored currently</p>



<a name="495393968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495393968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495393968">(Jan 22 2025 at 23:47)</a>:</h4>
<p>So basically a dirty bit per arg to note if it is used in a way that requires ownership</p>



<a name="495394024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394024">(Jan 22 2025 at 23:47)</a>:</h4>
<p>I think we would eventually want to expand this to be tracked for things that wrap lists rather than just raw lists (for example dict). Not sure the state of borrow signatures and tags.</p>



<a name="495394176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394176">(Jan 22 2025 at 23:48)</a>:</h4>
<p>I’m getting the same panic in an example that is not wrapped in a opaque type</p>



<a name="495394243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394243">(Jan 22 2025 at 23:49)</a>:</h4>
<p>Interesting. Would have guess the opaque type was the cause</p>



<a name="495394313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394313">(Jan 22 2025 at 23:50)</a>:</h4>
<p>Might just be related to storing a closure. That might disconnect the borrow signature from the original function?</p>



<a name="495394652"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394652" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394652">(Jan 22 2025 at 23:53)</a>:</h4>
<p>I have trouble finding where these signatures are inserted in the first place</p>



<a name="495394662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394662">(Jan 22 2025 at 23:53)</a>:</h4>
<p>I see only one place</p>



<a name="495394676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394676">(Jan 22 2025 at 23:53)</a>:</h4>
<p>Which is infer_borrow_signatures</p>



<a name="495394686"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394686" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394686">(Jan 22 2025 at 23:53)</a>:</h4>
<p>But I haven’t gone deep on it</p>



<a name="495394789"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394789" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394789">(Jan 22 2025 at 23:54)</a>:</h4>
<p>We do it per proc name and layout</p>



<a name="495394830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495394830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495394830">(Jan 22 2025 at 23:55)</a>:</h4>
<p>Each name+function layout pair is assumed to have been specialized at this point</p>



<a name="495395147"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495395147" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495395147">(Jan 22 2025 at 23:58)</a>:</h4>
<p>Yeah I think it is, but for some reason its borrow signature just isn’t there</p>



<a name="495395174"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495395174" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495395174">(Jan 22 2025 at 23:58)</a>:</h4>
<p>I’ll figure it out tonight or in the morning. Thanks for the context</p>



<a name="495395177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495395177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495395177">(Jan 22 2025 at 23:58)</a>:</h4>
<p>That's why I think the function didn't get multiple specializations</p>



<a name="495395233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Understanding%20IR%20Layout/near/495395233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Understanding.20IR.20Layout.html#495395233">(Jan 22 2025 at 23:59)</a>:</h4>
<p>We assume there's one for each specialized return type on line 352 of <a href="http://borrow.rs">borrow.rs</a></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
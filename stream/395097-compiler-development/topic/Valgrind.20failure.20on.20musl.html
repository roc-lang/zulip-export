<html>
<head><meta charset="utf-8"><title>Valgrind failure on musl · compiler development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html">Valgrind failure on musl</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="571955548"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/571955548" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#571955548">(Feb 04 2026 at 16:23)</a>:</h4>
<p>I need a hand figuring out this valgrind failure:<br>
<a href="https://github.com/roc-lang/roc/actions/runs/21645888338/job/62398322030?pr=9083">https://github.com/roc-lang/roc/actions/runs/21645888338/job/62398322030?pr=9083</a></p>
<p>The claim from claude is that this is related to a DWARF generation bug that loses the function names.<br>
I thought this was related to or triggered by compiling the new glue platform as part of the build. If I understand right, that should be impossible now on the branch, because now it 'should' be using the committed glue host lib for musl. I may be misunderstanding the Zig build system, and I feel like I definitely don't understand the problem causing the '???' function names in valgrind.</p>



<a name="571962132"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/571962132" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#571962132">(Feb 04 2026 at 16:51)</a>:</h4>
<p>I have also had issues with <code>???</code> in the past but I forgot how I solved that. Are you able to reproduce the valgrind error locally?</p>



<a name="571968423"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/571968423" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#571968423">(Feb 04 2026 at 17:19)</a>:</h4>
<p>It looks like it's reproducing locally with: <br>
<code>zig build -Doptimize=ReleaseFast -Dcpu=x86_64_v3 -Dtarget=x86_64-linux-musl</code><br>
<code>./ci/custom_valgrind.sh ./zig-out/bin/roc --no-cache test/str/app.roc</code></p>



<a name="571971248"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/571971248" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#571971248">(Feb 04 2026 at 17:32)</a>:</h4>
<p>Great, I recommend starting with giving that to Claude and see if it can fix it.</p>



<a name="572014513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572014513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572014513">(Feb 04 2026 at 21:36)</a>:</h4>
<p>I can continue doing that <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>. It was pointing to a Zig bug and suggesting broader valgrind suppression, so that made me think I should ask here. I don't feel qualified to say whether the stuff it wants to add to the valgrind suppression is reasonable or not.</p>



<a name="572312741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572312741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572312741">(Feb 06 2026 at 07:57)</a>:</h4>
<p>Can you paste Claude's justification for the suppression here?</p>



<a name="572429876"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572429876" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572429876">(Feb 06 2026 at 17:22)</a>:</h4>
<p>So, initially it was suggesting object-based suppression since there was no debug info to allow function-based. That seems completely unworkable, as far as actually using valgrind to catch errors goes. It seems like it's just a way to subvert CI.</p>
<p>It seems like part of the issue may be the specific build config used by the snap version of valgrind. Switching off of the snap build of valgrind to either the older version from apt or a built-from-source version allows using function-based suppression for the original musl alloc thing I was running into, which claude claims (and I believe) is a false positive.</p>
<p>On a recent, default-configuration build of valgrind, <a href="https://github.com/roc-lang/roc/actions/runs/21753513461/job/62757950165?pr=9083">used in the most recent build</a> on the <code>giesch/roc-glue</code> branch, we're getting a new valgrind failure that seems like an actual error (not related to basic musl behavior).</p>
<p>The context I'm hoping to gain by asking here is how to dig into valgrind errors in the compiler, or the history of working around this apparent Zig DWARF bug. It would also help to know if ubuntu 22 or the specific version of valgrind is important. I don't get these valgrind errors on my local ubuntu-24-based OS with a recent default valgrind. I'm fuzzy on the details, but it seems possible that there's some kind of mismatch between the recent valgrind and the older kernel version.</p>



<a name="572439525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572439525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572439525">(Feb 06 2026 at 18:16)</a>:</h4>
<blockquote>
<p>On a recent, default-configuration build of valgrind</p>
</blockquote>
<p>With "default-configuration" do you mean the way we currently use it <a href="https://github.com/roc-lang/roc/blob/3d0fdde9ae6ffb5ef411f8c8c2fc2cdce22a74fe/.github/workflows/ci_zig.yml#L209">on CI on the main branch</a>?</p>



<a name="572440228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572440228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572440228">(Feb 06 2026 at 18:21)</a>:</h4>
<blockquote>
<p>I don't get these valgrind errors on my local ubuntu-24-based OS with a recent default valgrind.</p>
</blockquote>
<p>You do need the same flags to build Roc as on CI, just <code>zig build roc</code> can yield different results. And, yes ubuntu and valgrind version matter. Anyway, I will try to reproduce this on my machine, and take a look</p>



<a name="572444593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572444593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572444593">(Feb 06 2026 at 18:49)</a>:</h4>
<p>Hmm <code>./zig-out/bin/snapshot --debug --verbose</code> is not giving me any output...</p>



<a name="572445370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572445370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572445370">(Feb 06 2026 at 18:54)</a>:</h4>
<p>I do get all debug output on macos using your branch, very strange <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="572445617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572445617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572445617">(Feb 06 2026 at 18:55)</a>:</h4>
<p>I need to go, I can pick up on Monday. Are you getting any output with <code>./zig-out/bin/snapshot --debug --verbose</code>? If not, it makes sense that you are not seeing the valgrind errors.</p>



<a name="572445626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572445626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572445626">(Feb 06 2026 at 18:55)</a>:</h4>
<p>By 'default configuration', I mean passing no arguments to 'configure' when building valgrind from source (which that particular commit did in CI). The build (of valgrind) used by snap has some level of customization. The lack of debug info seems unique to ubuntu 22 as far as I can tell.</p>



<a name="572448613"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572448613" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572448613">(Feb 06 2026 at 19:14)</a>:</h4>
<p>It sounds like maybe we need to set <code>omit_frame_pointer = false</code> in the <code>ReleaseFast</code> build used by valgrind in CI? But that would also be kind of cheating CI, maybe.</p>



<a name="572453093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572453093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dan G Knutson <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572453093">(Feb 06 2026 at 19:47)</a>:</h4>
<p>It looks like this is the configuration used by snap, but I'm not sure what commit would end up being used by ubuntu 22:<br>
<a href="https://github.com/ralight/valgrind-snap/blob/main/snap/snapcraft.yaml">https://github.com/ralight/valgrind-snap/blob/main/snap/snapcraft.yaml</a></p>



<a name="572737809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572737809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572737809">(Feb 09 2026 at 10:42)</a>:</h4>
<p><del>Building with <code>zig build snapshot -Doptimize=ReleaseFast -Dfuzz -Dsystem-afl=false -Dcpu=x86_64_v3 -Dtarget=x86_64-linux-musl</code> results in no output when running <code>./zig-out/bin/snapshot --debug --verbose</code>. But I do see the expected output when building with <code>zig build snapshot</code>. So valgrind is not the issue here, I'm looking into a fix...</del></p>



<a name="572738886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572738886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572738886">(Feb 09 2026 at 10:46)</a>:</h4>
<p><del>This also happens on the main branch.</del></p>



<a name="572740444"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572740444" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572740444">(Feb 09 2026 at 10:53)</a>:</h4>
<p>Ok that was just: "Zig's std.log.debug is <strong>compiled out</strong> in ReleaseFast builds." <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="572794333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572794333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572794333">(Feb 09 2026 at 14:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="430894">Dan G Knutson</span> <a href="#narrow/channel/395097-compiler-development/topic/Valgrind.20failure.20on.20musl/near/571968423">said</a>:</p>
<blockquote>
<p>It looks like it's reproducing locally with: <br>
<code>zig build -Doptimize=ReleaseFast -Dcpu=x86_64_v3 -Dtarget=x86_64-linux-musl</code><br>
<code>./ci/custom_valgrind.sh ./zig-out/bin/roc --no-cache test/str/app.roc</code></p>
</blockquote>
<p>I was able to reproduce this on the main branch as well.</p>



<a name="572798476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572798476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572798476">(Feb 09 2026 at 14:41)</a>:</h4>
<p>Adding <code>-Dstrip=false</code> during the build gives a clean trace.</p>



<a name="572800670"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572800670" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572800670">(Feb 09 2026 at 14:48)</a>:</h4>
<p>That specific valgrind error was indeed a false positive, pushing a fix soon...</p>



<a name="572827762"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572827762" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572827762">(Feb 09 2026 at 16:24)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/9167">PR#9167</a></p>



<a name="572858399"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572858399" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572858399">(Feb 09 2026 at 18:33)</a>:</h4>
<p>Fixed in <a href="https://github.com/roc-lang/roc/pull/9169">PR#9169</a> <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span></p>



<a name="572858766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Valgrind%20failure%20on%20musl/near/572858766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Valgrind.20failure.20on.20musl.html#572858766">(Feb 09 2026 at 18:35)</a>:</h4>
<p>I'll merge the fix into your branch tomorrow <span class="user-mention" data-user-id="430894">@Dan G Knutson</span>, I want to get <a href="https://github.com/roc-lang/roc/issues/9167">#9167</a> on main first so I don't make a mess of the branches.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
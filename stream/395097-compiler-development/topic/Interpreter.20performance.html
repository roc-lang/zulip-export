<html>
<head><meta charset="utf-8"><title>Interpreter performance ¬∑ compiler development ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/index.html">compiler development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html">Interpreter performance</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="566759993"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566759993" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566759993">(Jan 07 2026 at 15:30)</a>:</h4>
<p>The interpreter is still quite slow. Is it worth it to optimize it, or will it be replaced by a dev backend soon anyway?</p>
<p>One concrete slowdown I see is that the compiler get's significantly slower with loops over 2000. </p>
<div class="codehilite"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst&quot; }

main! = |_| {
    _foo = 0.to(&lt;n&gt;)
    Ok({})
}
</code></pre></div>
<p>depending on n, I have the following time output (Windows x86 machine):</p>
<table>
<thead>
<tr>
<th>n</th>
<th>time (s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>500</td>
<td>0.283</td>
</tr>
<tr>
<td>1000</td>
<td>0.323</td>
</tr>
<tr>
<td>2000</td>
<td>0.47</td>
</tr>
<tr>
<td>3000</td>
<td>1.282</td>
</tr>
<tr>
<td>4000</td>
<td>2.331</td>
</tr>
<tr>
<td>8000</td>
<td>9.773</td>
</tr>
</tbody>
</table>
<p>I did not investigate. Is it worth doing so? And performance of the interpreter in general?</p>



<a name="566763881"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566763881" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566763881">(Jan 07 2026 at 15:47)</a>:</h4>
<p>I think we want to keep the interpreter for constant folding. I would also like to keep it to keep our options open. It could be difficult to resurrect compared to just keeping it running. Definitely for this simple case where perf is bad, optimization seems worth it.</p>



<a name="566764475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566764475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566764475">(Jan 07 2026 at 15:50)</a>:</h4>
<p>I recommend checking out <a href="https://github.com/roc-lang/roc/blob/main/src/PROFILING/README.md">https://github.com/roc-lang/roc/blob/main/src/PROFILING/README.md</a></p>



<a name="566783206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566783206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Romain Lepert <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566783206">(Jan 07 2026 at 17:15)</a>:</h4>
<p>My understanding was that the interpreter would eventually become fast enough to become the de-facto dev workflow. Other languages have shown that interpreters can be fast enough for development workflows.  Also, another advantage is that it is much more amenable to a debugger. </p>
<p>I recall the main benefit of dev backends was to shorten the startup time albeit zero optimization. I believe the interpreter should startup even faster and can eventually be JITTED for optimization on hot paths.</p>
<p>So what why are the dev backends being resurrected ? I am not sure... I suppose there is a Claude translation just in case so that they are not lost when the rust backend gets yanked.</p>
<p>(i am just an outsider, so take my words with a huge grain of salt)</p>



<a name="566790187"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566790187" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566790187">(Jan 07 2026 at 17:51)</a>:</h4>
<p>Related conversation: <a class="message-link" href="/#narrow/channel/358903-advent-of-code/topic/2025.20Day.203/near/563700834">#advent of code &gt; 2025 Day 3 @ üí¨</a></p>



<a name="566822603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566822603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566822603">(Jan 07 2026 at 21:02)</a>:</h4>
<p>I dont think there is any short or medium term plans to not have an interpreter. </p>
<p>Longer term the benefits of reviving the dev backends is that we can simplify a lot of things at runtime I think.</p>
<p>Before we started the rewrite the hypothesis was that an interpreter would be relatively easy to build... in practice we have learnt that there is a lot of type wrangling that has to happen at runtime - to support polymorphism. So instead of using the same Mono build pipeline at compile time we have just as much work to do at runtime.</p>
<p>In a compiled world with dev backends and if the interpeter didnt exist, we could eliminate all of this additional complexity and just have a single pipeline.</p>



<a name="566872486"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566872486" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566872486">(Jan 08 2026 at 06:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="559412">Fabian Schmalzried</span> <a href="#narrow/channel/395097-compiler-development/topic/Interpreter.20performance/near/566759993">said</a>:</p>
<blockquote>
<p>The interpreter is still quite slow. Is it worth it to optimize it, or will it be replaced by a dev backend soon anyway?</p>
<p>One concrete slowdown I see is that the compiler get's significantly slower with loops over 2000. </p>
<div class="codehilite"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst&quot; }

main! = |_| {
    _foo = 0.to(&lt;n&gt;)
    Ok({})
}
</code></pre></div>
<p>depending on n, I have the following time output (Windows x86 machine):</p>
<table>
<thead>
<tr>
<th>n</th>
<th>time (s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>500</td>
<td>0.283</td>
</tr>
<tr>
<td>1000</td>
<td>0.323</td>
</tr>
<tr>
<td>2000</td>
<td>0.47</td>
</tr>
<tr>
<td>3000</td>
<td>1.282</td>
</tr>
<tr>
<td>4000</td>
<td>2.331</td>
</tr>
<tr>
<td>8000</td>
<td>9.773</td>
</tr>
</tbody>
</table>
<p>I did not investigate. Is it worth doing so? And performance of the interpreter in general?</p>
</blockquote>
<p>I definitely think it's worth investigating any performance issues. It shouldn't be really bad or anything. This could just be some obvious bug in our implementation. </p>
<p>We had something similar recently where Brendan sped us up like 6000x with a single line change or something like that.</p>



<a name="566872571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566872571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566872571">(Jan 08 2026 at 06:11)</a>:</h4>
<p>The focus so far has been on correctness, so there is a lot of low hanging fruit in the performance department.</p>



<a name="566893294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566893294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566893294">(Jan 08 2026 at 08:58)</a>:</h4>
<p>Alright, thanks for all the input. I will try to see what I can do to improve the performance.</p>



<a name="566933550"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566933550" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566933550">(Jan 08 2026 at 12:45)</a>:</h4>
<p>So one culprit for the slowdown is <code>types.snapshot()</code> in <code>unifyWithConf(..)</code>, which is used for restoring, when unification fails: <a href="https://github.com/roc-lang/roc/blob/eb54be9749da1966bcf0ce01a87b3f96a3919e87/src/check/unify.zig#L183">https://github.com/roc-lang/roc/blob/eb54be9749da1966bcf0ce01a87b3f96a3919e87/src/check/unify.zig#L183</a></p>
<p>Removing this turns the ~9.7s to ~1.2s. </p>
<p>Of cause just removing this does break something, at least the tests are now broken.<br>
Anyone has some insights on how to handle this? I see those options:</p>
<ol>
<li>Maybe rollback is not necessary at all? Unification failed, so why bother rolling back? (No idea on the actual implications on this, probably something to do with "inform don't block"?)</li>
<li>Add some more efficient rollback mechanism (maybe more like database transactions)</li>
<li>Figure out why this simple code is unifying so much and reduce that (probably worth it anyway)</li>
</ol>



<a name="566936861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566936861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566936861">(Jan 08 2026 at 13:04)</a>:</h4>
<p>Helpful commit message here: <a href="https://github.com/roc-lang/roc/commit/8b97a2d03e1c485507d599a18262f75c11f074d8">https://github.com/roc-lang/roc/commit/8b97a2d03e1c485507d599a18262f75c11f074d8</a></p>



<a name="566936880"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566936880" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566936880">(Jan 08 2026 at 13:04)</a>:</h4>
<p>What do you think <span class="user-mention" data-user-id="281383">@Richard Feldman</span>?</p>



<a name="566936928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566936928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566936928">(Jan 08 2026 at 13:05)</a>:</h4>
<p>I'm leaning towards "1. Figure out why this simple code is unifying so much and reduce that (probably worth it anyway)"</p>



<a name="566944521"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566944521" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566944521">(Jan 08 2026 at 13:42)</a>:</h4>
<p>agree, in this code sample the value of n should not increase the number of times the type checker unifies.</p>
<p>also note, there are compile time types (in Check) and runtime types (in the interpreter), so it‚Äôs also worth figuring out which part of the codebase the unifies are coming from</p>



<a name="566945992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566945992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566945992">(Jan 08 2026 at 13:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/channel/395097-compiler-development/topic/Interpreter.20performance/near/566936861">said</a>:</p>
<blockquote>
<p>Helpful commit message here: <a href="https://github.com/roc-lang/roc/commit/8b97a2d03e1c485507d599a18262f75c11f074d8">https://github.com/roc-lang/roc/commit/8b97a2d03e1c485507d599a18262f75c11f074d8</a></p>
</blockquote>
<p>reading through that commit message, the optimistic snapshot seem wasteful if the unification does not error.</p>
<p>i wonder if there‚Äôs some other way to solve this, like i wonder if we change unification order so we could avoid the ‚Äúinner unify success pollutes outer error message‚Äù thing</p>



<a name="566949989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566949989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566949989">(Jan 08 2026 at 14:07)</a>:</h4>
<p>I think this strategy goes all the way back to elm's type checker...the only idea I have for how to improve it is basically a "double or nothing" - we optimistically assume there will be no type mismatches in the entire module, and then if we're wrong, we start over and redo type checking for the entire module with snapshotting</p>



<a name="566950268"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566950268" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566950268">(Jan 08 2026 at 14:08)</a>:</h4>
<p>the problem is just that unification has to use in-place mutation for performance, and it just unavoidably loses information</p>



<a name="566963295"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566963295" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566963295">(Jan 08 2026 at 15:00)</a>:</h4>
<p>i‚Äôll need to double check, but i think in elm, because it uses continuation style passing, type descriptors are not updated until after all recursive unification has succeeded (or not). maybe we could capture ‚Äúpending‚Äù merges during unification, then only actually upadate the types store after we know if it was a success or failure</p>
<p>but, that aside, it would surprise me if the value of an argument caused the type checking phase to call unify many more times, so i suspect its a unify call in the interpreter</p>



<a name="566968605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566968605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566968605">(Jan 08 2026 at 15:21)</a>:</h4>
<p><span class="user-mention silent" data-user-id="341568">Jared Ramirez</span> <a href="#narrow/channel/395097-compiler-development/topic/Interpreter.20performance/near/566963295">said</a>:</p>
<blockquote>
<p>but, that aside, it would surprise me if the value of an argument caused the type checking phase to call unify many more times, so i suspect its a unify call in the interpreter</p>
</blockquote>
<p>Yes, here: <a href="https://github.com/roc-lang/roc/blob/eb54be9749da1966bcf0ce01a87b3f96a3919e87/src/eval/interpreter.zig#L17716">https://github.com/roc-lang/roc/blob/eb54be9749da1966bcf0ce01a87b3f96a3919e87/src/eval/interpreter.zig#L17716</a><br>
I think this runs for every <code>.append</code> in the <code>range_to</code> builtin.<br>
Any idea how to best improve this? <br>
I also don't quite understand why a copy of the arg is necessary at this point.</p>



<a name="566976988"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566976988" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566976988">(Jan 08 2026 at 15:57)</a>:</h4>
<p>Can the unification in the interpreter fail? Type checking should prevent this, right? So we can just have a unification function just for the interpreter that does not create this snapshot?</p>



<a name="566977928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/566977928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#566977928">(Jan 08 2026 at 16:01)</a>:</h4>
<p>Would the unification in the interpreter still be required, when we have the <a href="#narrow/channel/316715-contributing/topic/Worklog.20.28Draft.20PRs.20and.20coordination.29/near/564799190">"monomorphized roc code"</a></p>



<a name="567003740"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567003740" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567003740">(Jan 08 2026 at 18:09)</a>:</h4>
<p>Don't we full type check before the interpreter? Can we removing all type checking from the interpreter and just assert types?</p>



<a name="567003941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567003941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567003941">(Jan 08 2026 at 18:10)</a>:</h4>
<p>I don't think we need mono. Anything with static dispatch just needs a virtual table. They literally could store an index to their module and anything with dispatch would just grab that module and run, no type checking</p>



<a name="567004025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567004025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567004025">(Jan 08 2026 at 18:11)</a>:</h4>
<p>I obviously don't know the pipeline. But something of this nature should be doable and huge for perf.</p>



<a name="567074023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567074023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567074023">(Jan 09 2026 at 05:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="559412">Fabian Schmalzried</span> <a href="#narrow/channel/395097-compiler-development/topic/Interpreter.20performance/near/566976988">said</a>:</p>
<blockquote>
<p>Can the unification in the interpreter fail? Type checking should prevent this, right? So we can just have a unification function just for the interpreter that does not create this snapshot?</p>
</blockquote>
<p>that's true, it should never fail in the interpreter!</p>



<a name="567074278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567074278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567074278">(Jan 09 2026 at 05:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/395097-compiler-development/topic/Interpreter.20performance/near/567003941">said</a>:</p>
<blockquote>
<p>I don't think we need mono. Anything with static dispatch just needs a virtual table. They literally could store an index to their module and anything with dispatch would just grab that module and run, no type checking</p>
</blockquote>
<p>If I remember right, I think the reason we have to unify in the interpreter is because of layout:</p>
<ul>
<li>the host abi expects the same layout from data it receives from the interpreter as data it receives from optimized llvm builds</li>
<li>computing that layout requires monomorphic types</li>
<li>the process of making polymorphic types monomorphic is by going through and unifying the polymorphic types with monomorphic ones, and that's true whether it's happening at compile time or at runtime</li>
</ul>



<a name="567131242"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567131242" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567131242">(Jan 09 2026 at 12:28)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/issues/8967">#8967</a> for the example above it's now &gt;10x faster</p>



<a name="567158532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567158532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Fabian Schmalzried <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567158532">(Jan 09 2026 at 14:50)</a>:</h4>
<p>Found something else that I don't know how to fix: <br>
the refcount of the list <code>$answer</code> list in <code>range_to</code> is 2 for all the appends, therefore the list is not mutated inplace. I think it should be just 1? Anyone has any hints on where to look for this unnecessary refcount?</p>



<a name="567165633"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567165633" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567165633">(Jan 09 2026 at 15:21)</a>:</h4>
<p>Ah. Layouts require it. That makes sense. Maybe the interpreter really does need to be after mono then. Not sure.</p>



<a name="567167372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567167372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567167372">(Jan 09 2026 at 15:29)</a>:</h4>
<p>For range_to sounds like we get confused by the mutable variable</p>



<a name="567167469"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567167469" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567167469">(Jan 09 2026 at 15:29)</a>:</h4>
<p>Cause it is referenced after the loop as well. So that is technically an extra refcount</p>



<a name="567167578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567167578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567167578">(Jan 09 2026 at 15:30)</a>:</h4>
<p>But that is only true for non-mutable variables. This mutable variable is actually changing in the loop</p>



<a name="567167694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/395097-compiler%20development/topic/Interpreter%20performance/near/567167694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/395097-compiler-development/topic/Interpreter.20performance.html#567167694">(Jan 09 2026 at 15:30)</a>:</h4>
<p>So sounds like we need special recount exceptions for mutable variables.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Day 7 · advent of code · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/index.html">advent of code</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html">Day 7</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="314433491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314433491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314433491">(Dec 07 2022 at 11:27)</a>:</h4>
<p>Here is my partial <a href="https://github.com/lukewilliamboswell/roc-things/blob/main/aoc-2022/day7.roc">solution for Day 7</a>. I've got to the point where it parses the input, and passes all my tests. I shouldn't have too much trouble implementing the next bit, but I would like to make my. parsing more reliable. At the moment I have to manually append a newline character to the end of the input to make it work properly. I've really had a lot of trouble trying to figure out how to <code>skip</code> and <code>ingore</code> something. Basically I want to consume/chomp a newline character if it's there, but if it's not then be happy. I could write something using <code>buildPrimitiveParser</code> maybe, but I'm not sure how to get it to play nicely with the applicative API. Would really appreciate any assistance here. I'm definitely missing a trick on how <code>const</code> and <code>apply</code> work together here I think.</p>



<a name="314459279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314459279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314459279">(Dec 07 2022 at 13:46)</a>:</h4>
<p>You may consider instead of saying that a line of input is valid if it ends in a newline, that your lines of input are valid if they are separated by newlines. for example: <a href="https://gist.github.com/ayazhafiz/f06a714f77a5736545c3b63fa942edf9#file-parser-roc-L152">https://gist.github.com/ayazhafiz/f06a714f77a5736545c3b63fa942edf9#file-parser-roc-L152</a></p>



<a name="314468336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314468336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Shritesh Bhattarai <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314468336">(Dec 07 2022 at 14:29)</a>:</h4>
<p>Here's my <a href="https://github.com/shritesh/advent/blob/main/2022/07.roc">Day 7</a>. I feel like I should memoize the calculation but computers are fast.</p>



<a name="314788180"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314788180" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314788180">(Dec 08 2022 at 22:57)</a>:</h4>
<p>Here is my <a href="https://github.com/lukewilliamboswell/roc-things/blob/main/aoc-2022/day7.roc">completed Day 7</a>. That was more of a challenge. I had quite a few crashes and things to work around, and then plenty of minor logic bugs along the way. I also refactored along the way to significantly speed up the calculation so now it runs almost instantly. Pretty happy with the parsers and combinators too <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="314793745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314793745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314793745">(Dec 08 2022 at 23:44)</a>:</h4>
<p>I know it's probably not a fair comparison right now and the implementations are very different, but a bit of fun anyway... but I've been comparing the speed of my Day 7 with mates who wrote it in Rust. My Roc implementation is sitting at <em>33.7ms</em>, verse Rust's <em>2.2ms</em> to run the whole puzzle including reading the file so about 15x slower at the moment. I'm pretty impressed with this! I imagine there is a lot of things that can be optimised yet in basic-cli. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="314793944"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314793944" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314793944">(Dec 08 2022 at 23:46)</a>:</h4>
<p>I would love to see some flamegraphs of the 2 apps to know where the time is being spent.</p>



<a name="314794813"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314794813" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314794813">(Dec 08 2022 at 23:55)</a>:</h4>
<blockquote>
<p>My Roc implementation is sitting at 33.7ms, verse Rust's 2.2ms to run the whole puzzle including reading the file so about 15x slower at the moment</p>
</blockquote>
<p>Is this with both compilers optimizing the code?</p>



<a name="314795010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314795010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314795010">(Dec 08 2022 at 23:57)</a>:</h4>
<p>Yes I think so. Its the release version of Rust, and roc then using <code>roc build --optimize</code></p>



<a name="314796074"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314796074" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314796074">(Dec 09 2022 at 00:06)</a>:</h4>
<p>Running it on my linux machine is a little slower</p>
<div class="codehilite"><pre><span></span><code>$ hyperfine --warmup 3 &#39;./app-aoc-2022-day-7&#39;
Benchmark 1: ./app-aoc-2022-day-7
  Time (mean ± σ):      48.3 ms ±   0.2 ms    [User: 47.9 ms, System: 0.4 ms]
</code></pre></div>



<a name="314796100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314796100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314796100">(Dec 09 2022 at 00:06)</a>:</h4>
<p>I'll try and figure out how to get a flame graph</p>



<a name="314797885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314797885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314797885">(Dec 09 2022 at 00:26)</a>:</h4>
<p>You have a ton of allocations. So that probably is the main cost of your code in Roc</p>



<a name="314798662"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314798662" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314798662">(Dec 09 2022 at 00:35)</a>:</h4>
<p>Is that mostly from the parsing logic do you think?</p>



<a name="314798904"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314798904" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314798904">(Dec 09 2022 at 00:38)</a>:</h4>
<p>Not really sure. My gut feeling is that it is related to the dicts of lists of strings, but it could be the parser. Maybe I should compare to a different day that just parses and does simple math</p>



<a name="314799013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799013">(Dec 09 2022 at 00:39)</a>:</h4>
<p>Oh, parser is definitely part of it. <code>List.sublist</code> called by the parser is pretty heavy.</p>



<a name="314799076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799076">(Dec 09 2022 at 00:40)</a>:</h4>
<p>Since we don't have seamless slices yet, all of those are allocations</p>



<a name="314799132"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799132" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799132">(Dec 09 2022 at 00:41)</a>:</h4>
<p><a href="/user_uploads/22008/0MYBuCYwiQ997fefc6bVQB5k/kernal.svg">kernal.svg</a></p>



<a name="314799151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799151">(Dec 09 2022 at 00:41)</a>:</h4>
<p>My first attempt... how can I improve this?</p>



<a name="314799240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799240">(Dec 09 2022 at 00:42)</a>:</h4>
<p>use the legacy linker and maybe an unoptimized build if you want the best flamegraph. Though unoptimized is not necessarily representive of the final graph</p>



<a name="314799260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799260">(Dec 09 2022 at 00:42)</a>:</h4>
<p>I've been thinking the parser could just pass indexes around. Maybe that would be a lot faster?</p>



<a name="314799304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799304">(Dec 09 2022 at 00:43)</a>:</h4>
<p>With seamless slices, it should hopefullly be approximately as fast as passing around indices, but yeah, that would be faster than calling sublist currently.</p>



<a name="314799397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799397">(Dec 09 2022 at 00:44)</a>:</h4>
<p>Also, <code>Dict.insert</code> is using a lot of the time in subfunctions. Not completely sure why. How big are these dictionaries? I think pretty small, so my guess is that the hashing is actually costing a solid amount. but that is just a guess.</p>



<a name="314799409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799409">(Dec 09 2022 at 00:44)</a>:</h4>
<p>Does the legacy linker work on linux atm?</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$ roc build day7.roc --linker legacy

I was expecting this file to exist:

    /home/luke/.cache/roc/packages/github.com/roc-lang/basic-cli/releases/download/0.1.2/3bKbbmgtIfOyC6FviJ9o8F8xqKutmXgjCJx3bMfVTSo/linux-x86_64.o

However, it was not there!

If you have the platform<span class="err">'</span>s <span class="nb">source</span> code locally, you may be able to generate it by re-running this <span class="nb">command</span> with --prebuilt-platform<span class="o">=</span><span class="nb">false</span>
</code></pre></div>



<a name="314799786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799786">(Dec 09 2022 at 00:48)</a>:</h4>
<p>Oh, it doesn't work with the url published platform</p>



<a name="314799837"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799837" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799837">(Dec 09 2022 at 00:49)</a>:</h4>
<p>Optimized flamegraph: <a href="/user_uploads/22008/HvNfejbrqhAMd_ktgRkU6hkj/flamegraph.svg">flamegraph.svg</a></p>



<a name="314799928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314799928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314799928">(Dec 09 2022 at 00:50)</a>:</h4>
<p>Unoptimized flamegraph: <a href="/user_uploads/22008/ufdfo2e5u8141uqgbKmJbOfc/flamegraph.svg">flamegraph.svg</a></p>



<a name="314800173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314800173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314800173">(Dec 09 2022 at 00:52)</a>:</h4>
<p>Allocation count: 44060</p>



<a name="314800193"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314800193" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314800193">(Dec 09 2022 at 00:52)</a>:</h4>
<p>haha...That's crazy.</p>



<a name="314800398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314800398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314800398">(Dec 09 2022 at 00:54)</a>:</h4>
<p>lol, I think I need to figure out how to write Roc without all the allocations. But tbh, I'm not exactly sure where the line is, what makes an allocation and what doesn't? I feel like it is everytime you create a new thing in memory. So if I can change my code to re-use the same structure, i.e. a record that gets passed around then that would reduce the allocations?</p>



<a name="314800437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314800437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314800437">(Dec 09 2022 at 00:55)</a>:</h4>
<p>Though most of the time malloc is giving us the same pointer over an over again. We allocate it and free it and then allocate it again...</p>
<p>The address <code>0x5644723eb9b0</code> got allocated <code>21633</code> times for me. Most of the time just with about 10 to 20 bytes of data.</p>



<a name="314800584"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314800584" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314800584">(Dec 09 2022 at 00:56)</a>:</h4>
<p>given the varying small sizes, I would assume most of the allocations are <code>Str</code> or <code>List U8</code>, but I am not sure...just a guess.</p>



<a name="314800763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314800763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314800763">(Dec 09 2022 at 00:58)</a>:</h4>
<p>I should double check how I wrote dict to make sure it doesn't allocate unnecessarily when taking a key that is on the heap.</p>



<a name="314801429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314801429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314801429">(Dec 09 2022 at 01:05)</a>:</h4>
<p>To clarify <a href="https://github.com/roc-lang/roc/issues/1361">this Issue#1361</a> is what you mean by seamless slices? I guess this feature is still in the works?</p>



<a name="314801598"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314801598" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314801598">(Dec 09 2022 at 01:08)</a>:</h4>
<p>So your breakdown seems to be about:</p>
<p>Just parsing:<br>
12ms<br>
20541 allocations</p>
<p>Building directory list:<br>
22ms<br>
18229 allocations</p>
<p>Rest:<br>
10ms<br>
5290 allocations</p>



<a name="314801688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314801688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314801688">(Dec 09 2022 at 01:08)</a>:</h4>
<p>Yeah, that feature. It is decently well thought through at this point, just someone has to actually implement it and wire it through the compiler.</p>



<a name="314801874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314801874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314801874">(Dec 09 2022 at 01:11)</a>:</h4>
<p>Looks really amazing for parsers! <span aria-label="drooling" class="emoji emoji-1f924" role="img" title="drooling">:drooling:</span></p>



<a name="314802028"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314802028" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314802028">(Dec 09 2022 at 01:12)</a>:</h4>
<p>Now just imagine an essentially zero allocation parser because the lists and strings all are seamless slices and just referencing the original strings/lists. Allocating at most once for each final element going into your datastructure</p>



<a name="314802207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314802207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314802207">(Dec 09 2022 at 01:14)</a>:</h4>
<p>Anyway, i definitely think I need to dig into your build directory listing function and what it calls to figure out if dicts have an issue with cloning keys and what the cost actually is here.</p>



<a name="314802482"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314802482" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314802482">(Dec 09 2022 at 01:17)</a>:</h4>
<p>One immediate thought on general performance, can you reverse your cwd list.? Append to it and drop last. Prepend and drop first are expensive.</p>



<a name="314802491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314802491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314802491">(Dec 09 2022 at 01:18)</a>:</h4>
<p>Probably would be better to just reverse at the very end if needed.</p>



<a name="314803068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314803068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314803068">(Dec 09 2022 at 01:24)</a>:</h4>
<p>Just gave it a shot, made no difference.</p>



<a name="314805642"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314805642" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314805642">(Dec 09 2022 at 01:57)</a>:</h4>
<p>I definitely need to look into dictionary and see what is going on. I think there may be a referencing issue there.</p>
<p>Past that, it should help performance to change the key from <code>List Str</code> to <code>Str</code> for now<br>
Just use a helper like: <code>makeKey = \path -&gt; Str.joinWith path "/"</code></p>



<a name="314806085"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314806085" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314806085">(Dec 09 2022 at 02:01)</a>:</h4>
<p>Oh yeah, almost certainly a referencing bug with dictionary keys that leads to copies. That or a referencing bug with hashing lists of reference counted types that leads to copies. Changing the key type to Str just for  <code>buildDirectoryListing</code> and it's sub functions cuts out ~15000 allocations.</p>



<a name="314806363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314806363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314806363">(Dec 09 2022 at 02:04)</a>:</h4>
<p>Random aside, I have no idea why, but the program as a whole even after reseting all of the code is running about 2x slower for me. My computer must be throttling or doing something weird, but so far I can't figure out what.</p>



<a name="314808972"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314808972" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314808972">(Dec 09 2022 at 02:35)</a>:</h4>
<p>Ok. I think I found the root issue at least for the dictionary part. Small String hashing has terrible performance (it always allocates). All of your strings are small strings. So you have<code>List SmallStr</code>, which is probably the worst case for hashing in the compiler currently. That is why joining the strings is faster. It costs one allocation, but leads to way better hashing.</p>



<a name="314809094"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314809094" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314809094">(Dec 09 2022 at 02:36)</a>:</h4>
<p>I think we may need a special hack for small string hashing if we want good performance here.</p>



<a name="314809413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314809413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314809413">(Dec 09 2022 at 02:40)</a>:</h4>
<p>Anyway new summary: With <code>Str</code> keys to the <code>Dict</code> for the <code>buildDirectoryListing</code> the time of that function goes from 22ms to about 3ms</p>



<a name="314809690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314809690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314809690">(Dec 09 2022 at 02:43)</a>:</h4>
<p>It's currently a <code>List Str</code> what do you mean by <code>Str</code> keys?</p>



<a name="314809937"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314809937" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314809937">(Dec 09 2022 at 02:46)</a>:</h4>
<p><code>newKey = Str.joinWith oldKey "/"</code></p>



<a name="314844660"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314844660" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314844660">(Dec 09 2022 at 08:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/358903-Advent-of-Code/topic/Day.207/near/314800398">said</a>:</p>
<blockquote>
<p>lol, I think I need to figure out how to write Roc without all the allocations. But tbh, I'm not exactly sure where the line is, what makes an allocation and what doesn't? I feel like it is everytime you create a new thing in memory. So if I can change my code to re-use the same structure, i.e. a record that gets passed around then that would reduce the allocations?</p>
</blockquote>
<p>It's whenever you create a new thing <em>whose type has variable size</em><br>
For example every value of <code>U64</code> is always the same size. But different values of <code>List U64</code> could be different sizes. That means <code>U64</code> does not allocate but <code>List U64</code> does.<br>
The only 3 things in Roc that allocate are <code>List</code>, <code>Str</code>, and recursive tag unions (for example tree structures or linked lists).</p>



<a name="314844719"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314844719" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314844719">(Dec 09 2022 at 08:49)</a>:</h4>
<p>Numbers, records, and non-recursive tags don't allocate.</p>



<a name="314846023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314846023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314846023">(Dec 09 2022 at 08:58)</a>:</h4>
<p>The one exception to the rule is that we have a performance trick where we are able to skip allocation for "small" <code>Str</code> (smaller than 3 <code>Nat</code>s). In general this makes things faster, but it means that low-level code in the standard library needs special cases for small strings. And Brendan found out that the hashing code for this case isn't as fast as it could be.</p>



<a name="314991301"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/314991301" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Gabriel Pickl <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#314991301">(Dec 09 2022 at 22:10)</a>:</h4>
<p>think i'll take a break for today since I ran into 3 probable compiler bugs in a row <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="315138634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/315138634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Logan Lowder <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#315138634">(Dec 10 2022 at 23:35)</a>:</h4>
<p>Man that was hard!<br>
Catching up still <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span> <a href="https://github.com/lowderdev/advent-of-code/blob/main/2022/roc/day7/main.roc">day7</a></p>



<a name="315138710"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/315138710" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Logan Lowder <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#315138710">(Dec 10 2022 at 23:36)</a>:</h4>
<p>Had to borrow some of your code <span class="user-mention" data-user-id="515757">@Luke Boswell</span><br>
(gave you a shout out in the comments) <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="315144567"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/358903-advent%20of%20code/topic/Day%207/near/315144567" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/358903-advent-of-code/topic/Day.207.html#315144567">(Dec 11 2022 at 00:57)</a>:</h4>
<p>Thanks, your solution looks nice! <span aria-label="ok" class="emoji emoji-1f44c" role="img" title="ok">:ok:</span></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
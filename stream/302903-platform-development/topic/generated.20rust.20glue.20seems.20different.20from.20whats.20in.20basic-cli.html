<html>
<head><meta charset="utf-8"><title>generated rust glue seems different from whats in basic-cli · platform development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/index.html">platform development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html">generated rust glue seems different from whats in basic-cli</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="408270252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408270252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408270252">(Dec 15 2023 at 23:08)</a>:</h4>
<p>I have a platform I'm trying to setup to make a property based testing framework for roc.</p>
<p>I stubbed out the basics <a href="https://github.com/JRMurr/roc-pbt/tree/e553fab69018a438b41062b28f422de113df2e56">here</a></p>
<p>I would like to write some functions in rust that would be exposed to roc to get random strings, nums, etc. I gathered from reading some of the other platform examples i need to make <code>roc_fx_&lt;func&gt;</code> defs and add them to an <code>Effect.roc</code> file manually.</p>
<p>The issue im running into is any of the custom effects I added seem to cause the roc app to exit when called. If i stick to "pure" roc the app seems to run normally. I also copied some effects from basic cli to see if was how my functions were defined but seems to have the same issue.</p>
<p>I used <code>roc glue &lt;path to rust spec&gt; </code> to generate the glue code but one difference I'm noticing between the glue it generated and the basic cli is how <code>roc__mainForHost_xxxx</code> links are handled. </p>
<p>The <a href="https://github.com/JRMurr/roc-pbt/blob/e553fab69018a438b41062b28f422de113df2e56/platform/crates/glue/roc_app/src/x86_64.rs#L31">glue generated this</a></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="cp">#[derive(Debug)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RocFunction_72</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">closure_data</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">RocFunction_72</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">force_thunk</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">roc_std</span>::<span class="n">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">fn</span> <span class="nf">roc__mainForHost_0_caller</span><span class="p">(</span><span class="n">arg0</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="p">(),</span><span class="w"> </span><span class="n">closure_data</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">output</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">roc_std</span>::<span class="n">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">();</span>

<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">roc__mainForHost_0_caller</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(),</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">closure_data</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">());</span>

<span class="w">            </span><span class="n">output</span><span class="p">.</span><span class="n">assume_init</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mainForHost</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">roc_std</span>::<span class="n">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">fn</span> <span class="nf">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="n">_</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">roc_std</span>::<span class="n">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">();</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="n">ret</span><span class="p">.</span><span class="n">assume_init</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>but in <code>basic-cli</code> i see </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[link_name = </span><span class="s">"roc__mainForHost_1_exposed_generic"</span><span class="cp">]</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">roc_main</span><span class="p">(</span><span class="n">output</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">);</span>

<span class="w">    </span><span class="cp">#[link_name = </span><span class="s">"roc__mainForHost_1_exposed_size"</span><span class="cp">]</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">roc_main_size</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[link_name = </span><span class="s">"roc__mainForHost_0_caller"</span><span class="cp">]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">call_Fx</span><span class="p">(</span><span class="n">flags</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">closure_data</span>: <span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">output</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">);</span>

<span class="w">    </span><span class="cp">#[allow(dead_code)]</span>
<span class="w">    </span><span class="cp">#[link_name = </span><span class="s">"roc__mainForHost_0_size"</span><span class="cp">]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">size_Fx</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[link_name = </span><span class="s">"roc__mainForHost_0_result_size"</span><span class="cp">]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">size_Fx_result</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="kt">i64</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Do i need to manually create some of these other extern funcs like <code>roc_main_size</code>, <code>call_Fx</code>, etc for roc to handle the effects correctly?</p>
<p>I couldn't find any platform making tutorial docs when poking around, do any exist? If not Id be happy to document some of the process to get the basics setup once I get something working</p>



<a name="408272041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272041">(Dec 15 2023 at 23:29)</a>:</h4>
<p>The docs don't exist cause we are working on a huge change (have been for a while). So documenting the process now isn't super useful.</p>



<a name="408272138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272138">(Dec 15 2023 at 23:30)</a>:</h4>
<p>As for the other functions there, you shouldn't need them. Glue should generate that correctly.</p>



<a name="408272166"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272166" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272166">(Dec 15 2023 at 23:30)</a>:</h4>
<p>You will need the <code>roc_fx_*</code> function which I don't think glue will generate</p>



<a name="408272199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272199">(Dec 15 2023 at 23:31)</a>:</h4>
<p>Probably would need to look at your platform specifically when I am on pc to give real advice</p>



<a name="408272326"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272326" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272326">(Dec 15 2023 at 23:33)</a>:</h4>
<p>Ahh the doc stuff makes sense.</p>
<p>I tried to split up some of my rust code around so definitely possible I missed something during that</p>



<a name="408272508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272508">(Dec 15 2023 at 23:35)</a>:</h4>
<p>Yeah, first glance on phone looks fine.</p>



<a name="408272602"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272602" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272602">(Dec 15 2023 at 23:36)</a>:</h4>
<p>The size function isn't needed cause the size of a task i32 is know at compile time</p>



<a name="408272624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272624">(Dec 15 2023 at 23:36)</a>:</h4>
<p>So glue can just generate all of that statically</p>



<a name="408272688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272688">(Dec 15 2023 at 23:37)</a>:</h4>
<p>And the caller function labeled <code>call_Fx</code> is used in the <code>force_thunk</code> function that glue generates`</p>



<a name="408272846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272846">(Dec 15 2023 at 23:39)</a>:</h4>
<p><span class="user-mention" data-user-id="666594">@John Murray</span> btw I'd love to include property based testing directly into <code>expect</code>! Want to chat about it sometime?</p>



<a name="408272968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408272968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408272968">(Dec 15 2023 at 23:41)</a>:</h4>
<p>Definitly! mostly using this as an excuse to make my own platform so would love to help out with pbt in <code>expect</code></p>



<a name="408273332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408273332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408273332">(Dec 15 2023 at 23:45)</a>:</h4>
<p>I'll try to take a look shortly, probably something simple. If you want to try and debug in the meantime, run with a debugger and print the stack trace when it crashes.</p>



<a name="408273390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408273390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408273390">(Dec 15 2023 at 23:46)</a>:</h4>
<p>That will probably reveal a function with slightly off API or something</p>



<a name="408273468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408273468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408273468">(Dec 15 2023 at 23:47)</a>:</h4>
<p>Oh, I bet this needs an explicit out param:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">roc_fx_genStr</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">RocStr</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RocStr</span>::<span class="n">from</span><span class="p">(</span><span class="s">"abc"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>



<a name="408273495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408273495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408273495">(Dec 15 2023 at 23:47)</a>:</h4>
<p><code>out: *mut RocStr</code></p>



<a name="408274078"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408274078" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408274078">(Dec 15 2023 at 23:55)</a>:</h4>
<p>so would it be something like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">roc_fx_genStr</span><span class="p">(</span><span class="n">_out</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RocStr</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">RocStr</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RocStr</span>::<span class="n">from</span><span class="p">(</span><span class="s">"abc"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>or would i need to set out to <code>RocStr::from("abc")</code>?</p>



<a name="408274891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408274891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408274891">(Dec 16 2023 at 00:03)</a>:</h4>
<p>Set out to that and return nothing</p>



<a name="408290515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408290515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408290515">(Dec 16 2023 at 02:26)</a>:</h4>
<p>I updated to </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">roc_fx_genStr</span><span class="p">(</span><span class="n">out</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">RocStr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">out</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">RocStr</span>::<span class="n">from</span><span class="p">(</span><span class="s">"abc"</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>with this roc program to test</p>
<div class="codehilite"><pre><span></span><code>app &quot;simple&quot;
    packages { pf: &quot;../platform/main.roc&quot; }
    imports [
        pf.Task.{Task},
        pf.Generator,
        pf.Stdout,
    ]
    provides [main] to pf

dbge = \x -&gt;
    dbg x

    x

main : Task {} I32
main =
    val &lt;- Generator.genStr |&gt; dbge |&gt; Task.await
    {} &lt;- Stdout.line val |&gt; dbge |&gt; Task.await
    Task.err 0
</code></pre></div>
<p>and the output I have is </p>
<div class="codehilite"><pre><span></span><code>roc dev examples/simple.roc
🔨 Rebuilding platform...
ENTERTING ROC
[examples/simple.roc:11] x = &lt;opaque&gt;
LEAVING ROC
RES:(RocOk(ManuallyDrop { value: () }))
</code></pre></div>
<p>the last line sometimes will be something like <code>RES:(RocErr(ManuallyDrop { value: -1597949984 }))</code> were the number changes a lot.</p>
<p>Would that imply that maybe my manual bindings for things like alloc are wrong?</p>



<a name="408301659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408301659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408301659">(Dec 16 2023 at 04:36)</a>:</h4>
<p>I ended up getting it to work but not using the generated glue in <code>roc_app</code> and instead using the same <code>rust_main</code> from basic cli</p>



<a name="408301943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408301943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408301943">(Dec 16 2023 at 04:40)</a>:</h4>
<p>I wonder what glue has wrong</p>



<a name="408301965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408301965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408301965">(Dec 16 2023 at 04:40)</a>:</h4>
<p>I'll have to dig into that in the future</p>



<a name="408301978"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408301978" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408301978">(Dec 16 2023 at 04:40)</a>:</h4>
<p>Do you think you could file a bug with the failing version</p>



<a name="408301981"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408301981" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408301981">(Dec 16 2023 at 04:40)</a>:</h4>
<p>Will do!</p>



<a name="408302030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408302030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408302030">(Dec 16 2023 at 04:41)</a>:</h4>
<p>Not sure when I will get to it, maybe monday. About to travel, so not exactly sure my free time, but I do want to figure out what is going on here.</p>



<a name="408302160"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408302160" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408302160">(Dec 16 2023 at 04:43)</a>:</h4>
<p>No rush! im unblocked for now so no worries.</p>



<a name="408302790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408302790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408302790">(Dec 16 2023 at 04:50)</a>:</h4>
<p>The generated glue has this as main</p>
<div class="codehilite"><pre><span></span><code>mainForHost : Task {} I32
mainForHost = main
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">mainForHost</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">roc_std</span>::<span class="n">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">fn</span> <span class="nf">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="n">_</span>: <span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">roc_std</span>::<span class="n">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span>::<span class="n">mem</span>::<span class="n">MaybeUninit</span>::<span class="n">uninit</span><span class="p">();</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"> </span><span class="p">);</span>

<span class="w">        </span><span class="n">ret</span><span class="p">.</span><span class="n">assume_init</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>so i think uninit is only making the space for a roc result and not the actual effect which needs to be resolved?</p>



<a name="408303101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408303101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408303101">(Dec 16 2023 at 04:54)</a>:</h4>
<p>created <a href="https://github.com/roc-lang/roc/issues/6288">https://github.com/roc-lang/roc/issues/6288</a></p>



<a name="408304162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408304162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408304162">(Dec 16 2023 at 05:05)</a>:</h4>
<p>Another interesting place to look it basic-webserver.</p>



<a name="408304176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408304176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408304176">(Dec 16 2023 at 05:05)</a>:</h4>
<p>It has a workaround to make glue generate the correct type for main</p>



<a name="408304313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408304313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408304313">(Dec 16 2023 at 05:06)</a>:</h4>
<p>Here is the platform main which is modified so glue will generate correctly <a href="https://github.com/roc-lang/basic-webserver/blob/main/platform/main-glue.roc">https://github.com/roc-lang/basic-webserver/blob/main/platform/main-glue.roc</a></p>



<a name="408304364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408304364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408304364">(Dec 16 2023 at 05:07)</a>:</h4>
<p>This was a workaround Brendan provided, I am not sure how it works.</p>



<a name="408305682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408305682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408305682">(Dec 16 2023 at 05:25)</a>:</h4>
<p>Haha....now I remember. Thanks for posting that.</p>



<a name="408305756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408305756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408305756">(Dec 16 2023 at 05:26)</a>:</h4>
<p>The issue is that glue sees the task and assumes that the final value is being returned. So it doesnt generate code to call the task chain.</p>



<a name="408305782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408305782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408305782">(Dec 16 2023 at 05:26)</a>:</h4>
<p>By writing it explicitly as a function that returns a closure, we are actually specific the underlying closure type that the task truly generates</p>



<a name="408305807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408305807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408305807">(Dec 16 2023 at 05:27)</a>:</h4>
<p>That is why the workaround functions and what is need to make glue work here as well.</p>



<a name="408305929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408305929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408305929">(Dec 16 2023 at 05:29)</a>:</h4>
<p>For generating this glue we would need a workaround like <code>rocMainForHost : {} -&gt; ({} -&gt; Result {} I32)</code> or something like that for this example.</p>



<a name="408306027"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408306027" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408306027">(Dec 16 2023 at 05:30)</a>:</h4>
<p>Or it might just be:<br>
<code>rocMainForHost : ({} -&gt; Result {} I32)</code></p>



<a name="408307387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408307387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> John Murray <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408307387">(Dec 16 2023 at 05:49)</a>:</h4>
<p>Ahh that makes a lot of sense. Does the glue script not have enough introspection to know that task is opaque but it relies on effect?</p>



<a name="408313165"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408313165" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408313165">(Dec 16 2023 at 07:09)</a>:</h4>
<p>Yeah, it just doesn't have special handling for this currently</p>



<a name="408313174"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/generated%20rust%20glue%20seems%20different%20from%20whats%20in%20basic-cli/near/408313174" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/generated.20rust.20glue.20seems.20different.20from.20whats.20in.20basic-cli.html#408313174">(Dec 16 2023 at 07:09)</a>:</h4>
<p>Cause effect is a special type</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
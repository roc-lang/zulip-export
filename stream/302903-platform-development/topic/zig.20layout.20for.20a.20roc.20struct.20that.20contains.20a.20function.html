<html>
<head><meta charset="utf-8"><title>zig layout for a roc struct that contains a function · platform development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/index.html">platform development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html">zig layout for a roc struct that contains a function</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="371320921"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371320921" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371320921">(Jun 30 2023 at 22:52)</a>:</h4>
<p>Hi,</p>
<p>I try to have a <code>mainForHost</code> in a platform, that returns a struct which has a field that is a function:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">Job</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">name</span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="p">,</span>
<span class="w">    </span><span class="nv">value</span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="p">,</span>
<span class="w">    </span><span class="nv">callback</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>
<p>But I am not able to build the corresponding data structure in zig. I was able, that roc returns a function or that roc returns a struct without a function, but I have no idea how to handle the combination.</p>
<p>What I want to do in zig is getting the pointer to the function, so I can call <code>roc__mainForHost_0_caller</code>.</p>
<p>Here is my current code: <a href="https://github.com/ostcar/roc-wasm-platform/blob/5868b4a423ea70fc0387dbad66cafc7ca765fe1f/src/host.zig#L50">https://github.com/ostcar/roc-wasm-platform/blob/5868b4a423ea70fc0387dbad66cafc7ca765fe1f/src/host.zig#L50</a></p>
<p>To see the platform in action, you can use this example: <a href="https://github.com/ostcar/roc-wasm-platform/tree/task/examples/echo">https://github.com/ostcar/roc-wasm-platform/tree/task/examples/echo</a></p>



<a name="371502876"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371502876" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371502876">(Jul 01 2023 at 14:45)</a>:</h4>
<p>Iirc, how it should work:</p>
<p>That function just returns closure capture data for the callback. The callback would need to be exposed and called directly like <code>mainForHost</code> is called.</p>



<a name="371503351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371503351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371503351">(Jul 01 2023 at 14:47)</a>:</h4>
<p>Should be doable. Probably need an <code>as</code> statement in the type to get roc to expose the caller function (though not 100% sure if that still is the case)</p>



<a name="371503692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371503692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371503692">(Jul 01 2023 at 14:48)</a>:</h4>
<p><span class="user-mention" data-user-id="281543">@Folkert de Vries</span> does that sound correct with the latest glue and function related changes?</p>



<a name="371508957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371508957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371508957">(Jul 01 2023 at 15:09)</a>:</h4>
<p>I'm assuming glue is not used here?</p>



<a name="371509062"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371509062" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371509062">(Jul 01 2023 at 15:09)</a>:</h4>
<p>if that is correct then yes you'd need to name the function type (so something like<code>callback : (a -&gt; b) as Foo</code> in the signature of <code>mainForHost</code></p>



<a name="371522054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371522054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371522054">(Jul 01 2023 at 16:01)</a>:</h4>
<p>Yeah, glue isn't used, but I wasn't sure if the function generation strategy changed some because of glue changes.</p>
<p>But yeah, your comment matches what I thought was needed.</p>



<a name="371522198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371522198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371522198">(Jul 01 2023 at 16:01)</a>:</h4>
<p>Does the job type still need to be embedded in they type of <code>mainForHost</code> or can the <code>as</code> go in the job type definition?</p>



<a name="371522299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371522299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371522299">(Jul 01 2023 at 16:02)</a>:</h4>
<p>must literally be in the type of <code>mainForHost</code></p>



<a name="371561410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371561410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371561410">(Jul 01 2023 at 19:35)</a>:</h4>
<p>Glue is not used. As far as I know, glue does currently not support zig. If I am wrong, I would like to use glue.</p>
<p>I tried it with the <code>as</code> statement, but it did not help. I am not sure if <code>as</code> is needed. If I just return a function (<code>mainForHost : List u8 -&gt; (List U8 -&gt; List U8)</code>) then it works. roc creates a function <code>roc__mainForHost_0_caller</code> that I can call with the return value from <code>roc__mainForHost_1_exposed</code> and everything works fine.</p>
<p>I am a step farther but my zig knowledge is to low:</p>
<p>In roc, I have the type :</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">Job</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">name</span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="p">,</span>
<span class="w">    </span><span class="nv">value</span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="p">,</span>
<span class="w">    </span><span class="nv">callback</span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>In zig I have the type:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">placeholder_I_dont_understand</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">:</span><span class="w"> </span><span class="n">RocList</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="n">RocList</span><span class="w"> </span><span class="p">};</span>
<span class="kr">const</span><span class="w"> </span><span class="n">RocList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pointer</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">};</span>

<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_1_exposed</span><span class="p">(</span><span class="n">job</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">Job</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">RocList</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_0_caller</span><span class="p">(</span><span class="n">argument</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">RocList</span><span class="p">,</span><span class="w"> </span><span class="n">callback_pointer</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">RocList</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="p">;</span>
</code></pre></div>
<p>With the following code, I get a pointer, that I can use to call <code>roc__mainForHost_0_caller</code></p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">var</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">Job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="n">roc__mainForHost_1_exposed</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="nb">@ptrCast</span><span class="p">([</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>
</code></pre></div>
<p>With the following code, I get (a pointer to) the value of the name-attribute.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">var</span><span class="w"> </span><span class="n">result</span><span class="o">:</span><span class="w"> </span><span class="n">Job</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="n">roc__mainForHost_1_exposed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
</code></pre></div>
<p>But I do not know how to call <code>roc__mainForHost_1_exposed</code> so I can get the callresult pointer and the name attribute.</p>
<p>I would have guest, that it should be easy to go from <code>*Job</code> to <code>Job</code> with something like <code>&amp;result.name.pointer</code> or <code>result.*.name.pointer</code>, but nothing seems to work.</p>



<a name="371561879"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371561879" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371561879">(Jul 01 2023 at 19:38)</a>:</h4>
<p>the zig syntax is <code>ptr.*</code>  to dereference the pointer</p>



<a name="371562013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371562013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371562013">(Jul 01 2023 at 19:39)</a>:</h4>
<p>and you can use the <code>--debug</code> flag in your roc build/run command to have roc generate <code>.ll</code> files. Those contain exactly the names/types of functions that roc generates, so that you can use them from zig</p>



<a name="371564720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371564720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371564720">(Jul 01 2023 at 19:59)</a>:</h4>
<p>Success! Thank you.</p>
<p>But the solution was something different. As I looked at the values, zig behaved very strange. For example the pointer cast to an int was something like <code>7</code>. And the value from <code>1000 + @ptrToInt(result.name.pointer)</code> was still <code>7</code></p>
<p>So I updated to zig 0.10.1 and everything worked.</p>
<p>It seems, that there are some critical bugs in zig 0.9.1 with wasm that where fixed with zig 0.10.1.</p>
<p>I hope roc will switch to zig 0.10.1 in the near future and  for the meantime removes the <code>--strip</code>argument from the wasm build. See <a href="#narrow/stream/231634-beginners/topic/Bundle.20a.20wasm.20platform/near/369321926">https://roc.zulipchat.com/#narrow/stream/231634-beginners/topic/Bundle.20a.20wasm.20platform/near/369321926</a></p>



<a name="371565754"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371565754" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371565754">(Jul 01 2023 at 20:06)</a>:</h4>
<p>we want to update more to zig 0.11 which should be released soon</p>



<a name="371567005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/371567005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#371567005">(Jul 01 2023 at 20:16)</a>:</h4>
<p>I am sure, it will also work with zig 0.11. <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="372294365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372294365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372294365">(Jul 04 2023 at 12:39)</a>:</h4>
<p>Could I ask for you help once more? I am still struggling with zig. I never used a language with manual memory management before. So I have some difficulties with it.</p>
<p>I am trying to write a function in zig, that calls roc and then returns a pointer to a zig-struct with two values. If I am correct, I have to allocate this struct on the heap. But as soon as I allocate anything, the value from roc gets corrupted.</p>
<p>This works:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">var</span><span class="w"> </span><span class="n">roc_result</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="n">roc__mainForHost_1_exposed</span><span class="p">(</span><span class="n">roc_result</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="n">roc_result</span><span class="p">;</span>
</code></pre></div>
<p>This does not work:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">heap</span><span class="p">.</span><span class="n">page_allocator</span><span class="p">;</span>

<span class="kr">var</span><span class="w"> </span><span class="n">roc_result</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span>
<span class="n">roc__mainForHost_1_exposed</span><span class="p">(</span><span class="n">roc_result</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
<span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span>
<span class="w">    </span><span class="nb">@panic</span><span class="p">(</span><span class="s">"failed to allocate result type"</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="n">roc_result</span><span class="p">;</span>
</code></pre></div>
<p>I use the <code>roc_alloc</code> function, that is used by any zig-platform in the repo:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">Align</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">};</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">?*</span><span class="kr">align</span><span class="p">(</span><span class="nb">@alignOf</span><span class="p">(</span><span class="n">Align</span><span class="p">))</span><span class="w"> </span><span class="n">anyopaque</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="n">c_ptr</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kr">align</span><span class="p">(</span><span class="nb">@alignOf</span><span class="p">(</span><span class="n">Align</span><span class="p">))</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">free</span><span class="p">(</span><span class="n">c_ptr</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kr">align</span><span class="p">(</span><span class="nb">@alignOf</span><span class="p">(</span><span class="n">Align</span><span class="p">))</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span><span class="w"> </span><span class="n">src</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span><span class="w"> </span><span class="n">count</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">;</span>

<span class="kr">export</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc_alloc</span><span class="p">(</span><span class="n">size</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">alignment</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alignment</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc_realloc</span><span class="p">(</span><span class="n">c_ptr</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">old_size</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">alignment</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_size</span><span class="p">;</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alignment</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">realloc</span><span class="p">(</span><span class="nb">@alignCast</span><span class="p">(</span><span class="nb">@alignOf</span><span class="p">(</span><span class="n">Align</span><span class="p">),</span><span class="w"> </span><span class="nb">@ptrCast</span><span class="p">([</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">c_ptr</span><span class="p">)),</span><span class="w"> </span><span class="n">new_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="kr">export</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc_dealloc</span><span class="p">(</span><span class="n">c_ptr</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span><span class="w"> </span><span class="n">alignment</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alignment</span><span class="p">;</span>

<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="nb">@alignCast</span><span class="p">(</span><span class="nb">@alignOf</span><span class="p">(</span><span class="n">Align</span><span class="p">),</span><span class="w"> </span><span class="nb">@ptrCast</span><span class="p">([</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">c_ptr</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre></div>
<p>Could it be, that the zig <code>page_allocator</code> and <code>roc_alloc</code> are writing to the same places? How could I rewrite the <code>roc_alloc</code> to use the <code>page_allocator</code>?</p>



<a name="372295860"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372295860" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372295860">(Jul 04 2023 at 12:44)</a>:</h4>
<p>bunch of stuff going on here. </p>
<p>what is the signature of <code>roc__mainForHost_1_exposed</code>? </p>
<div class="codehilite"><pre><span></span><code>var roc_result: u32 = undefined;
roc__mainForHost_1_exposed(roc_result, arg);
</code></pre></div>



<a name="372295925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372295925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372295925">(Jul 04 2023 at 12:44)</a>:</h4>
<p>you seem to give it a <code>u32</code> which is almost certainly not what the LLVM code says it should be</p>



<a name="372296079"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372296079" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372296079">(Jul 04 2023 at 12:45)</a>:</h4>
<p>I expect that it wants a pointer, maybe <code>i32*</code> in the llvm IR? or something ending in <code>*</code> certainly</p>



<a name="372296738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372296738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372296738">(Jul 04 2023 at 12:47)</a>:</h4>
<p>so in general. the fact that the earlier program seems to work is coincidence. the zig side has to match the roc (llvm) side exactly</p>



<a name="372296755"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372296755" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372296755">(Jul 04 2023 at 12:47)</a>:</h4>
<p>I am not able to read the llvm definitions. Here it is:</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc__mainForHost_1_exposed</span><span class="p">({</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">}*</span><span class="w"> </span><span class="k">sret</span><span class="p">({</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">}*</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%result_value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span>
<span class="w">  </span><span class="nv">%bitcast_arg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">bitcast</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">i8</span><span class="p">*,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">}*</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="p">*</span>
<span class="w">  </span><span class="nv">%load_arg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="p">,</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="p">*</span><span class="w"> </span><span class="nv">%bitcast_arg</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_mainForHost_c610e85212d0697cb161d4ba431ba63f273feee7dcb7927c9ff5d74ae6cbfa3</span><span class="p">(</span><span class="nv">%list.RocList</span><span class="w"> </span><span class="nv">%load_arg</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">}*</span><span class="w"> </span><span class="nv">%result_value</span><span class="p">)</span>
<span class="w">  </span><span class="nv">%load_roc_result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">}*</span><span class="w"> </span><span class="nv">%result_value</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nv">%load_roc_result</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">0</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="m">12</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="m">3</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i8</span><span class="p">]</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="p">}*</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="p">}</span>
</code></pre></div>
<p>I used [*]u8 before, but it worked with u32 and it was easier with it :)</p>



<a name="372297060"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372297060" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372297060">(Jul 04 2023 at 12:48)</a>:</h4>
<p>assuming you're on a 64-bit machine, using <code>u64</code> (or <code>usize</code>, to be generic) is usually the better choice</p>



<a name="372297083"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372297083" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372297083">(Jul 04 2023 at 12:48)</a>:</h4>
<p>if you just want to hack around a bit</p>



<a name="372297192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372297192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372297192">(Jul 04 2023 at 12:49)</a>:</h4>
<p>I try to compile it with --target=wasm32. So its 32bit</p>



<a name="372297243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372297243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372297243">(Jul 04 2023 at 12:49)</a>:</h4>
<p>ah, ok, that makes sense then</p>



<a name="372297630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372297630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372297630">(Jul 04 2023 at 12:50)</a>:</h4>
<p>This is my current zig definition for the function:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">RocJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">placeholder_I_dont_understand</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="n">RocList</span><span class="w"> </span><span class="p">};</span>
<span class="kr">const</span><span class="w"> </span><span class="n">RocList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pointer</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">};</span>
<span class="c1">// TODO: u32 works, but use a pointer, so it is more clear</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_1_exposed</span><span class="p">(</span><span class="n">job</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">argument</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">RocList</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="p">;</span>
</code></pre></div>



<a name="372297689"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372297689" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372297689">(Jul 04 2023 at 12:50)</a>:</h4>
<p>sure, ok</p>



<a name="372297794"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372297794" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372297794">(Jul 04 2023 at 12:51)</a>:</h4>
<p>well, we need that integer to be a valid pointer now</p>



<a name="372298017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372298017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372298017">(Jul 04 2023 at 12:51)</a>:</h4>
<p>because you know exactly what types and sizes you expect, no (heap) allocation is needed</p>



<a name="372298431"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372298431" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372298431">(Jul 04 2023 at 12:53)</a>:</h4>
<p>also because this already uses the <code>sret</code> attribute ("stack return"), I wonder if this might just work</p>
<div class="codehilite"><pre><span></span><code>extern fn roc__mainForHost_1_exposed(argument: *RocList) RocJob;
</code></pre></div>



<a name="372300227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372300227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372300227">(Jul 04 2023 at 12:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281543">Folkert de Vries</span> <a href="#narrow/stream/302903-Writing-a-platform/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function/near/372298431">said</a>:</p>
<blockquote>
<p>also because this already uses the <code>sret</code> attribute ("stack return"), I wonder if this might just work</p>
<p><div class="codehilite"><pre><span></span><code>extern fn roc__mainForHost_1_exposed(argument: *RocList) RocJob;
</code></pre></div><br>
</p>
</blockquote>
<p>Yes. This works and looks nicer. But it still does not work if I add an allocation:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">var</span><span class="w"> </span><span class="n">roc_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roc__mainForHost_1_exposed</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>

<span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">allocator</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="k">catch</span>
<span class="w">        </span><span class="nb">@panic</span><span class="p">(</span><span class="s">"failed to allocate result type"</span><span class="p">);</span>

<span class="k">return</span><span class="w"> </span><span class="nb">@ptrToInt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">roc_result</span><span class="p">);</span>
</code></pre></div>
<p>Without the allocatio it works as before.</p>



<a name="372300551"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372300551" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372300551">(Jul 04 2023 at 12:59)</a>:</h4>
<p>The goal is, to return something like this (both are pointers, I just use u32 for the moment to make it better understand it from the JavaScript-die):</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">ExternJob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">callback</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>



<a name="372301639"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372301639" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372301639">(Jul 04 2023 at 13:02)</a>:</h4>
<p>describe "does not work" in more detail? no allocation is happening. malloc and the rust page allocator don't interfere</p>



<a name="372301725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372301725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372301725">(Jul 04 2023 at 13:03)</a>:</h4>
<p>ah, wait</p>



<a name="372301775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372301775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372301775">(Jul 04 2023 at 13:03)</a>:</h4>
<p>what is happening here is that you are returning a  pointer that does not live long enough</p>



<a name="372301868"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372301868" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372301868">(Jul 04 2023 at 13:03)</a>:</h4>
<p>and, kind of depending on a bunch of things, that usually does not work</p>



<a name="372302468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372302468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372302468">(Jul 04 2023 at 13:05)</a>:</h4>
<p>the <code>&amp;roc_result</code> takes a pointer to the <code>roc_result</code> value as it lives on the stack of the surrounding function. But when you return, that stack memory is free'd up. So whoever you return this pointer to gets a pointer that points to invalid memory (it has  just been cleaned up)</p>



<a name="372302626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372302626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372302626">(Jul 04 2023 at 13:05)</a>:</h4>
<p>I don't think your surrounding function should return a pointer. would make things way simpler</p>



<a name="372302884"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372302884" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372302884">(Jul 04 2023 at 13:06)</a>:</h4>
<p>That is true. But wasm only supports basic types like u32. So a pointer is all I can return</p>



<a name="372303210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372303210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372303210">(Jul 04 2023 at 13:07)</a>:</h4>
<p>kind of. if it's an extern function. One possible approach (given that you know the types) is to provide the function with a pointer to write the result into</p>



<a name="372303477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372303477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372303477">(Jul 04 2023 at 13:08)</a>:</h4>
<p>in other words, make finding the memory the caller's problem</p>



<a name="372304119"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372304119" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372304119">(Jul 04 2023 at 13:10)</a>:</h4>
<p>Its hard to tell what is going wrong. What should happen is, that I return a pointer to the closure (I don't know if this is the correct word) that I have to use to later call <code>roc__mainForHost_0_caller</code>. So in result, I call roc with two arguments. One to <code>roc__mainForHost_1_exposed</code> and on to <code>roc__mainForHost_0_caller</code>. The two arguments should be combined with this roc function:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">arg1</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="err">\</span><span class="nx">arg2</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="s">"arg1: \(arg1), arg2: \(arg2)"</span>
</code></pre></div>
<p>When I said, it works, then this happend. When I said it does not work, then it was a strange behavior. For exmaple it returns a string where <code>arg1</code> was the variable I put into <code>arg2</code></p>



<a name="372304627"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372304627" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372304627">(Jul 04 2023 at 13:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281543">Folkert de Vries</span> <a href="#narrow/stream/302903-Writing-a-platform/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function/near/372303210">said</a>:</p>
<blockquote>
<p>kind of. if it's an extern function. One possible approach (given that you know the types) is to provide the function with a pointer to write the result into</p>
</blockquote>
<p>That could work. I will try it.</p>
<p>But it has one problem. I do not know hat the size of the closure is :) I just returned the pointer. But if I save it somewhere, I have to know the size.</p>



<a name="372305061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372305061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372305061">(Jul 04 2023 at 13:13)</a>:</h4>
<p>oh. hmm. well really I think you should not do this manually if you expect the roc program to change</p>



<a name="372305287"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372305287" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372305287">(Jul 04 2023 at 13:13)</a>:</h4>
<p>or is that the literal main function you will always use?</p>



<a name="372305449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372305449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372305449">(Jul 04 2023 at 13:14)</a>:</h4>
<p>no. I would like to write a platform, that supports different main functions</p>



<a name="372305570"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372305570" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372305570">(Jul 04 2023 at 13:14)</a>:</h4>
<p>yeah. this is why we have glue (for rust for now)</p>



<a name="372305696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372305696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372305696">(Jul 04 2023 at 13:15)</a>:</h4>
<p>because also the function could be nested arbitrarily, right</p>



<a name="372305829"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372305829" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372305829">(Jul 04 2023 at 13:15)</a>:</h4>
<p>basically, there is no reasonable way for the zig code to know what roc will give it, and what structure it will have</p>



<a name="372306140"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372306140" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372306140">(Jul 04 2023 at 13:16)</a>:</h4>
<p>so unless you know the structure exactly and it does not change as you change the roc program, you'll run into trouble</p>



<a name="372306267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372306267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372306267">(Jul 04 2023 at 13:16)</a>:</h4>
<p>and here structure means, loosely, the type of main. Loosely because when you start returning closures things get complicated</p>



<a name="372307337"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372307337" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372307337">(Jul 04 2023 at 13:20)</a>:</h4>
<p>All I would need is the size. What does <code>roc__mainForHost_1_size()</code> or  <code>roc__mainForHost_0_size</code> do? They sound as if they could return the size?</p>



<a name="372307579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372307579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372307579">(Jul 04 2023 at 13:21)</a>:</h4>
<p>yes they do. but this only works for one level. (if that is all you need, great!)</p>



<a name="372308091"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372308091" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372308091">(Jul 04 2023 at 13:23)</a>:</h4>
<p>the <code>crates/cli_testing_examples/benchmarks/platform/host.zig</code> file might be helpful</p>



<a name="372308343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372308343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372308343">(Jul 04 2023 at 13:24)</a>:</h4>
<p>in particular</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">stderr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">getStdErr</span><span class="p">().</span><span class="n">writer</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// The size might be zero; if so, make it at least 8 so that we don't have a nullptr</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="nb">@intCast</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">roc__mainForHost_1_exposed_size</span><span class="p">()),</span><span class="w"> </span><span class="mi">8</span><span class="p">);</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">raw_output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roc_alloc</span><span class="p">(</span><span class="nb">@intCast</span><span class="p">(</span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">),</span><span class="w"> </span><span class="nb">@alignOf</span><span class="p">(</span><span class="kt">u64</span><span class="p">)).</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@ptrCast</span><span class="p">([</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">raw_output</span><span class="p">);</span>

<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">roc_dealloc</span><span class="p">(</span><span class="n">raw_output</span><span class="p">,</span><span class="w"> </span><span class="nb">@alignOf</span><span class="p">(</span><span class="kt">u64</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">timer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">Timer</span><span class="p">.</span><span class="n">start</span><span class="p">()</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="k">unreachable</span><span class="p">;</span>

<span class="w">    </span><span class="n">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="n">output</span><span class="p">);</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">closure_data_pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">@ptrCast</span><span class="p">([</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>



<a name="372308381"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372308381" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372308381">(Jul 04 2023 at 13:24)</a>:</h4>
<p>shows how to do the allocation</p>



<a name="372308558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372308558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372308558">(Jul 04 2023 at 13:24)</a>:</h4>
<p>in your case remove the <code>defer</code> block, because it would clean up the memory, but you want to return it</p>



<a name="372308678"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372308678" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372308678">(Jul 04 2023 at 13:25)</a>:</h4>
<p>My internet connection will break in some minutes. So I say thank you for know and will tell you when I tested it</p>



<a name="372331628"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372331628" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372331628">(Jul 04 2023 at 14:34)</a>:</h4>
<p>I don't see how this could work.</p>
<p>In you example, the roc function looks like this:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">mainForHost</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">Fx</span>
</code></pre></div>
<p>But what if it would had an argument:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">mainForHost</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Task</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">Fx</span>
</code></pre></div>
<p>In this case, the closure would (or at least could) contain the a variable sized argument. So the size of the closure could only be known at runtime. But as far as I can see, al the <code>*_size()</code> functions return a value, that is independent of the size of the input argument. I tested it with all of these functions:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_1_exposed_size</span><span class="p">()</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_0_size</span><span class="p">()</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_0_result_size</span><span class="p">()</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_1_size</span><span class="p">()</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_1_result_size</span><span class="p">()</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
</code></pre></div>
<p>I don't think that <code>roc glue</code> can help, since it does not run at runtime.</p>
<p>When <code>roc</code> returns a list, then the returned data looks like this:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">const</span><span class="w"> </span><span class="n">RocList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">pointer</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">capacity</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">};</span>
</code></pre></div>
<p>So it not only returns a pointer to the data, but also the length of the data. If it would only return the pointer, then it would not be possible to do anything with it.</p>
<p>So I think, it should be the same for a closure. A closure should also return its size.</p>
<p>Is this already the case? If yes: how can I access it? if not, do you also see, that is would be helpful?</p>



<a name="372334035"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372334035" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372334035">(Jul 04 2023 at 14:41)</a>:</h4>
<p>yes this is why closures are a problem</p>



<a name="372334596"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372334596" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372334596">(Jul 04 2023 at 14:43)</a>:</h4>
<p>in this case, we statically know (when we compile the app) exactly how big that closure is</p>



<a name="372334615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372334615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372334615">(Jul 04 2023 at 14:43)</a>:</h4>
<p>or, how big it could get, worst case</p>



<a name="372340970"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372340970" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372340970">(Jul 04 2023 at 15:02)</a>:</h4>
<p>How is that possible? I would have thought, that the closure has to contain all the data that the main function was called with. If you call main with 1GB of data, I would think, that the closure is 1GB +X.</p>



<a name="372342730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372342730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372342730">(Jul 04 2023 at 15:07)</a>:</h4>
<p>you mean if that input list is 1gb of data?</p>



<a name="372343029"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372343029" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372343029">(Jul 04 2023 at 15:08)</a>:</h4>
<p>because if so, all we store in the closure is 3 usize values: ptr, len, capacity. the actual contents of the list are elsewhere in memory and kept alive (as in, not cleaned up) because the closure contains them, but it does not count towards the data that is returned from main</p>



<a name="372409791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372409791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372409791">(Jul 04 2023 at 20:19)</a>:</h4>
<p>Ahh this makes sense. But I still don't get it 100%. The argument list it can be saved elsewhere. But what about data, that is allocated from roc? For example the following function</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">main</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">U32</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="nx">Str</span><span class="w"> </span><span class="p">)</span>
<span class="nv">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">list</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">new_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">List</span><span class="p">.</span><span class="nx">map</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="nx">s</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="s">"hello (\s)"</span><span class="p">)</span>
<span class="w">    </span><span class="err">\</span><span class="nx">i</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nx">List</span><span class="p">.</span><span class="nx">map</span><span class="w"> </span><span class="nx">new_list</span><span class="w"> </span><span class="p">(</span><span class="err">\</span><span class="nx">s</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Str</span><span class="p">.</span><span class="nx">repeat</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">i</span><span class="p">)</span>
</code></pre></div>
<p>This would return a closure that has to contain <code>new_list</code>. But since it has a variable size, it has to be stored elsewhere. So when will the actual content of <code>new_list</code> be freed? <code>roc</code> can not know, if the platform saves the closure (with the pointer to <code>new_list</code>) to call it later.</p>



<a name="372415692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372415692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372415692">(Jul 04 2023 at 21:08)</a>:</h4>
<p>If the platform saves <code>new_list</code>, it must increment the refcount</p>



<a name="372415751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372415751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372415751">(Jul 04 2023 at 21:08)</a>:</h4>
<p>Otherwise, if <code>new_list</code> were passed back into roc without the refcount incremented, roc would free it.</p>



<a name="372415815"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372415815" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372415815">(Jul 04 2023 at 21:09)</a>:</h4>
<p>If <code>new_list</code> is passed to the platform with a unique refcount, the platform is responsible for freeing it assuming that the list isn't passed back into roc.</p>



<a name="372416005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372416005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372416005">(Jul 04 2023 at 21:11)</a>:</h4>
<p>Also, theoretically <code>new_list</code> may not even be a new allocation. It may be the same allocation as <code>list</code>. Depends on if <code>list</code> was unique to begin with and if we can update in place.</p>



<a name="372416207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372416207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372416207">(Jul 04 2023 at 21:13)</a>:</h4>
<p>By default, <code>new_list</code>, which is saved in the closure, would have a unique refcount. As such, roc would free it after the closure is run. (Though it still may in place update and reuse the allocation instead of freeing).</p>



<a name="372416287"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372416287" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372416287">(Jul 04 2023 at 21:14)</a>:</h4>
<p>If the closure was going to be called multiple times, the list captured by the closure would need its refcount incremented before each call to avoid being freed or reused.</p>



<a name="372423504"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372423504" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372423504">(Jul 04 2023 at 22:30)</a>:</h4>
<p>That is interesting. With this information, I am not sure, if my use case is possible.</p>
<p>I want to call roc, receive a closure, copy the closure to the heap and return the pointer to the wasm-runtime. Later, another function calls run_closure with the pointer.</p>
<p>If I understand you both correctly, as soon as the first function returns, the original closure will be freed. Since the allocated data has a refcound of 1, it will also be freed. To solve this, I would have to add the refcound of all data referenced by the closure by 1. I don't know how to do this.</p>
<p>Would it be possible to tell roc somehow, that I made a copy of the closure and that it should not reduce the refcounter, when the original closure on the stack gets "freed"? </p>
<p>Or do you have another idea, how a task-like feature could work with webassembly?</p>



<a name="372425706"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372425706" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372425706">(Jul 04 2023 at 22:54)</a>:</h4>
<p>once the data is out of roc, freeing the memory is your responsibility. you can just not do it</p>



<a name="372425741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372425741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372425741">(Jul 04 2023 at 22:54)</a>:</h4>
<p>so if you don't actively free heap memory,  it'll just keep existing</p>



<a name="372425786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372425786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372425786">(Jul 04 2023 at 22:55)</a>:</h4>
<p>now, for the storing of the closure, I think by far the easiest is to have roc return a <code>Box YourActualReturnType</code></p>



<a name="372425871"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372425871" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372425871">(Jul 04 2023 at 22:56)</a>:</h4>
<p>it makes roc do the allocation, so everything is the right size</p>



<a name="372425910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372425910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372425910">(Jul 04 2023 at 22:56)</a>:</h4>
<p>but you can also do the allocation yourself on the zig side</p>



<a name="372425934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372425934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372425934">(Jul 04 2023 at 22:57)</a>:</h4>
<p>using those size constants we talked about before</p>



<a name="372426072"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372426072" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372426072">(Jul 04 2023 at 22:58)</a>:</h4>
<p>then the <code>mainforhost_exposed_generic</code> function takes a pointer as an argument and writes the return value into it. usually we'd give a stack pointer, but you can provide a heap pointer (given to you by the allocater) as well</p>



<a name="372426162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/372426162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#372426162">(Jul 04 2023 at 22:59)</a>:</h4>
<p>we're working on better support for <code>Task</code> using glue. it is quite tricky to do it in general though.</p>



<a name="373739260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/zig%20layout%20for%20a%20roc%20struct%20that%20contains%20a%20function/near/373739260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/zig.20layout.20for.20a.20roc.20struct.20that.20contains.20a.20function.html#373739260">(Jul 09 2023 at 16:20)</a>:</h4>
<p>I still don't get, when the memory is deallocated. But after I copied the closure_data to a manually allocated memory, everything works. So thank you for you help.</p>
<p>Afterwards I realized, that I misunderstood, how Task work. Now I get, that I have to define the effects in a special <code>hosted Effect</code> module. This makes it much easier. I have other questions about this, but I will ask them i a different thread :)</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
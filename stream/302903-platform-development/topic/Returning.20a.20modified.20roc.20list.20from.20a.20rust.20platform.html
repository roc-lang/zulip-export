<html>
<head><meta charset="utf-8"><title>Returning a modified roc list from a rust platform Â· platform development Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/index.html">platform development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html">Returning a modified roc list from a rust platform</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="486112225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486112225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486112225">(Dec 04 2024 at 14:59)</a>:</h4>
<p>I'm trying to implement an efficient buffered reader and I want to support returning the buffer you just used.<br>
If there is only one reference, then it will be reused.</p>
<p>Currently, my code looks like this, I'm not sure If I'm doing it right, but I'm trying to make rust happy with me returning the buffer I technically have a mutable reference to. I thought the simplest way to do that was to recreate the roc list from a pointer. But I'm really unsure. Any help would be greatly appreciated :)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_fileReadByteBuf</span><span class="p">(</span>
<span class="w">    </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">buf_reader</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">BufReader</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ThreadSafeRefcountedResourceHeap</span><span class="p">::</span><span class="n">box_to_resource</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">buf_reader</span><span class="p">.</span><span class="n">fill_buf</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">n</span><span class="p">,</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="fm">matches!</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">kind</span><span class="p">(),</span><span class="w"> </span><span class="n">ErrorKind</span><span class="p">::</span><span class="n">Interrupted</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">continue</span><span class="p">,</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">RocResult</span><span class="p">::</span><span class="n">err</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_str</span><span class="p">().</span><span class="n">into</span><span class="p">()),</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="c1">//We should be able to ask the user to "return" their buffer. So that if they do they get the same buffer back and we don't have to re-allocate. Should be a nice optimization.</span>
<span class="w">        </span><span class="c1">//TODO: If the capacity is larger but the len isn't right we should be able to extend the len to match. I don't have access to a function that does that though</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">is_unique</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">available</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">available</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">buf</span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="n">available</span><span class="p">);</span>
<span class="w">                    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(</span><span class="n">RocList</span><span class="p">::</span><span class="n">from_raw_parts</span><span class="p">(</span>
<span class="w">                            </span><span class="n">buf</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">buf</span><span class="p">.</span><span class="n">capacity</span><span class="p">(),</span>
<span class="w">                        </span><span class="p">));</span>
<span class="w">                    </span><span class="p">};</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(</span><span class="n">RocList</span><span class="p">::</span><span class="n">from_slice</span><span class="p">(</span><span class="n">available</span><span class="p">));</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
<span class="w">        </span><span class="n">buf_reader</span><span class="p">.</span><span class="n">consume</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">list</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="486141810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486141810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486141810">(Dec 04 2024 at 17:12)</a>:</h4>
<p>I think all I needed to do was inc the reference count when I make the duplicate. <br>
It's no longer crashing but it's not actually any faster so It mustn't be running this optimisation often</p>



<a name="486158922"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486158922" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486158922">(Dec 04 2024 at 18:55)</a>:</h4>
<blockquote>
<p>it's not actually any faster</p>
</blockquote>
<p>I'd expect this to be a memory usage diff, not a perf diff, no?</p>



<a name="486180633"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486180633" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486180633">(Dec 04 2024 at 21:17)</a>:</h4>
<p>In your fast case you don't consume the length. Is that related?</p>



<a name="486182199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486182199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486182199">(Dec 04 2024 at 21:28)</a>:</h4>
<p>Also, you can just edit the length in place instead of making sure it is a perfect match</p>



<a name="486182442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486182442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486182442">(Dec 04 2024 at 21:30)</a>:</h4>
<p>Also, if you keep allocating the same sized object right after freeing it, malloc has a fast path to just return the old version. So may not be much of a perf difference</p>



<a name="486182495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486182495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486182495">(Dec 04 2024 at 21:30)</a>:</h4>
<p>A bugger perf different would probably come from avoid the extra copy from the buf reader to roc</p>



<a name="486182588"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486182588" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486182588">(Dec 04 2024 at 21:31)</a>:</h4>
<p>Theoretically could use a seamless slice with a constant refcount to deal with this. Then only would cost the copy of roc mutates the list</p>



<a name="486182638"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486182638" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486182638">(Dec 04 2024 at 21:31)</a>:</h4>
<p>Though that may not be safe over repeated calls...I'd have to think about it more</p>



<a name="486203075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486203075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486203075">(Dec 05 2024 at 00:31)</a>:</h4>
<p>Yeah sorry that was a bug. I did a whole bunch of testing and noticed essentially no difference in memory usage or performance between the two versions.<br>
Perhaps 10%, but it's hard to say when benchmarks have a little variance and the call time is absolutely dominated by FFI overhead (I assume this is somewhat meaningful?) and IO.</p>
<p>Do you mean make the reader's internal buffer the slice from roc? </p>
<p>I believe It should be safe so long as you re-check on each read that the buffer is still unique and if so you create a clone.</p>



<a name="486203163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486203163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486203163">(Dec 05 2024 at 00:32)</a>:</h4>
<p>Oh yeah in my final code I did edit the length in place too :)</p>



<a name="486203327"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486203327" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486203327">(Dec 05 2024 at 00:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="651372">Eli Dowling</span> <a href="#narrow/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486203075">said</a>:</p>
<blockquote>
<p>Do you mean make the reader's internal buffer the slice from roc? </p>
</blockquote>
<p>Yep</p>



<a name="486203423"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486203423" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486203423">(Dec 05 2024 at 00:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="651372">Eli Dowling</span> <a href="#narrow/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486203075">said</a>:</p>
<blockquote>
<p>the call time is absolutely dominated by FFI overhead (I assume this is somewhat meaningful?)</p>
</blockquote>
<p>Unless it is being called constantly (unlikely if return multiple bytes), there should be about 0 ffi overhead</p>



<a name="486203584"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486203584" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486203584">(Dec 05 2024 at 00:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486203423">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="651372">Eli Dowling</span> <a href="#narrow/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486203075">said</a>:</p>
<blockquote>
<p>the call time is absolutely dominated by FFI overhead (I assume this is somewhat meaningful?)</p>
</blockquote>
<p>Good to know! Has anyone measured the overhead of effects overall? As in if I want to do any effect vs just calling a roc function how much slower is it? </p>
<p>Unless it is being called constantly (unlikely if return multiple bytes), there should be about 0 ffi overhead</p>
</blockquote>



<a name="486203963"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486203963" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486203963">(Dec 05 2024 at 00:40)</a>:</h4>
<p>I definitely saw huge performance improvements by making the buffer larger, so I thought there might be a pretty meaningful cost to jumping in and out of roc code. <br>
As in a 100 byte buffer takes 2 seconds and a 20k buffer takes 150ms. <br>
And it seems to be seeing improvements even between 20k and 100k. </p>
<p>I'm keen to test some other languages buffered readers to compare too :)</p>



<a name="486204185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486204185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486204185">(Dec 05 2024 at 00:43)</a>:</h4>
<p>Probably not from jumping in and out of roc, but other overhead that is alleviated from looping in larger chunks. I'll definitely have to try benchmarking this</p>



<a name="486204328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486204328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486204328">(Dec 05 2024 at 00:44)</a>:</h4>
<p>Yeah, I thought the same. I'll let you know my results and provide some snippets, keen to understand this and see how we compare to others :)</p>



<a name="486204330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486204330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486204330">(Dec 05 2024 at 00:44)</a>:</h4>
<p>For example, one big copy is much faster then many small copies</p>



<a name="486204370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486204370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486204370">(Dec 05 2024 at 00:45)</a>:</h4>
<p>Yeah yeah, for sure</p>



<a name="486204607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486204607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486204607">(Dec 05 2024 at 00:47)</a>:</h4>
<p>Do you have anything I could run right now just to check for any major roc perf issues?</p>



<a name="486205170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486205170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486205170">(Dec 05 2024 at 00:54)</a>:</h4>
<p>I can push all my code up later today but obviously it's a modified basic cli platform and a benchmark to go with it</p>



<a name="486205205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486205205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486205205">(Dec 05 2024 at 00:54)</a>:</h4>
<p>I'll put a quick test in go and dotnet in the repo too for comparison</p>



<a name="486205561"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486205561" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486205561">(Dec 05 2024 at 00:58)</a>:</h4>
<p><span aria-label="thank you" class="emoji emoji-1f64f" role="img" title="thank you">:thank_you:</span></p>



<a name="486227479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486227479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486227479">(Dec 05 2024 at 05:06)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> <br>
<a href="https://github.com/faldor20/basic-cli/tree/purity-inference">https://github.com/faldor20/basic-cli/tree/purity-inference</a><br>
<a href="https://github.com/faldor20/roc-experiments">https://github.com/faldor20/roc-experiments</a><br>
Those repos have my experiments and my basic-cli fork.<br>
The last one is the go impl.</p>
<div class="codehilite"><pre><span></span><code>Benchmark 1 (78 runs): ./buf-reuse
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          63.6ms Â±  441us    62.6ms â€¦ 64.3ms          0 ( 0%)        0%
  peak_rss           2.71MB Â±  103KB    2.36MB â€¦ 2.88MB          2 ( 3%)        0%
  cpu_cycles         6.98M  Â±  111K     6.83M  â€¦ 7.54M          10 (13%)        0%
  instructions       10.1M  Â± 1.11K     10.1M  â€¦ 10.1M           4 ( 5%)        0%
  cache_references   34.4K  Â± 1.00K     32.2K  â€¦ 36.6K           0 ( 0%)        0%
  cache_misses       26.0K  Â±  732      23.6K  â€¦ 27.2K           3 ( 4%)        0%
  branch_misses      5.13K  Â±  190      4.23K  â€¦ 5.62K           4 ( 5%)        0%
Benchmark 2 (76 runs): ./buf-no-reuse
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          65.4ms Â±  559us    64.5ms â€¦ 67.2ms          6 ( 8%)        ðŸ’©+  2.9% Â±  0.2%
  peak_rss           2.72MB Â± 93.0KB    2.62MB â€¦ 2.88MB          0 ( 0%)          +  0.6% Â±  1.1%
  cpu_cycles         13.3M  Â±  235K     13.0M  â€¦ 14.4M           2 ( 3%)        ðŸ’©+ 91.0% Â±  0.8%
  instructions       28.9M  Â± 1.56K     28.9M  â€¦ 28.9M           8 (11%)        ðŸ’©+187.8% Â±  0.0%
  cache_references   44.1K  Â± 1.72K     40.6K  â€¦ 48.3K           0 ( 0%)        ðŸ’©+ 28.0% Â±  1.3%
  cache_misses       26.6K  Â±  770      24.3K  â€¦ 27.9K           4 ( 5%)        ðŸ’©+  2.3% Â±  0.9%
  branch_misses      35.2K  Â± 1.05K     33.5K  â€¦ 39.4K           2 ( 3%)        ðŸ’©+585.8% Â±  4.6%
Benchmark 3 (76 runs): ./read-speed
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          65.8ms Â±  536us    64.7ms â€¦ 67.9ms          2 ( 3%)        ðŸ’©+  3.5% Â±  0.2%
  peak_rss           2.01MB Â± 85.2KB    1.84MB â€¦ 2.10MB          0 ( 0%)        âš¡- 25.5% Â±  1.1%
  cpu_cycles         19.9M  Â±  256K     19.4M  â€¦ 21.2M           1 ( 1%)        ðŸ’©+184.5% Â±  0.9%
  instructions       36.9M  Â± 92.9K     36.8M  â€¦ 37.4M           2 ( 3%)        ðŸ’©+267.6% Â±  0.2%
  cache_references   51.9K  Â± 4.62K     40.1K  â€¦ 64.1K           0 ( 0%)        ðŸ’©+ 50.8% Â±  3.0%
  cache_misses       14.9K  Â±  658      13.8K  â€¦ 16.9K           2 ( 3%)        âš¡- 42.5% Â±  0.8%
  branch_misses      18.7K  Â±  626      17.4K  â€¦ 20.3K           0 ( 0%)        ðŸ’©+263.9% Â±  2.8%
</code></pre></div>



<a name="486227525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486227525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486227525">(Dec 05 2024 at 05:07)</a>:</h4>
<p>No-reuse is recreating the buffer every time. <br>
Interestingly, this is still way faster than using rusts read-buffered</p>



<a name="486227802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486227802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486227802">(Dec 05 2024 at 05:11)</a>:</h4>
<p>The way it works for this testing build is:<br>
 If, when you call read, you provide a <code>List U8</code> that is the same as the one the reader was created with, it will reuse that buffer. Otherwise it will make a new list. <br>
Obviously normally you'd check for it being unique, but for testing this provides me a guarantee that it's doing what I want</p>



<a name="486227946"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486227946" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486227946">(Dec 05 2024 at 05:13)</a>:</h4>
<p>Crazy the difference in CPU cycles between the 3, yet almost identical execution time</p>



<a name="486228036"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228036" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228036">(Dec 05 2024 at 05:14)</a>:</h4>
<p>I know... I guess it's just waiting on the file system and the rest is kind of irrelevant.</p>



<a name="486228057"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228057" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228057">(Dec 05 2024 at 05:14)</a>:</h4>
<p>Yeah, probably. io is slow....though it should be hot file cache so all in ram</p>



<a name="486228076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228076">(Dec 05 2024 at 05:15)</a>:</h4>
<p>At least I assume it should be</p>



<a name="486228172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228172">(Dec 05 2024 at 05:16)</a>:</h4>
<p>Oh, this is literally just reading. I expected it to be parsing of something as well.</p>



<a name="486228191"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228191" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228191">(Dec 05 2024 at 05:16)</a>:</h4>
<p>I wonder why 2 gets so many branch misses? I also wonder if I wasn't comparing pointers and just passed in a flag if that would make it not do that.</p>



<a name="486228195"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228195" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228195">(Dec 05 2024 at 05:16)</a>:</h4>
<p>Makes sense go is way more CPU instructions. It is multithreaded and doing async io.</p>



<a name="486228233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228233">(Dec 05 2024 at 05:17)</a>:</h4>
<p>Probably branch misses in malloc/free/refcounting? Given that should be the main difference from one.</p>



<a name="486228238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228238">(Dec 05 2024 at 05:17)</a>:</h4>
<p>yeah, I also have the parser and I'd like to build that in a few langs too, but I wanted to validate if this was having an impact or not first.</p>



<a name="486228271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228271">(Dec 05 2024 at 05:17)</a>:</h4>
<p>make sure I'm not just measuring slower IO or buffering or some silly thing like that <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="486228445"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228445" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228445">(Dec 05 2024 at 05:20)</a>:</h4>
<p>Also, you probably want <code>List.repeat</code></p>



<a name="486228485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486228485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486228485">(Dec 05 2024 at 05:20)</a>:</h4>
<p>Instead of range and map</p>



<a name="486229005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486229005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486229005">(Dec 05 2024 at 05:26)</a>:</h4>
<p>ohh, thanks!</p>
<p>I'll definitely merge this into basic-cli at soon. Just to give you an idea how insanely much quicker, this is.<br>
This is using the whole file reading basic-cli comes with:<br>
Reading line by line is pretty similar.</p>
<div class="codehilite"><pre><span></span><code>  measurement          mean Â± Ïƒ            min â€¦ max           outliers
  wall_time          16.7s  Â± 1.01s     15.6s  â€¦ 17.7s           0 ( 0%)
  peak_rss           2.75MB Â±    0      2.75MB â€¦ 2.75MB          0 ( 0%)
  cpu_cycles         68.7G  Â± 1.28G     67.4G  â€¦ 70.0G           0 ( 0%)
  instructions        299G  Â±  619       299G  â€¦  299G           0 ( 0%)
  cache_references    857K  Â±  181K      706K  â€¦ 1.06M           0 ( 0%)
  cache_misses        351K  Â± 74.9K      283K  â€¦  431K           0 ( 0%)
  branch_misses      47.5M  Â±  545K     47.2M  â€¦ 48.2M           0 ( 0%)
</code></pre></div>



<a name="486229065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486229065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486229065">(Dec 05 2024 at 05:27)</a>:</h4>
<p>I'm pretty happy with a 350x speed up ;)</p>



<a name="486231817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486231817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486231817">(Dec 05 2024 at 06:01)</a>:</h4>
<p>Reading hole file definitely should not be that show (but basic CLI really has not been optimized yet)</p>



<a name="486231964"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486231964" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486231964">(Dec 05 2024 at 06:02)</a>:</h4>
<p>Side note for API: You should store the buffer with the reader. Then make the API match the older reader API. Just make it skip the rust buffer and reuse the roc buffer when possible.</p>



<a name="486232010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232010">(Dec 05 2024 at 06:03)</a>:</h4>
<p>Then everyone can just use this by default and get speed boosts</p>



<a name="486232164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232164">(Dec 05 2024 at 06:04)</a>:</h4>
<p>Also, all of these test apps like expected speed almost all time in the read system call. Go has more async io and scheduler overhead. The version that always allocated spends more time freeing and calculating capacity (I assume this is a fail on the perf tool and actually is allocating)</p>



<a name="486232329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232329">(Dec 05 2024 at 06:06)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486231817">said</a>:</p>
<blockquote>
<p>Reading hole file definitely should not be that show (but basic CLI really has not been optimized yet)</p>
</blockquote>
<p>Hahah yeah, I agree. <br>
And the API will be the same, I just wanted more control while I was testing.</p>



<a name="486232598"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232598" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232598">(Dec 05 2024 at 06:09)</a>:</h4>
<p>It'd be good to have a new API as well that takes any reader and buf and "consumes and returns that buff" if it's unique. That way you could do some fancy multi buffer things with reuse.</p>



<a name="486232682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232682">(Dec 05 2024 at 06:10)</a>:</h4>
<p>I don't think that really fits basic-cli, but maybe</p>



<a name="486232781"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232781" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232781">(Dec 05 2024 at 06:11)</a>:</h4>
<p>Also, reading whole file is just <code>File.readBytes!</code>?</p>



<a name="486232796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232796">(Dec 05 2024 at 06:11)</a>:</h4>
<p>Yup</p>



<a name="486232797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232797">(Dec 05 2024 at 06:11)</a>:</h4>
<p>Or are you talking still through the reader?</p>



<a name="486232992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486232992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486232992">(Dec 05 2024 at 06:13)</a>:</h4>
<p>I think in the long term it'd be good to have a standardized reader/ stream standard or maybe ability.</p>
<p>That way folks can write platform agnostic roc code that Interfaces with byte streams.</p>
<p>That is a proposal from another day though <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="486233124"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233124" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233124">(Dec 05 2024 at 06:15)</a>:</h4>
<p>For me, reading the whole file at once is about 3x slower than this new code. No where near the speedup you are seeing.</p>



<a name="486233159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233159">(Dec 05 2024 at 06:15)</a>:</h4>
<p>Oh interesting, I did think it was odd. I'll have to investigate later. <br>
How big if your file?</p>



<a name="486233277"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233277" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233277">(Dec 05 2024 at 06:16)</a>:</h4>
<p>Mines about 400mb</p>



<a name="486233351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233351">(Dec 05 2024 at 06:17)</a>:</h4>
<p>80 megabytes</p>



<a name="486233371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233371">(Dec 05 2024 at 06:17)</a>:</h4>
<p>That's my code:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">testRawReadSpeed</span><span class="err">!</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">len</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="mi">8000</span>
<span class="w">    </span><span class="nv">res</span><span class="nf">=</span><span class="w"> </span><span class="nv">try</span><span class="w"> </span><span class="p">(</span><span class="kt">File</span><span class="nf">.</span><span class="nv">readBytes</span><span class="err">!</span><span class="w"> </span><span class="s">"input.txt"</span><span class="p">)</span>
<span class="w">    </span><span class="nv">done</span><span class="nf">=</span><span class="nv">res</span><span class="nf">|&gt;</span><span class="kt">List</span><span class="nf">.</span><span class="nv">len</span>

<span class="w">    </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"done!!$(Inspect.toStr (done))"</span>

<span class="nv">main</span><span class="err">!</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">try</span><span class="w"> </span><span class="p">(</span><span class="nv">testRawReadSpeed</span><span class="err">!</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">onErr</span><span class="err">!</span><span class="w"> </span><span class="nf">\</span><span class="nv">a</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Inspect</span><span class="nf">.</span><span class="nv">toStr</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="p">)</span>
<span class="w">    </span><span class="nv">try</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"done!"</span>
<span class="w">    </span><span class="kt">Ok</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>



<a name="486233372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233372">(Dec 05 2024 at 06:17)</a>:</h4>
<p>Of random base64 text</p>



<a name="486233468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233468">(Dec 05 2024 at 06:18)</a>:</h4>
<p>Yeah, my code is equivalent</p>



<a name="486233487"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233487" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233487">(Dec 05 2024 at 06:18)</a>:</h4>
<p>that's super duper wierd</p>



<a name="486233517"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233517" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233517">(Dec 05 2024 at 06:19)</a>:</h4>
<p>Spends 75% of the time in read and 25% copying bytes from the rust vector to the roc list</p>



<a name="486233661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233661">(Dec 05 2024 at 06:20)</a>:</h4>
<p>Did you accidentally build either the platform or roc without optimization? Also are you sure it is the same input file that your other test saw?</p>



<a name="486233743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233743">(Dec 05 2024 at 06:21)</a>:</h4>
<p>wait a minute... I'm stupid. I was using the wrong script. Like an absolute moron <span aria-label="man facepalming" class="emoji emoji-1f926-200d-2642" role="img" title="man facepalming">:man_facepalming:</span> </p>
<div class="codehilite"><pre><span></span><code>whole-file
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          1.78s  Â± 2.36ms    1.78s  â€¦ 1.78s           0 ( 0%)        0%
  peak_rss            822MB Â± 75.7KB     821MB â€¦  822MB          0 ( 0%)        0%
  cpu_cycles          974M  Â± 2.49M      972M  â€¦  977M           0 ( 0%)        0%
  instructions       3.28G  Â±  226      3.28G  â€¦ 3.28G           0 ( 0%)        0%
  cache_references   6.15M  Â± 20.8K     6.13M  â€¦ 6.17M           0 ( 0%)        0%
  cache_misses       1.57M  Â± 27.6K     1.54M  â€¦ 1.59M           0 ( 0%)        0%
  branch_misses      5.07K  Â±  163      4.89K  â€¦ 5.21K           0 ( 0%)        0%
Benchmark 2 (31 runs): ./buf-reuse
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time           164ms Â± 4.49ms     159ms â€¦  176ms          3 (10%)        âš¡- 90.8% Â±  0.3%
  peak_rss           2.69MB Â±  101KB    2.49MB â€¦ 2.88MB          0 ( 0%)        âš¡- 99.7% Â±  0.0%
  cpu_cycles         7.01M  Â±  225K     6.77M  â€¦ 7.57M           3 (10%)        âš¡- 99.3% Â±  0.1%
  instructions       10.1M  Â± 1.25K     10.1M  â€¦ 10.1M           2 ( 6%)        âš¡- 99.7% Â±  0.0%
  cache_references   20.6K  Â± 1.12K     18.2K  â€¦ 22.7K           0 ( 0%)        âš¡- 99.7% Â±  0.1%
  cache_misses       8.89K  Â±  239      8.03K  â€¦ 9.31K           1 ( 3%)        âš¡- 99.4% Â±  0.5%
  branch_misses      5.54K  Â±  165      5.30K  â€¦ 5.85K           0 ( 0%)        ðŸ’©+  9.3% Â±  4.0%
</code></pre></div>



<a name="486233769"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233769" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233769">(Dec 05 2024 at 06:21)</a>:</h4>
<p>my laptop isn't plugged in anymore btw</p>



<a name="486233891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486233891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486233891">(Dec 05 2024 at 06:22)</a>:</h4>
<p>Let me make a bigger file to see if the time diff grows</p>



<a name="486234081"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486234081" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486234081">(Dec 05 2024 at 06:24)</a>:</h4>
<p>Haha...that made the diff closer....</p>



<a name="486234130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486234130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486234130">(Dec 05 2024 at 06:25)</a>:</h4>
<p>wait, closer to each other, or closer to my results?</p>



<a name="486234283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486234283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486234283">(Dec 05 2024 at 06:26)</a>:</h4>
<p>closer to eachother:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>du<span class="w"> </span>-hs<span class="w"> </span>--apparent-size<span class="w"> </span>input.txt
611M<span class="w">    </span>input.txt
$<span class="w"> </span>poop<span class="w"> </span>./read-speed<span class="w"> </span>./read-speed-test<span class="w"> </span>./read-speed-test-fast
Benchmark<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">(</span><span class="m">3</span><span class="w"> </span>runs<span class="o">)</span>:<span class="w"> </span>./read-speed
<span class="w">  </span>measurement<span class="w">          </span>mean<span class="w"> </span>Â±<span class="w"> </span>Ïƒ<span class="w">            </span>min<span class="w"> </span>â€¦<span class="w"> </span>max<span class="w">           </span>outliers<span class="w">         </span>delta
<span class="w">  </span>wall_time<span class="w">          </span><span class="m">1</span>.74s<span class="w">  </span>Â±<span class="w">  </span>107ms<span class="w">    </span><span class="m">1</span>.64s<span class="w">  </span>â€¦<span class="w"> </span><span class="m">1</span>.85s<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span><span class="m">0</span>%
<span class="w">  </span>peak_rss<span class="w">           </span><span class="m">3</span>.10MB<span class="w"> </span>Â±<span class="w"> </span><span class="m">2</span>.36KB<span class="w">    </span><span class="m">3</span>.10MB<span class="w"> </span>â€¦<span class="w"> </span><span class="m">3</span>.10MB<span class="w">          </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span><span class="m">0</span>%
<span class="w">  </span>cpu_cycles<span class="w">         </span><span class="m">86</span>.6M<span class="w">  </span>Â±<span class="w"> </span><span class="m">10</span>.9M<span class="w">     </span><span class="m">74</span>.0M<span class="w">  </span>â€¦<span class="w"> </span><span class="m">93</span>.3M<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span><span class="m">0</span>%
<span class="w">  </span>instructions<span class="w">       </span><span class="m">91</span>.8M<span class="w">  </span>Â±<span class="w"> </span><span class="m">13</span>.0M<span class="w">     </span><span class="m">76</span>.9M<span class="w">  </span>â€¦<span class="w">  </span>101M<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span><span class="m">0</span>%
<span class="w">  </span>cache_references<span class="w">   </span><span class="m">6</span>.76M<span class="w">  </span>Â±<span class="w">  </span>390K<span class="w">     </span><span class="m">6</span>.35M<span class="w">  </span>â€¦<span class="w"> </span><span class="m">7</span>.13M<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span><span class="m">0</span>%
<span class="w">  </span>cache_misses<span class="w">        </span>119K<span class="w">  </span>Â±<span class="w"> </span><span class="m">51</span>.5K<span class="w">     </span><span class="m">84</span>.5K<span class="w">  </span>â€¦<span class="w">  </span>178K<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span><span class="m">0</span>%
<span class="w">  </span>branch_misses<span class="w">       </span>229K<span class="w">  </span>Â±<span class="w"> </span><span class="m">15</span>.6K<span class="w">      </span>218K<span class="w">  </span>â€¦<span class="w">  </span>247K<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span><span class="m">0</span>%
Benchmark<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="o">(</span><span class="m">3</span><span class="w"> </span>runs<span class="o">)</span>:<span class="w"> </span>./read-speed-test
<span class="w">  </span>measurement<span class="w">          </span>mean<span class="w"> </span>Â±<span class="w"> </span>Ïƒ<span class="w">            </span>min<span class="w"> </span>â€¦<span class="w"> </span>max<span class="w">           </span>outliers<span class="w">         </span>delta
<span class="w">  </span>wall_time<span class="w">          </span><span class="m">2</span>.07s<span class="w">  </span>Â±<span class="w">  </span>205ms<span class="w">    </span><span class="m">1</span>.83s<span class="w">  </span>â€¦<span class="w"> </span><span class="m">2</span>.20s<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">          </span>+<span class="w"> </span><span class="m">18</span>.8%<span class="w"> </span>Â±<span class="w"> </span><span class="m">21</span>.3%
<span class="w">  </span>peak_rss<span class="w">           </span><span class="m">1</span>.28GB<span class="w"> </span>Â±<span class="w"> </span><span class="m">76</span>.9KB<span class="w">    </span><span class="m">1</span>.28GB<span class="w"> </span>â€¦<span class="w"> </span><span class="m">1</span>.28GB<span class="w">          </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>ðŸ’©+41241.8%<span class="w"> </span>Â±<span class="w">  </span><span class="m">4</span>.0%
<span class="w">  </span>cpu_cycles<span class="w">         </span><span class="m">1</span>.57G<span class="w">  </span>Â±<span class="w"> </span><span class="m">3</span>.00M<span class="w">     </span><span class="m">1</span>.57G<span class="w">  </span>â€¦<span class="w"> </span><span class="m">1</span>.57G<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>ðŸ’©+1715.0%<span class="w"> </span>Â±<span class="w"> </span><span class="m">21</span>.0%
<span class="w">  </span>instructions<span class="w">       </span><span class="m">5</span>.12G<span class="w">  </span>Â±<span class="w"> </span><span class="m">55</span>.1<span class="w">      </span><span class="m">5</span>.12G<span class="w">  </span>â€¦<span class="w"> </span><span class="m">5</span>.12G<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>ðŸ’©+5478.9%<span class="w"> </span>Â±<span class="w"> </span><span class="m">22</span>.7%
<span class="w">  </span>cache_references<span class="w">   </span><span class="m">44</span>.2M<span class="w">  </span>Â±<span class="w">  </span>191K<span class="w">     </span><span class="m">44</span>.0M<span class="w">  </span>â€¦<span class="w"> </span><span class="m">44</span>.4M<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>ðŸ’©+554.3%<span class="w"> </span>Â±<span class="w"> </span><span class="m">10</span>.3%
<span class="w">  </span>cache_misses<span class="w">       </span><span class="m">16</span>.3M<span class="w">  </span>Â±<span class="w"> </span><span class="m">18</span>.5K<span class="w">     </span><span class="m">16</span>.3M<span class="w">  </span>â€¦<span class="w"> </span><span class="m">16</span>.3M<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>ðŸ’©+13639.3%<span class="w"> </span>Â±<span class="w"> </span><span class="m">74</span>.0%
<span class="w">  </span>branch_misses<span class="w">      </span><span class="m">6</span>.16K<span class="w">  </span>Â±<span class="w"> </span><span class="m">61</span>.2<span class="w">      </span><span class="m">6</span>.09K<span class="w">  </span>â€¦<span class="w"> </span><span class="m">6</span>.22K<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>âš¡-<span class="w"> </span><span class="m">97</span>.3%<span class="w"> </span>Â±<span class="w"> </span><span class="m">10</span>.9%
Benchmark<span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="o">(</span><span class="m">4</span><span class="w"> </span>runs<span class="o">)</span>:<span class="w"> </span>./read-speed-test-fast
<span class="w">  </span>measurement<span class="w">          </span>mean<span class="w"> </span>Â±<span class="w"> </span>Ïƒ<span class="w">            </span>min<span class="w"> </span>â€¦<span class="w"> </span>max<span class="w">           </span>outliers<span class="w">         </span>delta
<span class="w">  </span>wall_time<span class="w">          </span><span class="m">1</span>.64s<span class="w">  </span>Â±<span class="w">  </span>169ms<span class="w">    </span><span class="m">1</span>.49s<span class="w">  </span>â€¦<span class="w"> </span><span class="m">1</span>.80s<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">          </span>-<span class="w">  </span><span class="m">5</span>.5%<span class="w"> </span>Â±<span class="w"> </span><span class="m">16</span>.6%
<span class="w">  </span>peak_rss<span class="w">           </span><span class="m">3</span>.66MB<span class="w"> </span>Â±<span class="w"> </span><span class="m">64</span>.2KB<span class="w">    </span><span class="m">3</span>.56MB<span class="w"> </span>â€¦<span class="w"> </span><span class="m">3</span>.69MB<span class="w">          </span><span class="m">1</span><span class="w"> </span><span class="o">(</span><span class="m">25</span>%<span class="o">)</span><span class="w">        </span>ðŸ’©+<span class="w"> </span><span class="m">18</span>.1%<span class="w"> </span>Â±<span class="w">  </span><span class="m">3</span>.2%
<span class="w">  </span>cpu_cycles<span class="w">         </span><span class="m">13</span>.3M<span class="w">  </span>Â±<span class="w">  </span>453K<span class="w">     </span><span class="m">12</span>.7M<span class="w">  </span>â€¦<span class="w"> </span><span class="m">13</span>.8M<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>âš¡-<span class="w"> </span><span class="m">84</span>.7%<span class="w"> </span>Â±<span class="w"> </span><span class="m">15</span>.7%
<span class="w">  </span>instructions<span class="w">       </span><span class="m">12</span>.7M<span class="w">  </span>Â±<span class="w"> </span><span class="m">28</span>.7<span class="w">      </span><span class="m">12</span>.7M<span class="w">  </span>â€¦<span class="w"> </span><span class="m">12</span>.7M<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>âš¡-<span class="w"> </span><span class="m">86</span>.2%<span class="w"> </span>Â±<span class="w"> </span><span class="m">17</span>.6%
<span class="w">  </span>cache_references<span class="w">    </span>563K<span class="w">  </span>Â±<span class="w"> </span><span class="m">66</span>.3K<span class="w">      </span>513K<span class="w">  </span>â€¦<span class="w">  </span>661K<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>âš¡-<span class="w"> </span><span class="m">91</span>.7%<span class="w"> </span>Â±<span class="w">  </span><span class="m">7</span>.3%
<span class="w">  </span>cache_misses<span class="w">       </span><span class="m">17</span>.6K<span class="w">  </span>Â±<span class="w"> </span><span class="m">1</span>.36K<span class="w">     </span><span class="m">16</span>.3K<span class="w">  </span>â€¦<span class="w"> </span><span class="m">19</span>.1K<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>âš¡-<span class="w"> </span><span class="m">85</span>.2%<span class="w"> </span>Â±<span class="w"> </span><span class="m">54</span>.0%
<span class="w">  </span>branch_misses<span class="w">      </span><span class="m">7</span>.99K<span class="w">  </span>Â±<span class="w">  </span><span class="m">272</span><span class="w">      </span><span class="m">7</span>.75K<span class="w">  </span>â€¦<span class="w"> </span><span class="m">8</span>.34K<span class="w">           </span><span class="m">0</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="m">0</span>%<span class="o">)</span><span class="w">        </span>âš¡-<span class="w"> </span><span class="m">96</span>.5%<span class="w"> </span>Â±<span class="w">  </span><span class="m">8</span>.4%
</code></pre></div>
<p>This is go, whole file, then your new code.</p>



<a name="486234592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486234592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486234592">(Dec 05 2024 at 06:29)</a>:</h4>
<p>oh, well this is quite strange... I've go no idea. my only guess at this point is that because I'm using a pretty low power laptop I've got way less cache or my ram is way slower or something so the cost of loading this big ol chunk of memory is higher.</p>



<a name="486234935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486234935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486234935">(Dec 05 2024 at 06:33)</a>:</h4>
<p>I am using a beefy gaming laptop (though a bit dated at this point). So yeah, probably something like that. (also, my system is a bit complicated, zfs filesystem with compression, not sure exactly how file caching pans out) 100% could be system differences that make your system less friendly to loading files in really large chunks (or more realistically makes mine less friendly to loading in small chunks).</p>



<a name="486235186"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486235186" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486235186">(Dec 05 2024 at 06:35)</a>:</h4>
<p>out of curiousity, could you run: <code>sudo -v; du -hs input.txt; hyperfine --prepare 'sync; echo 3 | sudo tee /proc/sys/vm/drop_caches' -w0 -r5 ./whole-file ./buf-reuse</code></p>



<a name="486235522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486235522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486235522">(Dec 05 2024 at 06:38)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Whole file:
  Time (mean Â± Ïƒ):      1.930 s Â±  0.018 s    [User: 0.952 s, System: 0.944 s]
  Range (min â€¦ max):    1.913 s â€¦  1.955 s    5 runs
reuse:
   Time (mean Â± Ïƒ):     371.8 ms Â±   5.8 ms    [User: 10.0 ms, System: 294.5 ms]
  Range (min â€¦ max):   366.5 ms â€¦ 378.6 ms    5 runs

Summary
  ./buf-reuse ran
    5.19 Â± 0.09 times faster than ./readWhole
</code></pre></div>



<a name="486235735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486235735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486235735">(Dec 05 2024 at 06:40)</a>:</h4>
<p>Can I also get the exact size of your <code>input.txt</code>: <code>du -hs input.txt</code></p>



<a name="486235772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486235772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486235772">(Dec 05 2024 at 06:41)</a>:</h4>
<p>391M    ./input.txt</p>



<a name="486235878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486235878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486235878">(Dec 05 2024 at 06:42)</a>:</h4>
<p>I can't imagine this matters but the content isn't really random. It's mostly the same really long line copied</p>



<a name="486235914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486235914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486235914">(Dec 05 2024 at 06:42)</a>:</h4>
<p>If you don't have compression on your filesystem, it shouldn't matter</p>



<a name="486236043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486236043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486236043">(Dec 05 2024 at 06:43)</a>:</h4>
<p>Anyway, really cool. Hoping this isn't a fluke and a number of people that aren't me will see perf gains like that. (though we also should totally make reading bytes to end read directly to a roc list).</p>



<a name="486236236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486236236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486236236">(Dec 05 2024 at 06:45)</a>:</h4>
<p>This was fun. I'll definitely update all the reading api's to use this trick.</p>



<a name="486236532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486236532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486236532">(Dec 05 2024 at 06:48)</a>:</h4>
<p>When we get parallelism it'd be cool to use a pair of buffers to make an alternating buffer loop that runs the read handler with one buffer and then reads into the other one then swaps them when both tasks are done.</p>



<a name="486236705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486236705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486236705">(Dec 05 2024 at 06:50)</a>:</h4>
<p>Also, even on my machine, I would expect that reading the whole file would only be a few percent faster than than reading in chunks. (and it would use a crap ton more memory).</p>



<a name="486236774"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486236774" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486236774">(Dec 05 2024 at 06:50)</a>:</h4>
<p>So this setup is still much nicer for many many use cases</p>



<a name="486237171"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486237171" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486237171">(Dec 05 2024 at 06:54)</a>:</h4>
<p>I think I would have intuitively thought the opposite. <br>
I guess you're saying you'd expect the file system api overhead is more than that of allocating a huge block of memory?<br>
I wonder if there would be an inflection point? <br>
Like I assume reading from a tcp socket is faster than from the filesystem?</p>



<a name="486237260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486237260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486237260">(Dec 05 2024 at 06:55)</a>:</h4>
<p>I've not actually got any experience benchmarking any of this, so I just have a vague hunch <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="486237659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486237659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486237659">(Dec 05 2024 at 06:59)</a>:</h4>
<blockquote>
<p>I guess you're saying you'd expect the file system api overhead is more than that of allocating a huge block of memory?</p>
</blockquote>
<p>A single large allocation is pretty cheap if you have free ram. The file api has to copy data. Copying data is always slow.</p>



<a name="486237771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486237771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486237771">(Dec 05 2024 at 07:00)</a>:</h4>
<blockquote>
<p>Like I assume reading from a tcp socket is faster than from the filesystem?</p>
</blockquote>
<p>Assuming the data is ready and you don't have to wait on network io, should be equivalent to reading from a filesystem in ram most of the time.</p>



<a name="486238029"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486238029" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486238029">(Dec 05 2024 at 07:02)</a>:</h4>
<p>That all makes sense. <br>
Well I'll be keen to see if with this approach the whole file read ends up faster!</p>



<a name="486239101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486239101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486239101">(Dec 05 2024 at 07:11)</a>:</h4>
<p>maybe not on your system, but should be on mine</p>



<a name="486239213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486239213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486239213">(Dec 05 2024 at 07:12)</a>:</h4>
<p>Also, if you are willing to give me more metrics (hoping you have the same perf counters), can you run this on each app:<br>
<code>perf stat -B -e cache-references,cache-misses,cycles,instructions,branches,branch-misses,faults,migrations,cycle_activity.stalls_total,resource_stalls.any</code></p>



<a name="486239277"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486239277" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486239277">(Dec 05 2024 at 07:12)</a>:</h4>
<p>I'm guessing I should compile with --profiling and the leagcy linker?</p>



<a name="486239467"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486239467" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486239467">(Dec 05 2024 at 07:14)</a>:</h4>
<p>and <code>--optimize</code> of course</p>



<a name="486239530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486239530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486239530">(Dec 05 2024 at 07:15)</a>:</h4>
<p>Though this is just aggregate cpu counter stats, so I guess <code>--profiling</code> and legacy linker shouldn't actually make a difference.</p>



<a name="486239703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486239703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486239703">(Dec 05 2024 at 07:16)</a>:</h4>
<p>oh good, because my self built version of roc cannot call the legacy linker and I don't want to have nix build a version that can because that takes ages <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="486240070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486240070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486240070">(Dec 05 2024 at 07:18)</a>:</h4>
<p>Yeah, probably fine to run on the same executables you had above</p>



<a name="486240129"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486240129" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486240129">(Dec 05 2024 at 07:18)</a>:</h4>
<div class="codehilite"><pre><span></span><code>starting
done!!(Ok 553462367)

 Performance counter stats for &#39;./buf-reuse&#39;:

        10,032,011      cache-references
         6,953,420      cache-misses                     #   69.31% of all cache refs
       389,319,100      cycles
       595,658,461      instructions                     #    1.53  insn per cycle
       120,573,534      branches
           169,221      branch-misses                    #    0.14% of all branches
               114      faults
                 5      migrations

       0.458919494 seconds time elapsed

       0.010922000 seconds user
       0.378975000 seconds sys
</code></pre></div>
<div class="codehilite"><pre><span></span><code>done!!553462367
done!

 Performance counter stats for &#39;./readWhole&#39;:

        38,754,204      cache-references
        25,693,393      cache-misses                     #   66.30% of all cache refs
     2,433,906,387      cycles
     5,815,782,790      instructions                     #    2.39  insn per cycle
       829,527,258      branches
           218,738      branch-misses                    #    0.03% of all branches
           270,342      faults
                 1      migrations

       2.451330888 seconds time elapsed

       1.286101000 seconds user
       1.138542000 seconds sys
</code></pre></div>



<a name="486240189"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486240189" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486240189">(Dec 05 2024 at 07:19)</a>:</h4>
<p>I had to remove the last two events because it said they were invalid</p>



<a name="486240336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486240336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486240336">(Dec 05 2024 at 07:20)</a>:</h4>
<p>Oh it's going to take a little longer now btw, my file is a little bigger because I converted it base64 when I made that comment about it not being random just to be totally sure</p>



<a name="486240460"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486240460" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486240460">(Dec 05 2024 at 07:21)</a>:</h4>
<blockquote>
<p>I had to remove the last two events because it said they were invalid</p>
</blockquote>
<p><span aria-label="tear" class="emoji emoji-1f972" role="img" title="tear">:tear:</span></p>



<a name="486240803"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486240803" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486240803">(Dec 05 2024 at 07:24)</a>:</h4>
<p>Apparently they are not supported in any modern intel cpus.</p>



<a name="486241735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486241735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486241735">(Dec 05 2024 at 07:32)</a>:</h4>
<p>Ok, most interesting notes of difference:</p>
<ol>
<li>your machine simply is running way way less instructions than mine (especially for the reuse case, ~10x less)</li>
<li>you have a much higher cache miss ratio, but also a lot less cache references overall. (like 5-8x less cache references)</li>
</ol>
<p>Overall, In both cases, your system is doing a lot less than mine. It seems likely that my memory hierarchy is solidly faster than yours (at least the outer level caches, maybe not the small close to cpu caches that the reuse stays in).</p>



<a name="486242286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242286">(Dec 05 2024 at 07:36)</a>:</h4>
<p>Hey, great news!</p>



<a name="486242292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242292">(Dec 05 2024 at 07:36)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Architecture:             x86_64
  CPU op-mode(s):         32-bit, 64-bit
  Address sizes:          39 bits physical, 48 bits virtual
  Byte Order:             Little Endian
CPU(s):                   8
  On-line CPU(s) list:    0-7
Vendor ID:                GenuineIntel
  Model name:             11th Gen Intel(R) Core(TM) i7-1185G7 @ 3.00GHz
    CPU family:           6
    Model:                140
    Thread(s) per core:   2
    Core(s) per socket:   4
    Socket(s):            1
    Stepping:             1
    CPU(s) scaling MHz:   20%
    CPU max MHz:          4800.0000
    CPU min MHz:          400.0000
    BogoMIPS:             5990.40
arch_capabilities
Virtualization features:
  Virtualization:         VT-x
Caches (sum of all):
  L1d:                    192 KiB (4 instances)
  L1i:                    128 KiB (4 instances)
  L2:                     5 MiB (4 instances)
  L3:                     12 MiB (1 instance)
NUMA:
  NUMA node(s):           1
  NUMA node0 CPU(s):      0-7
Vulnerabilities:
</code></pre></div>



<a name="486242344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242344">(Dec 05 2024 at 07:37)</a>:</h4>
<p>I just had the bright idea to get my filesystem, compression, zfs special caching out of the way! Ran everything in a <code>tmpfs</code> (so from ram)</p>



<a name="486242356"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242356" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242356">(Dec 05 2024 at 07:37)</a>:</h4>
<p>I now see about a 5x perf improvement with buffer reuse</p>



<a name="486242383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242383">(Dec 05 2024 at 07:37)</a>:</h4>
<p>hey!!! That's familar</p>



<a name="486242423"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242423" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242423">(Dec 05 2024 at 07:38)</a>:</h4>
<p>So I bet many other people will see that too!</p>



<a name="486242476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242476">(Dec 05 2024 at 07:38)</a>:</h4>
<p>Pretty much the exact same. Excellent!</p>



<a name="486242596"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242596" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242596">(Dec 05 2024 at 07:39)</a>:</h4>
<p>Interesting extra note from the benchmark. reading in one go should be about the same speed as reading with the buffer</p>



<a name="486242651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242651">(Dec 05 2024 at 07:39)</a>:</h4>
<p>it spends 20% of the time reading to the rust vec and 80% of the time copying that to the roc list</p>



<a name="486242765"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242765" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242765">(Dec 05 2024 at 07:40)</a>:</h4>
<p>Not user why it isn't just a memcpy and a lot faster</p>



<a name="486242811"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242811" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242811">(Dec 05 2024 at 07:41)</a>:</h4>
<p>But if we read straight to the roc list, would be about 5x faster and a toss up which version is fastest</p>



<a name="486242912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486242912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486242912">(Dec 05 2024 at 07:41)</a>:</h4>
<p>haha, I was just writing the exact same thing, surprising that it's slower to read from the FS than a vec in rust</p>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486242765">said</a>:</p>
<blockquote>
<p>Not user why it isn't just a memcpy and a lot faster</p>
</blockquote>



<a name="486243041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486243041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486243041">(Dec 05 2024 at 07:42)</a>:</h4>
<p>I feel like the major thing I've learned here is your system setup as far as filesystem and things can make a kind of shocking difference to Filesystem calls.</p>



<a name="486243043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486243043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486243043">(Dec 05 2024 at 07:42)</a>:</h4>
<p>Found out why...roc std is accidentally pessimizing everything. It is worried about refcounts of the inner elements</p>



<a name="486243067"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486243067" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486243067">(Dec 05 2024 at 07:42)</a>:</h4>
<p>Which there are none cause this is a list u8</p>



<a name="486243591"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486243591" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486243591">(Dec 05 2024 at 07:46)</a>:</h4>
<blockquote>
<p>your system setup</p>
</blockquote>
<p>My system is pretty crazy to be fair. Everything is automatically compressed and decompressed when reading/writing. Zfs uses the arc instead of (along with?) the normal linux filesystem cache. My system snapshots like every 15 minutes and I can teleport the entire system back to an older version.</p>



<a name="486243827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486243827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486243827">(Dec 05 2024 at 07:48)</a>:</h4>
<p>Hahaha, when I started that, I thought "can't be that crazy" I was absolutely mistaken. That's crazy <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="486296207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486296207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486296207">(Dec 05 2024 at 12:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486233517">said</a>:</p>
<blockquote>
<p>Spends 75% of the time in read and 25% copying bytes from the rust vector to the roc list</p>
</blockquote>
<p>we could cut this 25% out by skipping the Vec middleman and calling OS file APIs directly! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="486298127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486298127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486298127">(Dec 05 2024 at 12:52)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> <br>
I think you may have not quite understood while skimming, we did jump around a lot:</p>
<p>What Brendan was seeing in that quote, was his uniquely odd file system, making the read super slow. </p>
<p>The conclusion of this was that we will use the same technique as my expirimental buffered read for the full file read. <br>
Directly calling <code>read</code> on the File handle in rust and giving it the internal slice of a roc list as the destination for that read. </p>
<p>Unless I'm not understanding you <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="486305725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486305725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486305725">(Dec 05 2024 at 13:31)</a>:</h4>
<p>ah nice! that makes sense <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="486346593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486346593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486346593">(Dec 05 2024 at 16:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486242651">said</a>:</p>
<blockquote>
<p>it spends 20% of the time reading to the rust vec and 80% of the time copying that to the roc list</p>
</blockquote>
<p><span class="user-mention" data-user-id="651372">@Eli Dowling</span>, don't forget this comment. Looks like we could cut out about 80% of the time from the rust vec middle man.</p>



<a name="486346783"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486346783" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486346783">(Dec 05 2024 at 16:31)</a>:</h4>
<p>So full files read doesn't need your buffered read. They just need to not write to a rust vector</p>



<a name="486351578"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486351578" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486351578">(Dec 05 2024 at 16:53)</a>:</h4>
<p><span class="user-mention" data-user-id="651372">@Eli Dowling</span> can you try this?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_fileReadBytes</span><span class="p">(</span><span class="n">roc_path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">File</span><span class="p">::</span><span class="n">open</span><span class="p">(</span><span class="n">path_from_roc_path</span><span class="p">(</span><span class="n">roc_path</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">file</span>
<span class="w">                </span><span class="p">.</span><span class="n">metadata</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">m</span><span class="o">|</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">len</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"TODO: make robust: file has not size?"</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocList</span><span class="p">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">buf_slice</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">std</span><span class="p">::</span><span class="n">slice</span><span class="p">::</span><span class="n">from_raw_parts_mut</span><span class="p">(</span><span class="n">buf_list</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">buf_list</span><span class="p">.</span><span class="n">capacity</span><span class="p">())</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="n">read_exact</span><span class="p">(</span><span class="n">buf_slice</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(())</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">out_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">RocList</span><span class="p">::</span><span class="n">from_raw_parts</span><span class="p">(</span>
<span class="w">                            </span><span class="n">buf_list</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">buf_list</span><span class="p">.</span><span class="n">capacity</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">buf_list</span><span class="p">.</span><span class="n">capacity</span><span class="p">(),</span>
<span class="w">                        </span><span class="p">)</span>
<span class="w">                    </span><span class="p">};</span>
<span class="w">                    </span><span class="n">std</span><span class="p">::</span><span class="n">mem</span><span class="p">::</span><span class="n">forget</span><span class="p">(</span><span class="n">buf_list</span><span class="p">);</span>

<span class="w">                    </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(</span><span class="n">out_list</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RocResult</span><span class="p">::</span><span class="n">err</span><span class="p">(</span><span class="n">toRocReadError</span><span class="p">(</span><span class="n">err</span><span class="p">)),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">RocResult</span><span class="p">::</span><span class="n">err</span><span class="p">(</span><span class="n">toRocReadError</span><span class="p">(</span><span class="n">err</span><span class="p">)),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="486351790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486351790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486351790">(Dec 05 2024 at 16:54)</a>:</h4>
<p>I see this on a tmpfs:</p>
<div class="codehilite"><pre><span></span><code>enchmark 1 (69 runs): whole-file
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          71.6ms Â± 1.46ms    69.7ms â€¦ 76.7ms          4 ( 6%)        0%
  peak_rss            412MB Â± 83.8KB     412MB â€¦  412MB          0 ( 0%)        0%
  cpu_cycles          685K  Â± 9.84K      656K  â€¦  716K           2 ( 3%)        0%
  instructions        425K  Â± 1.62       425K  â€¦  425K           0 ( 0%)        0%
  cache_references   28.6K  Â±  560      27.0K  â€¦ 30.6K           3 ( 4%)        0%
  cache_misses       14.4K  Â±  189      14.1K  â€¦ 14.9K           0 ( 0%)        0%
  branch_misses      5.53K  Â± 97.3      5.01K  â€¦ 5.76K           2 ( 3%)        0%
Benchmark 2 (68 runs): buf-reuse
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          72.1ms Â± 1.33ms    70.5ms â€¦ 77.2ms          6 ( 9%)          +  0.6% Â±  0.7%
  peak_rss           3.97MB Â±  102KB    3.76MB â€¦ 4.29MB          2 ( 3%)        âš¡- 99.0% Â±  0.0%
  cpu_cycles         6.93M  Â±  302K     6.55M  â€¦ 8.32M           4 ( 6%)        ðŸ’©+911.7% Â± 10.4%
  instructions       8.22M  Â± 3.22      8.22M  â€¦ 8.22M           1 ( 1%)        ðŸ’©+1832.1% Â±  0.0%
  cache_references   67.4K  Â± 13.7K     43.6K  â€¦  103K           0 ( 0%)        ðŸ’©+135.4% Â± 11.3%
  cache_misses       14.5K  Â±  273      14.0K  â€¦ 16.3K           1 ( 1%)          +  0.3% Â±  0.5%
  branch_misses      13.6K  Â± 6.66K     5.64K  â€¦ 42.1K           4 ( 6%)        ðŸ’©+146.7% Â± 28.4%
</code></pre></div>



<a name="486351807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486351807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486351807">(Dec 05 2024 at 16:54)</a>:</h4>
<p>which matches what I expected</p>



<a name="486352797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486352797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486352797">(Dec 05 2024 at 16:58)</a>:</h4>
<p>Basically this is saying that in a compute heavy situation, the whole file should be better (way less cycles, instructions, and branch misses). In a memory heavy situation, obviously, the reuse is better.</p>



<a name="486357782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486357782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486357782">(Dec 05 2024 at 17:23)</a>:</h4>
<p>I'm still seeing a really large difference</p>
<div class="codehilite"><pre><span></span><code>Benchmark 1 (61 runs): ./buf-reuse
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          81.8ms Â± 3.21ms    75.2ms â€¦ 97.4ms          5 ( 8%)        0%
  peak_rss           2.75MB Â± 16.8KB    2.62MB â€¦ 2.75MB          1 ( 2%)        0%
  cpu_cycles         6.96M  Â±  336K     6.79M  â€¦ 8.70M           7 (11%)        0%
  instructions       10.1M  Â± 2.16      10.1M  â€¦ 10.1M           0 ( 0%)        0%
  cache_references   20.6K  Â±  751      17.1K  â€¦ 22.1K           1 ( 2%)        0%
  cache_misses       12.1K  Â±  623      9.00K  â€¦ 13.3K           1 ( 2%)        0%
  branch_misses      4.75K  Â±  340      3.79K  â€¦ 5.58K           3 ( 5%)        0%
Benchmark 2 (7 runs): ./readWhole
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time           812ms Â± 3.87ms     808ms â€¦  818ms          0 ( 0%)        ðŸ’©+892.2% Â±  3.2%
  peak_rss            822MB Â± 70.1KB     822MB â€¦  822MB          0 ( 0%)        ðŸ’©+29773.0% Â±  0.8%
  cpu_cycles          984M  Â± 8.03M      978M  â€¦ 1.00G           0 ( 0%)        ðŸ’©+14037.7% Â± 28.0%
  instructions       3.28G  Â± 34.8      3.28G  â€¦ 3.28G           0 ( 0%)        ðŸ’©+32490.8% Â±  0.0%
  cache_references   5.89M  Â± 30.8K     5.84M  â€¦ 5.94M           0 ( 0%)        ðŸ’©+28474.6% Â± 36.1%
  cache_misses       1.65M  Â± 9.12K     1.63M  â€¦ 1.66M           0 ( 0%)        ðŸ’©+13588.0% Â± 18.6%
  branch_misses      4.93K  Â±  188      4.62K  â€¦ 5.12K           0 ( 0%)          +  3.9% Â±  5.5%
Benchmark 3 (22 runs): ./readWhole-new
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time           236ms Â± 4.43ms     230ms â€¦  249ms          1 ( 5%)        ðŸ’©+189.0% Â±  2.2%
  peak_rss            412MB Â± 59.7KB     412MB â€¦  412MB          0 ( 0%)        ðŸ’©+14881.8% Â±  0.6%
  cpu_cycles          726K  Â± 59.9K      645K  â€¦  923K           1 ( 5%)        âš¡- 89.6% Â±  2.1%
  instructions        483K  Â± 0.46       483K  â€¦  483K           0 ( 0%)        âš¡- 95.2% Â±  0.0%
  cache_references   9.76K  Â±  250      8.97K  â€¦ 10.2K           1 ( 5%)        âš¡- 52.7% Â±  1.6%
  cache_misses       7.69K  Â±  320      7.03K  â€¦ 8.67K           2 ( 9%)        âš¡- 36.2% Â±  2.3%
  branch_misses      4.73K  Â±  153      4.50K  â€¦ 5.17K           0 ( 0%)          -  0.5% Â±  3.2%
</code></pre></div>



<a name="486358138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486358138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486358138">(Dec 05 2024 at 17:25)</a>:</h4>
<p>I also tried with a small 7MB file:</p>
<div class="codehilite"><pre><span></span><code>Benchmark 1 (1773 runs): ./buf-reuse
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          2.43ms Â±  257us    2.01ms â€¦ 4.02ms         84 ( 5%)        0%
  peak_rss           2.75MB Â± 18.8KB    2.49MB â€¦ 2.75MB         31 ( 2%)        0%
  cpu_cycles          610K  Â± 63.2K      536K  â€¦ 1.00M         105 ( 6%)        0%
  instructions        808K  Â± 0.47       808K  â€¦  808K           1 ( 0%)        0%
  cache_references   9.30K  Â±  331      7.46K  â€¦ 10.6K          75 ( 4%)        0%
  cache_misses       1.86K  Â±  546      1.13K  â€¦ 7.27K         164 ( 9%)        0%
  branch_misses      2.73K  Â±  617      1.40K  â€¦ 5.40K          55 ( 3%)        0%
Benchmark 2 (287 runs): ./readWhole
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          16.9ms Â± 6.17ms    15.5ms â€¦  103ms         13 ( 5%)        ðŸ’©+595.8% Â± 11.9%
  peak_rss           17.3MB Â± 28.5KB    17.0MB â€¦ 17.3MB         11 ( 4%)        ðŸ’©+528.9% Â±  0.1%
  cpu_cycles         18.7M  Â± 1.21M     18.3M  â€¦ 25.7M          16 ( 6%)        ðŸ’©+2969.9% Â±  9.3%
  instructions       60.7M  Â± 3.39      60.7M  â€¦ 60.7M           4 ( 1%)        ðŸ’©+7405.3% Â±  0.0%
  cache_references    120K  Â± 1.51K      102K  â€¦  123K           5 ( 2%)        ðŸ’©+1191.7% Â±  0.9%
  cache_misses       29.1K  Â± 1.90K     24.9K  â€¦ 37.1K          15 ( 5%)        ðŸ’©+1463.3% Â±  5.8%
  branch_misses      3.54K  Â±  512      2.44K  â€¦ 5.11K           7 ( 2%)        ðŸ’©+ 30.0% Â±  2.8%
Benchmark 3 (749 runs): ./readWhole-new
  measurement          mean Â± Ïƒ            min â€¦ max           outliers         delta
  wall_time          6.13ms Â± 3.52ms    3.18ms â€¦ 30.8ms        207 (28%)        ðŸ’©+152.3% Â±  6.8%
  peak_rss           9.83MB Â±    0      9.83MB â€¦ 9.83MB          0 ( 0%)        ðŸ’©+257.5% Â±  0.0%
  cpu_cycles          531K  Â± 90.4K      427K  â€¦  918K          82 (11%)        âš¡- 13.0% Â±  1.0%
  instructions        483K  Â± 0.58       483K  â€¦  483K           3 ( 0%)        âš¡- 40.2% Â±  0.0%
  cache_references   8.99K  Â±  527      7.27K  â€¦ 10.0K          96 (13%)        âš¡-  3.3% Â±  0.4%
  cache_misses       2.73K  Â±  822      1.54K  â€¦ 5.97K          23 ( 3%)        ðŸ’©+ 46.7% Â±  2.9%
  branch_misses      3.26K  Â±  769      1.70K  â€¦ 5.29K           0 ( 0%)        ðŸ’©+ 19.7% Â±  2.1%
</code></pre></div>



<a name="486359010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486359010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486359010">(Dec 05 2024 at 17:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486346783">said</a>:</p>
<blockquote>
<p>So full files read doesn't need your buffered read. They just need to not write to a rust vector</p>
</blockquote>
<p>That is what I was saying. Using a roc list as the destination for the read instead of an intermediate vec, just like my new readbytes does.</p>



<a name="486364014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486364014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486364014">(Dec 05 2024 at 17:56)</a>:</h4>
<p>Weird that the perf still isn't good for you. <span aria-label="shrug" class="emoji emoji-1f937" role="img" title="shrug">:shrug:</span> .... If you are interested, we could dig into the perf more.<br>
Would require a release build of the platform with debug info (edit cargo toml to have <code>debug=true</code> and comment out the <code>strip</code> line) along with building the roc app with <code>--optimize --profiling --linker legacy</code> (probably could build using the testing nightly?). Then running both scripts with a good profiler (I find samply the nicest).</p>



<a name="486441951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486441951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486441951">(Dec 06 2024 at 05:02)</a>:</h4>
<p>I was able to steal my wife's machine for a bit and test this. Simply staying in l1 cache makes all the difference here (also munmap at the end from freeing the large buffer is slow). I would have expected the pref here to do a better job (due to pretching), but I guess not. This is a case where you would need to mmap the buffer to get equivalent perf. Probably would want to mmap in copy on write mode and pass to roc.</p>



<a name="486441993"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486441993" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486441993">(Dec 06 2024 at 05:03)</a>:</h4>
<p>Still don't see the crazy 10x gain you see, but I see 3x.</p>



<a name="486441997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486441997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486441997">(Dec 06 2024 at 05:03)</a>:</h4>
<p>So definitely a win</p>



<a name="486442078"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486442078" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486442078">(Dec 06 2024 at 05:04)</a>:</h4>
<p>You must either have really slow ram/higher level caches. Or really fast l1 cache to see the 10x gain</p>



<a name="486573756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486573756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486573756">(Dec 06 2024 at 18:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform/near/486441951">said</a>:</p>
<blockquote>
<p>I was able to steal my wife's machine for a bit and test this. Simply staying in l1 cache makes all the difference here (also munmap at the end from freeing the large buffer is slow). I would have expected the pref here to do a better job (due to pretching), but I guess not. This is a case where you would need to mmap the buffer to get equivalent perf. Probably would want to mmap in copy on write mode and pass to roc.</p>
</blockquote>
<p>This is interesting, good to have another data point</p>



<a name="486579019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486579019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486579019">(Dec 06 2024 at 19:10)</a>:</h4>
<p>Hey, I'm having some trouble making the current setup work in a robust way with the rust platform.<br>
I think I'm having issues because it's possible for the platform to free <code>Box&lt;()&gt;</code> representing the file handle and then also end up freeing the roc list along with it.<br>
I can't seem to quite figure out a way to ensure the file handle and the buf stay in sync reference wise.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">RocReader</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">internalList</span><span class="p">:</span><span class="w"> </span><span class="nc">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">reader</span><span class="p">:</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">RocRefcounted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RocReader</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// panic!("oh no")</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">internalList</span><span class="p">.</span><span class="n">dec</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">reader</span><span class="p">.</span><span class="n">dec</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// panic!("oh no")</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">internalList</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">reader</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>I tried wrapping them like this.. but that didn't help becasue then I couldn't pass the Box&lt;()&gt; into the heap to get the file handle out.<br>
I'm sure I'm missing someting obvious here.</p>



<a name="486582411"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486582411" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486582411">(Dec 06 2024 at 19:36)</a>:</h4>
<p>I wouldn't store the <code>internalList</code> on the rust side. I would still use your original version and pass it in. Just make the reader in roc a <code>Reader := { file: Box {}, buf: List U8 }</code></p>



<a name="486582441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486582441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486582441">(Dec 06 2024 at 19:36)</a>:</h4>
<p>That said, I can look into the refcounting if you prefer that method.</p>



<a name="486620896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486620896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486620896">(Dec 07 2024 at 01:45)</a>:</h4>
<p>Oh, yeah alright, that does make way more sense... Sometimes I'm in so deep that the simple and obvious solution just completely eludes me <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="486665312"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486665312" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486665312">(Dec 07 2024 at 12:25)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span>  I made a PR for your branch with my changes :)<br>
<a href="https://github.com/roc-lang/basic-cli/pull/278">https://github.com/roc-lang/basic-cli/pull/278</a><br>
Let me know if you have any changes or questions</p>



<a name="486757808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486757808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486757808">(Dec 08 2024 at 10:37)</a>:</h4>
<p><span class="user-mention" data-user-id="651372">@Eli Dowling</span> I've only started investigating the CI failures. I suspect it's because the PI branch itself is struggling, and not your's changes. It looks like it passes everything on my aarch64 macos</p>



<a name="486757901"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Returning%20a%20modified%20roc%20list%20from%20a%20rust%20platform/near/486757901" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Eli Dowling <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Returning.20a.20modified.20roc.20list.20from.20a.20rust.20platform.html#486757901">(Dec 08 2024 at 10:39)</a>:</h4>
<p>I think I probably added some rust warnings. I'll double check tomorrow, but I probably have an unused import or something silly <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
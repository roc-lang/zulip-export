<html>
<head><meta charset="utf-8"><title>Use of different allocators in the same platform · platform development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/index.html">platform development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html">Use of different allocators in the same platform</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="490105034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490105034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490105034">(Dec 20 2024 at 07:07)</a>:</h4>
<p>I have a question about the planed change, that allocators get passed.</p>
<p>With this change, it will be possible, that different calls to Roc could use different allocators. For example different buffers as pre allocated memory. This could introduce new kinds of memory bugs, when the memory of different values are in different buffers.</p>
<p>For example, if the platform uses a <code>Model</code>, like the <a href="https://github.com/lukewilliamboswell/roc-wasm4">wasm4-platform</a> or <a href="https://github.com/lukewilliamboswell/roc-ray">roc-ray</a>.</p>
<p>The <code>Model</code> could be a <code>List Str</code> (or a List of another refcounted type)  and the memory of each Str could be in a different memory buffer. What happens, if Roc tries to deallocate the list? Currently, it calls <code>roc_dealloc</code> for the list itself and for each element on the list. But since the elements could have been created with another allocator, <code>roc_dealloc</code> could not deallocate them.</p>
<p>How should we handle situations like this?</p>



<a name="490105655"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490105655" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490105655">(Dec 20 2024 at 07:13)</a>:</h4>
<p>Should it be, that when you call Roc, all arguments have to be created with the same allocator?</p>
<p>So for example the following code would be illegal, since <code>addStr</code> gets called with <code>allocator1</code> but it has an argument, that was created with an <code>allocator2</code>.</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">var</span><span class="w"> </span><span class="n">allocator1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocAllocator</span><span class="p">();</span>
<span class="kr">var</span><span class="w"> </span><span class="n">allocator2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocAllocator</span><span class="p">();</span>
<span class="kr">var</span><span class="w"> </span><span class="n">myModel</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">undefinded</span><span class="p">;</span>
<span class="n">roc__initModel_1_exposed_generic</span><span class="p">(</span><span class="n">allocator1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">myModel</span><span class="p">);</span>

<span class="kr">var</span><span class="w"> </span><span class="n">myStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocStr</span><span class="p">(</span><span class="n">allocator2</span><span class="p">,</span><span class="w"> </span><span class="s">"hello world"</span><span class="p">);</span>
<span class="n">roc__addStr_1_exposed_generic</span><span class="p">(</span><span class="n">allocator1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">myModel</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">myModel</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">myStr</span><span class="p">);</span>
</code></pre></div>



<a name="490106361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490106361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490106361">(Dec 20 2024 at 07:19)</a>:</h4>
<p>Or would it be possible and enough, that allocators can not only be passed around, but also be <code>attached</code> to a type.</p>
<p>For example in zig, you have the <code>ArrayList</code>. Most of the time, it gets used like this:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">var</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ArrayList</span><span class="p">(</span><span class="kt">u8</span><span class="p">).</span><span class="n">init</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>
<span class="k">defer</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">deinit</span><span class="p">();</span>
<span class="k">try</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'H'</span><span class="p">);</span>
<span class="k">try</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'e'</span><span class="p">);</span>
<span class="k">try</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'l'</span><span class="p">);</span>
<span class="k">try</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'l'</span><span class="p">);</span>
<span class="k">try</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">'o'</span><span class="p">);</span>
<span class="k">try</span><span class="w"> </span><span class="n">list</span><span class="p">.</span><span class="n">appendSlice</span><span class="p">(</span><span class="s">" World!"</span><span class="p">);</span>
</code></pre></div>
<p>So the allocator is saved with the array list, so each call to <code>append</code> and also to <code>deinit</code> use the same allocator. If we want to do this, all std-container-types (like List, Dict, Set etc) could use the allocator, they used, when they where created. But it would also be necessary, that when you add an element to a container, that was allocated with a different allocater, it gets copied to the allocator of the container.</p>



<a name="490106544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490106544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490106544">(Dec 20 2024 at 07:21)</a>:</h4>
<p>So the call to <code>addStr</code> in the example above would copy <code>myStr</code> to <code>allocator1</code>.</p>



<a name="490107515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490107515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490107515">(Dec 20 2024 at 07:28)</a>:</h4>
<p>What I would like to do is to update the <a href="https://github.com/ostcar/kingfisher">kingfisher</a> platform, to use an arena allocators for each request. So each request gets handled by its own allocator. But the Kingfisher-platform uses a <code>Model</code>, so parts of a request (a request-header or the request-body) could be saved in the <code>Model</code>.  Since the allocator of each request gets deallocated after the request finishes, Roc would need to make sure, that the memory used in the <code>Model</code> is copied to an allocator, that stays around for the hole runtime of the program.</p>
<p>Do you think, this could be possible in a future version of Roc?</p>



<a name="490149708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490149708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490149708">(Dec 20 2024 at 12:14)</a>:</h4>
<p>I think we could facilitate this with Brendan's idea of exposing functions from the application to the host which provide operations on its types</p>



<a name="490149825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490149825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490149825">(Dec 20 2024 at 12:15)</a>:</h4>
<p>we were talking about it in the context of builtins, but we could also do it for application-specific types like Model</p>



<a name="490150002"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490150002" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490150002">(Dec 20 2024 at 12:16)</a>:</h4>
<p>and one of the operations we could expose is "clone" - where you pass it a roc_alloc (and it's potentially different from the one that was used to allocate the original value) and then it uses that roc_alloc for the new (cloned) value and everything inside it</p>



<a name="490194599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490194599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490194599">(Dec 20 2024 at 16:32)</a>:</h4>
<p>Yeah, I have thought about this a bit and I'm not sure if it is better to have the roc types hold onto the allocator or have the platform guarantee the allocator is used correctly. My gut feeling is that the platform needs to be responsible and in control. If a roc list holds onto an allocator and the platform frees the underlying allocator, that roc list is now broken. So I don't think that really solves the problem</p>



<a name="490195830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490195830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490195830">(Dec 20 2024 at 16:40)</a>:</h4>
<blockquote>
<p>So each request gets handled by its own allocator. But the Kingfisher-platform uses a <code>Model</code>, so parts of a request (a request-header or the request-body) could be saved in the <code>Model</code>.</p>
</blockquote>
<p>For kingfisher, I think you just need to run <code>decodeModel</code> and <code>handleWriteRequest</code> with a special allocator. Everything that only reads the model (which hopefully would be most requests) can just use an arena allocator.</p>



<a name="490196147"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490196147" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490196147">(Dec 20 2024 at 16:41)</a>:</h4>
<p>How does kingfisher deal with race conditions and data sharing across threads to update the model?</p>



<a name="490196213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490196213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490196213">(Dec 20 2024 at 16:42)</a>:</h4>
<p>Does it have a way to work around the lack of atomic refcounts?</p>



<a name="490313378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490313378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490313378">(Dec 21 2024 at 16:57)</a>:</h4>
<p>The idea to handle race conditions is, that the refcound of <code>Model</code> gets set to infinity for read-requests (Get-Requests) and that there can only be one write-request (POST) at the same time (One write requests OR many read requests). I had problems with the lack of atomics in read requests.</p>



<a name="490313446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490313446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490313446">(Dec 21 2024 at 16:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490195830">said</a>:</p>
<blockquote>
<blockquote>
<p>So each request gets handled by its own allocator. But the Kingfisher-platform uses a <code>Model</code>, so parts of a request (a request-header or the request-body) could be saved in the <code>Model</code>.</p>
</blockquote>
<p>For kingfisher, I think you just need to run <code>decodeModel</code> and <code>handleWriteRequest</code> with a special allocator. Everything that only reads the model (which hopefully would be most requests) can just use an arena allocator.</p>
</blockquote>
<p>This could work. But of cause I would be a fan, if the allocator was attached to the data-types, so write requests can also use an area allocator.</p>



<a name="490313499"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490313499" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490313499">(Dec 21 2024 at 16:59)</a>:</h4>
<p>If the allocator is not attached to the data-types, it will be a source of possible errors. I think attaching the allocator will be a nicer experience for platform developers.</p>



<a name="490313816"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490313816" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490313816">(Dec 21 2024 at 17:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490150002">said</a>:</p>
<blockquote>
<p>and one of the operations we could expose is "clone" - where you pass it a roc_alloc (and it's potentially different from the one that was used to allocate the original value) and then it uses that roc_alloc for the new (cloned) value and everything inside it</p>
</blockquote>
<p>I don't think this will work. If your <code>Model</code> is something like <code>Model: {list: List Str}</code> and the application code does <code>newModel = {model &amp; list: List.append model.list "not a small string"}</code> then it is not a clone, but it has to be ensured, that the string and (if there is not enough capacity) the clone of the <code>List</code> gets allocated in the allocator of the model. This is not a clone of the <code>Model</code></p>



<a name="490315666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490315666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490315666">(Dec 21 2024 at 17:31)</a>:</h4>
<p>I think the <code>clone</code> suggestion was that, <code>newModel = {model &amp; list: List.append model.list "not a small string"}</code> would be allocated into the request local arena allocator. On return from roc, the host would call <code>model.clone()</code> which would recursively clone the model into a different location to keep it alive longer.</p>



<a name="490315909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490315909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490315909">(Dec 21 2024 at 17:35)</a>:</h4>
<blockquote>
<p>so write requests can also use an area allocator.</p>
</blockquote>
<p>I don't think attaching the allocator to the data type solves this. You have no guarantees if the user continues to use the same container or replaces the container with a totally new container. Also, any new data added to the container would potentially use a different allocator.</p>



<a name="490316009"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490316009" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490316009">(Dec 21 2024 at 17:36)</a>:</h4>
<blockquote>
<p>I had problems with the lack of atomics in read requests.</p>
</blockquote>
<p>Yeah, in current roc, you either need to fully understand the model data type to recursively set the refcount to constant or you need atomics.</p>



<a name="490316317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490316317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490316317">(Dec 21 2024 at 17:41)</a>:</h4>
<p>If we gave every container an allocator, that would mean that every container holds an extra pointer, which would not be great. A list of str would now need to be 64bit longer per string in the container.</p>



<a name="490317246"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490317246" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490317246">(Dec 21 2024 at 17:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490315909">said</a>:</p>
<blockquote>
<blockquote>
<p>so write requests can also use an area allocator.</p>
</blockquote>
<p>I don't think attaching the allocator to the data type solves this. You have no guarantees if the user continues to use the same container or replaces the container with a totally new container. Also, any new data added to the container would potentially use a different allocator.</p>
</blockquote>
<p>I think you are right. This would make it necessary to call all functions, that can manipulate the <code>Model</code> with the same allocator. The idea from <span class="user-mention" data-user-id="281383">@Richard Feldman</span> could work, but would create potentially unnecessary copies.</p>



<a name="490317278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490317278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490317278">(Dec 21 2024 at 17:57)</a>:</h4>
<p>how does updating the model work?</p>



<a name="490317302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490317302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490317302">(Dec 21 2024 at 17:57)</a>:</h4>
<p>like what's the API - is there an effect any request handler can run to change it?</p>



<a name="490317375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490317375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490317375">(Dec 21 2024 at 17:58)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490316317">said</a>:</p>
<blockquote>
<p>If we gave every container an allocator, that would mean that every container holds an extra pointer, which would not be great. A list of str would now need to be 64bit longer per string in the container.</p>
</blockquote>
<p>Are there tricks, that pointers can use only 32bits on a 64bit system? If so, then the refcounter could be used. Its a usize value that will never store more then 32bit. For lists, that have heap allocated elements, there is even another usize value to point to the original list.</p>



<a name="490317707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490317707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490317707">(Dec 21 2024 at 18:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490317302">said</a>:</p>
<blockquote>
<p>like what's the API - is there an effect any request handler can run to change it?</p>
</blockquote>
<p>In the current version, Roc exposes the function <code>handleWriteRequest : Request, Model -&gt; (Response, Model),</code>.</p>
<p>But I am playing with the API. One Idea is to have only one <code>handleRequest</code> function, but the http-method-type looks like this:</p>
<div class="codehilite"><pre><span></span><code>RequestMethod : [
    Options,
    Get,
    Post SaveEvent,
    Put SaveEvent,
    Delete SaveEvent,
    Head,
    Trace,
    Connect,
    Patch SaveEvent,
]
</code></pre></div>
<p>And <code>SaveEvent</code> is an effect that updates the <code>Model</code>. So if you want to update the Model, you have to unpack the method with </p>
<div class="codehilite"><pre><span></span><code> when request.method is
        Get -&gt;
           ...
        Post saveEvent -&gt;
            ...
</code></pre></div>



<a name="490317967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490317967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490317967">(Dec 21 2024 at 18:07)</a>:</h4>
<p>This uses Rocs type system, that you can only update the Model on write requests, but you don't have to update the model, if it did not change. For example, if there is a unauthenticated POST request. At the current version, the host can not know, if that <code>Model</code> changed and has to save it it any case. With the new API, it only needs to save it, when <code>SaveEvent</code> was called.</p>



<a name="490318900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490318900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490318900">(Dec 21 2024 at 18:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> <a href="#narrow/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490317375">said</a>:</p>
<blockquote>
<p>Are there tricks, that pointers can use only 32bits on a 64bit system? If so, then the refcounter could be used. Its a usize value that will never store more then 32bit. For lists, that have heap allocated elements, there is even another usize value to point to the original list.</p>
</blockquote>
<p>A small string or eventual small list u8 would need to store the allocator, so I dont think there is any way around the full 64 bits being on the stack.</p>



<a name="490319182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490319182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490319182">(Dec 21 2024 at 18:28)</a>:</h4>
<p>Anyway, how I see this playing out in practice:</p>
<ol>
<li>We get explicit allocators per requests not per container</li>
<li>We attempt to use them and figure out smart patterns that avoid any memory issues (probably add recursive clone for easy testing)</li>
<li>We evaluate if it is enough or if the allocator needs to be stored on each container type.</li>
</ol>



<a name="490326125"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490326125" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490326125">(Dec 21 2024 at 20:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> <a href="#narrow/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490317707">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform/near/490317302">said</a>:</p>
<blockquote>
<p>like what's the API - is there an effect any request handler can run to change it?</p>
</blockquote>
<p>In the current version, Roc exposes the function <code>handleWriteRequest : Request, Model -&gt; (Response, Model),</code>.</p>
</blockquote>
<p>yeah this innately has a race condition in it, unfortunately. <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>
<p>what can happen is that two different requests start getting handled in parallel, one increments a "total requests handled" counter in the model from 5 to 6, finishes, and saves the new model, then the other finishes and also increments "total requests handled" from 5 to 6 because it was 5 when both handler functions started running</p>



<a name="490326219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490326219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490326219">(Dec 21 2024 at 20:08)</a>:</h4>
<p>Elm doesn't have this problem bc only <code>update</code> can change the model, and it only ever runs on one thread</p>



<a name="490326266"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490326266" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490326266">(Dec 21 2024 at 20:10)</a>:</h4>
<p>the <code>SaveEvent</code> design would have the same race condition</p>



<a name="490327195"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490327195" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490327195">(Dec 21 2024 at 20:21)</a>:</h4>
<p>SaveEvent could have a RWLock. So each request grabs a reader lock over the model. Only grab a writer lock with that function. Then mutate the model in place. Still have to be really careful. Cause either you need to lock the entire request or you need to ensure that no thread has a reference to any data within the model before freeing the lock.</p>



<a name="490327204"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490327204" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490327204">(Dec 21 2024 at 20:21)</a>:</h4>
<p>Probably would do it per request in this case</p>



<a name="490327390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490327390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490327390">(Dec 21 2024 at 20:24)</a>:</h4>
<p>Also, just realized that without locking for the whole request you definitely will hit the increment bug you mentioned above.</p>



<a name="490327408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490327408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490327408">(Dec 21 2024 at 20:24)</a>:</h4>
<p>Still could model it with a save effect, but the save effect would need to start from loading the existing model after grabbing the writer lock</p>



<a name="490329146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490329146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490329146">(Dec 21 2024 at 20:47)</a>:</h4>
<p>yeah, which would be pretty different from the current API <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="490331199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490331199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490331199">(Dec 21 2024 at 21:20)</a>:</h4>
<p>There is a RWLock, but this lock is in the host. The host also checks the http method and only lets one write request through.</p>
<p>So there can not be a race condition on write requests, since there is no race.</p>
<p>I know that this has other problems. For example, you can send many unauthorized POST requests. But this limitation is fine for me</p>



<a name="490344212"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490344212" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490344212">(Dec 22 2024 at 00:47)</a>:</h4>
<p>if we had <a href="#narrow/stream/304641-ideas/topic/STM.20.28software.20transactional.20memory.29.20builtin">https://roc.zulipchat.com/#narrow/stream/304641-ideas/topic/STM.20.28software.20transactional.20memory.29.20builtin</a> I think that could address the race conditions by providing access to Model as a <code>Store Model</code></p>



<a name="490372144"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Use%20of%20different%20allocators%20in%20the%20same%20platform/near/490372144" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Use.20of.20different.20allocators.20in.20the.20same.20platform.html#490372144">(Dec 22 2024 at 08:56)</a>:</h4>
<p>I read the topic, but I don't get it. </p>
<p>Would the Store/Actor be something, the platform provides which each call like <code>handleRequest : Request, Store a -&gt; (Response, Store a)</code>, or is it something that could life in some sort of global space in each Roc app and is therefore platform independent?</p>
<p>If it's the second case, then I would not need the kingfisher platform anymore. I could just use basic-webserver. All I want is a way to store state between requests. If this is something Roc can always do, it would be perfect.</p>
<p>But I think this global thing is not possible in a pure language, so you probably mean, that <code>Store/Actor</code> is something, the platform has to provide on each call.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Struggling with glue · platform development · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/index.html">platform development</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html">Struggling with glue</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="485029245"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485029245" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485029245">(Nov 29 2024 at 06:20)</a>:</h4>
<p>I've been working on a custom Roc platform in Rust, relying heavily on example platforms.  I think I have a decent high-level understanding for how the pieces fit together.  I have a lot of ideas I'm excited to try, but unfortunately my struggles with glue generation have ground my progress to a halt.  Hoping some of the lovely folks in here can help unblock me.</p>
<p>I've seen from other threads and my own experience that Rust glue generation is a bit broken.  In my case, there were unnecessary <code>Clone</code> derivations and a few other minor issues preventing the generated glue code from compiling, which I was able to fix manually.  But after getting past those errors, I get hit with this cryptic error at point when the platform tries to use the generated struct to read data from the application:</p>
<div class="codehilite"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at core/src/panicking.rs:221:5:
unsafe precondition(s) violated: slice::from_raw_parts requires the pointer to be aligned and non-null, and the total size of the slice not to exceed `isize::MAX`
</code></pre></div>
<p>I realize that without more context this error probably isn't actionable, so let me back up and show the Roc types I'm trying to generate glue for:</p>
<div class="codehilite"><pre><span></span><code>GenericEffect : [
    Single (Bytes =&gt; Bytes),
    Map GenericEffect (Bytes -&gt; Bytes),
    Chain GenericEffect GenericEffect,
    Fork GenericEffect GenericEffect,
    Parallel GenericEffect,
    Branch GenericEffect GenericEffect (Bytes -&gt; Bool),
    Loop GenericEffect GenericEffect (Bytes -&gt; Bool),
]

Bytes : List U8
</code></pre></div>
<p>I don't necessarily want to explain what I'm hoping to achieve with this custom platform at the moment, since I'm still in the exploratory phase (but I could if need be).  What I'd like to know for starters is</p>
<ol>
<li>Should I be able to generate glue for these types at all?  Or is there something about them that just won't work with glue?</li>
<li>How would I go about troubleshooting the error above?  I could perhaps put together a reprex repo but if the answer to the above is "no" then I wouldn't even bother <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></li>
</ol>



<a name="485031989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485031989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485031989">(Nov 29 2024 at 06:48)</a>:</h4>
<p>Do you need the platform to call those functions? Maybe if you box them so they're just opaque pointers (with fixed size) on the host side. I didn't think we supported functions crossing the boundary though yet, I thought we needed type erasure for that (which isnt implemented yet).</p>



<a name="485109703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485109703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485109703">(Nov 29 2024 at 14:24)</a>:</h4>
<p>Correct, the application builds up this structure full of functions and hands it off to the platform for execution.  My platform makes the construction and composition of effects very restricted in order to make certain security guarantees and enable debug tooling.</p>
<p>I can try boxing the functions on the roc side when I have access to a computer.</p>
<p>In general does everything being passed from roc to the platform need a fixed size?  So is <code>List U8</code> also an issue?</p>



<a name="485147431"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485147431" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485147431">(Nov 29 2024 at 18:50)</a>:</h4>
<p>Glue has a lot of bugs and limitations currently. Functions are an exceptionally sharp edge.</p>



<a name="485147536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485147536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485147536">(Nov 29 2024 at 18:51)</a>:</h4>
<p>We do plan to restrict the platform API to fixed sized data types. Today, roc will create a size function for anything that is not fixed size, but it isn't aways enough to be useful.</p>



<a name="485147666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485147666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485147666">(Nov 29 2024 at 18:52)</a>:</h4>
<p>I would not expect this platform to work in general. It looks a lot like effect interpreters which are stuck due to compiler bugs. It might end up working out, but I would expect to hit compiler bugs that need to be worked around.</p>



<a name="485147798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485147798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485147798">(Nov 29 2024 at 18:54)</a>:</h4>
<p>Lists have a compile time known size and are totally fine to pass to the platform. A list is the size of 3 pointers.</p>



<a name="485174432"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485174432" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485174432">(Nov 29 2024 at 23:59)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> regarding your comment about this looking like effect interpreters, does it make a difference to know that for this platform the effects being handed off to the platform is a one-time transaction?  Like the application essentially is just a DSL for building up an effectful computation that the platform executes.  There's no back and forth between the app and platform.</p>



<a name="485174635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485174635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485174635">(Nov 30 2024 at 00:01)</a>:</h4>
<p>I think the issue is that when you have recursion and captures you are in lambda set territory and those sometimes break.</p>



<a name="485174672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485174672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485174672">(Nov 30 2024 at 00:01)</a>:</h4>
<p>It may work, but when it doesn't we don't have many options available.</p>



<a name="485174744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485174744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485174744">(Nov 30 2024 at 00:02)</a>:</h4>
<p>Also, are you passing these functions across to the host (rust/zig) etc? or do they live purely in the roc side of things (between app and platform)?</p>



<a name="485174778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485174778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485174778">(Nov 30 2024 at 00:03)</a>:</h4>
<p>If you can provide more context I can probably provide more assistance. Even if it's just a fake platform.</p>



<a name="485176060"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485176060" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485176060">(Nov 30 2024 at 00:21)</a>:</h4>
<p>Sure, I can try to give more context.  With this platform, the Roc API provides constructors for creating effects, but not executing any of them.  The application can't even provide a main function, just a "main effect" value.  Custom effects cannot be created by the app author, only selected from the platform library.  The <code>GenericEffect</code> type I showed above isn't exposed to the app author either.  Instead they are given a type-safe wrapper with functions for composing effects and/or doing ad-hoc mapping (pure functions only):</p>
<div class="codehilite"><pre><span></span><code>Effect a b := GenericEffect

map : Effect a b, (b -&gt; c) -&gt; Effect a c
chain : Effect a b, Effect b c -&gt; Effect a c
fork : Effect a b, Effect a c -&gt; Effect a (b, c)
parallelize : Effect a b -&gt; Effect (List a) (List b)
branch : Effect a b, Effect a c, (a -&gt; bool) -&gt; Effect a (Either b c)
loop : Effect a a, Effect a b, (a -&gt; bool) -&gt; Effect a b
fixture : a -&gt; Effect {} a where a implements Encoding
discard : Effect a * -&gt; Effect a {}
</code></pre></div>
<p>There are some missing implements Encoding/Decoding annotations above, but this gives a rough idea of the application API.  <code>Effect a b</code> internally manages the <code>GenericEffect</code> (shown earlier) by wrapping any provided functions that operate on <code>a</code> or <code>b</code> with encoders/decoders to keep the host's view of the computation generic (and enable some of the features described below)</p>
<p>Here's what "hello world" might look like:</p>
<div class="codehilite"><pre><span></span><code>app [main] { pf: platform &quot;platform/main.roc&quot; }

import pf.Stdout
import pf.Effect

main = Effect.fixture &quot;Hello world!&quot; |&gt; Effect.chain Stdout.line
</code></pre></div>
<p>So to answer the question above, yes the host needs to be able to execute the functions defined in Roc, because the application (intentionally) isn't allowed to actually execute anything, other than functions to compose effects.</p>



<a name="485176369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485176369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485176369">(Nov 30 2024 at 00:26)</a>:</h4>
<p>Also <code>Effect.fixture</code> isn't truly an effect (probably needs a better name).  It's just what I'm using for my POC code at the moment because it works nicely with <code>chain</code></p>



<a name="485176782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485176782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485176782">(Nov 30 2024 at 00:32)</a>:</h4>
<p>The big idea is that by giving the platform a highly-structured view of the application, you can get a whole bunch of stuff for free, like automatic state chart documentation; debug instrumentation that allows you to pause, inspect, and modify data at runtime; and interesting security analysis capabilities (e.g., going beyond "this program has network and disk access" to "this program, despite disk and network access, cannot send your personal files to a remote server, because there's no path between the ReadFile effect and HttpPost effect")</p>



<a name="485177027"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485177027" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485177027">(Nov 30 2024 at 00:36)</a>:</h4>
<p>That last idea depends on functional purity and tightly controlling the composition and execution of effectful code (and Roc is the only language that I know of that has these critical features!)</p>



<a name="485177518"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485177518" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485177518">(Nov 30 2024 at 00:44)</a>:</h4>
<p>Ok, I'm not sure I can give you any definitive answers. </p>
<p>My approach with this kind of thing is to start with the very smallest e2e thing I can think of and build it up bit by bit. So maybe you could try just with:</p>
<div class="codehilite"><pre><span></span><code>GenericEffect : [
    Single (Bytes =&gt; Bytes),
]
</code></pre></div>
<p>And see if you can get that working? </p>
<p>One thing I find that is helpful, is that you can generate the llvm ir with <code>roc build --no-link --emit-llvm-ir path/to/app.roc</code>. That will give you the definitive answer on what roc is generating. I often use this to confirm the FFI is correct.</p>



<a name="485177708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485177708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485177708">(Nov 30 2024 at 00:47)</a>:</h4>
<p>I was able to generate glue using <code>RustGlue.roc</code> and this platform.</p>
<div class="codehilite"><pre><span></span><code>platform &quot;&quot;
    requires {} { main! : {} =&gt; _ }
    exposes []
    packages {}
    imports []
    provides [mainForHost!]

Bytes : List U8

GenericEffect : [
    Single (Bytes =&gt; Bytes),
]

mainForHost! : {} =&gt; GenericEffect
mainForHost! = \{} -&gt; main! {}
</code></pre></div>



<a name="485177778"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485177778" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485177778">(Nov 30 2024 at 00:48)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="cp">#[derive(Debug)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">RocFunction_67</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">closure_data</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">RocFunction_67</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">force_thunk</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">arg0</span><span class="p">:</span><span class="w"> </span><span class="nc">roc_std</span><span class="p">::</span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">roc_std</span><span class="p">::</span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc__mainForHost_0_caller</span><span class="p">(</span><span class="n">arg0</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">roc_std</span><span class="p">::</span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">closure_data</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">roc_std</span><span class="p">::</span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">mem</span><span class="p">::</span><span class="n">MaybeUninit</span><span class="p">::</span><span class="n">uninit</span><span class="p">();</span>

<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">roc__mainForHost_0_caller</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arg0</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">closure_data</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span><span class="w"> </span><span class="n">output</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">());</span>

<span class="w">            </span><span class="n">output</span><span class="p">.</span><span class="n">assume_init</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="n">roc_refcounted_noop_impl</span><span class="o">!</span><span class="p">(</span><span class="n">RocFunction_67</span><span class="p">);</span>

<span class="cp">#[derive(Clone, )]</span>
<span class="cp">#[repr(transparent)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">GenericEffect</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="n">f0</span><span class="p">:</span><span class="w"> </span><span class="nc">RocFunction_67</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">GenericEffect</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// A tag named ``Single``, with the given payload.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">Single</span><span class="p">(</span><span class="n">f0</span><span class="p">:</span><span class="w"> </span><span class="nc">RocFunction_67</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">f0</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="sd">/// Since `GenericEffect` only has one tag (namely, `Single`),</span>
<span class="w">    </span><span class="sd">/// convert it to `Single`'s payload.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">into_Single</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocFunction_67</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">f0</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="sd">/// Since `GenericEffect` only has one tag (namely, `Single`),</span>
<span class="w">    </span><span class="sd">/// convert it to `Single`'s payload.</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">as_Single</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">RocFunction_67</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">f0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="k">impl</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Debug</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GenericEffect</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="o">&lt;'</span><span class="nb">_</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="nb">Result</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">f</span><span class="p">.</span><span class="n">debug_tuple</span><span class="p">(</span><span class="s">"GenericEffect::Single"</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">field</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">f0</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">roc_refcounted_noop_impl</span><span class="o">!</span><span class="p">(</span><span class="n">GenericEffect</span><span class="p">);</span>
</code></pre></div>
<p>This is looking positive...</p>



<a name="485177800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485177800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485177800">(Nov 30 2024 at 00:48)</a>:</h4>
<p>Yes, I should have been more clear that the glue generation does succeed, but the generated code doesn't compile</p>



<a name="485177821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485177821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485177821">(Nov 30 2024 at 00:49)</a>:</h4>
<p>Ohk... yeah the generated code is a mess rn. I usually just use it as a general guide</p>



<a name="485177828"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485177828" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485177828">(Nov 30 2024 at 00:49)</a>:</h4>
<p>Helps me figure out the order and alignment etc</p>



<a name="485178034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178034">(Nov 30 2024 at 00:52)</a>:</h4>
<p>So admittedly I don't really understand what I need to look for to fix order/alignment issues <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>.  I saw the <code>DescribeGlue.roc</code> spec for spitting out the types/alignment, but I couldn't do much with that information.  I'm not sure how much I need to understand about FFI in general</p>



<a name="485178162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178162">(Nov 30 2024 at 00:54)</a>:</h4>
<p>Sorry for the super vague question <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="485178164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178164">(Nov 30 2024 at 00:54)</a>:</h4>
<p>I'm not an expert... but me and my buddy Claude stumble through it</p>



<a name="485178172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178172">(Nov 30 2024 at 00:54)</a>:</h4>
<p>Having the LLVM IR is super helpful</p>



<a name="485178288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178288">(Nov 30 2024 at 00:56)</a>:</h4>
<p>Is there something in particular I should look for in the 13k line LLVM IR output?</p>



<a name="485178308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178308">(Nov 30 2024 at 00:56)</a>:</h4>
<p>Yeah, search for the entrypoint... like <code>mainForHost</code> etc</p>



<a name="485178461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178461">(Nov 30 2024 at 00:59)</a>:</h4>
<p>For example in the JS DOM experimental platform I have the following...</p>
<div class="codehilite"><pre><span></span><code>platform &quot;&quot;
    requires { Model } {
        init : {} -&gt; Model,
        update : Model, List U8 -&gt; Action.Action Model,
        render : Model -&gt; Html.Html Model,
    }
    exposes [Html, Action]
    packages {}
    imports []
    provides [initForHost, updateForHost, renderForHost]

import Html
import Html
import Action

initForHost : I32 -&gt; Box Model
initForHost = \_ -&gt; Box.box (init {})

updateForHost : Box Model, List U8 -&gt; Action.Action (Box Model)
updateForHost = \boxedModel, payload -&gt;
    Action.map (update (Box.unbox boxedModel) payload) Box.box

renderForHost : Box Model -&gt; Html.Html Model
renderForHost = \boxedModel -&gt; render (Box.unbox boxedModel)
</code></pre></div>
<p>So I can find these in the LLVM</p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@roc__initForHost_1_exposed</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">)</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!99</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%call</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@_initForHost_99aa979e4a9cadd6dbe48ea878ec84acb7696eb93470c375f6893f1da46c3772</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!100</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%call</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!100</span>
<span class="p">}</span>

<span class="k">define</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="vg">@roc__initForHost_1_exposed_size</span><span class="p">()</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!102</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="k">ptrtoint</span><span class="w"> </span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="p">(</span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i64</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!103</span>
<span class="p">}</span>

<span class="k">define</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="vg">@roc__updateForHost_1_exposed</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">)</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!120</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%result_value</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">alloca</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!121</span>
<span class="w">  </span><span class="nv">%load_arg</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!121</span>
<span class="w">  </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@_updateForHost_392aebc0773ca1163ead8eb210e2c2aabca4fe4ded9f2b122a7dab30d082d98b</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="nv">%list.RocList</span><span class="w"> </span><span class="nv">%load_arg</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%result_value</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!121</span>
<span class="w">  </span><span class="nv">%load_result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%result_value</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!121</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nv">%load_result</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!121</span>
<span class="p">}</span>

<span class="k">define</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="vg">@roc__updateForHost_1_exposed_size</span><span class="p">()</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!123</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="k">ptrtoint</span><span class="w"> </span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="p">({</span><span class="w"> </span><span class="p">[</span><span class="m">1</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">],</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i64</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!124</span>
<span class="p">}</span>

<span class="k">define</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@roc__renderForHost_1_exposed</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">)</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!183</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%call</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@_renderForHost_eabc27640eff330d625cb2f6435f5dccaec45dd590ad64015fdca105b70</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!184</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%call</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!184</span>
<span class="p">}</span>

<span class="k">define</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="vg">@roc__renderForHost_1_exposed_size</span><span class="p">()</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!186</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="k">ptrtoint</span><span class="w"> </span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="k">getelementptr</span><span class="w"> </span><span class="p">(</span><span class="kt">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="kt">i64</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!187</span>
<span class="p">}</span>
</code></pre></div>
<p>Which I've then translated to the following...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_init</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[link(name = </span><span class="s">"app"</span><span class="cp">)]</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// initForHost : I32 -&gt; Model</span>
<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__initForHost_1_exposed"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">caller</span><span class="p">(</span><span class="n">arg_not_used</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__initForHost_1_exposed_size"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">size</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">debug_assert_eq!</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">mem</span><span class="p">::</span><span class="n">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="n">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span>
<span class="w">        </span><span class="n">caller</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_update</span><span class="p">(</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">raw_event</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">glue</span><span class="p">::</span><span class="n">RawAction</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[link(name = </span><span class="s">"app"</span><span class="cp">)]</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// updateForHost : Box Model, List U8 -&gt; Action.Action (Box Model)</span>
<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__updateForHost_1_exposed"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">caller</span><span class="p">(</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">raw_event</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">glue</span><span class="p">::</span><span class="n">RawAction</span><span class="p">;</span>

<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__updateForHost_1_exposed_size"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">size</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">debug_assert_eq!</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">mem</span><span class="p">::</span><span class="n">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="n">glue</span><span class="p">::</span><span class="n">RawAction</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span>
<span class="w">        </span><span class="n">caller</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="n">raw_event</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_render</span><span class="p">(</span><span class="n">model</span><span class="p">:</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">glue</span><span class="p">::</span><span class="n">Html</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[link(name = </span><span class="s">"app"</span><span class="cp">)]</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// renderForHost : Box Model -&gt; Html.Html Model</span>
<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__renderForHost_1_exposed"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">caller</span><span class="p">(</span><span class="n">model</span><span class="p">:</span><span class="w"> </span><span class="nc">RocBox</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">glue</span><span class="p">::</span><span class="n">Html</span><span class="p">;</span>

<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__renderForHost_1_exposed_size"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">size</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">debug_assert_eq!</span><span class="p">(</span><span class="n">std</span><span class="p">::</span><span class="n">mem</span><span class="p">::</span><span class="n">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="n">glue</span><span class="p">::</span><span class="n">Html</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"> </span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span>
<span class="w">        </span><span class="n">caller</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="485178764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485178764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485178764">(Nov 30 2024 at 01:03)</a>:</h4>
<p>Thank you... there's a lot of unfamiliar stuff to digest here, but I'll see if I can use this to make sense of my output and find any clues as to why my app is crashing <span aria-label="magnifying glass" class="emoji emoji-1f50d" role="img" title="magnifying glass">:magnifying_glass:</span></p>



<a name="485179301"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485179301" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485179301">(Nov 30 2024 at 01:11)</a>:</h4>
<p>Before I get too far with that though, does this Roc type even make sense?</p>
<div class="codehilite"><pre><span></span><code>Effect a b := GenericEffect
</code></pre></div>
<p>Specifically how the type parameters aren't used.  In Rust this is a problem and I'd need to use PhantomData or something, but the Roc compiler doesn't seem to care.  Just want to check that this is expected.</p>



<a name="485179496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485179496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485179496">(Nov 30 2024 at 01:13)</a>:</h4>
<p>I think so, that would be identical to this right?</p>
<div class="codehilite"><pre><span></span><code>Effect a b := [
    Single (Bytes =&gt; Bytes),
    Map (Effect a b) (Bytes -&gt; Bytes),
    Chain (Effect a b) (Effect a b),
    Fork (Effect a b) (Effect a b),
    Parallel (Effect a b),
    Branch (Effect a b) (Effect a b) (Bytes -&gt; Bool),
    Loop (Effect a b) (Effect a b) (Bytes -&gt; Bool),
]
</code></pre></div>



<a name="485179795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485179795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485179795">(Nov 30 2024 at 01:17)</a>:</h4>
<p>Not quite.  I had to wrap <code>GenericEffect</code> because it's not possible to name all the type parameters of the inner <code>Effect</code>s if I were to do it in a completely type safe way.  For example:</p>
<div class="codehilite"><pre><span></span><code>Effect a b ??? := [
    Single (a =&gt; b)
    Map (Effect a b) (b -&gt; c)
    Chain (Effect a b) (Effect a c)
    ...
]
</code></pre></div>



<a name="485179883"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485179883" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485179883">(Nov 30 2024 at 01:18)</a>:</h4>
<p><code>GenericEffect</code> deals with this problem by wrapping all those functions with encoders/decoders to coerce everything to a single concrete type (<code>Bytes</code>/<code>List U8</code> in my case, but I could just as easily have used <code>Str</code>)</p>



<a name="485180158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485180158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485180158">(Nov 30 2024 at 01:22)</a>:</h4>
<p>I guess I should have clarified up front that <code>a</code> represents the input to the effect, and <code>b</code> represents the output</p>



<a name="485189550"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485189550" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485189550">(Nov 30 2024 at 03:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="572105">Tanner Nielsen</span> <a href="#narrow/stream/302903-platform-development/topic/Struggling.20with.20glue/near/485174432">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> regarding your comment about this looking like effect interpreters, does it make a difference to know that for this platform the effects being handed off to the platform is a one-time transaction?  Like the application essentially is just a DSL for building up an effectful computation that the platform executes.  There's no back and forth between the app and platform.</p>
</blockquote>
<p>Is nothing returns a GenericEffect, you may be fine. Not sure.</p>



<a name="485189694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485189694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485189694">(Nov 30 2024 at 03:47)</a>:</h4>
<p>Also, do you need to pass the lambdas to the host for the Generic effect? If you could make that all live in roc, it would make your interaction with glue complexity simpler.</p>



<a name="485191956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485191956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tanner Nielsen <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485191956">(Nov 30 2024 at 04:22)</a>:</h4>
<p>The main reason I wanted the lambdas to be executed by the host was so I could do parallelism via Rust threads.  That's not a hard requirement of the platform though, and I guess a single-threaded proof of concept is better than nothing.</p>



<a name="485198048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/302903-platform%20development/topic/Struggling%20with%20glue/near/485198048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/302903-platform-development/topic/Struggling.20with.20glue.html#485198048">(Nov 30 2024 at 06:00)</a>:</h4>
<p>Makes sense</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
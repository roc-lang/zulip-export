<html>
<head><meta charset="utf-8"><title>mono mismatch between mac aarch64 and rest of targets · bugs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html">mono mismatch between mac aarch64 and rest of targets</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="493982259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493982259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493982259">(Jan 15 2025 at 17:39)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/7514">https://github.com/roc-lang/roc/pull/7514</a> is currently failing CI due to one of the mono tests failing. Unfortunately, it seems mac aarch64 outputs different mono than the rest of the targets. It seems there's some off-by-one difference in <code>Derived_gen</code> identifiers that only shows up in one example. If we fix it for mac aarch64, it breaks the other targets, if we fix the other targets, it breaks for mac aarch64.</p>
<p>Is there host/arch-specific logic in the mono pass? I searched for any code with <code>#[cfg(.*target_os = "macos"</code> and nothing jumped out at me, but that's about as far as I knew to look.</p>



<a name="493982682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493982682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493982682">(Jan 15 2025 at 17:41)</a>:</h4>
<p>the CI run where mac aarch64 fails on mono mismatch: <a href="https://github.com/roc-lang/roc/actions/runs/12778134753/job/35620405661">https://github.com/roc-lang/roc/actions/runs/12778134753/job/35620405661</a><br>
the CI run where everything else fails on mono mismatch: <a href="https://github.com/roc-lang/roc/actions/runs/12778510523/job/35623205009">https://github.com/roc-lang/roc/actions/runs/12778510523/job/35623205009</a></p>



<a name="493982992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493982992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493982992">(Jan 15 2025 at 17:43)</a>:</h4>
<p>Nix calls the architecture darwin</p>



<a name="493983005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493983005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493983005">(Jan 15 2025 at 17:43)</a>:</h4>
<p>Maybe Rust does the same?</p>



<a name="493983279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493983279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493983279">(Jan 15 2025 at 17:44)</a>:</h4>
<p>But yeah, it's very rare for us to do something for Macs, it's more often Unix filtering</p>



<a name="493984501"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493984501" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493984501">(Jan 15 2025 at 17:51)</a>:</h4>
<p>nah, no results with <code>cfg\(.*darwin</code>, it looks like <code>target_os = "macos"</code> is the rust cfg used in roc to conditionally do things for mac.</p>
<p>just because I didn't see anything doesn't mean someone with a better understanding of mono or preceding passes wouldn't. I don't have a good idea how/where <code>Derived_gen</code> identifiers are even created or where that number comes from in eg <code>#Derived_gen.22</code></p>



<a name="493989701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493989701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493989701">(Jan 15 2025 at 18:19)</a>:</h4>
<p><code>Derived_gen.21</code> does not exist in <a href="https://github.com/roc-lang/roc/blob/144b02939d8ac04b32ae1a932ddc6f722adef01e/crates/compiler/test_mono/generated/inspect_derived_tag_one_field_string.txt">https://github.com/roc-lang/roc/blob/144b02939d8ac04b32ae1a932ddc6f722adef01e/crates/compiler/test_mono/generated/inspect_derived_tag_one_field_string.txt</a></p>



<a name="493989728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493989728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493989728">(Jan 15 2025 at 18:19)</a>:</h4>
<p>That seems like a bug</p>



<a name="493989814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493989814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493989814">(Jan 15 2025 at 18:20)</a>:</h4>
<p>Skipping a number seems very suspicious</p>



<a name="493994690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/493994690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#493994690">(Jan 15 2025 at 18:49)</a>:</h4>
<p>I can investigate on Friday if you don't have a mac <span class="user-mention" data-user-id="722031">@shua</span></p>



<a name="494000444"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494000444" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494000444">(Jan 15 2025 at 19:25)</a>:</h4>
<p>Thanks, I do not have a mac. I'll still keep reading mono source just for the heck of it</p>



<a name="494001020"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494001020" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494001020">(Jan 15 2025 at 19:29)</a>:</h4>
<p>just to sanity check: "apple-silicon" would follow "aarch64" codepaths right? not, for instance, "aarch32"</p>



<a name="494001267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494001267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494001267">(Jan 15 2025 at 19:31)</a>:</h4>
<p>that's correct</p>



<a name="494421537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494421537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494421537">(Jan 17 2025 at 19:00)</a>:</h4>
<p>I have not figured this out yet but will continue tomorrow <span class="user-mention" data-user-id="722031">@shua</span></p>



<a name="494423316"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494423316" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494423316">(Jan 17 2025 at 19:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/channel/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets/near/493989814">said</a>:</p>
<blockquote>
<p>Skipping a number seems very suspicious</p>
</blockquote>
<p>Is skipping a number suspicious only for <code>#Derived_gen</code> module or for all? I ask because, eg <code>#Derived.1</code> and <code>#Derived.3</code> are in that output but <code>#Derived.2</code> is nowhere to be found.</p>



<a name="494465375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494465375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494465375">(Jan 18 2025 at 01:05)</a>:</h4>
<p>best I've managed to dig:</p>
<ul>
<li>the differing function is <code>Str.replace_each_help</code> (or <code>Str.61</code> in the non-prettified output)</li>
<li>the <code>#Derived_gen.20</code> and <code>#Derived_gen.21</code> idents are (on my linux machine) generated in <code>apply_trmc</code> for the two recursive functions <code>Str.first_match_help</code>/<code>Str.63</code> and <code>Str.replace_each_help</code>/<code>Str.61</code> respectively. Whatever fishy is happening has to be happening after <code>Str.first_match_help</code> arg symbols are generated but before <code>Str.replace_each_help</code> arg symbols are generated</li>
<li><code>apply_trmc</code> is looping over procs, and holding a <code>mut</code> reference to the <code>IdentIds</code> struct which generates <code>#Derived_gen</code> idents, so I can't see how anything else could be incrementing the counter there, it must be something in <code>apply_trmc</code> loop</li>
<li>procs have to be iterated over in the same order on linux and mac osx, otherwise the generated idents might differ</li>
</ul>
<p>I've added a <code>dbg!(_)</code> to the current branch to hopefully get enough info from a failing test run to tell what might be different between mac and linux.</p>



<a name="494492944"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494492944" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494492944">(Jan 18 2025 at 08:00)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="515757">@Luke Boswell</span> for the mac output. It looks like on mac, the order in which procs are processed is changed. So <code>Str.matches_at_help</code> is processed, creates <code>#Derived_gen.21</code> then throws the result away, then <code>Str.replace_each_help</code> is processed. On linux that order is switched, and <code>Str.matches_at_help</code> creates <code>#Derived_gen.25</code> but since it's thrown away, you don't see that in the output.</p>
<p>That is the only difference in the order of how procs are processed between the two platforms for the <code>test_mono</code> <code>inspect_derived_tag_one_field_string</code> test.</p>
<p>Now to figure out why the order changes.</p>



<a name="494499461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494499461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494499461">(Jan 18 2025 at 09:19)</a>:</h4>
<p>Glad you found that. Sounds puzzling</p>



<a name="494504157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494504157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494504157">(Jan 18 2025 at 10:20)</a>:</h4>
<p>Yeah, that's some great info</p>



<a name="494512292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494512292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494512292">(Jan 18 2025 at 12:04)</a>:</h4>
<p>trying to find any info if <code>HashMap</code> with <code>wyhash::WyHash</code> is stable across cpu/os targets or not. There's an implicit requirement in our code that the procs are iterated in the same order, but we're just calling <code>HashMap::values</code> which I don't think gives much guarantees in terms of ordering.</p>



<a name="494515043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494515043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494515043">(Jan 18 2025 at 12:35)</a>:</h4>
<p>I think <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> knows all bout that</p>



<a name="494524556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494524556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494524556">(Jan 18 2025 at 14:35)</a>:</h4>
<blockquote>
<p>we're just calling <code>HashMap::values</code></p>
</blockquote>
<p>Can you link to this line of code @shua?</p>



<a name="494524659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494524659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494524659">(Jan 18 2025 at 14:36)</a>:</h4>
<p>We could try sorting them and see if it fixes our issue.</p>



<a name="494524830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494524830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494524830">(Jan 18 2025 at 14:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/channel/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets/near/494524556">said</a>:</p>
<blockquote>
<blockquote>
<p>we're just calling <code>HashMap::values</code></p>
</blockquote>
<p>Can you link to this line of code @shua?</p>
</blockquote>
<p>Is it <a href="https://github.com/roc-lang/roc/blob/1e087b138d18f90daaf60b5eb71ed7afc3498064/crates/compiler/mono/src/tail_recursion.rs#L52">here</a>?</p>



<a name="494526178"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494526178" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494526178">(Jan 18 2025 at 14:56)</a>:</h4>
<blockquote>
<p>We could try sorting them and see if it fixes our issue.</p>
</blockquote>
<p>Sorting comes with a perf cost, maybe we should just ignore diffs where only the numbers are different? That seems pretty reasonable</p>



<a name="494530399"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494530399" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494530399">(Jan 18 2025 at 15:55)</a>:</h4>
<p>that would hide bugs where there are symbol collisions</p>



<a name="494530436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494530436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494530436">(Jan 18 2025 at 15:55)</a>:</h4>
<p>Ok</p>



<a name="494530442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494530442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494530442">(Jan 18 2025 at 15:56)</a>:</h4>
<p>i think sorting is okay, can revisit it if it becomes a big problem or do it only in tests</p>



<a name="494530568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494530568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494530568">(Jan 18 2025 at 15:57)</a>:</h4>
<p>A lot of Eq, Ord, PartialOrd would have to be added all over the place to be able to sort, WyHash allows passing a seed, I'm looking into that now</p>



<a name="494530634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494530634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494530634">(Jan 18 2025 at 15:58)</a>:</h4>
<p>we could try using indexmap or btreemap, something that does guarantee iteration based on insertion order (which should be the same I guess?)</p>



<a name="494530709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494530709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494530709">(Jan 18 2025 at 15:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/channel/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets/near/494530568">said</a>:</p>
<blockquote>
<p>A lot of Eq, Ord, PartialOrd would have to be added all over the place to be able to sort, WyHash allows passing a seed, I'm looking into that now</p>
</blockquote>
<p>We could <code>sort_by_key</code> to avoid those bounds (as long as you can get some sortable key from the keys or values)</p>



<a name="494531089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494531089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494531089">(Jan 18 2025 at 16:03)</a>:</h4>
<p>^at least, <code>Vec::sort_by_key</code> exists, not sure if that's what yous were thinking</p>



<a name="494537229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494537229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494537229">(Jan 18 2025 at 17:25)</a>:</h4>
<p>Yeah, if you need stable insertion order, I would switch to index map</p>



<a name="494537344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494537344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494537344">(Jan 18 2025 at 17:27)</a>:</h4>
<p>Wyhash generally uses the same hash for given bit widths, but it definitely differs on 32bit and could differ in other cases.</p>



<a name="494537453"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494537453" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494537453">(Jan 18 2025 at 17:28)</a>:</h4>
<p>All that said, feels quite surprising if this is the very first time we hit an ordering difference, but it's possible</p>



<a name="494547645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494547645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494547645">(Jan 18 2025 at 19:33)</a>:</h4>
<p>Alright, my sort is pretty hacky but that fixed it. I'll push my code later tonight and will make an issue to switch to an index map.</p>



<a name="494568338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494568338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494568338">(Jan 18 2025 at 22:17)</a>:</h4>
<p>Fix in <a href="https://github.com/roc-lang/roc/pull/7532">PR#7532</a><br>
Index map issue: <a href="https://github.com/roc-lang/roc/issues/7531">#7531</a></p>



<a name="494580497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494580497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494580497">(Jan 18 2025 at 23:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets/near/494537453">said</a>:</p>
<blockquote>
<p>All that said, feels quite surprising if this is the very first time we hit an ordering difference, but it's possible</p>
</blockquote>
<p>It's strange to me that something as wide-ranging as hashing differences would only show up by swapping two elements in a single test run. I would expect to be seeing a bunch more things out of order</p>



<a name="494581230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494581230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494581230">(Jan 18 2025 at 23:34)</a>:</h4>
<p>I changed the dbg's in my PR, because I want to check</p>
<ol>
<li>that the keys are hashing the same between linux and mac, and </li>
<li>that the insertion into the map is happening in the same order</li>
</ol>
<p>if the problem is 1, then something like indexmap would help, but if it's 2 then indexmap would not fix this issue and I'd have to look further back in the flow to see where they diverge.</p>
<p>Specifically, my ask is someone with an arm mac please pull the latest from that branch, run <code>cargo test -p test_mono inspect_derived_tag_one -- --nocapture &gt;dbg-mac.out 2&gt;&amp;1</code> and then send me <code>dbg-mac.out</code> file.</p>
<p>edit: <code>2&gt;&amp;1</code> was in the wrong place</p>



<a name="494581281"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494581281" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494581281">(Jan 18 2025 at 23:35)</a>:</h4>
<p>gotta sign off soon but feel free to add a <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span>  to that comment if you're doing it so two people don't duplicate work</p>



<a name="494581304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494581304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494581304">(Jan 18 2025 at 23:36)</a>:</h4>
<p>ha, comment was ninja'd by <span class="user-mention" data-user-id="515757">@Luke Boswell</span> , thanks for looking into this with me!</p>



<a name="494581377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494581377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494581377">(Jan 18 2025 at 23:36)</a>:</h4>
<p><a href="/user_uploads/22008/FkflM2AZ1V26_JOhyHJk2VQb/dbg-mac.out">dbg-mac.out</a></p>



<a name="494581438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494581438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494581438">(Jan 18 2025 at 23:37)</a>:</h4>
<p>ah dang, I got my shell args out of order, can you run </p>
<div class="codehilite"><pre><span></span><code>cargo test -p test_mono inspect_derived_tag_one -- --nocapture &gt;dbg-mac.out 2&gt;&amp;1
</code></pre></div>
<p>instead?</p>



<a name="494581519"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494581519" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494581519">(Jan 18 2025 at 23:38)</a>:</h4>
<p><a href="/user_uploads/22008/tLz4kfIx-3PfjR3g4TiWYy2k/dbg-mac.out">dbg-mac.out</a></p>



<a name="494581857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494581857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494581857">(Jan 18 2025 at 23:43)</a>:</h4>
<p>oh weird, the dbg info is identical, so I can't find any difference in how the keys are hashed, nor any difference in the insertion order. Still intrigued, but this hopefully give more evidence that using something like indexmap to store the procedures would fix this issue, because it guarantees iteration over the insertion order (and insertion order is identical).</p>



<a name="494587199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494587199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494587199">(Jan 19 2025 at 00:54)</a>:</h4>
<p>Intriguing. You would expect the keys would need to hash differently for the iteration order to change. That is assuming:</p>
<ol>
<li>The hash tables are the same size (thus bucket indices are the same)</li>
<li>The hash table isn't intentionally random iteration order like with go.</li>
<li>The hash tables has no other architecture specific differences we are missing.</li>
</ol>



<a name="494587221"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494587221" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494587221">(Jan 19 2025 at 00:54)</a>:</h4>
<p>So I'm still quite surprised something is causing a difference here. Cause I think all 3 of those points should be the same between machines.</p>



<a name="494590870"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494590870" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494590870">(Jan 19 2025 at 01:45)</a>:</h4>
<p>as an aside, this is making me feel great about the design decision to have Roc's <code>Dict</code> iterate in insertion order <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="494591223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494591223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494591223">(Jan 19 2025 at 01:50)</a>:</h4>
<p>Yeah, I think you really need to either do insertion order or randomized (like in go). I guess what absl does is also kinda ok. Randomized in debug builds and arbitrary but consistent in release builds.</p>



<a name="494591269"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494591269" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494591269">(Jan 19 2025 at 01:51)</a>:</h4>
<p>Also, randomized doesn't have to be truly random. Can just be starting at a random point in the middle and then looping back to the front.</p>



<a name="494635206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494635206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494635206">(Jan 19 2025 at 12:01)</a>:</h4>
<p>Rust's default <code>HashMap</code> uses <code>RandomState</code> which initializes with seed from system random, but we <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/collections/src/all.rs#L7-L19">override it</a> in roc to be <code>WyHash::default()</code> which starts with the same seed  (the 0 value) every time. Maybe it would be a good idea to seed our <code>WyHash</code> instances with random numbers to flush out these incorrect assumptions on iteration order?</p>



<a name="494635490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/494635490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#494635490">(Jan 19 2025 at 12:04)</a>:</h4>
<p>.. trying that now to see how many tests fail</p>



<a name="495106636"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495106636" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495106636">(Jan 21 2025 at 17:15)</a>:</h4>
<p>spicy, we start hitting a couple <code>unreachable!</code>'s in inc_dec and <code>mono/src/borrow.rs</code> if we make <code>MutMap</code> use <code>std::collections::hash_map::RandomState</code></p>
<p>So I guess there is an assumption that all <code>MutMap</code>s iterate in the same order (if inserted in the same order I guess)?</p>



<a name="495107826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495107826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495107826">(Jan 21 2025 at 17:21)</a>:</h4>
<p>I'm going to try making a single seed that all <code>MutMap</code>s <code>WyHash</code> state start with, but which isn't the default 0, that should hopefully give less errors, but maybe might still give some if there's an implicit assumption that iteration is the same across multiple executions.</p>



<a name="495129961"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495129961" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495129961">(Jan 21 2025 at 19:32)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/blob/5b4c8e70d873e7f5e30f995aedea0199bf1f99b1/crates/compiler/gen_dev/src/lib.rs#L363-L364">https://github.com/roc-lang/roc/blob/5b4c8e70d873e7f5e30f995aedea0199bf1f99b1/crates/compiler/gen_dev/src/lib.rs#L363-L364</a></p>
<p>also found this nice comment, which was wrong at the time. <code>WyHash</code>'s default value, unlike <code>RandomState</code> is not random but the zero value.</p>



<a name="495167299"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495167299" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495167299">(Jan 21 2025 at 23:56)</a>:</h4>
<p>that was an interesting chase, but it looks like another part of the code (the lambda set interner) is under the assumption that maps, etc _should_ hash consistently with the default <code>BuildHasher</code>. <a href="https://github.com/roc-lang/roc/blob/a8def1a974a6dacdcd18656e66114880f4e92b59/crates/compiler/mono/src/layout/intern.rs#L585-L591">https://github.com/roc-lang/roc/blob/a8def1a974a6dacdcd18656e66114880f4e92b59/crates/compiler/mono/src/layout/intern.rs#L585-L591</a></p>
<p>So we cannot change <code>BuildHasher</code> to be something like <code>RandomState</code> (ie two calls to <code>BuildHasher::build_hasher</code> will return two differently behaving hashers) because that breaks some assumptions in the lambda set interner, which expects every call to <code>BuildHasher::hash_one</code> to be the same for the same input.</p>



<a name="495167438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495167438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495167438">(Jan 21 2025 at 23:57)</a>:</h4>
<p>doesn't explain why mac aarch64 was swapping elements, but it was an interesting dive.</p>



<a name="495167779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495167779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495167779">(Jan 22 2025 at 00:00)</a>:</h4>
<p>This has been a really interesting read. Definitely seems that we have a solid amount of code with implicit assumptions around hashing</p>



<a name="495170503"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495170503" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495170503">(Jan 22 2025 at 00:22)</a>:</h4>
<p>honourable mention to:</p>
<p>calling <code>.values().enumerate()</code> <a href="https://github.com/roc-lang/roc/blob/a8def1a974a6dacdcd18656e66114880f4e92b59/crates/compiler/mono/src/borrow.rs#L403-L415">https://github.com/roc-lang/roc/blob/a8def1a974a6dacdcd18656e66114880f4e92b59/crates/compiler/mono/src/borrow.rs#L403-L415</a> and then using <code>.values().nth(i)</code> later <a href="https://github.com/roc-lang/roc/blob/a8def1a974a6dacdcd18656e66114880f4e92b59/crates/compiler/mono/src/borrow.rs#L146">https://github.com/roc-lang/roc/blob/a8def1a974a6dacdcd18656e66114880f4e92b59/crates/compiler/mono/src/borrow.rs#L146</a></p>



<a name="495222087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495222087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495222087">(Jan 22 2025 at 08:18)</a>:</h4>
<p>I think the last thing I want to look into for this is how many tests fail with a different global seed on program start, where before it was effectively a different seed for every hashmap. I expect a  bunch of test_mono tests to fail, and maybe fixed by replacing <code>MutMap</code> usage with <code>VecMap</code> or something that guarantees consistent iteration.</p>



<a name="495358905"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495358905" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495358905">(Jan 22 2025 at 19:27)</a>:</h4>
<p>Yeah, I think we should switch over to <a href="https://github.com/indexmap-rs/indexmap">indexmap</a> for current uses of mutmap.</p>



<a name="495358995"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495358995" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495358995">(Jan 22 2025 at 19:28)</a>:</h4>
<p>Vecmap won't scale for large maps due to being a linear scan to lookup</p>



<a name="495456895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/mono%20mismatch%20between%20mac%20aarch64%20and%20rest%20of%20targets/near/495456895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets.html#495456895">(Jan 23 2025 at 09:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets/near/495358905">said</a>:</p>
<blockquote>
<p>Yeah, I think we should switch over to <a href="https://github.com/indexmap-rs/indexmap">indexmap</a> for current uses of mutmap.</p>
</blockquote>
<p>Issue is at <a href="https://github.com/roc-lang/roc/issues/7531">#7531</a></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>LLVM IR output in compiler crash during AOC! Â· bugs Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html">LLVM IR output in compiler crash during AOC!</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="486390939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486390939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486390939">(Dec 05 2024 at 20:48)</a>:</h4>
<p>Getting some interesting output after a simple change in my Day 5, Part 2 solution for AOC:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>ðŸ˜± LLVM errors when defining module; I wrote the full LLVM IR to "main.ll"

 Call parameter type does not match function signature!
  %load_opaque2 = load { %list.RocList, %list.RocList, i64, float, i8 }, ptr %"#arg1", align 8, !dbg !1891
 ptr  %call_user_defined_compare_function = call fastcc i8 @"#UserApp_67_14a58b912b778d42457329574d6284a94c25ccd4d26148cd2e979b6a93d4ec9"(i64 %load_opaque, i64 %load_opaque1, { %list.RocList, %list.RocList, i64, float, i8 } %load_opaque2), !dbg !1891

Location: crates/compiler/build/src/program.rs:283:9
</code></pre></div>
<p>I don't have LSP in my normal Editor (neovim), but when I open in Zed - which is using the stable LSP - it's all good.  But when I build with latest I get the above.</p>



<a name="486391094"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486391094" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486391094">(Dec 05 2024 at 20:49)</a>:</h4>
<p>Give me a sec and I'll push an update to my repo and paste a link</p>



<a name="486394166"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486394166" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486394166">(Dec 05 2024 at 21:12)</a>:</h4>
<p>Here it is:</p>
<p><a href="https://github.com/gamebox/aoc-2024/blob/main/day5/puzzle2/main.roc">https://github.com/gamebox/aoc-2024/blob/main/day5/puzzle2/main.roc</a></p>



<a name="486403548"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486403548" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486403548">(Dec 05 2024 at 22:23)</a>:</h4>
<p>Can you fully type <code>pageSprtByRules</code> and see what output you get?</p>



<a name="486403671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486403671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486403671">(Dec 05 2024 at 22:24)</a>:</h4>
<p>I'm working on a reduction right now, almost done</p>



<a name="486403721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486403721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486403721">(Dec 05 2024 at 22:24)</a>:</h4>
<p>I did, and it just gave me a weird type annotation warning</p>



<a name="486403757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486403757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486403757">(Dec 05 2024 at 22:24)</a>:</h4>
<p>I don't think it likes that it only returns two of the three tags in the union maybe?</p>



<a name="486403952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486403952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486403952">(Dec 05 2024 at 22:26)</a>:</h4>
<p>Are you typing it with the full union?</p>



<a name="486404243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486404243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486404243">(Dec 05 2024 at 22:28)</a>:</h4>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kn">module</span><span class="w"> </span><span class="err">[]</span>

<span class="nv">sortByRules</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">ruleMap</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nf">\</span><span class="nv">_a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">afters</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">ruleMap</span><span class="w"> </span><span class="nv">b</span>
<span class="w">            </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">withDefault</span><span class="w"> </span><span class="p">[]</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">afters</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kt">LT</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kt">GT</span>

<span class="nv">calculateMiddleTotal</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">sorter</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">sortByRules</span><span class="w"> </span><span class="p">(</span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">empty</span><span class="w"> </span><span class="p">{})</span>
<span class="w">    </span><span class="nv">fixed</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">sortWith</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="nv">sorter</span>

<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">len</span><span class="w"> </span><span class="nv">fixed</span>

<span class="nv">expect</span>
<span class="w">    </span><span class="nv">calculateMiddleTotal</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="mi">123</span>
</code></pre></div>
<p>Fails with</p>
<div class="codehilite"><pre><span></span><code>An internal compiler expectation was broken.
This is definitely a compiler bug.
Please file an issue here: &lt;https://github.com/roc-lang/roc/issues/new/choose&gt;
Errors defining module:
Call parameter type does not match function signature!
  %load_opaque2 = load { %list.RocList, %list.RocList, i64, float, i8 }, ptr %&quot;#arg1&quot;, align 8, !dbg !752
 ptr  %call_user_defined_compare_function = call fastcc i8 @test_1_3_52aff1341cf42f5e6559a2cf028663f7bbbc7576ac1948fc58784a0613b79(%lis
t.RocList %load_opaque, %list.RocList %load_opaque1, { %list.RocList, %list.RocList, i64, float, i8 } %load_opaque2), !dbg !752


Uncomment things nearby to see more details. IR written to `&quot;/var/folders/23/7wjdwv0n5t1b12fgvjmpc_fr0000gp/T/test.ll&quot;`
Location: crates/repl_expect/src/run.rs:561:9
</code></pre></div>



<a name="486404331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486404331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486404331">(Dec 05 2024 at 22:29)</a>:</h4>
<p>Nope, I left it with just a <code>_</code></p>



<a name="486404436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486404436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486404436">(Dec 05 2024 at 22:30)</a>:</h4>
<p>I kinda wish the List builtin module had an exported type alias for the comparison union</p>



<a name="486404463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486404463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486404463">(Dec 05 2024 at 22:30)</a>:</h4>
<p>Like Comp or something</p>



<a name="486404503"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486404503" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486404503">(Dec 05 2024 at 22:30)</a>:</h4>
<p>I've had similar issues with Bool as well</p>



<a name="486420819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486420819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486420819">(Dec 06 2024 at 01:04)</a>:</h4>
<p>The bug will either be the captures or the union. Not sure which. Should be easy to test though</p>



<a name="486420848"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486420848" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486420848">(Dec 06 2024 at 01:05)</a>:</h4>
<p>I assume the actual generated mono is bad and that is why the llvm ir is bad</p>



<a name="486426022"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486426022" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486426022">(Dec 06 2024 at 01:59)</a>:</h4>
<p>Maybe I can instrument the mono coming in?</p>



<a name="486431343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486431343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486431343">(Dec 06 2024 at 03:00)</a>:</h4>
<p>We have a flag have mono verify iteself</p>



<a name="486431440"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486431440" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486431440">(Dec 06 2024 at 03:01)</a>:</h4>
<p>Requires running roc through cargo I think (maybe works with any debug build of the compiler)</p>



<a name="486431532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486431532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486431532">(Dec 06 2024 at 03:02)</a>:</h4>
<p><code>ROC_CHECK_MONO_IR=1</code></p>



<a name="486431572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486431572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486431572">(Dec 06 2024 at 03:03)</a>:</h4>
<p>Cool</p>



<a name="486432981"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486432981" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486432981">(Dec 06 2024 at 03:19)</a>:</h4>
<p>I called it like this and no additional logging:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code><span class="nv">ROC_CHECK_MONO_IR</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>cargo<span class="w"> </span>run<span class="w"> </span>--<span class="w"> </span>build<span class="w"> </span>~/Development/aoc-roc-2024/day5/puzzle2/main.roc
</code></pre></div>



<a name="486433744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486433744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486433744">(Dec 06 2024 at 03:29)</a>:</h4>
<p>Double checked and check_ir found no problems</p>



<a name="486434593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486434593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486434593">(Dec 06 2024 at 03:39)</a>:</h4>
<p>Here's some source (Unrelated technically)</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>fixUpdate : RuleMap -&gt; (Update -&gt; Update)
fixUpdate = \ruleMap -&gt; \update -&gt;
    List.sortWith update (pageSortByRules ruleMap)
</code></pre></div>
<p>IR after RESET_REUSE:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>procedure : `#UserApp.fixUpdate` {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}
procedure = `#UserApp.fixUpdate` (`#UserApp.ruleMap`: {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}):
    ret `#UserApp.ruleMap`;
</code></pre></div>



<a name="486434637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486434637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486434637">(Dec 06 2024 at 03:39)</a>:</h4>
<p>BTW, I love this Roc/LLVMIR hybrid <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="486434758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486434758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486434758">(Dec 06 2024 at 03:41)</a>:</h4>
<p>WOW, that's strange.</p>
<p>The IR for the actual problem function:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>procedure : `#UserApp.pageSortByRules` {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}
procedure = `#UserApp.pageSortByRules` (`#UserApp.ruleMap`: {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}):
    ret `#UserApp.ruleMap`;
</code></pre></div>
<p>Which is exactly the same...</p>



<a name="486434768"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486434768" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486434768">(Dec 06 2024 at 03:41)</a>:</h4>
<p>Is this some weird some of interning issue?</p>



<a name="486434785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486434785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486434785">(Dec 06 2024 at 03:41)</a>:</h4>
<p>I'm going to have to learn a LOT to figure that out</p>



<a name="486442743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486442743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486442743">(Dec 06 2024 at 05:13)</a>:</h4>
<p>That function body looks very wrong (and by that I mean nonexistant)</p>



<a name="486496869"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486496869" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486496869">(Dec 06 2024 at 11:48)</a>:</h4>
<p>Yeah, gotta love functions becomes the Identity function random</p>



<a name="486496929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486496929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486496929">(Dec 06 2024 at 11:49)</a>:</h4>
<p>And the types are wrong for one of them</p>



<a name="486497564"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486497564" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486497564">(Dec 06 2024 at 11:53)</a>:</h4>
<p>Again the pageSortByRules  function is defined as :</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>pageSortByRules : RuleMap -&gt; (U64, U64 -&gt; _)
pageSortByRules = \ruleMap -&gt; \a, b -&gt;
    afters : List U64
    afters =
        Dict.get ruleMap b
        |&gt; Result.withDefault []

    contains : Bool
    contains = List.contains afters a

    if contains then
        LT
    else
        EQ
</code></pre></div>



<a name="486503852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486503852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486503852">(Dec 06 2024 at 12:31)</a>:</h4>
<p>Moving some functions back to lambdas....</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>fixUpdates : RuleMap, List Update -&gt; List Update
fixUpdates = \ruleMap, updates -&gt;
    List.map updates \update -&gt;
        List.sortWith update \a, b -&gt;
            afters =
                Dict.get ruleMap b
                |&gt; Result.withDefault []

            contains = List.contains afters a

            if contains then
                LT
            else
                EQ
</code></pre></div>
<p>Produces this mono after specialization</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>procedure : `#UserApp.fixUpdates` List List U64
procedure = `#UserApp.fixUpdates` (`#UserApp.ruleMap`: {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}, `#UserApp.updates`: List List U64):
    let `#UserApp.116` : List List U64 = CallByName `List.map` `#UserApp.updates` `#UserApp.ruleMap`;
    ret `#UserApp.116`;
</code></pre></div>
<p>Which to me seems wrong right from the call to <a href="http://List.map">List.map</a>.  I would expect a #UserMap.DD type procedure to be passed as the second argument.</p>



<a name="486504082"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486504082" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486504082">(Dec 06 2024 at 12:32)</a>:</h4>
<p>I found a possible candidate</p>
<div class="codehilite"><pre><span></span><code>procedure : `#UserApp.66` List U64
procedure = `#UserApp.66` (`#UserApp.update`: List U64, `#UserApp.ruleMap`: {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}):
    let `#UserApp.119` : List U64 = CallByName `List.sortWith` `#UserApp.update` `#UserApp.ruleMap`;
    ret `#UserApp.119`;
</code></pre></div>
<p>And that call is also wrong</p>



<a name="486504209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486504209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486504209">(Dec 06 2024 at 12:33)</a>:</h4>
<p>But maybe my brain isn't processing the type signatures right here.</p>



<a name="486504340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486504340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486504340">(Dec 06 2024 at 12:34)</a>:</h4>
<p>I'm guessing that <code>{List {U32, U32}, List {U64, List U64}, U64, Float32, U8}</code> is actually the closure struct</p>



<a name="486524560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486524560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486524560">(Dec 06 2024 at 14:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486404243">said</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kn">module</span><span class="w"> </span><span class="err">[]</span>

<span class="nv">sortByRules</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">ruleMap</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nf">\</span><span class="nv">_a</span><span class="p">,</span><span class="w"> </span><span class="nv">b</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">afters</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">ruleMap</span><span class="w"> </span><span class="nv">b</span>
<span class="w">            </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">withDefault</span><span class="w"> </span><span class="p">[]</span>

<span class="w">        </span><span class="kr">if</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">isEmpty</span><span class="w"> </span><span class="nv">afters</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="kt">LT</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="kt">GT</span>

<span class="nv">calculateMiddleTotal</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">sorter</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">sortByRules</span><span class="w"> </span><span class="p">(</span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">empty</span><span class="w"> </span><span class="p">{})</span>
<span class="w">    </span><span class="nv">fixed</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">sortWith</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="nv">sorter</span>

<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">len</span><span class="w"> </span><span class="nv">fixed</span>

<span class="nv">expect</span>
<span class="w">    </span><span class="nv">calculateMiddleTotal</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="mi">123</span>
</code></pre></div>
<p>Fails with</p>
<p><div class="codehilite"><pre><span></span><code>An internal compiler expectation was broken.
This is definitely a compiler bug.
Please file an issue here: &lt;https://github.com/roc-lang/roc/issues/new/choose&gt;
Errors defining module:
Call parameter type does not match function signature!
  %load_opaque2 = load { %list.RocList, %list.RocList, i64, float, i8 }, ptr %&quot;#arg1&quot;, align 8, !dbg !752
 ptr  %call_user_defined_compare_function = call fastcc i8 @test_1_3_52aff1341cf42f5e6559a2cf028663f7bbbc7576ac1948fc58784a0613b79(%lis
t.RocList %load_opaque, %list.RocList %load_opaque1, { %list.RocList, %list.RocList, i64, float, i8 } %load_opaque2), !dbg !752


Uncomment things nearby to see more details. IR written to `&quot;/var/folders/23/7wjdwv0n5t1b12fgvjmpc_fr0000gp/T/test.ll&quot;`
Location: crates/repl_expect/src/run.rs:561:9
</code></pre></div><br>
</p>
</blockquote>
<p>Don't know how you ran this, but I just tried and can't reproduce on stable or latest</p>



<a name="486525322"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486525322" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486525322">(Dec 06 2024 at 14:19)</a>:</h4>
<p>If I actually use this module, I get a illegal Option unwrap on this line:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="fm">debug_assert!</span><span class="p">(</span><span class="n">unspecialized</span><span class="p">.</span><span class="n">is_empty</span><span class="p">());</span>
</code></pre></div>



<a name="486527027"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486527027" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486527027">(Dec 06 2024 at 14:29)</a>:</h4>
<p>Ok, I had to do one more thing than this, annotate that the sorter's return type is _</p>



<a name="486527495"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486527495" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486527495">(Dec 06 2024 at 14:31)</a>:</h4>
<p>If I annotate it with the expected type, but keep the implementation the same, same error.</p>



<a name="486527588"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486527588" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486527588">(Dec 06 2024 at 14:32)</a>:</h4>
<p>If I annotate it to return the exact Tag union it returns, a mismatch</p>



<a name="486527645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486527645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486527645">(Dec 06 2024 at 14:32)</a>:</h4>
<p>If I annotate it to return the Tag union it returns but make it open, a mismatch</p>



<a name="486528028"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486528028" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486528028">(Dec 06 2024 at 14:34)</a>:</h4>
<p>Actually, I could reproduce with yours.  I just had a weird editor bug where it was renaming Test.roc to test.roc</p>



<a name="486528491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486528491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486528491">(Dec 06 2024 at 14:36)</a>:</h4>
<p>If I need a function that returns [A, B C], and I get a function that returns just [A, B] that should not be a mismatch.  Comparing tag unions should be something like Set.isSubset a b (Making that up)</p>



<a name="486528567"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486528567" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486528567">(Dec 06 2024 at 14:37)</a>:</h4>
<p>And {A, B} is a subset of {A, B, C}</p>



<a name="486529666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486529666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486529666">(Dec 06 2024 at 14:42)</a>:</h4>
<p>Interesting to note that running <code>roc build --optimize</code> causes a seg fault instead <span aria-label="eyes" class="emoji emoji-1f440" role="img" title="eyes">:eyes:</span></p>



<a name="486529956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486529956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486529956">(Dec 06 2024 at 14:44)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span>  as a not-Rust-pro, how do you cause a seg fault in rust outside of unsafe?  I'm not saying this isn't happening in an unsafe block, but just want to know if we have known edges were that can happen.</p>



<a name="486532005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486532005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486532005">(Dec 06 2024 at 14:55)</a>:</h4>
<p>Ok, I just read it myself.  OOB slice index, dangling reference, uninitialized variables, and even some panics</p>



<a name="486532604"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486532604" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486532604">(Dec 06 2024 at 14:58)</a>:</h4>
<p>Hmm segfaults in the compiler are quite rare, but yeah, do a debug build <code>cargo build --bin roc</code> and run <code>valgrind ./target/debug/roc YOURCOMMAND</code> and share the output here</p>



<a name="486532737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486532737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486532737">(Dec 06 2024 at 14:59)</a>:</h4>
<p>To be clear the segfault is happening during <code>roc build --optimize</code>? Not when running the produced binary?</p>



<a name="486535248"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486535248" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486535248">(Dec 06 2024 at 15:11)</a>:</h4>
<p>Yes</p>



<a name="486535441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486535441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486535441">(Dec 06 2024 at 15:12)</a>:</h4>
<p>And I've minimized it to a function returning a tag union that is a closure referencing specifically a <code>Dict</code></p>



<a name="486536545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486536545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486536545">(Dec 06 2024 at 15:18)</a>:</h4>
<p>A custom tag union doesn't do it, a list doesn't do it, a struct doesn't do it</p>



<a name="486536821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486536821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486536821">(Dec 06 2024 at 15:19)</a>:</h4>
<p>Valgrind may be able to give additional hints even though you already have the function</p>



<a name="486540034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486540034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486540034">(Dec 06 2024 at 15:36)</a>:</h4>
<p>If memory serves, Valgrind can't run on arm64/MacOS on my version of the OS</p>



<a name="486542218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486542218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486542218">(Dec 06 2024 at 15:47)</a>:</h4>
<p>Ah yes, didn't know you were on macos, I can run it, is it just <code>roc build --optimize</code> on <a href="https://github.com/gamebox/aoc-2024/blob/main/day5/puzzle2/main.roc">https://github.com/gamebox/aoc-2024/blob/main/day5/puzzle2/main.roc</a> ?</p>



<a name="486547940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486547940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486547940">(Dec 06 2024 at 16:14)</a>:</h4>
<p>Yes</p>



<a name="486547951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486547951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486547951">(Dec 06 2024 at 16:14)</a>:</h4>
<p>Thank you</p>



<a name="486550843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486550843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486550843">(Dec 06 2024 at 16:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486528491">said</a>:</p>
<blockquote>
<p>If I need a function that returns [A, B C], and I get a function that returns just [A, B] that should not be a mismatch.  Comparing tag unions should be something like Set.isSubset a b (Making that up)</p>
</blockquote>
<p>Yeah, we made functions return open tag unions by default, so I believe this should work.</p>



<a name="486551039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486551039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486551039">(Dec 06 2024 at 16:28)</a>:</h4>
<p>It gives a mismatch and specifies a union with the tag that is not in the return value</p>



<a name="486551078"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486551078" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486551078">(Dec 06 2024 at 16:28)</a>:</h4>
<p>Oh, but it won't work cause you pass it to something as a lambda</p>



<a name="486551164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486551164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486551164">(Dec 06 2024 at 16:28)</a>:</h4>
<p>I bet that unification doesn't understand the open tag return type and how to unify</p>



<a name="486551174"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486551174" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486551174">(Dec 06 2024 at 16:28)</a>:</h4>
<p>?</p>



<a name="486551213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486551213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486551213">(Dec 06 2024 at 16:29)</a>:</h4>
<p>That should be a simple unification</p>



<a name="486551652"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486551652" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486551652">(Dec 06 2024 at 16:31)</a>:</h4>
<p>Probably. Just guessing it isn't implemented. Returning open tags was a feature added to roc later. It probably didn't consider lambdas when it was written. Probably just considered returned values from calls</p>



<a name="486552236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486552236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486552236">(Dec 06 2024 at 16:34)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> might remember from back in the day <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="486552351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486552351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486552351">(Dec 06 2024 at 16:34)</a>:</h4>
<p>I'm just getting "LLVM errors when defining module" no segfault, what's your roc commit <span class="user-mention" data-user-id="781658">@Anthony Bullard</span>?</p>



<a name="486553108"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486553108" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486553108">(Dec 06 2024 at 16:38)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> 0274d9b9971c91975c82a91c9e3057e6365f9701</p>



<a name="486553428"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486553428" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486553428">(Dec 06 2024 at 16:40)</a>:</h4>
<p>That's with debug build</p>



<a name="486553454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486553454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486553454">(Dec 06 2024 at 16:40)</a>:</h4>
<p>I can try with release if that makes a diff</p>



<a name="486553667"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486553667" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486553667">(Dec 06 2024 at 16:41)</a>:</h4>
<p>It made no diff <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="486553906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486553906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486553906">(Dec 06 2024 at 16:42)</a>:</h4>
<p>I'm going to Linux-ify my old 2019 Mac Mini sometime soon, but right now, only have my M1 Pro MacBook Pro</p>



<a name="486554322"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486554322" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486554322">(Dec 06 2024 at 16:45)</a>:</h4>
<p>I'm only going so deep on this right now because it's the second time in 5 days of AOC I've hit a compiler crash when doing something rather mundane in my solution - and couldn't overcome it without using a completely different solution.   I appreciate all of your help <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> <span class="user-mention" data-user-id="361169">@Anton</span></p>



<a name="486554672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486554672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486554672">(Dec 06 2024 at 16:46)</a>:</h4>
<p>I still did not get a segfault on that commit but I'm running it with valgrind now anyway, it's taking a long time but that's expected</p>



<a name="486554826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486554826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486554826">(Dec 06 2024 at 16:47)</a>:</h4>
<p>Interesting.  I get it every time I hit this bug</p>



<a name="486555061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486555061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486555061">(Dec 06 2024 at 16:48)</a>:</h4>
<p>Running this:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>module [calculateMiddleTotal]

calculateMiddleTotal = \{} -&gt;
    rulesMap : List U64
    rulesMap = []
    sorter = \_a, _b -&gt; if List.isEmpty rulesMap then GT else LT
    fixed = List.sortWith [] sorter
    List.len fixed

expect
    calculateMiddleTotal {} == 123
</code></pre></div>
<p>Results in no error with <code>build --optimize</code></p>



<a name="486555150"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486555150" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486555150">(Dec 06 2024 at 16:49)</a>:</h4>
<p>But this does</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>module [calculateMiddleTotal]

calculateMiddleTotal = \{} -&gt;
    rulesMap : Dict U64 (List Str)
    rulesMap = Dict.empty {}
    sorter = \_a, _b -&gt; if Dict.isEmpty rulesMap then GT else LT
    fixed = List.sortWith [] sorter
    List.len fixed

expect
    calculateMiddleTotal {} == 123
</code></pre></div>



<a name="486555172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486555172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486555172">(Dec 06 2024 at 16:49)</a>:</h4>
<p>Sorry, a segfault</p>



<a name="486555486"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486555486" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486555486">(Dec 06 2024 at 16:50)</a>:</h4>
<p>And most interestingly to me, this also doesn't segfault and compiles as expected:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>module [calculateMiddleTotal]

calculateMiddleTotal = \{} -&gt;
    rulesMap : Dict U64 (List Str)
    rulesMap = Dict.empty {}
    sorter = \a, b -&gt; if a &gt; b then GT else LT
    fixed = List.sortWith [] sorter
    List.len fixed

expect
    calculateMiddleTotal {} == 123
</code></pre></div>



<a name="486555530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486555530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486555530">(Dec 06 2024 at 16:51)</a>:</h4>
<p>The only difference is we don't close over the Dict</p>



<a name="486555995"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486555995" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486555995">(Dec 06 2024 at 16:53)</a>:</h4>
<p>This DOES fail with a segfault (using Result * *)</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>module [calculateMiddleTotal]

calculateMiddleTotal = \{} -&gt;
    rulesMap : Result U64 [BooHoo]
    rulesMap = Err BooHoo
    sorter = \_a, _b -&gt; if Result.isOk rulesMap then GT else LT
    fixed = List.sortWith [] sorter
    List.len fixed

expect
    calculateMiddleTotal {} == 123
</code></pre></div>



<a name="486556216"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486556216" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486556216">(Dec 06 2024 at 16:54)</a>:</h4>
<p>Also fails with segfault when using Set:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>module [calculateMiddleTotal]

calculateMiddleTotal = \{} -&gt;
    rulesMap : Set U64
    rulesMap = Set.empty {}
    sorter = \_a, _b -&gt; if Set.isEmpty rulesMap then GT else LT
    fixed = List.sortWith [] sorter
    List.len fixed

expect
    calculateMiddleTotal {} == 123
</code></pre></div>



<a name="486556821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486556821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486556821">(Dec 06 2024 at 16:57)</a>:</h4>
<p>Jesus, it even fails with just closing over a <code>Str</code></p>



<a name="486557188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486557188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486557188">(Dec 06 2024 at 16:58)</a>:</h4>
<p>Supplying the same function (in any permutation) to something like <code>List.map</code> is no issue</p>



<a name="486557340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486557340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486557340">(Dec 06 2024 at 16:59)</a>:</h4>
<p>And it always seems happy with closing over (List *)</p>



<a name="486557646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486557646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486557646">(Dec 06 2024 at 17:00)</a>:</h4>
<blockquote>
<p>Jesus, it even fails with just closing over a <code>Str</code></p>
</blockquote>
<p>That is nice actually, it simplifies the bug no?</p>



<a name="486557721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486557721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486557721">(Dec 06 2024 at 17:01)</a>:</h4>
<p>can you share the example with Str?</p>



<a name="486557734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486557734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486557734">(Dec 06 2024 at 17:01)</a>:</h4>
<p>But it works with just <code>U64</code> <span class="user-mention" data-user-id="361169">@Anton</span></p>



<a name="486557861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486557861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486557861">(Dec 06 2024 at 17:02)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> as you please:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>module [calculateMiddleTotal]

calculateMiddleTotal = \{} -&gt;
    rulesMap : Str
    rulesMap = "Hello"
    sorter = \_a, _b -&gt; if Str.isEmpty rulesMap then GT else LT
    fixed = List.sortWith [] sorter
    List.len fixed

expect
    calculateMiddleTotal {} == 123
</code></pre></div>



<a name="486558015"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558015" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558015">(Dec 06 2024 at 17:02)</a>:</h4>
<p>I'm literally just changing three things, the type annotation of rulesMap, the value of it, and the condition in the <code>if</code> inside of the lambda to match that type</p>



<a name="486558176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558176">(Dec 06 2024 at 17:03)</a>:</h4>
<p>ty, taking a look</p>



<a name="486558340"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558340" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558340">(Dec 06 2024 at 17:04)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span>  Here's the mono for it, very interesting:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>procedure : `Test.calculateMiddleTotal` U64
procedure = `Test.calculateMiddleTotal` (`Test.7`: {}):
    let `Test.rulesMap` : Str = "Hello";
    let `Test.12` : List [] = Array [];
    let `Test.14` : Str = "UnresolvedTypeVar: specialize_symbol res_layout";
    Crash `Test.14`
</code></pre></div>



<a name="486558361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558361">(Dec 06 2024 at 17:04)</a>:</h4>
<p>lol</p>



<a name="486558428"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558428" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558428">(Dec 06 2024 at 17:04)</a>:</h4>
<p>I'm assuming that's an Easter Egg for a unexpected condition?</p>



<a name="486558475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558475">(Dec 06 2024 at 17:05)</a>:</h4>
<p>i have no idea, probably</p>



<a name="486558516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558516">(Dec 06 2024 at 17:05)</a>:</h4>
<p>Remember, this is supposed to be a minimal repro for the problem</p>



<a name="486558593"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558593" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558593">(Dec 06 2024 at 17:05)</a>:</h4>
<p>yep</p>



<a name="486558612"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558612" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558612">(Dec 06 2024 at 17:05)</a>:</h4>
<p>And when running against the real code, the lambda body was instead becoming the <code>id</code> function</p>



<a name="486558749"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558749" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558749">(Dec 06 2024 at 17:06)</a>:</h4>
<p>Here's the mono for that</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>procedure : `#UserApp.fixUpdate` {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}
procedure = `#UserApp.fixUpdate` (`#UserApp.ruleMap`: {List {U32, U32}, List {U64, List U64}, U64, Float32, U8}):
    ret `#UserApp.ruleMap`;
</code></pre></div>



<a name="486558836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486558836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486558836">(Dec 06 2024 at 17:06)</a>:</h4>
<p>From this source:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>fixUpdate : RuleMap -&gt; (Update -&gt; Update)
fixUpdate = \ruleMap -&gt; \update -&gt;
    List.sortWith update (pageSortByRules ruleMap)
</code></pre></div>



<a name="486559008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559008">(Dec 06 2024 at 17:07)</a>:</h4>
<p>My eyes still don't feel trained to read the mono ir very well, but that definitely looks like <code>id</code> to me</p>



<a name="486559215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559215">(Dec 06 2024 at 17:08)</a>:</h4>
<p>It has something to do with the layout of the closed over value I'm assuming</p>



<a name="486559297"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559297" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559297">(Dec 06 2024 at 17:09)</a>:</h4>
<p>I don't even know yet what to instrument to find the issue.  But I'm trying to learn :-)</p>



<a name="486559370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559370">(Dec 06 2024 at 17:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486559008">said</a>:</p>
<blockquote>
<p>My eyes still don't feel trained to read the mono ir very well, but that definitely looks like <code>id</code> to me</p>
</blockquote>
<p>For <code>fixUpdate</code> you mean?</p>



<a name="486559723"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559723" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559723">(Dec 06 2024 at 17:11)</a>:</h4>
<p>Yeah, but it looks like it takes an arg <code>#UserApp.ruleMap</code> of the type <code>{List {U32, U32}, List {U64, List U64}, U64, Float32, U8}</code> and returns the same type, which is correct since it <code>ret</code>s  that arg as the only instruction.</p>



<a name="486559886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559886">(Dec 06 2024 at 17:12)</a>:</h4>
<p>yes that's fine. But it's not returning a function, it's returning the captures of the defunctionalized function</p>



<a name="486559916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559916">(Dec 06 2024 at 17:12)</a>:</h4>
<p>Ok, so that's the closure env?</p>



<a name="486559958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559958">(Dec 06 2024 at 17:13)</a>:</h4>
<p>yes, the env of the underlying <code>\update -&gt; ...</code> fn</p>



<a name="486559987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486559987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486559987">(Dec 06 2024 at 17:13)</a>:</h4>
<p>That's what I suspected</p>



<a name="486560151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486560151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486560151">(Dec 06 2024 at 17:14)</a>:</h4>
<p>wait so for the List example you're seeing a crash when generating LLVM code right?</p>



<a name="486560167"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486560167" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486560167">(Dec 06 2024 at 17:14)</a>:</h4>
<p>something like this</p>
<div class="codehilite"><pre><span></span><code>An internal compiler expectation was broken.
This is definitely a compiler bug.
Please file an issue here: &lt;https://github.com/roc-lang/roc/issues/new/choose&gt;
Errors defining module:
Call parameter type does not match function signature!
  %load_opaque2 = load %str.RocStr, ptr %&quot;#arg1&quot;, align 8, !dbg !491
 ptr  %call_user_defined_compare_function = call fastcc i8 @Test_sorter_e84248fb50d0833361d0417df114b0b3b3448fff97c39cdde963b09a9aebb8(ptr %load_opaque, ptr %load_opaque1, %str.RocStr %load_opaque2), !dbg !491
</code></pre></div>



<a name="486560365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486560365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486560365">(Dec 06 2024 at 17:15)</a>:</h4>
<p>No List is the only thing that works</p>



<a name="486560395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486560395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486560395">(Dec 06 2024 at 17:15)</a>:</h4>
<p>err sorry the Str one you posted earlier</p>



<a name="486560419"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486560419" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486560419">(Dec 06 2024 at 17:15)</a>:</h4>
<p><a href="#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486558340">https://roc.zulipchat.com/#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486558340</a><br>
this one</p>



<a name="486560543"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486560543" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486560543">(Dec 06 2024 at 17:16)</a>:</h4>
<p>Similar, yeah</p>
<div class="codehilite"><pre><span></span><code>An internal compiler expectation was broken.
This is definitely a compiler bug.
Please file an issue here: &lt;https://github.com/roc-lang/roc/issues/new/choose&gt;
ðŸ˜± LLVM errors when defining module; I wrote the full LLVM IR to &quot;main.ll&quot;

 Call parameter type does not match function signature!
  %load_opaque2 = load %str.RocStr, ptr %&quot;#arg1&quot;, align 8, !dbg !881
 ptr  %call_user_defined_compare_function = call fastcc i8 @Test_sorter_2c7d993eadf275d994a1f98b824972fece3cfca6b6ac52dd7bb717e1f5753(ptr %load_opaque, ptr %load_opaque1, %str.RocStr %load_opaque2), !dbg !881

Location: crates/compiler/build/src/program.rs:283:9
</code></pre></div>



<a name="486562612"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486562612" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486562612">(Dec 06 2024 at 17:27)</a>:</h4>
<p>ok well the code generation is definitely wrong</p>



<a name="486563053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563053">(Dec 06 2024 at 17:29)</a>:</h4>
<p>ive forgotten how all this works lol</p>



<a name="486563076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563076">(Dec 06 2024 at 17:29)</a>:</h4>
<p>the code needs to be simplified a lot</p>



<a name="486563530"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563530" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563530">(Dec 06 2024 at 17:31)</a>:</h4>
<p>Do you think the mono is wrong or the llvm code gen is wrong?</p>



<a name="486563679"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563679" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563679">(Dec 06 2024 at 17:32)</a>:</h4>
<p>Mono is doing something wrong</p>



<a name="486563707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563707">(Dec 06 2024 at 17:32)</a>:</h4>
<p>no mono is fine</p>



<a name="486563814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563814">(Dec 06 2024 at 17:33)</a>:</h4>
<p>the llvm gen is producing the wrong types</p>



<a name="486563858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563858">(Dec 06 2024 at 17:33)</a>:</h4>
<p>This is how we get that llvm I showed the the <code>Str</code> value being closed over:</p>
<p>In mono/src/ir.rs (in the function specialize_symbol)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">partial_proc</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_var</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arg_var</span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="n">partial_proc</span><span class="p">.</span><span class="n">annotation</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// this symbol is a function, that is used by-name (e.g. as an argument to another</span>
<span class="w">            </span><span class="c1">// function). Register it with the current variable, then create a function pointer</span>
<span class="w">            </span><span class="c1">// to it in the IR.</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">res_layout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">return_on_layout_error</span><span class="o">!</span><span class="p">(</span>
<span class="w">                </span><span class="n">env</span><span class="p">,</span>
<span class="w">                </span><span class="n">layout_cache</span><span class="p">.</span><span class="n">raw_from_var</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">arena</span><span class="p">,</span><span class="w"> </span><span class="n">arg_var</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">subs</span><span class="p">),</span>
<span class="w">                </span><span class="s">"specialize_symbol res_layout"</span>
<span class="w">            </span><span class="p">);</span>
</code></pre></div>



<a name="486563913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486563913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486563913">(Dec 06 2024 at 17:33)</a>:</h4>
<p>It's different for the other cases</p>



<a name="486566286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486566286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486566286">(Dec 06 2024 at 17:47)</a>:</h4>
<p>That's for rooting it to llvm. I'll definitely take a look later today. I haven't followed everything, what is the minimal roc file to repro?</p>



<a name="486567117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486567117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486567117">(Dec 06 2024 at 17:52)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> These two have different, but similar issues:</p>
<p><a href="#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486557861">https://roc.zulipchat.com/#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486557861</a><br>
<a href="#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486555486">https://roc.zulipchat.com/#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486555486</a></p>



<a name="486570545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486570545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486570545">(Dec 06 2024 at 18:16)</a>:</h4>
<p>Update: valgrind did not report any errors</p>



<a name="486571478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486571478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486571478">(Dec 06 2024 at 18:22)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="486573964"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486573964" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Stanley <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486573964">(Dec 06 2024 at 18:38)</a>:</h4>
<p>FWIW I got more or less the same error as the one at the top of this thread doing yesterday. The context was <code>List.sortWith</code> and at first I thought it might be the rather specific function I had (which was a closure over a Dict) ... but replacing it even with the most tediously vanilla function produced the same issue. I ended up having to write my own mergesort rather than use <code>List.sortWith</code>. I realise that's horribly unspecific but I hadn't looked at this thread so didn't save the output, but just shrugged and moved on, so I don't have the code I was running. I do have the LLVM IR, if that's of any interest, but I have no idea what I'd be looking for!</p>



<a name="486576074"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486576074" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486576074">(Dec 06 2024 at 18:51)</a>:</h4>
<p>Yeah, probably a bug with calling the zig builtin for sortWith</p>



<a name="486587542"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486587542" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486587542">(Dec 06 2024 at 20:13)</a>:</h4>
<p>I want to test this case with other functions that expect a callback that returns a tag union</p>



<a name="486587614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486587614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486587614">(Dec 06 2024 at 20:13)</a>:</h4>
<p>Outside of say Result</p>



<a name="486597493"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486597493" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486597493">(Dec 06 2024 at 21:28)</a>:</h4>
<p>Ok, definitely seems like only <code>List.sortWith</code></p>



<a name="486597573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486597573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486597573">(Dec 06 2024 at 21:29)</a>:</h4>
<p>I just checked <code>List.walkWith</code> which has a callback which has a similar unnamed tag union and no issues with the closure over <code>Dict k v</code></p>



<a name="486601708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486601708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486601708">(Dec 06 2024 at 22:05)</a>:</h4>
<p>Damn, it's been so long since I worked with LLVM IR, I didn't even know about opaque pointers!</p>



<a name="486602440"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486602440" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486602440">(Dec 06 2024 at 22:12)</a>:</h4>
<p>Ok, so we are loading a struct from a pointer and then supplying that as the third arg to the sorter, which is expecting three pointers.  So the whole problem is SOMETHING thinks the layout allows it to be passed by value, but SOMETHING else is like "Nah, give me a pointer bro"</p>



<a name="486602700"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486602700" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486602700">(Dec 06 2024 at 22:14)</a>:</h4>
<p>I think if the llvmir is this:</p>
<p>```llvm<br>
  %call_user_defined_compare_function = call fastcc i8 @Test_sorter_ebcdc7d352ecfa1e7d1b4ba0644f3ace5e7298b5a4113365f27eee831460e3a2(ptr %load_opaque, ptr %load_opaque1, ptr %"#arg1"), !dbg !924</p>
<div class="codehilite"><pre><span></span><code>Then it will work as expected, minus probably some other detail I&#39;m missing
</code></pre></div>



<a name="486602728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486602728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486602728">(Dec 06 2024 at 22:14)</a>:</h4>
<p>Can I just build the main.ll with llvm directly?</p>



<a name="486603219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603219">(Dec 06 2024 at 22:18)</a>:</h4>
<p>Zig is pretty nice with llvm, <code>zig build-exe -lc main.ll host-stub-things.zig</code> you probably will need to provide an implementation for roc_alloc and friends in another zig file</p>



<a name="486603418"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603418" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603418">(Dec 06 2024 at 22:20)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> Can I just give it an <code>ll</code> file and a platform <code>.a</code> file?</p>



<a name="486603438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603438">(Dec 06 2024 at 22:20)</a>:</h4>
<p>Thats the easiest</p>



<a name="486603443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603443">(Dec 06 2024 at 22:20)</a>:</h4>
<p>I was trying llc and then clang</p>



<a name="486603449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603449">(Dec 06 2024 at 22:20)</a>:</h4>
<p>Let's see</p>



<a name="486603463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603463">(Dec 06 2024 at 22:20)</a>:</h4>
<p>Gotta find the platform cache on my system</p>



<a name="486603494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603494">(Dec 06 2024 at 22:21)</a>:</h4>
<p>I found it the other day...</p>



<a name="486603531"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603531" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603531">(Dec 06 2024 at 22:21)</a>:</h4>
<p><code>~/.cache/roc/...</code></p>



<a name="486603608"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486603608" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486603608">(Dec 06 2024 at 22:22)</a>:</h4>
<p>Im on my phone rn..</p>



<a name="486606338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606338">(Dec 06 2024 at 22:48)</a>:</h4>
<p>I found it, thanks Luke.</p>



<a name="486606364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606364">(Dec 06 2024 at 22:48)</a>:</h4>
<p>Ok, verified that we just to NOT load the struct from the pointer</p>



<a name="486606386"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606386" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606386">(Dec 06 2024 at 22:48)</a>:</h4>
<p>Now time to figure out where in the hell we make that decision :-)</p>



<a name="486606445"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606445" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606445">(Dec 06 2024 at 22:49)</a>:</h4>
<p><code>gen_llvm</code>?</p>



<a name="486606485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606485">(Dec 06 2024 at 22:49)</a>:</h4>
<p>Yeah, I got that part</p>



<a name="486606620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606620">(Dec 06 2024 at 22:51)</a>:</h4>
<p>Probably around <code>is_passed_by_reference</code> in <code>layout.rs</code> I'd assume</p>



<a name="486606639"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606639" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606639">(Dec 06 2024 at 22:51)</a>:</h4>
<p>I'll do this goose chase later</p>



<a name="486606686"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606686" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606686">(Dec 06 2024 at 22:52)</a>:</h4>
<p>But good to know that I'm making progress that others probably could have done in 30 minutes in instead 2 days</p>



<a name="486606727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606727">(Dec 06 2024 at 22:52)</a>:</h4>
<p>:-)</p>



<a name="486606751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606751">(Dec 06 2024 at 22:52)</a>:</h4>
<p>Thanks for sharing the action... this is better than any Netflix series</p>



<a name="486606785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606785">(Dec 06 2024 at 22:52)</a>:</h4>
<p>I'm showing my thinking so that hopefully a more experienced dev on the team can help me avoid deadends and give me tips.</p>



<a name="486606799"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486606799" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486606799">(Dec 06 2024 at 22:53)</a>:</h4>
<p>I came in knowing nothing about Roc's compiler</p>



<a name="486616453"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486616453" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486616453">(Dec 07 2024 at 00:47)</a>:</h4>
<p>Ok, I definitely found where the issue manifests, hopefully will found the issue soon.</p>



<a name="486616901"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486616901" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486616901">(Dec 07 2024 at 00:53)</a>:</h4>
<p>Yeah, you seem to be diving into this quite well</p>



<a name="486616911"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486616911" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486616911">(Dec 07 2024 at 00:53)</a>:</h4>
<p>The fun of c abi and such</p>



<a name="486617229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486617229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486617229">(Dec 07 2024 at 00:57)</a>:</h4>
<p>Yeah, I just can't figure out why the hell it looks at the roc function's type, and says "I see your llvm type is <code>i8 (ptr, ptr, ptr)</code>, but I'm going to give you <code>(ptr, ptr, { %list.RocList, %list.RocList, i64, float, i8 })</code> anyway"</p>



<a name="486617612"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486617612" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486617612">(Dec 07 2024 at 01:02)</a>:</h4>
<p>LLVM decides the value type is a Struct instead of a value</p>



<a name="486617903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486617903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486617903">(Dec 07 2024 at 01:06)</a>:</h4>
<p>So it seems that the function type is wrong</p>



<a name="486618334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486618334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486618334">(Dec 07 2024 at 01:12)</a>:</h4>
<p>Shit....this is either coming from inkwell, or we are doing something weird when populating the environment</p>



<a name="486618396"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486618396" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486618396">(Dec 07 2024 at 01:13)</a>:</h4>
<p>I wonder if it's worth testing out this branch <a href="https://github.com/roc-lang/roc/pull/6921">https://github.com/roc-lang/roc/pull/6921</a></p>



<a name="486618419"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486618419" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486618419">(Dec 07 2024 at 01:14)</a>:</h4>
<p>The LLVM upgrade is basically done... we just have some CI shenanigans to land that upgrade</p>



<a name="486618473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486618473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486618473">(Dec 07 2024 at 01:14)</a>:</h4>
<p>Does it upgrade inkwell?</p>



<a name="486618478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486618478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486618478">(Dec 07 2024 at 01:14)</a>:</h4>
<p>Yes</p>



<a name="486618492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486618492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486618492">(Dec 07 2024 at 01:14)</a>:</h4>
<p>We are currently using an older custom fork, but this upgrades us to a more recent release</p>



<a name="486620986"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486620986" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486620986">(Dec 07 2024 at 01:46)</a>:</h4>
<p>Reminder that llvm does not deal with abi</p>



<a name="486621000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486621000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486621000">(Dec 07 2024 at 01:47)</a>:</h4>
<p>It leaves that up to us</p>



<a name="486621016"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486621016" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486621016">(Dec 07 2024 at 01:47)</a>:</h4>
<p>It passes a pointer if we tell it to pass a pointer. It passes a struct if we tell it to pass a struct</p>



<a name="486621038"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486621038" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486621038">(Dec 07 2024 at 01:47)</a>:</h4>
<p>Yes by the function type</p>



<a name="486621093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486621093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486621093">(Dec 07 2024 at 01:48)</a>:</h4>
<p>So likely, this is a case of two different parts of our code disagreeing (that or zig generated llvm following cabi and us disagreeing)</p>



<a name="486621128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486621128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486621128">(Dec 07 2024 at 01:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486621038">said</a>:</p>
<blockquote>
<p>Yes by the function type</p>
</blockquote>
<p>Not completely if I recall. I think we generate a call instruction without verifying the llvm function signature. It is solely generated off the roc mono types</p>



<a name="486621320"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486621320" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486621320">(Dec 07 2024 at 01:51)</a>:</h4>
<p><span class="user-mention" data-user-id="781658">@Anthony Bullard</span> ... I'm also interested in learning more about this aspect of our compiler. If you keep dropping thoughts in here as you go I would appreciate that. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span> </p>
<p>I've been poking at the compiler from both ends, but mono is still black magic</p>



<a name="486621523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486621523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486621523">(Dec 07 2024 at 01:54)</a>:</h4>
<p>I have a lot to learn still</p>



<a name="486641508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486641508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486641508">(Dec 07 2024 at 06:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC!/near/486602700">said</a>:</p>
<blockquote>
<p>I think if the llvmir is this:</p>
<p>```llvm<br>
  %call_user_defined_compare_function = call fastcc i8 @Test_sorter_ebcdc7d352ecfa1e7d1b4ba0644f3ace5e7298b5a4113365f27eee831460e3a2(ptr %load_opaque, ptr %load_opaque1, ptr %"#arg1"), !dbg !924</p>
<p><div class="codehilite"><pre><span></span><code>Then it will work as expected, minus probably some other detail I&#39;m missing
````

I think the problem is that `Test_sorter_ebcdc7d352ecfa1e7d1b4ba0644f3ace5e7298b5a4113365f27eee831460e3a2` is defined to take a ptr in the third parameter but it should be RocStr (ptr + 2 other fields)
</code></pre></div><br>
</p>
</blockquote>



<a name="486641898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486641898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486641898">(Dec 07 2024 at 06:50)</a>:</h4>
<p>oh wait no yeah the call site is wrong</p>



<a name="486641908"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486641908" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486641908">(Dec 07 2024 at 06:50)</a>:</h4>
<p>although passing the str via reference seems kind of silly but that's a separate thing</p>



<a name="486642671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486642671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486642671">(Dec 07 2024 at 07:02)</a>:</h4>
<p>Alright this is the fix for at least one of the issues<br>
<a href="https://github.com/roc-lang/roc/pull/7317">https://github.com/roc-lang/roc/pull/7317</a></p>



<a name="486642680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486642680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486642680">(Dec 07 2024 at 07:02)</a>:</h4>
<p>Not sure why there's a unique path for this specifically but</p>



<a name="486642770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486642770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486642770">(Dec 07 2024 at 07:04)</a>:</h4>
<p>seems to fix the Dict example too</p>



<a name="486643221"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486643221" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486643221">(Dec 07 2024 at 07:11)</a>:</h4>
<p>Yeah, we have a lot of abi mess in the llvm backend that needs to be merged into one universal tagged abi. That just takes arguments with their type info and generates correct c abi. We have a lot of adhoc stuff today</p>



<a name="486644287"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486644287" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486644287">(Dec 07 2024 at 07:27)</a>:</h4>
<p>this isn't ABI though. there should just be a better abstraction for loading parameters for internal calls.</p>



<a name="486660762"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486660762" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486660762">(Dec 07 2024 at 11:22)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> You are my personal hero right now.  That change emits the exact llvm I was doing by hand, and fixes the issue in the minimal repro!</p>



<a name="486660801"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486660801" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486660801">(Dec 07 2024 at 11:23)</a>:</h4>
<p>I am happy that I was hovering over this exact point in the code, but I had no idea what to do yet</p>



<a name="486660946"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486660946" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486660946">(Dec 07 2024 at 11:25)</a>:</h4>
<p>And how that I see this, it makes a LOT of sense.  The layout_interner can look out the closure data and tell us that it should be passed by reference or not.  And then we only create the new load instruction of course when it is passed by value.</p>



<a name="486661155"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486661155" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486661155">(Dec 07 2024 at 11:28)</a>:</h4>
<p>And it also fixes my AOC solution.  Now for me to finish it <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="486687368"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486687368" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486687368">(Dec 07 2024 at 17:09)</a>:</h4>
<p>sweet!</p>



<a name="486694569"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/LLVM%20IR%20output%20in%20compiler%20crash%20during%20AOC%21/near/486694569" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/LLVM.20IR.20output.20in.20compiler.20crash.20during.20AOC.21.html#486694569">(Dec 07 2024 at 18:46)</a>:</h4>
<p>I ran into this issue in my solution and this fixed it for me too. Thanks!</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
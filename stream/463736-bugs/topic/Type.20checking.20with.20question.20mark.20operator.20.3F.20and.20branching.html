<html>
<head><meta charset="utf-8"><title>Type checking with question mark operator ? and branching · bugs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html">Type checking with question mark operator ? and branching</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="561503210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561503210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561503210">(Dec 02 2025 at 19:33)</a>:</h4>
<p>Type checking is failing with this example. Am I missing something or is this a bug?</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">get_greeting</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">Try</span><span class="p">(</span><span class="no">Str</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span>
<span class="n">get_greeting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="p">{}</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">match</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Try</span><span class="o">.</span><span class="n">Ok</span><span class="p">(</span><span class="no">List</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="o">[</span><span class="s2">"hello"</span><span class="o">]</span><span class="p">)</span><span class="sc">?)</span><span class="p">,</span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Err</span><span class="p">(</span><span class="no">Impossible</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">main!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="no">Stdout</span><span class="o">.</span><span class="n">line!</span><span class="p">(</span><span class="n">get_greeting</span><span class="p">({})</span><span class="o">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s2">"Error!"</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>
<p>I get the following error message:</p>
<div class="codehilite"><pre><span></span><code>This expression is used in an unexpected way:
   ┌─ test/fx/question_mark_operator_branching.roc:10:5
   │
10 │     match 0 {
11 │         0 =&gt; Try.Ok(List.first([&quot;hello&quot;])?),
12 │         _ =&gt; Err(Impossible)
13 │     }

It has the type:
    Try(Str, [Impossible, .._others])

But the type annotation says it should have the type:
    Try(Str, [ListWasEmpty])
</code></pre></div>



<a name="561512630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561512630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561512630">(Dec 02 2025 at 20:27)</a>:</h4>
<p>seems like a bug, I'll look into it!</p>



<a name="561512862"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561512862" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561512862">(Dec 02 2025 at 20:29)</a>:</h4>
<p>maybe an even simpler test with "if" branching is possible. I haven’t checked if it’s "match" specific or reproducible with branching in general.</p>



<a name="561513517"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561513517" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561513517">(Dec 02 2025 at 20:33)</a>:</h4>
<p>it's that we don't have polarity yet (cc <span class="user-mention" data-user-id="341568">@Jared Ramirez</span>, not sure if you've started on that yet!) so it's treating <code>[ListWasEmpty]</code> from <code>List.first</code> as a closed union</p>



<a name="561513574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561513574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561513574">(Dec 02 2025 at 20:33)</a>:</h4>
<p>I can manually annotate all the builtins as open and it should fix it</p>



<a name="561513623"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561513623" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561513623">(Dec 02 2025 at 20:34)</a>:</h4>
<p>and then can put them back to the current signatures after we add polarity to the type-checker</p>



<a name="561514609"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561514609" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561514609">(Dec 02 2025 at 20:40)</a>:</h4>
<p>Meanwhile, I’m just going to do a double match to make the type checker happy. Now I’m getting this for my program. Not sure where to start looking at. Any suggestions?</p>
<div class="codehilite"><pre><span></span><code>❯ roc day02.roc

Roc crashed: e_closure: failed to resolve capture value
</code></pre></div>



<a name="561517241"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561517241" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hardy <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561517241">(Dec 02 2025 at 20:57)</a>:</h4>
<p>I have also seen the "e_closure" problem. It occured to me when i tried following:</p>
<div class="codehilite"><pre><span></span><code>    for line in test_input.split_on(&quot;\n&quot;) {
        if line.starts_with(&quot;L&quot;) {
            val = I64.from_str(line.drop_prefix(&quot;L&quot;))
            dbg val
        }
    }
</code></pre></div>
<p>After peeking at your solution i got around that one by moving the <code>line.drop_prefix("L")</code> before the if. So my guess would be that there is some problem using a value in an inner scope which is already captured in an outer scope or something. Not sure how properly describe it.</p>



<a name="561522735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561522735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561522735">(Dec 02 2025 at 21:30)</a>:</h4>
<p>can you give me a .roc file to repro?</p>



<a name="561522802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561522802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561522802">(Dec 02 2025 at 21:30)</a>:</h4>
<p>doesn't need to be minimal, just something where I can run <code>roc</code> and reproduce it</p>



<a name="561522908"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561522908" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561522908">(Dec 02 2025 at 21:30)</a>:</h4>
<p>yep, exactly what I was preparing</p>



<a name="561523500"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561523500" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561523500">(Dec 02 2025 at 21:34)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/issues/8547">https://github.com/roc-lang/roc/issues/8547</a></p>



<a name="561523720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561523720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561523720">(Dec 02 2025 at 21:35)</a>:</h4>
<p>Don’t know if Claude root cause analysis is correct, but I figured I’d leave it there for you to judge.</p>



<a name="561525447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561525447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561525447">(Dec 02 2025 at 21:48)</a>:</h4>
<p>thanks! the original error in this thread is fixed now btw</p>



<a name="561548666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561548666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Edwin Santos <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561548666">(Dec 03 2025 at 01:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="479073">Matthieu Pizenberg</span> <a href="#narrow/channel/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching/near/561514609">said</a>:</p>
<blockquote>
<p>Meanwhile, I’m just going to do a double match to make the type checker happy. Now I’m getting this for my program. Not sure where to start looking at. Any suggestions?</p>
<p><div class="codehilite"><pre><span></span><code>❯ roc day02.roc

Roc crashed: e_closure: failed to resolve capture value
</code></pre></div><br>
</p>
</blockquote>
<p>I've also been having this issue with closures, got it with this sample program:</p>
<div class="codehilite"><pre><span></span><code>main! = |args| {
    identity = |a| a
    init_try : Try(U32, [SomeError, ..others])
    init_try = Err(SomeError)
    final_try = match init_try {
            Ok(ok) =&gt; Ok(ok)
            Err(e) =&gt; Err(identity(e))
    }
    was_an_error = Try.is_err(final_try)

    Stdout.line!(&quot;final_try is an error: ${was_an_error}&quot;)
    Ok({})

}

# Error: Roc crashed: e_closure: failed to resolve capture value
</code></pre></div>
<p>I tried with Strings and numerics and without type signatures they would crash, with type signatures they can succeed. But when using a Try type this always fails, with or without a type signature or changing the error type to something like [..others] or just SomeError. I also swapped Err(SomeError) with Ok(30) and still get the closure error. Was trying to get a closure like  |_| Exit(101) going.</p>



<a name="561554224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561554224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561554224">(Dec 03 2025 at 02:45)</a>:</h4>
<p><span class="user-mention" data-user-id="986975">@Edwin Santos</span> <span class="user-mention" data-user-id="479073">@Matthieu Pizenberg</span>  this is fixed now!</p>



<a name="561554316"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561554316" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jared Ramirez <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561554316">(Dec 03 2025 at 02:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching/near/561513517">said</a>:</p>
<blockquote>
<p>it's that we don't have polarity yet (cc <span class="user-mention silent" data-user-id="341568">Jared Ramirez</span>, not sure if you've started on that yet!) so it's treating <code>[ListWasEmpty]</code> from <code>List.first</code> as a closed union</p>
</blockquote>
<p>i have polarity partially implemented, but there’s still a bit of work until its ready to go</p>



<a name="561554341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Type%20checking%20with%20question%20mark%20operator%20%3F%20and%20branching/near/561554341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Type.20checking.20with.20question.20mark.20operator.20.3F.20and.20branching.html#561554341">(Dec 03 2025 at 02:47)</a>:</h4>
<p>yeah no rush! modifying the types in <code>Builtin.roc</code> to make the tag unions expicitly open fixed it</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
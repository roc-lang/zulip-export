<html>
<head><meta charset="utf-8"><title>Found another segfault! · bugs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html">Found another segfault!</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="561590416"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561590416" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561590416">(Dec 03 2025 at 08:53)</a>:</h4>
<p>Here is the issue with the minimal example <a href="https://github.com/roc-lang/roc/issues/8553">https://github.com/roc-lang/roc/issues/8553</a><br>
Both these mains trigger a segfault with the platform used in test/fx/</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">main!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">sublist</span><span class="p">({</span><span class="w"> </span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">sublist</span><span class="p">({</span><span class="w"> </span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">})</span>
<span class="p">}</span>

<span class="n">main!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Str</span><span class="o">.</span><span class="n">to_utf8</span><span class="p">(</span><span class="s2">"11"</span><span class="p">)</span>
<span class="w">    </span><span class="n">_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">sublist</span><span class="p">({</span><span class="w"> </span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">sublist</span><span class="p">({</span><span class="w"> </span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>



<a name="561631273"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561631273" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561631273">(Dec 03 2025 at 11:54)</a>:</h4>
<p>even simpler segfault:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">main!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_bool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="p">}</span>
</code></pre></div>



<a name="561635707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561635707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561635707">(Dec 03 2025 at 12:16)</a>:</h4>
<p>Could reproduce. With "roc test", I also get a stack trace, which is pretty helpful.  Source:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">module</span><span class="o">[]</span>
<span class="n">expect</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</code></pre></div>
<div class="spoiler-block"><div class="spoiler-header">
<p>stack trace</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>ez@desktop-nixos ~/c/testing-roc [1]&gt; ~/code/roc/zig-out/bin/roc test<br>
thread 13052 panic: Use-after-free: incref on already-freed memory<br>
/home/ez/code/roc/src/builtins/utils.zig:258:13: 0x4bdd9fd in increfRcPtrC (mod.zig)<br>
            @panic("Use-after-free: incref on already-freed memory");<br>
            ^<br>
/home/ez/code/roc/src/builtins/utils.zig:353:24: 0x4984515 in increfDataPtrC (mod.zig)<br>
    return increfRcPtrC(isizes, inc_amount);<br>
                       ^<br>
/home/ez/code/roc/src/eval/StackValue.zig:188:42: 0x45be3d1 in copyToPtr (mod.zig)<br>
            builtins.utils.increfDataPtrC(alloc_ptr, 1);<br>
                                         ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:782:30: 0x45c9d6b in pushCopy (mod.zig)<br>
            try src.copyToPtr(&amp;self.runtime_layout_store, ptr.?, roc_ops);<br>
                             ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:10661:54: 0x50708f9 in evalLookupLocal (mod.zig)<br>
                const copy_result = try self.pushCopy(b.value, roc_ops);<br>
                                                     ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:9000:55: 0x4dee219 in scheduleExprEval (mod.zig)<br>
                const value = try self.evalLookupLocal(lookup, expected_rt_var, roc_ops);<br>
                                                      ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:8719:46: 0x4bdf732 in evalWithExpectedType (mod.zig)<br>
                    try self.scheduleExprEval(&amp;work_stack, &amp;value_stack, eval_item.expr_idx, eval_item.expected_rt_var, roc_ops);<br>
                                             ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:500:45: 0x4987c1d in eval (mod.zig)<br>
        return try self.evalWithExpectedType(expr_idx, roc_ops, null);<br>
                                            ^<br>
/home/ez/code/roc/src/eval/test_runner.zig:198:49: 0x49cedd9 in eval (mod.zig)<br>
        const result = try self.interpreter.eval(expr_idx, ops);<br>
                                                ^<br>
/home/ez/code/roc/src/eval/test_runner.zig:223:41: 0x478c7e3 in eval_all (mod.zig)<br>
                const result = self.eval(stmt.s_expect.body) catch |err| {<br>
                                        ^<br>
/home/ez/code/roc/src/cli/main.zig:3094:41: 0x47d4b3a in rocTest (main.zig)<br>
    const summary = test_runner.eval_all() catch |err| {<br>
                                        ^<br>
/home/ez/code/roc/src/cli/main.zig:576:41: 0x47f29f2 in mainArgs (main.zig)<br>
        .test_cmd =&gt; |test_args| rocTest(allocs, test_args),<br>
                                        ^<br>
/home/ez/code/roc/src/cli/main.zig:508:13: 0x47f4a63 in main (main.zig)<br>
    mainArgs(&amp;allocs, args) catch {<br>
            ^<br>
/home/ez/opt/zig/lib/std/start.zig:627:37: 0x47f5021 in main (std.zig)<br>
            const result = root.main() catch |err| {<br>
                                    ^<br>
/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c:95:7: 0x945dcc0 in libc_start_main_stage2 (/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c)<br>
 exit(main(argc, argv, envp));<br>
      ^<br>
???:?:?: 0x936af89 in ??? (???)<br>
Unwind error at address <code>exe:0x936af89</code> (error.MissingFDE), trace may be incomplete</p>
<p>fish: Job 1, '~/code/roc/zig-out/bin/roc test' terminated by signal SIGABRT (Abort)</p>
</div></div>



<a name="561651400"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561651400" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561651400">(Dec 03 2025 at 13:28)</a>:</h4>
<p>Ok, Claude found out what seems to be the issue. I’ll prepare a PR.</p>



<a name="561655124"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561655124" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561655124">(Dec 03 2025 at 13:44)</a>:</h4>
<p>Actually its fix doesn’t work for lists of lists ...</p>



<a name="561658168"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561658168" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561658168">(Dec 03 2025 at 13:57)</a>:</h4>
<p>No time to continue looking into it today.</p>



<a name="561716620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561716620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561716620">(Dec 03 2025 at 17:39)</a>:</h4>
<p>With a bit of luck, this might be the last blocking bug to be able to solve AoC 2 :)</p>



<a name="561719744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Found%20another%20segfault%21/near/561719744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Found.20another.20segfault.21.html#561719744">(Dec 03 2025 at 17:55)</a>:</h4>
<p><a href="/user_uploads/22008/ZjCPOp5QBOKvnFd5xRdb2ijy/BUGFIX_LIST_EQUALITY_UAF.md">BUGFIX_LIST_EQUALITY_UAF.md</a></p>
<p>Earlier today, I got claude to be able to fix the simple case for list equality, but it would still fail at nested list equality, so I didn’t make a PR. Here is the report I had, in case it’s of help to anyone giving it another try.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Fluffing doesn&#x27;t naively work for tags 췅 bugs 췅 Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html">Fluffing doesn&#x27;t naively work for tags</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="489039117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489039117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489039117">(Dec 15 2024 at 00:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/489038532">said</a>:</p>
<blockquote>
<p>Do we intend to support using tag unions as effect parameters? (The top-level data container, where structs already work.)</p>
</blockquote>
<p>The "fluffing" workaround we identified <a href="#narrow/channel/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust">yesterday</a> doesn't seem to work for tags, but maybe I'm fluffing wrong. This caused me some confusion when debugging my struct-passing effects by creating tag-passing effects for sub-fields of those structs. (Are my phrases and jargon making sense? I'm open to better wordings.) I don't have any plans (yet) for tag-passing effects in production, but I think it's still good to identify whether payloadful-tag-passing effects are possible and how to enable them.</p>
<p>Reproduction: <a href="https://github.com/roc-lang/basic-cli/compare/main...JanCVanB:basic-cli:bug_repro___payloadful_tag_fluffing">https://github.com/roc-lang/basic-cli/compare/main...JanCVanB:basic-cli:bug_repro___payloadful_tag_fluffing</a></p>
<p>Types:</p>
<div class="codehilite"><pre><span></span><code>Fluff : { a : U64, b : U64, c : U64, d : U64 }
fluff : Fluff
fluff = { a: 0, b: 0, c: 0, d: 0 }

HappyPayloadlessTag : [Foo, Bar, Baz]
SadPayloadfulTag : [Foo U8, Bar, Baz]
SadPayloadfulTagFluffed : [Foo U8 Fluff, Bar, Baz]

sendHappyPayloadlessTag! : HappyPayloadlessTag =&gt; Result {} Str
sendSadPayloadfulTag! : SadPayloadfulTag =&gt; Result {} Str
sendSadPayloadfulTagFluffed! : SadPayloadfulTagFluffed =&gt; Result {} Str
</code></pre></div>
<p>Execution:</p>
<div class="codehilite"><pre><span></span><code>jan@framey:~/_code/JanCVanB/basic-cli$ roc version
roc nightly pre-release, built from commit 10ebd02 on Sa 14 Dez 2024 10:33:15 UTC
jan@framey:~/_code/JanCVanB/basic-cli$ git log -2
commit 00decff4bc84a80a2ebd921da8a728527775b89d (HEAD -&gt; bug_repro___payloadful_tag_fluffing, origin/bug_repro___payloadful_tag_fluffing)
Author: Jan &lt;jancvanb@pm.me&gt;
Date:   Fri Dec 13 12:50:11 2024 -0700

    Demonstrate that fluffing tags doesn&#39;t seem to work

commit fbdd5e68fe286ae7f999d549d0e761df0b3773cf (origin/main, origin/HEAD, main)
Merge: 2a15c4a 0f8b306
Author: Luke Boswell &lt;lukewilliamboswell@gmail.com&gt;
Date:   Sat Dec 14 16:38:37 2024 +1100

    Merge pull request #287 from roc-lang/refactor

    Refactor into reusable crates
jan@framey:~/_code/JanCVanB/basic-cli$ ./bug_repro___run.sh
================================================================================
游끢 Running ./jump-start.sh ...
--------------------------------------------------------------------------------
+ &#39;[&#39; -z &#39;&#39; &#39;]&#39;
+ echo &#39;Warning: ROC environment variable is not set... I&#39;\&#39;&#39;ll try with just &#39;\&#39;&#39;roc&#39;\&#39;&#39;.&#39;
Warning: ROC environment variable is not set... I&#39;ll try with just &#39;roc&#39;.
+ ROC=roc
+ roc build --lib ./platform/libapp.roc
0 errors and 0 warnings found in 146 ms while successfully building:

    ./platform/libapp
+ cargo build --release
    Finished `release` profile [optimized] target(s) in 0.05s
+ &#39;[&#39; -n &#39;&#39; &#39;]&#39;
+ cp target/release/libhost.a ./platform/libhost.a
+ roc build --linker=legacy build.roc
0 errors and 0 warnings found in 327 ms while successfully building:

    build
================================================================================

================================================================================
游 This is ./examples/bug_repro_happy.roc :
--------------------------------------------------------------------------------
app [main!] { pf: platform &quot;../platform/main.roc&quot; }

import pf.BugRepro
import pf.Stdout

main! = \{} -&gt;

    tag = Foo

    _ = Stdout.line! &quot;游분 tag: $(Inspect.toStr tag)&quot;
    BugRepro.sendHappyPayloadlessTag! tag
    |&gt; Result.mapErr (\message -&gt; Exit 1 message)

--------------------------------------------------------------------------------
游끢 Running ./examples/bug_repro_happy.roc ...
--------------------------------------------------------------------------------
游분 tag: Foo
游 tag: HappyPayloadlessTag::Foo
================================================================================

================================================================================
游 This is ./examples/bug_repro_sad1.roc :
--------------------------------------------------------------------------------
app [main!] { pf: platform &quot;../platform/main.roc&quot; }

import pf.BugRepro
import pf.Stdout

main! = \{} -&gt;

    tag = Foo 100

    _ = Stdout.line! &quot;游분 tag: $(Inspect.toStr tag)&quot;
    BugRepro.sendSadPayloadfulTag! tag
    |&gt; Result.mapErr (\message -&gt; Exit 1 message)

--------------------------------------------------------------------------------
游끢 Running ./examples/bug_repro_sad1.roc ...
--------------------------------------------------------------------------------
thread &#39;main&#39; panicked at /home/big-ci-user/.cargo/git/checkouts/inkwell-946411d814d2c9f8/89e06af/src/types/enums.rs:487:13:
Found StructType(StructType { struct_type: Type { address: 0x5641cd5a3390, llvm_type: &quot;{ [1 x i8], i8 }&quot; } }) but expected the PointerType variant
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
================================================================================

================================================================================
游 This is ./examples/bug_repro_sad2.roc :
--------------------------------------------------------------------------------
app [main!] { pf: platform &quot;../platform/main.roc&quot; }

import pf.BugRepro
import pf.Stdout

main! = \{} -&gt;

    tag = Foo 100 BugRepro.fluff

    _ = Stdout.line! &quot;游분 tag: $(Inspect.toStr tag)&quot;
    BugRepro.sendSadPayloadfulTagFluffed! tag
    |&gt; Result.mapErr (\message -&gt; Exit 1 message)

--------------------------------------------------------------------------------
游끢 Running ./examples/bug_repro_sad2.roc ...
--------------------------------------------------------------------------------
thread &#39;main&#39; panicked at /home/big-ci-user/.cargo/git/checkouts/inkwell-946411d814d2c9f8/89e06af/src/types/enums.rs:487:13:
Found StructType(StructType { struct_type: Type { address: 0x55c9d88524c0, llvm_type: &quot;{ [5 x i64], i8 }&quot; } }) but expected the PointerType variant
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
================================================================================
jan@framey:~/_code/JanCVanB/basic-cli$
</code></pre></div>



<a name="489039378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489039378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489039378">(Dec 15 2024 at 00:41)</a>:</h4>
<p>Clarification: Fluffing tags does seem to work when they're passed to Rust inside of a struct. My celebratory posts yeterday in the above two linked threads were about that use case - a struct containing two tags, where one was fluffed like <code>Foo 100 BugRepro.fluff</code> above. The struct passes by pointer totally fine, containing the fluffed tag inside it, but passing just the fluffed tag alone causes the panics above.</p>



<a name="489039654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489039654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489039654">(Dec 15 2024 at 00:46)</a>:</h4>
<p>Clarification: Everywhere I say "struct" above, I meant "record".</p>



<a name="489039770"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489039770" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489039770">(Dec 15 2024 at 00:48)</a>:</h4>
<p>Disclaimer to any beginners - hi! <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span> This is platform dev stuff, seemingly at the edge of what's supported, totally not relevant to app dev.</p>



<a name="489040080"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040080" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040080">(Dec 15 2024 at 00:54)</a>:</h4>
<p>looks like we are recognizin we need to pass by pointer cause the value is larger, but some reason for tags, we fail to actually move them into an alloca and pass by pointer.</p>



<a name="489040174"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040174" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040174">(Dec 15 2024 at 00:56)</a>:</h4>
<p>haha... yeah.... very clearly have missing case in <code>to_cc_type</code>.</p>



<a name="489040176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040176">(Dec 15 2024 at 00:56)</a>:</h4>
<p>So very unsurprising this is broken</p>



<a name="489040184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040184">(Dec 15 2024 at 00:56)</a>:</h4>
<p><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span></p>



<a name="489040208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040208">(Dec 15 2024 at 00:57)</a>:</h4>
<p>Thanks for looking! Is there anything I can do to help fix and/or test from my current level of abstraction?</p>



<a name="489040210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040210">(Dec 15 2024 at 00:57)</a>:</h4>
<p>also our <code>is_passed_by_reference</code> function here is definitely wrong as well.</p>



<a name="489040292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040292">(Dec 15 2024 at 00:58)</a>:</h4>
<p>oh, <code>is_passed_by_reference</code> is not wrong, it is just for internal calls, not for c abi</p>



<a name="489040310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040310">(Dec 15 2024 at 00:59)</a>:</h4>
<p>Yet we are using it for c abi <span aria-label="man facepalming" class="emoji emoji-1f926-200d-2642" role="img" title="man facepalming">:man_facepalming:</span></p>



<a name="489040324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040324">(Dec 15 2024 at 00:59)</a>:</h4>
<p>Uh oh! Sounds <del>bad</del> <del>wrong</del> not good.</p>



<a name="489040409"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040409" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040409">(Dec 15 2024 at 01:00)</a>:</h4>
<p>yeah, a lot of this code has grown naturally and has never been rewriting. Our entire argument passing code probably should be fully rewritten to make smarter choice internally and to generate c-abi in a sane manner.</p>



<a name="489040442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040442">(Dec 15 2024 at 01:01)</a>:</h4>
<p>it has been on my backlog for essentially forever</p>



<a name="489040536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040536">(Dec 15 2024 at 01:02)</a>:</h4>
<p>Without generating action items / priorities for you, what do you expect this rot means for platform dev functionality? Are records the best effect parameter? What else might not work?</p>



<a name="489040783"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040783" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040783">(Dec 15 2024 at 01:07)</a>:</h4>
<p>I mean looking at this code, even structs are handled wrong</p>



<a name="489040796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040796">(Dec 15 2024 at 01:07)</a>:</h4>
<p>looks like we don't pass them by reference until at 4 registers in size (c-abi does this at 2)</p>



<a name="489040809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040809">(Dec 15 2024 at 01:07)</a>:</h4>
<p>We also don't pack structs if they are small enough to fit into a single registers</p>



<a name="489040847"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040847" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040847">(Dec 15 2024 at 01:08)</a>:</h4>
<p>(Sounds right - I have to fluff 4 U64s to trigger the pointer pass.)</p>



<a name="489040867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040867">(Dec 15 2024 at 01:08)</a>:</h4>
<p>So... I guess that primitives (int, dec, float, etc) should work ok. List and str as well... and really large structs</p>



<a name="489040877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040877">(Dec 15 2024 at 01:08)</a>:</h4>
<p>oh, and enums</p>



<a name="489040892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040892">(Dec 15 2024 at 01:09)</a>:</h4>
<p>enums == payloadless tags ?</p>



<a name="489040897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040897">(Dec 15 2024 at 01:09)</a>:</h4>
<p>yeah</p>



<a name="489040900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040900">(Dec 15 2024 at 01:09)</a>:</h4>
<p>Confirmed above too.</p>



<a name="489040923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040923">(Dec 15 2024 at 01:09)</a>:</h4>
<p>Everything else has a chance to work, but probably will fail</p>



<a name="489040992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489040992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489040992">(Dec 15 2024 at 01:10)</a>:</h4>
<p>Also, I probably should make this my next project. It seems that platform development and glue interest has grown a lot recently. So this is likely to become a new bottleneck.</p>



<a name="489041004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041004">(Dec 15 2024 at 01:10)</a>:</h4>
<p>Good thing I only plan to pass massively-nested records for a while... until I get into event streaming, but fluffing should work for those smaller records.</p>



<a name="489041030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041030">(Dec 15 2024 at 01:11)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/463736-bugs/topic/Fluffing.20doesn't.20naively.20work.20for.20tags/near/489040992">said</a>:</p>
<blockquote>
<p>Also, I probably should make this my next project.</p>
</blockquote>
<p><span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span></p>



<a name="489041039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041039">(Dec 15 2024 at 01:11)</a>:</h4>
<p>you also can just decompose the record if you prefer. That should work as well.</p>
<p>Instead of <code>effect! : {a: U8, b: U8, c: U8} -&gt; {}</code><br>
can do <code>effect! : U8, U8, U8 -&gt; {}</code></p>



<a name="489041104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041104">(Dec 15 2024 at 01:12)</a>:</h4>
<p>C ABI problems have been competing with lambda sets for the title of most notorious cause of bugs...would be INCREDIBLE to have a rewrite to address that!</p>



<a name="489041133"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041133" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041133">(Dec 15 2024 at 01:13)</a>:</h4>
<p>Any other rotted platform dev functionality you foresee? Just to save me wall-headbutting time <span aria-label="yum" class="emoji emoji-1f60b" role="img" title="yum">:yum:</span> <span aria-label="note" class="emoji emoji-1f4dd" role="img" title="note">:note:</span></p>



<a name="489041164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041164">(Dec 15 2024 at 01:13)</a>:</h4>
<p>um, I think that <code>roc_str</code> in rust my be too smart for it's own good which may lead to it not passing as expected in c-abi if passed by value.</p>



<a name="489041223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041223">(Dec 15 2024 at 01:14)</a>:</h4>
<p>ooh Luke was mentioning something about RocStr being annoying</p>



<a name="489041224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041224">(Dec 15 2024 at 01:14)</a>:</h4>
<p>I also wouldn't be surprised if some code in <code>roc_std</code> in general is already stale compared to the zig builtins</p>



<a name="489041264"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041264" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041264">(Dec 15 2024 at 01:15)</a>:</h4>
<p>I'd just like to know if there is a way we could fuzz or test the C ABI side of things.</p>



<a name="489041274"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041274" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041274">(Dec 15 2024 at 01:15)</a>:</h4>
<p>This is why the other big project I want to do is to make roc expose a ton of functions to the platform such that it doesn't need to know how to interact with roc types. It only needs to know how to pass them correctly with c-abi (which is overall a lot easier to get right from established langauges)</p>



<a name="489041332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041332">(Dec 15 2024 at 01:16)</a>:</h4>
<p>we can call it R<del>e</del>o<del>a</del>c<del>t</del> Hooks (<span class="user-mention" data-user-id="781658">@Anthony Bullard</span> please laugh at my five-year-old JavaScript joke)</p>



<a name="489041371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041371">(Dec 15 2024 at 01:17)</a>:</h4>
<blockquote>
<p>a way we could fuzz or test the C ABI side of things.</p>
</blockquote>
<p>I'm not sure how we would generate a source of truth for it.</p>



<a name="489041571"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489041571" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489041571">(Dec 15 2024 at 01:20)</a>:</h4>
<p>How might staleness in <code>roc_std</code> manifest to someone like me?</p>



<a name="489042621"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489042621" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489042621">(Dec 15 2024 at 01:38)</a>:</h4>
<p>Either weird mutation glitches or segfaults</p>



<a name="489042671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489042671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489042671">(Dec 15 2024 at 01:39)</a>:</h4>
<blockquote>
<p>C ABI problems</p>
</blockquote>
<p>Maybe with changes to fix up c abi, we could also ban returning types with unknown sizes. I'm not sure where that would get wired in, but anything with an unknown size would need to be represented by a type variable and behind a pointer. <code>Box a</code> or <code>List a</code> for example.</p>



<a name="489043968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489043968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489043968">(Dec 15 2024 at 02:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/stream/463736-bugs/topic/Fluffing.20doesn't.20naively.20work.20for.20tags/near/489041332">said</a>:</p>
<blockquote>
<p>we can call it R<del>e</del>o<del>a</del>c<del>t</del> Hooks (<span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> please laugh at my five-year-old JavaScript joke)</p>
</blockquote>
<p>Boomer joke</p>



<a name="489046349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489046349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489046349">(Dec 15 2024 at 02:44)</a>:</h4>
<p>Man, c abi is gonna be so fun: <a href="https://rust.godbolt.org/z/e9vzrWWrn">https://rust.godbolt.org/z/e9vzrWWrn</a></p>



<a name="489047065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489047065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489047065">(Dec 15 2024 at 02:58)</a>:</h4>
<p>wow, that's wild. i didn't expect xmm would go that deep i thought it stopped after like 6 genregs?</p>



<a name="489047112"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489047112" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489047112">(Dec 15 2024 at 02:59)</a>:</h4>
<p>Gen regs and float regs are tracked separately. That is why this is extra complex. Also, mixed structs are handled in 64bit chunks. So one chunk can be int while the other is float.</p>



<a name="489047305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489047305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489047305">(Dec 15 2024 at 03:01)</a>:</h4>
<p>I think when I revamp this, I'll make it so that it generates the correct c abi layout along with a getter and setter lambda. So you go from a list of internal layouts to a list of c abi layouts + the conversion functions needed to call or receive arguments. That way it is all calculated in one place.</p>



<a name="489047952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489047952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489047952">(Dec 15 2024 at 03:13)</a>:</h4>
<p>c abi varies by OS, right? Like Windows x64 is different from Linux and/or macOS x64, yeah?</p>



<a name="489048359"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489048359" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489048359">(Dec 15 2024 at 03:20)</a>:</h4>
<p>yeah, windows x64 is really simple in comparison but also slower due to pushing way more on the stack</p>



<a name="489048376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489048376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489048376">(Dec 15 2024 at 03:20)</a>:</h4>
<p>unix x64 is probably the most complex overall</p>



<a name="489048644"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489048644" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489048644">(Dec 15 2024 at 03:26)</a>:</h4>
<p>can this be offloaded to something else? can llvm figure this out</p>



<a name="489048881"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489048881" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489048881">(Dec 15 2024 at 03:30)</a>:</h4>
<p>llvm sadly does not handle it. It is all done in the frontend.</p>



<a name="489048922"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489048922" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489048922">(Dec 15 2024 at 03:31)</a>:</h4>
<p>Apparently some people embed clang in their compilers to make it generate c abi for them</p>



<a name="489049364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489049364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489049364">(Dec 15 2024 at 03:40)</a>:</h4>
<p>If we wanted, we also could probably force a simpler API. We do control both sides of the ffi. Just need to make sure we generate things in a clear way if we do so. By explicitly passing certain types as pointers, we could avoid a lot of the abi complications.</p>



<a name="489051969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489051969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489051969">(Dec 15 2024 at 04:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/channel/463736-bugs/topic/Fluffing.20doesn't.20naively.20work.20for.20tags/near/489048644">said</a>:</p>
<blockquote>
<p>can this be offloaded to something else? can llvm figure this out</p>
</blockquote>
<p>I think it was Andrew Kelley who said "discovering that LLVM does not help you out with C ABI at all is a rite of passage for compiler authors" <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="489052000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489052000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489052000">(Dec 15 2024 at 04:27)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/463736-bugs/topic/Fluffing.20doesn't.20naively.20work.20for.20tags/near/489049364">said</a>:</p>
<blockquote>
<p>If we wanted, we also could probably force a simpler API. We do control both sides of the ffi. Just need to make sure we generate things in a clear way if we do so. By explicitly passing certain types as pointers, we could avoid a lot of the abi complications.</p>
</blockquote>
<p>I think this is fine fwiw, just need to make sure that glue matches up with it</p>



<a name="489052074"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489052074" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489052074">(Dec 15 2024 at 04:28)</a>:</h4>
<p>like one idea would be to put all the arguments into a struct and then expect a pointer to that <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="489054056"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489054056" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489054056">(Dec 15 2024 at 05:02)</a>:</h4>
<p>there has to be something</p>



<a name="489054066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Fluffing%20doesn%27t%20naively%20work%20for%20tags/near/489054066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags.html#489054066">(Dec 15 2024 at 05:03)</a>:</h4>
<p>zig has solved this at the least, can we plug into that?</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
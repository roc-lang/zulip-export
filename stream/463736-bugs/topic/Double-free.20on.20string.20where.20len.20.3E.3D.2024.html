<html>
<head><meta charset="utf-8"><title>Double-free on string where len &gt;= 24 · bugs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html">Double-free on string where len &gt;= 24</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="561255715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561255715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561255715">(Dec 01 2025 at 19:20)</a>:</h4>
<p>I have ~1 hour to look into this starting now, so good chance I can't resolve it. Repro:</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>module []
# happens with strings of length 24 and above
expect("123456789012345678901234" != "")
</code></pre></div>
<p>run <code>roc test</code></p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Error message + stack trace:</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>ez@desktop-nixos ~/c/testing-roc&gt; ~/code/roc/zig-out/bin/roc test<br>
thread 35891 panic: Use-after-free: decref on already-freed memory<br>
/home/ez/code/roc/src/builtins/utils.zig:459:13: 0x4e5802c in decref (mod.zig)<br>
            @panic("Use-after-free: decref on already-freed memory");<br>
            ^<br>
/home/ez/code/roc/src/builtins/str.zig:235:40: 0x4bce7a6 in decref (mod.zig)<br>
            @import("utils.zig").decref(self.getAllocationPtr(), self.capacity_or_alloc_ptr, RocStr.alignment, false, roc_ops);<br>
                                       ^<br>
/home/ez/code/roc/src/eval/StackValue.zig:1416:31: 0x497ddf5 in decref (mod.zig)<br>
                roc_str.decref(ops);<br>
                              ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:11865:33: 0x4e2c032 in applyContinuation (mod.zig)<br>
                defer lhs.decref(&amp;self.runtime_layout_store, roc_ops);<br>
                                ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:8191:71: 0x4bcdd00 in evalWithExpectedType (mod.zig)<br>
                    const should_continue = try self.applyContinuation(&amp;work_stack, &amp;value_stack, cont, roc_ops);<br>
                                                                      ^<br>
/home/ez/code/roc/src/eval/interpreter.zig:492:45: 0x497d91d in eval (mod.zig)<br>
        return try self.evalWithExpectedType(expr_idx, roc_ops, null);<br>
                                            ^<br>
/home/ez/code/roc/src/eval/test_runner.zig:198:49: 0x49bfe29 in eval (mod.zig)<br>
        const result = try self.interpreter.eval(expr_idx, ops);<br>
                                                ^<br>
/home/ez/code/roc/src/eval/test_runner.zig:223:41: 0x4784e13 in eval_all (mod.zig)<br>
                const result = self.eval(stmt.s_expect.body) catch |err| {<br>
                                        ^<br>
/home/ez/code/roc/src/cli/main.zig:3142:41: 0x47cd63a in rocTest (main.zig)<br>
    const summary = test_runner.eval_all() catch |err| {<br>
                                        ^<br>
/home/ez/code/roc/src/cli/main.zig:576:41: 0x47eb492 in mainArgs (main.zig)<br>
        .test_cmd =&gt; |test_args| rocTest(allocs, test_args),<br>
                                        ^<br>
/home/ez/code/roc/src/cli/main.zig:508:13: 0x47ed503 in main (main.zig)<br>
    mainArgs(&amp;allocs, args) catch {<br>
            ^<br>
/home/ez/opt/zig/lib/std/start.zig:627:37: 0x47edac1 in main (std.zig)<br>
            const result = root.main() catch |err| {<br>
                                    ^<br>
/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c:95:7: 0x944204c in libc_start_main_stage2 (/home/ez/opt/zig/lib/libc/musl/src/env/__libc_start_main.c)<br>
 exit(main(argc, argv, envp));<br>
      ^<br>
???:?:?: 0x934f309 in ??? (???)<br>
Unwind error at address <code>exe:0x934f309</code> (error.MissingFDE), trace may be incomplete</p>
<p>fish: Job 1, '~/code/roc/zig-out/bin/roc test' terminated by signal SIGABRT (Abort)</p>
</div></div>



<a name="561258144"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561258144" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561258144">(Dec 01 2025 at 19:33)</a>:</h4>
<p>I can fix this, thanks for the repro!</p>



<a name="561262033"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561262033" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561262033">(Dec 01 2025 at 19:55)</a>:</h4>
<p>Np! Meanwhile expanding my mind about the interpreter so that next time I can fix it too :)</p>



<a name="561264741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561264741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561264741">(Dec 01 2025 at 20:10)</a>:</h4>
<p>I'm pretty sure this is fixed in <a href="https://github.com/roc-lang/roc/pull/8527">https://github.com/roc-lang/roc/pull/8527</a><br>
It's the same issue as <a href="https://github.com/roc-lang/roc/issues/8525">https://github.com/roc-lang/roc/issues/8525</a> I think</p>



<a name="561264826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561264826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Norbert Hajagos <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561264826">(Dec 01 2025 at 20:11)</a>:</h4>
<p>I know you're on it, but I'm just using this issue to learn. Sharing  this, since first time I used the Zed debugger:<br>
defer -ed decref on lhs and rhs: <a href="https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11865">https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11865</a></p>
<p>looping through the [lhs, rhs] array and decref-ing them.<br>
<a href="https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11962-L11969">https://github.com/roc-lang/roc/blob/968e8776e2f69438135b3155829a2d9a556dd201/src/eval/interpreter.zig#L11962-L11969</a></p>



<a name="561280458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561280458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561280458">(Dec 01 2025 at 21:38)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/8535">https://github.com/roc-lang/roc/pull/8535</a> includes a fix for this!</p>



<a name="561280501"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561280501" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561280501">(Dec 01 2025 at 21:38)</a>:</h4>
<p>it was still reproducing on there</p>



<a name="561280526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Double-free%20on%20string%20where%20len%20%3E%3D%2024/near/561280526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Double-free.20on.20string.20where.20len.20.3E.3D.2024.html#561280526">(Dec 01 2025 at 21:38)</a>:</h4>
<p>so the earlier PRs didn't fix it</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>âœ” Struct memory partially zeroed between Roc and Rust Â· bugs Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html">âœ” Struct memory partially zeroed between Roc and Rust</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="488911577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488911577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488911577">(Dec 13 2024 at 20:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/488774885">said</a>:</p>
<blockquote>
<p>... Tomorrow I'll revisit the memory zeroing bug...</p>
</blockquote>
<p>I've created <a href="https://github.com/roc-lang/basic-cli/compare/main...JanCVanB:basic-cli:bug_repro___zeroed_struct">a minimal bug reproduction (using just a few additions to basic-cli@main)</a> of this confusing obstacle I've been hitting in my roc-on project (before and after switching to purity inference). I get this output, which demonstrates the zeroing I'm also seeing with all tag union discriminants (seemingly because <code>discriminant</code> is the second field in the union).</p>
<div class="codehilite"><pre><span></span><code>jan@framey:~/_code/JanCVanB/basic-cli$ roc version
roc nightly pre-release, built from commit 7495495 on Do 12 Dez 2024 09:43:52 UTC
jan@framey:~/_code/JanCVanB/basic-cli$ ./bug_repro___run.sh
+ &#39;[&#39; -z &#39;&#39; &#39;]&#39;
+ echo &#39;Warning: ROC environment variable is not set... I&#39;\&#39;&#39;ll try with just &#39;\&#39;&#39;roc&#39;\&#39;&#39;.&#39;
Warning: ROC environment variable is not set... I&#39;ll try with just &#39;roc&#39;.
+ ROC=roc
+ roc build --lib ./platform/libapp.roc
0 errors and 0 warnings found in 143 ms while successfully building:

    ./platform/libapp
+ cargo build --release
    Finished `release` profile [optimized] target(s) in 0.05s
+ &#39;[&#39; -n &#39;&#39; &#39;]&#39;
+ cp target/release/libhost.a ./platform/libhost.a
+ roc build --linker=legacy build.roc
0 errors and 0 warnings found in 287 ms while successfully building:

    build
ðŸ¦… happy: {bar: 22, baz: 33, foo: 11}
ðŸ¦€ sad: ZeroedStruct { bar: 22, baz: 0, foo: 0 }
jan@framey:~/_code/JanCVanB/basic-cli$
</code></pre></div>
<p>I'm happy to create a github issue for this, but I'm unclear which repo is responsible - maybe a <code>roc-lang/roc/crates/glue/src/RustGlue.roc</code> bug?</p>



<a name="488915848"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488915848" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488915848">(Dec 13 2024 at 20:32)</a>:</h4>
<p>Yeah, known c abi bugs</p>



<a name="488915949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488915949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488915949">(Dec 13 2024 at 20:33)</a>:</h4>
<p>Rust is expecting <code>{bar: 22, baz: 33, foo: 11}</code> to be passed in a single register.</p>



<a name="488915958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488915958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488915958">(Dec 13 2024 at 20:33)</a>:</h4>
<p>Cause it is 3 U8s</p>



<a name="488915999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488915999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488915999">(Dec 13 2024 at 20:33)</a>:</h4>
<p>We are probably passing it in 3 different registers</p>



<a name="488916072"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488916072" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488916072">(Dec 13 2024 at 20:34)</a>:</h4>
<p>Thus only the first value is correct (cause it is in the first register)</p>



<a name="488919801"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488919801" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488919801">(Dec 13 2024 at 20:59)</a>:</h4>
<p>Oh, okay! I'm so glad this is known and clear to you.</p>



<a name="488919985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488919985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488919985">(Dec 13 2024 at 21:00)</a>:</h4>
<p>Can I debug it by telling Rust to expect multiple registers? (no idea where to start, but happy to look up things)</p>



<a name="488920120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488920120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488920120">(Dec 13 2024 at 21:01)</a>:</h4>
<p>If you make rust recieve 3 u8s instead of a struct, I think that should work</p>



<a name="488920257"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488920257" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488920257">(Dec 13 2024 at 21:02)</a>:</h4>
<p>This is a major issue we have with small types. We really need to revamp how we generate c-abi and deal with all the various cases.</p>



<a name="488920400"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488920400" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488920400">(Dec 13 2024 at 21:03)</a>:</h4>
<p>Do you mean [u8]? Is there a better one-to-one container? Since I have dozens of nested struct types with lots of U8s, I'm looking for structure.</p>



<a name="488920696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488920696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488920696">(Dec 13 2024 at 21:05)</a>:</h4>
<p>Or would ballooning to U32/64 minimum sizes and then tossing head bits magically fix it?</p>



<a name="488921026"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488921026" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488921026">(Dec 13 2024 at 21:07)</a>:</h4>
<p>I infer that this approach would be a PR to RustGlue.roc to fix the representations it chooses.</p>



<a name="488921555"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488921555" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488921555">(Dec 13 2024 at 21:10)</a>:</h4>
<p>For this specific case: <a href="https://godbolt.org/z/xj87ajszh">https://godbolt.org/z/xj87ajszh</a></p>



<a name="488921657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488921657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488921657">(Dec 13 2024 at 21:11)</a>:</h4>
<p>If all of your structs/tags were big enough to avoid fitting in two register, it would probably generate correct calls that match what rust expects.</p>



<a name="488921796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488921796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488921796">(Dec 13 2024 at 21:12)</a>:</h4>
<blockquote>
<p>Or would ballooning to U32/64 minimum sizes and then tossing head bits magically fix it?</p>
</blockquote>
<p>So yeah, this would probably would in most cases.</p>



<a name="488922328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488922328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488922328">(Dec 13 2024 at 21:16)</a>:</h4>
<p>Ballooning results:</p>
<p>U8s</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66}
ðŸ¦€ sad: ZeroedStruct { bar: 22, baz: 0, foo: 0, qux1: 0, qux2: 0, qux3: 0 }
</code></pre></div>
<p>U16s</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66}
ðŸ¦€ sad: ZeroedStruct { bar: 22, baz: 1951, foo: 32766, qux1: 0, qux2: 33, qux3: 0 }
</code></pre></div>
<p>U32s</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66}
ðŸ¦€ sad: ZeroedStruct { bar: 66, baz: 32766, foo: 3966136302, qux1: 22066, qux2: 1945484424, qux3: 32766 }
</code></pre></div>
<p>U64s</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66}
ðŸ¦€ sad: ZeroedStruct { bar: 140724510355272, baz: 94609053062050, foo: 140724510355320, qux1: 8, qux2: 139842509156127, qux3: 94609075901416 }
</code></pre></div>
<p><span aria-label="blushing" class="emoji emoji-1f633" role="img" title="blushing">:blushing:</span></p>



<a name="488922666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488922666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488922666">(Dec 13 2024 at 21:19)</a>:</h4>
<p>ballooned on both the roc and rust side?</p>



<a name="488922955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488922955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488922955">(Dec 13 2024 at 21:21)</a>:</h4>
<p>yeah both, via naive regenerated glue<br>
<a href="/user_uploads/22008/pncittAo44VJwgYZ1ZLXUb0J/Screenshot_20241213_141958.png">Screenshot_20241213_141958.png</a><br>
<a href="/user_uploads/22008/4K1LUNjHj9QMjDVSxxeEumTc/Screenshot_20241213_142026.png">Screenshot_20241213_142026.png</a><br>
<a href="/user_uploads/22008/Yz-pI2c27_apW1jJTbo7UdY6/Screenshot_20241213_142045.png">Screenshot_20241213_142045.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/pncittAo44VJwgYZ1ZLXUb0J/Screenshot_20241213_141958.png" title="Screenshot_20241213_141958.png"><img data-original-dimensions="218x186" src="/user_uploads/thumbnail/22008/pncittAo44VJwgYZ1ZLXUb0J/Screenshot_20241213_141958.png/840x560.webp"></a></div><div class="message_inline_image"><a href="/user_uploads/22008/4K1LUNjHj9QMjDVSxxeEumTc/Screenshot_20241213_142026.png" title="Screenshot_20241213_142026.png"><img data-original-dimensions="722x245" src="/user_uploads/thumbnail/22008/4K1LUNjHj9QMjDVSxxeEumTc/Screenshot_20241213_142026.png/840x560.webp"></a></div><div class="message_inline_image"><a href="/user_uploads/22008/Yz-pI2c27_apW1jJTbo7UdY6/Screenshot_20241213_142045.png" title="Screenshot_20241213_142045.png"><img data-original-dimensions="900x127" src="/user_uploads/thumbnail/22008/Yz-pI2c27_apW1jJTbo7UdY6/Screenshot_20241213_142045.png/840x560.webp"></a></div>



<a name="488923457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488923457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488923457">(Dec 13 2024 at 21:25)</a>:</h4>
<p>My "workaround" is to make the type larger by adding in U64's or something until it gets passed by pointer, and then just ignore the unused parts.</p>



<a name="488923541"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488923541" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488923541">(Dec 13 2024 at 21:25)</a>:</h4>
<p>Should I add a pointer dereference to this sextet of U64s? (And is 6 "enough" to trigger that passing by pointer?)</p>



<a name="488923700"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488923700" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488923700">(Dec 13 2024 at 21:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/463736-bugs/topic/Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust/near/488923457">said</a>:</p>
<blockquote>
<p>My "workaround" is to make the type larger by adding in U64's or something until it gets passed by pointer, and then just ignore the unused parts.</p>
</blockquote>
<p>That's probably an easier general workaround</p>



<a name="488923774"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488923774" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488923774">(Dec 13 2024 at 21:27)</a>:</h4>
<p><del>Sneaky pointer confirmed:</del> I wonder if it's already passing by pointer:</p>
<p>Re-running U64s</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66}
ðŸ¦€ sad: ZeroedStruct { bar: 140732166601912, baz: 93831138048418, foo: 140732166601960, qux1: 8, qux2: 140691827044127, qux3: 93831156052968 }
</code></pre></div>
<p>and again</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66}
ðŸ¦€ sad: ZeroedStruct { bar: 140721497110504, baz: 94174084974690, foo: 140721497110552, qux1: 8, qux2: 139823797833503, qux3: 94174114378728 }
</code></pre></div>



<a name="488923859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488923859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488923859">(Dec 13 2024 at 21:27)</a>:</h4>
<p>or just unwiped ram noise, I suppose</p>



<a name="488924117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488924117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488924117">(Dec 13 2024 at 21:30)</a>:</h4>
<p>Does this mean that glue code always requires nontrivial handwriting after generation? (when numbers are involved)</p>



<a name="488924429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488924429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488924429">(Dec 13 2024 at 21:32)</a>:</h4>
<p>Luke, do you have an existing example of that pointer+ignore workaround that I can adapt? Like from roc-ray?</p>



<a name="488924886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488924886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488924886">(Dec 13 2024 at 21:35)</a>:</h4>
<p>Sure, here's how I get UUID's across to the host in roc-ray</p>
<div class="codehilite"><pre><span></span><code>RawUUID : {
    upper : U64,
    lower : U64,
    zzz1 : U64,
    zzz2 : U64,
    zzz3 : U64,
}
</code></pre></div>



<a name="488924989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488924989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488924989">(Dec 13 2024 at 21:36)</a>:</h4>
<p>And the glue for that </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[derive(Clone, Copy, Default, Debug, PartialEq, PartialOrd, Eq, Ord, Hash)]</span>
<span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PeerUUID</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lower</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">upper</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">zzz1</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">zzz2</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">zzz3</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">roc_refcounted_noop_impl</span><span class="o">!</span><span class="p">(</span><span class="n">PeerUUID</span><span class="p">);</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;</span><span class="n">matchbox_socket</span><span class="p">::</span><span class="n">PeerId</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PeerUUID</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">peer_id</span><span class="p">:</span><span class="w"> </span><span class="nc">matchbox_socket</span><span class="p">::</span><span class="n">PeerId</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">PeerUUID</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">upper</span><span class="p">,</span><span class="w"> </span><span class="n">lower</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">peer_id</span><span class="p">.</span><span class="mf">0.</span><span class="n">as_u64_pair</span><span class="p">();</span>
<span class="w">        </span><span class="n">PeerUUID</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">lower</span><span class="p">,</span>
<span class="w">            </span><span class="n">upper</span><span class="p">,</span>
<span class="w">            </span><span class="n">zzz1</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">zzz2</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">zzz3</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;&amp;</span><span class="n">PeerUUID</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">uuid</span><span class="p">::</span><span class="n">Uuid</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">roc_uuid</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">PeerUUID</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">uuid</span><span class="p">::</span><span class="n">Uuid</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">uuid</span><span class="p">::</span><span class="n">Uuid</span><span class="p">::</span><span class="n">from_u64_pair</span><span class="p">(</span><span class="n">roc_uuid</span><span class="p">.</span><span class="n">upper</span><span class="p">,</span><span class="w"> </span><span class="n">roc_uuid</span><span class="p">.</span><span class="n">lower</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">From</span><span class="o">&lt;&amp;</span><span class="n">PeerUUID</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">PeerId</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">roc_uuid</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">PeerUUID</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">matchbox_socket</span><span class="p">::</span><span class="n">PeerId</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uuid</span><span class="p">::</span><span class="n">Uuid</span><span class="p">::</span><span class="n">from_u64_pair</span><span class="p">(</span><span class="n">roc_uuid</span><span class="p">.</span><span class="n">upper</span><span class="p">,</span><span class="w"> </span><span class="n">roc_uuid</span><span class="p">.</span><span class="n">lower</span><span class="p">);</span>
<span class="w">        </span><span class="n">matchbox_socket</span><span class="p">::</span><span class="n">PeerId</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="n">uuid</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="488925209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925209">(Dec 13 2024 at 21:38)</a>:</h4>
<p>Gotcha, so stuff in fluff then ignore it as much as possible!</p>



<a name="488925444"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925444" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925444">(Dec 13 2024 at 21:40)</a>:</h4>
<p>What are the implications/ripples of passing by pointer? Would my</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_sendZeroedStruct</span><span class="p">(</span><span class="n">sad</span><span class="p">:</span><span class="w"> </span><span class="nc">glue2</span><span class="p">::</span><span class="n">ZeroedStruct</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>change to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_sendZeroedStruct</span><span class="p">(</span><span class="n">sad</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">glue2</span><span class="p">::</span><span class="n">ZeroedStruct</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>?</p>



<a name="488925470"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925470" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925470">(Dec 13 2024 at 21:40)</a>:</h4>
<p>Yeah, I'm hoping with the ROAR stuff we've been discussing, that would clean all the C ABI issues up.</p>



<a name="488925518"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925518" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925518">(Dec 13 2024 at 21:40)</a>:</h4>
<p>...otherwise I don't see why the ballooning above wouldn't be working already.</p>



<a name="488925572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925572">(Dec 13 2024 at 21:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/463736-bugs/topic/Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust/near/488925444">said</a>:</p>
<blockquote>
<p>What are the implications/ripples of passing by pointer? Would my</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_sendZeroedStruct</span><span class="p">(</span><span class="n">sad</span><span class="p">:</span><span class="w"> </span><span class="nc">glue2</span><span class="p">::</span><span class="n">ZeroedStruct</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>change to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_sendZeroedStruct</span><span class="p">(</span><span class="n">sad</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">glue2</span><span class="p">::</span><span class="n">ZeroedStruct</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</code></pre></div>
<p>?</p>
</blockquote>
<p>Yeah I think so.. here's an example getting PeerUUID from roc</p>
<div class="codehilite"><pre><span></span><code>extern &quot;C&quot; fn roc_fx_sendToPeer(bytes: &amp;RocList&lt;u8&gt;, peer: &amp;glue::PeerUUID) {
</code></pre></div>



<a name="488925684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925684">(Dec 13 2024 at 21:42)</a>:</h4>
<p>Just adding the <code>&amp;</code>:</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66}
ðŸ¦€ sad: ZeroedStruct { bar: 22, baz: 33, foo: 11, qux1: 44, qux2: 55, qux3: 66 }
</code></pre></div>
<p><span aria-label="woman facepalming" class="emoji emoji-1f926-200d-2640" role="img" title="woman facepalming">:woman_facepalming:</span> I should be dancing right now but I'm not.</p>



<a name="488925794"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925794" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925794">(Dec 13 2024 at 21:43)</a>:</h4>
<p>Congratulations, you've basically found all the known issues with platform development <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="488925802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925802">(Dec 13 2024 at 21:43)</a>:</h4>
<p>This is fantastic news. For now I don't care that my programs will consume 100x memory.</p>



<a name="488925897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488925897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488925897">(Dec 13 2024 at 21:44)</a>:</h4>
<p><span aria-label="point up" class="emoji emoji-1f446" role="img" title="point up">:point_up:</span> Best case scenario is that I'm quoting this comment in a month.</p>



<a name="488926376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488926376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488926376">(Dec 13 2024 at 21:48)</a>:</h4>
<p>Okay, now I'm dancing: 3 U8s + 4 U64s triggers passing by pointer!</p>
<div class="codehilite"><pre><span></span><code>ðŸ¦… happy: {bar: 22, baz: 33, fluff1: 0, fluff2: 0, fluff3: 0, fluff4: 0, foo: 11}
ðŸ¦€ sad: ZeroedStruct { fluff1: 0, fluff2: 0, fluff3: 0, fluff4: 0, bar: 22, baz: 33, foo: 11 }
</code></pre></div>



<a name="488926475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488926475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488926475">(Dec 13 2024 at 21:49)</a>:</h4>
<p>THANK YOU ALL</p>



<a name="488926781"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488926781" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488926781">(Dec 13 2024 at 21:51)</a>:</h4>
<p>Hmm, now how to apply this logic to tag unions, which currently generate two-field structs (payload+discriminant)...</p>



<a name="488926901"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488926901" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488926901">(Dec 13 2024 at 21:52)</a>:</h4>
<p>I'll try fluffing every tag payload</p>



<a name="488926967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488926967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488926967">(Dec 13 2024 at 21:53)</a>:</h4>
<blockquote>
<p>Yeah, I'm hoping with the ROAR stuff we've been discussing, that would clean all the C ABI issues up.</p>
</blockquote>
<p>they are kinda unrelated</p>



<a name="488926977"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488926977" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488926977">(Dec 13 2024 at 21:53)</a>:</h4>
<p>ROAR is for the dev backend</p>



<a name="488926991"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488926991" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488926991">(Dec 13 2024 at 21:53)</a>:</h4>
<p>llvm backend is failing to follow c abi in these cases</p>



<a name="488927912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488927912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488927912">(Dec 13 2024 at 22:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/488927886">said</a>:</p>
<blockquote>
<p>LET'S</p>
<p>GOOOOOOOOOOOOOOOOOO</p>
<p><div class="codehilite"><pre><span></span><code>ðŸ¦…ðŸ˜¶ main is sending custom MIDI: {format: SingleTrack, timing: (Metrical 100 0 0 0 0)}
ðŸ¦€ðŸ˜¶ roc_fx_echoMidiSmallish received custom MIDI: Header { timing: Timing::Metrical(Timing_Metrical { f1: 0, f2: 0, f3: 0, f4: 0, f0: 100 }), format: Format::SingleTrack }
ðŸ¦€ðŸ˜Š roc_fx_echoMidiSmallish casted that to Midly: Header { format: SingleTrack, timing: Metrical(u15(100)) }
ðŸ¦€ðŸ˜Š roc_fx_echoMidiSmallish casted that back too: Header { timing: Timing::Metrical(Timing_Metrical { f1: 0, f2: 0, f3: 0, f4: 0, f0: 100 }), format: Format::SingleTrack }
ðŸ¦…ðŸ˜¶ main received an echo back: {format: SingleTrack, timing: (Metrical 100 0 0 0 0)}
ðŸ¦…ðŸ˜Š main sees no difference!
</code></pre></div><br>
</p>
</blockquote>



<a name="488928494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488928494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488928494">(Dec 13 2024 at 22:05)</a>:</h4>
<p><a href="/user_uploads/22008/JweP26OHoMVLwmhn9P82doVU/stuff_that_fluff.gif">stuff_that_fluff.gif</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/JweP26OHoMVLwmhn9P82doVU/stuff_that_fluff.gif" title="stuff_that_fluff.gif"><img data-animated="true" data-original-dimensions="220x164" src="/user_uploads/thumbnail/22008/JweP26OHoMVLwmhn9P82doVU/stuff_that_fluff.gif/840x560-anim.webp"></a></div>



<a name="488929208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488929208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488929208">(Dec 13 2024 at 22:11)</a>:</h4>
<p>You've heard of whitespace - now introducing whxtxspxcx:</p>
<div class="codehilite" data-code-language="Perl"><pre><span></span><code><span class="c1"># This is to help avoid hitting a known C ABI bug</span>
<span class="c1"># by ensuring small values are passed by pointer.</span>
<span class="c1"># See https://roc.zulipchat.com/#narrow/channel/463736-bugs/topic/Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust/near/488928494</span>
<span class="n">Fluff</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">U64</span>
<span class="n">X</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Fluff</span>

<span class="n">FpsTiming</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">Fps24</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Fps25</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Fps29</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Fps30</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">]</span>
<span class="n">Format</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">SingleTrack</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Parallel</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Sequential</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">]</span>
<span class="n">Timing</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">Metrical</span><span class="w"> </span><span class="n">U16</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">,</span><span class="w"> </span><span class="n">Timecode</span><span class="w"> </span><span class="n">FpsTiming</span><span class="w"> </span><span class="n">U8</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="n">X</span><span class="p">]</span>

<span class="n">Header</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">format</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Format</span><span class="p">,</span>
<span class="w">    </span><span class="n">timing</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Timing</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>



<a name="488929333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20Struct%20memory%20partially%20zeroed%20between%20Roc%20and%20Rust/near/488929333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust.html#488929333">(Dec 13 2024 at 22:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>✔ platform std.Thread.spawn -&gt; unreachable -&gt; segfault · bugs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20platform.20std.2EThread.2Espawn.20-.3E.20unreachable.20-.3E.20segfault.html">✔ platform std.Thread.spawn -&gt; unreachable -&gt; segfault</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="561713970"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20platform%20std.Thread.spawn%20-%3E%20unreachable%20-%3E%20segfault/near/561713970" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Campbell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20platform.20std.2EThread.2Espawn.20-.3E.20unreachable.20-.3E.20segfault.html#561713970">(Dec 03 2025 at 17:27)</a>:</h4>
<p>x86_64 linux</p>
<p>Commit: <code>719fcae1151c0f1ecd30894366cbe4c9e2f99397</code></p>
<p>Adding a <code>std.Thread.spawn</code> call...</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="n">hostedStdoutLine</span><span class="p">(</span><span class="n">ops</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">builtins</span><span class="p">.</span><span class="n">host_abi</span><span class="p">.</span><span class="n">RocOps</span><span class="p">,</span><span class="w"> </span><span class="n">ret_ptr</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span><span class="w"> </span><span class="n">args_ptr</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ops</span><span class="p">;</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret_ptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args_ptr</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">thread_test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="n">worker</span><span class="p">()</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">.</span><span class="n">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">ns_per_s</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">Thread</span><span class="p">.</span><span class="n">spawn</span><span class="p">(.{},</span><span class="w"> </span><span class="n">thread_test</span><span class="p">.</span><span class="n">worker</span><span class="p">,</span><span class="w"> </span><span class="p">.{})</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">{};</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<p>Result: <code>thread 54669 panic: reached unreachable code</code></p>
<div class="codehilite"><pre><span></span><code>[anon@nixos:~/Projects/roc]$ zig build test
[...tests fail...]

[anon@nixos:~/Projects/roc]$ ./zig-out/bin/roc ./test/fx/app.roc
thread 54669 panic: reached unreachable code
error: Child process /home/anon/.cache/roc/75fed07d9047282a9e6197f23853ba39/temp/roc-tmp-RmsPvqoZLOh3Y7e4JvbGzW1HSRiQC1uu/roc_run_3344319531 killed by signal: 11
error: Child process crashed with segmentation fault (SIGSEGV)
</code></pre></div>
<p>Then program exits, without continuing.</p>



<a name="561717303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20platform%20std.Thread.spawn%20-%3E%20unreachable%20-%3E%20segfault/near/561717303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20platform.20std.2EThread.2Espawn.20-.3E.20unreachable.20-.3E.20segfault.html#561717303">(Dec 03 2025 at 17:42)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="683808">@Scott Campbell</span>,<br>
Can you make a github issue for this? It may be some time before we get to it, we're currently focused on advent of code related fixes and improvements.</p>



<a name="561791518"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20platform%20std.Thread.spawn%20-%3E%20unreachable%20-%3E%20segfault/near/561791518" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Campbell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20platform.20std.2EThread.2Espawn.20-.3E.20unreachable.20-.3E.20segfault.html#561791518">(Dec 04 2025 at 04:11)</a>:</h4>
<p>Done!</p>
<p><a href="https://github.com/roc-lang/roc/issues/8566">#8566</a></p>
<p>It's not urgent, I don't actually need threads yet.</p>
<p>I can probably try to make do with some kind of single threaded event loop if needed, and zig's newish IO interface, for async style concurrent code. Then it'll be easy to swap out the implementation later.</p>
<p>If it bothers me too much, I'll try grab a debugger and learn how to find zig segfaults...</p>



<a name="561792036"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/%E2%9C%94%20platform%20std.Thread.spawn%20-%3E%20unreachable%20-%3E%20segfault/near/561792036" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/.E2.9C.94.20platform.20std.2EThread.2Espawn.20-.3E.20unreachable.20-.3E.20segfault.html#561792036">(Dec 04 2025 at 04:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="683808">Scott Campbell</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
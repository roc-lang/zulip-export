<html>
<head><meta charset="utf-8"><title>Program has different behavior depending on `dbg` place... · bugs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html">Program has different behavior depending on `dbg` place...</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="565388815"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565388815" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565388815">(Dec 25 2025 at 20:09)</a>:</h4>
<p>Hey all - I've got a real puzzler on my hands. I have been trying to port some old AoC code to the new compiler. However, while the program passes <code>roc build</code>, it crashes before reaching the end of main. However, depending where, and how many <code>dbg</code> statements I place, the crash will occur at different places.</p>
<p>Also, I get some strange behavior where placing two <code>dbg</code> statements for the same <code>Try</code> value will show as the wrapped value once, and an <code>Ok(...)</code> the next time.</p>
<p>There is a third issue, which seems unrelated to the <code>dbg</code> issue, in which I can pipe the results of the <code>part1()</code> calculation to <code>Stdout.line!()</code>, but if I save the result of <code>part1()</code> as a value and then call <code>Stdout.line!()</code> on the value in the next line, the program crashes before reaching the <code>Stdout.line!()</code>. </p>
<p>Finally, the program never finishes executing completely. It will always crash before completing, but depending on how I structure the rest of the code, I may be able to get it to print the result of <code>part1()</code>.</p>



<a name="565388866"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565388866" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565388866">(Dec 25 2025 at 20:10)</a>:</h4>
<p>I have been trying to minimize this issue, but haven't been able to due so yet.</p>
<p>(current code coming below)</p>



<a name="565388998"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565388998" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565388998">(Dec 25 2025 at 20:14)</a>:</h4>
<p>I will give the full code below, but let me start by giving this snippet. Depending on which of these debug statements are uncommented, the program will crash in different modes, and may or may not make it back to main to execute the <code>Stdout.line!()</code> statement in main.</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="c1">## Solve part 1</span>
<span class="n">part1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">Str</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">Try</span><span class="p">(</span><span class="no">Str</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span>
<span class="n">part1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">s</span><span class="o">.</span><span class="n">split_on</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="w">    </span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">extract_digits</span><span class="p">)</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">keep_oks</span><span class="p">(</span><span class="n">compute_calibration</span><span class="p">)</span>
<span class="w">    </span><span class="c1"># -&gt;debug() # (1)</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="n">sum</span><span class="p">()</span>
<span class="w">    </span><span class="c1"># -&gt;debug() # (2)</span>
<span class="w">    </span><span class="o">.</span><span class="n">to_str</span><span class="p">()</span>
<span class="w">    </span><span class="c1"># -&gt;debug() # (3)</span>
<span class="w">    </span><span class="o">-&gt;</span><span class="no">Ok</span>
<span class="w">    </span><span class="c1"># -&gt;debug() # (4)</span>
<span class="p">}</span>
</code></pre></div>



<a name="565390228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565390228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565390228">(Dec 25 2025 at 20:53)</a>:</h4>
<p><strong>Failure Modes</strong></p>
<ul>
<li>All <code>debug</code> statements commented out:<ul>
<li>The program crashes with the following:</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>Roc crashed: Internal error: TypeMismatch in call_invoke_closure continuation
</code></pre></div>
<ul>
<li>Only <code>(1)</code> uncommented, or <code>(1)</code> and <code>(2)</code> uncommnted:<ul>
<li>crashes with the following:</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>thread 43720 panic: reached unreachable code
Unable to dump stack trace: debug info stripped
Aborted (core dumped)
</code></pre></div>
<ul>
<li>Only <code>(2)</code>, <code>(3)</code>, or <code>(4)</code> uncommented:<ul>
<li>Same as <em>all</em> commented out</li>
</ul>
</li>
<li>Both <code>(1)</code> and <code>(3)</code> uncommented:<ul>
<li>Debug <code>(1)</code> prints, but prints an empty list, even though not empty.  Dbg <code>(3)</code> does not print. The function completes successfully, and returns to main, where depending on main, the result may print via <code>Stdout.line!()</code>. Finally, the program crashes with a different error message:</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>dbg: []
209.0

Roc crashed: call_invoke_closure: value_stack empty when popping function
</code></pre></div>
<ul>
<li>Both <code>(1)</code> and <code>(4)</code> uncommented:<ul>
<li>Debug <code>(1)</code> prints, but prints an empty list, even though not empty. Dbg <code>(4)</code> does not print. The function completes successfully, and returns to main, where depending on main, the result may print via <code>Stdout.line!()</code>. Finally, the program crashes with a different error message:</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>dbg: []
209.0

Roc crashed: non-exhaustive match
</code></pre></div>
<ul>
<li>Dbg <code>(1)</code> uncommented, and both <code>(3)</code> and <code>(4)</code> uncommented:<ul>
<li>Debug <code>(1)</code> and <code>(3)</code> print, but <code>(1)</code> prints an empty list, even though not empty. Dbg <code>(4)</code> does not print. The function completes successfully, and returns to main, where depending on main, the result may print via <code>Stdout.line!()</code>. Finally, the program crashes with a different error message:</li>
</ul>
</li>
</ul>
<div class="codehilite"><pre><span></span><code>dbg: []
dbg: &quot;209.0&quot;
209.0

Roc crashed: non-exhaustive match
</code></pre></div>
<ul>
<li>In any of the permutations that result in a return to main, IE: <code>(1)</code> and at least one of <code>(3)</code> or <code>(4)</code> uncommented, uncommenting <code>(2)</code> does not change the failure mode. However, instead of <code>dbg</code> <code>(2)</code> printing an integer value, it also prints an empty list as well. So uncommenting all results in the following:</li>
</ul>
<div class="codehilite"><pre><span></span><code>dbg: []
dbg: []
dbg: &quot;209.0&quot;
209.0

Roc crashed: non-exhaustive match
</code></pre></div>



<a name="565390256"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565390256" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565390256">(Dec 25 2025 at 20:54)</a>:</h4>
<p>Note that <code>debug</code> is defined as:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">debug</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">a</span>
<span class="nv">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">dbg</span><span class="w"> </span><span class="nx">v</span>
<span class="w">    </span><span class="nx">v</span>
<span class="p">}</span>
</code></pre></div>



<a name="565390391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565390391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565390391">(Dec 25 2025 at 20:58)</a>:</h4>
<p>I'll come back and document some of the other issues later, but for now, here is the full code file:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nx">app</span><span class="w"> </span><span class="p">[</span><span class="nx">main</span><span class="o">!</span><span class="p">]</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">pf</span><span class="o">:</span><span class="w"> </span><span class="nx">platform</span><span class="w"> </span><span class="s">"https://github.com/lukewilliamboswell/roc-platform-template-zig/releases/download/0.6/2BfGn4M9uWJNhDVeMghGeXNVDFijMfPsmmVeo6M4QjKX.tar.zst"</span><span class="w"> </span><span class="p">}</span>

<span class="nx">import</span><span class="w"> </span><span class="nx">pf</span><span class="p">.</span><span class="nx">Stdout</span>

<span class="nx">main</span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">_args</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">input</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="err">\\</span><span class="nx">two1nine</span>
<span class="w">        </span><span class="err">\\</span><span class="nx">eightwothree</span>
<span class="w">        </span><span class="err">\\</span><span class="nx">abcone2threexyz</span>
<span class="w">        </span><span class="err">\\</span><span class="nx">xtwone3four</span>
<span class="w">        </span><span class="err">\\</span><span class="mi">4</span><span class="nx">nineeightseven2</span>
<span class="w">        </span><span class="err">\\</span><span class="nx">zoneight234</span>
<span class="w">        </span><span class="err">\\</span><span class="mi">7</span><span class="nx">pqrstsixteen</span>

<span class="w">    </span><span class="nx">part1</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span><span class="o">?</span><span class="nf">-&gt;</span><span class="nx">Stdout</span><span class="p">.</span><span class="nx">line</span><span class="o">!</span><span class="p">()</span>

<span class="w">    </span><span class="c1"># answer1 = part1(input)?-&gt;debug()-&gt;debug()-&gt;debug()</span>
<span class="w">    </span><span class="c1"># dbg "answer"</span>
<span class="w">    </span><span class="c1"># Stdout.line!(answer1)</span>

<span class="w">    </span><span class="nx">Ok</span><span class="p">({})</span>
<span class="p">}</span>

<span class="c1">## Solve part 1</span>
<span class="nv">part1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Try</span><span class="p">(</span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">)</span>
<span class="nv">part1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">s</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">split_on</span><span class="p">(</span><span class="s">"\n"</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">map</span><span class="nf">(extract_digits)</span>
<span class="nf">    -&gt;</span><span class="nx">keep_oks</span><span class="nf">(compute_calibration)</span>
<span class="nf">    -&gt;</span><span class="nx">debug</span><span class="p">()</span><span class="w"> </span><span class="c1"># (1)</span>
<span class="w">    </span><span class="nf">-&gt;</span><span class="nx">sum</span><span class="p">()</span>
<span class="w">    </span><span class="c1"># -&gt;debug() # (2)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">to_str</span><span class="p">()</span>
<span class="w">    </span><span class="c1"># -&gt;debug() # (3)</span>
<span class="w">    </span><span class="nf">-&gt;</span><span class="nx">Ok</span>
<span class="w">    </span><span class="nf">-&gt;</span><span class="nx">debug</span><span class="p">()</span><span class="w"> </span><span class="c1"># (4)</span>
<span class="p">}</span>

<span class="nv">extract_digits</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="p">(</span><span class="nx">U64</span><span class="p">)</span>
<span class="nv">extract_digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">s</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">to_utf8</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="nx">keep_if</span><span class="p">(</span><span class="o">|</span><span class="nx">c</span><span class="o">|</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s">'0'</span><span class="w"> </span><span class="o">and</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="s">'9'</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="o">|</span><span class="nx">c</span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="s">'0'</span><span class="p">).</span><span class="nx">to_u64</span><span class="p">())</span>
<span class="p">}</span>

<span class="nv">compute_calibration</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="nf">(U64) -&gt;</span><span class="w"> </span><span class="nx">Try</span><span class="p">(</span><span class="nx">U64</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">)</span>
<span class="nv">compute_calibration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">digits</span><span class="o">|</span><span class="w"> </span><span class="nx">Ok</span><span class="p">(</span><span class="nx">List</span><span class="p">.</span><span class="nx">first</span><span class="p">(</span><span class="nx">digits</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">List</span><span class="p">.</span><span class="nx">last</span><span class="p">(</span><span class="nx">digits</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>

<span class="c1">## Solve part 2</span>
<span class="nv">part2</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Try</span><span class="p">(</span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">)</span>
<span class="nv">part2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">s</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">split_on</span><span class="p">(</span><span class="s">"\n"</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">map</span><span class="nf">(extract_text_digits)</span>
<span class="nf">        -&gt;</span><span class="nx">keep_oks</span><span class="nf">(compute_calibration)</span>
<span class="nf">        -&gt;</span><span class="nx">debug</span><span class="nf">()</span>
<span class="nf">        -&gt;</span><span class="nx">sum</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="nx">to_str</span><span class="nf">()</span>
<span class="nf">        -&gt;</span><span class="nx">Ok</span>
<span class="p">}</span>

<span class="nv">extract_text_digits</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="p">(</span><span class="nx">U64</span><span class="p">)</span>
<span class="nv">extract_text_digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">s</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">to_utf8</span><span class="p">()</span>
<span class="w">    </span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">to</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">len</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="nx">fold</span><span class="p">(</span>
<span class="w">            </span><span class="p">[],</span>
<span class="w">            </span><span class="o">|</span><span class="nx">ds</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">match</span><span class="w"> </span><span class="nx">bytes</span><span class="p">.</span><span class="nx">drop_first</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'o'</span><span class="p">,</span><span class="w"> </span><span class="s">'n'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'t'</span><span class="p">,</span><span class="w"> </span><span class="s">'w'</span><span class="p">,</span><span class="w"> </span><span class="s">'o'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'t'</span><span class="p">,</span><span class="w"> </span><span class="s">'h'</span><span class="p">,</span><span class="w"> </span><span class="s">'r'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'f'</span><span class="p">,</span><span class="w"> </span><span class="s">'o'</span><span class="p">,</span><span class="w"> </span><span class="s">'u'</span><span class="p">,</span><span class="w"> </span><span class="s">'r'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'f'</span><span class="p">,</span><span class="w"> </span><span class="s">'i'</span><span class="p">,</span><span class="w"> </span><span class="s">'v'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'s'</span><span class="p">,</span><span class="w"> </span><span class="s">'i'</span><span class="p">,</span><span class="w"> </span><span class="s">'x'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'s'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="s">'v'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="s">'n'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="s">'i'</span><span class="p">,</span><span class="w"> </span><span class="s">'g'</span><span class="p">,</span><span class="w"> </span><span class="s">'h'</span><span class="p">,</span><span class="w"> </span><span class="s">'t'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'n'</span><span class="p">,</span><span class="w"> </span><span class="s">'i'</span><span class="p">,</span><span class="w"> </span><span class="s">'n'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="s">'z'</span><span class="p">,</span><span class="w"> </span><span class="s">'e'</span><span class="p">,</span><span class="w"> </span><span class="s">'r'</span><span class="p">,</span><span class="w"> </span><span class="s">'o'</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">                    </span><span class="p">[</span><span class="nx">d</span><span class="p">,</span><span class="w"> </span><span class="p">..]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="s">'0'</span><span class="w"> </span><span class="o">and</span><span class="w"> </span><span class="nx">d</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="s">'9'</span><span class="w"> </span><span class="nx">ds</span><span class="p">.</span><span class="nx">append</span><span class="p">((</span><span class="nx">d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="s">'0'</span><span class="p">).</span><span class="nx">to_u64</span><span class="p">())</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="nx">ds</span>
<span class="w">                    </span><span class="p">[]</span><span class="w"> </span><span class="nf">=&gt;</span><span class="w"> </span><span class="nx">ds</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">)</span>
<span class="p">}</span>

<span class="nv">keep_oks</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Try</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">))</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>
<span class="nv">keep_oks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">vs</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">vs</span><span class="p">.</span><span class="nx">fold</span><span class="p">(</span>
<span class="w">        </span><span class="p">[],</span>
<span class="w">        </span><span class="o">|</span><span class="nx">acc</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">match</span><span class="w"> </span><span class="nx">f</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">Ok</span><span class="nf">(u) =&gt;</span><span class="w"> </span><span class="nx">acc</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">u</span><span class="p">)</span>
<span class="w">                </span><span class="nx">Err</span><span class="nf">(_) =&gt;</span><span class="w"> </span><span class="nx">acc</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="nv">sum</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">List</span><span class="nf">(Num) -&gt;</span><span class="w"> </span><span class="nx">Num</span>
<span class="nv">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">nums</span><span class="o">|</span><span class="w"> </span><span class="nx">nums</span><span class="p">.</span><span class="nx">fold</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="nx">acc</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="o">|</span><span class="w"> </span><span class="nx">acc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span>

<span class="nv">debug</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">a</span>
<span class="nv">debug</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">|</span><span class="nx">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">dbg</span><span class="w"> </span><span class="nx">v</span>
<span class="w">    </span><span class="nx">v</span>
<span class="p">}</span>
</code></pre></div>



<a name="565393263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565393263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565393263">(Dec 25 2025 at 22:08)</a>:</h4>
<p>I'll look into this!</p>



<a name="565397398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565397398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565397398">(Dec 26 2025 at 00:26)</a>:</h4>
<p><span class="user-mention" data-user-id="518883">@Ian McLerran</span> I have a fix in <a href="https://github.com/roc-lang/roc/pull/8752/changes">https://github.com/roc-lang/roc/pull/8752/changes</a> - just cleaning it up now</p>



<a name="565397420"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565397420" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565397420">(Dec 26 2025 at 00:27)</a>:</h4>
<p>tl;dr stack corruption in the interpreter - <code>dbg</code> was not really related, it just triggered the bug because involved the stack <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="565399182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565399182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565399182">(Dec 26 2025 at 01:16)</a>:</h4>
<p>Ahh, that makes sense! Changing the debug calls just changed the stack, hence the different results.</p>



<a name="565400000"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565400000" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565400000">(Dec 26 2025 at 01:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="518883">Ian McLerran</span> has marked this topic as resolved.</p>



<a name="565403054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565403054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565403054">(Dec 26 2025 at 02:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="518883">Ian McLerran</span> has marked this topic as unresolved.</p>



<a name="565404022"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565404022" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565404022">(Dec 26 2025 at 03:18)</a>:</h4>
<p>Thanks for tackling this <span class="user-mention" data-user-id="281383">@Richard Feldman</span>! I built off the latest main, and I can see that most of the failure modes are fixed! (I can remove all the debugs, and the program compiles, regardless of whether I print from the pipe, or save the value and print)</p>
<p>Looks like this code also raises a couple other bugs if I reintroduce some <code>debug()</code> calls:<br>
1) If I reintroduce <code>(1)</code> and <code>(2)</code>:</p>
<p>- debug <code>(2)</code> prints an empty list, where it should print the integer value "209"<br>
2) If I reintroduce <code>(2)</code>, <code>(3)</code>, or <code>(4)</code> only:</p>
<p>- crashes with: <code>Roc crashed: Internal error: TypeMismatch in call_invoke_closure continuation</code></p>



<a name="565404047"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/565404047" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#565404047">(Dec 26 2025 at 03:19)</a>:</h4>
<p>ah interesting! I'll follow up!</p>



<a name="568033095"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/568033095" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#568033095">(Jan 14 2026 at 16:45)</a>:</h4>
<p>Seems like the behavior of this code has changed since 20 days ago. Now when I build, regardless of dbg statements included (or not included), the program will build, but then crashes at run time with:</p>
<div class="codehilite"><pre><span></span><code>Roc crashed: Error evaluating: NotNumeric
</code></pre></div>



<a name="568036657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/568036657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#568036657">(Jan 14 2026 at 17:00)</a>:</h4>
<p>I will minimize this and make an issue</p>



<a name="568042875"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/568042875" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#568042875">(Jan 14 2026 at 17:28)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/issues/9020">#9020</a> I have described a workaround there as well</p>



<a name="568042996"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/568042996" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#568042996">(Jan 14 2026 at 17:29)</a>:</h4>
<p>Thanks Anton!</p>



<a name="568045883"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/568045883" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#568045883">(Jan 14 2026 at 17:44)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> Great work chopping that thing down! I was trying to do the same but did not get nearly this far! <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="568045903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/568045903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#568045903">(Jan 14 2026 at 17:45)</a>:</h4>
<p>Just looking at your reproduction and work around... I see your repro was using a local closure, and the work around is to move the local closure to a top level closure. </p>
<p>It looks like the local closure <code>f</code> in your code corresponds to <code>compute_calibration</code> in my code, but in my code, <code>compute_calibration</code> is top level, not local... Seems like there might be something else going on here?</p>



<a name="568055108"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Program%20has%20different%20behavior%20depending%20on%20%60dbg%60%20place.../near/568055108" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Program.20has.20different.20behavior.20depending.20on.20.60dbg.60.20place.2E.2E.2E.html#568055108">(Jan 14 2026 at 18:35)</a>:</h4>
<p>Yeah, it seems like a complex interaction, I have included your original code as well to make sure it works when the issue appears to be fixed.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
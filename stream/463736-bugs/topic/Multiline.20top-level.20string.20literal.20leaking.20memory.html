<html>
<head><meta charset="utf-8"><title>Multiline top-level string literal leaking memory · bugs · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/index.html">bugs</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Multiline.20top-level.20string.20literal.20leaking.20memory.html">Multiline top-level string literal leaking memory</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="562531823"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Multiline%20top-level%20string%20literal%20leaking%20memory/near/562531823" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Multiline.20top-level.20string.20literal.20leaking.20memory.html#562531823">(Dec 08 2025 at 18:10)</a>:</h4>
<p>My day01.roc AoC solution works but leaks memory. I minimized it to the following example. It seems the memory leak only manifests if the string literal is top-level (not in main) and if multi-line string literal (<code>\\</code> syntax).</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="c1"># Only multi-line syntax leaks memory</span>
<span class="c1"># Single-line string literal does not leak memory: "Very long single-line string does not leak memory \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nLLLLLLLLLLLL"</span>
<span class="c1"># Multi-line string literal defined in main does not leak memory</span>
<span class="n">multi_line_constant</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">0</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">1</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">2</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">3</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">4</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">5</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">6</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">7</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">8</span>
<span class="w">    </span><span class="p">\\</span><span class="mi">9</span>
<span class="w">    </span><span class="p">\\</span><span class="n">a</span>
<span class="w">    </span><span class="p">\\</span><span class="n">b</span>
<span class="w">    </span><span class="p">\\</span><span class="n">c</span>

<span class="n">main!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">multi_line_constant</span>
<span class="p">}</span>
</code></pre></div>



<a name="562532185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Multiline%20top-level%20string%20literal%20leaking%20memory/near/562532185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Multiline.20top-level.20string.20literal.20leaking.20memory.html#562532185">(Dec 08 2025 at 18:12)</a>:</h4>
<p>Is it possible that the concatenation of the parts making the top-level string constant call some functions that allocate memory, and we don’t de-allocate it because it’s assumed top-level constants are from some arena that doesn’t need de-allocating?</p>



<a name="562533091"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Multiline%20top-level%20string%20literal%20leaking%20memory/near/562533091" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Multiline.20top-level.20string.20literal.20leaking.20memory.html#562533091">(Dec 08 2025 at 18:18)</a>:</h4>
<p>I opened an issue about it: <a href="https://github.com/roc-lang/roc/issues/8592">https://github.com/roc-lang/roc/issues/8592</a></p>



<a name="562613043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Multiline%20top-level%20string%20literal%20leaking%20memory/near/562613043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Multiline.20top-level.20string.20literal.20leaking.20memory.html#562613043">(Dec 09 2025 at 07:23)</a>:</h4>
<p>Took me a few hours to get to the bottom of this one, it came up as an issue for me in CI with more test coverage while trying to merge the <code>roc build</code> PR. Anyway should be fixed in <a href="https://github.com/roc-lang/roc/pull/8548">https://github.com/roc-lang/roc/pull/8548</a></p>



<a name="562613193"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Multiline%20top-level%20string%20literal%20leaking%20memory/near/562613193" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Multiline.20top-level.20string.20literal.20leaking.20memory.html#562613193">(Dec 09 2025 at 07:25)</a>:</h4>
<p>It was caused by one or more of these issues - a double-decref in <code>list_concat</code> and also a memory leak from <code>findCapturedValue</code></p>



<a name="562722502"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/463736-bugs/topic/Multiline%20top-level%20string%20literal%20leaking%20memory/near/562722502" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Matthieu Pizenberg <a href="https://roc-lang.github.io/zulip-export/stream/463736-bugs/topic/Multiline.20top-level.20string.20literal.20leaking.20memory.html#562722502">(Dec 09 2025 at 15:49)</a>:</h4>
<p><a href="/user_uploads/22008/IApEKxUkV-fRxdlHc_7WQKIX/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/IApEKxUkV-fRxdlHc_7WQKIX/image.png" title="image.png"><img data-original-content-type="image/png" data-original-dimensions="750x500" src="/user_uploads/thumbnail/22008/IApEKxUkV-fRxdlHc_7WQKIX/image.png/840x560.webp"></a></div>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>zig compiler - LSP · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html">zig compiler - LSP</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="527599377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/527599377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#527599377">(Jul 08 2025 at 03:48)</a>:</h4>
<p>I'm wondering if anyone is interested in working on the LSP for our new zig compiler?</p>



<a name="527599469"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/527599469" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#527599469">(Jul 08 2025 at 03:50)</a>:</h4>
<p>I'm thinking we have enough "roc check" functionality that this could be useful to have when working on <code>.roc</code> files using the new 0.1 syntax.</p>



<a name="527599859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/527599859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#527599859">(Jul 08 2025 at 03:55)</a>:</h4>
<p>I guess <span class="user-mention" data-user-id="781658">@Anthony Bullard</span> wanted working on it. Otherwise I can start the next week (on vacation rn)</p>



<a name="528111966"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528111966" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528111966">(Jul 10 2025 at 15:44)</a>:</h4>
<p>Yeah I told Kiryl to go ahead if he is interested since this "vacation" I'm on is busier than my normal working days <span aria-label="rofl" class="emoji emoji-1f923" role="img" title="rofl">:rofl:</span></p>



<a name="528193574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528193574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528193574">(Jul 11 2025 at 04:17)</a>:</h4>
<p>We talked about exposing generic information that can be used to build tooling such as a language server in this thread <a href="#narrow/stream/304641-ideas/topic/Bundle.20the.20language.20server.20in.20the.20CLI/near/523017150">https://roc.zulipchat.com/#narrow/stream/304641-ideas/topic/Bundle.20the.20language.20server.20in.20the.20CLI/near/523017150</a></p>
<p>I think it would be valuable to do some design work about how this should look before implementing it</p>



<a name="528196231"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528196231" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528196231">(Jul 11 2025 at 04:55)</a>:</h4>
<p>Ah yeah, that's a fun topic. </p>
<p>I love the simplicity of just making a <code>roc tooling</code> platform and giving is a list of all the modules in the app/package/platform in a big text S-expression format.</p>
<p>It's probably not much more work in the long run to make a nice Roc API that models things properly and would would be much nicer to work with.</p>



<a name="528196434"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528196434" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528196434">(Jul 11 2025 at 04:58)</a>:</h4>
<p>If we're not doing just a normal LSP but wanting to pursue this <code>roc tooling</code> approach instead, then we probably want to wait a little longer before we start implementing it. Designing the API and making an example app etc is very  doable now though.</p>



<a name="528334171"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528334171" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528334171">(Jul 11 2025 at 12:54)</a>:</h4>
<p>Can it be done in parallel? I like the <code>roc tooling</code> idea, but there is a couple of reasons of why I think it makes sense to start working on <code>roc lsp</code> straight away:</p>
<ol>
<li>It will show us what we need for the api and find the ergonomics we need on practice</li>
<li>LSP won't be implemented cleanly and likely would require a refactoring anyway (make it work -&gt; make it right)</li>
<li>It should be fairly easy to refactor lsp to use an API. <code>roc tooling</code> can be designed along the way.</li>
</ol>
<p>I'll start drafting things as soon as possible</p>



<a name="528362952"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528362952" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528362952">(Jul 11 2025 at 15:28)</a>:</h4>
<p>The lsp is a separate executable from the compiler, right? There is no <code>roc lsp</code> commands, right?</p>
<p>It just that currently it would via subcommands call <code>roc check</code> and in the future it would call <code>roc tooling</code>?</p>



<a name="528370779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528370779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528370779">(Jul 11 2025 at 16:11)</a>:</h4>
<p>Hm. How about having it as part of the roc cli for a while and when tooling is ready - move it somewhere else? Relying on rendered diagnostic messages seems to be not great</p>



<a name="528372085"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528372085" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528372085">(Jul 11 2025 at 16:21)</a>:</h4>
<p>Can we make it a separate executable that depends on our internal zig source (like snapshot.zig is)?</p>
<p>At least if we want it eventually decoupled, I think it is best to avoid ever putting it in the same executable.</p>
<p>... But I'm not actually sure if our long term plans here have shifted and what the current state is.</p>



<a name="528372156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528372156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528372156">(Jul 11 2025 at 16:21)</a>:</h4>
<p>Ah, sure. Good point!</p>



<a name="528376852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528376852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528376852">(Jul 11 2025 at 16:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="584248">Kiryl Dziamura</span> <a href="#narrow/stream/316715-contributing/topic/zig.20compiler.20-.20LSP/near/528370779">said</a>:</p>
<blockquote>
<p>Hm. How about having it as part of the roc cli for a while and when tooling is ready - move it somewhere else? Relying on rendered diagnostic messages seems to be not great</p>
</blockquote>
<p>my concern is that people will set up their editor configs to use it that way and then we'll never be able to get rid of it without breaking things for a bunch of people</p>



<a name="528383368"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528383368" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528383368">(Jul 11 2025 at 17:45)</a>:</h4>
<p>I see. So <code>roc tooling</code> as poc might be whatever api for <code>lsp</code> which then can be refined and stabilized? Or you suggest having <code>lsp</code> completely decoupled for now? I'm for the second option</p>



<a name="528385458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528385458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528385458">(Jul 11 2025 at 18:01)</a>:</h4>
<p>I'm saying never have a <code>roc lsp</code>, but rather have a different thing that is sufficiently powerful that you can give it a roc script and that's all you need to stand up a language server</p>



<a name="528385716"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528385716" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528385716">(Jul 11 2025 at 18:03)</a>:</h4>
<p>I definitely think we should expose enough info that people can build a fast and featureful language server just by providing <code>roc</code> with a single .roc file</p>



<a name="528385774"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528385774" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528385774">(Jul 11 2025 at 18:03)</a>:</h4>
<p>and without <code>roc</code> having any formal knowledge of the language server protocol</p>



<a name="528391637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528391637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528391637">(Jul 11 2025 at 18:54)</a>:</h4>
<p>You mean the compiler doesn't have a lsp command, but it is instead a separate binary, correct?  With no coupling between the compiler and language server?</p>



<a name="528392122"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528392122" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528392122">(Jul 11 2025 at 18:56)</a>:</h4>
<p>I know one language that fits the task very well <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span><br>
I wonder how good would it be to use roc tooling as a platform</p>



<a name="528392692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528392692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528392692">(Jul 11 2025 at 19:00)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> yes, I understand the concept of roc tooling. My question is rather "should we start working on the roc tooling or on lsp poc to understand what api the roc tooling expects to provide?"</p>



<a name="528393018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528393018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528393018">(Jul 11 2025 at 19:03)</a>:</h4>
<p>Loving this direction, here's a brief summary of what I am thinking... </p>
<p>So my understanding is the goal is for the roc cli to support plugin scripts that can take different representations of a roc module/app/platform/package and use this for different purposes. Primarily these fall into the category of developer tooling. Some use-cases I can think of; code gen, linters, debug tools, LSP etc</p>
<p>Example usage: </p>
<ul>
<li><code>roc tool &lt;plugin.roc&gt; &lt;app.roc&gt;</code> : <code>roc tool lsp.roc hello-world.roc</code></li>
</ul>
<p>The <code>app.roc</code> could be any roc code, a standalone module, an app <code>main.roc</code>, package or platform etc.</p>
<p>The <code>plugin.roc</code> is a normal roc app -- the platform it uses is provided by the roc cli. It has an API that provides information about the <code>app.roc</code> that was provided, and enables various IO. The roc cli is the host which loads the plugin script, and provides the information for it to do it's thing.</p>
<p>We discussed different ideas about what this API would actually look like -- the approach I think is simplest and most flexible (at least to start with) is to provide a <code>Str</code> that is simply the CanIR s-expression (exactly the same as is used in the snapshots).</p>
<p>The way I am thinking we approach this is as follows;</p>
<ol>
<li>Add a flag to <code>roc check --dump-cir</code> that simply prints the CanIR s-expression to STDOUT</li>
<li>Write a Roc package (using current roc) that parses the CanIR s-expression</li>
<li>Write an LSP using basic-cli/basic-webserver that calls <code>./zig-out/bin/roc check --dump-cir ...</code></li>
</ol>
<p>This will give us an end to end capability quickly, and enable or unlock a lot of other dev tooling.</p>
<p>At some point we will want to transition to <code>roc tool</code> and have a plugin, but I think this should be deferred until after we build <code>roc glue</code> and really establish the conventions for calling into roc and platform development. </p>
<p>While there is some translation from current roc syntax to 0.1 -- I don't expect this to be a major issue in future.</p>
<p>Interested to know what people think of this approach?</p>



<a name="528394243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528394243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528394243">(Jul 11 2025 at 19:13)</a>:</h4>
<p>My take on it is that I don't know at which level roc tooling should provide info and how because there's no consumers yet. Like, we can do the can ir sexpr and then it turns out the consumer needs smth else. I mean, I love the idea of roc tooling but just don't know the real world requirements. Rephrasing, roc tooling is a server and tools are clients. But I don't know how clients want to be served because there are no clients yet.</p>
<p>I'll read some discussions on it</p>



<a name="528394391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528394391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528394391">(Jul 11 2025 at 19:15)</a>:</h4>
<p>We could also easily add a <code>roc check --dump-ast</code> also if there are tools we want to build that use the AST instead.</p>



<a name="528394516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528394516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528394516">(Jul 11 2025 at 19:16)</a>:</h4>
<p>I think we just start with something really basic. I don't understand LSP very well, but I imagine there is something like, jump to definition or what type is this identifier etc</p>



<a name="528394537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528394537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528394537">(Jul 11 2025 at 19:16)</a>:</h4>
<p>Maybe <span class="user-mention" data-user-id="651372">@Eli Dowling</span> might have some advice?</p>



<a name="528396098"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528396098" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528396098">(Jul 11 2025 at 19:29)</a>:</h4>
<p>I imagine roc tooling as a DB, where roc file is a representation of database. And you can send queries to it</p>



<a name="528397821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528397821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528397821">(Jul 11 2025 at 19:47)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> I like that idea!</p>



<a name="528397889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528397889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528397889">(Jul 11 2025 at 19:48)</a>:</h4>
<p>I'd maybe call it <code>--deprecated-dump-ir</code> just to set expectations that we will replace it in the future with something else <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="528398064"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528398064" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528398064">(Jul 11 2025 at 19:50)</a>:</h4>
<p>so I will start with the flag implementation? so then it's possible to pipe it's output to a separate simple implementation of lsp, right? for starters</p>



<a name="528399838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528399838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528399838">(Jul 11 2025 at 20:06)</a>:</h4>
<p>hmm, I'm kinda second-guessing how useful that would be now that I'm thinking about it more</p>



<a name="528400113"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528400113" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528400113">(Jul 11 2025 at 20:08)</a>:</h4>
<p>I think if we did the dump to a file thing, we would end up starting over from scratch when we start on the real thing bc so little of it would be useful</p>



<a name="528400377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528400377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528400377">(Jul 11 2025 at 20:11)</a>:</h4>
<p>that's why I suggest implementing a simple lsp using roc zig as library and iteratively get to the tooling middleware</p>



<a name="528401842"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528401842" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528401842">(Jul 11 2025 at 20:24)</a>:</h4>
<p>I guess we could call it --deprecated-lsp haha</p>



<a name="528411031"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528411031" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528411031">(Jul 11 2025 at 21:54)</a>:</h4>
<p>Do we need to implement a language server before getting to tooling/plugin system?</p>



<a name="528411767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528411767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528411767">(Jul 11 2025 at 22:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/316715-contributing/topic/zig.20compiler.20-.20LSP/near/528400113">said</a>:</p>
<blockquote>
<p>I think if we did the dump to a file thing, we would end up starting over from scratch when we start on the real thing bc so little of it would be useful</p>
</blockquote>
<p>Maybe we should discuss this in another thread.</p>
<p>Why shouldn't we use the s-expression as a Str? How big of an issue would that be?</p>



<a name="528411909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528411909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528411909">(Jul 11 2025 at 22:06)</a>:</h4>
<p>Previous thoughts <a href="#narrow/channel/304641-ideas/topic/Bundle.20the.20language.20server.20in.20the.20CLI/near/523176618">https://roc.zulipchat.com/#narrow/channel/304641-ideas/topic/Bundle.20the.20language.20server.20in.20the.20CLI/near/523176618</a></p>



<a name="528413205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528413205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528413205">(Jul 11 2025 at 22:23)</a>:</h4>
<p>I haven't written this up anywhere, but my general thought is that the way I think we should try doing a language server is: </p>
<ul>
<li>we load up all our ModuleEnvs in the usual way</li>
<li>we build our graph of dependencies between those modules</li>
<li>within each of those modules, we also know what their exports are</li>
<li>we keep a process running with all of this in memory</li>
<li>when we get an individual change to a particular file, we diff its source bytes to figure out which top-level decls changed, and redo parsing on them to get new asts for them</li>
<li>then we replace the old canonical decls with lookups to the new ones, so that all the existing references to the old ones get automatically updated in-place</li>
<li>then we use our old canonical dependency graph of top-level decls to see which top-level decls need to have their types re-checked if necessary (in many cases we can quickly determine that the changed top-level decls(s) could not possibly have changed their types, so this is unnecessary)</li>
<li>now we finish all necessary type-checking within the module </li>
<li>now we see if any exposed things changed types; if so, other modules which depend on this one will need to be rebuilt in a similar incremental way</li>
<li>finally we're all synced up and back to normal, except some of our node stores have grown</li>
<li>to prevent this from growing memory usage indefinitely, we have a background thread with low priority which copies over module envs into more compact representations by rebuilding them from AST onward. If this finishes and the original module env wasn't modified in the meantime, then we atomically swap it in and deinit the old one</li>
<li>in this way, we have cheap garbage collection of modules, they can get updated incrementally very quickly, and we always have all the info necessary in memory to answer questions about types, references, etc.</li>
</ul>



<a name="528413241"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528413241" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528413241">(Jul 11 2025 at 22:24)</a>:</h4>
<p>I think that's how we get the best LSP perf and memory usage, and that has essentially nothing in common with reading SExprs from disk and then doing different things with them in memory <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="528413437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528413437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528413437">(Jul 11 2025 at 22:27)</a>:</h4>
<p>Don’t try to diff bytes prior to parsing. That’s basically a buggy implementation of an incremental parser. Either build a proper incremental parser or just always reparse the whole file</p>



<a name="528414016"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414016" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414016">(Jul 11 2025 at 22:36)</a>:</h4>
<p>I mean using regions</p>



<a name="528414037"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414037" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414037">(Jul 11 2025 at 22:36)</a>:</h4>
<p>like the language server says "here is what was modified" and we use our regions to tell what was modified</p>



<a name="528414051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414051">(Jul 11 2025 at 22:36)</a>:</h4>
<p>maybe "diff" is the wrong word for that haha</p>



<a name="528414278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414278">(Jul 11 2025 at 22:40)</a>:</h4>
<p>This doesn't sound like plugin at all. This just sounds like a separate binary that is still coupled to the check libraries , just like snapshot.  Which i think is fine but above it sounded like there was a desire for something with less coupling</p>



<a name="528414305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414305">(Jul 11 2025 at 22:41)</a>:</h4>
<p>(Even if i think that's not easy to do if you also want top performance from the language server)</p>



<a name="528414338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414338">(Jul 11 2025 at 22:41)</a>:</h4>
<p>I think this should be in the <code>roc</code> binary</p>



<a name="528414359"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414359" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414359">(Jul 11 2025 at 22:42)</a>:</h4>
<p>everything I just described is still useful for something like <code>roc check --watch</code></p>



<a name="528414373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414373">(Jul 11 2025 at 22:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/zig.20compiler.20-.20LSP/near/528385458">said</a>:</p>
<blockquote>
<p>I'm saying never have a <code>roc lsp</code>, but rather have a different thing that is sufficiently powerful that you can give it a roc script and that's all you need to stand up a language server</p>
</blockquote>
<p>Then what was meant by this?</p>



<a name="528414381"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414381" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414381">(Jul 11 2025 at 22:42)</a>:</h4>
<p>sorry, "different thing" as in <code>roc tool</code></p>



<a name="528414426"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414426" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414426">(Jul 11 2025 at 22:43)</a>:</h4>
<p>So tool is a sub command of the compiler binary that does the above in service of multiple tools that are implemented in Roc?</p>



<a name="528414429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414429">(Jul 11 2025 at 22:43)</a>:</h4>
<p>yeah</p>



<a name="528414435"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414435" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414435">(Jul 11 2025 at 22:43)</a>:</h4>
<p>so like you could use it to implement a codemod tool as well, for example</p>



<a name="528414439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414439">(Jul 11 2025 at 22:43)</a>:</h4>
<p>or a language server</p>



<a name="528414450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414450">(Jul 11 2025 at 22:43)</a>:</h4>
<p>or a dedicated plugin for a specific editor that's more ambitious than just language server</p>



<a name="528414463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414463">(Jul 11 2025 at 22:44)</a>:</h4>
<p>Ok. interesting</p>



<a name="528414471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414471">(Jul 11 2025 at 22:44)</a>:</h4>
<p>the specific thing I don't want to do is to couple <code>roc</code> to the language server protocol</p>



<a name="528414481"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414481" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414481">(Jul 11 2025 at 22:44)</a>:</h4>
<p>Is there prior art, or is this just an experiment?</p>



<a name="528414540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414540">(Jul 11 2025 at 22:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/zig.20compiler.20-.20LSP/near/528414471">said</a>:</p>
<blockquote>
<p>the specific thing I don't want to do is to couple <code>roc</code> to the language server protocol</p>
</blockquote>
<p>i understand this, even with LSP having such deep momentum behind it</p>



<a name="528414625"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414625" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414625">(Jul 11 2025 at 22:46)</a>:</h4>
<p>there's lots of prior art for doing it in batch builds (e.g. code mod tools, languages like Nim have lots of <a href="https://youtu.be/ElHi2h9Ho6M?si=5tQUTqMo1UB7gkE0">static introspection features</a>) and there's also lots of prior art for doing dynamic runtime introspection (e.g. Smalltalk) but I'm not aware of prior art combining the two - a static analysis system that efficiently keeps itself up-to-date with changes at runtime</p>
<div class="youtube-video message_inline_image"><a data-id="ElHi2h9Ho6M" href="https://youtu.be/ElHi2h9Ho6M?si=5tQUTqMo1UB7gkE0"><img src="https://uploads.zulipusercontent.net/a8c4334bead326844ceeb04c836e647992455d67/68747470733a2f2f692e7974696d672e636f6d2f76692f456c4869326839486f364d2f6d7164656661756c742e6a7067"></a></div>



<a name="528414631"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414631" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414631">(Jul 11 2025 at 22:46)</a>:</h4>
<p>One down side is it means that we have to have at least a working interpreter for Roc v0.1 implemented to start on implementation of this</p>



<a name="528414656"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414656" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414656">(Jul 11 2025 at 22:47)</a>:</h4>
<p>yeah that's why I'd be ok with doing a temporary like <code>roc deprecated-lsp</code> or something</p>



<a name="528414676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414676">(Jul 11 2025 at 22:47)</a>:</h4>
<p>just really clearly communicate that it's a stopgap that will be going away, to be replaced by something else that you can use to achieve the same goal</p>



<a name="528414684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414684">(Jul 11 2025 at 22:47)</a>:</h4>
<p>Ok</p>



<a name="528414728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414728">(Jul 11 2025 at 22:48)</a>:</h4>
<p>but that temporary thing should just be a zig library that's exposed in the roc binary just like<br>
check, test, build, etc</p>



<a name="528414745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414745">(Jul 11 2025 at 22:49)</a>:</h4>
<p>but I do think we should aim for an architecture along these lines:</p>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/316715-contributing/topic/zig.20compiler.20-.20LSP/near/528413205">said</a>:</p>
<blockquote>
<p>I haven't written this up anywhere, but my general thought is that the way I think we should try doing a language server is: </p>
</blockquote>



<a name="528414764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414764">(Jul 11 2025 at 22:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="781658">Anthony Bullard</span> <a href="#narrow/channel/316715-contributing/topic/zig.20compiler.20-.20LSP/near/528414728">said</a>:</p>
<blockquote>
<p>but that temporary thing should just be a zig library that's exposed in the roc binary just like<br>
check, test, build, etc</p>
</blockquote>
<p>I think just have it be part of the normal <code>roc</code> CLI</p>



<a name="528414768"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414768" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414768">(Jul 11 2025 at 22:49)</a>:</h4>
<p>Ok, i think that temporary things architecture is what is being decided here</p>



<a name="528414787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414787">(Jul 11 2025 at 22:49)</a>:</h4>
<p>like we can of course build something simpler, but it feels kinda wasteful</p>



<a name="528414795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414795">(Jul 11 2025 at 22:49)</a>:</h4>
<p>I think roc tool is awesome for once we have a working stable intepreter</p>



<a name="528414801"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414801" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414801">(Jul 11 2025 at 22:49)</a>:</h4>
<p>we already have the module envs in place</p>



<a name="528414807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414807">(Jul 11 2025 at 22:50)</a>:</h4>
<p>Yep</p>



<a name="528414824"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414824" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414824">(Jul 11 2025 at 22:50)</a>:</h4>
<p>loading files is <a href="https://github.com/roc-lang/roc/pull/8001">WIP</a></p>



<a name="528414836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414836">(Jul 11 2025 at 22:50)</a>:</h4>
<p>And our check pipeline is so fast it'll be great perf</p>



<a name="528414852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414852">(Jul 11 2025 at 22:50)</a>:</h4>
<p>I hope we can make the tool interface still very performant as well</p>



<a name="528414971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528414971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528414971">(Jul 11 2025 at 22:53)</a>:</h4>
<p>yeah I haven't super dug into it but I think we'll be good thanks to the whole <code>Idx</code> thing</p>



<a name="528415031"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528415031" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528415031">(Jul 11 2025 at 22:54)</a>:</h4>
<p>supposedly (Folkert and Andrew independently confirmed this) you can turn a SoA thing into a normal tagged union for ergonomics and llvm will optimize away the conversion</p>



<a name="528415065"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528415065" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528415065">(Jul 11 2025 at 22:54)</a>:</h4>
<p>so we should be able to offer nice ergonomics as well as great perf...in theory at least!</p>



<a name="528415153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528415153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528415153">(Jul 11 2025 at 22:56)</a>:</h4>
<p>i can't wait to have some actual down days to jump back into roc development</p>



<a name="528415473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528415473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528415473">(Jul 11 2025 at 23:01)</a>:</h4>
<p>if it's still gonna be hectic for awhile, I'd be happy to get your PR across the finish line</p>



<a name="528415489"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528415489" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528415489">(Jul 11 2025 at 23:02)</a>:</h4>
<p>we've been avoiding touching parser stuff and it would be nice to unblock if you're gonna be bandwidth-constrained awhile longer! <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="528415509"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528415509" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528415509">(Jul 11 2025 at 23:02)</a>:</h4>
<p>there's plenty of other stuff in the pipe <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="528415579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528415579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528415579">(Jul 11 2025 at 23:03)</a>:</h4>
<p>FWIW I think an actual incremental parser is not that difficult to do (and make "clearly correct")</p>



<a name="528418985"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528418985" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528418985">(Jul 12 2025 at 00:03)</a>:</h4>
<p>Basically:</p>
<ul>
<li>The parser grows a new field: known_edit_range: (offset, old_len, new_len)</li>
<li>We introduce a new internal ast node type: node_reference, which has an original_id and a "shift" (amount by which we have to adjust ranges to be correct)</li>
<li>Most parsing functions get a new optional arg for the "possible old node"</li>
<li>Those functions will have a small preamble where they check if there's a trivial match against the node passed, and if so return a node_reference pointing to that. We can determine a "trivial" match by looking at the current pos, the known_edit_range, and the node's offset.</li>
<li>Otherwise, they also need to fish out what would be the corresponding field in the "possible old node" to pass that to child parsers</li>
</ul>



<a name="528419124"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528419124" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528419124">(Jul 12 2025 at 00:06)</a>:</h4>
<p>Also, the ast node id type used outside the parser will need to grow an extra field to store the expected "shift", which is applied when looking up any ranges.</p>



<a name="528419290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528419290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528419290">(Jul 12 2025 at 00:07)</a>:</h4>
<p>We can chose to modify as many or as few functions as we want - so if we do this at the granularity of defs, we automatically get a parser that can skip re-parsing matching defs. Or we can make every function do this, and get very fine-grained re-use.</p>



<a name="528419309"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528419309" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528419309">(Jul 12 2025 at 00:07)</a>:</h4>
<p>(obviously the tokenizer needs to be able to produce a diff as well)</p>



<a name="528419369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528419369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528419369">(Jul 12 2025 at 00:08)</a>:</h4>
<p>That much is somewhat non-trivial, especially with string interpolation, but very doable.</p>



<a name="528419428"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528419428" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528419428">(Jul 12 2025 at 00:09)</a>:</h4>
<p>Of course, maybe this is roughly what you mean by "we use our regions to tell what was modified"</p>



<a name="528423013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528423013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528423013">(Jul 12 2025 at 01:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/316715-contributing/topic/zig.20compiler.20-.20LSP/near/528413205">said</a>:</p>
<blockquote>
<p>I haven't written this up anywhere, but my general thought is that the way I think we should try doing a language server is: </p>
</blockquote>
<p>Ok, thank you for summarising this... clears some things up.</p>



<a name="528423069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528423069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528423069">(Jul 12 2025 at 01:21)</a>:</h4>
<p>Based on this, I'd say we just wait a little and build the tool version of an LSP. There's no rush and we're probably not too far away. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="528425025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528425025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528425025">(Jul 12 2025 at 02:03)</a>:</h4>
<p>That tooling api is going to be important to design well, since it's now an API contract for the compiler (obv more important post v1)</p>



<a name="528425457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528425457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528425457">(Jul 12 2025 at 02:12)</a>:</h4>
<p>100%!</p>



<a name="528429215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528429215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528429215">(Jul 12 2025 at 03:42)</a>:</h4>
<p>There's nothing stopping us from designing that now.. or sketching out prelimary concepts. </p>
<p>Coming back to the <code>--deprecated-dump-can-ir</code> idea... we could use that as a bit of a hack to simulate the API and do some experiments with real 0.1 programs. Acknowledge we will be throwing most of this work away, but the goal wouldnt be to make a super comprehensive implementation just hack enough together to explore the tooling API design space. </p>
<p>Having a more mature API design we are aiming for earlier would be quite helpful.</p>



<a name="528429269"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/zig%20compiler%20-%20LSP/near/528429269" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/zig.20compiler.20-.20LSP.html#528429269">(Jul 12 2025 at 03:43)</a>:</h4>
<p>It's also something cool people can work on if they're just wanting to learn and write Roc and not so keen on Zig or Rust things -- but still is really helpful working towards nice tooling for the 0.1 implementation</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
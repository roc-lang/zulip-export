<html>
<head><meta charset="utf-8"><title>Set perf · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html">Set perf</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="405705083"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405705083" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405705083">(Dec 03 2023 at 22:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="586417">Elias Mulhall</span> <a href="#narrow/stream/358903-Advent-of-Code/topic/2023.20Day.203/near/405676155">said</a>:</p>
<blockquote>
<p><a href="https://gist.github.com/mulias/b07e012ced92406f59cc2548d0f01323">Day 3, this one has a performance bug that I'll talk about below</a><br>
<a href="https://gist.github.com/mulias/f217e7461a2b847b1110d27e6c6191a1">Day 3, with a workaround</a></p>
<div class="spoiler-block"><div class="spoiler-header">
<p>Performance Issue Details</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>I used a set of <code>{x: Nat, y: Nat}</code> indices to solve for adjacency. Something about this is hella slow. There's a benchmark in the gist, but the implementation using sets takes ~6 seconds to run. If I try  running a build compiled with <code>--optimize</code> then  it hangs forever while using 100% of a CPU core.</p>
<p>To troubleshoot I did a super naive swap, changing out the sets for lists, used concat instead of union, and searching through the two lists to find the intersection. That runs in ~2 seconds unoptimized and ~150ms optimized.</p>
<p>There's some inefficiency in my code but the set implementation being so much slower seems like a bug to me.</p>
<p></div></div><br>
</p>
</blockquote>
<p>I haven't root caused this or anything, but it honestly might just be a case of a bad usecase for set that got unlucky with perf (though obviously must be some sort of bug due to the issue with <code>--optimize</code>.</p>
<p>Anyway, stats I have so far.</p>
<p>1) generates 1863 neighbor sets of size 8. 8 is an unlucky number it means that every one of those sets will be allocated, insert 7 values which requires hashing them, reallocated and rehashed, then insert the final value. So every fromList call here will cast 2 allocations, 15 hashes, and some other data twiddling.</p>
<p>Fixing fromList perf and at a minimum getting withCapacity properly working should help a lot here. I forget why fromCapacity is no implemented currently, but this probably is pretty terrible for perf.</p>
<p>2) This generates 32222 sets of size 0 to 3 for the various indices. 29788 of which are just empty. Given these never rehash, this is just a ridiculous number of allocations (that wouldn't happen with an empty list) due to dictionaries having a default capacity of 8. And currently a dictionary is 2 allocations. So compared to using lists, this is 59576 extra allocations....probably this is the main issue?</p>
<p>3) Set.insection are currently not written in the optimal way. It probably should be walking one set and removing items. Instead it generates a totally new set from empty.</p>



<a name="405705785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405705785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405705785">(Dec 03 2023 at 22:53)</a>:</h4>
<p>love this investigation! <span aria-label="star struck" class="emoji emoji-1f929" role="img" title="star struck">:star_struck:</span></p>



<a name="405707263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405707263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405707263">(Dec 03 2023 at 23:11)</a>:</h4>
<p>Ahhh, the size 8 thing makes sense. It would be pretty straightforward to add a <code>Set.withCapacity</code>, right? Actually in that case I'm doing <code>Set.fromList</code>... would it be bad for that function to eager-allocate the set to have the same capacity as the list? Depending on use case that might mean allocing way more space than needed, but not to a ridiculous degree.</p>



<a name="405707338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405707338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405707338">(Dec 03 2023 at 23:12)</a>:</h4>
<p>Oops, I skipped the paragraph where you already said that</p>



<a name="405707537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405707537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405707537">(Dec 03 2023 at 23:15)</a>:</h4>
<p>Is the <code>--optimize</code> issue reproducable, or just me?</p>



<a name="405707558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405707558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405707558">(Dec 03 2023 at 23:15)</a>:</h4>
<p>Reproducible on my end</p>



<a name="405707619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405707619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405707619">(Dec 03 2023 at 23:16)</a>:</h4>
<p>I'll try to implement a few improvements and see how it goes.</p>



<a name="405707739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405707739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405707739">(Dec 03 2023 at 23:18)</a>:</h4>
<p>As an extra note, if we were really careful, the set could theoretically take ownership of the list and reuse the allocation. Though would be a more complex algorithm. Would need to inplace deal with duplicate elements.</p>



<a name="405713329"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713329" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713329">(Dec 04 2023 at 00:27)</a>:</h4>
<blockquote>
<p>So compared to using lists, this is 59576 extra allocations</p>
</blockquote>
<p>...</p>
<p>So allocating is faster than not allocating. Cause if we don't allocate, we have to add an extra conditional to all insert/get/remove/etc calls.</p>



<a name="405713463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713463">(Dec 04 2023 at 00:29)</a>:</h4>
<p>about 10% faster to just always allocate with this example</p>



<a name="405713469"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713469" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713469">(Dec 04 2023 at 00:29)</a>:</h4>
<p>what's the extra conditional?</p>



<a name="405713478"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713478" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713478">(Dec 04 2023 at 00:29)</a>:</h4>
<p>like what does it do</p>



<a name="405713513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713513">(Dec 04 2023 at 00:29)</a>:</h4>
<p>before it would just unsafe load an index from the metadata</p>



<a name="405713535"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713535" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713535">(Dec 04 2023 at 00:29)</a>:</h4>
<p>Now it has to check length is not 0</p>



<a name="405713626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713626">(Dec 04 2023 at 00:30)</a>:</h4>
<p>and for insert of course, if not allocated, it has to allocate at the beginning of the function.</p>



<a name="405713939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405713939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405713939">(Dec 04 2023 at 00:33)</a>:</h4>
<p>Also, due to the sets being super small (max size 8 elements), I don't think that sets will ever be faster than lists for this exampl. Lots of extra overhead with hashing, allocations, and extra conditionals with very very small data.</p>



<a name="405714071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405714071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405714071">(Dec 04 2023 at 00:35)</a>:</h4>
<p>I wonder if there's some cmov trick that could work here</p>



<a name="405714146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405714146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405714146">(Dec 04 2023 at 00:35)</a>:</h4>
<p>like this part:</p>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405713513">said</a>:</p>
<blockquote>
<p>before it would just unsafe load an index from the metadata</p>
</blockquote>
<p>could use a cmov for "if length is 0, set the pointer to be a pointer to the address of the length itself" or something</p>



<a name="405714173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405714173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405714173">(Dec 04 2023 at 00:36)</a>:</h4>
<p>(I don't know what the metadata would need to be for "this is missing" though)</p>



<a name="405714297"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405714297" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405714297">(Dec 04 2023 at 00:37)</a>:</h4>
<p>probably not.</p>
<p>It is essentialy:</p>
<div class="codehilite"><pre><span></span><code>if initialized:
    # do some gigantic compute
else:
    just return
</code></pre></div>
<p>Generally <code>cmov</code> is only good for evenish small compute. branch prediction is much better for cases like this.</p>



<a name="405714797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405714797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405714797">(Dec 04 2023 at 00:41)</a>:</h4>
<p>well that's true for <code>insert</code>, right? But <code>get</code> presumably never initializes anything</p>



<a name="405714831"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405714831" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405714831">(Dec 04 2023 at 00:41)</a>:</h4>
<p>but I guess it's the others that are significantly slowed down here</p>



<a name="405715036"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405715036" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405715036">(Dec 04 2023 at 00:42)</a>:</h4>
<p>So <code>insert</code> is actually</p>
<div class="codehilite"><pre><span></span><code>if !initialized:
    initialize

# do rest of compute with initialized dict
</code></pre></div>
<p>for <code>get</code>, it is the case mentioned above. Cause hashing and calculating index related stuff is the large compute I was mentioning above.</p>



<a name="405715275"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405715275" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405715275">(Dec 04 2023 at 00:44)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> doesn't <code>insert</code> need a branch anyway to see if it's over capacity?</p>



<a name="405715820"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405715820" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405715820">(Dec 04 2023 at 00:49)</a>:</h4>
<p>Only if the key isn't found</p>



<a name="405716006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716006">(Dec 04 2023 at 00:50)</a>:</h4>
<p>ok so then it branches on whether the key is found, right?</p>



<a name="405716044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716044">(Dec 04 2023 at 00:50)</a>:</h4>
<p>yep</p>



<a name="405716076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716076">(Dec 04 2023 at 00:51)</a>:</h4>
<p>but checking indices assumes the dict is initialized</p>



<a name="405716139"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716139" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716139">(Dec 04 2023 at 00:51)</a>:</h4>
<p>So it never does any bounds checks</p>



<a name="405716167"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716167" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716167">(Dec 04 2023 at 00:51)</a>:</h4>
<p>gotcha, so what if that branch's conditional branchlessly checked length?</p>



<a name="405716283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716283">(Dec 04 2023 at 00:52)</a>:</h4>
<p>e.g. do both the cmov thing I mentioned earlier and also an <code>AND</code> with it being nonempty</p>



<a name="405716362"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716362" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716362">(Dec 04 2023 at 00:53)</a>:</h4>
<p>That branch is after it has already unconditionally loaded from the metadata. Which would deref a null pointer on an uninitialized dict.</p>



<a name="405716431"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716431" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716431">(Dec 04 2023 at 00:53)</a>:</h4>
<p>that's what I mean about doing a cmov to have the null pointer point to <code>&amp;length</code> or whatever so it can be successfully dereferenced to something we'll ignore anyway</p>



<a name="405716605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716605">(Dec 04 2023 at 00:55)</a>:</h4>
<p>e.g. (pretending <code>&amp;&amp;</code> is not going to desugar to a condition here):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">isEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="kd">let</span><span class="w"> </span><span class="n">metadataPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">isEmpty</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">&amp;</span><span class="n">len</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">normalMetadataPtr</span><span class="w"> </span><span class="p">};</span>

<span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">isEmpty</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">doNormalCheckOn</span><span class="p">(</span><span class="n">metadataPtr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



<a name="405716646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405716646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405716646">(Dec 04 2023 at 00:55)</a>:</h4>
<p>it's definitely possible that would still be more costly than the branch misprediction though haha</p>



<a name="405718629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405718629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405718629">(Dec 04 2023 at 01:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405713939">said</a>:</p>
<blockquote>
<p>Also, due to the sets being super small (max size 8 elements), I don't think that sets will ever be faster than lists for this exampl. Lots of extra overhead with hashing, allocations, and extra conditionals with very very small data.</p>
</blockquote>
<p>something I've wondered about is whether we should consider having a "small hashmap optimization" where we don't use a hashmap if the collection is small enough</p>



<a name="405718671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405718671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405718671">(Dec 04 2023 at 01:10)</a>:</h4>
<p>and instead <code>Dict</code> (and therefore <code>Set</code> too) is backed by a flat <code>List</code> of tuples</p>



<a name="405719434"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405719434" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405719434">(Dec 04 2023 at 01:17)</a>:</h4>
<p>So I figured out how to remove the branch. Just use constant lists. Then it is always initialized</p>



<a name="405719455"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405719455" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405719455">(Dec 04 2023 at 01:17)</a>:</h4>
<p>Instead of before where it was using list.repeat.</p>



<a name="405719477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405719477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405719477">(Dec 04 2023 at 01:17)</a>:</h4>
<p>Also initialization changes seem to have fixed the <code>--optimize</code> bug.</p>



<a name="405719492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405719492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405719492">(Dec 04 2023 at 01:17)</a>:</h4>
<p>In optimized, this is about 6x slower than the list version</p>



<a name="405719577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405719577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405719577">(Dec 04 2023 at 01:18)</a>:</h4>
<p>which honestly may be expected perf. Probably should write something similar in c++ with absl::flat_hash_map and vector to compare</p>



<a name="405719943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405719943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405719943">(Dec 04 2023 at 01:21)</a>:</h4>
<p>constant lists as in they're allocated in the readonly section of the binary?</p>



<a name="405720093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405720093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405720093">(Dec 04 2023 at 01:23)</a>:</h4>
<p>Yeah, they should be. Though looking at the llvm, I think llvm is smart enough to make them magically disappear cause they are so small. Not fully sure</p>



<a name="405720182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405720182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405720182">(Dec 04 2023 at 01:24)</a>:</h4>
<p>very cool!</p>



<a name="405720196"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405720196" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405720196">(Dec 04 2023 at 01:24)</a>:</h4>
<p>what do you think of the "small hashmap optimization" idea?</p>



<a name="405720694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405720694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405720694">(Dec 04 2023 at 01:29)</a>:</h4>
<p>Mostly questioning if it is a good idea for automatic application or a better idea for human optimization.</p>



<a name="405720843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405720843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405720843">(Dec 04 2023 at 01:30)</a>:</h4>
<p>As in, we could expose both types with the same api (or make the list verson in a package). Explicitly choosing either one avoids perf costs related to extra conditionals. So if you know you need large or know you need small it makes sense to pick explicitly. That said merged may avoid some worst cases like this.</p>



<a name="405720848"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405720848" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405720848">(Dec 04 2023 at 01:30)</a>:</h4>
<p>I think the pitch for it is that it's common to use <code>Set</code> or <code>Dict</code> not so much for performance but rather because they enforce a guarantee and clearly communicate intent</p>



<a name="405720965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405720965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405720965">(Dec 04 2023 at 01:32)</a>:</h4>
<p>and we could have separate types for that, but I do wonder whether the extra conditional matters in the "actually use a hash map" case when you have so many entries that you're probably getting cache misses</p>



<a name="405721048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721048">(Dec 04 2023 at 01:32)</a>:</h4>
<blockquote>
<p>not so much for performance</p>
</blockquote>
<p>To that I would say, use <code>--optimize</code> and accept that it may not be the same perf as picking a <code>ListSet</code> or <code>ListDict</code>, but perf isn't the main concern.</p>



<a name="405721080"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721080" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721080">(Dec 04 2023 at 01:33)</a>:</h4>
<p>Also, I need to do some measurements, but likely we should just rewrite dict as a zig builtin.</p>



<a name="405721091"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721091" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721091">(Dec 04 2023 at 01:33)</a>:</h4>
<p>That probably will close a solid chunk of the gap.</p>



<a name="405721185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721185">(Dec 04 2023 at 01:34)</a>:</h4>
<p>But I can't really guarantee that currently, it is mostly speculation. That said, I was unable to implement part of the absl::flat_hash_map optimization in roc due to it being worse performance</p>



<a name="405721221"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721221" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721221">(Dec 04 2023 at 01:35)</a>:</h4>
<p>Though I think we have a builtin to address part of that now, so maybe I should try again.</p>



<a name="405721744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721744">(Dec 04 2023 at 01:40)</a>:</h4>
<p>I also wonder if a <code>List.appendUnique</code> or something might be useful</p>



<a name="405721804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721804">(Dec 04 2023 at 01:41)</a>:</h4>
<p>like some quick way to use a list like a <code>Set</code> except with different performance characteristics</p>



<a name="405721875"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721875" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721875">(Dec 04 2023 at 01:42)</a>:</h4>
<p>eh might be clearer to get a <code>ListSet</code> off the shelf or something</p>



<a name="405721882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405721882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405721882">(Dec 04 2023 at 01:42)</a>:</h4>
<p>oh, so essentially:</p>
<div class="codehilite"><pre><span></span><code>if !List.contains list x then
    List.append list x
</code></pre></div>



<a name="405722506"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405722506" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405722506">(Dec 04 2023 at 01:49)</a>:</h4>
<p>Just found a huge speed boost in the app...<br>
from</p>
<div class="codehilite"><pre><span></span><code>|&gt; Set.union state
</code></pre></div>
<p>to</p>
<div class="codehilite"><pre><span></span><code>|&gt; \x -&gt; Set.union state x
</code></pre></div>
<p>Made the optimized build about 2x faster</p>



<a name="405723637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405723637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405723637">(Dec 04 2023 at 02:01)</a>:</h4>
<p>Anyway, on a branch, I am down to 3x slower on an optimized build with set vs with list.</p>



<a name="405724615"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405724615" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405724615">(Dec 04 2023 at 02:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405722506">said</a>:</p>
<blockquote>
<p>Just found a huge speed boost in the app...<br>
from</p>
<div class="codehilite"><pre><span></span><code>|&gt; Set.union state
</code></pre></div>
<p>to</p>
<div class="codehilite"><pre><span></span><code>|&gt; \x -&gt; Set.union state x
</code></pre></div>
<p>Made the optimized build about 2x faster</p>
</blockquote>
<p>whoa! Why does that improve speed?</p>



<a name="405724804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405724804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405724804">(Dec 04 2023 at 02:11)</a>:</h4>
<p>It is equivalent of going from</p>
<div class="codehilite"><pre><span></span><code>List.concat smallList largeList
</code></pre></div>
<p>To</p>
<div class="codehilite"><pre><span></span><code>List.concat largeList smallList
</code></pre></div>



<a name="405724827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405724827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405724827">(Dec 04 2023 at 02:11)</a>:</h4>
<p>So copy a few elements to the end of something large instead of copy a ton of elements to the end of something small.</p>



<a name="405724843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405724843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405724843">(Dec 04 2023 at 02:11)</a>:</h4>
<p>In a very hot loop</p>



<a name="405725182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725182">(Dec 04 2023 at 02:14)</a>:</h4>
<p>ohhh</p>



<a name="405725202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725202">(Dec 04 2023 at 02:14)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> does that suggest we should swap the argument order there?</p>



<a name="405725290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725290">(Dec 04 2023 at 02:15)</a>:</h4>
<p>oh nm, I guess this is application-specific</p>



<a name="405725424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725424">(Dec 04 2023 at 02:16)</a>:</h4>
<p>might be too fancy, but I wonder if it's worth picking which one we insert into based on which is bigger, assuming they're both unique</p>



<a name="405725429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725429">(Dec 04 2023 at 02:16)</a>:</h4>
<p>I added a conditional in the function. I think that will be worth it in general</p>



<a name="405725588"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725588" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725588">(Dec 04 2023 at 02:17)</a>:</h4>
<p>in <code>Set.union</code> you mean?</p>



<a name="405725612"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725612" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725612">(Dec 04 2023 at 02:17)</a>:</h4>
<p>yeah</p>



<a name="405725745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725745">(Dec 04 2023 at 02:18)</a>:</h4>
<p>cool, makes sense to me!</p>



<a name="405725955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405725955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405725955">(Dec 04 2023 at 02:20)</a>:</h4>
<p><span class="user-mention" data-user-id="586417">@Elias Mulhall</span> can you test on the <code>set-perf</code> branch? See if <code>--optimize</code> still hangs for you.</p>



<a name="405726080"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405726080" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405726080">(Dec 04 2023 at 02:21)</a>:</h4>
<p>Anyway, patched up a handful of improvements in <a href="https://github.com/roc-lang/roc/issues/6176">#6176</a></p>



<a name="405726484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405726484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405726484">(Dec 04 2023 at 02:24)</a>:</h4>
<p>Also, I wonder if the full performant impl of <code>absl::flat_hash_set</code> might actually be faster than regular lists. The main feature we are missing currently is groups. Groups enable it such that a chunk of the hash can be compared for 8 indices at once. So it might do 1 hash and 1 comparison to avoid up to 8 calls to <code>==</code>. That said it still has the rest of the extra conditionals and overhead.</p>



<a name="405726608"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405726608" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405726608">(Dec 04 2023 at 02:25)</a>:</h4>
<p>Now that we have <code>popCount</code> as a builtin, I should revisit implementing that in roc and perf gains.</p>



<a name="405726673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405726673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405726673">(Dec 04 2023 at 02:26)</a>:</h4>
<p>Should definitly convert this or a similar example to <code>c++</code> with <code>absl::flat_hash_map</code> to see what our real perf diff is.</p>



<a name="405728902"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405728902" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405728902">(Dec 04 2023 at 02:42)</a>:</h4>
<p>that sounds fascinating! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="405731318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405731318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405731318">(Dec 04 2023 at 03:00)</a>:</h4>
<p>As an aside, about small dict impl.</p>
<p>The larger the key is the worse small dict is. Cause large key means an expensive Eq. So it would be a lot faster to do more hash comparisons rather than key comparisons.</p>



<a name="405731401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405731401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405731401">(Dec 04 2023 at 03:00)</a>:</h4>
<p>So probably <code>ListDict</code> is only better with both small size and small key.</p>



<a name="405733758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405733758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405733758">(Dec 04 2023 at 03:18)</a>:</h4>
<p>yeah true, although we do know the size of that statically, so could have a heuristic involving both</p>



<a name="405734044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405734044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405734044">(Dec 04 2023 at 03:20)</a>:</h4>
<p>Sure, if roc exposed that at compile time or you add an extra runtime check</p>



<a name="405744876"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405744876" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405744876">(Dec 04 2023 at 04:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405725955">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="586417">Elias Mulhall</span> can you test on the <code>set-perf</code> branch? See if <code>--optimize</code> still hangs for you.</p>
</blockquote>
<p>Unfortunately it still does! Anything I can do to debug further?</p>



<a name="405745431"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405745431" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405745431">(Dec 04 2023 at 04:59)</a>:</h4>
<p>Oh wait, I lightly modified the code, with the original I can still repro...let me take a look at that specifically.</p>



<a name="405745597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405745597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405745597">(Dec 04 2023 at 05:00)</a>:</h4>
<p>Ah ha, good luck!</p>



<a name="405748274"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405748274" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405748274">(Dec 04 2023 at 05:27)</a>:</h4>
<p>So I'm not sure how easy this will be to make a minimized test case, but this is not a <code>Set</code> bug at all.</p>
<p>It is some sort refcounting/uniqueness failure. The bug is specifically with the <code>newPartNumber</code> variable: <a href="https://gist.github.com/mulias/b07e012ced92406f59cc2548d0f01323#file-2023day03-roc-L66">https://gist.github.com/mulias/b07e012ced92406f59cc2548d0f01323#file-2023day03-roc-L66</a></p>



<a name="405748363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405748363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405748363">(Dec 04 2023 at 05:28)</a>:</h4>
<p>It should always have multiple references which means on this line here it should incur a deep copy:<br>
<a href="https://gist.github.com/mulias/b07e012ced92406f59cc2548d0f01323#file-2023day03-roc-L88">https://gist.github.com/mulias/b07e012ced92406f59cc2548d0f01323#file-2023day03-roc-L88</a></p>



<a name="405748413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405748413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405748413">(Dec 04 2023 at 05:29)</a>:</h4>
<p>That is not happening. As such, we are getting these weird sets that have old data from the last iteration of the loop. Unsurprisingly, missing old data with a new set breaks things.</p>



<a name="405748451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405748451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405748451">(Dec 04 2023 at 05:29)</a>:</h4>
<p>A simple workaround is just to inline the variable uses:<br>
<code>current: { digits: [], indices: Set.empty {} },</code></p>



<a name="405748865"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405748865" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405748865">(Dec 04 2023 at 05:34)</a>:</h4>
<p>Doing a quick scan of the mono ir, it seems that every iteration of <code>Array2d.walk</code> the value is decremented, but it doesn't look to every be incremented. I assume it would get incremented through the closure capture somewhere or something like that, but I don't see it. (definitely might just be missing it)</p>



<a name="405749251"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405749251" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405749251">(Dec 04 2023 at 05:39)</a>:</h4>
<p>actually, it looks like <code>Array2D.walk</code> calls <code>List.walkWithIndex</code> calls<code> List.walkWithIndexHelp</code> which increments the functions refcount. That should mean this all works correctly. Maybe a bug in the actully generated increment or decrement function?</p>



<a name="405757738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405757738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405757738">(Dec 04 2023 at 06:53)</a>:</h4>
<p>So I was able to work around the refcount craziness (was affecting both the list and set version of the code). Fixing that made both versions about 4x faster. So on my machine the list version is now 40ms and the set version 150ms. Both quite respectable times and the flamegraphs now look like they are spending there time mostly doing real work and not too much in refcounts.</p>
<p>All of the time is now essentially set in calculating set overlaps. (again these are small sets neighbors is 8 elements and the digit sets are 1 to 3 elements).</p>
<p>So if we optimize the set overlap calculation to early exist like the list overlap calculation, we get to the point where the set version is slightly more than 2x slower than the list version at about 90ms</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">isOverlapping</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">Set</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Bool</span>
<span class="nv">isOverlapping</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">a</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">Set</span><span class="p">.</span><span class="nx">len</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">Set</span><span class="p">.</span><span class="nx">len</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nx">isOverlapping</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">a</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nx">Set</span><span class="p">.</span><span class="nx">walkUntil</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">Bool</span><span class="p">.</span><span class="nx">false</span><span class="w"> </span><span class="err">\</span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">Set</span><span class="p">.</span><span class="nx">contains</span><span class="w"> </span><span class="nx">b</span><span class="w"> </span><span class="nx">k</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="nx">Break</span><span class="w"> </span><span class="nx">Bool</span><span class="p">.</span><span class="nx">true</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="nx">Continue</span><span class="w"> </span><span class="nx">Bool</span><span class="p">.</span><span class="nx">false</span>
</code></pre></div>



<a name="405758163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405758163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405758163">(Dec 04 2023 at 06:56)</a>:</h4>
<p>Anyway, that is probably enough digging into the perf of all of this.</p>



<a name="405758226"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405758226" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405758226">(Dec 04 2023 at 06:56)</a>:</h4>
<p>I should probably file some issue to track some of this, but I will leave that as an exercise for tomorrow Brendan cause I am currently quite tired.</p>



<a name="405766361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405766361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hannes Nevalainen <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405766361">(Dec 04 2023 at 07:56)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405720196">said</a>:</p>
<blockquote>
<p>what do you think of the "small hashmap optimization" idea?</p>
</blockquote>
<p>FWIW maps on the Beam are just arrays under the hood if size &lt; 32</p>



<a name="405826006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405826006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405826006">(Dec 04 2023 at 13:38)</a>:</h4>
<blockquote>
<p>Anyway, that is probably enough digging into the perf of all of this.</p>
</blockquote>
<p>I would say so, you went much deeper into this than I anticipated! Thanks for all the details, very interesting.</p>



<a name="405851094"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405851094" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405851094">(Dec 04 2023 at 15:37)</a>:</h4>
<p>Haha. I enjoy digging into performance and such</p>



<a name="405852651"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405852651" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405852651">(Dec 04 2023 at 15:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="630509">Hannes Nevalainen</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405766361">said</a>:</p>
<blockquote>
<p>FWIW maps on the Beam are just arrays under the hood if size &lt; 32</p>
</blockquote>
<p>Do you have a link to info on this? Or source I guess.</p>



<a name="405885705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405885705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405885705">(Dec 04 2023 at 18:11)</a>:</h4>
<blockquote>
<p>So I was able to work around the refcount craziness (was affecting both the list and set version of the code). Fixing that made both versions about 4x faster.</p>
</blockquote>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> I'm not sure I'm following how you did this. Was this a code change or a compiler change?</p>



<a name="405886546"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405886546" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405886546">(Dec 04 2023 at 18:16)</a>:</h4>
<p>Ah sorry, didn't share:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">gearPartNumbers</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">Schematic</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">List</span><span class="w"> </span><span class="p">(</span><span class="nx">PartNumber</span><span class="p">,</span><span class="w"> </span><span class="nx">PartNumber</span><span class="p">)</span>
<span class="nv">gearPartNumbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">schematic</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">partNumbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">allPartNumbers</span><span class="w"> </span><span class="nx">schematic</span>

<span class="w">    </span><span class="nx">Array2D</span><span class="p">.</span><span class="nx">walk</span><span class="w"> </span><span class="nx">schematic</span><span class="w"> </span><span class="p">([],</span><span class="w"> </span><span class="nx">partNumbers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">direction</span><span class="o">:</span><span class="w"> </span><span class="nx">Forwards</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="err">\</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">pns</span><span class="p">),</span><span class="w"> </span><span class="nx">elem</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="nx">elem</span><span class="w"> </span><span class="o">is</span>
<span class="w">            </span><span class="nb">Symbol</span><span class="w"> </span><span class="s">'*'</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">elemNeighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">neighbors</span><span class="w"> </span><span class="nx">index</span>
<span class="w">                </span><span class="nv">neighboringPartNumbers</span><span class="w"> </span><span class="o">=</span>
<span class="w">                    </span><span class="nx">List</span><span class="p">.</span><span class="nx">keepIf</span><span class="w"> </span><span class="nx">pns</span><span class="w"> </span><span class="err">\</span><span class="nx">partNumber</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                        </span><span class="nx">isOverlapping</span><span class="w"> </span><span class="nx">partNumber</span><span class="p">.</span><span class="nx">indices</span><span class="w"> </span><span class="nx">elemNeighbors</span>

<span class="w">                </span><span class="k">when</span><span class="w"> </span><span class="nx">neighboringPartNumbers</span><span class="w"> </span><span class="o">is</span>
<span class="w">                    </span><span class="p">[</span><span class="nx">pn1</span><span class="p">,</span><span class="w"> </span><span class="nx">pn2</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">List</span><span class="p">.</span><span class="nx">append</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="p">(</span><span class="nx">pn1</span><span class="p">,</span><span class="w"> </span><span class="nx">pn2</span><span class="p">),</span><span class="w"> </span><span class="nx">pns</span><span class="p">)</span>
<span class="w">                    </span><span class="nx">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">pns</span><span class="p">)</span>

<span class="w">            </span><span class="nx">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">pns</span><span class="p">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="p">.</span><span class="mi">0</span>
</code></pre></div>
<p>Same can be done to the list version</p>



<a name="405887140"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405887140" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405887140">(Dec 04 2023 at 18:20)</a>:</h4>
<p>I think if <code>partNumbers</code> is a capture of the closure we aren't smart about refcounts and recursively increment the refcounts of everything contained in <code>partNumbers</code>.</p>
<p>If we pass it in instead, we realize that we don't need to recursively increment hte refcount based on how it is being used and instead just increment the outer list refcount. That is at least my guess.</p>



<a name="405887285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405887285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405887285">(Dec 04 2023 at 18:21)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> or <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> does that sound plausible? If so, is there an actionable bug I can file?</p>



<a name="405937690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405937690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405937690">(Dec 05 2023 at 00:16)</a>:</h4>
<blockquote>
<p>If we pass it in instead, we realize that we don't need to recursively increment hte refcount based on how it is being used and instead just increment the outer list refcount. That is at least my guess.</p>
</blockquote>
<p>Can you elaborate what you mean by this? I don't follow</p>



<a name="405938773"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405938773" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405938773">(Dec 05 2023 at 00:24)</a>:</h4>
<p>This is the original code</p>
<div class="codehilite"><pre><span></span><code>gearPartNumbers : Schematic, List PartNumber -&gt; List (PartNumber, PartNumber)
gearPartNumbers = \schematic, partNumbers -&gt;
    Array2D.walk schematic [] { direction: Forwards } \state, elem, index -&gt;
        when elem is
            Symbol &#39;*&#39; -&gt;
                adjacentPartNumbers =
                    List.keepIf partNumbers \partNumber -&gt;
                        anyAdjacent partNumber.indices [index]

                when adjacentPartNumbers is
                    [pn1, pn2] -&gt; List.append state (pn1, pn2)
                    _ -&gt; state

            _ -&gt; state
</code></pre></div>
<p>This code is faster because it seems to eliminate ref counts on <code>partNumbers</code></p>
<div class="codehilite"><pre><span></span><code>gearPartNumbers : Schematic, List PartNumber -&gt; List (PartNumber, PartNumber)
gearPartNumbers = \schematic, partNumbers -&gt;
    Array2D.walk schematic ([], partNumbers) { direction: Forwards } \(state, pns), elem, index -&gt;
        when elem is
            Symbol &#39;*&#39; -&gt;
                adjacentPartNumbers =
                    List.keepIf pns \partNumber -&gt;
                        anyAdjacent partNumber.indices [index]

                when adjacentPartNumbers is
                    [pn1, pn2] -&gt; (List.append state (pn1, pn2), pns)
                    _ -&gt; (state, pns)

            _ -&gt; (state, pns)
    |&gt; .0
</code></pre></div>



<a name="405938940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405938940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405938940">(Dec 05 2023 at 00:25)</a>:</h4>
<p><del>we realize that we don't need to recursively increment hte refcount based on how it is being used and instead just increment the outer list refcount.</del></p>
<p>So that comment turned out to be wrong. I thought we had an optimization that enable sometimes just incrementing a list outer refcount instead of incrementing it recursively, but even if we do, it doesn't apply here.</p>
<hr>
<h3>A more correct analysis</h3>
<p>In the original version <code>partNumbers</code> is a closure capture. On every iteration of <code>Array2D.walk</code>, we would recursively increment the closure captures and spend a lot of time incrementing refcounts in <code>partNumbers</code>. On top of that, at the end of the function, we would recursively decrement the refcount. Overall just eating tons of times with refcounting.</p>
<p>If we explicitly make <code>partNumbers</code> part of the state, this goes away. Most of the time, <code>pn</code> is just passed through without getting used. This means its refcount is never incremented or decremented. The only time we have to deal with refcounts of <code>pn</code> in the new version of the code is when the symbol is <code>*</code>. In that case, the refcount of <code>pn</code> is recursively incremented. So this is just way way less refcount fiddling overall. Turned out to not be a fancy optimization, just hugely cutting how often we have to deal with this.</p>
<p>Summary: recursive refcount increments/decrements can be super brutal. I wonder if there is a better way to deal with a case like this.</p>



<a name="405939207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405939207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405939207">(Dec 05 2023 at 00:27)</a>:</h4>
<p>Looking at the IR to confirm...</p>



<a name="405939715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405939715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405939715">(Dec 05 2023 at 00:31)</a>:</h4>
<p>Here's an updated gist if that helps <a href="https://gist.github.com/mulias/3e7fb28d934736155028d5e85c9bb3ca">https://gist.github.com/mulias/3e7fb28d934736155028d5e85c9bb3ca</a><br>
One of the versions of the function is commented out</p>



<a name="405942201"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405942201" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405942201">(Dec 05 2023 at 00:47)</a>:</h4>
<p>Hmm yeah your analysis sounds right to me Brendan</p>



<a name="405942344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405942344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405942344">(Dec 05 2023 at 00:48)</a>:</h4>
<p>It's not totally clear to me why in the first case the capture is seen as borrowed, and in the second case it isn't though</p>



<a name="405942410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405942410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405942410">(Dec 05 2023 at 00:48)</a>:</h4>
<p>The thing is that on the surface, the capture is seen as owned, until <code>array2d.Array2D.iterate</code> is hit</p>



<a name="405942754"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405942754" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405942754">(Dec 05 2023 at 00:50)</a>:</h4>
<p>And then we have</p>
<div class="codehilite"><pre><span></span><code># SLOW
procedure : `array2d.Array2D.iterate` List {{List U8, List {U64, U64}}, {List U8, List {U64, U64}}}
procedure = `array2d.Array2D.iterate` (`#Derived_gen.IdentId(86)`: {List [C , C U8, C U8], {U64, U64}}, `#Derived_gen.IdentId(87)`: {U64, U64}, `#Derived_gen.IdentId(88)`:
List {{List U8, List {U64, U64}}, {List U8, List {U64, U64}}}, `#Derived_gen.IdentId(89)`: {}, `#Derived_gen.IdentId(90)`: List {List U8, List {U64, U64}}):
    joinpoint `array2d.Array2D.770` `array2d.Array2D.array` `array2d.Array2D.index` `array2d.Array2D.state` `array2d.Array2D.nextIndexFn` `array2d.Array2D.nextStateFn`:
        inc `array2d.Array2D.array`;
        let `array2d.Array2D.771` : [C {}, C [C , C U8, C U8]] = CallByName `array2d.Array2D.get` `array2d.Array2D.array` `array2d.Array2D.index`;
        let `array2d.Array2D.791` : U8 = 1i64;
        let `array2d.Array2D.792` : U8 = GetTagId `array2d.Array2D.771`;
        let `array2d.Array2D.793` : Int1 = lowlevel Eq `array2d.Array2D.791` `array2d.Array2D.792`;
        if `array2d.Array2D.793` then
            inc `array2d.Array2D.array`;
            let `array2d.Array2D.elem` : [C , C U8, C U8] = UnionAtIndex (Id 1) (Index 0) `array2d.Array2D.771`;
            let `array2d.Array2D.788` : [C {}, C {U64, U64}] = CallByName `array2d.Array2D.decY` `array2d.Array2D.array` `array2d.Array2D.index`;
            inc `array2d.Array2D.nextStateFn`; &lt;&lt;&lt;&lt;&lt; THIS is the INC
            let `array2d.Array2D.789` : [C List {{List U8, List {U64, U64}}, {List U8, List {U64, U64}}}, C List {{List U8, List {U64, U64}}, {List U8, List {U64, U64}}}] = CallByName `array2d.Array2D.200` `array2d.Array2D.state` `array2d.Array2D.elem` `array2d.Array2D.index` `array2d.Array2D.nextStateFn`;
</code></pre></div>
<div class="codehilite"><pre><span></span><code># FAST
procedure : `array2d.Array2D.iterate` {List {List U8, List {U64, U64}}, {List U8, List {U64, U64}}}
procedure = `array2d.Array2D.iterate` (`#Derived_gen.IdentId(48)`: {List [C , C U8, C U8], {U64, U64}}, `#Derived_gen.IdentId(49)`: {U64, U64}, `#Derived_gen.IdentId(50)`:
{List {List U8, List {U64, U64}}, {List U8, List {U64, U64}}}, `#Derived_gen.IdentId(51)`: {}, `#Derived_gen.IdentId(52)`: {}):
    joinpoint `array2d.Array2D.1039` `array2d.Array2D.array` `array2d.Array2D.index` `array2d.Array2D.state` `array2d.Array2D.nextIndexFn` `array2d.Array2D.nextStateFn`:
        inc `array2d.Array2D.array`;
        let `array2d.Array2D.1040` : [C {}, C [C , C U8, C U8]] = CallByName `array2d.Array2D.get` `array2d.Array2D.array` `array2d.Array2D.index`;
        let `array2d.Array2D.1060` : U8 = 1i64;
        let `array2d.Array2D.1061` : U8 = GetTagId `array2d.Array2D.1040`;
        let `array2d.Array2D.1062` : Int1 = lowlevel Eq `array2d.Array2D.1060` `array2d.Array2D.1061`;
        if `array2d.Array2D.1062` then
            inc `array2d.Array2D.array`;
            let `array2d.Array2D.elem` : [C , C U8, C U8] = UnionAtIndex (Id 1) (Index 0) `array2d.Array2D.1040`;
            let `array2d.Array2D.1057` : [C {}, C {U64, U64}] = CallByName `array2d.Array2D.incX` `array2d.Array2D.array` `array2d.Array2D.index`;
            let `array2d.Array2D.1058` : [C {List {List U8, List {U64, U64}}, {List U8, List {U64, U64}}}, C {List {List U8, List {U64, U64}}, {List U8, List {U64, U64}}}] = CallByName `array2d.Array2D.200` `array2d.Array2D.state` `array2d.Array2D.elem` `array2d.Array2D.index` `array2d.Array2D.nextStateFn`;
</code></pre></div>



<a name="405943004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405943004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405943004">(Dec 05 2023 at 00:52)</a>:</h4>
<p>In the fast example, the closure has no captures, so the <code>inc</code> is elided? It would just be a call to a no-op?</p>



<a name="405943009"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405943009" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405943009">(Dec 05 2023 at 00:52)</a>:</h4>
<p>So I'm not really sure why we're seeing it as borrowed in one case and not the other. Maybe the fact that the capture parameter passes out specializes it? But I would expect that it's seen as irrelevant in the first (capturing) case for sure, especially because it unwraps transparently to an extra List parameter</p>



<a name="405943069"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405943069" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405943069">(Dec 05 2023 at 00:52)</a>:</h4>
<p>Maybe <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> has an idea</p>



<a name="405943117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405943117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405943117">(Dec 05 2023 at 00:52)</a>:</h4>
<p>Well, but it would <code>inc</code> on something right? Like presumably the outer capture is passed in some way to <code>iterate</code></p>



<a name="405943136"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405943136" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405943136">(Dec 05 2023 at 00:53)</a>:</h4>
<p>But that seems to be missing</p>



<a name="405943167"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405943167" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405943167">(Dec 05 2023 at 00:53)</a>:</h4>
<p>Although I haven't looked at the iterate implementation so I could be off</p>



<a name="405943234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405943234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405943234">(Dec 05 2023 at 00:53)</a>:</h4>
<p>It is pretty direct and just recursive: <a href="https://github.com/mulias/roc-array2d/blob/951b2a7ae561de88bf185bb61e26244dc9f5d508/package/Array2D.roc#L894-L906">https://github.com/mulias/roc-array2d/blob/951b2a7ae561de88bf185bb61e26244dc9f5d508/package/Array2D.roc#L894-L906</a></p>



<a name="405945303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405945303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405945303">(Dec 05 2023 at 01:05)</a>:</h4>
<p>The IR looks weird to me for a different (and probably unrelated) reason -- <code>Array2D.walk</code> with default params should just be a wrapper for <code>List.walkWithIndex</code>, the <code>iterate</code> function shouldn't get involved unless you're walking in a different order <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span>.</p>



<a name="405945806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405945806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405945806">(Dec 05 2023 at 01:08)</a>:</h4>
<p>Oh wait, that may be exactly why it change to borrowing instead of owning</p>



<a name="405945856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405945856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405945856">(Dec 05 2023 at 01:08)</a>:</h4>
<p>Maybe in this dispatch function where there are two paths, we mess something up and switch from owning to borrowing?</p>
<p><a href="https://github.com/mulias/roc-array2d/blob/951b2a7ae561de88bf185bb61e26244dc9f5d508/package/Array2D.roc#L415C1-L426C43">https://github.com/mulias/roc-array2d/blob/951b2a7ae561de88bf185bb61e26244dc9f5d508/package/Array2D.roc#L415C1-L426C43</a></p>



<a name="405945946"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405945946" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405945946">(Dec 05 2023 at 01:09)</a>:</h4>
<p>Or maybe it is related to putting the closure in another closure?</p>
<div class="codehilite"><pre><span></span><code>\state, elem, listIndex -&gt;
            fn state elem (arrayIndexOf listIndex arrayShape)
</code></pre></div>



<a name="405945953"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405945953" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405945953">(Dec 05 2023 at 01:09)</a>:</h4>
<p>Just guesses</p>



<a name="405946496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/405946496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#405946496">(Dec 05 2023 at 01:12)</a>:</h4>
<p>Maybe we should try to trim this down to just a simple list version and see if we can still repro.</p>



<a name="406010497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406010497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hannes Nevalainen <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406010497">(Dec 05 2023 at 09:19)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405852651">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="630509">Hannes Nevalainen</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/405766361">said</a>:</p>
<blockquote>
<p>FWIW maps on the Beam are just arrays under the hood if size &lt; 32</p>
</blockquote>
<p>Do you have a link to info on this? Or source I guess.</p>
</blockquote>
<p>It is apparently a "hash array mapped trie" for 32 entries or less. I don't really know more than that :) here are some links</p>
<p><a href="https://twitter.com/akoutmos/status/1266034402422853633">https://twitter.com/akoutmos/status/1266034402422853633</a><br>
<a href="https://github.com/erlang/otp/blob/master/erts/emulator/beam/erl_map.h#L72-L76">https://github.com/erlang/otp/blob/master/erts/emulator/beam/erl_map.h#L72-L76</a><br>
<a href="https://github.com/erlang/otp/blob/master/erts/emulator/beam/erl_map.c#L264-L268">https://github.com/erlang/otp/blob/master/erts/emulator/beam/erl_map.c#L264-L268</a><br>
<a href="https://elixirforum.com/t/big-maps-versus-small-maps-performance/31909">https://elixirforum.com/t/big-maps-versus-small-maps-performance/31909</a></p>



<a name="406104666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406104666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406104666">(Dec 05 2023 at 16:56)</a>:</h4>
<p>Thanks!</p>



<a name="406105425"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406105425" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406105425">(Dec 05 2023 at 17:00)</a>:</h4>
<blockquote>
<p>Maybe we should try to trim this down to just a simple list version and see if we can still repro.</p>
</blockquote>
<p>I don't have a small repro currently, but I am pretty sure I hit this again when working on the implementation details of Dict. I have a hot loop with a <code>.walk</code> function in it that happens to capture a list. 45% of the hot loop execution time is spent on refcounting that really shouldn't be needed (I'll probably have to manually inline this for perf reasons).  To my understanding, the core issue is that we really need to do inlIning before inserting refcounts. LLVM is inlining the lambda, but it still has a capture with a refcount inc before the lambda and a refcount dec in the lambda.</p>



<a name="406106262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406106262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406106262">(Dec 05 2023 at 17:03)</a>:</h4>
<p>I would guess a minimal repro will just be something simple like:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1"># Some large list of refcounted things, assume list of sets</span>
<span class="nv">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1"># Some other list to walk, lets assume it has indices into x</span>
<span class="nx">List</span><span class="p">.</span><span class="nx">walk</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="err">\</span><span class="nx">count</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="nx">List</span><span class="p">.</span><span class="nx">get</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">is</span>
<span class="w">        </span><span class="nx">Ok</span><span class="w"> </span><span class="nx">set</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nx">count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="nx">Set</span><span class="p">.</span><span class="nx">len</span><span class="w"> </span><span class="nx">set</span><span class="p">)</span>
<span class="w">        </span><span class="nx">Err</span><span class="w"> </span><span class="nx">OutOfBounds</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nx">count</span>
</code></pre></div>



<a name="406106545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406106545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406106545">(Dec 05 2023 at 17:04)</a>:</h4>
<p>Assuming I have this right, this will just thrash the refcounts of all elements in x.</p>



<a name="406179346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406179346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406179346">(Dec 05 2023 at 23:53)</a>:</h4>
<p>I am still diving down the trail of dictionary perf improvements and I found something interesting. <code>listGetUnsafe</code> is supposed to borrow it's input. This means that no refcount changes are required to call the function.</p>
<p>This does not look to be working correctly in my dictionary code. I see lots of cases like this:</p>
<div class="codehilite"><pre><span></span><code>inc `Dict.metadata`;
let `Dict.group` : U64 = CallByName `Dict.listGetUnsafe` `Dict.metadata` `Dict.slotIndex`;
</code></pre></div>
<p>If I follow that link through, I find:</p>
<div class="codehilite"><pre><span></span><code>procedure : `Dict.listGetUnsafe` {U32, {}}
procedure = `Dict.listGetUnsafe` (`#Attr.#arg1`: List {U32, {}}, `#Attr.#arg2`: U64):
    let `Dict.960` : {U32, {}} = lowlevel ListGetUnsafe `#Attr.#arg1` `#Attr.#arg2`;
    dec `#Attr.#arg1`;
    ret `Dict.960`;
</code></pre></div>
<p>Even thouhg the lowlevel does not require changing the refcount, we are wrapping it in a function call and that function apparently requires changing the refcount. So this is defeating the whole point of the lowlevel not needing to change the refcount</p>



<a name="406179393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406179393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406179393">(Dec 05 2023 at 23:53)</a>:</h4>
<p>Any ideas how to fix this?</p>



<a name="406179538"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406179538" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406179538">(Dec 05 2023 at 23:54)</a>:</h4>
<p>The same thing does not happen to <code>List.getUnsafe</code>:</p>
<div class="codehilite"><pre><span></span><code>procedure : `List.getUnsafe` U64
procedure = `List.getUnsafe` (`#Attr.#arg1`: List U64, `#Attr.#arg2`: U64):
    let `List.612` : U64 = lowlevel ListGetUnsafe `#Attr.#arg1` `#Attr.#arg2`;
    ret `List.612`;
</code></pre></div>



<a name="406181999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406181999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406181999">(Dec 06 2023 at 00:14)</a>:</h4>
<p>Oh, I figured out the missing piece. Refcounts gone!!!</p>



<a name="406186087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406186087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406186087">(Dec 06 2023 at 00:45)</a>:</h4>
<p>Also, I am so thankful for drop specialization...it is removing refcounts for me as well</p>



<a name="406186331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406186331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406186331">(Dec 06 2023 at 00:46)</a>:</h4>
<p>Now I just want closures to be able to borrow instead of own captures such that they can avoid refcounting.</p>



<a name="406227968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406227968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406227968">(Dec 06 2023 at 05:23)</a>:</h4>
<p>So ummm.....Dictionaries with refcounted keys are problematic:</p>
<p><a href="/user_uploads/22008/O4E6mKlUPalHIiNmVZ6YLPt_/Screenshot-2023-12-05-at-9.22.17PM.png">Screenshot-2023-12-05-at-9.22.17PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/O4E6mKlUPalHIiNmVZ6YLPt_/Screenshot-2023-12-05-at-9.22.17PM.png" title="Screenshot-2023-12-05-at-9.22.17PM.png"><img src="/user_uploads/22008/O4E6mKlUPalHIiNmVZ6YLPt_/Screenshot-2023-12-05-at-9.22.17PM.png"></a></div>



<a name="406228112"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406228112" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406228112">(Dec 06 2023 at 05:25)</a>:</h4>
<p>The purple is refcounting. It is 80% of the execution time. The other 20% of the execution time is splitting a gigantic string.</p>
<p>So ~100% of the execution time spent in dictionary related functions is spent on recursive refcount increments and decrements.</p>



<a name="406228341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406228341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406228341">(Dec 06 2023 at 05:27)</a>:</h4>
<p>I thought morphic was supposed to enable a function like <code>Dict.get</code> to simply "borrow" it's input since we can statically guarantee it is never modified, only read. As such, we would elide all of this refcounting madness. Is that not the case? Is this an optimization we can add?</p>



<a name="406289068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406289068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406289068">(Dec 06 2023 at 11:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/406186331">said</a>:</p>
<blockquote>
<p>Now I just want closures to be able to borrow instead of own captures such that they can avoid refcounting.</p>
</blockquote>
<p><span class="user-mention" data-user-id="281543">@Folkert de Vries</span> any thoughts or info on this? I don't really know what's possible here <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="406289215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406289215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406289215">(Dec 06 2023 at 11:53)</a>:</h4>
<p>this is not a morphic thing at all</p>



<a name="406289319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406289319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406289319">(Dec 06 2023 at 11:53)</a>:</h4>
<p>the refcounting approach is now to always own values, and push RC updates into the called function. That is optimal for in-place mutation, because borrowed values can never be mutated</p>



<a name="406289501"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406289501" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406289501">(Dec 06 2023 at 11:54)</a>:</h4>
<p>inferring borrowing is hard, and it's harder to bound the amount of code duplication for owned/borrowed arguments</p>



<a name="406289552"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406289552" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406289552">(Dec 06 2023 at 11:55)</a>:</h4>
<p>e.g. what if you have multiple arguments, they can all be owned or borrowed, this cascades</p>



<a name="406294129"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406294129" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406294129">(Dec 06 2023 at 12:26)</a>:</h4>
<p>I wonder about that last part in practice <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="406294259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406294259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406294259">(Dec 06 2023 at 12:26)</a>:</h4>
<p>like certainly it's possible to imagine that blowing up, but that doesn't necessarily mean it would in practice (after all, the same is true of monomorphization in general!)</p>



<a name="406298193"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406298193" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406298193">(Dec 06 2023 at 12:51)</a>:</h4>
<p>you would now do it twice though</p>



<a name="406298239"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406298239" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406298239">(Dec 06 2023 at 12:51)</a>:</h4>
<p>but to be clear, this is not some technical limitation, it's a tradeoff</p>



<a name="406298605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406298605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406298605">(Dec 06 2023 at 12:54)</a>:</h4>
<p>the core problem is that you don't know at any particular point whether to own or borrow: borrowing saves RC manipulation, but disallows mutation. In the middle of a call chain you don't know which is best. Even in most functions it's tricky to know whether being able to mutate is useful.</p>
<p>there is another problem here which is that with borrowing, in recursive functions, you may run into big spikes in memory use, because all the memory is borrowed and only released when all of those recursive functions return</p>



<a name="406298683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406298683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406298683">(Dec 06 2023 at 12:54)</a>:</h4>
<p>all of that is to say: you have to be careful with borrowing. If you can figure out a good heuristic then there should be no problem technically, but finding that heuristic is not trivial</p>



<a name="406308419"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406308419" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406308419">(Dec 06 2023 at 13:47)</a>:</h4>
<p>I wonder how we might go about trying to figure out what a good heuristic might be <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="406308975"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406308975" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406308975">(Dec 06 2023 at 13:49)</a>:</h4>
<p>now that we've run into concrete performance problems of the form "almost all this program does is increment and decrement refcounts, and then it does a bit of work which isn't that" it's probably worth starting to discuss things we might want to try <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="406328763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406328763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406328763">(Dec 06 2023 at 15:23)</a>:</h4>
<p>So we have builtins that borrow things because they are read only, like <code>List.getUnsafe</code>. my wrong understanding was that if a function only called borrowing builtins, it would also just borrow the value. So it would kinda propagate out from those builtins.</p>



<a name="406328912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406328912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406328912">(Dec 06 2023 at 15:24)</a>:</h4>
<p>That would fix this specific problem</p>



<a name="406329272"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406329272" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406329272">(Dec 06 2023 at 15:25)</a>:</h4>
<p>it seems like for that scenario, there would be no risk of a blowup, right?</p>



<a name="406329286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406329286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406329286">(Dec 06 2023 at 15:25)</a>:</h4>
<p>But would add the delayed freeing of memory in recursive functions like mentioned by folkert. (Though not sure how realistic of a problem this is in practice)</p>



<a name="406329438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406329438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406329438">(Dec 06 2023 at 15:26)</a>:</h4>
<p>"if this function argument is only ever passed to things that borrow, then it too can be borrowed"</p>



<a name="406329535"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406329535" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406329535">(Dec 06 2023 at 15:26)</a>:</h4>
<p>I'm more worried about the overhead of reference counting than the delaying of freed memory</p>



<a name="406329782"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406329782" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406329782">(Dec 06 2023 at 15:28)</a>:</h4>
<p>I agree.</p>



<a name="406330194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406330194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406330194">(Dec 06 2023 at 15:29)</a>:</h4>
<p>Also, I swear that at some point we talked about the idea of enabling just refcounting the outer list instead of recursively refcounting all elements in some cases. If we could do that here, it also would alleviate the issue. Though, I don't recall the context in which we thought a change like this might work.</p>



<a name="406332973"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406332973" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406332973">(Dec 06 2023 at 15:42)</a>:</h4>
<p>oh yeah we should totally change how lists do RC</p>



<a name="406337369"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406337369" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406337369">(Dec 06 2023 at 16:03)</a>:</h4>
<p>Do we have concrete ideas for that or is this a case where we need more research projects like Morphic?</p>



<a name="406569289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406569289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406569289">(Dec 07 2023 at 15:41)</a>:</h4>
<p>Looping back to the idea of borrowing an input to a function if all uses in the function also borrow the input, is that something we could just append onto the type checker? Like for each value we want to know both the type and a bit flag of whether or not the value is potentially dirty. Any call in a sub branch would make an entire body dirty. Of course there would need to be some custom propagation logic at function boundaries.</p>
<p>Would that make sense and be something realitively small cost to add onto the type checker? Should it go somewhere else? Is it just a bad idea overall? Any other suggestions on solution?</p>



<a name="406593079"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406593079" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406593079">(Dec 07 2023 at 17:52)</a>:</h4>
<p>I was talking to <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> about this the other day and he mentioned that doing the analysis on mono instead of during type checking would have various benefits</p>



<a name="406632430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406632430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406632430">(Dec 07 2023 at 22:38)</a>:</h4>
<p>well the main benefit is that you can reason about higher-order functions</p>



<a name="406632447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406632447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406632447">(Dec 07 2023 at 22:38)</a>:</h4>
<p>(with lambda sets, at least)</p>



<a name="406633137"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406633137" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406633137">(Dec 07 2023 at 22:44)</a>:</h4>
<p>Ah, then you could analyze closure captures and do something smarter?</p>



<a name="406643767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406643767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406643767">(Dec 08 2023 at 00:19)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> is this something you'd be interested in getting into in terms of compiler development? (With guidance of course!)</p>



<a name="406644370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406644370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406644370">(Dec 08 2023 at 00:24)</a>:</h4>
<p>Well, I do want dict to run fast and this will be fundamental to getting it closer to c++ speeds. So for sure.</p>
<p>Also, I think it will be helpful for me to understand more deeply. I have some vague performance ideas, but many I am not sure could work in roc without really expensive analysis.</p>



<a name="406645763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406645763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406645763">(Dec 08 2023 at 00:35)</a>:</h4>
<p>that would be amazing! <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> are you currently the only person with domain expertise in this? Or does anyone else know how it works/how to implement things to try?</p>



<a name="406650708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406650708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406650708">(Dec 08 2023 at 01:10)</a>:</h4>
<blockquote>
<p>onto the type checker? Should it go somewhere else?</p>
</blockquote>
<p>Doing it in the typechecker has other problems too, namely that you lose all specialization and are bound to the virality of unification. Really you want this over the SSA form.</p>



<a name="406651260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406651260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406651260">(Dec 08 2023 at 01:14)</a>:</h4>
<p>also it slows down <code>roc check</code> unnecessarily</p>



<a name="406651271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406651271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406651271">(Dec 08 2023 at 01:14)</a>:</h4>
<p>(and therefore editor integrations)</p>



<a name="406652934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406652934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406652934">(Dec 08 2023 at 01:27)</a>:</h4>
<p>also, I guess if we want to do this for closure captures as well, we need to check that the closure capture is essentially never saved and is just directly called or something of that nature. Think of <code>List.map</code> and <code>List.walk</code> closures that may capture values. Would suck if List.walk capturing a refcounted value and then just using it in a borrowed manner had bad perf compared passing in the value as part of the state.</p>



<a name="406653024"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653024" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653024">(Dec 08 2023 at 01:28)</a>:</h4>
<p>Cause if the closure capture is saved, it actually does need to make sure the value isn't freed.</p>



<a name="406653160"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653160" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653160">(Dec 08 2023 at 01:29)</a>:</h4>
<p>At the level of the type-specialized IR closure captures are identical to normal parameters</p>



<a name="406653240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653240">(Dec 08 2023 at 01:30)</a>:</h4>
<p>So I guess I'm not sure why they have to be treated specially</p>



<a name="406653300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653300">(Dec 08 2023 at 01:30)</a>:</h4>
<p>Wait, really. But captures can live for a long long time while regular params only live for the body of the function.</p>



<a name="406653414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653414">(Dec 08 2023 at 01:31)</a>:</h4>
<p>How can the captures outlive the body of the function? Only if they're returned right? But that's the same as for the case of regular parameters</p>



<a name="406653526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653526">(Dec 08 2023 at 01:32)</a>:</h4>
<p>After type specialization of lambda sets, all closures are unboxed and their captures are passed as an extra (unboxed) parameter</p>



<a name="406653552"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653552" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653552">(Dec 08 2023 at 01:32)</a>:</h4>
<p>yeah, I just realized that as I was trying to write out an example. So it can be borrowed if it is only used in a borrowing way and never possibly returned from the function. With those rules, I think it is the same for captures and params</p>



<a name="406653562"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406653562" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406653562">(Dec 08 2023 at 01:32)</a>:</h4>
<p>Right</p>



<a name="406661819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406661819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406661819">(Dec 08 2023 at 02:45)</a>:</h4>
<p>A note on the cost of this refcounting. I ported some hashmap benchmarks form C++ to roc. The test we are closest to C++ in perf (about 2x slower) is the insert remove bench. Important part about insert and remove, due to mutating the dictionary, they just take ownership of it and never need to touch the refcount.</p>



<a name="406661918"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406661918" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406661918">(Dec 08 2023 at 02:46)</a>:</h4>
<p>Still slower than I would hope, but it is a lot better than the 4x of some other cases.</p>



<a name="406702991"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406702991" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406702991">(Dec 08 2023 at 07:35)</a>:</h4>
<p>I have only ported 1 benchmark so far, but I am a bit surprised. Decided to test out go just for the fun of it. In the test of insert 100million keys, clear the dict, insert 100 million keys again, finally delete 100 million keys 1 by 1: golang is 4.5x slower than the current version of roc.</p>
<p>Go spends a heck of a lot of system time. I wonder if it is doing something weird with memory that is just eating tons of kernel time.</p>
<p>Definitely will have to port a few more benchmarks and compare at some point.</p>



<a name="406703436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406703436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406703436">(Dec 08 2023 at 07:37)</a>:</h4>
<p>We also use about 2x less memory, which makes sense cause Roc cleans up memory immediately instead of lazily</p>



<a name="406733279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406733279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406733279">(Dec 08 2023 at 10:48)</a>:</h4>
<p>I think lobster lang infers borrowing/owning arguments or something, cant really remember. I remember the creator being asked about code blowup. Maybe relevant?</p>



<a name="406743522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406743522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406743522">(Dec 08 2023 at 11:54)</a>:</h4>
<p>wait so what does that means in terms of comparing Go to C++ on these particular benchmarks? Go is 10x slower?</p>



<a name="406768397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406768397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406768397">(Dec 08 2023 at 14:18)</a>:</h4>
<p>I love that all this started with me thinking that creating thousands of small sets would be a performant way to solve a problem, then complaining when that wasn't the case. Really enjoying fallowing this thread.</p>



<a name="406781109"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406781109" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406781109">(Dec 08 2023 at 15:24)</a>:</h4>
<p>I may have an addiction</p>



<a name="406781295"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406781295" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406781295">(Dec 08 2023 at 15:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/406743522">said</a>:</p>
<blockquote>
<p>wait so what does that means in terms of comparing Go to C++ on these particular benchmarks? Go is 10x slower?</p>
</blockquote>
<p>Yep.</p>



<a name="406781562"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406781562" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406781562">(Dec 08 2023 at 15:27)</a>:</h4>
<p>That said, something still feels wrong to me about that giant perf difference, need to dig in more.</p>



<a name="406783699"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406783699" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406783699">(Dec 08 2023 at 15:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/406781109">said</a>:</p>
<blockquote>
<p>I may have an addiction</p>
</blockquote>
<p><a href="/user_uploads/22008/CEwIWtZqJO8x8U9JlynXnBrF/gottagofast.webp">gottagofast.webp</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/CEwIWtZqJO8x8U9JlynXnBrF/gottagofast.webp" title="gottagofast.webp"><img src="/user_uploads/22008/CEwIWtZqJO8x8U9JlynXnBrF/gottagofast.webp"></a></div>



<a name="406804412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406804412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406804412">(Dec 08 2023 at 17:15)</a>:</h4>
<p>Looking into the go hash impl, I was reminded that go does not have custom equality or custom hash (maybe has changed with the new generics?) And instead always used an autoderive impl with maps. On top of that, maps don't implement hash or equality (and they have no set type)</p>



<a name="406805004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406805004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406805004">(Dec 08 2023 at 17:18)</a>:</h4>
<p>My guess as to why go maps are slow in one picture. The key is the bottom right corner.</p>
<p><a href="/user_uploads/22008/Gjor7gvLt8UQj-Umcl6PN058/164cba0e-0cf4-4d49-850d-029e37a0acf0.jpg">164cba0e-0cf4-4d49-850d-029e37a0acf0.jpg</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/Gjor7gvLt8UQj-Umcl6PN058/164cba0e-0cf4-4d49-850d-029e37a0acf0.jpg" title="164cba0e-0cf4-4d49-850d-029e37a0acf0.jpg"><img src="/user_uploads/22008/Gjor7gvLt8UQj-Umcl6PN058/164cba0e-0cf4-4d49-850d-029e37a0acf0.jpg"></a></div><p>Honestly, there design is fine, but it is not totally flat. As such, in the case a bucket overflows instead of place elements in a calculated different bucked in the same array, they just allocate a new bucket on the heap. So it is kinda like in between flat and traditional cause a bucket contains 8 elements and overflow <em>should</em> be rare.</p>



<a name="406805334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406805334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406805334">(Dec 08 2023 at 17:20)</a>:</h4>
<p>I'm guessing the benchmark led to lots of random heap jumps.</p>



<a name="406805896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406805896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406805896">(Dec 08 2023 at 17:23)</a>:</h4>
<p>Also, never realized that all the generics in the go runtime are implemented c style. To call map.get, the runtime passes in a map that essentially has void* pointers cause it knows nothing about the data type, and a struct of function pointers that know about the data and how it works.</p>



<a name="406806308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406806308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406806308">(Dec 08 2023 at 17:25)</a>:</h4>
<p>oh I assumed that was how they did it</p>



<a name="406806356"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406806356" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406806356">(Dec 08 2023 at 17:25)</a>:</h4>
<p>monomorphization is very rare among languages with automatic memory management!</p>



<a name="406806542"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406806542" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406806542">(Dec 08 2023 at 17:26)</a>:</h4>
<p>Yeah, but most languages just use runtime type info, right?</p>



<a name="406806993"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406806993" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406806993">(Dec 08 2023 at 17:28)</a>:</h4>
<p>But yeah, summary of go lang hash map is kinda like absl::flat_hash_map, but less flat and with more pointer generic shuffling.</p>
<p>Oh and with metadata in buckets instead of stored densely.</p>



<a name="406807011"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406807011" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406807011">(Dec 08 2023 at 17:29)</a>:</h4>
<p>I think that varies. I don't know for sure but I believe Haskell does it the way Go does</p>



<a name="406808753"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406808753" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406808753">(Dec 08 2023 at 17:39)</a>:</h4>
<p>Interesting go maps after growing migrate to the new map in chunks over multiple calls to insert instead of doing it all at once.</p>



<a name="406808804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406808804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406808804">(Dec 08 2023 at 17:39)</a>:</h4>
<p>So for a bit, it will be two partial maps.</p>



<a name="406808914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406808914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406808914">(Dec 08 2023 at 17:40)</a>:</h4>
<p>Trying to make perf of insert more consistent at the cost of probably more perf over time.</p>



<a name="406809667"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406809667" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406809667">(Dec 08 2023 at 17:45)</a>:</h4>
<p><del>Hmm, sounds like go may have a weird hash function choice too to make it more secure against hash flooding attacks without needing a fallback. Will have to look into that.</del> they used to, now they also just use wyhash.</p>



<a name="406814611"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406814611" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406814611">(Dec 08 2023 at 18:16)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/Set.20perf/near/406808753">said</a>:</p>
<blockquote>
<p>Interesting go maps after growing migrate to the new map in chunks over multiple calls to insert instead of doing it all at once.</p>
</blockquote>
<p>This sounds like <a href="https://github.com/jonhoo/griddle">https://github.com/jonhoo/griddle</a></p>



<a name="406814878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406814878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406814878">(Dec 08 2023 at 18:18)</a>:</h4>
<p>Yep</p>



<a name="406871653"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Set%20perf/near/406871653" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Set.20perf.html#406871653">(Dec 09 2023 at 02:08)</a>:</h4>
<p>Ok. so turns out that go just has horrible perf on arm. On x86, it is actually quite fast. In between roc and c++ for this benchmark</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
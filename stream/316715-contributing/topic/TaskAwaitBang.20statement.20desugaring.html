<html>
<head><meta charset="utf-8"><title>TaskAwaitBang statement desugaring · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html">TaskAwaitBang statement desugaring</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="449124639"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449124639" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449124639">(Jul 04 2024 at 16:16)</a>:</h4>
<p>I played around with the following code and couldn't understand why it didn't work as expected:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="c1">-- unexpected type annotation</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span><span class="w"> </span><span class="p">(</span><span class="kt">Result</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="o">!</span><span class="w"> </span><span class="n">task</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">-- desugared version</span>
<span class="nf">ignoreResultDesugared</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span><span class="w"> </span><span class="p">(</span><span class="kt">Result</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="nf">ignoreResultDesugared</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="w"> </span><span class="n">task</span>

<span class="c1">-- what I expected</span>
<span class="nf">ignoreResultExpected</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="kt">Task</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">*</span>
<span class="nf">ignoreResultExpected</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="nf">\</span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">        </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<p>currently, desugaring works this way:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="c1">-- initial code</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="o">!</span><span class="w"> </span><span class="n">task</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">-- 1. add record destructuring in front of the statement (why not underscore?)</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="p">{}</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="o">!</span><span class="w"> </span><span class="n">task</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">-- 2. unwrap TaskAwaitBang to a Task.await call preserving record destructuring</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="nf">\</span><span class="p">{}</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">        </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">-- 3. drop destructuring because input and output are the same. it's incorrect</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="w"> </span><span class="n">task</span>
</code></pre></div>
<p>what I want to do:</p>
<ol>
<li>use <code>_</code> instead of <code>{}</code> in step 2</li>
<li>remove step <code>3</code></li>
</ol>
<p>Just want to confirm that it's a bug and the fix logic is correct</p>



<a name="449126496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449126496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449126496">(Jul 04 2024 at 16:25)</a>:</h4>
<p>Yeah. That sounds like a bug and correct fix</p>



<a name="449126602"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449126602" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449126602">(Jul 04 2024 at 16:26)</a>:</h4>
<p>going to create a pr soon then</p>



<a name="449128830"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449128830" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449128830">(Jul 04 2024 at 16:40)</a>:</h4>
<p>Oh, one quick thought</p>



<a name="449128938"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449128938" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449128938">(Jul 04 2024 at 16:41)</a>:</h4>
<p><code>result!</code> returns data, so maybe we intentionally want to force users to write:</p>
<div class="codehilite"><pre><span></span><code>_ = Task.result! task
</code></pre></div>



<a name="449128992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449128992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449128992">(Jul 04 2024 at 16:41)</a>:</h4>
<p>Like be explicit they meant to throw away the data.</p>



<a name="449129084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449129084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449129084">(Jul 04 2024 at 16:42)</a>:</h4>
<p>I could see the value in that (of course it would need a custom error to avoid confusion)</p>



<a name="449129861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449129861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449129861">(Jul 04 2024 at 16:48)</a>:</h4>
<p>I believe there was a discussion a long time ago and as a result, statements were introduced. otherwise we'd write <code>_ = </code> everywhere.<br>
Or you mean, allow statements only for <code>Task {} *</code> case?</p>



<a name="449129886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449129886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449129886">(Jul 04 2024 at 16:48)</a>:</h4>
<p>I would agree with this.</p>



<a name="449129982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449129982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449129982">(Jul 04 2024 at 16:49)</a>:</h4>
<p>In Rust, we have the #[must_use] directive, which makes sure that users don't perform fallible tasks and forget to handle a Result</p>



<a name="449130177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449130177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449130177">(Jul 04 2024 at 16:50)</a>:</h4>
<p>Without such a directive here, if we don't require users to at least put an underscore, it becomes very easy to avoid handling task outcomes</p>



<a name="449130370"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449130370" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449130370">(Jul 04 2024 at 16:52)</a>:</h4>
<p>I like the idea. not sure how to implement it tho. it's a type based unused variable</p>



<a name="449131128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449131128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449131128">(Jul 04 2024 at 16:56)</a>:</h4>
<p>The simple thing is what I think we already do: allow skipping the assignment if the {} unit type is returned, otherwise require an assignment</p>



<a name="449131616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449131616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449131616">(Jul 04 2024 at 16:59)</a>:</h4>
<p>can you give an example?</p>



<a name="449146523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449146523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449146523">(Jul 04 2024 at 18:38)</a>:</h4>
<p>The fix for the problem described in the head message: <a href="https://github.com/roc-lang/roc/issues/6868">https://github.com/roc-lang/roc/issues/6868</a></p>



<a name="449149421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449149421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449149421">(Jul 04 2024 at 19:05)</a>:</h4>
<p>I think an example is this:</p>
<div class="codehilite"><pre><span></span><code>x = Stdin.line!
{} = Stdout.line! &quot;some output&quot;
</code></pre></div>
<p>We definitely want to allow:</p>
<div class="codehilite"><pre><span></span><code>x = Stdin.line!
Stdout.line! &quot;some output&quot;
</code></pre></div>
<p>We actually might not want to allow:</p>
<div class="codehilite"><pre><span></span><code>Stdin.line!
Stdout.line! &quot;some output&quot;
</code></pre></div>
<p>With this final code, we may want to force the user to be explicit that they are throwing away the result of <code>Stdin.line!</code>. So We may want to generate an error that say: <code>Stdin.line! returns a Str, but you are not using it. If this is intentional, please write "_ = Stdin.line!"</code></p>
<p>As such, the required form would be:</p>
<div class="codehilite"><pre><span></span><code>_ = Stdin.line!
Stdout.line! &quot;some output&quot;
</code></pre></div>
<p>Basically, the question is: Do we want warnings for when the result of a Task! is not used and is not <code>{}</code>?</p>



<a name="449149741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449149741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449149741">(Jul 04 2024 at 19:07)</a>:</h4>
<p>I could see people voting either way. I think the explicit <code>_ = </code> is a lot clearer on intention, but is extra verbosity. It also, likely will be a bit harder to program into the compiler, but I think it is likely the better solution so that a user doesn't accidentally miss a returned value from a task.</p>



<a name="449154709"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449154709" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449154709">(Jul 04 2024 at 19:35)</a>:</h4>
<p>yeah I think statements should only work for <code>Task {} _</code></p>



<a name="449154730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449154730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449154730">(Jul 04 2024 at 19:35)</a>:</h4>
<p>Yeah, I agree with all points. I meant, an example of what <span class="user-mention" data-user-id="461444">@Sam Mohr</span> was talking about.</p>
<p>I imagined suffixed stmt desugaring to work this way, in particular the first step:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="o">!</span><span class="w"> </span><span class="n">task</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">-- 1. add a unique var in front of the statement along with a type annotation</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="o">#!</span><span class="n">a0</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="o">#!</span><span class="n">a0</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="o">!</span><span class="w"> </span><span class="n">task</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>



<a name="449154843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449154843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449154843">(Jul 04 2024 at 19:37)</a>:</h4>
<p>and then if not a unit type returned - ask user to have an explicit pattern. otherwise - ignore the unused variable (assuming it's a special kind of var)</p>



<a name="449158053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449158053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449158053">(Jul 04 2024 at 20:07)</a>:</h4>
<p>However, no need to add the annotation if there’s a special kind of pattern. I’ll play with the concept. I don’t know how errors/warnings of the compiler are collected, and didn’t look into type system much yet, so it will be a good introduction I think</p>



<a name="449161605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449161605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449161605">(Jul 04 2024 at 20:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="584248">Kiryl Dziamura</span> <a href="#narrow/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring/near/449154730">said</a>:</p>
<blockquote>
<p>Yeah, I agree with all points. I meant, an example of what <span class="user-mention silent" data-user-id="461444">Sam Mohr</span> was talking about.</p>
</blockquote>
<p>I might be communicating poorly, I'm just saying what Richard said. If the Task returns {}, we know nothing valuable was returned. Otherwise, if the dev is forced to assign the value to a variable, we get what I'm talking about for free</p>



<a name="449161720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449161720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449161720">(Jul 04 2024 at 20:32)</a>:</h4>
<p>In that if they assign a variable that's not prefixed with an underscore, they'll get a warning if the value isn't used. So they need to explicitly ignore the value by prefixing with an underscore to ignore it, which is good enough as a #[must_use] in my eyes</p>



<a name="449162304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449162304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449162304">(Jul 04 2024 at 20:39)</a>:</h4>
<p>Then we’re on the same page! <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="449162318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449162318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449162318">(Jul 04 2024 at 20:39)</a>:</h4>
<p>Awesome!</p>



<a name="449182053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449182053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449182053">(Jul 04 2024 at 23:58)</a>:</h4>
<p>I think there may have been some confusion here. At least I'm a little confused about the PR. -- I'll try and explain 1 sec</p>



<a name="449182935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449182935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449182935">(Jul 05 2024 at 00:05)</a>:</h4>
<p>I thought were desugaring suffixed statements into <code>{} = Task.await ...</code> because that restricts their use to only tasks that are <code>Task {} _</code>.</p>



<a name="449183477"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449183477" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449183477">(Jul 05 2024 at 00:08)</a>:</h4>
<p>For example the following example is not the behaviour that we want</p>
<div class="codehilite"><pre><span></span><code>main =
    Stdin.input!

    Stdout.print &quot;just ingore the input&quot;

# the PR would desguar this into
main =
    Task.await (Stdin.input) \_ -&gt;

        Stdout.print &quot;just ingore the input&quot;
</code></pre></div>



<a name="449183745"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449183745" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449183745">(Jul 05 2024 at 00:09)</a>:</h4>
<p>While this should be permitted because the user is intentionally throwing the input away</p>
<div class="codehilite"><pre><span></span><code>main =
    _ = Stdin.input!

    Stdout.print &quot;just ingore the input&quot;

# this should be ok, and is the current bevahiour (ASFAIK)
main =
    Task.await (Stdin.input) \_ -&gt;

        Stdout.print &quot;just ingore the input&quot;
</code></pre></div>



<a name="449184236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449184236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449184236">(Jul 05 2024 at 00:13)</a>:</h4>
<p>And if they just make it a statement and don't explicitly ignore, like below, then this should throw a type error.</p>
<div class="codehilite"><pre><span></span><code>main =
    Stdin.input!

    Stdout.print &quot;just ingore the input&quot;

# this will throw a type error
main =
    Task.await (Stdin.input) \{} -&gt;

        Stdout.print &quot;just ingore the input&quot;
</code></pre></div>
<div class="codehilite"><pre><span></span><code>── TYPE MISMATCH in main.roc ───────────────────────────────────────────────────

This 2nd argument to this function has an unexpected type:

10│      Stdin.input!


The argument is an anonymous function of type:

    {}a -&gt; Task {} […]

But this function needs its 2nd argument to be:

    Str -&gt; Task {} […]

────────────────────────────────────────────────────────────────────────────────
</code></pre></div>



<a name="449184918"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449184918" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449184918">(Jul 05 2024 at 00:21)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> are you saying this is how you thought we agreed it should work, or how you personally think it should work?</p>



<a name="449185010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449185010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449185010">(Jul 05 2024 at 00:22)</a>:</h4>
<p>I think users should be able to use ! to await any Task, and eliding the {} = means when the task returns {}, we can throw that away because it's useless</p>



<a name="449185757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449185757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449185757">(Jul 05 2024 at 00:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring/near/449154709">said</a>:</p>
<blockquote>
<p>yeah I think statements should only work for <code>Task {} _</code></p>
</blockquote>
<p>This is basically what I'm thinking of, and why I don't think we <em>should</em> have statements for any task.</p>



<a name="449186009"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449186009" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449186009">(Jul 05 2024 at 00:30)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring/near/449128938">said</a>:</p>
<blockquote>
<p><code>result!</code> returns data, so maybe we intentionally want to force users to write:</p>
<p><div class="codehilite"><pre><span></span><code>_ = Task.result! task
</code></pre></div><br>
</p>
</blockquote>
<p>And also this. If users want to throw away the data they can add a <code>_ =</code> assignment and be explicit.</p>



<a name="449186320"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449186320" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449186320">(Jul 05 2024 at 00:33)</a>:</h4>
<p><span class="user-mention silent" data-user-id="461444">Sam Mohr</span> <a href="#narrow/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring/near/449184918">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> are you saying this is how you thought we agreed it should work, or how you personally think it should work?</p>
</blockquote>
<p>I'm saying I think there has been some confusion. Based on my read of the above discussion, and the behaviour I can see in the PR, I don't think it matches.</p>
<p>I'm seeking clarification -- as much as pointing out how I also understand the design was intended to work.</p>



<a name="449188675"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449188675" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449188675">(Jul 05 2024 at 00:56)</a>:</h4>
<p>Okay, when we say "statement", we mean something like</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"Hello world"</span>
</code></pre></div>
<p>Where we call a task <code>Task {} _</code>, but don't <em>assign</em> anything. Whereas an "assignment" means</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">data</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Http</span><span class="nf">.</span><span class="nv">get</span><span class="err">!</span><span class="w"> </span><span class="s">"api.com"</span>
</code></pre></div>



<a name="449188899"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449188899" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449188899">(Jul 05 2024 at 00:57)</a>:</h4>
<p>Okay, given that much</p>



<a name="449189046"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189046" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189046">(Jul 05 2024 at 00:58)</a>:</h4>
<p>Yeah, it's a very specific distinction based on the implementation for the <code>Ast::Expr</code>type</p>



<a name="449189073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189073">(Jul 05 2024 at 00:59)</a>:</h4>
<p>We only have statements for <code>dbg</code> <code>expect</code> <code>if then else</code> <code>when</code></p>



<a name="449189074"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189074" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189074">(Jul 05 2024 at 00:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring/near/449185757">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring/near/449154709">said</a>:</p>
<blockquote>
<p>yeah I think statements should only work for <code>Task {} _</code></p>
</blockquote>
<p>This is basically what I'm thinking of, and why I don't think we <em>should</em> have statements for any task.</p>
</blockquote>
<p>You would rather not have "statements", aka users should have to write</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="p">{}</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span><span class="w"> </span><span class="s">"Hello world"</span>
</code></pre></div>



<a name="449189084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189084">(Jul 05 2024 at 00:59)</a>:</h4>
<p>Is that the case?</p>



<a name="449189238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189238">(Jul 05 2024 at 01:01)</a>:</h4>
<p>This is discussed in the <a href="https://docs.google.com/document/d/1mTEZlOKqtMonmVsIGEC1A9ufs1TQHhVgZ52Vn-13GeU/edit?usp=sharing">Chaining Syntax Design Proposal</a></p>



<a name="449189254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189254">(Jul 05 2024 at 01:01)</a>:</h4>
<p>See the section <code>Task statements</code></p>



<a name="449189655"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189655" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189655">(Jul 05 2024 at 01:07)</a>:</h4>
<p>I'll read through that again. In the mean time, I think I personally am okay with eliding the left hand side of this assignment for a few reasons</p>
<ul>
<li>like how Task.await is the only thing that ! now means, eliding <code>{} = </code> is unambiguous if it only happens with unit value Tasks</li>
<li>there are lots of ops that return {}, so it is nice to be able to ignore their result</li>
</ul>



<a name="449189735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449189735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449189735">(Jul 05 2024 at 01:07)</a>:</h4>
<p>yeah so maybe a summary would be:</p>
<ul>
<li>it should never be necessary to write <code>{} = someTask! ...</code> because you should always be able to omit that <code>{} =</code></li>
<li>for all other <code>Task</code> return types, this shouldn't be the case, and you <em>should</em> have to write <code>_ = someTask!</code> (or some more specific pattern than <code>_</code>)</li>
</ul>



<a name="449236112"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449236112" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449236112">(Jul 05 2024 at 07:16)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> thanks for clarification!</p>
<p>I updated the pr: <a href="https://github.com/roc-lang/roc/pull/6868">https://github.com/roc-lang/roc/pull/6868</a></p>
<p>the actual fix is to just remove the third step I mentioned in my original message:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="nf">\</span><span class="p">{}</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">        </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>

<span class="c1">-- 3. drop destructuring because input and output are the same</span>
<span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="w"> </span><span class="n">task</span>
</code></pre></div>
<p>In this step, we completely remove user's return <code>Task.ok {}</code>, assuming the task returns <code>{}</code> which is not correct because we don't know it's type during desugaring</p>



<a name="449239899"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449239899" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kilian Vounckx <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449239899">(Jul 05 2024 at 07:33)</a>:</h4>
<p>What about records? Say you do something like <code>Http.get</code> which returns a response record like <code>{ status : U16, body : Str }</code> (simplified of course). With await syntax you used to be able to do</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>Task.await (Http.get "example.com") \{} -&gt;
    # do something without response
</code></pre></div>
<p>The record fields would just be ignored because the anonymous function takes an open record. I don't know how this would work with bang syntax, but it shouldn't work as a statement for such calls. However just desugaring a statement to an empty record would allow it to work. I don't know the way around it though because you would need type information</p>



<a name="449249176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449249176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449249176">(Jul 05 2024 at 08:23)</a>:</h4>
<p>Yeah, I think we should generate a special pattern as I mentioned earlier.</p>



<a name="449257888"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449257888" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449257888">(Jul 05 2024 at 08:59)</a>:</h4>
<p>Or, even better, we can have a named underscore with type annotation</p>



<a name="449259147"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449259147" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449259147">(Jul 05 2024 at 09:06)</a>:</h4>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="kr">_</span><span class="o">#!</span><span class="n">a0</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span>
<span class="kr">_</span><span class="o">#!</span><span class="n">a0</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="o">!</span><span class="w"> </span><span class="n">task</span>
</code></pre></div>



<a name="449259556"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449259556" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449259556">(Jul 05 2024 at 09:07)</a>:</h4>
<p>Is there a way to annotate closure without moving it into a separate variable?</p>



<a name="449271337"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449271337" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449271337">(Jul 05 2024 at 09:51)</a>:</h4>
<p>I imagine smth like that</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="o">!</span><span class="w"> </span><span class="n">task</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<p>transforms to</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="p">(</span><span class="kt">Task</span><span class="o">.</span><span class="n">result</span><span class="w"> </span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="nf">\</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">        </span><span class="n">_a</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="n">_a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">a</span>
<span class="w">        </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<p>it works and requires strictly unit type. however in this form it produces this warning:</p>
<div class="codehilite"><pre><span></span><code>This destructure assignment doesn&#39;t introduce any new variables:

14│          _a = a
             ^^

If you don&#39;t need to use the value on the right-hand-side of this
assignment, consider removing the assignment. Since Roc is purely
functional, assignments that don&#39;t introduce variables cannot affect a
program&#39;s behavior!
</code></pre></div>
<p>which is expectable but I'm not sure how it would look like for syntax sugar. we should ignore this warning there</p>



<a name="449279249"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449279249" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449279249">(Jul 05 2024 at 10:39)</a>:</h4>
<p>Ha! I think it can be this:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">ignoreResult</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="nf">\</span><span class="n">a0</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">        </span><span class="n">a1</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="n">a1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">a0</span>
<span class="w">        </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="n">a1</span>
</code></pre></div>



<a name="449285145"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449285145" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449285145">(Jul 05 2024 at 11:04)</a>:</h4>
<p>Found another bug. Type annotation is ignored in this example:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">task</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">U32</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">task</span><span class="o">!</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="n">a</span>
</code></pre></div>
<p>The fix from the prev message should cover this case as well</p>



<a name="449294331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449294331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449294331">(Jul 05 2024 at 11:56)</a>:</h4>
<p>On the other hand, it won't work with multiple statements:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">f</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="n">a</span><span class="o">!</span>
<span class="w">    </span><span class="n">b</span><span class="o">!</span>
<span class="w">    </span><span class="n">c</span><span class="o">!</span>
</code></pre></div>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">f</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">\#!</span><span class="n">a0</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">        </span><span class="o">#!</span><span class="n">a1</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="o">#!</span><span class="n">a1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="o">#!</span><span class="n">a0</span><span class="w"> </span><span class="c1">-- &lt;---- need to drop this variable without warnings somehow</span>
<span class="w">        </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">\#!</span><span class="n">a2</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="o">...</span>
</code></pre></div>
<p>I'll extend <code>Underscore(&amp;str)</code> to <code>Underscore(&amp;str, AddedBy)</code> where <code>AddedBy</code> is enum with options <code>User, TaskAwaitBang</code> (and <code>ResultTryQuestion</code> in the future) so we can both fix the problem and generate better error message going forward</p>



<a name="449334280"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/TaskAwaitBang%20statement%20desugaring/near/449334280" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Kiryl Dziamura <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/TaskAwaitBang.20statement.20desugaring.html#449334280">(Jul 05 2024 at 15:15)</a>:</h4>
<p>Sorry for spamming. I realized that typed closures are better for now. This way no need to introduce changes to the <code>Underscore</code> pattern. At least for now</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="n">x</span><span class="o">!</span>
<span class="w">    </span><span class="n">y</span><span class="o">!</span>
<span class="w">    </span><span class="n">z</span><span class="o">!</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="n">a2</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">_</span>
<span class="w">    </span><span class="n">a2</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="n">a1</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">_</span>
<span class="w">    </span><span class="n">a1</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="n">a2</span>
<span class="w">    </span><span class="n">a0</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">_</span>
<span class="w">    </span><span class="n">a0</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">a1</span>
<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">await</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">a0</span>
</code></pre></div>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
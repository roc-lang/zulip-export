<html>
<head><meta charset="utf-8"><title>Interpreter recursion crash · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html">Interpreter recursion crash</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="560507559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560507559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560507559">(Nov 27 2025 at 02:47)</a>:</h4>
<p>So I have been doing a little more investigation into the crash that I encountered yesterday. I had to build the platform shim with debug symbols in order to get a backtrace which required some modifications in <code>cli/main.zig</code> and <code>cli/linker.zig</code>.  It looks like the exception actually occurs in translateTypeVar when we try to access a key in the translate_cache. </p>
<p>It was a bit difficult getting to this point because I had to manually modify the calls to llvm and lld-link to get a debuggable platform shim. Does it make sense to make this an option in the <code>generatePlatformHostShim</code> function for debugging? I could even see this being valuable for people developing their own platforms for debugging purposes.</p>
<p>Also I was wondering if this recursive fib test should be put into the snapshot tests folder or be added to one of the test platforms like int or str etc.</p>
<p><a href="/user_uploads/22008/tRqC6wBfvosB3gHELVgH7Mgs/image.png">image.png</a><br>
<a href="/user_uploads/22008/106S0FiE12VSwHl7DgnC8vgS/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/tRqC6wBfvosB3gHELVgH7Mgs/image.png" title="image.png"><img data-original-content-type="image/png" data-original-dimensions="1912x134" src="/user_uploads/thumbnail/22008/tRqC6wBfvosB3gHELVgH7Mgs/image.png/840x560.webp"></a></div><div class="message_inline_image"><a href="/user_uploads/22008/106S0FiE12VSwHl7DgnC8vgS/image.png" title="image.png"><img data-original-content-type="image/png" data-original-dimensions="586x1452" src="/user_uploads/thumbnail/22008/106S0FiE12VSwHl7DgnC8vgS/image.png/840x560.webp"></a></div>



<a name="560510873"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560510873" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560510873">(Nov 27 2025 at 03:38)</a>:</h4>
<p>Sounds like something that would be very useful in future to have</p>



<a name="560510897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560510897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560510897">(Nov 27 2025 at 03:38)</a>:</h4>
<p>Another update. It does actually look like its a stack depth bug. I updated to the latest main branch and the crash location changed but the call stack looks very similar.</p>



<a name="560511497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511497">(Nov 27 2025 at 03:47)</a>:</h4>
<p>Does this mean that <code>evalExprMinimal</code> and <code>dispatchBinaryOp</code> should be implemented without recursion so that they do not trigger a stack overflow, or is it better to ignore the problem for now and implement tail call recursion? I think that tail calls would only work in the trivial case like for Fibonacci where there is no more work after the recursive call correct?</p>



<a name="560511566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511566">(Nov 27 2025 at 03:48)</a>:</h4>
<p>I'm probably not the best person to comment on that question... but I know that trmc is the plan</p>



<a name="560511599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511599">(Nov 27 2025 at 03:49)</a>:</h4>
<p>I thought our interpreter was implemented without recursion though</p>



<a name="560511617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511617">(Nov 27 2025 at 03:49)</a>:</h4>
<p>I'm thinking of tail call optimization as something to do in 2026</p>



<a name="560511635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511635">(Nov 27 2025 at 03:49)</a>:</h4>
<p>right now I'm trying to focus on what's needed to unblock people doing Advent of Code in Roc if they want to</p>



<a name="560511666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511666">(Nov 27 2025 at 03:50)</a>:</h4>
<p>and since we already have <code>for</code> and <code>while</code>, stack-safe recursion isn't a blocker <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="560511728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511728">(Nov 27 2025 at 03:50)</a>:</h4>
<p><span class="user-mention silent" data-user-id="1001061">Devin Prothero</span> <a href="#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560511497">said</a>:</p>
<blockquote>
<p>Does this mean that <code>evalExprMinimal</code> and <code>dispatchBinaryOp</code> should be implemented without recursion so that they do not trigger a stack overflow</p>
</blockquote>
<p>oh you mean recursion in the Zig code!</p>



<a name="560511756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560511756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560511756">(Nov 27 2025 at 03:51)</a>:</h4>
<p>yeah it would be great if they could be stack-safe <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="560512018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512018">(Nov 27 2025 at 03:55)</a>:</h4>
<p>Yeah the zig code for the interpreter is all recursive which causes the stack overflow. It might be a bit difficult to rewrite in a stack safe way since there are multiple mutually recursive functions all interacting. Some kind of state machine with ArrayLists to hold stack frames might make the most sense, but I would have to try it first and see.</p>



<a name="560512130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512130">(Nov 27 2025 at 03:56)</a>:</h4>
<p>I have written some toy languages before but usually I would compile to a bytecode and interpret that with a VM rather than directly interpreting expressions so iv'e just been trying to familiarize myself with the code.</p>



<a name="560512173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512173">(Nov 27 2025 at 03:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560511666">said</a>:</p>
<blockquote>
<p>and since we already have <code>for</code> and <code>while</code>, stack-safe recursion isn't a blocker <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>
</blockquote>
<p>That makes a lot of sense, I think that is smart since AOC is just around the corner</p>



<a name="560512487"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512487" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512487">(Nov 27 2025 at 04:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560511566">said</a>:</p>
<blockquote>
<p>I'm probably not the best person to comment on that question... but I know that trmc is the plan</p>
</blockquote>
<p>Sorry I'm not familiar with trmc what is that?</p>



<a name="560512861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512861">(Nov 27 2025 at 04:06)</a>:</h4>
<p><a href="https://jfmengels.net/modulo-cons/#tail-recursion-but-modulo-cons">https://jfmengels.net/modulo-cons/#tail-recursion-but-modulo-cons</a></p>



<a name="560512919"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512919" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512919">(Nov 27 2025 at 04:07)</a>:</h4>
<p>relevant Roc-specific context: <a class="stream-topic" data-stream-id="316715" href="/#narrow/channel/316715-contributing/topic/Tail.20Recursion.20Modulo.20Cons/with/356268539">#contributing &gt; Tail Recursion Modulo Cons</a>  and later <a href="https://github.com/roc-lang/roc/pull/5569">https://github.com/roc-lang/roc/pull/5569</a></p>



<a name="560512922"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512922" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512922">(Nov 27 2025 at 04:07)</a>:</h4>
<p>(and other follow-up PRs)</p>



<a name="560512932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512932">(Nov 27 2025 at 04:07)</a>:</h4>
<p>Thanks</p>



<a name="560512957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560512957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560512957">(Nov 27 2025 at 04:08)</a>:</h4>
<p>Richard that zulip chat is a private group DM I think... I can't see it at least</p>



<a name="560513113"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560513113" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560513113">(Nov 27 2025 at 04:10)</a>:</h4>
<p>oops sorry, fixed the link!</p>



<a name="560515248"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560515248" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560515248">(Nov 27 2025 at 04:36)</a>:</h4>
<p>Hmm. I wouldn't expect the interpreter to need this at all. I thought the interpreter was a big while loop that runs instructions and then pushes function calls onto the stack. If the interpreter itself is recursive for code execution it may be a general problem in large roc programs even with trmc.</p>



<a name="560515351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560515351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560515351">(Nov 27 2025 at 04:38)</a>:</h4>
<p>yeah I was confused earlier - this is about our Zig code being recursive</p>



<a name="560515363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560515363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560515363">(Nov 27 2025 at 04:38)</a>:</h4>
<p>instead of stack-safe</p>



<a name="560515382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560515382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560515382">(Nov 27 2025 at 04:38)</a>:</h4>
<p>as I recall I went down a rabbit hole trying to do that at some point and backed off</p>



<a name="560517601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560517601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560517601">(Nov 27 2025 at 05:11)</a>:</h4>
<p>From what I have seen so far it looks like CIR is modeled as an S-Expression so the most natural way to implement the interpreter is recursively. Here is a random example of the simple add test after the canonicalize pass.</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="nv">can-ir</span>
<span class="w">    </span><span class="p">(</span><span class="nv">d-let</span>
<span class="w">        </span><span class="p">(</span><span class="nv">p-assign</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"addU8"</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nv">e-lambda</span>
<span class="w">            </span><span class="p">(</span><span class="nv">args</span>
<span class="w">                </span><span class="p">(</span><span class="nv">p-assign</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"a"</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">p-assign</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"b"</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="nv">e-binop</span><span class="w"> </span><span class="p">(</span><span class="nv">op</span><span class="w"> </span><span class="s">"add"</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-lookup-local</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">p-assign</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"a"</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-lookup-local</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">p-assign</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"b"</span><span class="p">)))))</span>
<span class="w">        </span><span class="p">(</span><span class="nv">annotation</span>
<span class="w">            </span><span class="p">(</span><span class="nv">ty-fn</span><span class="w"> </span><span class="p">(</span><span class="nv">effectful</span><span class="w"> </span><span class="nv">false</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nv">ty-lookup</span><span class="w"> </span><span class="p">(</span><span class="nv">name</span><span class="w"> </span><span class="s">"U8"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">builtin</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">ty-lookup</span><span class="w"> </span><span class="p">(</span><span class="nv">name</span><span class="w"> </span><span class="s">"U8"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">builtin</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">ty-lookup</span><span class="w"> </span><span class="p">(</span><span class="nv">name</span><span class="w"> </span><span class="s">"U8"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">builtin</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">s-expect</span>
<span class="w">        </span><span class="p">(</span><span class="nv">e-binop</span><span class="w"> </span><span class="p">(</span><span class="nv">op</span><span class="w"> </span><span class="s">"eq"</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nv">e-call</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-lookup-local</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">p-assign</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"addU8"</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-num</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="s">"1"</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-num</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="s">"2"</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="nv">e-num</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="s">"3"</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">s-expect</span>
<span class="w">        </span><span class="p">(</span><span class="nv">e-binop</span><span class="w"> </span><span class="p">(</span><span class="nv">op</span><span class="w"> </span><span class="s">"eq"</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nv">e-call</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-lookup-local</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">p-assign</span><span class="w"> </span><span class="p">(</span><span class="nv">ident</span><span class="w"> </span><span class="s">"addU8"</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-num</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="s">"0"</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nv">e-num</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="s">"10"</span><span class="p">)))</span>
<span class="w">            </span><span class="p">(</span><span class="nv">e-num</span><span class="w"> </span><span class="p">(</span><span class="nv">value</span><span class="w"> </span><span class="s">"10"</span><span class="p">)))))</span>
</code></pre></div>
<p>It seems like the problem arises once the call depth of the roc program reaches some arbitrary number because instructions like <code>e-call</code> and <code>e-binop</code>are intepreted by recursively calling <code>evalExprMinimal</code> and the like. I think that this means <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> is correct and that even non-recursive code will trigger this crash if you have deep enough function calls.</p>



<a name="560517656"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560517656" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560517656">(Nov 27 2025 at 05:12)</a>:</h4>
<p>for sure! that's why it should be stack-safe <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="560517698"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560517698" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560517698">(Nov 27 2025 at 05:12)</a>:</h4>
<p>the only reason it isn't right now is just the amount of work it would take - although maybe it will turn out we need it for advent of code <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="560524100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560524100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560524100">(Nov 27 2025 at 06:37)</a>:</h4>
<p>Yeah, I guess the current recursive nodes are not exactly interpreter friendly passed just being a tree walking interpreter</p>



<a name="560525630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560525630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560525630">(Nov 27 2025 at 06:53)</a>:</h4>
<p>I wonder if we will need to make a flat bytecode for it to work well.</p>



<a name="560525844"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560525844" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560525844">(Nov 27 2025 at 06:55)</a>:</h4>
<p>With anything tree, I think it is either expensive (push and popping state for every node), or recursive.</p>
<p>That said, if we just push state at function call boundaries (and loops), that may be enough</p>



<a name="560588847"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560588847" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> isaactfa <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560588847">(Nov 27 2025 at 12:47)</a>:</h4>
<p><span class="user-mention silent" data-user-id="1001061">Devin Prothero</span> <a href="#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560507559">said</a>:</p>
<blockquote>
<p>It was a bit difficult getting to this point because I had to manually modify the calls to llvm and lld-link to get a debuggable platform shim. Does it make sense to make this an option in the <code>generatePlatformHostShim</code> function for debugging? I could even see this being valuable for people developing their own platforms for debugging purposes.</p>
</blockquote>
<p>Could you share how you got a debuggable build? I'm struggling to find the right build/link options to adjust.</p>



<a name="560660254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560660254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Devin Prothero <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560660254">(Nov 27 2025 at 19:18)</a>:</h4>
<p><span class="user-mention silent" data-user-id="1001404">isaactfa</span> <a href="#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560588847">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="1001061">Devin Prothero</span> <a href="#narrow/channel/316715-contributing/topic/Interpreter.20recursion.20crash/near/560507559">said</a>:</p>
<blockquote>
<p>It was a bit difficult getting to this point because I had to manually modify the calls to llvm and lld-link to get a debuggable platform shim. Does it make sense to make this an option in the <code>generatePlatformHostShim</code> function for debugging? I could even see this being valuable for people developing their own platforms for debugging purposes.</p>
</blockquote>
<p>Could you share how you got a debuggable build? I'm struggling to find the right build/link options to adjust.</p>
</blockquote>
<p>I had to make quite a few changes to get debugging to work I made a patch file that shows the important stuff tho.</p>
<p><a href="/user_uploads/22008/Gyqt2oGt3Jv4ukoTm63izsJd/debug_platform_builds.patch">debug_platform_builds.patch</a></p>
<p>Also I don't know if you are on windows but if you are then I would recommend the RadDebugger because it makes it easy to debug subprocesses. You can just turn on a setting and it will automatically hook into child processes which is important because the interpreter runs as a subprocess.</p>



<a name="560717933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Interpreter%20recursion%20crash/near/560717933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> isaactfa <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Interpreter.20recursion.20crash.html#560717933">(Nov 28 2025 at 07:07)</a>:</h4>
<p>Thank you!</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
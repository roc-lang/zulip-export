<html>
<head><meta charset="utf-8"><title>Setting up development enviroment · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html">Setting up development enviroment</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="315266930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315266930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315266930">(Dec 11 2022 at 23:32)</a>:</h4>
<p>hey, Just setting up my development environment to play around in, and I hit a small snag.</p>
<p>When I run <code>cargo test</code> within nix from the project root directory, it comes back saying that ~70-90 of the tests have failed (it seems to be a different number every time). This is with a clean working tree on commit 116463893.</p>
<p>Is this expected behavior? If not, any ideas on how to fix that?</p>



<a name="315267194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267194">(Dec 11 2022 at 23:36)</a>:</h4>
<p>which tests fail?</p>



<a name="315267238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267238">(Dec 11 2022 at 23:37)</a>:</h4>
<p>they all start with <code>gen_</code> I can give you a complete list for my last test if you want</p>



<a name="315267405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267405">(Dec 11 2022 at 23:40)</a>:</h4>
<p>just a sample is fine. is any particular error printed?</p>



<a name="315267417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267417">(Dec 11 2022 at 23:40)</a>:</h4>
<p>and also, what are your system details</p>



<a name="315267591"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267591" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267591">(Dec 11 2022 at 23:43)</a>:</h4>
<div class="codehilite"><pre><span></span><code>failures:
    gen_abilities::encode_derived_list_of_lists_of_strings
    gen_abilities::encode_derived_nested_record_tag_record
    gen_abilities::encode_immediate::u16
    gen_abilities::hash::immediate::u16
    gen_compare::eq_i64
    gen_compare::list_eq_empty
    gen_compare::unit
    gen_list::bool_list_literal
    gen_list::list_drop_if_geq3
    gen_list::list_drop_if_string_eq
    gen_list::list_drop_last_mutable
    gen_list::list_find
    gen_list::list_find_index_not_found
...
</code></pre></div>
<p>the error that cargo comes back with is simply </p>
<div class="codehilite"><pre><span></span><code>error: test failed, to rerun pass &#39;-p test_gen --test test_gen&#39;
</code></pre></div>
<p>I'm on an M1 Macbook, macOS Monterey version 12.3.1</p>



<a name="315267653"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267653" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267653">(Dec 11 2022 at 23:44)</a>:</h4>
<p>hmm there is nothing else above the <code>failures: </code> line?</p>



<a name="315267766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267766">(Dec 11 2022 at 23:46)</a>:</h4>
<p>oh sorry, lots, something like this:</p>
<div class="codehilite"><pre><span></span><code>---- gen_tags::pattern_matching_unit stdout ----
thread &#39;gen_tags::pattern_matching_unit&#39; panicked at &#39;called `Result::unwrap()` on an `Err` value: DlClose { desc: &quot;dlclose(0x20fc175a0): cannot dlclose until fork() handlers have completed&quot; }&#39;, crates/compiler/test_gen/src/gen_tags.rs:712:5
</code></pre></div>
<p>79 times</p>
<p>from a quick scan they all seem to be panics on <code>unwrap</code> calls.</p>



<a name="315267870"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267870" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267870">(Dec 11 2022 at 23:48)</a>:</h4>
<p>hmm. well that is the interesting bit</p>



<a name="315267878"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267878" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267878">(Dec 11 2022 at 23:48)</a>:</h4>
<p>but I don't know what it means</p>



<a name="315267884"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315267884" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315267884">(Dec 11 2022 at 23:48)</a>:</h4>
<p>some sort of race condition maybe?</p>



<a name="315269126"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315269126" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315269126">(Dec 12 2022 at 00:06)</a>:</h4>
<p>ok, well, that must be it, running <code>cargo test -p test_gen --test test_gen -- --test-threads=1</code> returns no failures.</p>



<a name="315269153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315269153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315269153">(Dec 12 2022 at 00:06)</a>:</h4>
<p>but it also took 10 minutes. any ideas on how to fix?</p>



<a name="315269319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315269319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315269319">(Dec 12 2022 at 00:09)</a>:</h4>
<p>yeah, I always run those tests with <code>--test-threads=1</code> due to that race condition, generally with release</p>



<a name="315269577"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315269577" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315269577">(Dec 12 2022 at 00:13)</a>:</h4>
<p>do you have any idea what causes the race condition? hardware? OS? just the way the tests are designed?</p>



<a name="315269819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315269819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315269819">(Dec 12 2022 at 00:17)</a>:</h4>
<p>Not really. I assume it is running a kernel call in parallel over many tests.</p>



<a name="315269825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315269825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315269825">(Dec 12 2022 at 00:17)</a>:</h4>
<p>since dlclose is directly a kernel call</p>



<a name="315269894"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315269894" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315269894">(Dec 12 2022 at 00:18)</a>:</h4>
<p>maybe we could modify the test to use a lock when opening and closing dylibs</p>



<a name="315270070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315270070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315270070">(Dec 12 2022 at 00:21)</a>:</h4>
<p>interesting, also maybe we should add some text explaining this to <code>CONTRIBUTING.md</code>explaining the issue in the mean time. (in the running tests section)</p>



<a name="315270190"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315270190" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315270190">(Dec 12 2022 at 00:23)</a>:</h4>
<p>ether way, thank you very much for the help :)</p>



<a name="315272541"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315272541" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315272541">(Dec 12 2022 at 00:57)</a>:</h4>
<p>Update: it seems to work for up to 4 threads. don't know if that's significant, but it seemed to yield a small performance boost</p>



<a name="315281505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315281505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315281505">(Dec 12 2022 at 03:11)</a>:</h4>
<p>So I tried locks and it actually made things worse. Don't know why, maybe I just did something wrong. That said, it did work to just ignore the error instead of crashing. I guess the one concern of ignoring the error is that it could maybe lead to enough file handles building up that some random tests fail?</p>
<p>Thoughts on just changing from <code>library.close().unwrap()</code> to <code>let _ = library.close();</code>. That or just removing the line completely. The library should close when dropped(just ignoring errors). So maybe explicitly closing isn't need at all.</p>



<a name="315284163"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315284163" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315284163">(Dec 12 2022 at 03:52)</a>:</h4>
<p>yeah seems unnecessary in tests, unless I'm missing something!</p>



<a name="315284228"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315284228" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315284228">(Dec 12 2022 at 03:54)</a>:</h4>
<p>I thought we had a case in CI where we ran out of file handles. Thought this was maybe added because of that...but I could be wrong.</p>



<a name="315285135"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315285135" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315285135">(Dec 12 2022 at 04:06)</a>:</h4>
<p>we did do that because multiple tests might try to rebuild eg the cli platform at the same time</p>



<a name="315285153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315285153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315285153">(Dec 12 2022 at 04:06)</a>:</h4>
<p>I put something in place to manage that but i’m not confident it always works</p>



<a name="315285401"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315285401" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315285401">(Dec 12 2022 at 04:09)</a>:</h4>
<p>That is just locking which platform can build, right? This shouldn't relate to opening and closing dynamic libraries in <code>test_gen</code>. This failure is specifically from closing dls and making sure that doesn't error.</p>



<a name="315287027"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315287027" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315287027">(Dec 12 2022 at 04:31)</a>:</h4>
<p>is the problem only due to trying to close the dylib? i’m not sure i totally follow what the symptom is aside tests hanging<br>
on macos we spin trying to open the dylib if it doesn’t load the first time</p>



<a name="315287237"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315287237" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315287237">(Dec 12 2022 at 04:34)</a>:</h4>
<p>Yeah. Only on closing the dylib. Always this error: <code> DlClose { desc: "dlclose(0x20fc175a0): cannot dlclose until fork() handlers have completed" }</code></p>



<a name="315287267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315287267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315287267">(Dec 12 2022 at 04:35)</a>:</h4>
<p>if we ignore the error on close all the tests pass for me consistently</p>



<a name="315287344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315287344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315287344">(Dec 12 2022 at 04:36)</a>:</h4>
<p>tried to dig into the why, but really not sure</p>



<a name="315317200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315317200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315317200">(Dec 12 2022 at 09:00)</a>:</h4>
<p><span class="user-mention" data-user-id="572078">@Nathan Freestone</span> does <code>cargo test --release</code> work without errors? That is how we test it on CI.</p>



<a name="315400161"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315400161" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315400161">(Dec 12 2022 at 15:56)</a>:</h4>
<p>For these tests, it doesn't for me. I still have to limit threads in release builds for it to pass consistently with current main on test_gen</p>



<a name="315405256"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315405256" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315405256">(Dec 12 2022 at 16:18)</a>:</h4>
<p>I think this test_gen failure is the same as <a href="#narrow/stream/231635-compiler-development/topic/macos_x86_64.20test_gen.20failure/near/312339022">here</a> on the github ci macos x86_64 server. I could not reproduce it, so I never ended up bisecting it. If someone wants to give that a try; the failure first showed up 16 days ago. We can probably learn something from the commit that introduced the failure.</p>



<a name="315406371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315406371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315406371">(Dec 12 2022 at 16:23)</a>:</h4>
<p>I think it is likely different:</p>
<ol>
<li>I hit it on M1 macos</li>
<li>It is a dlclose here that gets unwrapped, there is no default unlike the issue on the CI server</li>
<li>I have been hitting it for months whenever I have to run <code>test_gen</code> locally (pretty rare, so i just  used 1 test thread when it happened)</li>
</ol>



<a name="315406539"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315406539" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315406539">(Dec 12 2022 at 16:24)</a>:</h4>
<p>Oh alright, good to know</p>



<a name="315406544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315406544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315406544">(Dec 12 2022 at 16:24)</a>:</h4>
<p>Also, it happens often enough that i will hit it consistently over the 1200ish tests in test_gwn.</p>



<a name="315407581"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315407581" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315407581">(Dec 12 2022 at 16:28)</a>:</h4>
<p>Based on the comments here: <a href="https://github.com/nagisa/rust_libloading/blob/6e284984aee68cc2d1b7e7d5e7b5a2a2279cf8e3/src/os/unix/mod.rs#L316">https://github.com/nagisa/rust_libloading/blob/6e284984aee68cc2d1b7e7d5e7b5a2a2279cf8e3/src/os/unix/mod.rs#L316</a></p>
<p>Especially those inside the function, i think we should just remove the lib.close line and see if it passes CI. With the current API, we can't even retry closing the lib. So i think we should just ignore the errors and make sure that doesn't break anything. The dl will still be requested to close, it just won't crash the test if that fails.</p>



<a name="315408681"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315408681" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315408681">(Dec 12 2022 at 16:34)</a>:</h4>
<p>I'll push a CL in a minute</p>



<a name="315408713"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315408713" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315408713">(Dec 12 2022 at 16:34)</a>:</h4>
<p>Then we can see if it passes CI</p>



<a name="315411718"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315411718" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315411718">(Dec 12 2022 at 16:49)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/pull/4741">#4741</a></p>



<a name="315432424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315432424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315432424">(Dec 12 2022 at 18:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/stream/316715-contributing/topic/Setting.20up.20development.20enviroment/near/315317200">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="572078">Nathan Freestone</span> does <code>cargo test --release</code> work without errors? That is how we test it on CI.</p>
</blockquote>
<p>I have the same experience as Brendan, also on Apple sillicon</p>



<a name="315441106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315441106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315441106">(Dec 12 2022 at 19:15)</a>:</h4>
<p>Ok. merged the fix.</p>



<a name="315441159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315441159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315441159">(Dec 12 2022 at 19:15)</a>:</h4>
<p>If you pull main, it should work with full threading</p>



<a name="315441366"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315441366" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315441366">(Dec 12 2022 at 19:16)</a>:</h4>
<p>I  will test</p>



<a name="315446595"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Setting%20up%20development%20enviroment/near/315446595" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Freestone <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Setting.20up.20development.20enviroment.html#315446595">(Dec 12 2022 at 19:46)</a>:</h4>
<p><code>cargo test --release</code> now works without errors! Thanks for looking into it!</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>formatting malformed nodes · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html">formatting malformed nodes</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="536700679"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536700679" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536700679">(Aug 29 2025 at 00:33)</a>:</h4>
<p>I'd like a second opinion on the decision to no longer format malformed input in snapshots. </p>
<p>On one hand we will have less noise in our snapshots as we fix things, on the other we lose the confidence that things are formatting stable right?</p>
<p><span class="user-mention" data-user-id="453336">@Joshua Warner</span> do you have any thoughts?</p>



<a name="536700750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536700750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536700750">(Aug 29 2025 at 00:34)</a>:</h4>
<p>I'd like to format malformed input because I want to make sure it's not discarding information</p>



<a name="536702330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536702330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536702330">(Aug 29 2025 at 00:58)</a>:</h4>
<p>I think for now we should just bail and refuse to format malformed input. As a second phase, we can format the top level defs that are not malformed.</p>



<a name="536702395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536702395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536702395">(Aug 29 2025 at 00:59)</a>:</h4>
<p>In my experience, the general problem of formatting malformed input is just a really hard problem.</p>



<a name="536702494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536702494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536702494">(Aug 29 2025 at 01:00)</a>:</h4>
<p>There are just too many ways the input can be malformed, and it’s really hard to make sure that our rendition of it doesn’t interact strangely with some property of the rest of the input (and make things worse)</p>



<a name="536705804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536705804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536705804">(Aug 29 2025 at 01:51)</a>:</h4>
<p>(this was a big source of fuzzing problems in the old compiler, and ultimately I’m not sure if it was worth it)</p>



<a name="536706923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536706923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536706923">(Aug 29 2025 at 02:06)</a>:</h4>
<p>I think it's fine to refuse to format malformed <em>nodes</em>, but what I want to avoid is refusing to format the entire file if any node is malformed</p>



<a name="536707207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536707207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536707207">(Aug 29 2025 at 02:11)</a>:</h4>
<p>Agree, but refusing to format at all is better than having a buggy formatter in the presence of malformed nodes - and that’s likely unless we have a very concerted effort.</p>



<a name="536707254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536707254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536707254">(Aug 29 2025 at 02:12)</a>:</h4>
<p>I don't understand what's buggy about just like - take the <code>Region</code> of the malformed node and literally <code>@memcpy</code> those bytes into the output buffer and continue</p>



<a name="536707278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536707278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536707278">(Aug 29 2025 at 02:12)</a>:</h4>
<p>like don't try to fix the indentation or anything like that, just if it's malformed we copy it over as-is, and it probably looks totally wrong, but that's fine because it's malformed</p>



<a name="536707294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536707294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536707294">(Aug 29 2025 at 02:13)</a>:</h4>
<p>and maybe it messes up the stuff around it, and that's fine too because it's malformed</p>



<a name="536707479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536707479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536707479">(Aug 29 2025 at 02:15)</a>:</h4>
<p>the important part being that if you have a malformed node somewhere earlier in your source code - e.g. the classic culprit of <code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code> from a merge conflict marker - it doesn't destroy your ability to have a nice experience editing the rest of your file</p>



<a name="536707508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536707508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536707508">(Aug 29 2025 at 02:16)</a>:</h4>
<p>the blast radius of brokenness is isolated to just the area right around the malformed node</p>



<a name="536707523"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536707523" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536707523">(Aug 29 2025 at 02:16)</a>:</h4>
<p>maybe I'm missing something about why that would be error-prone but it sounds very striaghtforward to me! <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="536708019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708019">(Aug 29 2025 at 02:23)</a>:</h4>
<p>With PNC I think the potential malformed weirdness is generally more bounded than before PNC (and braces). The general shape of the problem is that you can have something that the format changes immediately outside of the malformed block that causes the malformed block itself to be parted differently, perhaps as a different malformed thing or even well formed now - pushing the malformed section elsewhere.</p>



<a name="536708127"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708127" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708127">(Aug 29 2025 at 02:24)</a>:</h4>
<p>The git merge markers are a great example for another reason: if we format those badly, we might invalidate them and confuse other tools ( like editors)</p>



<a name="536708209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708209">(Aug 29 2025 at 02:25)</a>:</h4>
<p>For example, it would be bad if one of those got indented or the new line before/after it removed.</p>



<a name="536708313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708313">(Aug 29 2025 at 02:27)</a>:</h4>
<p>It’s a bit like undefined behavior: anything can be going on in the malformed node, and there’s no guarantee that after formatting that the “undefined” behavior will be still contained to that same node.</p>



<a name="536708384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joshua Warner <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708384">(Aug 29 2025 at 02:28)</a>:</h4>
<p>Obviously, the behavior stays the same if literally nothing else about the code changes, but if that’s the case, there’s no point in formatting anyway</p>



<a name="536708417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708417">(Aug 29 2025 at 02:29)</a>:</h4>
<p>19 messages were moved here from <a class="stream-topic" data-stream-id="316715" href="/#narrow/channel/316715-contributing/topic/Pull.20Request.20for.20Review/with/536658147">#contributing &gt; Pull Request for Review</a> by <span class="user-mention silent" data-user-id="515757">Luke Boswell</span>.</p>



<a name="536708654"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708654" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708654">(Aug 29 2025 at 02:33)</a>:</h4>
<p>One thing I intended for the snapshots was to also validate behaviour for unhappy paths like <code>&lt;&lt;&lt;&lt;&lt;</code> merge markers. That was what prompted me to ask this question, because I feel like it is helpful to see the formatter behaviour in our snapshots. </p>
<p>How we do that I'm not sure, but it sounds like either way we don't want a "MALFORMED INPUT" <span class="user-mention" data-user-id="639239">@JRI98</span>... is that right?</p>



<a name="536708912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536708912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536708912">(Aug 29 2025 at 02:37)</a>:</h4>
<p>yeah, fwiw I have a branch that's changing a bunch of stuff at once, so I'll roll this into that</p>



<a name="536727120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/formatting%20malformed%20nodes/near/536727120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> JRI98 <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/formatting.20malformed.20nodes.html#536727120">(Aug 29 2025 at 06:43)</a>:</h4>
<p>Now that I think of it, I shouldn't have sent that change in the same PR. But it came after this short discussion <a class="message-link" href="/#narrow/channel/395097-compiler-development/topic/zig-compiler.20-.20Formatter.20and.20style/near/536179002">#compiler development &gt; zig-compiler - Formatter and style @ 💬</a><br>
My rationale is that in the normal formatting flow, outside of snapshots, the current behavior is to bail out when there are parser errors. So, the <code>FORMATTED</code> section of a snapshot being broken doesn't mean that the same will happen when formatting a file via de CLI. Now, if the behavior of the CLI would change, that would be different, but as it is right now, my change would just be mimicking the formatting behavior in other places.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
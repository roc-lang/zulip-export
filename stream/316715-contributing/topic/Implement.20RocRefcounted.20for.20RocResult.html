<html>
<head><meta charset="utf-8"><title>Implement RocRefcounted for RocResult · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html">Implement RocRefcounted for RocResult</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="451346254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451346254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451346254">(Jul 14 2024 at 11:17)</a>:</h4>
<p>Having a crack at this and I'm a little stuck. Just wondering if there is something obvious I'm missing here.</p>
<div class="codehilite"><pre><span></span><code>no method named `is_refcounted` found for reference `&amp;ManuallyDrop&lt;T&gt;` in the current scope
found the following associated functions; to be used as methods, functions must have a `self` parameter
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RocRefcounted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RocResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">RocRefcounted</span><span class="p">,</span>
<span class="w">    </span><span class="n">E</span><span class="p">:</span><span class="w"> </span><span class="nc">RocRefcounted</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">as_result_of_refs</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">payload</span><span class="p">.</span><span class="n">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">payload</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">payload</span><span class="p">.</span><span class="n">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">payload</span><span class="p">.</span><span class="n">inc</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">todo!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">todo!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="451346969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451346969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451346969">(Jul 14 2024 at 11:33)</a>:</h4>
<p>I think I'm closer...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="n">RocRefcounted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">RocResult</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="o">&gt;</span>
<span class="k">where</span>
<span class="w">    </span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">RocRefcounted</span><span class="p">,</span>
<span class="w">    </span><span class="n">E</span><span class="p">:</span><span class="w"> </span><span class="nc">RocRefcounted</span><span class="p">,</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">RocResultTag</span><span class="p">::</span><span class="n">RocOk</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">ok</span><span class="p">).</span><span class="n">inc</span><span class="p">(),</span>
<span class="w">                </span><span class="n">RocResultTag</span><span class="p">::</span><span class="n">RocErr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">err</span><span class="p">).</span><span class="n">inc</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">RocResultTag</span><span class="p">::</span><span class="n">RocOk</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">ok</span><span class="p">).</span><span class="n">dec</span><span class="p">(),</span>
<span class="w">                </span><span class="n">RocResultTag</span><span class="p">::</span><span class="n">RocErr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">err</span><span class="p">).</span><span class="n">dec</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">tag</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">RocResultTag</span><span class="p">::</span><span class="n">RocOk</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">ok</span><span class="p">).</span><span class="n">is_refcounted</span><span class="p">(),</span>
<span class="w">                </span><span class="n">RocResultTag</span><span class="p">::</span><span class="n">RocErr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">payload</span><span class="p">.</span><span class="n">err</span><span class="p">).</span><span class="n">is_refcounted</span><span class="p">(),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="/user_uploads/22008/EkMUBQgD89wOoqZDmcWJK2EI/Screenshot-2024-07-14-at-21.32.50.png">Screenshot-2024-07-14-at-21.32.50.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/EkMUBQgD89wOoqZDmcWJK2EI/Screenshot-2024-07-14-at-21.32.50.png" title="Screenshot-2024-07-14-at-21.32.50.png"><img src="/user_uploads/22008/EkMUBQgD89wOoqZDmcWJK2EI/Screenshot-2024-07-14-at-21.32.50.png"></a></div><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">RocRefcounted</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// Increments the refcount.</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">);</span>

<span class="w">    </span><span class="sd">/// Decrements the refcount potentially freeing the underlying allocation.</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">);</span>

<span class="w">    </span><span class="sd">/// Returns true if the type is actually refcounted by roc.</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>



<a name="451365955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451365955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451365955">(Jul 14 2024 at 16:18)</a>:</h4>
<p>is_refcointed should have a branch</p>



<a name="451365972"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451365972" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451365972">(Jul 14 2024 at 16:18)</a>:</h4>
<p>Should be true if either the ok or err is refcounted</p>



<a name="451367961"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451367961" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451367961">(Jul 14 2024 at 16:54)</a>:</h4>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">fn</span><span class="w"> </span><span class="nv">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">T</span><span class="nf">::</span><span class="nv">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="nf">||</span><span class="w"> </span><span class="kt">E</span><span class="nf">::</span><span class="nv">is_refcounted</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>



<a name="451389236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451389236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451389236">(Jul 14 2024 at 23:30)</a>:</h4>
<p>Also need to implement this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">roc_std</span><span class="p">::</span><span class="n">RocRefcounted</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">SQLiteValue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">unimplemented!</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">unimplemented!</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_refcounted</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>



<a name="451389283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451389283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451389283">(Jul 14 2024 at 23:31)</a>:</h4>
<p>This was generated by roc glue. I might try hand implementing first.</p>



<a name="451389950"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451389950" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451389950">(Jul 14 2024 at 23:45)</a>:</h4>
<p>I think I know where the problem might be for basic-cli...</p>
<p>We have a lot of hand-rolled interface types like the following.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">InternalResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">body</span><span class="p">:</span><span class="w"> </span><span class="nc">RocList</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">metadata</span><span class="p">:</span><span class="w"> </span><span class="nc">Metadata</span><span class="p">,</span>
<span class="w">    </span><span class="n">variant</span><span class="p">:</span><span class="w"> </span><span class="nc">RocStr</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Metadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">headers</span><span class="p">:</span><span class="w"> </span><span class="nc">RocList</span><span class="o">&lt;</span><span class="n">Header</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">url</span><span class="p">:</span><span class="w"> </span><span class="nc">RocStr</span><span class="p">,</span>
<span class="w">    </span><span class="n">statusCode</span><span class="p">:</span><span class="w"> </span><span class="kt">u16</span><span class="p">,</span>
<span class="w">    </span><span class="n">statusText</span><span class="p">:</span><span class="w"> </span><span class="nc">RocStr</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>Do we need to do/change anything to manage the refcounting in these correctly?</p>



<a name="451390091"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451390091" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451390091">(Jul 14 2024 at 23:48)</a>:</h4>
<p>Like if roc gives the host one of these, or the host gives roc one, do we need to use the RocRefcounted fn's at all?</p>



<a name="451391903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451391903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451391903">(Jul 15 2024 at 00:21)</a>:</h4>
<blockquote>
<p>Do we need to do/change anything to manage the refcounting in these correctly?</p>
</blockquote>
<p>If they aren't put in lists, nothing should change</p>



<a name="451391971"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451391971" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451391971">(Jul 15 2024 at 00:22)</a>:</h4>
<p>So only if you give a <code>List InternalResponse</code> To/from roc.</p>



<a name="451391994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451391994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451391994">(Jul 15 2024 at 00:22)</a>:</h4>
<blockquote>
<p><code>SQLiteValue</code></p>
</blockquote>
<p>Must have missed that, I thought it would fall under a struct style tag, but I guess it is a non-recursive tag which needs smarter rules</p>



<a name="451392010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392010">(Jul 15 2024 at 00:23)</a>:</h4>
<p>impl should just be a match statement and then calling inc/dec on the values within it.</p>



<a name="451392031"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392031" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392031">(Jul 15 2024 at 00:23)</a>:</h4>
<p>OK. </p>
<p>Well, I'm currently porting some of the changes we made in basic-cli across to basic-webserver so there is less glue there and trying to implement these RefCounted things.</p>



<a name="451392046"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392046" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392046">(Jul 15 2024 at 00:23)</a>:</h4>
<p>I haven't found the issue in basic-cli</p>



<a name="451392111"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392111" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392111">(Jul 15 2024 at 00:24)</a>:</h4>
<blockquote>
<p>I haven't found the issue in basic-cli</p>
</blockquote>
<p>I think likely the bug is on the roc internal side and not platform related.</p>



<a name="451392130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392130">(Jul 15 2024 at 00:25)</a>:</h4>
<p>Also, is args.roc the only one with issues?</p>



<a name="451392298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392298">(Jul 15 2024 at 00:27)</a>:</h4>
<p>I'm not sure, it's the first one on the list and fails in the expect script</p>



<a name="451392384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392384">(Jul 15 2024 at 00:28)</a>:</h4>
<p>Ok, figured you can run the expect scripts manually using </p>
<div class="codehilite"><pre><span></span><code>$ EXAMPLES_DIR=examples/ expect ci/expect_scripts/args.exp
spawn examples//args div -n 5 -d 20
args(82068,0x201c58c00) malloc: Heap corruption detected, free list is damaged at 0x600000f48080
*** Incorrect guard value: 145982044012671
args(82068,0x201c58c00) malloc: *** set a breakpoint in malloc_error_break to debug

Error: output was different from expected value.
</code></pre></div>



<a name="451392536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392536">(Jul 15 2024 at 00:30)</a>:</h4>
<p>Just ran them all manually, only <code>args.roc</code> is failing</p>



<a name="451392559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392559">(Jul 15 2024 at 00:31)</a>:</h4>
<p>Args with valgrind, core issue:</p>
<div class="codehilite"><pre><span></span><code># Probably reading heap size on a list allocated without a heap size?
=56308== Invalid read of size 8
==56308==    at 0x1CDF43: ??? (roc_app:0)
==56308==    by 0x1D1E03: ??? (roc_app:0)
==56308==    by 0x1AAAB7: List_walkTryHelp_147f9a29f721bc6a47c431ffbf897368d53af6834eae9416f984da7fc2dd89 (roc_app:0)


# Double free
==56308==  Address 0x4b6d4b0 is 0 bytes inside a block of size 9 free&#39;d
==56308==    at 0x48469E4: free (in /nix/store/78zxvxfy6klvwfc2s95y71y0b284fd6v-valgrind-3.22.0/libexec/valgrind/vgpreload_memcheck-amd64-linux.so)
==56308==    by 0x1D4882: roc_dealloc (lib.rs:81)
==56308==    by 0x1CE2CA: decrement_refcounted_ptr_8 (roc_app:0)
==56308==    by 0x1CE27D: ??? (roc_app:0)
==56308==    by 0x18DB36: #Attr_#generic_rc_by_ref_2_dec (roc_app:0)
==56308==    by 0x18DB36: Arg.Parser_constructSetOfOptions_3655121d7ba98da90331d38b92032d451b515e695221ee2a9d34aa692cd2c (roc_app:0)

# Use after free
==56308== Invalid write of size 8
==56308==    at 0x1CDF64: ??? (roc_app:0)
==56308==    by 0x1D1E03: ??? (roc_app:0)
==56308==    by 0x1AAAB7: List_walkTryHelp_147f9a29f721bc6a47c431ffbf897368d53af6834eae9416f984da7fc2dd89 (roc_app:0)
==56308==    by 0x194BAE: List_walkTry_1d346aa605d9beef3d3c8b59d397858b899a3c7efdcede8d0efd4953334f936 (roc_app:0)
</code></pre></div>



<a name="451392566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392566">(Jul 15 2024 at 00:31)</a>:</h4>
<p>So almost certainly a refcounting bug of some sort.</p>



<a name="451392572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392572">(Jul 15 2024 at 00:31)</a>:</h4>
<p>Just need to figure out how to debug it.</p>



<a name="451392582"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392582" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392582">(Jul 15 2024 at 00:31)</a>:</h4>
<p>Add some sort of minimal repro to <code>gen_refcount</code></p>



<a name="451392629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451392629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451392629">(Jul 15 2024 at 00:32)</a>:</h4>
<p>All the cli parser combinators are pretty complex, so would prefer something more minimal....</p>



<a name="451396353"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451396353" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451396353">(Jul 15 2024 at 01:28)</a>:</h4>
<p>I think I've found a more minimal repro, but some reason I can't get it to run as a <code>gen_refcount</code> test. So still need to mess with debugging more.</p>



<a name="451398243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451398243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451398243">(Jul 15 2024 at 01:57)</a>:</h4>
<p>Much more minimal repro of at least one refcounting issue:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">app</span><span class="w"> </span><span class="p">[</span><span class="nv">main</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">pf</span><span class="nf">:</span><span class="w"> </span><span class="nv">platform</span><span class="w"> </span><span class="s">"../platform/main.roc"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Stdout</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Task</span><span class="w"> </span><span class="nv">exposing</span><span class="w"> </span><span class="p">[</span><span class="kt">Task</span><span class="p">]</span>

<span class="kt">Arg</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="kt">Short</span><span class="w"> </span><span class="kt">Str</span><span class="p">,</span>
<span class="w">    </span><span class="kt">ShortGroup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">names</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">Str</span><span class="p">,</span><span class="w"> </span><span class="nv">complete</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">[</span><span class="kt">Complete</span><span class="p">,</span><span class="w"> </span><span class="kt">Partial</span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="kt">Long</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span><span class="p">,</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">[</span><span class="kt">NoValue</span><span class="p">]</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="kt">Parameter</span><span class="w"> </span><span class="kt">Str</span><span class="p">,</span>
<span class="p">]</span>

<span class="nv">constructSetOfOptions</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Arg</span>
<span class="nv">constructSetOfOptions</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">combined</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">options</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">combined</span>
<span class="w">        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toUtf8</span>
<span class="w">        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">keepOks</span><span class="w"> </span><span class="nf">\</span><span class="nv">c</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">fromUtf8</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="p">]</span>

<span class="w">    </span><span class="nv">when</span><span class="w"> </span><span class="nv">options</span><span class="w"> </span><span class="nv">is</span>
<span class="w">        </span><span class="p">[</span><span class="nv">alone</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Short</span><span class="w"> </span><span class="nv">alone</span>
<span class="w">        </span><span class="nv">other</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">ShortGroup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">names</span><span class="nf">:</span><span class="w"> </span><span class="nv">other</span><span class="p">,</span><span class="w"> </span><span class="nv">complete</span><span class="nf">:</span><span class="w"> </span><span class="kt">Complete</span><span class="w"> </span><span class="p">}</span>

<span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="p">[</span><span class="s">"-d"</span><span class="p">]</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="nf">\</span><span class="nv">x</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">when</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">splitFirst</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="s">"-"</span><span class="w"> </span><span class="nv">is</span>
<span class="w">            </span><span class="kt">Ok</span><span class="w"> </span><span class="p">{</span><span class="nv">after</span><span class="p">}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">constructSetOfOptions</span><span class="w"> </span><span class="nv">after</span>
<span class="w">            </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="kt">Parameter</span><span class="w"> </span><span class="s">"err"</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">len</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">toStr</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span>
</code></pre></div>



<a name="451398902"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451398902" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451398902">(Jul 15 2024 at 02:04)</a>:</h4>
<p>Seems like the bug is somehow with pattern matching extracting  a value...no idea how though. Maybe I am missing something:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">constructSetOfOptions</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Arg</span>
<span class="nv">constructSetOfOptions</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">combined</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">options</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">combined</span>
<span class="w">        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toUtf8</span>
<span class="w">        </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">keepOks</span><span class="w"> </span><span class="nf">\</span><span class="nv">c</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">fromUtf8</span><span class="w"> </span><span class="p">[</span><span class="nv">c</span><span class="p">]</span>

<span class="w">    </span><span class="nv">dbg</span><span class="w"> </span><span class="nv">options</span>
<span class="w">    </span><span class="nv">when</span><span class="w"> </span><span class="nv">options</span><span class="w"> </span><span class="nv">is</span>
<span class="w">        </span><span class="p">[</span><span class="nv">alone</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">dbg</span><span class="w"> </span><span class="nv">alone</span>
<span class="w">            </span><span class="kt">Short</span><span class="w"> </span><span class="nv">alone</span>
<span class="w">        </span><span class="nv">other</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">ShortGroup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">names</span><span class="nf">:</span><span class="w"> </span><span class="nv">other</span><span class="p">,</span><span class="w"> </span><span class="nv">complete</span><span class="nf">:</span><span class="w"> </span><span class="kt">Complete</span><span class="w"> </span><span class="p">}</span>

<span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="p">[</span><span class="s">"-d"</span><span class="p">]</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="nf">\</span><span class="nv">x</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">when</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">splitFirst</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="s">"-"</span><span class="w"> </span><span class="nv">is</span>
<span class="w">            </span><span class="kt">Ok</span><span class="w"> </span><span class="p">{</span><span class="nv">after</span><span class="p">}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">out</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">constructSetOfOptions</span><span class="w"> </span><span class="nv">after</span>
<span class="w">                </span><span class="nv">dbg</span><span class="w"> </span><span class="nv">out</span>
<span class="w">                </span><span class="nv">out</span>
<span class="w">            </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="kt">Parameter</span><span class="w"> </span><span class="s">"err"</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">len</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">toStr</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[examples/args.roc:22] options = [&quot;d&quot;]
[examples/args.roc:25] alone = &quot;d&quot;
[examples/args.roc:35] out = (Short &quot;�&quot;)
</code></pre></div>



<a name="451398941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451398941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451398941">(Jul 15 2024 at 02:05)</a>:</h4>
<p>Or maybe treating something as a large string/slice incorrectly.</p>



<a name="451399259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451399259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451399259">(Jul 15 2024 at 02:08)</a>:</h4>
<p>Oh, interesting, I think the issue might actually be pattern matching directly... (I guess I don't know how pattern matching does refcounting).<br>
This is fine:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="w">    </span><span class="kr">if</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">len</span><span class="w"> </span><span class="nv">options</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="kr">then</span>
<span class="w">        </span><span class="nv">when</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">options</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">is</span>
<span class="w">            </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">alone</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Short</span><span class="w"> </span><span class="nv">alone</span>
<span class="w">            </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">crash</span><span class="w"> </span><span class="s">"impossible"</span>
<span class="w">    </span><span class="kr">else</span>
<span class="w">        </span><span class="kt">ShortGroup</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">names</span><span class="nf">:</span><span class="w"> </span><span class="nv">options</span><span class="p">,</span><span class="w"> </span><span class="nv">complete</span><span class="nf">:</span><span class="w"> </span><span class="kt">Complete</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



<a name="451399990"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451399990" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451399990">(Jul 15 2024 at 02:16)</a>:</h4>
<p>Ok even more minimal:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="kr">in</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">[</span><span class="kt">Str</span><span class="nf">.</span><span class="nv">fromUtf8</span><span class="w"> </span><span class="p">[</span><span class="nf">'</span><span class="nv">d'</span><span class="p">]]</span>
<span class="w">    </span><span class="nv">out</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">when</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">is</span>
<span class="w">            </span><span class="p">[</span><span class="nv">alone</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="nv">alone</span><span class="p">]</span>
<span class="w">            </span><span class="nv">other</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">other</span>
<span class="w">    </span><span class="nv">out</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">len</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">toStr</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span>
</code></pre></div>



<a name="451407351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451407351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451407351">(Jul 15 2024 at 04:13)</a>:</h4>
<p>Ok, so I've done a fair bit of refactoring for basic-webserver for these changes. It looks like everything is happy, the platform and all the examples check and build ok, but whenever I run the server and actually call into roc I get the following error from inside Roc.</p>
<div class="codehilite"><pre><span></span><code>thread &#39;tokio-runtime-worker&#39; panicked at crates/roc_host/src/roc.rs:42:5:
The Roc app crashed with: NoImplementationNamed { def_symbol: `38.IdentId(2)` }
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
thread &#39;tokio-runtime-worker&#39; panicked at crates/roc_host/src/http_server.rs:87:26:
called `Result::unwrap()` on an `Err` value: JoinError::Panic(Id(10), ...)
</code></pre></div>



<a name="451407525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451407525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451407525">(Jul 15 2024 at 04:16)</a>:</h4>
<p>Never mind, I found the thing that causes that is when you have a type annotation but have provided the implementation. Oops on my part.</p>



<a name="451408078"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451408078" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451408078">(Jul 15 2024 at 04:25)</a>:</h4>
<p>Ok, so I think I've completed the refactor for basic-webserver. I added all the changes to the <a href="https://github.com/roc-lang/basic-webserver/pull/54">refactor-host PR</a>. <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> </p>
<p>I have some failing expect scripts, but I can verify it's behaving correctly manually... so I think it's just a macos versus linux CI thing.</p>
<p>Before this will pass in CI it also needs a new nightly with the Refcount changes, and a release of basic-cli. But otherwise looks like everything is running ok on my macos. </p>
<p>I can also test it on my linux machine later.</p>



<a name="451410560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451410560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451410560">(Jul 15 2024 at 04:58)</a>:</h4>
<p>I've been testing the updated/refactored basic-webserver with the demo web app I've been working on, so am pretty confident it's working well.</p>



<a name="451536694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451536694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451536694">(Jul 15 2024 at 16:13)</a>:</h4>
<p>The RC bug looks to be llvm specific (which makes sense, cause llvm rolls its own rc while other backends generate refcount procs).</p>



<a name="451546332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451546332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451546332">(Jul 15 2024 at 16:44)</a>:</h4>
<p>Yep, a use after free for sure in llvm. The list <code>['d']</code> was converted to a <code>Str</code>, but still got freed anyway.</p>
<div class="codehilite"><pre><span></span><code>+ allocated u8@60000166c040 (1 bytes with alignment 8)
+ allocated u8@600001a600c0 (32 bytes with alignment 8)
decref list: (8,32,true,fn(?[*]u8) callconv(.C) void@1049a9420)
freeing underlying elements from: (u8@600001a600d0, 1)
| decrement isize@60000166c040: 1 - 1 = 0!
💀 freed u8@60000166c040
| decrement isize@600001a600c8: 1 - 1 = 0!
💀 freed u8@600001a600c0
+ allocated u8@600001a600c0 (32 bytes with alignment 8)
decref list: (8,32,true,fn(?[*]u8) callconv(.C) void@1049a9420)
freeing underlying elements from: (u8@600001a600d0, 1)
| decrement isize@60000166c040: 9223523571393151041 - 1 = 9223523571393151040!
| decrement isize@600001a600c8: 1 - 1 = 0!
💀 freed u8@600001a600c0
</code></pre></div>



<a name="451546545"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451546545" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451546545">(Jul 15 2024 at 16:44)</a>:</h4>
<p><code>60000166c040</code> specifically</p>



<a name="451558063"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451558063" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451558063">(Jul 15 2024 at 17:15)</a>:</h4>
<p>Is this output from a tool?</p>



<a name="451559387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451559387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451559387">(Jul 15 2024 at 17:18)</a>:</h4>
<p>Debug prints in our zig builtins</p>



<a name="451559498"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451559498" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451559498">(Jul 15 2024 at 17:18)</a>:</h4>
<p>Some behind flags that already exist. A few new.</p>



<a name="451644019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451644019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451644019">(Jul 15 2024 at 22:47)</a>:</h4>
<p>Testing the changes on my x64 linux machine -- in short basic-webserver refactor host branch is good to go. </p>
<p>The above free issue prevents us from using basic-cli.</p>
<div class="codehilite"><pre><span></span><code>08:44:37 ~/Documents/Github/basic-cli refactor-host$ roc --prebuilt-platform examples/args.roc -- div 5 2
free(): invalid next size (fast)
</code></pre></div>
<p>This prevents us from using the build script for basic-webserver as it uses argument parsing. </p>
<div class="codehilite"><pre><span></span><code>08:44:11 ~/Documents/Github/basic-webserver refactor-host$ roc --prebuilt-platform build.roc
free(): invalid pointer
</code></pre></div>
<p>Running through the build steps manually I can verify that basic-webserver is working well.</p>



<a name="451647311"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451647311" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451647311">(Jul 15 2024 at 23:11)</a>:</h4>
<p>Yeah, hopefully I can narrow down the bug and then everything will be green.</p>



<a name="451651633"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451651633" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451651633">(Jul 15 2024 at 23:51)</a>:</h4>
<p>Ok. I think it is a bug in drop specialization or something related to the <code>dec</code> to <code>decref</code> conversion.</p>



<a name="451652053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451652053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451652053">(Jul 15 2024 at 23:55)</a>:</h4>
<p>After refcounting ir is correct:</p>
<div class="codehilite"><pre><span></span><code>procedure : `#UserApp.main` Str
procedure = `#UserApp.main` ():
    let `#UserApp.16` : U8 = 100i64;
    let `#UserApp.15` : List U8 = Array [`#UserApp.16`];
    let `#UserApp.inStr` : [C {U64, U8}, C Str] = CallByName `Str.fromUtf8` `#UserApp.15`;
    let `#UserApp.in` : List [C {U64, U8}, C Str] = Array [`#UserApp.inStr`];
    joinpoint `#UserApp.8` `#UserApp.out`:
        let `#UserApp.7` : U64 = CallByName `List.len` `#UserApp.out`;
        dec `#UserApp.out`;
        let `#UserApp.6` : Str = CallByName `Num.toStr` `#UserApp.7`;
        ret `#UserApp.6`;
    in
    let `#UserApp.12` : U64 = lowlevel ListLenUsize `#UserApp.in`;
    let `#UserApp.13` : U64 = 1i64;
    let `#UserApp.14` : Int1 = lowlevel Eq `#UserApp.12` `#UserApp.13`;
    if `#UserApp.14` then
        let `#UserApp.11` : U64 = 0i64;
        let `#UserApp.alone` : [C {U64, U8}, C Str] = lowlevel ListGetUnsafe `#UserApp.in` `#UserApp.11`;
        inc `#UserApp.alone`;
        dec `#UserApp.in`;
        let `#UserApp.9` : List [C {U64, U8}, C Str] = Array [`#UserApp.alone`];
        jump `#UserApp.8` `#UserApp.9`;
    else
        jump `#UserApp.8` `#UserApp.in`;
</code></pre></div>
<p>After drop specialization ir is incorrect cause it is missing the increment of <code>#UserApp.alone</code>. For lists, there should not longer be a difference between <code>dec</code> and <code>decref</code> or at least, that is my understanding of how my PR changes things, but drop specialization (some other pass after refcounting) doesn't know that....Though maybe there should still be a difference... Cause we could save on the increment here if there was a difference.</p>
<div class="codehilite"><pre><span></span><code>procedure : `#UserApp.main` Str
procedure = `#UserApp.main` ():
    let `#UserApp.16` : U8 = 100i64;
    let `#UserApp.15` : List U8 = Array [`#UserApp.16`];
    let `#UserApp.inStr` : [C {U64, U8}, C Str] = CallByName `Str.fromUtf8` `#UserApp.15`;
    let `#UserApp.in` : List [C {U64, U8}, C Str] = Array [`#UserApp.inStr`];
    joinpoint `#UserApp.8` `#UserApp.out`:
        let `#UserApp.7` : U64 = CallByName `List.len` `#UserApp.out`;
        dec `#UserApp.out`;
        let `#UserApp.6` : Str = CallByName `Num.toStr` `#UserApp.7`;
        ret `#UserApp.6`;
    in
    let `#UserApp.12` : U64 = lowlevel ListLenUsize `#UserApp.in`;
    let `#UserApp.13` : U64 = 1i64;
    let `#UserApp.14` : Int1 = lowlevel Eq `#UserApp.12` `#UserApp.13`;
    if `#UserApp.14` then
        let `#UserApp.11` : U64 = 0i64;
        let `#UserApp.alone` : [C {U64, U8}, C Str] = lowlevel ListGetUnsafe `#UserApp.in` `#UserApp.11`;
        decref `#UserApp.in`;
        let `#UserApp.9` : List [C {U64, U8}, C Str] = Array [`#UserApp.alone`];
        jump `#UserApp.8` `#UserApp.9`;
    else
        jump `#UserApp.8` `#UserApp.in`;
</code></pre></div>



<a name="451652170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451652170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451652170">(Jul 15 2024 at 23:56)</a>:</h4>
<p>Thinking about this more, I don't think there can be this optimization anymore. Cause decrementing the list may be freeing tail elements that are in the capacity of the ilst but not in the specific slice being freed. So while it may be correct for the slice elements, it won't be correct for the underlying elements.</p>



<a name="451652179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451652179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451652179">(Jul 15 2024 at 23:56)</a>:</h4>
<p>So I think I just need to block this optimization.</p>



<a name="451652225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451652225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451652225">(Jul 15 2024 at 23:57)</a>:</h4>
<p>I guess it could still be allowed if there was some sort of check on slice vs list though.</p>



<a name="451652259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451652259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451652259">(Jul 15 2024 at 23:57)</a>:</h4>
<p>cc: <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> in case he has any comments around this optimization and how it maps to the new list refcounting</p>



<a name="451652804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451652804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451652804">(Jul 16 2024 at 00:02)</a>:</h4>
<p>Oh, I think this optimization may only apply to lists with known lengths. So maybe we can make it safe.</p>



<a name="451653841"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451653841" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451653841">(Jul 16 2024 at 00:11)</a>:</h4>
<p>Ok. I think I have a fix</p>



<a name="451654274"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451654274" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451654274">(Jul 16 2024 at 00:16)</a>:</h4>
<p>If anyone has thoughts on drop specialization for lists, left a big todo with info on the refcounting change. Currently just disabled it, but not sure if it should be fully removed or not: <a href="https://github.com/roc-lang/roc/pull/6907/files#r1678554981">https://github.com/roc-lang/roc/pull/6907/files#r1678554981</a> (extra context in todo right above comment)</p>



<a name="451656856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451656856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451656856">(Jul 16 2024 at 00:43)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="463199">@J.Teeuwissen</span> who worked on drop specialization</p>



<a name="451656987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451656987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451656987">(Jul 16 2024 at 00:44)</a>:</h4>
<p>Test results for <a href="https://github.com/roc-lang/roc/pull/6907">https://github.com/roc-lang/roc/pull/6907</a> using</p>
<ul>
<li><code>ROC=roc EXAMPLES_DIR=examples/ bash ci/all_tests.sh</code></li>
<li>on commit <code>5dc20e0</code></li>
</ul>
<h3>macos aarch64</h3>
<ul>
<li>basic-cli <strong>refactor-host</strong> <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> </li>
<li>basic-webserver <strong>refactor-host</strong> <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> </li>
</ul>
<h3>linux x64</h3>
<ul>
<li>basic-cli <strong>refactor-host</strong> <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> </li>
<li>basic-webserver <strong>refactor-host</strong> <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span></li>
</ul>



<a name="451658552"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451658552" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451658552">(Jul 16 2024 at 01:00)</a>:</h4>
<p>Ok, I think we are ready for the next steps <span class="user-mention" data-user-id="361169">@Anton</span> </p>
<ol>
<li>a new test nightly for roc</li>
<li>pre-release of basic-cli</li>
<li>release of roc nightly &amp; update examples</li>
<li>latest release of basic-cli &amp; basic-webserver</li>
</ol>
<p>The following platforms have been updated and compatible with these changes;</p>
<ul>
<li>roc-wasm4</li>
<li>basic-ssg <a href="https://github.com/lukewilliamboswell/basic-ssg/releases/tag/0.4.0">latest release</a> </li>
</ul>
<p>The following packages/platforms <em>should</em> be updated at some point soon, not blocking</p>
<ul>
<li><a href="https://github.com/lukewilliamboswell/roc-glue-code-gen">roc-glue-code-gen</a> - to include <a href="https://github.com/roc-lang/roc/pull/6905">impl RocRefcounted for RocResult</a> -- nice to have, but not currently blocking basic-cli or basic-webserver</li>
</ul>



<a name="451688453"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451688453" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451688453">(Jul 16 2024 at 06:21)</a>:</h4>
<p>So, if my understanding of the new lists is correct, a <code>dec</code> of a list does something like this:</p>
<div class="codehilite"><pre><span></span><code>if (unique list)
  dec items
  free list
else
  decref list
</code></pre></div>
<p>If this is the case, <code>inc item; dec list</code> (with list being a singleton), it could be optimized as follows </p>
<div class="codehilite"><pre><span></span><code>if (unique list)
  free list
else
  inc item
  decref list
</code></pre></div>



<a name="451688956"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451688956" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451688956">(Jul 16 2024 at 06:27)</a>:</h4>
<p>Iirc the previous list <code>dec</code> simply decremented all items. I think all drop specializations for lists (with a known length) would have to be updated with a uniqueness check (and free/decref).<br>
I'm not sure how "dead" references factor in, I would assume they do not matter as their reference count should not be touched either way.</p>



<a name="451688989"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451688989" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451688989">(Jul 16 2024 at 06:27)</a>:</h4>
<p>That is correct with the caveat that seamless slices can make it more complex</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">str</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="s">"some super long string that will definitely be allocated"</span>
<span class="nv">list</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="p">[</span><span class="nv">str</span><span class="p">,</span><span class="w"> </span><span class="nv">str</span><span class="p">]</span>
<span class="nv">subList</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">dropFirst</span><span class="w"> </span><span class="mi">1</span>

<span class="err">#</span><span class="w"> </span><span class="nv">keep</span><span class="w"> </span><span class="nv">sublist</span><span class="w"> </span><span class="nv">alive</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">use</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">later</span>
</code></pre></div>
<p>In this case, we are left with 2 allocations. 1 for the Str and 1 for the List.<br>
The Str has a refcount of 2.<br>
The slice has a size of 1, but knows how to get back to the initial allocation so it can free the entire original list.</p>
<p>When <code>subList</code> goes out of scope, it will end up decrementing the refcount to <code>str</code> twice and freeing both it and the underlying list allocation.</p>



<a name="451689302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451689302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451689302">(Jul 16 2024 at 06:31)</a>:</h4>
<p>So more accurate refcount note to add to the code would be:</p>
<div class="codehilite"><pre><span></span><code>if (unique list)
  dec items (this includes all items in the entire allocation, they don&#39;t have to be in the current sublist)
  free list
else
  decref list
</code></pre></div>



<a name="451692266"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451692266" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451692266">(Jul 16 2024 at 06:57)</a>:</h4>
<p>Ah okay. Using the suggested slice/list check would be a simple fix. It would only make sense to drop specialise a slice if the size of the underlying list size is known at <em>compile</em> time. But even then, you would have to inline both the <code>dec</code> for the slice and the <code>dec</code> for the list. (Assuming the slice one calls the list one).</p>



<a name="451693010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451693010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451693010">(Jul 16 2024 at 07:03)</a>:</h4>
<p>Makes sense. Thanks for the info.</p>



<a name="451801846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451801846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451801846">(Jul 16 2024 at 16:21)</a>:</h4>
<blockquote>
<p>linux x64  basic-cli <strong>refactor-host</strong> <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> </p>
</blockquote>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> did you run this inside nix?<br>
I'm now hitting:</p>
<div class="codehilite"><pre><span></span><code>❯ ./examples/args div -n 5 -d 20
free(): invalid next size (fast)
Aborted (core dumped)
</code></pre></div>



<a name="451802906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451802906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451802906">(Jul 16 2024 at 16:25)</a>:</h4>
<p>Did you delete and rebuild the host for surgical linking? I think we hit that as well if the surgical linker pulled in the old host (should pass with --linker=legacy` or if the surgical linker host is properly rebuilt</p>



<a name="451805365"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/Implement%20RocRefcounted%20for%20RocResult/near/451805365" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/Implement.20RocRefcounted.20for.20RocResult.html#451805365">(Jul 16 2024 at 16:33)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> <span aria-label="heart" class="emoji emoji-2764" role="img" title="heart">:heart:</span> <br>
that fixed it :)</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
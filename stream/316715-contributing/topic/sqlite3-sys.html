<html>
<head><meta charset="utf-8"><title>sqlite3-sys · contributing · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/index.html">contributing</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html">sqlite3-sys</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="491116485"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491116485" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491116485">(Dec 28 2024 at 20:02)</a>:</h4>
<p>So I was looking at the sqlite3 issues that basic-webserver hit with sqlite3-sys: <a href="https://github.com/roc-lang/basic-webserver/pull/82">https://github.com/roc-lang/basic-webserver/pull/82</a></p>



<a name="491116522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491116522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491116522">(Dec 28 2024 at 20:03)</a>:</h4>
<p>I think the root issue is just that the <code>sqlite</code> crate does not bundle sqlite, but when switching to <code>sqlite-sys</code>, we switched to bundling sqlite</p>



<a name="491116534"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491116534" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491116534">(Dec 28 2024 at 20:03)</a>:</h4>
<p>So everything probably would work if we just reloaded everything but avoided bundling sqlite</p>



<a name="491116542"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491116542" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491116542">(Dec 28 2024 at 20:03)</a>:</h4>
<p>That said, I still want to look into if we can bundle sqlite somehow cause that is nicer overall.</p>



<a name="491116620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491116620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491116620">(Dec 28 2024 at 20:05)</a>:</h4>
<p>Also, when we tried just disabling default features, that failed cause that leads to neither bundling or linking sqlite3. We needed to switch to the <code>linkage</code> feature if we wanted to link instead of bundle.</p>



<a name="491116742"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491116742" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491116742">(Dec 28 2024 at 20:07)</a>:</h4>
<p>As a note, if we can't get <code>sqlite3-sys</code> to work bundled, we can also try <code>libsqlite3-sys</code> (that is what <code>rusqlite</code> uses and maintains)</p>



<a name="491116751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491116751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491116751">(Dec 28 2024 at 20:07)</a>:</h4>
<p>Just collecting info on all of this now</p>



<a name="491118596"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491118596" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491118596">(Dec 28 2024 at 20:38)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> is the current path for basic cli to just manually implement glue and have the <code>roc_*</code> crates implement what they use. So <code>roc_file</code> implements all file related types. <code>roc_sqlite</code> will implement all sqlite related types.</p>



<a name="491121361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491121361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491121361">(Dec 28 2024 at 21:25)</a>:</h4>
<p>Yeah, that's what I've been trying... no idea if it's the best way, just the first thing I thought of.</p>



<a name="491121387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491121387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491121387">(Dec 28 2024 at 21:25)</a>:</h4>
<p>I tried to group them into crates that basic-webserver and basic-ssg would need. Sqlite would definitely be its own I think.</p>



<a name="491123812"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491123812" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491123812">(Dec 28 2024 at 22:06)</a>:</h4>
<p>SG</p>



<a name="491123818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491123818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491123818">(Dec 28 2024 at 22:06)</a>:</h4>
<p>Hopefully will have a PR soon</p>



<a name="491130032"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491130032" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491130032">(Dec 29 2024 at 00:03)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> What do I need to do to make sure my <a href="https://github.com/roc-lang/basic-cli/pull/299">new PR for sqlite</a> doesn't <a href="https://github.com/roc-lang/roc/pull/7241">break releasing</a>?</p>
<p>Do I just need to attempt to build with musl?</p>



<a name="491131006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131006">(Dec 29 2024 at 00:20)</a>:</h4>
<p>You could make a new tag on the webserver repo,  and then make a new PR just like that release one, and just build a new release. It wont upload any files, that is done manually by Anton</p>



<a name="491131020"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131020" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131020">(Dec 29 2024 at 00:20)</a>:</h4>
<p>Or the basic-cli repo... whichever you are more interested in</p>



<a name="491131044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131044">(Dec 29 2024 at 00:21)</a>:</h4>
<p>If it passes CI in roc-lang/roc then you know it's all good</p>



<a name="491131210"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131210" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131210">(Dec 29 2024 at 00:24)</a>:</h4>
<p>To tag, I'll need to merge into main, right? So I guess first I need to land in basic cli. Then will make a test release to make sure everything is working in basic-cli. If not, will iterate.</p>



<a name="491131221"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131221" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131221">(Dec 29 2024 at 00:24)</a>:</h4>
<p>No I don't think you need it on main</p>



<a name="491131223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131223">(Dec 29 2024 at 00:24)</a>:</h4>
<p>Just a tag -- in the remote (roc-lang/basic-cli) repo</p>



<a name="491131229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131229">(Dec 29 2024 at 00:24)</a>:</h4>
<p>Oh, ok</p>



<a name="491131260"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131260" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131260">(Dec 29 2024 at 00:25)</a>:</h4>
<p>We can delete the tag afterwards, it's just so the CI runners checkout the correct branch/commit</p>



<a name="491131505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131505">(Dec 29 2024 at 00:30)</a>:</h4>
<p>Makes sense</p>



<a name="491131738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491131738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491131738">(Dec 29 2024 at 00:34)</a>:</h4>
<p>kicked off here: <a href="https://github.com/roc-lang/roc/actions/runs/12530963666/job/34948060619?pr=7428">https://github.com/roc-lang/roc/actions/runs/12530963666/job/34948060619?pr=7428</a></p>
<p>I think it should build. Though won't be fully functional until <a href="https://github.com/roc-lang/roc/issues/7427">#7427</a> lands and is pulled in</p>



<a name="491140761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491140761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491140761">(Dec 29 2024 at 03:09)</a>:</h4>
<p>I feel really close here for the release. Only issue is on linux arm64 with musl. I think the issue is that <code>cc</code> is compiling for <code>glibc</code> instead of <code>musl</code> for some reason. And an old version of glibc at that. As such, it is generating a call to <code>fcntl64</code> which no longer exists. It is just <code>fcntl</code> now.</p>



<a name="491140828"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491140828" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491140828">(Dec 29 2024 at 03:10)</a>:</h4>
<p>Maybe I can just update glibc on the system. Maybe there is some config I can set to get the c properly building targeting musl libc.</p>



<a name="491142354"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491142354" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491142354">(Dec 29 2024 at 03:38)</a>:</h4>
<blockquote>
<p>Only issue is on linux arm64 with musl</p>
</blockquote>
<p>It's not building against musl though is it?</p>



<a name="491142373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491142373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491142373">(Dec 29 2024 at 03:38)</a>:</h4>
<p>It's just running <code>+ cargo build --release</code> on the native linux arm64</p>



<a name="491142389"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491142389" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491142389">(Dec 29 2024 at 03:39)</a>:</h4>
<p>(deleted)</p>



<a name="491142410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491142410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491142410">(Dec 29 2024 at 03:39)</a>:</h4>
<p>Maybe we could try building against the musl target</p>



<a name="491142501"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491142501" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491142501">(Dec 29 2024 at 03:41)</a>:</h4>
<p>So instead we do <code>cargo build --release --target aarch64-unknown-linux-musl</code>?</p>



<a name="491142772"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491142772" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491142772">(Dec 29 2024 at 03:46)</a>:</h4>
<p>Ignore my last, looking at the actual workflow in <code>.github/workflows/basic_cli_build_release.yml</code> we can see</p>
<div class="codehilite"><pre><span></span><code>- name: build basic-cli
        env:
          CARGO_BUILD_TARGET: aarch64-unknown-linux-musl
          CC_aarch64_unknown_linux_musl: clang-18
          AR_aarch64_unknown_linux_musl: llvm-ar-18
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_RUSTFLAGS: &quot;-Clink-self-contained=yes -Clinker=rust-lld&quot;
        run: ./ci/build_basic_cli.sh linux_arm64
</code></pre></div>



<a name="491142779"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491142779" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491142779">(Dec 29 2024 at 03:46)</a>:</h4>
<p>Yeah, I can test that. Though it should be building against musl due to the environment variable <code>CARGO_BUILD_TARGET: aarch64-unknown-linux-musl</code></p>



<a name="491143125"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491143125" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491143125">(Dec 29 2024 at 03:53)</a>:</h4>
<p>I wonder how far we are from fully statically linked... and if that effort would also help us here?</p>



<a name="491143918"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491143918" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491143918">(Dec 29 2024 at 04:05)</a>:</h4>
<p>Also, in the final link command, I see a bunch of <code>aarch64-unknown-linux-gnu</code>. So I guess that <code>CARGO_BUILD_TARGET</code> is not enough</p>



<a name="491144230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491144230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491144230">(Dec 29 2024 at 04:10)</a>:</h4>
<p><del>I think I see the issue... in <a href="https://github.com/roc-lang/roc/blob/main/ci/build_basic_cli.sh">build_basic_cli.sh</a></del> ... hmm, actually I'm not sure</p>



<a name="491144348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491144348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491144348">(Dec 29 2024 at 04:12)</a>:</h4>
<p>I just pushed something to set <code>--target</code> as well. We'll see if it works.</p>



<a name="491144430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491144430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491144430">(Dec 29 2024 at 04:14)</a>:</h4>
<p>Might be helpful to <code>echo $CARGO_BUILD_TARGET</code> in there too somewhere so we can see what's getting to that point</p>



<a name="491144457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491144457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491144457">(Dec 29 2024 at 04:15)</a>:</h4>
<p>Also in <code>build.roc</code> we might need to do something... I think that gets called as well</p>



<a name="491144519"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491144519" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491144519">(Dec 29 2024 at 04:16)</a>:</h4>
<p>So I wonder if the call to <code>roc build.roc</code> in <code>ci/build_basic_cli.sh</code> is passing the <code>CARGO_BUILD_TARGET</code> env var down</p>



<a name="491144525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491144525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491144525">(Dec 29 2024 at 04:16)</a>:</h4>
<p>There's two layers of shells there</p>



<a name="491144935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491144935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491144935">(Dec 29 2024 at 04:25)</a>:</h4>
<p>I'm not sure, but currently we are failing in the <code>cargo build --release</code> of <code>jumpstart.sh</code> from basic-cli</p>



<a name="491146677"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491146677" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491146677">(Dec 29 2024 at 04:56)</a>:</h4>
<p>can now see: <code>+ cargo build --release --target aarch64-unknown-linux-musl</code></p>
<p>Yet still failing while linking to stuff in <code>1.82.0-aarch64-unknown-linux-gnu</code></p>



<a name="491146684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491146684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491146684">(Dec 29 2024 at 04:57)</a>:</h4>
<p>Feels like I am missing some sort of linker config to update to <code>musl</code></p>



<a name="491146966"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491146966" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491146966">(Dec 29 2024 at 05:00)</a>:</h4>
<p>Testing now with <code>rust-lld</code> disabled, maybe that is the issue</p>



<a name="491147668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491147668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491147668">(Dec 29 2024 at 05:11)</a>:</h4>
<p>That didn't help. Though it did give a slightly different form of the error. Some minor context from searching it:</p>
<blockquote>
<p>No worries. I found out it was eventually a problem with incompatible versions of glib for cross-compilation. I would assume you cross-compiled on &lt;= Ubuntu 18 with GLIB 2.27 which is strictly not-forward compatible with GLIB2.28 on the Raspbian (Debian Buster). Faintly recalling, they have changed the header for fcntl64 to a macro in the latest version of GLIB.</p>
</blockquote>



<a name="491147729"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491147729" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491147729">(Dec 29 2024 at 05:12)</a>:</h4>
<p>given we are building with musl, idk why we are hitting glibc errors, but I wonder if we can just update glibc on the pi</p>



<a name="491147746"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491147746" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491147746">(Dec 29 2024 at 05:13)</a>:</h4>
<p>cc: <span class="user-mention" data-user-id="361169">@Anton</span> in case you have ideas</p>



<a name="491147764"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491147764" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491147764">(Dec 29 2024 at 05:13)</a>:</h4>
<p>If this doesn't pan out, eventually I'll give in and switch to linking sqlite instead of bundling it, but it would be nicer to bundle it if possible.</p>



<a name="491148744"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491148744" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491148744">(Dec 29 2024 at 05:33)</a>:</h4>
<p>Does the build target set CC? <a href="https://github.com/stainless-steel/sqlite3-src/blob/7704dc7f0842ba2708dfcc8baa2a526dc0730020/build.rs#L5">https://github.com/stainless-steel/sqlite3-src/blob/7704dc7f0842ba2708dfcc8baa2a526dc0730020/build.rs#L5</a></p>



<a name="491150071"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150071" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150071">(Dec 29 2024 at 05:58)</a>:</h4>
<p><a href="https://docs.rs/cc/latest/cc/">https://docs.rs/cc/latest/cc/</a></p>



<a name="491150225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150225">(Dec 29 2024 at 06:00)</a>:</h4>
<p>The <code>CC</code> environment variable is set to <code>clang-18</code></p>



<a name="491150259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150259">(Dec 29 2024 at 06:01)</a>:</h4>
<p>We could try setting <code>CC_ENABLE_DEBUG_OUTPUT</code></p>



<a name="491150261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150261">(Dec 29 2024 at 06:01)</a>:</h4>
<p>I think clang should support musl. Nothing fails until the final link step</p>



<a name="491150277"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150277" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150277">(Dec 29 2024 at 06:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150259">said</a>:</p>
<blockquote>
<p>We could try setting <code>CC_ENABLE_DEBUG_OUTPUT</code></p>
</blockquote>
<p>I tried, didn't see any extra output in CI.</p>



<a name="491150424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150424">(Dec 29 2024 at 06:03)</a>:</h4>
<p><a href="https://github.com/rust-lang/cc-rs/issues/1251">https://github.com/rust-lang/cc-rs/issues/1251</a> maybe?</p>



<a name="491150833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150833">(Dec 29 2024 at 06:10)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> </p>
<p>Mind if I try adding this to <code>.cargo/config.toml</code>?</p>
<div class="codehilite"><pre><span></span><code>[target.aarch64-unknown-linux-musl]
linker = &quot;aarch64-linux-musl-gcc&quot;
rustflags = [&quot;-C&quot;, &quot;target-feature=+crt-static&quot;]

[profile.release]
lto = true
codegen-units = 1
panic = &quot;abort&quot;
</code></pre></div>



<a name="491150962"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150962" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150962">(Dec 29 2024 at 06:13)</a>:</h4>
<p>Oh, interesting, disabled clang as the default cc and it is looking for <code>aarch64-linux-musl-gcc</code>. This feels relevant. Maybe clang doesn't correctly support musl and thus is leading to still linking glibc. Sadly, even though <code>musl-tools</code> should be installed, <code>aarch64-linux-musl-gcc</code> is not found.</p>



<a name="491150969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491150969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491150969">(Dec 29 2024 at 06:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/316715-contributing/topic/sqlite3-sys/near/491150833">said</a>:</p>
<blockquote>
<p>Mind if I try adding this to <code>.cargo/config.toml</code>?</p>
</blockquote>
<p>go for it</p>



<a name="491151029"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491151029" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491151029">(Dec 29 2024 at 06:14)</a>:</h4>
<p>Do you think we need these flags? <code>"-Clink-self-contained=yes -Clinker=rust-lld"</code></p>



<a name="491151044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491151044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491151044">(Dec 29 2024 at 06:14)</a>:</h4>
<p>Maybe using <code>rust-lld</code> is better if we know it's available</p>



<a name="491151054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491151054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491151054">(Dec 29 2024 at 06:14)</a>:</h4>
<p>To my understanding <code>link-self-contained=yes</code> should be default with musl and <code>linker=rust-lld</code> should lead to faster linking</p>



<a name="491151066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491151066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491151066">(Dec 29 2024 at 06:15)</a>:</h4>
<p>So neither should be needed.</p>



<a name="491151084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491151084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491151084">(Dec 29 2024 at 06:15)</a>:</h4>
<p>Feel free to push to either branch and update the tag if needed. I am gonna log off for the night</p>



<a name="491195916"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491195916" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491195916">(Dec 29 2024 at 18:06)</a>:</h4>
<p>From more reading, it sounds like rust just tends to hit toolchain issues when compiling for <code>aarch64-unknown-linux-musl</code> (looks to even happen from time to time with x86_64 musl). My best guess is that rust does not actually correctly enable the toolchain. Scouring the web, there are a mix of various linking and compilation issues that are regularly hit with this musl.</p>
<p>I am currently testing a workaround that someone claimed work for sqlite: <a href="https://github.com/briansmith/ring/issues/1414#issuecomment-1596300080">https://github.com/briansmith/ring/issues/1414#issuecomment-1596300080</a></p>
<p>That said, it sounds like the only sure-fire way to get rust to compile for <code>aarch64-unknown-linux-musl</code> is to use <a href="https://github.com/cross-rs/cross">cross</a>. I guess musl is different enough that it is best to fully isolate the toolchain to make it work correctly. So we may want to start using <code>cross</code> for all of our <code>musl</code> builds.</p>



<a name="491196928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491196928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491196928">(Dec 29 2024 at 18:21)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/actions/runs/12537623092/job/34961921175?pr=7428">Workaround is functional</a>. This means the fundamental issue was from mixed toolchains (pulling in some stuff from gnu and some from musl). I think that we should eventually change all of our musl builds to use <a href="https://github.com/cross-rs/cross">cross</a> to completely rule out this class of issues.</p>



<a name="491197022"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491197022" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491197022">(Dec 29 2024 at 18:23)</a>:</h4>
<p>Anyway, this should mean we are good to land <a href="https://github.com/roc-lang/basic-cli/pull/299">https://github.com/roc-lang/basic-cli/pull/299</a> with bundled sqlite.</p>



<a name="491197043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491197043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491197043">(Dec 29 2024 at 18:23)</a>:</h4>
<p>We can figure out moving to <code>cross</code> in a separate PR. The workaround is functional and can be used for whenever the next release is.</p>



<a name="491197351"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/316715-contributing/topic/sqlite3-sys/near/491197351" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/316715-contributing/topic/sqlite3-sys.html#491197351">(Dec 29 2024 at 18:28)</a>:</h4>
<p>And just to post this here to perserve it, this is the fundamental part of the workaround. Ensure clang does not pull in the default glibc and instead pulls in the musl version:<br>
<code>CFLAGS_aarch64_unknown_linux_musl: "-nostdinc -nostdlib -isystem/usr/include/aarch64-linux-musl/"</code></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Lossy unicode conversion builtins · API design · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/index.html">API design</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html">Lossy unicode conversion builtins</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="489582492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489582492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489582492">(Dec 17 2024 at 22:24)</a>:</h4>
<p>How does the team feel about having these functions in std:</p>
<ul>
<li><code>Str.from_utf8 : List U8 -&gt; Result Str { err : InvalidUnicodeErr, index : U64 }</code></li>
<li><code>Str.from_utf8_lossy : List U8 -&gt; Str</code></li>
<li><code>Str.from_utf16 : List U16 -&gt; Result Str { err : InvalidUnicodeErr, index : U64 }</code></li>
<li><code>Str.from_utf16_lossy : List U16 -&gt; Str</code></li>
</ul>



<a name="489582572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489582572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489582572">(Dec 17 2024 at 22:25)</a>:</h4>
<p>The <code>*_lossy</code> functions should replace invalid chars with the <a href="https://www.compart.com/en/unicode/U+FFFD">replacement char</a></p>



<a name="489583218"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583218" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583218">(Dec 17 2024 at 22:31)</a>:</h4>
<p>Note -- are you tacking <a href="https://github.com/roc-lang/roc/pull/7321">https://github.com/roc-lang/roc/pull/7321</a></p>



<a name="489583252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583252">(Dec 17 2024 at 22:31)</a>:</h4>
<div class="codehilite"><pre><span></span><code>Str.fromUtf8 : List U8 -&gt; Result Str [BadUtf8 { problem : Utf8ByteProblem, index : U64 }]
</code></pre></div>



<a name="489583396"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583396" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583396">(Dec 17 2024 at 22:32)</a>:</h4>
<p>The tag's unify nicer with other tag based errors -- for when your doing the "just pass it up the chain" thing</p>



<a name="489583471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583471">(Dec 17 2024 at 22:33)</a>:</h4>
<p>Oh yeah, the tag is good</p>



<a name="489583591"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583591" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583591">(Dec 17 2024 at 22:34)</a>:</h4>
<p>So I'd add...</p>
<div class="codehilite"><pre><span></span><code>Str.from_utf16 : List U16 -&gt; Result Str [BadUtf16 { problem : Utf16ByteProblem, index : U64 }]
</code></pre></div>



<a name="489583629"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583629" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583629">(Dec 17 2024 at 22:34)</a>:</h4>
<p>Yes</p>



<a name="489583672"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583672" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583672">(Dec 17 2024 at 22:34)</a>:</h4>
<p>I'll be quite honest: I didn't try to make the error types useful</p>



<a name="489583685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583685">(Dec 17 2024 at 22:35)</a>:</h4>
<p>Thanks for thinking for me</p>



<a name="489583706"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583706" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583706">(Dec 17 2024 at 22:35)</a>:</h4>
<p>I think if Anton was here, he'd ask for a PR to merge into that PR. He's planning on making a testing release I think</p>



<a name="489583720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583720">(Dec 17 2024 at 22:35)</a>:</h4>
<p>Instead of lossy, do we want with replacement? Then just expose the default replacement character?</p>



<a name="489583783"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583783" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583783">(Dec 17 2024 at 22:36)</a>:</h4>
<p>Maybe that isn't valuable or worth it, just curious. Have seen that API before</p>



<a name="489583827"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583827" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583827">(Dec 17 2024 at 22:36)</a>:</h4>
<p>If you're opt-ing into quick and dirty... you want minimal friction</p>



<a name="489583869"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583869" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583869">(Dec 17 2024 at 22:36)</a>:</h4>
<p>I'm just not sure what the replacement API would look like</p>



<a name="489583872"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583872" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583872">(Dec 17 2024 at 22:36)</a>:</h4>
<p>I guess you can always use lossy and the call replace separately to change the replacement char</p>



<a name="489583887"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583887" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583887">(Dec 17 2024 at 22:36)</a>:</h4>
<p>We definitely should expose the replacement char though</p>



<a name="489583911"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583911" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583911">(Dec 17 2024 at 22:36)</a>:</h4>
<p>We don't have a <code>char</code> type, so what if they pass an invalid UTF-8 char?</p>



<a name="489583914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583914">(Dec 17 2024 at 22:36)</a>:</h4>
<p>I have to google it every time</p>



<a name="489583947"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583947" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583947">(Dec 17 2024 at 22:37)</a>:</h4>
<p>"\u(FFFD)"</p>



<a name="489583992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489583992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489583992">(Dec 17 2024 at 22:37)</a>:</h4>
<p>Also, might as well add in utf32 while we're here?</p>



<a name="489584068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584068">(Dec 17 2024 at 22:38)</a>:</h4>
<p><code>Str.from_utf8_with_replacement : List U8, { replacement_char ? Str } -&gt; Str</code></p>



<a name="489584143"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584143" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584143">(Dec 17 2024 at 22:38)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins/near/489583827">said</a>:</p>
<blockquote>
<p>If you're opt-ing into quick and dirty... you want minimal friction</p>
</blockquote>
<p>Very true. I'm happy with just lossy.</p>



<a name="489584151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584151">(Dec 17 2024 at 22:38)</a>:</h4>
<p>What if they call <code>Str.from_utf8_with_replacement(bytes, "not-a-char")</code></p>



<a name="489584229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584229">(Dec 17 2024 at 22:39)</a>:</h4>
<p>Yeah, let's just leave it as lossy and let them separately call <code>Str.replace</code> separately to change the character</p>



<a name="489584472"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584472" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584472">(Dec 17 2024 at 22:41)</a>:</h4>
<p>One thought I have (unrelated to design stuff, more scheduling), is any of this going to block our current upgrade. I'd like to land the new PI basic-cli this week. I think we can just make <code>Arg : [Unix (List U16, Windows (List U16)]</code> and land the Weaver and these builtin upgrades later. </p>
<p>If we just make an issue for these Lossy strings additions, we can track it.</p>



<a name="489584482"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584482" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584482">(Dec 17 2024 at 22:41)</a>:</h4>
<p>So:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf8</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">[</span><span class="kt">BadUtf8</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Utf8ByteProblem</span><span class="p">,</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="w"> </span><span class="p">}]</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf8_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf16</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U16</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">[</span><span class="kt">BadUtf16</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Utf16ByteProblem</span><span class="p">,</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="w"> </span><span class="p">}]</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf16_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U16</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf32</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U32</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">[</span><span class="kt">BadUtf32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Utf32ByteProblem</span><span class="p">,</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="w"> </span><span class="p">}]</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf32_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U32</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
</code></pre></div>



<a name="489584626"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584626" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584626">(Dec 17 2024 at 22:43)</a>:</h4>
<p>Potentially merging the error tag of it makes sense</p>



<a name="489584643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584643">(Dec 17 2024 at 22:43)</a>:</h4>
<p>Let's do Arg, and I'll try to get a PR for these functions by tomorrow. If I can't do it in time, we can do it later</p>



<a name="489584661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489584661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489584661">(Dec 17 2024 at 22:43)</a>:</h4>
<p>Adding new functions isn't breaking</p>



<a name="489614819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489614819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489614819">(Dec 18 2024 at 03:59)</a>:</h4>
<p>I feel like we should drop “Byte” from the utf16/32 error tags. It’s not just one byte for those <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="489620671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489620671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489620671">(Dec 18 2024 at 05:05)</a>:</h4>
<p>Works for me!</p>



<a name="489806520"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489806520" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489806520">(Dec 18 2024 at 17:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="489294">Agus Zubiaga</span> <a href="#narrow/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins/near/489614819">said</a>:</p>
<blockquote>
<p>I feel like we should drop “Byte” from the utf16/32 error tags. It’s not just one byte for those <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>
</blockquote>
<p>Can we drop it off all tags?</p>



<a name="489806589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489806589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489806589">(Dec 18 2024 at 17:21)</a>:</h4>
<p>You have a list of u8s and and index</p>



<a name="489806630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489806630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489806630">(Dec 18 2024 at 17:21)</a>:</h4>
<p>I think anyone can figure out that is a problem with a specific byte</p>



<a name="489806703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489806703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489806703">(Dec 18 2024 at 17:21)</a>:</h4>
<p>Though I still in the camp that if possible, we should just have a single UnicodeError</p>



<a name="489806776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489806776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489806776">(Dec 18 2024 at 17:22)</a>:</h4>
<p>Or UtfError</p>



<a name="489808480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489808480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489808480">(Dec 18 2024 at 17:31)</a>:</h4>
<p>(deleted)</p>



<a name="489808489"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489808489" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489808489">(Dec 18 2024 at 17:31)</a>:</h4>
<p>For naming, I'd prefer <code>Err [InvalidUtf*]</code> over <code>Err [Utf*Error]</code> (whether it's 8/16/generic) - <code>Bad</code> is fine too.</p>



<a name="489815338"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489815338" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489815338">(Dec 18 2024 at 18:12)</a>:</h4>
<p>Good call</p>



<a name="489896317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489896317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489896317">(Dec 19 2024 at 06:48)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/issues/7390">https://github.com/roc-lang/roc/issues/7390</a></p>



<a name="489896347"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489896347" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489896347">(Dec 19 2024 at 06:48)</a>:</h4>
<p>If someone could validate that issue, that'd be great</p>



<a name="489896377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489896377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489896377">(Dec 19 2024 at 06:48)</a>:</h4>
<p>Luke and I will be getting the APIs in place for basic-cli and Weaver, respectively</p>



<a name="489896475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489896475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489896475">(Dec 19 2024 at 06:49)</a>:</h4>
<p>Which means creating an <code>Arg := [Unix (List U8), Windows (List U16)]</code> type and just crashing on <code>Windows</code> for now. Once these are implemented, it should be a simple change to properly support 16-bit encoded strings in <code>basic-cli</code> and Weaver</p>



<a name="489900176"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489900176" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489900176">(Dec 19 2024 at 07:20)</a>:</h4>
<p>Why the redundancy of Bad+Invalid in <code>[BadUtf8 { err : InvalidUtf8, index : U64 }]</code>?</p>



<a name="489900739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489900739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489900739">(Dec 19 2024 at 07:25)</a>:</h4>
<p>Is <code>[InvalidUtf8 { index : U64 }]</code> sufficient? (Happy to Q&amp;A in GH thread, if you'd prefer.)</p>



<a name="489900889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489900889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489900889">(Dec 19 2024 at 07:27)</a>:</h4>
<p>I also prefer Zulip, it's more back and forth</p>



<a name="489900936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489900936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489900936">(Dec 19 2024 at 07:27)</a>:</h4>
<p>The error holds info about why the UTF was encoded incorrectly</p>



<a name="489900954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489900954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489900954">(Dec 19 2024 at 07:27)</a>:</h4>
<p>It's a tag union</p>



<a name="489901017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489901017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489901017">(Dec 19 2024 at 07:28)</a>:</h4>
<p>Ohhh I forget those sneaky invisible payloads exist, thanks.</p>



<a name="489901424"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489901424" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489901424">(Dec 19 2024 at 07:31)</a>:</h4>
<p>When I mentioned naming above, I was ignorant to these tag union(s) already existing, and they seem fine as-is. Does this issue intend to refactor <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/builtins/roc/Str.roc#L379-L388">this existing pattern</a> from Problem+ByteProblem to Bad+Invalid? (Sorry if I'm bikeshedding this away from implementation concerns.)</p>
<div class="codehilite" data-code-language="Perl"><pre><span></span><code><span class="n">Utf8ByteProblem</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="n">InvalidStartByte</span><span class="p">,</span>
<span class="w">    </span><span class="n">UnexpectedEndOfSequence</span><span class="p">,</span>
<span class="w">    </span><span class="n">ExpectedContinuation</span><span class="p">,</span>
<span class="w">    </span><span class="n">OverlongEncoding</span><span class="p">,</span>
<span class="w">    </span><span class="n">CodepointTooLarge</span><span class="p">,</span>
<span class="w">    </span><span class="n">EncodesSurrogateHalf</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">Utf8Problem</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">byteIndex</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">U64</span><span class="p">,</span><span class="w"> </span><span class="n">problem</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Utf8ByteProblem</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>



<a name="489902668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489902668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489902668">(Dec 19 2024 at 07:42)</a>:</h4>
<p>That PR you linked seems to want <code>[BadUtf* { problem : Utf*ByteProblem, index : U64 }]</code></p>



<a name="489902942"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489902942" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489902942">(Dec 19 2024 at 07:44)</a>:</h4>
<p>If <a href="https://github.com/roc-lang/roc/issues/7390">#7390</a> intends to be ambivalent on Err structure, then please ignore everything I've said above.</p>



<a name="489985325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489985325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489985325">(Dec 19 2024 at 15:16)</a>:</h4>
<p>Oh yeah let's remove one level of tag nesting</p>



<a name="489985343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489985343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489985343">(Dec 19 2024 at 15:17)</a>:</h4>
<p>It isn't needed</p>



<a name="489985538"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/489985538" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#489985538">(Dec 19 2024 at 15:18)</a>:</h4>
<p>Directly return a <code>Result Str { byteIndex : U64, problem : Utf8ByteProblem }</code></p>



<a name="490060138"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/490060138" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#490060138">(Dec 19 2024 at 22:34)</a>:</h4>
<p><span class="user-mention" data-user-id="722031">@shua</span>  -- it's not urgent or anything... but would you be interested in tackling this? </p>
<p>Here's the tracking issue from Sam <a href="https://github.com/roc-lang/roc/issues/7390">https://github.com/roc-lang/roc/issues/7390</a></p>



<a name="491131222"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131222" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131222">(Dec 29 2024 at 00:24)</a>:</h4>
<p>I can pick this up. Should I merge it into <a href="https://github.com/roc-lang/roc/pull/7321">https://github.com/roc-lang/roc/pull/7321</a> or a separate PR?</p>



<a name="491131225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131225">(Dec 29 2024 at 00:24)</a>:</h4>
<p>Also, would the preference be for 3 separate tag sets (<code>Utf8ByteProblem</code>, <code>Utf16ByteProblem</code>, and <code>Utf32ByteProblem</code>) or should they all just be <code>UtfDecodingProblem</code> even if some variants aren't possible for utf16/utf32?</p>



<a name="491131527"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131527" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131527">(Dec 29 2024 at 00:31)</a>:</h4>
<p>I think it's ok to merge it into your PR</p>



<a name="491131614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131614">(Dec 29 2024 at 00:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="722031">shua</span> <a href="#narrow/channel/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins/near/491131225">said</a>:</p>
<blockquote>
<p>Also, would the preference be for 3 separate tag sets (<code>Utf8ByteProblem</code>, <code>Utf16ByteProblem</code>, and <code>Utf32ByteProblem</code>) or should they all just be <code>UtfDecodingProblem</code> even if some variants aren't possible for utf16/utf32?</p>
</blockquote>
<p>I'm not quite following this...</p>



<a name="491131631"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131631" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131631">(Dec 29 2024 at 00:32)</a>:</h4>
<p>Is this in the Issue?</p>
<div class="codehilite"><pre><span></span><code>Str.from_utf8 : List U8 -&gt; Result Str [BadUtf8 { err : InvalidUtf8, index : U64 }]
Str.from_utf8_lossy : List U8 -&gt; Str
Str.from_utf16 : List U16 -&gt; Result Str [BadUtf16 { err : InvalidUtf16, index : U64 }]
Str.from_utf16_lossy : List U16 -&gt; Str
Str.from_utf32 : List U32 -&gt; Result Str [BadUtf32 { err : InvalidUtf32, index : U64 }]
Str.from_utf32_lossy : List U32 -&gt; Str
</code></pre></div>



<a name="491131657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131657">(Dec 29 2024 at 00:32)</a>:</h4>
<p>Ohk, maybe we should update the issue -- nvm</p>
<p>I think I see, the tag union is inside the record right?</p>



<a name="491131776"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131776" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131776">(Dec 29 2024 at 00:35)</a>:</h4>
<p>I'm not sure we need all the different error tags. Just <code>InvalidUtf8</code> would be ok wouldn't it?</p>



<a name="491131890"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131890" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131890">(Dec 29 2024 at 00:37)</a>:</h4>
<p>If possible, should only be a single tag</p>



<a name="491131899"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491131899" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491131899">(Dec 29 2024 at 00:37)</a>:</h4>
<p><code>InvalidUnicode</code> probably</p>



<a name="491132005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132005">(Dec 29 2024 at 00:39)</a>:</h4>
<p>So like this?</p>
<div class="codehilite"><pre><span></span><code>Str.from_utf8 : List U8 -&gt; Result Str [InvalidUnicode { err : [BadUtf8], index : U64 }]
Str.from_utf8_lossy : List U8 -&gt; Str
Str.from_utf16 : List U16 -&gt; Result Str [InvalidUnicode { err : [BadUtf16], index : U64 }]
Str.from_utf16_lossy : List U16 -&gt; Str
Str.from_utf32 : List U32 -&gt; Result Str [InvalidUnicode { err : [BadUtf32], index : U64 }]
Str.from_utf32_lossy : List U32 -&gt; Str
</code></pre></div>



<a name="491132120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132120">(Dec 29 2024 at 00:41)</a>:</h4>
<p>Or maybe</p>
<div class="codehilite"><pre><span></span><code>Str.from_utf8 : List U8 -&gt; Result Str [InvalidUtf8 { index : U64 }]
Str.from_utf8_lossy : List U8 -&gt; Str
Str.from_utf16 : List U16 -&gt; Result Str [InvalidUtf16 { index : U64 }]
Str.from_utf16_lossy : List U16 -&gt; Str
Str.from_utf32 : List U32 -&gt; Result Str [InvalidUtf32 { index : U64 }]
Str.from_utf32_lossy : List U32 -&gt; Str
</code></pre></div>



<a name="491132191"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132191" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132191">(Dec 29 2024 at 00:42)</a>:</h4>
<p>Or </p>
<div class="codehilite"><pre><span></span><code>UnicodeErr : [
    InvalidUtf8 U64,
    InvalidUtf16 U64,
    InvalidUtf32 U64,
]

Str.from_utf8 : List U8 -&gt; Result Str UnicodeErr
Str.from_utf8_lossy : List U8 -&gt; Str
Str.from_utf16 : List U16 -&gt; Result Str UnicodeErr
Str.from_utf16_lossy : List U16 -&gt; Str
Str.from_utf32 : List U32 -&gt; Result Str UnicodeErr
Str.from_utf32_lossy : List U32 -&gt; Str
</code></pre></div>



<a name="491132395"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132395" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132395">(Dec 29 2024 at 00:46)</a>:</h4>
<p>I think like this:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kt">UnicodeProblem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="kt">InvalidStartByte</span><span class="p">,</span>
<span class="w">    </span><span class="kt">UnexpectedEndOfSequence</span><span class="p">,</span>
<span class="w">    </span><span class="kt">ExpectedContinuation</span><span class="p">,</span>
<span class="w">    </span><span class="kt">OverlongEncoding</span><span class="p">,</span>
<span class="w">    </span><span class="kt">CodepointTooLarge</span><span class="p">,</span>
<span class="w">    </span><span class="kt">EncodesSurrogateHalf</span><span class="p">,</span>
<span class="p">]</span>

<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf8</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">[</span><span class="kt">BadUtf8</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="p">,</span><span class="w"> </span><span class="nv">problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">UnicodeProblem</span><span class="w"> </span><span class="p">}]</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf8_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf16</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U16</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">[</span><span class="kt">BadUtf16</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="p">,</span><span class="w"> </span><span class="nv">problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">UnicodeProblem</span><span class="w"> </span><span class="p">}]</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf16_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U16</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf32</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U32</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">[</span><span class="kt">BadUtf32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="p">,</span><span class="w"> </span><span class="nv">problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">UnicodeProblem</span><span class="w"> </span><span class="p">}]</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf32_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U32</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
</code></pre></div>



<a name="491132601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132601">(Dec 29 2024 at 00:50)</a>:</h4>
<p>This all looks good to me, assuming we're okay with providing a superset of the errors we see for all Unicode variants.</p>



<a name="491132614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132614">(Dec 29 2024 at 00:50)</a>:</h4>
<p>I'm not sure what they type of errors we see for UTF-8 vs 16 vs 32</p>



<a name="491132643"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132643" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132643">(Dec 29 2024 at 00:51)</a>:</h4>
<p>It's probably better to provide the actual set of errors per encoding instead of just a single union</p>



<a name="491132713"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132713" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132713">(Dec 29 2024 at 00:52)</a>:</h4>
<p>If we go with a single union, we should maybe aim for naming with respect to codepoints instead of just bytes? Since UTF-16 and 32 don't process bytes</p>



<a name="491132761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132761">(Dec 29 2024 at 00:52)</a>:</h4>
<p>My thought is: if the error set mostly overlaps, then just merge it, if not, then add separate tag unions.</p>



<a name="491132767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132767">(Dec 29 2024 at 00:52)</a>:</h4>
<p>So that is my default to try</p>



<a name="491132807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132807">(Dec 29 2024 at 00:53)</a>:</h4>
<p>If it doesnt work in practice due to disjoint errors, then make <code>Utf8Problem</code>, <code>Utf16Problem</code>, and <code>Utf32Problem</code></p>



<a name="491132925"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491132925" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491132925">(Dec 29 2024 at 00:54)</a>:</h4>
<p>I don't feel strongly in opposition, though I do think it's better for API users to get <code>UTFXXProblem</code>. Either works for me</p>



<a name="491133521"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491133521" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491133521">(Dec 29 2024 at 01:01)</a>:</h4>
<p>Looking at the zig standard library, errors look to be disjoint</p>



<a name="491133581"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491133581" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491133581">(Dec 29 2024 at 01:02)</a>:</h4>
<p>So I think we will have a sepearate <code>Utf8Problem</code>, <code>Utf16Problem</code> and <code>Utf32Problem</code></p>



<a name="491133586"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491133586" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491133586">(Dec 29 2024 at 01:02)</a>:</h4>
<p>Yep</p>



<a name="491134034"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134034" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134034">(Dec 29 2024 at 01:10)</a>:</h4>
<p>Also, it sounds like we actually need to support <a href="https://simonsapin.github.io/wtf-8/#wtf-16">wtf-8 and wtf-16</a> for windows paths.</p>



<a name="491134047"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134047" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134047">(Dec 29 2024 at 01:11)</a>:</h4>
<p>zig does support this, but you have to explicitly tell it to how to handle the utf-16 it is given</p>



<a name="491134050"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134050" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134050">(Dec 29 2024 at 01:11)</a>:</h4>
<p><a href="https://ziglang.org/documentation/0.13.0/std/#std.unicode.Surrogates">https://ziglang.org/documentation/0.13.0/std/#std.unicode.Surrogates</a></p>



<a name="491134053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134053">(Dec 29 2024 at 01:11)</a>:</h4>
<p>WTF is very appropriate</p>



<a name="491134055"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134055" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134055">(Dec 29 2024 at 01:11)</a>:</h4>
<p>An infinite hole, Windows is</p>



<a name="491134067"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134067" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134067">(Dec 29 2024 at 01:11)</a>:</h4>
<p>Basically, is wtf is for old utf-16 that is not technically valid modern utf-16 (like windows path and js strings apparently)</p>



<a name="491134148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134148">(Dec 29 2024 at 01:12)</a>:</h4>
<p>probably <code>Str.from_utf16</code> should just take an extra arg and forward that to zig</p>



<a name="491134162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134162">(Dec 29 2024 at 01:13)</a>:</h4>
<p>I'm sure having UTF-16 is good, but it seems like we only need WTF-16 for now</p>



<a name="491134179"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134179" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134179">(Dec 29 2024 at 01:13)</a>:</h4>
<p>Yeah, I have no idea where you would run into valid modern utf-16.</p>



<a name="491134237"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134237" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134237">(Dec 29 2024 at 01:14)</a>:</h4>
<p>Well, do you know how this will affect <code>OsArg := [Unix (List U8), Windows (List U16)]</code>? Seems like we'll only have UTF-8 and WTF-16</p>



<a name="491134262"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134262" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134262">(Dec 29 2024 at 01:15)</a>:</h4>
<p>Also, we can still implement UTF-16/32 in the stdlib, they won't hurt anything</p>



<a name="491134289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134289">(Dec 29 2024 at 01:15)</a>:</h4>
<p>correct. We will only have <code>UTF-8</code> and <code>WTF-16</code></p>



<a name="491134303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134303">(Dec 29 2024 at 01:15)</a>:</h4>
<p>Okay, great</p>



<a name="491134688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134688">(Dec 29 2024 at 01:22)</a>:</h4>
<p>Reading up on this more, it sounds like using <code>WTF-16</code> for all <code>UTF-16</code> parsing is valid (and likely required in many cases due to legacy). It just loses some performance due to adding extra checks for unpaired surrogates. So I think we should make <code>Str.from_utf16</code>, but under the hood, it will just parse <code>WTF-16</code>. According to wikipedia, most utf-16 decoders do this.</p>
<p>I'm not sure the perf cost, but it sounds like many systems require it in general.</p>



<a name="491134892"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134892" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134892">(Dec 29 2024 at 01:24)</a>:</h4>
<p>We could also add <code>Str.from_wtf16</code> and just alias <code>Str.from_utf16</code> in that case</p>



<a name="491134931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491134931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sam Mohr <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491134931">(Dec 29 2024 at 01:25)</a>:</h4>
<p>If someone wants to parse WTF-16, it'd be good to not need to ask in Zulip or read what could be the 3rd docs paragraph of <code>Str.parse_utf16</code></p>



<a name="491135083"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491135083" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491135083">(Dec 29 2024 at 01:27)</a>:</h4>
<p>Yeah, sounds good</p>



<a name="491136449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491136449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491136449">(Dec 29 2024 at 01:48)</a>:</h4>
<p>eh I think just doing utf16 is fine, and then document that it's actually wtf-16</p>



<a name="491136459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491136459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491136459">(Dec 29 2024 at 01:48)</a>:</h4>
<p>I think the likelihood that perf is a problem here is low, and I wouldn't be surprised if people chose the wrong one</p>



<a name="491136468"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491136468" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491136468">(Dec 29 2024 at 01:48)</a>:</h4>
<p>leading to things almost always working, but then in super rare scenarios not working right <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="491136479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491136479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491136479">(Dec 29 2024 at 01:49)</a>:</h4>
<p>as in, they choose utf-16 not realizing they need wtf-16</p>



<a name="491136487"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491136487" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491136487">(Dec 29 2024 at 01:49)</a>:</h4>
<p>(and perhaps not knowing wtf-16 exists!)</p>



<a name="491142773"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491142773" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491142773">(Dec 29 2024 at 03:46)</a>:</h4>
<p>edit: below is incorrect, we want the wrapping <code>BadUtf8</code> tags</p>
<hr>
<p>Merging suggestions from above on error api:</p>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins/near/491133521">said</a>:</p>
<blockquote>
<p>Looking at the zig standard library, errors look to be disjoint</p>
</blockquote>
<p>means we want distinct <code>Utf8Problem</code>, <code>Utf16Problem</code> and <code>Utf32Problem</code> tagsets, and</p>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins/near/489985325">said</a>:</p>
<blockquote>
<p>Oh yeah let's remove one level of tag nesting</p>
</blockquote>
<p>indicates we can remove the wrapping <code>BadUtf8</code> etc tag, leading to the following api:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kt">Utf8Problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nf">...</span><span class="w"> </span><span class="p">]</span>
<span class="kt">Utf16Problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nf">...</span><span class="w"> </span><span class="p">]</span>
<span class="kt">Utf32Problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nf">...</span><span class="w"> </span><span class="p">]</span>

<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf8</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="p">,</span><span class="w"> </span><span class="nv">problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Utf8Problem</span><span class="w"> </span><span class="p">}</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf8_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U8</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf16</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U16</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="p">,</span><span class="w"> </span><span class="nv">problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Utf16Problem</span><span class="w"> </span><span class="p">}</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf16_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U16</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf32</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U32</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">index</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">U64</span><span class="p">,</span><span class="w"> </span><span class="nv">problem</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Utf32Problem</span><span class="w"> </span><span class="p">}</span>
<span class="kt">Str</span><span class="nf">.</span><span class="nv">from_utf32_lossy</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U32</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Str</span>
</code></pre></div>



<a name="491142852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491142852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491142852">(Dec 29 2024 at 03:47)</a>:</h4>
<p>I think we still want a tag union, because it merges nicely with other errors when you pass them up from a callsite within a function <code>Result _ []err</code></p>



<a name="491142903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491142903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491142903">(Dec 29 2024 at 03:48)</a>:</h4>
<p>If it's a record, then its an extra step to wrap it in a tag</p>



<a name="491142984"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491142984" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491142984">(Dec 29 2024 at 03:50)</a>:</h4>
<p>And to be clear: we want <code>from_utf16</code> to actually accept wtf-16, but <code>from_utf8</code> should still only accept utf-8 <em>not</em> wtf-8?</p>



<a name="491143089"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491143089" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491143089">(Dec 29 2024 at 03:52)</a>:</h4>
<p>yes</p>



<a name="491143093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491143093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491143093">(Dec 29 2024 at 03:52)</a>:</h4>
<p>I think that is correct.</p>



<a name="491143107"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491143107" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491143107">(Dec 29 2024 at 03:53)</a>:</h4>
<p><code>wtf-8</code> seems to be exceptionally rare from what I can tell. So it is reasonable to just consider it malformed</p>



<a name="491143114"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491143114" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491143114">(Dec 29 2024 at 03:53)</a>:</h4>
<p><code>wtf-16</code> seems to be the default for many apis on the otherhand.</p>



<a name="491143120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/491143120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#491143120">(Dec 29 2024 at 03:53)</a>:</h4>
<p>yeah, that matches my understanding as well</p>



<a name="492391619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492391619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492391619">(Jan 07 2025 at 21:37)</a>:</h4>
<p>coming back to <code>wtf-8</code>, what is expected for</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">when</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">fromUtf16</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="nv">xd800</span><span class="p">]</span><span class="w"> </span><span class="nv">is</span>
<span class="w">  </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="s">"a"</span>
<span class="w">  </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">s</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">fromUtf8</span><span class="w"> </span><span class="p">(</span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toUtf8</span><span class="w"> </span><span class="nv">s</span><span class="p">)</span><span class="w"> </span><span class="nv">is</span>
<span class="w">    </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="s">"b"</span>
<span class="w">    </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="s">"c"</span>
</code></pre></div>
<p>a. <code>Str.fromUtf16</code> will implement strict utf-16 (ie not wtf-16) and fail with an error about an unpaired surrogate<br>
b. <code>Str.fromUtf16</code> will implement wtf-16, but <code>Str.fromUtf8</code> will implement strict utf-8 (ie not wtf-8), and return an error about encoding a surrogate pair<br>
c. <code>Str.fromUtf16</code> implements wtf-16, and <code>Str.fromUtf8</code> implements (possibly a subset of) wtf-8, both accepting unpaired surrogate pair codepoints</p>



<a name="492391787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492391787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492391787">(Jan 07 2025 at 21:38)</a>:</h4>
<p>the agreement before (to make <code>from_utf16</code> actually be <code>from_wtf16</code> but leave <code>from_utf8</code> as-is) would imply "b" which leads to <code>Str.fromUtf8</code> and <code>Str.toUtf8</code> not being able to roundtrip</p>



<a name="492394368"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492394368" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492394368">(Jan 07 2025 at 21:55)</a>:</h4>
<p>we could make <code>Str.toUtf8</code> return a <code>Result Str _</code>. It seems unfortunate but if you allow <code>Str</code> to contain surrogate pair codepoints, then it cannot be encoded to standards-compliant utf-8/16/32 afaict.</p>



<a name="492394636"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492394636" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492394636">(Jan 07 2025 at 21:57)</a>:</h4>
<p>I'm leaning towards "c". I have never cared about whether my unicode encoding/decoding libraries checked for unpaired surrogate codepoints. I would mentally file it in the same category as unpaired combining characters in the input string.</p>



<a name="492394693"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492394693" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492394693">(Jan 07 2025 at 21:57)</a>:</h4>
<p>but maybe someone else has stronger opinions?</p>



<a name="492396019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492396019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492396019">(Jan 07 2025 at 22:06)</a>:</h4>
<p>I think the bar should be super high for <code>Str</code> to be encoded as anything other than unmodified standard utf-8, because a ton of hosts will naively convert utf8 strings to roc <code>Str</code>s</p>



<a name="492396152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492396152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492396152">(Jan 07 2025 at 22:07)</a>:</h4>
<p>and if we have a slightly different representation, it sounds like a major UB footgun, not to mention a potential performance problem where we have to check every utf8 string the host wants to send in, to make sure it doesn't contain any edge cases</p>



<a name="492396189"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492396189" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492396189">(Jan 07 2025 at 22:07)</a>:</h4>
<p>I guess going from valid utf-8 to roc <code>Str</code>s should remain the same. wtf-8 is a superset of utf-8 which allows encoding more codepoints than utf-8.</p>



<a name="492396373"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492396373" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492396373">(Jan 07 2025 at 22:09)</a>:</h4>
<p>I think we should consider our strings to be strictly utf-8 and not wtf-8</p>



<a name="492396550"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492396550" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492396550">(Jan 07 2025 at 22:10)</a>:</h4>
<p>When converting wtf-16 to utf-8, I assume we need to cleanup the surrogate pairs to make it strict utf-8</p>



<a name="492396701"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492396701" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492396701">(Jan 07 2025 at 22:11)</a>:</h4>
<p>So we parse wtf-16, but canonicalize to cleanly convert into uft-8. If we can't canonicalize, we fail.</p>



<a name="492396869"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492396869" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492396869">(Jan 07 2025 at 22:12)</a>:</h4>
<p>Yeah, specifically _unpaired_ surrogate codepoints are an issue. We could replace them with unicode replacement character '�' or we could remove them.</p>



<a name="492397118"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492397118" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492397118">(Jan 07 2025 at 22:14)</a>:</h4>
<p>I think the motivating reason to accept wtf-16 is windows paths which can contain unpaired surrogate codepoints. If we replace or remove things in a path string, will windows still recognize it?</p>



<a name="492397217"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492397217" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492397217">(Jan 07 2025 at 22:15)</a>:</h4>
<p>I thought the point of wtf-16 is that it correctly knows how to convert unpaired surrogates into the correct Unicode code point.</p>



<a name="492397279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492397279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492397279">(Jan 07 2025 at 22:16)</a>:</h4>
<p>Cause an unpaired surrogates means that it is actually the old ucs-2 format</p>



<a name="492398456"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492398456" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492398456">(Jan 07 2025 at 22:26)</a>:</h4>
<p><del>ah, no, not as far as I understand.</del> wtf-16 is "potentially ill-formed utf-16".</p>
<p>I think at least in the document, "ucs-2" refers to a unicode encoding which was defined _before_ unicode codepoints exceeded 0xFFFF so everything fit in 16bits and surrogate pairs were not defined nor necessary. ucs-2 and utf-16 differ from codepoints 0xD800 to 0x110000, as ucs-2 can't encode anything higher than 0xFFFF and utf-16 has those ill-formed constraints around 0xD800 to 0xDFFF.</p>
<blockquote>
<p>WTF-16 is sometimes used as a shorter name for <a href="https://simonsapin.github.io/wtf-8/#potentially-ill-formed-utf-16">potentially ill-formed UTF-16</a>, especially in the context of systems were originally designed for <a href="https://simonsapin.github.io/wtf-8/#ucs-2">UCS-2</a> and later upgraded to <a href="https://simonsapin.github.io/wtf-8/#utf-16">UTF-16</a> but never enforced <a href="https://simonsapin.github.io/wtf-8/#well-formed">well-formedness</a>, either by neglect or because of backward-compatibility constraints.</p>
</blockquote>



<a name="492400900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492400900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492400900">(Jan 07 2025 at 22:43)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/channel/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins/near/492397217">said</a>:</p>
<blockquote>
<p>I thought the point of wtf-16 is that it correctly knows how to convert unpaired surrogates into the correct Unicode code point.</p>
</blockquote>
<p>yes, but encoding those codepoints as utf-8 is <a href="https://datatracker.ietf.org/doc/html/rfc3629#section-3">disallowed by the official standard</a></p>
<blockquote>
<p>The definition of UTF-8 prohibits encoding character numbers between U+D800 and U+DFFF, which are reserved for use with the UTF-16 encoding form (as surrogate pairs) and do not directly represent characters.</p>
</blockquote>
<p>Thus, the solution is to use a not-as-strict encoding which is the same as utf-8, except it allows encoding those codepoints. This not-as-strict encoding is wtf-8</p>



<a name="492402903"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492402903" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492402903">(Jan 07 2025 at 22:58)</a>:</h4>
<p>Hmm. I guess I don't fully understand wtf-16. Anyway, I would guess we want to keep strings as fully valid utf-8. So when converting from wtf-16, we would have one form of the function that uses replacement characters as necessary and another that just fails.</p>



<a name="492596982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492596982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492596982">(Jan 08 2025 at 22:57)</a>:</h4>
<p>Okay, I think that's what I'm doing currently. <code>fromUtf16</code> and <code>fromUtf8</code> will fail if the input is not utf-16 or utf-8 respectively, while <code>fromUtf16Lossy</code> and <code>fromUtf8Lossy</code> accept a superset of utf-16 and utf-8, which replaces ill-formed sequences which cannot be encoded or codepoints which cannot be encoded as utf-8 (ie surrogates) to the unicode replacement character.</p>
<p>This does mean that roc will not be able to work with host paths as <code>Str</code> but would rather have to work with <code>List U8</code> and fallibly convert them to <code>Str</code>.</p>



<a name="492597285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492597285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492597285">(Jan 08 2025 at 22:59)</a>:</h4>
<p>Yeah, I think a host path has to be a <code>List U8</code> or a <code>List U16</code>, I guess.</p>



<a name="492597486"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492597486" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492597486">(Jan 08 2025 at 23:00)</a>:</h4>
<p>oh the joys of standards compliance</p>



<a name="492598225"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492598225" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492598225">(Jan 08 2025 at 23:07)</a>:</h4>
<p>host paths aren't valid anything <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="492598304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492598304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492598304">(Jan 08 2025 at 23:08)</a>:</h4>
<p>UNIX allows anything in paths other than <code>0</code> bytes, and ASCII forward slashes mean directory separators</p>



<a name="492598344"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492598344" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492598344">(Jan 08 2025 at 23:08)</a>:</h4>
<p>the spec doesn't even have anything to do with Unicode <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="492598377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492598377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492598377">(Jan 08 2025 at 23:09)</a>:</h4>
<p>Windows is similar except it's like they also ban bytes under 32 or something like that</p>



<a name="492598785"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492598785" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492598785">(Jan 08 2025 at 23:13)</a>:</h4>
<p><em>they're a valid nuisance is what they are</em> <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="492598800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492598800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492598800">(Jan 08 2025 at 23:13)</a>:</h4>
<p>I think WASI filesystem spec uses <code>string</code> as path values, which must be valid unicode scalar values, and they just accept that some (pathologically-named) files will be unreachable via WASI. So if WASI is considered as a host, that's at least one.</p>
<p>edit: adding link to <a href="https://wa.dev/wasi:filesystem">wasi:filesystem spec</a></p>



<a name="492599040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/492599040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#492599040">(Jan 08 2025 at 23:15)</a>:</h4>
<p>interesting - we might want to add WASI to <a href="https://github.com/roc-lang/path/blob/14b5fa518d13abb5012bcaa6809f7259e912eaeb/package/Path.roc#L24">roc-lang/path</a></p>



<a name="494236953"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Lossy%20unicode%20conversion%20builtins/near/494236953" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> shua <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Lossy.20unicode.20conversion.20builtins.html#494236953">(Jan 16 2025 at 21:35)</a>:</h4>
<p>just in case someone's following this thread: <a href="https://github.com/roc-lang/roc/pull/7514">https://github.com/roc-lang/roc/pull/7514</a> has been posted and approved, but is currently blocked on some interesting CI failures <a class="stream-topic" data-stream-id="463736" href="/#narrow/channel/463736-bugs/topic/mono.20mismatch.20between.20mac.20aarch64.20and.20rest.20of.20targets">#bugs &gt; mono mismatch between mac aarch64 and rest of targets</a></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
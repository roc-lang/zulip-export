<html>
<head><meta charset="utf-8"><title>Tasks returning {} · API design · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/index.html">API design</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html">Tasks returning {}</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="434503825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434503825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434503825">(Apr 20 2024 at 14:03)</a>:</h4>
<p>Has there been any discussion for more convenient backpassing syntax when the task returns <code>{}</code>? I find it odd to have to write <code>_ &lt;- Stdout.line "hello" |&gt; Task.await</code>. I'm sure you all know that Haskell "automatically" handles <code>IO ()</code> in the do notation. I'm guessing this has been thought about and rejected?</p>



<a name="434506087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434506087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434506087">(Apr 20 2024 at 14:35)</a>:</h4>
<p>Hi drew,<br>
We created <a href="https://docs.google.com/document/d/1mTEZlOKqtMonmVsIGEC1A9ufs1TQHhVgZ52Vn-13GeU/edit#heading=h.8qhbfnuufxi9">the <code>!</code> syntax</a> so you can avoid writing <code>_ &lt;-</code>. I believe most of it is (very recently) implemented, I'm not sure what from the design doc is still missing.</p>



<a name="434506202"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434506202" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434506202">(Apr 20 2024 at 14:37)</a>:</h4>
<p>awesome thanks!</p>



<a name="434506604"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434506604" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434506604">(Apr 20 2024 at 14:43)</a>:</h4>
<p>oh wow, the <code>!</code> design is really nice. i like that it means everything looks like the direct style.</p>



<a name="434506850"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434506850" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434506850">(Apr 20 2024 at 14:46)</a>:</h4>
<p>the <code>with</code> syntax feels slightly awkward, but i like that <code>!</code> builds on <code>with</code>, and you'd _definitely_ want <code>with</code> for parsers imo.</p>



<a name="434506884"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434506884" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434506884">(Apr 20 2024 at 14:46)</a>:</h4>
<p>does <code>with</code> work for the entire following block? can you nest <code>with</code>s?</p>



<a name="434506938"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434506938" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434506938">(Apr 20 2024 at 14:47)</a>:</h4>
<p>one downside to removing backpassing is that if you want to interleave effects you need to use explicit callbacks, right?</p>



<a name="434507599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434507599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434507599">(Apr 20 2024 at 14:55)</a>:</h4>
<p>I think the current plan is to not add <code>with</code> unless it gains a really clear need.</p>



<a name="434507619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434507619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434507619">(Apr 20 2024 at 14:55)</a>:</h4>
<p>First we are making <code>!</code> special to only tasks</p>



<a name="434507905"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434507905" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434507905">(Apr 20 2024 at 14:56)</a>:</h4>
<p>Next thing we would consider is making <code>!</code> valid for any <code>andThen</code> style function on an opaque type (maybe a special case for result if needed). I don't think we can make it work with generic type aliases.</p>



<a name="434508050"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434508050" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434508050">(Apr 20 2024 at 14:57)</a>:</h4>
<p>After that, we would look into <code>with</code> if there is still need for more flexibility</p>



<a name="434508077"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434508077" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434508077">(Apr 20 2024 at 14:57)</a>:</h4>
<p>And yes, this means that callback need to be explicit otherwise. At least once back passing is removed</p>



<a name="434520909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434520909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434520909">(Apr 20 2024 at 17:44)</a>:</h4>
<p>got it, thanks.</p>



<a name="434522454"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434522454" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434522454">(Apr 20 2024 at 18:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434507905">said</a>:</p>
<blockquote>
<p>Next thing we would consider is making <code>!</code> valid for any <code>andThen</code> style function on an opaque type (maybe a special case for result if needed). I don't think we can make it work with generic type aliases.</p>
</blockquote>
<p>how would this look for a non-Task type?</p>



<a name="434522536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434522536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434522536">(Apr 20 2024 at 18:06)</a>:</h4>
<p>does this mean that whatever the returned type is, if it could be subsequently passed to that module's <code>andThen</code> function, you could use <code>!</code>?</p>



<a name="434523286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434523286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434523286">(Apr 20 2024 at 18:16)</a>:</h4>
<p>This has been discussed some, but is not nailed down. A big question is if we want the complexity it could bring to the type system or simply to have a basic rewrite rule like what you mentioned by calling the module's <code>andThen</code> function.</p>



<a name="434523994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434523994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434523994">(Apr 20 2024 at 18:26)</a>:</h4>
<p>this couldn't be implemented directly via abilities because of higher-kinded types, yeah?</p>



<a name="434524293"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434524293" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434524293">(Apr 20 2024 at 18:31)</a>:</h4>
<p>Exactly</p>



<a name="434528804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434528804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434528804">(Apr 20 2024 at 19:45)</a>:</h4>
<p>just when you thought you were out, monads pull you back in</p>



<a name="434529190"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434529190" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434529190">(Apr 20 2024 at 19:51)</a>:</h4>
<p>Yeah, maybe. Though having a single monad for a very specific scope is very different from totally generic monad use cases.</p>



<a name="434529222"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434529222" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434529222">(Apr 20 2024 at 19:51)</a>:</h4>
<p>Though how <code>!</code> and other syntax sugar work today, they are essentially macros. So they technically can skip past the type system and just generate something.</p>



<a name="434529263"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434529263" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434529263">(Apr 20 2024 at 19:52)</a>:</h4>
<p>totally agreed. i do think having <code>!</code> work with user defined types seems better.</p>



<a name="434529407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434529407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434529407">(Apr 20 2024 at 19:54)</a>:</h4>
<p>+1</p>



<a name="434530182"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434530182" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434530182">(Apr 20 2024 at 20:07)</a>:</h4>
<p>the <code>!</code> reminds me a bit of letops in ocaml</p>



<a name="434531462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434531462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434531462">(Apr 20 2024 at 20:27)</a>:</h4>
<p>I'm curious to see what specific use cases (if any) remain for user-defined types once we have shadowing and can use that for random number seeds</p>



<a name="434531540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434531540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434531540">(Apr 20 2024 at 20:29)</a>:</h4>
<p>the seed-passing style is very straightforward and composes trivially with tasks; the main ergonomics problem there is naming</p>



<a name="434531621"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434531621" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434531621">(Apr 20 2024 at 20:30)</a>:</h4>
<p>whereas the "build up a big <code>Generator</code>" style clashes with tasks regardless of whether it has <code>!</code> sugar - so I think once we have shadowing that will likely end up being the recommended style to use anyway</p>



<a name="434531688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434531688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434531688">(Apr 20 2024 at 20:31)</a>:</h4>
<p>and I don't think <code>!</code> would solve a significant pain point in parsers - e.g. Elm has neither that nor a backpassing equivalent and there doesn't seem to be demand for anything like that in Elm parsers</p>



<a name="434531742"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434531742" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434531742">(Apr 20 2024 at 20:32)</a>:</h4>
<p>so if we have shadowing I'm not really sure what the specific use cases would be, what the delta in experience would be between having <code>!</code> work and not work with those types, etc.</p>



<a name="434535498"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434535498" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434535498">(Apr 20 2024 at 21:35)</a>:</h4>
<p>interesting. what’s the “seed passing style”?</p>



<a name="434535509"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434535509" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434535509">(Apr 20 2024 at 21:35)</a>:</h4>
<p>and what do you mean by shadowing in this context?</p>



<a name="434537126"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434537126" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434537126">(Apr 20 2024 at 22:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434531462">said</a>:</p>
<blockquote>
<p>I'm curious to see what specific use cases (if any) remain for user-defined types once we have shadowing and can use that for random number seeds</p>
</blockquote>
<p>I was thinking that if we have !-syntax for custom types, it might come in useful in the design of roc-ci. To replace the backpassing I'm using in the current design. This is an example pipeline definition in the current design:</p>
<div class="codehilite"><pre><span></span><code>buildAndTest : Ci.Job
buildAndTest =
    repoDetails &lt;- Ci.step0 &quot;setup git&quot; Ci.setupGit
    binary &lt;- Ci.step1 &quot;build binary&quot; buildBinary repoDetails
    testsPass &lt;- Ci.step1 &quot;run tests&quot; runTests binary
    _ &lt;- Ci.step2 &quot;release&quot; release binary testsPass
    Ci.done
</code></pre></div>
<p>This is using backpassing to do what would be called a writer monad in Haskell. Every CI step you create is recorded into some internal data structure, from which the CI runner can later extract it.</p>
<p>If the seed-passing-style is what I think it is, I imagine that might be an alternative here too. The internal data structure containing the steps would be passed explicitly around:</p>
<div class="codehilite"><pre><span></span><code>buildAndTest : Ci.Job
buildAndTest =
    job = Ci.emptyJob
    (repoDetails, job) = Ci.step0 job &quot;setup git&quot; Ci.setupGit
    (binary, job) = Ci.step1 job &quot;build binary&quot; buildBinary repoDetails
    (testsPass, job) = Ci.step1 job &quot;run tests&quot; runTests binary
    (_, job) = Ci.step2 job &quot;release&quot; release binary testsPass
    job
</code></pre></div>
<p>There is a downside to this approach though: it becomes possible to accidentally not record a CI step, particularly when you're not interested in the result of the CI step and so are <code>_</code>-ing part of the return value of that step anyway. For instance, this would be a version of the previous example where the <code>release</code> step at the end is dropped:</p>
<div class="codehilite"><pre><span></span><code>buildAndTest : Ci.Job
buildAndTest =
    job = Ci.emptyJob
    (repoDetails, job) = Ci.step0 job &quot;setup git&quot; Ci.setupGit
    (binary, job) = Ci.step1 job &quot;build binary&quot; buildBinary repoDetails
    (testsPass, job) = Ci.step1 job &quot;run tests&quot; runTests binary
    _ = Ci.step2 job &quot;release&quot; release binary testsPass
    job
</code></pre></div>
<p>Of course entirely different designs are possible too!</p>



<a name="434537506"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434537506" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434537506">(Apr 20 2024 at 22:09)</a>:</h4>
<p>One big outstanding question I have about roc is how application-wide config / data will be handled. I don’t love the Reader monad but I’m not sure what other options are available. Many use Task and rely on a specific effect from the platform?</p>



<a name="434538102"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434538102" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434538102">(Apr 20 2024 at 22:20)</a>:</h4>
<p>Another scenario where I think having <code>!</code> for custom types could come in useful: defining a custom <code>Task</code> type wrapping the future builtin, with tracing support.</p>
<p>Suppose you want to create a platform that contains the following primitive for recording a span in a trace:</p>
<div class="codehilite"><pre><span></span><code>span : Str, Task val err -&gt; Task val err
</code></pre></div>
<p>In words: this takes a task and a string description, and would record how long the task takes to run. The platform could then add support for sending this data to some tracing platform where you can look at a flamegraph of your code.</p>
<p>For this to work the <code>Task</code> would need to carry some metadata related to the current span:</p>
<ul>
<li>Either a unique ID for the current span or a mutable list of child spans, so the relation between spans in the trace tree is recorded.</li>
<li>A timestamp representing the start time of the current span so we can calculate its duration when it ends.</li>
</ul>
<p>In the current design where platforms define their own <code>Task</code> type, platforms can define it to carry whatever metadata they like. If this is no longer possible because Task becomes a builtin (I'm not sure about this), another approach might be to define a custom <code>Task</code> type by wrapping the builtin one, though if <code>!</code> is not available for the custom <code>Task</code> type it would not be very ergonomic.</p>



<a name="434542040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434542040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434542040">(Apr 20 2024 at 23:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="463085">drew</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434537506">said</a>:</p>
<blockquote>
<p>One big outstanding question I have about roc is how application-wide config / data will be handled. I don’t love the Reader monad but I’m not sure what other options are available. Many use Task and rely on a specific effect from the platform?</p>
</blockquote>
<p>for this use case I agree with Evan's advice for what to do in Haskell (where Reader and others are available): just pass it around!</p>



<a name="434542088"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434542088" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434542088">(Apr 20 2024 at 23:35)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434542040">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="463085">drew</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434537506">said</a>:</p>
<blockquote>
<p>One big outstanding question I have about roc is how application-wide config / data will be handled. I don’t love the Reader monad but I’m not sure what other options are available. Many use Task and rely on a specific effect from the platform?</p>
</blockquote>
<p>for this use case I agree with Evan's advice for what to do in Haskell (where Reader and others are available): just pass it around!</p>
</blockquote>
<p>Doesn't this mean passing something like a database connection to most non-pure functions in a large-ish web application?</p>



<a name="434542155"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434542155" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434542155">(Apr 20 2024 at 23:36)</a>:</h4>
<p>yes, although with module params the passing doesn't have to be function-to-function, it can be module-to-module</p>



<a name="434542183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434542183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434542183">(Apr 20 2024 at 23:37)</a>:</h4>
<p>I suspect that would be the more common way to pass it around in Roc</p>



<a name="434542187"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434542187" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434542187">(Apr 20 2024 at 23:37)</a>:</h4>
<p><span class="user-mention" data-user-id="477725">@Jasper Woudenberg</span> could it make sense in a CI platform to use <code>Task</code> instead of <code>Job</code>?</p>



<a name="434542253"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434542253" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434542253">(Apr 20 2024 at 23:38)</a>:</h4>
<p>alternatively, could an applicative-based API for <code>Job</code> make sense? Then you could use record builder syntax, and also the structure would be statically inspectable (so you could print out a build graph etc)</p>



<a name="434543216"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434543216" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434543216">(Apr 20 2024 at 23:55)</a>:</h4>
<p><span class="user-mention silent" data-user-id="477725">Jasper Woudenberg</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434537126">said</a>:</p>
<blockquote>
<p>There is a downside to this approach though: it becomes possible to accidentally not record a CI step, particularly when you're not interested in the result of the CI step and so are <code>_</code>-ing part of the return value of that step anyway. For instance, this would be a version of the previous example where the <code>release</code> step at the end is dropped:</p>
<p><div class="codehilite"><pre><span></span><code>buildAndTest : Ci.Job
buildAndTest =
    job = Ci.emptyJob
    (repoDetails, job) = Ci.step0 job &quot;setup git&quot; Ci.setupGit
    (binary, job) = Ci.step1 job &quot;build binary&quot; buildBinary repoDetails
    (testsPass, job) = Ci.step1 job &quot;run tests&quot; runTests binary
    _ = Ci.step2 job &quot;release&quot; release binary testsPass
    job
</code></pre></div><br>
</p>
</blockquote>
<p>Would it make sense to catch this by linting <code>_ =</code>? I don't think there is much of a reason to write <code>_ =</code> in Roc if it means performing a pure computation and this discarding the result</p>



<a name="434543372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434543372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434543372">(Apr 20 2024 at 23:58)</a>:</h4>
<p>yeah I think that's a reasonable warning in general <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="434543856"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434543856" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434543856">(Apr 21 2024 at 00:05)</a>:</h4>
<blockquote>
<p>could it make sense in a CI platform to use <code>Task</code> instead of <code>Job</code>?</p>
</blockquote>
<p>Just thinking out loud of use cases that I expect to hit this (not that they need <code>!</code>, but they could use backpassing today and <code>!</code> would be really nice):</p>
<ol>
<li>Task</li>
<li>Any higher level abstraction that wraps Task</li>
<li>Result: at least in complex functions without effects/Task</li>
<li>Generators: sure rng can use shadowing and explicit state passing, but generators are nice. They also come in for arbitrary data generation from bytes like used in fuzzing.</li>
<li>Streams with manual continuations might also fit to some extent</li>
</ol>



<a name="434543947"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434543947" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434543947">(Apr 21 2024 at 00:07)</a>:</h4>
<p>Not sure if there are any common higher level wrappers of Result that would benefit from this.</p>



<a name="434545113"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434545113" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434545113">(Apr 21 2024 at 00:27)</a>:</h4>
<p>brief thoughts on those:</p>
<ol>
<li>(of course <code>Task</code> is definitely going to support it no matter what <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span>)</li>
<li>"Any higher level abstraction that wraps Task" - in the past I've seen this used for simulating effects in tests, and logging effects, and in Roc we can do both of those without requiring wrappers. (Logging can be done by providing a function to the platform, which it can then call when executing the <code>Task</code> state machine.) I haven't heard of other use cases for wrapping <code>Task</code> that seem like a good idea, so I think the specifics matter on this one!</li>
<li><code>Result</code> - neither Elm nor OCaml have sugar for this and it hasn't been an issue; I think it's fine if Roc doesn't have sugar for it either. Plus <code>Result</code> isn't opaque in Roc, so it can't get abilities, making it innately awkward for any kind of "make <code>!</code> work with any type that has a particular ability" design. If we really want it <em>just</em> for <code>Result</code> we can always discuss a <code>?</code> suffix in addition to <code>!</code></li>
<li>Generators - to be clear, I think <code>Generator</code> is a good idea for reuse (and in that use case, it doesn't clash with <code>Task</code>), I'm specifically talking about the style of "running" the RNG where you wrap all the logic you want to do in a big <code>Generator</code> that you have no intention of reusing, just as a way of threading the seed around. That's the situation where you can absolutely clash with <code>Task</code>, and where using <code>seed</code> instead doesn't have that problem.</li>
<li>Streams - is that stream in the sense of "iterators," or in the sense of like "streaming I/O"?</li>
</ol>



<a name="434545622"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434545622" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434545622">(Apr 21 2024 at 00:36)</a>:</h4>
<blockquote>
<p>Logging can be done by providing a function to the platform, which it can then call when executing the <code>Task</code> state machine.</p>
</blockquote>
<p>That may not give you the selective logging control you want. It also makes logging depend on the platform. It would be much nicer to build a logging library in roc that creates some form of logging task that simply has to know what effect to run for various kinds of logging. So I do think there is a rather large unlock here from allowing the wrapping.</p>
<blockquote>
<p>I haven't heard of other use cases for wrapping <code>Task</code> that seem like a good idea</p>
</blockquote>
<p>Yeah, not fully sure, the CI Job and general graph building + task style seems to be where this would most likely come up.</p>
<blockquote>
<p>I'm specifically talking about the style of "running" the RNG where you wrap all the logic you want to do in a big <code>Generator</code> that you have no intention of reusing, just as a way of threading the seed around. That's the situation where you can absolutely clash with <code>Task</code>, and where using <code>seed</code> instead doesn't have that problem.</p>
</blockquote>
<p>I was specifically think about where you define a generator per type and they are composable. So an outer generator composes many sub generators. I guess it probably could all be direct calls. Past hiding state, I'm not sure if there is a major difference in apis.</p>
<blockquote>
<p>is that stream in the sense of "iterators,"</p>
</blockquote>
<p>Kinda. I was more specifically thinking lazy data creation. Made by a chain of continuations.</p>



<a name="434548673"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434548673" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434548673">(Apr 21 2024 at 01:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434545113">said</a>:</p>
<blockquote>
<ol start="3">
<li><code>Result</code> - neither Elm nor OCaml have sugar for this and it hasn't been an issue; I think it's fine if Roc doesn't have sugar for it either. Plus <code>Result</code> isn't opaque in Roc, so it can't get abilities, making it innately awkward for any kind of "make <code>!</code> work with any type that has a particular ability" design. If we really want it <em>just</em> for <code>Result</code> we can always discuss a <code>?</code> suffix in addition to <code>!</code></li>
</ol>
</blockquote>
<p><code>letops</code> are a syntax for this in ocaml that can work with user-defined types, right? and <code>let-ppx</code> was before <code>letops</code> were directly supported.</p>



<a name="434558704"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434558704" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434558704">(Apr 21 2024 at 04:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434545622">said</a>:</p>
<blockquote>
<blockquote>
<p>Logging can be done by providing a function to the platform, which it can then call when executing the <code>Task</code> state machine.</p>
</blockquote>
<p>That may not give you the selective logging control you want. It also makes logging depend on the platform. It would be much nicer to build a logging library in roc that creates some form of logging task that simply has to know what effect to run for various kinds of logging. So I do think there is a rather large unlock here from allowing the wrapping.</p>
</blockquote>
<p>there's a deeper discussion to be had on the topic of logging, but briefly - given that platforms can already log all I/O (and give application authors a way to specify how they want each particular I/O operation to be logged), I'm skeptical that it's really beneficial to be able to say "okay <em>this exact</em> HTTP request should be at a different log level than <em>this exact</em> other HTTP request" as opposed to (for example) filtering the logs in some other way, or setting the level as a function of information contained in the the HTTP request itself (e.g. if the URL is going to some known third-party analytics domain, those requests can always be set to a lower log level)</p>



<a name="434558720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434558720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434558720">(Apr 21 2024 at 04:39)</a>:</h4>
<p>regarding OCaml, I actually don't know anything about <code>letops</code> or <code>let-ppx</code> <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="434559603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434559603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434559603">(Apr 21 2024 at 04:57)</a>:</h4>
<p>We'll have to see in practice once we have module params. My gut feel is that platform logging support will be adhoc and inconsistent. Including, I would guess that many platforms won't have proper logging at all. As such, it will be nicer to just call <code>Stderr.line</code> or <code>File.write</code> or <code>Http.push</code> to send logs. Then it will be nicer to wrap that up in a shared library that takes in the logging primitive as a module param task. I think that is the most likely way to get a really nice and consistent logging experience that can be attached to any platform with some sort of text output primitive.</p>



<a name="434559678"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434559678" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434559678">(Apr 21 2024 at 04:59)</a>:</h4>
<p>That said, I'm not sure that you will actually need any special form of wrapping task for that.</p>



<a name="434559683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434559683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434559683">(Apr 21 2024 at 04:59)</a>:</h4>
<p>So it may not need any sort of special <code>!</code></p>



<a name="434601319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434601319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434601319">(Apr 21 2024 at 16:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434558720">said</a>:</p>
<blockquote>
<p>regarding OCaml, I actually don't know anything about <code>letops</code> or <code>let-ppx</code> <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>
</blockquote>
<p>Here's a little example I put together to show how <code>letops</code> work -- <a href="https://gist.github.com/drewolson/5405ad83e5303026650d4015d185490c">https://gist.github.com/drewolson/5405ad83e5303026650d4015d185490c</a></p>



<a name="434601430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434601430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434601430">(Apr 21 2024 at 16:24)</a>:</h4>
<p>It feels worth explaining as <code>letops</code> actually feel pretty close to what you're describing with <code>!</code> -- they work as basically "rewrites". They effectively make callback based code look like the direct style, using whatever definition of <code>let*</code> (or other <code>let</code>-style functions) are in scope.</p>



<a name="434601447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434601447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434601447">(Apr 21 2024 at 16:25)</a>:</h4>
<p>in the example I show using <code>let*</code> (direct-style bind) for both lists and options, just as an example</p>



<a name="434601475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434601475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434601475">(Apr 21 2024 at 16:25)</a>:</h4>
<p>the annoying downside is that you must explicitly bring into scope the particular implementation you want for a given function</p>



<a name="434601499"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434601499" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434601499">(Apr 21 2024 at 16:25)</a>:</h4>
<p>that said, at least it is explicit. it feels very similar to the proposal for <code>with</code> and <code>?</code>.</p>



<a name="434601775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434601775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434601775">(Apr 21 2024 at 16:29)</a>:</h4>
<p>the same tools are used for applicative-style APIs via the conventionally named <code>let+</code> and <code>and+</code></p>



<a name="434602522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434602522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434602522">(Apr 21 2024 at 16:41)</a>:</h4>
<p>here's an example of an applicative-style parser using <code>letops</code> and the <code>angstrom</code> library <a href="https://gist.github.com/drewolson/1776047f9ac00d51df8a7a36deb2fda6">https://gist.github.com/drewolson/1776047f9ac00d51df8a7a36deb2fda6</a></p>



<a name="434602646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434602646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434602646">(Apr 21 2024 at 16:43)</a>:</h4>
<p>the comparisons to ocaml feel useful as it is a language without ad hoc polymorphism at all :) but i get that the design goals of roc differ. just wanted it here as a comparison / prior art.</p>



<a name="434602894"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434602894" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434602894">(Apr 21 2024 at 16:46)</a>:</h4>
<p>Writing this small parser also made me remember how much i dislike full type inference in ocaml, related to one of the disadvantages of HKP in the FAQ. If I accidentally forget the labeled argument to <code>Angstrom.parse_string</code>, here's the helpful error message I get:</p>



<a name="434602913"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434602913" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434602913">(Apr 21 2024 at 16:47)</a>:</h4>
<div class="codehilite"><pre><span></span><code>File &quot;bin/parse/main.ml&quot;, line 21, characters 4-11:

21 |   | Error _ -&gt; print_endline &quot;Error!&quot;

         ^^^^^^^

Error: This pattern should not be a constructor, the expected type is

       consume:Angstrom.Consume.t -&gt; (int * int, string) result```
</code></pre></div>



<a name="434602928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434602928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434602928">(Apr 21 2024 at 16:47)</a>:</h4>
<p>though i suppose this is actually related to currying :)</p>



<a name="434606306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434606306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434606306">(Apr 21 2024 at 17:41)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434542187">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="477725">Jasper Woudenberg</span> could it make sense in a CI platform to use <code>Task</code> instead of <code>Job</code>?</p>
</blockquote>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434542253">said</a>:</p>
<blockquote>
<p>alternatively, could an applicative-based API for <code>Job</code> make sense? Then you could use record builder syntax, and also the structure would be statically inspectable (so you could print out a build graph etc)</p>
</blockquote>
<p>Yeah, I'd like to make the CI structure be statically inspectable, which is why I don't think using <code>Task</code> instead of <code>Job</code> would help. With regards to record builders, I've thought about it after getting that feedback before, but I'm not sure what record I'd want to build <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>. Would the idea be to try represent the build graph as a set of nested records?</p>
<p>What I like about the design I have now is that it's already statically inspectable. on account of <code>Job</code> not coming with an <code>andThen</code>. And it allows you to write the project's CI almost like an ordinary function, with roc-ci being able to turn that into a pipeline (i.e., we can automatically figure out which bits to run in paralllel).</p>



<a name="434606614"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434606614" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434606614">(Apr 21 2024 at 17:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="477725">Jasper Woudenberg</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434606306">said</a>:</p>
<blockquote>
<p>What I like about the design I have now is that it's already statically inspectable. on account of <code>Job</code> not coming with an <code>andThen</code>. And it allows you to write the project's CI almost like an ordinary function, with roc-ci being able to turn that into a pipeline (i.e., we can automatically figure out which bits to run in paralllel).</p>
</blockquote>
<p>ah! So <code>!</code> desugars into an <code>andThen</code>, so it probably wouldn't be usable here even if it did support types other than <code>Task</code> <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="434606720"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434606720" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434606720">(Apr 21 2024 at 17:48)</a>:</h4>
<p>So logging is one thing, but any thoughts about what it would take to have good tracing support? For me, traces have completely replaced logging in web applications, and I'd be happy never to have to think off log levels again <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>. I think in terms of functionality required, while logging could be implemented by the platform providing some log function(s), for tracing the <code>Task</code> type needs to carry some context to allow a tree of spans to be created. Will that be possible with the language-provided <code>Task</code> type?</p>



<a name="434606907"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434606907" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434606907">(Apr 21 2024 at 17:51)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434606614">said</a>:</p>
<blockquote>
<p>ah! So <code>!</code> desugars into an <code>andThen</code>, so it probably wouldn't be usable here even if it did support types other than <code>Task</code> <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>
</blockquote>
<p>Ah, that makes sense, I guess that would never work then.</p>
<p>I'll probably go with the shadowing approach then, seems pretty straight-forward and I think it'd likely have better errors then the current backpassing approach anyway.</p>



<a name="434608543"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434608543" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434608543">(Apr 21 2024 at 18:17)</a>:</h4>
<p>cool cool!</p>



<a name="434608596"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434608596" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434608596">(Apr 21 2024 at 18:18)</a>:</h4>
<p>out of curiosity, how do you think you'd do it in Elm? <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="434611170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434611170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434611170">(Apr 21 2024 at 18:57)</a>:</h4>
<p>Elm uses <code>Task</code> so little, I'm not sure there'd be a ton of value in instrumenting it (given it'd leave most of the application out of scope). That said, if I had to, I'd probably introduce a custom <code>Task</code> type, give it the same API as the built-in task. That custom <code>Task</code> type could have a structure like this:</p>
<div class="codehilite"><pre><span></span><code>type TracingTask err val = TracingTask (TraceContext -&gt; Task err val)

type alias TraceContext = { id: String, startTime : Time }
</code></pre></div>
<p>For a more full-formed example, we defined a <code>Task</code> type in a similar fashion around <code>IO</code> in <code>nri-haskell</code>:<br>
<a href="https://github.com/NoRedInk/haskell-libraries/blob/trunk/nri-prelude/src/Platform/Internal.hs#L63">https://github.com/NoRedInk/haskell-libraries/blob/trunk/nri-prelude/src/Platform/Internal.hs#L63</a></p>



<a name="434611277"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434611277" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434611277">(Apr 21 2024 at 18:58)</a>:</h4>
<p>oh I meant modeling <code>Job</code> in Elm</p>



<a name="434611297"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434611297" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434611297">(Apr 21 2024 at 18:59)</a>:</h4>
<p>since Elm doesn't have shadowing</p>



<a name="434611690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434611690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jasper Woudenberg <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434611690">(Apr 21 2024 at 19:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/383402-API-Design/topic/Tasks.20returning.20.7B.7D/near/434611277">said</a>:</p>
<blockquote>
<p>oh I meant modeling <code>Job</code> in Elm</p>
</blockquote>
<p>Ah gotcha. Yeah, good question. Maybe define <code>Job.map2</code> and <code>Job.map3</code> and the like?</p>
<p>Nice question, I'll think a bit about this.</p>



<a name="434650676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650676">(Apr 22 2024 at 04:54)</a>:</h4>
<p>in playing around with <code>!</code>, i've found that ending a program in the basic-cli with _two_ statements that both use <code>!</code> works fine, but a single statement ending in <code>!</code> to end the program produces a type error</p>



<a name="434650683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650683">(Apr 22 2024 at 04:54)</a>:</h4>
<p>see <a href="https://gist.github.com/drewolson/635f4c39bd209338d3f6e5030720f1a9">https://gist.github.com/drewolson/635f4c39bd209338d3f6e5030720f1a9</a></p>



<a name="434650715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650715">(Apr 22 2024 at 04:55)</a>:</h4>
<p>output from the non-working case:</p>



<a name="434650717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650717">(Apr 22 2024 at 04:55)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ roc dev

── TYPE MISMATCH in main.roc ───────────────────────────────────────────────────

This 2nd argument to this function has an unexpected type:

22│              Stdout.line! &quot;Hello, $(name)&quot;

                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The argument is an anonymous function of type:

    {} -&gt; {}

But this function needs its 2nd argument to be:

    {} -&gt; InternalTask.Task c *

Tip: Type comparisons between an opaque type are only ever equal if

both types are the same opaque type. Did you mean to create an opaque

type by wrapping it? If I have an opaque type Age := U32 I can create

an instance of this opaque type by doing @Age 23.

────────────────────────────────────────────────────────────────────────────────

1 error and 0 warnings found in 27 ms

.

You can run the program anyway with roc run```
</code></pre></div>



<a name="434650828"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650828" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650828">(Apr 22 2024 at 04:56)</a>:</h4>
<p>Thank you, can you please log an issue. I'm pretty sure I know what is going wrong in this case</p>



<a name="434650858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650858">(Apr 22 2024 at 04:56)</a>:</h4>
<p>Just a link to the gist is all the description needed</p>



<a name="434650891"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650891" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650891">(Apr 22 2024 at 04:56)</a>:</h4>
<p>sure, make the issue in the roc repo?</p>



<a name="434650966"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/383402-API%20design/topic/Tasks%20returning%20%7B%7D/near/434650966" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> drew <a href="https://roc-lang.github.io/zulip-export/stream/383402-API-design/topic/Tasks.20returning.20.7B.7D.html#434650966">(Apr 22 2024 at 04:57)</a>:</h4>
<p>done, it's here <a href="https://github.com/roc-lang/roc/issues/6661">https://github.com/roc-lang/roc/issues/6661</a></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
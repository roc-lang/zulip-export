<html>
<head><meta charset="utf-8"><title>Roc and realtime audio signal processing · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html">Roc and realtime audio signal processing</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="432848408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432848408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432848408">(Apr 12 2024 at 07:40)</a>:</h4>
<p>I have been toying with the idea of using Roc for developing realtime audio applications - has anyone experimented in this area? If so how successful was it? In its most basic form this could look like using a lib like Portaudio in a platform and using Roc to generate the callback function that gets called with each sample tick. I’m a pretty inexperienced C developer though and I don’t yet fully understand the shape of the function that Roc outputs and the overhead it incudes that could impact performance in a tight audio loop. I’m keen to hear others experiences and share my own too, when the time comes!</p>



<a name="432849376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432849376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432849376">(Apr 12 2024 at 07:43)</a>:</h4>
<p>Sounds very doable. I would reach for a zig host, and call into portaudio to write the platform.</p>
<p>I've written a little about developing a platform <a href="https://lukewilliamboswell.github.io/roc-ray-experiment/">roc-ray-experiment article</a>. There may be something there you could use.</p>



<a name="432849472"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432849472" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432849472">(Apr 12 2024 at 07:43)</a>:</h4>
<p>I've got a few zig platforms we could probably hobble together to get something basic working.</p>



<a name="432850004"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432850004" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432850004">(Apr 12 2024 at 07:45)</a>:</h4>
<p>Fantastic - thanks Luke! I’ll take a look.</p>



<a name="432850020"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432850020" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432850020">(Apr 12 2024 at 07:45)</a>:</h4>
<p>It is's most basic form you could just have the <code>main</code> returned by roc be that callback function. Do you know what types you would like to work with?</p>



<a name="432850842"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432850842" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432850842">(Apr 12 2024 at 07:51)</a>:</h4>
<p>A basic mono signal function (like a distortion lookup table) might be float -&gt; float. I things might get more complicated when they need to use internal buffers to store samples in memory, such as a delay.</p>



<a name="432851224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432851224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432851224">(Apr 12 2024 at 07:54)</a>:</h4>
<p>I would probably start with a simple main function that takes a float, does some simple transformation on it and returns the resulting float</p>



<a name="432851402"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432851402" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432851402">(Apr 12 2024 at 07:55)</a>:</h4>
<p>That sounds like a really simple place to start.</p>



<a name="432851540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/432851540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#432851540">(Apr 12 2024 at 07:56)</a>:</h4>
<p>If you need any assistance let us know on zulip. Also <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> will be interested I'm sure.</p>



<a name="433247014"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433247014" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433247014">(Apr 15 2024 at 09:54)</a>:</h4>
<p>So I've implemented this in C and I have successfully managed to pass audio buffers through Roc in realtime. However the <code>roc__mainForHost_1_exposed_generic(&amp;rocOut, &amp;rocIn);</code> function is leaking memory. Does anyone have any clues as to why? Any suggestions appreciated!</p>
<p>It's also worth noting that the roc_alloc() and roc_dealloc() functions us malloc() and free(), which isn't recommended for sample accuracy. I don't think this is what is causing memory to leak however.</p>
<p>Here's my host.c:</p>
<div class="codehilite"><pre><span></span><code>#include &lt;errno.h&gt;
#include &lt;signal.h&gt;
#include &lt;stdbool.h&gt;
#include &lt;stdio.h&gt;
#include &lt;portaudio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;unistd.h&gt;
#include &lt;math.h&gt;
#include &lt;execinfo.h&gt;

#ifdef _WIN32
#else
#include &lt;sys/shm.h&gt;  // shm_open
#include &lt;sys/mman.h&gt; // for mmap
#include &lt;signal.h&gt;   // for kill
#endif

#define SAMPLE_RATE 44100
#define BLOCK_SIZE 256
#define NUM_CHANNELS 1 // Adjust for mono (1) or stereo (2)

// Roc memory management

void *roc_alloc(size_t size, unsigned int alignment)
{
  return malloc(size);
}

void *roc_realloc(void *ptr, size_t new_size, size_t old_size, unsigned int alignment)
{
  return realloc(ptr, new_size);
}

void roc_dealloc(void *ptr, unsigned int alignment)
{
  free(ptr);
}

void roc_panic(void *ptr, unsigned int alignment)
{
  char *msg = (char *)ptr;
  fprintf(stderr,
          &quot;Application crashed with message\n\n    %s\n\nShutting down\n&quot;, msg);
  exit(1);
}

// Roc debugging
void roc_dbg(char *loc, char *msg, char *src)
{
  fprintf(stderr, &quot;[%s] %s = %s\n&quot;, loc, src, msg);
}

void *roc_memset(void *str, int c, size_t n)
{
  return memset(str, c, n);
}

int roc_shm_open(char *name, int oflag, int mode)
{
#ifdef _WIN32
  return 0;
#else
  return shm_open(name, oflag, mode);
#endif
}

void *roc_mmap(void *addr, int length, int prot, int flags, int fd, int offset)
{
#ifdef _WIN32
  return addr;
#else
  return mmap(addr, length, prot, flags, fd, offset);
#endif
}

int roc_getppid()
{
#ifdef _WIN32
  return 0;
#else
  return getppid();
#endif
}

// Define the structure of the audio I/O buffer the Roc will work
struct RocList
{
  float *data;
  size_t len;
  size_t capacity;
};

// Define the Roc function
extern void roc__mainForHost_1_exposed_generic(struct RocList *outBuffer, struct RocList *inBuffer);

// Audio loop callback function
static int callback(const void *in,
                    void *out,
                    unsigned long framesPerBuffer,
                    const PaStreamCallbackTimeInfo *timeInfo,
                    PaStreamCallbackFlags statusFlags,
                    void *userData)
{

  // Declare Roc&#39;s input and output buffers
  struct RocList rocIn = {(float *)in, framesPerBuffer, framesPerBuffer};
  struct RocList rocOut;

  // Call the main Roc function
  // Possibly leaking memory
  roc__mainForHost_1_exposed_generic(&amp;rocOut, &amp;rocIn);

  // Copy the output from the Roc buffer to the audio codec output buffer
  memcpy(out, rocOut.data, framesPerBuffer * sizeof(float));

  return paContinue;
}

int main()
{
  PaError err;
  PaStream *stream;

  // Initialize PortAudio
  err = Pa_Initialize();
  if (err != paNoError)
  {
    fprintf(stderr, &quot;PortAudio error: %s\n&quot;, Pa_GetErrorText(err));
    return 1;
  }

  // Open a stream for playback and recording
  err = Pa_OpenDefaultStream(&amp;stream, NUM_CHANNELS, NUM_CHANNELS, paFloat32, SAMPLE_RATE, BLOCK_SIZE, callback, NULL);
  if (err != paNoError)
  {
    fprintf(stderr, &quot;PortAudio error: %s\n&quot;, Pa_GetErrorText(err));
    Pa_Terminate();
    return 1;
  }

  // Start, wait for user input, stop, close and terminate PortAudio
  err = Pa_StartStream(stream);
  if (err != paNoError)
  {
    fprintf(stderr, &quot;PortAudio error: %s\n&quot;, Pa_GetErrorText(err));
    Pa_CloseStream(stream);
    Pa_Terminate();
    return 1;
  }
  printf(&quot;Press any key to stop...\n&quot;);
  getchar();
  err = Pa_StopStream(stream);
  if (err != paNoError)
  {
    fprintf(stderr, &quot;PortAudio error: %s\n&quot;, Pa_GetErrorText(err));
  }
  Pa_CloseStream(stream);
  Pa_Terminate();

  return 0;
}
</code></pre></div>
<p>platform main.roc:</p>
<div class="codehilite"><pre><span></span><code>platform &quot;audioPlatform&quot;
    requires {} { main : List F32 -&gt; List F32 }
    exposes []
    packages {}
    imports []
    provides [mainForHost]

mainForHost : List F32 -&gt; List F32
mainForHost = \inputBuffer -&gt; main inputBuffer
</code></pre></div>
<p>and my Roc app:</p>
<div class="codehilite"><pre><span></span><code>app &quot;audioPlatformTest&quot;
    packages { pf: &quot;platform/main.roc&quot; }
    imports []
    provides [main] to pf

main : List F32 -&gt; List F32
main = \inputBuffer -&gt;

    # Map an identity function
    List.map
        inputBuffer
        (\a -&gt;

            a * 0.5
        )
</code></pre></div>



<a name="433257197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433257197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433257197">(Apr 15 2024 at 10:50)</a>:</h4>
<p>Could it be something like Roc is expecting you to free the output RocList?</p>



<a name="433257302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433257302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433257302">(Apr 15 2024 at 10:51)</a>:</h4>
<p>I'm guessing Roc will free the input RocList.</p>



<a name="433257349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433257349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433257349">(Apr 15 2024 at 10:51)</a>:</h4>
<p>This is definitely something I have very little confidence in.</p>



<a name="433308566"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433308566" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433308566">(Apr 15 2024 at 14:38)</a>:</h4>
<p>Yeah</p>



<a name="433308637"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433308637" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433308637">(Apr 15 2024 at 14:38)</a>:</h4>
<p>Need to free the output list</p>



<a name="433364982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433364982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433364982">(Apr 15 2024 at 19:02)</a>:</h4>
<p>Thanks both - I did try calling ‘free(rocOut.data)’ after the memcpy line in the callback but got a ‘pointer being freed was not allocated’ error</p>



<a name="433365499"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433365499" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433365499">(Apr 15 2024 at 19:05)</a>:</h4>
<p>Yeah, roc lists are a tad complicated. Currently only rust and zig have nice libraries for handling them.</p>



<a name="433365676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433365676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433365676">(Apr 15 2024 at 19:06)</a>:</h4>
<p>As a quick hack, try <code>free(rocOut.data - size_of(size_t))</code></p>



<a name="433409010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433409010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433409010">(Apr 15 2024 at 23:50)</a>:</h4>
<p>Thanks Brendan - no luck with this either. I'll see if I can address it using a different memory management strategy.</p>



<a name="433418205"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433418205" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433418205">(Apr 16 2024 at 01:19)</a>:</h4>
<p>Oh, the input array isn't being initialized in a valid way. That likely also causes issues here.</p>



<a name="433418579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433418579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433418579">(Apr 16 2024 at 01:23)</a>:</h4>
<p>OK - how so?</p>



<a name="433418742"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433418742" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433418742">(Apr 16 2024 at 01:24)</a>:</h4>
<p>I'm on a plane only typing with my phone. Can't to dive into details rn. Sorry.</p>



<a name="433418838"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433418838" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433418838">(Apr 16 2024 at 01:26)</a>:</h4>
<p>The issue fundamentally is that it has no refcount so roc will grab random data before the beginning of the array and assume it is the refcount.</p>



<a name="433418940"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433418940" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433418940">(Apr 16 2024 at 01:26)</a>:</h4>
<p>Probably what you want to do is pass it in as a seamless slice so that you don't need to copy around any data. I'll share code when I have the chance.</p>



<a name="433420043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433420043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433420043">(Apr 16 2024 at 01:37)</a>:</h4>
<p>Thank you!</p>



<a name="433565068"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433565068" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433565068">(Apr 16 2024 at 16:39)</a>:</h4>
<p>This is an example of passing a seamless slice to roc. By doing so, you retain control of the allocation and must free it. Roc essentially takes it in as read only: <a href="https://github.com/bhansconnect/roc-fuzz/blob/20388c307d7328168ebae4bfda2ff99bb10f2bc7/platform/host.cpp#L293-L296">https://github.com/bhansconnect/roc-fuzz/blob/20388c307d7328168ebae4bfda2ff99bb10f2bc7/platform/host.cpp#L293-L296</a></p>



<a name="433565324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433565324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433565324">(Apr 16 2024 at 16:40)</a>:</h4>
<p>Avoids needing to create a new allocation, add a refcount, clone the data, and pass that into roc.</p>



<a name="433566814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433566814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433566814">(Apr 16 2024 at 16:48)</a>:</h4>
<p>As an extra note, if you truly need to avoid all allocations for performance, there are ways to enforce that, but it is more complex. You would need to control that buffer that pa is using and then correctly pass it in uniquely to roc. After that, you would block all allocations reporting an error to make sure that the list is edited in place and never duplicated. Possible, definitely faster, but more wiring to do right. I can help with that if you hit perf issues and find it needed.</p>



<a name="433611252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433611252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433611252">(Apr 16 2024 at 21:35)</a>:</h4>
<p>Thanks for sharing this - really useful! I've tried applying the seamless slice approach. However the memory leak still persists. Please let me know if I'm applying the seamless slice incorrectly. </p>
<p>Here's the updated audio callback (including the definitions for RocList etc.) : </p>
<div class="codehilite"><pre><span></span><code>// Define the structure of the audio I/O buffer the Roc will work
struct RocList
{
  float *data;
  size_t len;
  size_t capacity;
};

const size_t SLICE_BIT = ((size_t)1) &lt;&lt; (8 * sizeof(size_t) - 1);
const size_t REFCOUNT_MAX = 0;

// Define the Roc function
extern void roc__mainForHost_1_exposed_generic(struct RocList *outBuffer, struct RocList *inBuffer);

// Audio loop callback function
static int callback(const void *in,
                    void *out,
                    unsigned long framesPerBuffer,
                    const PaStreamCallbackTimeInfo *timeInfo,
                    PaStreamCallbackFlags statusFlags,
                    void *userData)
{
  size_t rc = REFCOUNT_MAX;
  size_t slice_bits = (((size_t)&amp;rc) &gt;&gt; 1) | SLICE_BIT;

  // Declare Roc&#39;s input and output buffers
  struct RocList rocIn = {(float *)in, framesPerBuffer, slice_bits};
  struct RocList rocOut;

  // Call the main Roc function
  // Currently leaking memory
  roc__mainForHost_1_exposed_generic(&amp;rocOut, &amp;rocIn);

  // Copy the output from the Roc buffer to the audio codec output buffer
  memcpy(out, rocOut.data, framesPerBuffer * sizeof(float));

  return paContinue;
}
</code></pre></div>



<a name="433614264"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433614264" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433614264">(Apr 16 2024 at 21:58)</a>:</h4>
<p>Logging from <code>roc_alloc()</code>and. <code>roc_dealloc()</code>shows that new memory is being allocated with each call to <code>roc__mainForHost_1_exposed_generic()</code> but not deallocated, hence the leak. I don't want to be dynamically allocating and deallocating memory inside an audio callback anyway so I need to explore another approach I think.</p>



<a name="433615013"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433615013" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433615013">(Apr 16 2024 at 22:04)</a>:</h4>
<p>You still have to free <code>rocOut</code> as well.</p>



<a name="433641564"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433641564" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433641564">(Apr 17 2024 at 03:25)</a>:</h4>
<p>I have tried that (including your <code>free(rocOut.data - size_of(size_t))</code> suggestion) but it was never allocated via malloc() so I get an error. There may be some other way though that I'm not aware of. Sorry - I'm really hitting the limits of my knowledge of systems-level programming here!</p>



<a name="433647203"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433647203" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433647203">(Apr 17 2024 at 04:29)</a>:</h4>
<p>I imagine <code>rocOut.data</code> is allocated by roc using <code>roc_alloc()</code> and so it needs to be freed after the <code>memcpy</code>? I'm not sure, I haven't done any C in many years.</p>



<a name="433647332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433647332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433647332">(Apr 17 2024 at 04:31)</a>:</h4>
<p>So can you call <code>roc_dealloc(&amp;rocOut, 0);</code> maybe?</p>



<a name="433647368"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433647368" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433647368">(Apr 17 2024 at 04:31)</a>:</h4>
<p>I'm currently away on a business trip. When I get back, I'll definitely take a look. If you can put up a repo or gift with the full code, that would be helpful</p>



<a name="433647435"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433647435" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433647435">(Apr 17 2024 at 04:32)</a>:</h4>
<p>Should be able to take a look on Thursday or Friday</p>



<a name="433649198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433649198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433649198">(Apr 17 2024 at 04:55)</a>:</h4>
<p>Thanks Brendan - <a href="https://github.com/joseph-salmon/roc-audio-platform-test">here's the repo</a> if you would like to take a closer look. I really really appreciate your help on this!</p>



<a name="433649324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433649324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433649324">(Apr 17 2024 at 04:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing/near/433647332">said</a>:</p>
<blockquote>
<p><code>roc_dealloc(&amp;rocOut, 0);</code></p>
</blockquote>
<p>Thanks Luke - yeah I did try that and received one of these: <br>
<code>main(82727,0x16d78f000) malloc: *** error for object 0x16d78daa0: pointer being freed was not allocated</code></p>



<a name="433662831"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433662831" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433662831">(Apr 17 2024 at 05:19)</a>:</h4>
<p>I wanted to test this out, also <a href="https://github.com/lukewilliamboswell/test_port_audio">made a test repository</a>. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="433662942"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433662942" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433662942">(Apr 17 2024 at 05:20)</a>:</h4>
<p>I have only copied your code above, so haven't investigated the leak or anything yet</p>



<a name="433663039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433663039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433663039">(Apr 17 2024 at 05:21)</a>:</h4>
<p>Would be good to double check that skipping the roc call is free from memory leaks.</p>



<a name="433665767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433665767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433665767">(Apr 17 2024 at 05:55)</a>:</h4>
<p>Can confirm there is no leak if I comment out <code>roc__mainForHost_1_exposed_generic(&amp;rocOut, &amp;rocIn);</code></p>



<a name="433665821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433665821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433665821">(Apr 17 2024 at 05:56)</a>:</h4>
<p>Just running Instruments to check things. Took me a little while to figure out that I need to sign the binary before Instruments can target it.</p>



<a name="433666003"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433666003" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433666003">(Apr 17 2024 at 05:58)</a>:</h4>
<h2>Not calling roc</h2>
<p><a href="/user_uploads/22008/D5AWVdptjcOrEkcwxPpeALdO/Screenshot-2024-04-17-at-15.57.05.png">Screenshot-2024-04-17-at-15.57.05.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/D5AWVdptjcOrEkcwxPpeALdO/Screenshot-2024-04-17-at-15.57.05.png" title="Screenshot-2024-04-17-at-15.57.05.png"><img src="/user_uploads/22008/D5AWVdptjcOrEkcwxPpeALdO/Screenshot-2024-04-17-at-15.57.05.png"></a></div><h2>With the call to roc</h2>
<p><a href="/user_uploads/22008/dpdTSaO16cMC_FQ5K7WilDZU/Screenshot-2024-04-17-at-15.57.59.png">Screenshot-2024-04-17-at-15.57.59.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/dpdTSaO16cMC_FQ5K7WilDZU/Screenshot-2024-04-17-at-15.57.59.png" title="Screenshot-2024-04-17-at-15.57.59.png"><img src="/user_uploads/22008/dpdTSaO16cMC_FQ5K7WilDZU/Screenshot-2024-04-17-at-15.57.59.png"></a></div>



<a name="433695019"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433695019" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433695019">(Apr 17 2024 at 07:55)</a>:</h4>
<p>Yup! This is pretty much what I'm seeing too. Roc doesn't seem to be deallocating anything?</p>



<a name="433700283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433700283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433700283">(Apr 17 2024 at 08:23)</a>:</h4>
<p>Solved it</p>



<a name="433700294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433700294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433700294">(Apr 17 2024 at 08:23)</a>:</h4>
<p><span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="433700486"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433700486" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433700486">(Apr 17 2024 at 08:24)</a>:</h4>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">subtract_from_pointer</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">char_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span><span class="w">  </span><span class="c1">// Cast to char* to perform byte-wise arithmetic</span>
<span class="w">    </span><span class="n">char_ptr</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mh">0x8</span><span class="p">;</span><span class="w">               </span><span class="c1">// Subtract 8 bytes</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">char_ptr</span><span class="p">;</span><span class="w">       </span><span class="c1">// Cast back to void* if needed</span>
<span class="p">}</span>

<span class="c1">// then we can free the pointer</span>
<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subtract_from_pointer</span><span class="p">(</span><span class="n">rocOut</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</code></pre></div>



<a name="433700572"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433700572" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433700572">(Apr 17 2024 at 08:25)</a>:</h4>
<p><code>rocOut.data</code> actually points 1 byte ahead of where the pointer that is allocated</p>



<a name="433700853"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433700853" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433700853">(Apr 17 2024 at 08:26)</a>:</h4>
<p>I'm sure there is a better explanation, but at least now I have a program without the memory leak.</p>



<a name="433713568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433713568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433713568">(Apr 17 2024 at 09:36)</a>:</h4>
<p>That's fixed it - amazing! Thanks so much!</p>



<a name="433714730"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433714730" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joe Salmon <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433714730">(Apr 17 2024 at 09:43)</a>:</h4>
<p>Otherwise, I'm thrilled to see how little overhead Roc adds to the audio loop (so far!). It will interesting to see how it performs once I start throwing some more complex computations in there. But for now I have a pure functional app that is processing realtime audio, which feels pretty exciting!</p>



<a name="433748886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20and%20realtime%20audio%20signal%20processing/near/433748886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20and.20realtime.20audio.20signal.20processing.html#433748886">(Apr 17 2024 at 12:52)</a>:</h4>
<p>Ah, that's what I missed. It is a void*. So shifting it didn't work.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
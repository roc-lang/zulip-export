<html>
<head><meta charset="utf-8"><title>`roc dev` freezing when mapping and running `roc-pg` query · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html">`roc dev` freezing when mapping and running `roc-pg` query</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="439539113"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439539113" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439539113">(May 20 2024 at 09:51)</a>:</h4>
<p>Hi! I'm learning Roc and have gotten stuck on an issue where <code>roc dev</code> freezes while running my code. The issue occurs when running a database query using <code>roc-pg</code> while mapping over a list. The code builds and <code>roc check</code> passes.</p>
<p>It's probably due to a misunderstanding on my part as I'm new, so I'd appreciate help in understanding this better.</p>
<p>Here are three examples building up to the issue:</p>
<div class="codehilite"><pre><span></span><code>    # Works as expected. Output:
    #   pg: 9000
    record &lt;- Pg.Client.withConnect
            {
                host: &quot;localhost&quot;,
                port: 5432,
                user: &quot;postgres&quot;,
                database: &quot;postgres&quot;,
                auth: Password &quot;hunter2&quot;,
            }
            (\client -&gt;
                Pg.Cmd.new &quot;SELECT 9000 AS foo&quot;
                |&gt; Pg.Cmd.expect1
                    (
                        Pg.Result.succeed {
                            foo: &lt;- Pg.Result.str &quot;foo&quot; |&gt; Pg.Result.apply,
                        }
                    )
                |&gt; Pg.Client.command client)
        |&gt; Task.await
    Stdout.line! &quot;pg: $(record.foo)&quot;
</code></pre></div>
<p>This makes me believe I'm using <code>roc-pg</code> correctly.</p>
<div class="codehilite"><pre><span></span><code>    # Works as expected. Output:
    #   foo: 0
    #   foo: 1
    List.range { start: At 0, end: At 1 }
        |&gt; Task.forEach! \n -&gt;
            Stdout.line! &quot;foo: $(Num.toStr n)&quot;
</code></pre></div>
<p>This makes me believe I'm using <code>Task.forEach</code> correctly.</p>
<div class="codehilite"><pre><span></span><code>    # Freezes when running `roc dev`. `.roc-wrapped` uses 199 % CPU (the equivalent of maxing out two cores).
    # Expected output:
    #   foo: 0
    #   pg: 9000
    #   foo: 1
    #   pg: 9000
    List.range { start: At 0, end: At 1 }
    |&gt; Task.forEach \n -&gt;
        Stdout.line! &quot;foo: $(Num.toStr n)&quot;
        r &lt;- Pg.Client.withConnect
                {
                    host: &quot;localhost&quot;,
                    port: 5432,
                    user: &quot;postgres&quot;,
                    database: &quot;postgres&quot;,
                    auth: Password &quot;hunter2&quot;,
                }
                (\client -&gt;
                    Pg.Cmd.new &quot;SELECT 9000 AS foo&quot;
                    |&gt; Pg.Cmd.expect1
                        (
                            Pg.Result.succeed {
                                foo: &lt;- Pg.Result.str &quot;foo&quot; |&gt; Pg.Result.apply,
                            }
                        )
                    |&gt; Pg.Client.command client)
            |&gt; Task.await
        Stdout.line! &quot;pg: $(r.foo)&quot;
</code></pre></div>
<p>I've tried expressing the last example in different ways to understand why <code>roc dev</code> freezes, but haven't been able to figure it out. Can anyone help me understand this better?</p>
<p>Here's the full program: <a href="https://pastecode.io/s/n8mfzskt">https://pastecode.io/s/n8mfzskt</a></p>
<p>macOS aarch64<br>
Roc built from latest current source, commit: 7e1a82f048f8ac77b07c7f03ffd30bb13f92edba</p>



<a name="439621188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439621188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439621188">(May 20 2024 at 17:39)</a>:</h4>
<p><span class="user-mention" data-user-id="489294">@Agus Zubiaga</span> created roc-pg and might have an idea? <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="439622243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439622243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439622243">(May 20 2024 at 17:45)</a>:</h4>
<p>Profiling the executable to check where it is spending it's time can also be helpful.<br>
In the first presentation of our <a href="https://drive.google.com/drive/folders/1OrgVPE6qGx34MT8oP2aNsop1oAs3_EVl?usp=share_link">Dec 2023 meetup</a> Brendan explains how you can profile Roc code.</p>



<a name="439622746"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439622746" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439622746">(May 20 2024 at 17:48)</a>:</h4>
<p>I’ll try this later when I’m home, but running <code>roc check</code> might help find the issue. There are some times where <code>dev</code> hangs instead of reporting an error.</p>



<a name="439623021"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439623021" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439623021">(May 20 2024 at 17:50)</a>:</h4>
<blockquote>
<p>The code builds and <code>roc check</code> passes.</p>
</blockquote>
<p><code>roc check</code> was good</p>



<a name="439623214"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439623214" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439623214">(May 20 2024 at 17:51)</a>:</h4>
<p>Oh, I missed that</p>



<a name="439623446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439623446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439623446">(May 20 2024 at 17:53)</a>:</h4>
<p>I wonder if this is somehow related to creating connections in a loop. That should work, but you can also create the connection once and use <code>Task.forEach</code> inside.</p>



<a name="439630046"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439630046" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439630046">(May 20 2024 at 18:32)</a>:</h4>
<p>Ok, it's the compiler that's hanging, not the binary. It seems that the interaction with <code>Task.forEach</code> causes the hang. It works as expected if I extract its body into a function and call it from <code>main</code>:</p>
<div class="codehilite"><pre><span></span><code>main =
    run! 0
    run! 1

run = \n -&gt;
    Stdout.line! &quot;foo: $(Num.toStr n)&quot;

    r &lt;- Pg.Client.withConnect
            # ... the rest
</code></pre></div>



<a name="439630936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439630936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439630936">(May 20 2024 at 18:38)</a>:</h4>
<p>If we use <code>Task.loop</code> instead of <code>Task.forEach</code>, it works fine also:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">main</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nx">Task</span><span class="p">.</span><span class="nx">loop</span><span class="w"> </span><span class="p">(</span><span class="nx">List</span><span class="p">.</span><span class="nx">range</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">start</span><span class="o">:</span><span class="w"> </span><span class="nx">At</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nv">end</span><span class="o">:</span><span class="w"> </span><span class="nx">At</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="err">\</span><span class="nx">rem</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="nx">rem</span><span class="w"> </span><span class="o">is</span>
<span class="w">            </span><span class="p">[]</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nx">Task</span><span class="p">.</span><span class="nx">ok</span><span class="w"> </span><span class="p">(</span><span class="nx">Done</span><span class="w"> </span><span class="p">{})</span>

<span class="w">            </span><span class="p">[</span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="nx">as</span><span class="w"> </span><span class="nx">rest</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nx">run</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">map</span><span class="w"> </span><span class="err">\</span><span class="p">{}</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Step</span><span class="w"> </span><span class="nx">rest</span>

<span class="nv">run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">n</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nx">Stdout</span><span class="p">.</span><span class="nx">line</span><span class="o">!</span><span class="w"> </span><span class="s">"foo: $(Num.toStr n)"</span>

<span class="w">    </span><span class="nx">r</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">Pg</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">withConnect</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nv">host</span><span class="o">:</span><span class="w"> </span><span class="s">"localhost"</span><span class="p">,</span>
<span class="w">                </span><span class="nv">port</span><span class="o">:</span><span class="w"> </span><span class="mi">5432</span><span class="p">,</span>
<span class="w">                </span><span class="nv">user</span><span class="o">:</span><span class="w"> </span><span class="s">"postgres"</span><span class="p">,</span>
<span class="w">                </span><span class="nv">database</span><span class="o">:</span><span class="w"> </span><span class="s">"postgres"</span><span class="p">,</span>
<span class="w">                </span><span class="nv">auth</span><span class="o">:</span><span class="w"> </span><span class="nx">Password</span><span class="w"> </span><span class="s">"hunter2"</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="p">(</span><span class="err">\</span><span class="nx">client</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nx">Pg</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">.</span><span class="nx">new</span><span class="w"> </span><span class="s">"SELECT 9000 AS foo"</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Pg</span><span class="p">.</span><span class="nx">Cmd</span><span class="p">.</span><span class="nx">expect1</span>
<span class="w">                    </span><span class="p">(</span>
<span class="w">                        </span><span class="nx">Pg</span><span class="p">.</span><span class="nx">Result</span><span class="p">.</span><span class="nx">succeed</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="nv">foo</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">Pg</span><span class="p">.</span><span class="nx">Result</span><span class="p">.</span><span class="nx">str</span><span class="w"> </span><span class="s">"foo"</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Pg</span><span class="p">.</span><span class="nx">Result</span><span class="p">.</span><span class="nx">apply</span><span class="p">,</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">)</span>
<span class="w">                </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Pg</span><span class="p">.</span><span class="nx">Client</span><span class="p">.</span><span class="nx">command</span><span class="w"> </span><span class="nx">client</span><span class="p">)</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Task</span><span class="p">.</span><span class="nx">await</span>

<span class="w">    </span><span class="nx">Stdout</span><span class="p">.</span><span class="nx">line</span><span class="o">!</span><span class="w"> </span><span class="s">"pg: $(r.foo)"</span>
</code></pre></div>



<a name="439631041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439631041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439631041">(May 20 2024 at 18:39)</a>:</h4>
<p>So there seems to be something about <code>Task.forEach</code> specifically that makes the compiler hang</p>



<a name="439631414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439631414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439631414">(May 20 2024 at 18:41)</a>:</h4>
<p>Thank you! Besides <code>Task.forEach</code> the issue may also occur with <code>Task.seq</code> as that's one of the other alternatives I tried before asking. I don't have a reproduction of that right now though.</p>



<a name="439631415"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439631415" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439631415">(May 20 2024 at 18:41)</a>:</h4>
<p>interesting! can we get it down to a minimal repro, possibly not involving roc-pg?</p>



<a name="439631623"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439631623" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439631623">(May 20 2024 at 18:42)</a>:</h4>
<p>I have tried to reproduce it without <code>roc-pg</code> but was unable (not to say it's not possible!) I can tinker with it bit more to see if I can nail it down.</p>



<a name="439631933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439631933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439631933">(May 20 2024 at 18:44)</a>:</h4>
<p>appreciate it!</p>



<a name="439632111"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439632111" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439632111">(May 20 2024 at 18:45)</a>:</h4>
<p>compiler bugs can be super hard to fix without a minimal repro because even a small application results in a ton of in-memory information to scan through looking for problems <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="439632151"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439632151" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439632151">(May 20 2024 at 18:45)</a>:</h4>
<p>Indeed, I can relate!</p>



<a name="439657048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439657048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439657048">(May 20 2024 at 18:47)</a>:</h4>
<p>I'm trying to repro with just <code>Tcp</code>, but it seems to work fine unfortunately</p>



<a name="439657141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439657141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439657141">(May 20 2024 at 18:48)</a>:</h4>
<p>or fortunately <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="439657354"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439657354" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439657354">(May 20 2024 at 18:49)</a>:</h4>
<p>try moving something into a separate module?</p>



<a name="439657399"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439657399" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439657399">(May 20 2024 at 18:49)</a>:</h4>
<p>there's a known bug related to things working until you introduce a separate module</p>



<a name="439657407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439657407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439657407">(May 20 2024 at 18:49)</a>:</h4>
<p>I wonder if it may be because the "effect" comes from a separate package</p>



<a name="439657476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439657476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439657476">(May 20 2024 at 18:50)</a>:</h4>
<p>Yes, I guess that's the same line of thinking</p>



<a name="439658449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439658449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439658449">(May 20 2024 at 18:54)</a>:</h4>
<p>It seems to work fine on a different module. I'll try package.</p>



<a name="439658806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439658806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439658806">(May 20 2024 at 18:56)</a>:</h4>
<p>That works too <span aria-label="confused" class="emoji emoji-1f615" role="img" title="confused">:confused:</span></p>



<a name="439659375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439659375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439659375">(May 20 2024 at 18:59)</a>:</h4>
<p>Works: <code>File.writeUtf8</code>,<code>Sleep.millis</code>, <code>Http.send</code></p>



<a name="439661208"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439661208" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439661208">(May 20 2024 at 19:11)</a>:</h4>
<p><code>roc-pg</code> does a lot of Task chaining and looping internally. It might not be that the compiler is hanging, but that it's actually making super slow progress.</p>



<a name="439661761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439661761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439661761">(May 20 2024 at 19:13)</a>:</h4>
<p>OK, I'm letting it run now with <code>roc dev --max-threads 16</code></p>



<a name="439661896"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439661896" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439661896">(May 20 2024 at 19:14)</a>:</h4>
<p>The fact it doesn't happen with <code>Task.loop</code> gives me hope it's fixable</p>



<a name="439662075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439662075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439662075">(May 20 2024 at 19:15)</a>:</h4>
<p>FYI: it does not seem to utilize more cores despite the flag (199 % CPU util). RAM usage is increasing steadily: 25 GB now</p>



<a name="439662254"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439662254" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439662254">(May 20 2024 at 19:16)</a>:</h4>
<p>RAM utilization peaked at 26 GB and it's not increasing (staying 24-26 GB) despite plenty more being available</p>



<a name="439662352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439662352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439662352">(May 20 2024 at 19:16)</a>:</h4>
<p>Is the compiler really using that much RAM?</p>



<a name="439662393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439662393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439662393">(May 20 2024 at 19:17)</a>:</h4>
<p><code>btop</code> claims it is. the process name is <code>.roc-wrapped</code></p>



<a name="439662423"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439662423" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439662423">(May 20 2024 at 19:17)</a>:</h4>
<p>Decreasing slowly now, 15 GB, 10 GB ...</p>



<a name="439662741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439662741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439662741">(May 20 2024 at 19:18)</a>:</h4>
<p>is this a new record for most pathological compiler explosion discovered? <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<a name="439662858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439662858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439662858">(May 20 2024 at 19:19)</a>:</h4>
<p><code>roc-pg</code> keeps delivering those <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="439663250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663250">(May 20 2024 at 19:21)</a>:</h4>
<p>better to find them now than when they block things in production!</p>



<a name="439663276"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663276" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663276">(May 20 2024 at 19:21)</a>:</h4>
<p>It's been hovering around 3.4-4.1 GB for a while now. The process has been doing 199 % CPU util since start. The machine is an Apple Macbook Pro M1 Max with 64 GB of RAM.</p>



<a name="439663307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663307">(May 20 2024 at 19:22)</a>:</h4>
<p>I bet it'd be easier on the compiler if I didn't use combinators for decoding, but yeah, it's good to find these now</p>



<a name="439663599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663599">(May 20 2024 at 19:23)</a>:</h4>
<p>Huh, could the process be reading/writing from disk a lot? I'm not sure if it's this process, but a lot of disk IO is happening</p>



<a name="439663724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663724">(May 20 2024 at 19:24)</a>:</h4>
<p>I wonder if it's outputting a ton of LLVM IR</p>



<a name="439663767"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663767" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663767">(May 20 2024 at 19:24)</a>:</h4>
<p>I know Ayaz fixed a case like that when I first presented roc-pg</p>



<a name="439663771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663771">(May 20 2024 at 19:24)</a>:</h4>
<p>The process <code>kernel_task</code> just wrote over 10 GB to disk in 30s or so</p>



<a name="439663819"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439663819" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439663819">(May 20 2024 at 19:25)</a>:</h4>
<p>aaand another 15 GB</p>



<a name="439664070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439664070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439664070">(May 20 2024 at 19:26)</a>:</h4>
<p>Total since the process started <code>kernel_task</code> has written 103 GB to disk</p>



<a name="439664195"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439664195" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439664195">(May 20 2024 at 19:27)</a>:</h4>
<p>Poor SSD <span aria-label="joy" class="emoji emoji-1f602" role="img" title="joy">:joy:</span></p>



<a name="439664240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439664240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439664240">(May 20 2024 at 19:27)</a>:</h4>
<p>but... you get type-safe queries</p>



<a name="439664289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439664289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439664289">(May 20 2024 at 19:27)</a>:</h4>
<p>#worthit</p>



<a name="439664393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439664393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439664393">(May 20 2024 at 19:28)</a>:</h4>
<p>OK, it finished!</p>
<p><code>fish: Job 1, 'roc dev --max-threads 16' terminated by signal SIGKILL (Forced quit)</code></p>
<p>I did not force kill it, so I'm guessing the OS did</p>



<a name="439664526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439664526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439664526">(May 20 2024 at 19:29)</a>:</h4>
<p>What an adventure <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="439665152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439665152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439665152">(May 20 2024 at 19:32)</a>:</h4>
<p>FYI: I'm low on disk space (&lt;100 GB left) so it's possible that it ran out of space if the writes were temporary (or maybe it's just a coincidence that the numbers kind of add up)</p>



<a name="439668152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439668152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439668152">(May 20 2024 at 19:52)</a>:</h4>
<p>This is my smallest reproduction:</p>
<div class="codehilite"><pre><span></span><code>    List.range { start: At 0, end: At 1 }
    |&gt; Task.forEach \n -&gt;
        Pg.Client.withConnect
            {
                host: &quot;localhost&quot;,
                port: 5432,
                user: &quot;postgres&quot;,
                database: &quot;postgres&quot;,
                auth: Password &quot;hunter2&quot;,
            }
            \_ -&gt; Task.ok {}
</code></pre></div>



<a name="439670162"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439670162" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439670162">(May 20 2024 at 20:01)</a>:</h4>
<p><span class="user-mention" data-user-id="489294">@Agus Zubiaga</span> I've tried several other effects but cannot reproduce without <code>roc-pg</code>. It seems the query itself does not matter, so that's good! I'll hop off for tonight, but do reach out if I can help in any way. I'll probably be testing this more tomorrow! Thanks for creating <code>roc-pg</code>, I'm really grateful that it exists! It's what got me over the hump to explore Roc seriously <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="439670929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/439670929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#439670929">(May 20 2024 at 20:06)</a>:</h4>
<p>Thanks! That reduction in scope is significant</p>



<a name="440110393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/440110393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Niclas Ahden <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#440110393">(May 22 2024 at 14:46)</a>:</h4>
<p>This program passes <code>roc check</code> but panics during compilation:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">app</span><span class="w"> </span><span class="p">[</span><span class="n">main</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pf</span><span class="kt">:</span><span class="w"> </span><span class="n">platform</span><span class="w"> </span><span class="s">"https://github.com/roc-lang/basic-cli/releases/download/0.10.0/vNe6s9hWzoTZtFmNkvEICPErI9ptji_ySjicO6CkucY.tar.br"</span><span class="p">,</span>
<span class="w">    </span><span class="n">pg</span><span class="kt">:</span><span class="w"> </span><span class="s">"https://github.com/agu-z/roc-pg/releases/download/0.1.0/nb1q6kN1pu1xvv45w2tE7JjbQ60hOyR1NMxxhRMCVFc.tar.br"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kr">import</span><span class="w"> </span><span class="nn">pf.Task</span><span class="w"> </span><span class="n">exposing</span><span class="w"> </span><span class="p">[</span><span class="kt">Task</span><span class="p">,</span><span class="w"> </span><span class="n">await</span><span class="p">]</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">pf.Stdout</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">pg.Pg.Cmd</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">pg.Pg.Client</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">pg.Pg.Result</span>

<span class="nf">main</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="kr">_</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">queryA</span><span class="o">!</span>
<span class="w">    </span><span class="kr">_</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">queryB</span><span class="o">!</span>
<span class="w">    </span><span class="kt">Stdout</span><span class="o">.</span><span class="n">line</span><span class="o">!</span><span class="w"> </span><span class="s">"Done"</span>

<span class="nf">queryA</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Client</span><span class="o">.</span><span class="n">withConnect</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">host</span><span class="kt">:</span><span class="w"> </span><span class="s">"localhost"</span><span class="p">,</span>
<span class="w">            </span><span class="n">port</span><span class="kt">:</span><span class="w"> </span><span class="mi">5432</span><span class="p">,</span>
<span class="w">            </span><span class="n">user</span><span class="kt">:</span><span class="w"> </span><span class="s">"postgres"</span><span class="p">,</span>
<span class="w">            </span><span class="n">database</span><span class="kt">:</span><span class="w"> </span><span class="s">"postgres"</span><span class="p">,</span>
<span class="w">            </span><span class="n">auth</span><span class="kt">:</span><span class="w"> </span><span class="kt">Password</span><span class="w"> </span><span class="s">"hunter2"</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">\</span><span class="n">client</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">            </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Cmd</span><span class="o">.</span><span class="n">new</span><span class="w"> </span><span class="s">"SELECT 9000 As foo"</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Cmd</span><span class="o">.</span><span class="n">expect1</span>
<span class="w">                </span><span class="p">(</span>
<span class="w">                    </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Result</span><span class="o">.</span><span class="n">succeed</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">foo</span><span class="kt">:</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Result</span><span class="o">.</span><span class="n">i64</span><span class="w"> </span><span class="s">"foo"</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Result</span><span class="o">.</span><span class="n">apply</span><span class="p">,</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">            </span><span class="o">|&gt;</span><span class="w"> </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Client</span><span class="o">.</span><span class="n">command</span><span class="w"> </span><span class="n">client</span>

<span class="nf">queryB</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="kt">Pg</span><span class="o">.</span><span class="kt">Client</span><span class="o">.</span><span class="n">withConnect</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">host</span><span class="kt">:</span><span class="w"> </span><span class="s">"localhost"</span><span class="p">,</span>
<span class="w">            </span><span class="n">port</span><span class="kt">:</span><span class="w"> </span><span class="mi">5432</span><span class="p">,</span>
<span class="w">            </span><span class="n">user</span><span class="kt">:</span><span class="w"> </span><span class="s">"postgres"</span><span class="p">,</span>
<span class="w">            </span><span class="n">database</span><span class="kt">:</span><span class="w"> </span><span class="s">"postgres"</span><span class="p">,</span>
<span class="w">            </span><span class="n">auth</span><span class="kt">:</span><span class="w"> </span><span class="kt">Password</span><span class="w"> </span><span class="s">"hunter2"</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nf">\</span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<p>The compilation panic comes from <code>queryB</code> and it happens when the query is <code>\_ -&gt; Task.ok {}</code> instead of an actual query. Uncomment <code>_ = queryB!</code> and the code compiles and runs.</p>
<p>Here's the panic with backtrace:</p>
<div class="codehilite"><pre><span></span><code>$ RUST_BACKTRACE=1 roc dev pg3.roc
thread &#39;main&#39; panicked at crates/compiler/gen_llvm/src/llvm/build.rs:5764:19:
Error in alias analysis: error in module ModName(&quot;UserApp&quot;), function definition FuncName(&quot;.\x00\x00\x00\x11\x00\x00\x00=}\xef\t\x02\xf9\x17\xef&quot;), definition of value binding ValueId(5): could not find func in module ModName(&quot;UserApp&quot;) with name FuncName(&quot;=\x00\x00\x00\x06\x00\x00\x00\x1b\x82%\x07f\x82R\xe4&quot;)
stack backtrace:
   0: rust_begin_unwind
             at /rustc/07dca489ac2d933c78d3c5158e3f43beefeb02ce/library/std/src/panicking.rs:645:5
   1: core::panicking::panic_fmt
             at /rustc/07dca489ac2d933c78d3c5158e3f43beefeb02ce/library/core/src/panicking.rs:72:14
   2: roc_gen_llvm::llvm::build::build_procedures_help
   3: roc_gen_llvm::llvm::build::build_procedures
   4: roc_build::program::gen_from_mono_module
   5: roc_build::program::build_loaded_file
   6: roc_build::program::build_file
   7: roc_cli::build
   8: roc::main
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
</code></pre></div>
<p>macOS aarch64<br>
roc build from source, commit 33075285b7298dcd76772c8763368b1ca167101c</p>
<p><span class="user-mention" data-user-id="489294">@Agus Zubiaga</span> I think it might be a separate issue, but I'll post it here for completeness as my previous minimal reproduction used the same kind of "empty query". I hope this is helpful; please let me know if you prefer that I don't ping about this issue <span aria-label="ok" class="emoji emoji-1f44c" role="img" title="ok">:ok:</span></p>



<a name="440114507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%60roc%20dev%60%20freezing%20when%20mapping%20and%20running%20%60roc-pg%60%20query/near/440114507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.60roc.20dev.60.20freezing.20when.20mapping.20and.20running.20.60roc-pg.60.20query.html#440114507">(May 22 2024 at 15:03)</a>:</h4>
<p>Yeah, unfortunately, “error in alias analysis” is caused by a longstanding compiler bug that’s not specific to <code>roc-pg</code> usage.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
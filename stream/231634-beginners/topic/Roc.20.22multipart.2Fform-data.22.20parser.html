<html>
<head><meta charset="utf-8"><title>Roc &quot;multipart/form-data&quot; parser · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html">Roc &quot;multipart/form-data&quot; parser</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="432189224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432189224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432189224">(Apr 09 2024 at 10:06)</a>:</h4>
<p>I'm having trouble, parsing <code>multipart/form-data</code>, since the builtin <code>List</code> lacks a <code>splitSequence</code> function.</p>



<a name="432189560"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432189560" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432189560">(Apr 09 2024 at 10:07)</a>:</h4>
<p>Is there a known parser for this format? Should I just bite the bullet and implement it with roc-parser, or am I misusing roc's Lists</p>



<a name="432191670"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432191670" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432191670">(Apr 09 2024 at 10:17)</a>:</h4>
<p>Should I write the zig primitive for the standard library?</p>



<a name="432201156"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432201156" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432201156">(Apr 09 2024 at 10:56)</a>:</h4>
<p>I don't know if anyone has looked at parsing that before.</p>



<a name="432201635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432201635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432201635">(Apr 09 2024 at 10:58)</a>:</h4>
<p><a href="https://roc-lang.github.io/basic-webserver/Http/#parseFormUrlEncoded">https://roc-lang.github.io/basic-webserver/Http/#parseFormUrlEncoded</a></p>



<a name="432201788"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432201788" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432201788">(Apr 09 2024 at 10:59)</a>:</h4>
<p>I added a parser for FormUrlEncoded data, I'm not sure if that helps.</p>



<a name="432202515"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432202515" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432202515">(Apr 09 2024 at 11:02)</a>:</h4>
<p>I think it would be great to have a parser written in Roc <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>



<a name="432207300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432207300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432207300">(Apr 09 2024 at 11:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser/near/432201635">said</a>:</p>
<blockquote>
<p><a href="https://roc-lang.github.io/basic-webserver/Http/#parseFormUrlEncoded">https://roc-lang.github.io/basic-webserver/Http/#parseFormUrlEncoded</a></p>
</blockquote>
<p>This is great! Sadly it doesn't solve my issue, since i'm parsing the format:</p>
<div class="codehilite"><pre><span></span><code>-----------------------------306137057221634204471155786395
Content-Disposition: form-data; name=&quot;text&quot;

abc
-----------------------------306137057221634204471155786395
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;&quot;
Content-Type: application/octet-stream


-----------------------------306137057221634204471155786395--
</code></pre></div>



<a name="432207812"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432207812" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432207812">(Apr 09 2024 at 11:25)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser/near/432202515">said</a>:</p>
<blockquote>
<p>I think it would be great to have a parser written in Roc <span aria-label="grinning" class="emoji emoji-1f600" role="img" title="grinning">:grinning:</span></p>
</blockquote>
<p>I'm a bit worried about the performance <span aria-label="face with spiral eyes" class="emoji emoji-1f635-200d-1f4ab" role="img" title="face with spiral eyes">:face_with_spiral_eyes:</span>.<br>
I'll try the roc only approach and if it doesn't work out I'll probably send a pr to either roc-builtins or roc-webserver.</p>



<a name="432222641"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432222641" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432222641">(Apr 09 2024 at 12:18)</a>:</h4>
<p>Here's my attempt, I don't think it's too performant</p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>listSplit : List a, List a -&gt; List (List a) where a implements Eq
listSplit = \inp, sep -&gt;
    if List.len sep == 0 then
        [inp]
    else
        inp
        |&gt; List.walk
            { out: [], buf: [], consume: [] }
            \{out, buf, consume}, elem -&gt;
                if elem == List.get sep (List.len consume) |&gt; unwrap then
                    { consume: consume |&gt; List.append elem, out, buf} |&gt; tryToConsume sep
                else
                    {consume:[], out, buf: buf |&gt; List.concat consume|&gt; List.append elem}
        |&gt; \{out,buf,consume} -&gt; out|&gt;List.append (List.concat buf consume)

tryToConsume = \{out,buf,consume},sep-&gt;
            if consume == sep then
                {out: out|&gt; List.append buf, buf:[],consume:[]}
            else
                {out,buf,consume}

expect listSplit ("a/b/c/d"|&gt;Str.toUtf8) ['/'] == ["a","b","c","d"]|&gt;List.map Str.toUtf8
expect listSplit ("a/b/c/d"|&gt;Str.toUtf8) ['/','/'] == ["a/b/c/d"]|&gt;List.map Str.toUtf8
expect listSplit ("/a//b/c/d/"|&gt;Str.toUtf8) ['/'] == ["","a","","b","c","d",""]|&gt;List.map Str.toUtf8
expect listSplit ("//a////b//c//d/"|&gt;Str.toUtf8) ['/','/'] == ["","a","","b","c","d/"]|&gt;List.map Str.toUtf8

unwrap = \a-&gt;
       when a is
            Ok e -&gt; e
            Err e -&gt; crash "unwraped Err $(Inspect.toStr e)"
</code></pre></div>



<a name="432222807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432222807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432222807">(Apr 09 2024 at 12:19)</a>:</h4>
<p>If any roc wizards would look at this, that would be just fine by me</p>



<a name="432263573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432263573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432263573">(Apr 09 2024 at 14:53)</a>:</h4>
<p>So this function is just Str.split, but on a list of bytes?</p>



<a name="432269072"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432269072" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432269072">(Apr 09 2024 at 15:15)</a>:</h4>
<p>Jep, that's why I was asking if I should implement it the same way (in zig) or just in roc</p>



<a name="432269233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432269233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432269233">(Apr 09 2024 at 15:16)</a>:</h4>
<p>And if the std lib would accept it</p>



<a name="432274479"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432274479" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432274479">(Apr 09 2024 at 15:37)</a>:</h4>
<p>It should be fine to implement in Roc with good performance. All of the sub pieces needed for list are there.</p>
<p>I know that separately, some changes are planned for <code>List.split</code> that never got implemented. We wanted to make the signatures cleaner and more consistent: <a href="https://github.com/roc-lang/roc/issues/6164">https://github.com/roc-lang/roc/issues/6164</a></p>
<p>That said, I think those changes would be around changing the current <code>List.split</code> to <code>List.splitAt</code>. Then implementing a new split function that is more simple to the string version, but still for single element splits. <code>List.splitBy: List a, a -&gt; List (List a)</code>. So no explicit plans for a 'List.splitSequences<code>, but would still be a good general discussion to have. Maybe it should fully match </code>Str.split` for flexibility.</p>



<a name="432275375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432275375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432275375">(Apr 09 2024 at 15:40)</a>:</h4>
<p>Anyway, for a performant version in Roc, it will be very important to use <code>List.take</code> and <code>List.drop</code> or <code>List.sublist</code> to extract the splits. I should be able to write something up later today. May also want to use a smart search algorithm like <a href="https://en.wikipedia.org/wiki/Boyer%E2%80%93Moore%E2%80%93Horspool_algorithm">https://en.wikipedia.org/wiki/Boyer%E2%80%93Moore%E2%80%93Horspool_algorithm</a>, but that would be more complex to get write and use in roc. Linear scan is probably a fine start.</p>



<a name="432524466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432524466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432524466">(Apr 10 2024 at 14:59)</a>:</h4>
<p>Should I mark as complete until the List.split rework?</p>



<a name="432533377"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432533377" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432533377">(Apr 10 2024 at 15:39)</a>:</h4>
<p>I don't think anyone is specifically working on the <code>List.split</code> rework. Someone claimed it in december, but it never progressed. Overall, it is open to ideas an contributors.</p>
<p>As for a performant implementation in pure roc, this  should be a solid base:</p>
<div class="codehilite" data-code-language="Elixir"><pre><span></span><code><span class="n">listSplitSeq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">isEmpty</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="n">then</span>
<span class="w">        </span><span class="p">[</span><span class="n">list</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">listSplitSeqHelper</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span>

<span class="n">listSplitSeqHelper</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="p">(</span><span class="nc">List</span><span class="w"> </span><span class="n">a</span><span class="p">),</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="nc">U64</span><span class="p">,</span><span class="w"> </span><span class="nc">U64</span><span class="p">,</span><span class="w"> </span><span class="nc">U64</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">List</span><span class="w"> </span><span class="p">(</span><span class="nc">List</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">implements</span><span class="w"> </span><span class="nc">Eq</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nc">Inspect</span>
<span class="n">listSplitSeqHelper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">seq</span><span class="p">,</span><span class="w"> </span><span class="n">lastMatch</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="ow">when</span><span class="w"> </span><span class="p">(</span><span class="nc">List</span><span class="o">.</span><span class="n">get</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">),</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">get</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="n">is</span>
<span class="w">        </span><span class="p">(</span><span class="nc">Ok</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="nc">Ok</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1"># Still matching correct</span>
<span class="w">            </span><span class="n">listSplitSeqHelper</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="n">lastMatch</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">        </span><span class="p">(</span><span class="nc">Ok</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="nc">Ok</span><span class="w"> </span><span class="bp">_</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1"># Failure to match</span>
<span class="w">            </span><span class="n">listSplitSeqHelper</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="n">lastMatch</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="c1"># (Ok _, Err OutOfBounds) -&gt;</span>
<span class="w">        </span><span class="p">(</span><span class="nc">Ok</span><span class="w"> </span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="nc">Err</span><span class="w"> </span><span class="bp">_</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1"># Managed to match the whole subseq</span>
<span class="w">            </span><span class="n">subList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">sublist</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">{</span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="n">lastMatch</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastMatch</span><span class="p">}</span>
<span class="w">            </span><span class="n">nextOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">append</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">subList</span>

<span class="w">            </span><span class="n">listSplitSeqHelper</span><span class="w"> </span><span class="n">nextOut</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="n">seq</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="p">(</span><span class="nc">Err</span><span class="w"> </span><span class="nc">OutOfBounds</span><span class="p">,</span><span class="w"> </span><span class="nc">Err</span><span class="w"> </span><span class="nc">OutOfBounds</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1"># Match all the way to the end, append last match and extra empty list</span>
<span class="w">            </span><span class="n">subList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">sublist</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">{</span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="n">lastMatch</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastMatch</span><span class="p">}</span>
<span class="w">            </span><span class="n">nextOut</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">append</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">subList</span>

<span class="w">            </span><span class="nc">List</span><span class="o">.</span><span class="n">append</span><span class="w"> </span><span class="n">nextOut</span><span class="w"> </span><span class="p">[]</span>

<span class="w">        </span><span class="p">(</span><span class="nc">Err</span><span class="w"> </span><span class="nc">OutOfBounds</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">            </span><span class="c1"># No more possible matches, append remaining</span>
<span class="w">            </span><span class="n">subList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">List</span><span class="o">.</span><span class="n">sublist</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">{</span><span class="ss">start</span><span class="p">:</span><span class="w"> </span><span class="n">lastMatch</span><span class="p">,</span><span class="w"> </span><span class="ss">len</span><span class="p">:</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastMatch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span>
<span class="w">            </span><span class="nc">List</span><span class="o">.</span><span class="n">append</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">subList</span>
</code></pre></div>
<p>It is just a linear scan, which is best for short sequences to match. To make it more optimal would be to add the fancy algorithm if the key is larger or the input list is really large. This might be worth making a builtin only for all of the extra bounds checks we could remove (especially if we add in the fancier algorithm).</p>



<a name="432543118"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432543118" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432543118">(Apr 10 2024 at 16:30)</a>:</h4>
<p>This is great! One minor question is it possible for anything to match <code>(Ok _, Ok _)</code> and not match <code>(Ok x, Ok y)</code>. To me this seems like the same case?</p>



<a name="432553188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432553188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432553188">(Apr 10 2024 at 17:25)</a>:</h4>
<p>The <code>(Ok x, Ok y)</code> has a guard clause. It only matches <code>if x == y</code></p>



<a name="432553427"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432553427" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432553427">(Apr 10 2024 at 17:26)</a>:</h4>
<p>Oh, one extra note <code>List (List a)</code> and <code>List Str</code> may have some general perf issues currently. I am actively working on a fix, but we have a refcounting issue with nested container types.</p>



<a name="432556001"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432556001" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432556001">(Apr 10 2024 at 17:43)</a>:</h4>
<p>Perhaps the quicket fix is to just send a patch to basic-webserver platform and implement the parser directly. Is there any other way to run native code other than platoform and builtins?</p>



<a name="432565537"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432565537" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432565537">(Apr 10 2024 at 18:48)</a>:</h4>
<blockquote>
<p>Is there any other way to run native code other than platoform and builtins?</p>
</blockquote>
<p>nope (well, depends on what you mean by "native code". Both builtins and regular roc code compile the same way. Builtins just have minor abilities to cut corners. Platform is the only place where side effects can happen at all)</p>



<a name="432569103"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432569103" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432569103">(Apr 10 2024 at 19:10)</a>:</h4>
<blockquote>
<p>Perhaps the quicket fix is to just send a patch to basic-webserver platform and implement the parser directly</p>
</blockquote>
<p>Eh, I think it would be best to keep it in roc or the standard library. If this does lead to measurable perf issues, that just more pressure to improve roc.</p>



<a name="432579905"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432579905" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432579905">(Apr 10 2024 at 20:28)</a>:</h4>
<p>Seems like the most sane action: <a href="https://github.com/roc-lang/basic-webserver/blob/3f1028a742180da649f73361b8f389b98e10ca7a/platform/Http.roc#L147">https://github.com/roc-lang/basic-webserver/blob/3f1028a742180da649f73361b8f389b98e10ca7a/platform/Http.roc#L147</a><br>
In the future sending files over http might make this a bottleneck</p>



<a name="432611382"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432611382" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432611382">(Apr 11 2024 at 01:02)</a>:</h4>
<p>I don't follow. That is just normal roc code.</p>



<a name="432641807"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432641807" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432641807">(Apr 11 2024 at 07:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser/near/432611382">said</a>:</p>
<blockquote>
<p>I don't follow. That is just normal roc code.</p>
</blockquote>
<p>Oh, sorry; It was meant as an example of the prevous parser also being just native roc.</p>



<a name="432641839"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Roc%20%22multipart/form-data%22%20parser/near/432641839" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Roc.20.22multipart.2Fform-data.22.20parser.html#432641839">(Apr 11 2024 at 07:17)</a>:</h4>
<p><span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Crash in recursive code · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html">Crash in recursive code</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="575373359"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575373359" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Claude Précourt <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575373359">(Feb 23 2026 at 18:46)</a>:</h4>
<p>Hello all,</p>
<p>Here's a pretty simple app which is walking down directories starting with a root path provided as a command line argument. I call it like so :</p>
<div class="codehilite"><pre><span></span><code>roc --no-cache -- /Users
</code></pre></div>
<p>I'm using the latest <em>basic-cli</em> platform available and the corresponding nightly version or Roc, but I get the same result with the most recent Roc build.</p>
<p>The issue is that it never recurses deeper than 7 levels and sometimes gives me the following crash :</p>
<div class="codehilite"><pre><span></span><code>*Roc crashed: RocList.refcount: getAllocationDataPtr returned null (capacity=4416949544, is_slice=false)*
</code></pre></div>

<p>The crash doesn't seem random as if I get it for a specific root directory, I'll get it consistently. But not every root path results in a crash.</p>
<div class="codehilite"><pre><span></span><code>app [main!] { pf: platform &quot;https://github.com/roc-lang/basic-cli/releases/download/alpha-0/HVZonS7HStbvGwhqvDZE1HreyDfqD6tayzFbi9rAUXYN.tar.zst&quot;}

import pf.Stdout
import pf.Dir
import pf.Path

main! = |args| {
  root_path = args.get(1)?
  files = walk_directory!(root_path, Bool.False)
  Stdout.line!(Str.inspect(files))
  Ok({})
}

walk_directory! : Str, Bool =&gt; List(Str)
walk_directory! = |root_path, include_invisibles| {
  dbg(root_path)
  content = dir_content!(root_path, include_invisibles)
  fold!(content.dirs, [], |dirs, d| {dirs.concat(walk_directory!(d, include_invisibles))})
}

dir_content! : Str, Bool =&gt; {dirs: List(Str), files: List(Str)}
dir_content! = |root_path, include_invisibles| {
    content = match Dir.list!(root_path) {
      Ok(c) =&gt; c
      Err(e) =&gt; {
        dbg(e)
        []
      }
    }

    fold!(content, {files: [], dirs: []},
      |state, path| {
        if include_invisibles.not() and path_is_visible(path).not() {
          state
        } else if Path.is_file!(path).ok_or(Bool.False) {
          {..state, files: state.files.append(path)}
        } else if Path.is_dir!(path).ok_or(Bool.False) {
          {..state, dirs: state.dirs.append(path)}
        } else {
          state
        }
      }
    )
}

fold! : List(item), state, (state, item =&gt; state) =&gt; state
fold! = |list, init, step| {
    var $state = init

    for item in list {
        $state = step($state, item)
    }

    $state
}

path_is_visible : Str -&gt; Bool
path_is_visible = |path| {
  basename(path).starts_with(&quot;.&quot;).not()
}

basename : Str -&gt; Str
basename = |path| {
  path.split_on(&quot;/&quot;).last().ok_or(&quot;&quot;)
}
</code></pre></div>
<p>Before asking my questions I tried my best to exhaust all other possibilities except using AI. Is there a mini guide somewhere in the discussions on how I could set one up, maybe in combination with Zed? </p>
<p>Thank you so much for the help and, mostly, for all the hard work on this amazing language!</p>



<a name="575377112"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575377112" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575377112">(Feb 23 2026 at 19:01)</a>:</h4>
<p>Hi <span class="user-mention" data-user-id="928710">@Claude Précourt</span>, I am done for today but I can take a look tomorrow and provide you with an AI prompt as well :)</p>



<a name="575377508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575377508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Claude Précourt <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575377508">(Feb 23 2026 at 19:04)</a>:</h4>
<p>So kind of you <span class="user-mention" data-user-id="361169">@Anton</span> ! There is obviously no rush, no code in production here.</p>



<a name="575524836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575524836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575524836">(Feb 24 2026 at 12:06)</a>:</h4>
<p>Here is the workaround, using more for loops instead of fold:</p>
<div class="codehilite"><pre><span></span><code>app [main!] { pf: platform &quot;../platform/main.roc&quot; }

import pf.Stdout
import pf.Dir
import pf.Path

main! = |args| {
  root_path = args.get(1)?
  files = walk_directory!(root_path, Bool.False)
  Stdout.line!(Str.inspect(files))
  Ok({})
}

walk_directory! : Str, Bool =&gt; List(Str)
walk_directory! = |root_path, include_invisibles| {
  dbg(root_path)
  dirs = get_subdirs!(root_path, include_invisibles)

  var $result = dirs
  $result = []
  for d in dirs {
    $result = $result.concat(walk_directory!(d, include_invisibles))
  }

  $result
}

get_subdirs! : Str, Bool =&gt; List(Str)
get_subdirs! = |root_path, include_invisibles| {
    content = match Dir.list!(root_path) {
      Ok(c) =&gt; c
      Err(e) =&gt; {
        dbg(e)
        []
      }
    }

    var $dirs = content
    $dirs = []

    for path in content {
      if include_invisibles.not() and path_is_visible(path).not() {
        {}
      } else if Path.is_dir!(path).ok_or(Bool.False) {
        $dirs = $dirs.append(path)
      }
    }

    $dirs
}

path_is_visible : Str -&gt; Bool
path_is_visible = |path| {
  basename(path).starts_with(&quot;.&quot;).not()
}

basename : Str -&gt; Str
basename = |path| {
  path.split_on(&quot;/&quot;).last().ok_or(&quot;&quot;)
}
</code></pre></div>



<a name="575525008"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575525008" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575525008">(Feb 24 2026 at 12:07)</a>:</h4>
<p>This was my prompt for Opus 4.6 (Effort High) in Claude Code:<br>
"""<br>
Looks like I am hitting a segmentation fault, please investigate:</p>
<div class="codehilite"><pre><span></span><code>❯ ./roc_nightly-macos_apple_silicon-2026-02-24-9d46896/roc --no-cache ./examples/dir-walk-crash.roc /Users/username/gitrepos/basic-cli4/basic-cli
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli&quot;
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli/crates&quot;
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli/crates/roc_host_lib&quot;
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli/crates/roc_host_lib/src&quot;
❯ echo $?
139
</code></pre></div>
<h1>tips</h1>
<p>You are working in basic-cli, a Roc platform made with Roc and Rust. Passing things between Roc and Rust requires special care and is prone to issue with the memory.</p>
<p>The source code of zig 0.15.2 is in /Users/username/gitrepos/zig, you can use it as documentation.</p>
<p>If you make any changes inside basic-cli that are not in the examples folder, you will most likely need to rebuild with ./build.sh</p>
<p>After you are done, run ./ci/all_tests.sh to confirm you did not break anything else.</p>
<h1>tips for the Roc repo</h1>
<p>You can find the source code for the nightly release at /Users/username/gitrepos/roc. That repo contains the Roc CLI, a compiler and interpreter written in zig. Ignore everything in the crates folder there, exclude it from all your searches.</p>
<p>You can rebuild the roc binary with <code>zig build roc</code>, this will put it in <code>./zig-out/bin/roc</code>.</p>
<p>Debugging:</p>
<ul>
<li>I encourage you to add debug prints and other necessary code to verify your hypothesis.</li>
<li>You can enable printing of std.log.debug statements by altering the log_level at the top of src/cli/main.zig</li>
<li>If you are missing a tool that is not installed and that would help significantly, stop execution and tell me what I need to install.</li>
<li>If you believe an issue is memory related, try building roc with refcount tracing: <code>zig build roc -Dtrace-refcount</code></li>
</ul>
<p>Style:</p>
<ul>
<li>Avoid using shortcuts, workarounds and special cases to get something to work. Avoid hardcoding things.</li>
<li>Try to follow existing patterns in the codebase when applicable.</li>
<li>Do not just change code when there are comments above it that explain the need for something to be done a certain way.</li>
<li>Write high quality code, this is a production codebase.</li>
</ul>
<p>If you encounter a network error when fetching dependencies, just run the command again.</p>
<p>Some zig commands do not output anything on success and just exit with code 0.</p>
<p>Note that <code>zig test</code> often does not work with our project, so we typically rely on <code>zig build test</code>, the flag <code>--summary all</code> can give your more info about which tests ran. You can run a single test with <code>zig build test -- --test-filter "substring that occurs in test name"</code>. If you add <code>--summary all</code> it must be located before the <code>-- --test-filter</code>.</p>
<p>It's recommended to always run with <code>--no-cache</code>, so <code>./zig-out/bin/roc myfile.roc --no-cache</code>, to prevent caching from behaving in unexpected ways.</p>
<p>Note that Roc has changed since your training data, it's recommended to check existing .roc files in the repo if you're getting confusing errors when adding Roc code.<br>
"""</p>



<a name="575525181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575525181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575525181">(Feb 24 2026 at 12:08)</a>:</h4>
<p>Here are instructions for the initial setup:<br>
"""<br>
The debugging process:</p>
<div class="codehilite"><pre><span></span><code>git clone https://github.com/roc-lang/basic-cli.git
cd basic-cli
git checkout migrate-zig-compiler
</code></pre></div>
<p>Get commit from latest nightly at <a href="https://github.com/roc-lang/nightlies/releases">https://github.com/roc-lang/nightlies/releases</a>: 9d46896bdfbb44f915a935d77b69ea86cdc23e78</p>
<p>In your local basic-cli folder, update the rev for roc_std_new in Cargo.toml to 9d46896bdfbb44f915a935d77b69ea86cdc23e78</p>
<p>run <code>./ci/all_tests.sh</code> as a sanity check. You will need to have zig 0.15.2 installed.</p>
<p>Create ./examples/dir-walk-crash.roc, changing the header to: <code>app [main!] { pf: platform "../platform/main.roc" }</code></p>
<p>I ran the following:</p>
<div class="codehilite"><pre><span></span><code>❯ ./roc_nightly-macos_apple_silicon-2026-02-24-9d46896/roc --no-cache ./examples/dir-walk-crash.roc /Users/username/gitrepos/basic-cli4/basic-cli
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli&quot;
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli/crates&quot;
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli/crates/roc_host_lib&quot;
dbg: &quot;/Users/username/gitrepos/basic-cli4/basic-cli/crates/roc_host_lib/src&quot;
❯ echo $?
139
</code></pre></div>
<p>Exit code 139 means a segmentation fault.</p>
<p>I set my local Roc repo to the same commit as the nightly <code>git checkout 9d46896bdfbb44f915a935d77b69ea86cdc23e78</code>.<br>
"""</p>



<a name="575525371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575525371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575525371">(Feb 24 2026 at 12:09)</a>:</h4>
<p>Claude thinks the bug is in Roc itself, not basic-cli, so I will look into a fix there too.</p>



<a name="575567339"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575567339" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Claude Précourt <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575567339">(Feb 24 2026 at 15:06)</a>:</h4>
<p>So the workaround is to use a less of a functional approach for now. I, Claude Human tend agree with Claude AI that the bug is in Roc itself. While debugging I added many dbg() statements everywhere I was calling effectful methods of basic-cli to make sure that I wasn't silently failing somewhere when interacting with the file system. </p>
<p>And thanks <span class="user-mention" data-user-id="361169">@Anton</span>  for the example prompt. I need to invest more time to get better at this AI stuff...  ;-)</p>



<a name="575567659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575567659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575567659">(Feb 24 2026 at 15:07)</a>:</h4>
<blockquote>
<p>I, Claude Human</p>
</blockquote>
<p>everybody is talking about you these days <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="575568475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575568475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Claude Précourt <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575568475">(Feb 24 2026 at 15:10)</a>:</h4>
<p>I know! It was funny at first. Especially since I've always been the go to guy for all sorts of weird requests everywhere I have worked at. But now I must admit that it's just weird and mildly annoying seeing my first name used so often... At least Anthropic seems to have a good reputation and seems more ethical than most!</p>



<a name="575568968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575568968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575568968">(Feb 24 2026 at 15:12)</a>:</h4>
<p><a href="https://en.wikipedia.org/wiki/Anton_aus_Tirol">Anton aus Tirol</a> used to be a hit song when I was a child, but yeah this is something else :p</p>



<a name="575569372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575569372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Steve Howell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575569372">(Feb 24 2026 at 15:14)</a>:</h4>
<div class="message_inline_image"><a href="/user_uploads/22008/01EZaOqAKS_4MSDk6nX3U0wc/image.png"><img data-original-content-type="image/png" data-original-dimensions="238x212" src="/user_uploads/thumbnail/22008/01EZaOqAKS_4MSDk6nX3U0wc/image.png/840x560.webp"></a></div>



<a name="575571531"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575571531" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575571531">(Feb 24 2026 at 15:22)</a>:</h4>
<p>It would be nice if you were able to use it to get a pay raise if some out of touch higher up manager has been hearing office chatter about how Claude is making them so much more productive <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="575572443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575572443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Claude Précourt <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575572443">(Feb 24 2026 at 15:25)</a>:</h4>
<p>Great idea! I'll ask Claude to compose an email for me...!</p>
<p>I just listened to "Anton aus Tirol" and... it helped me make peace with having an AI homonym. <span aria-label="wink" class="emoji emoji-1f609" role="img" title="wink">:wink:</span></p>



<a name="575591394"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575591394" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575591394">(Feb 24 2026 at 16:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/channel/231634-beginners/topic/Crash.20in.20recursive.20code/near/575525371">said</a>:</p>
<blockquote>
<p>Claude thinks the bug is in Roc itself, not basic-cli, so I will look into a fix there too.</p>
</blockquote>
<p>Fixed in <a href="https://github.com/roc-lang/roc/issues/9200">#9200</a></p>



<a name="575642555"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Crash%20in%20recursive%20code/near/575642555" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Crash.20in.20recursive.20code.html#575642555">(Feb 24 2026 at 21:13)</a>:</h4>
<p>Yeah I was going to guess it's most likely in the interpreter <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
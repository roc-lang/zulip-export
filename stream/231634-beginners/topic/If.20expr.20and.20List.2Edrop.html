<html>
<head><meta charset="utf-8"><title>If expr and List.drop · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html">If expr and List.drop</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="346738259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346738259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Audrey Gao <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346738259">(Apr 04 2023 at 05:57)</a>:</h4>
<p>I wondered what was the reason that the first expression worked while the second one received an error . <a href="/user_uploads/22008/hs0jdqpw_f4FxxDKTvehTTil/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/hs0jdqpw_f4FxxDKTvehTTil/image.png" title="image.png"><img src="/user_uploads/22008/hs0jdqpw_f4FxxDKTvehTTil/image.png"></a></div>



<a name="346741570"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346741570" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346741570">(Apr 04 2023 at 06:21)</a>:</h4>
<p>I think it is a bug in the wasm dev backend.</p>



<a name="346742124"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346742124" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346742124">(Apr 04 2023 at 06:24)</a>:</h4>
<p>Interesting that changing from <code>List.dropAt x 0</code> to <code>List.dropFirst x</code> fixes it.</p>
<p>EDIT: This is actually extra confusing cause <code>List.dropFirst</code> is defined as:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">dropFirst</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">list</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nx">List</span><span class="p">.</span><span class="nx">dropAt</span><span class="w"> </span><span class="nx">list</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>



<a name="346742323"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346742323" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346742323">(Apr 04 2023 at 06:26)</a>:</h4>
<p>Also, I get a slightly different error, which might be useful as context for someone: <code>JsValue(CompileError: wasm validation error: at offset 18988: popping value from empty stack)</code></p>



<a name="346818261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346818261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346818261">(Apr 04 2023 at 11:32)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> this works for me in <code>roc repl</code> on the command line</p>



<a name="346818451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346818451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346818451">(Apr 04 2023 at 11:33)</a>:</h4>
<p>so yeah, probably a bug in the wasm dev backend</p>



<a name="346818491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346818491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346818491">(Apr 04 2023 at 11:33)</a>:</h4>
<p>but I agree that I'm not sure what it would be, given how <code>dropFirst</code> is defined <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="346879639"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/346879639" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#346879639">(Apr 04 2023 at 14:51)</a>:</h4>
<p>My gut feeling is it is somehow refcount/memory related. Maybe even a bug related to freeing a seamless slice, but that is definitely guessing.</p>



<a name="347021957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/347021957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Audrey Gao <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#347021957">(Apr 05 2023 at 05:02)</a>:</h4>
<p>Thanks for the information!</p>



<a name="347244600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/347244600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#347244600">(Apr 05 2023 at 20:05)</a>:</h4>
<p>OK this is weird. The following tests passes for the Wasm backend if I insert it into <a href="http://gen_list.rs">gen_list.rs</a><br>
And remember that tests are wrapped in a <code>main</code> function in the same way as REPL inputs are.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[test]</span>
<span class="k">fn</span> <span class="nf">zulip_issue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">assert_evals_to</span><span class="o">!</span><span class="p">(</span>
<span class="w">        </span><span class="s">r#"</span>
<span class="s">        x = [1,2,3]</span>
<span class="s">        tl = List.dropAt x 0</span>
<span class="s">        if Bool.true then [] else tl</span>
<span class="s">        "#</span><span class="p">,</span>
<span class="w">        </span><span class="n">RocList</span>::<span class="n">empty</span><span class="p">(),</span>
<span class="w">        </span><span class="n">RocList</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>



<a name="347244909"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/347244909" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#347244909">(Apr 05 2023 at 20:07)</a>:</h4>
<p>Also if I print out the IR after refcount insertion, this is what I get</p>
<div class="codehilite"><pre><span></span><code>procedure : `#UserApp.main` List I64
procedure = `#UserApp.main` ():
    let `#UserApp.x` : List I64 = Array [1i64, 2i64, 3i64];
    let `#UserApp.6` : U32 = 0i64;
    let `#UserApp.tl` : List I64 = CallByName `List.dropAt` `#UserApp.x` `#UserApp.6`;
    let `#UserApp.4` : Int1 = CallByName `Bool.true`;
    if `#UserApp.4` then
        dec `#UserApp.tl`;
        let `#UserApp.5` : List I64 = Array [];
        ret `#UserApp.5`;
    else
        ret `#UserApp.tl`;

procedure : `List.dropAt` List I64
procedure = `List.dropAt` (`#Attr.#arg1`: List I64, `#Attr.#arg2`: U32):
    let `List.494` : List I64 = lowlevel ListDropAt `#Attr.#arg1` `#Attr.#arg2`;
    ret `List.494`;

procedure : `Bool.true` Int1
procedure = `Bool.true` ():
    let `Bool.23` : Int1 = true;
    ret `Bool.23`;
</code></pre></div>



<a name="347245056"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/347245056" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#347245056">(Apr 05 2023 at 20:08)</a>:</h4>
<p>There's just one decrement in the <code>then</code> branch</p>



<a name="347245352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/347245352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#347245352">(Apr 05 2023 at 20:10)</a>:</h4>
<p>Flipping the <code>if</code> branches around moves the decrement to the branch that's not taken</p>



<a name="347247177"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/347247177" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#347247177">(Apr 05 2023 at 20:24)</a>:</h4>
<p>OK I managed to extract a .wasm file from the browser.<br>
The wasm instruction stream is invalid at the point where it calls the refcount decrement.</p>



<a name="347252543"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/If%20expr%20and%20List.drop/near/347252543" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/If.20expr.20and.20List.2Edrop.html#347252543">(Apr 05 2023 at 20:58)</a>:</h4>
<p>OK I figured out what's wrong. The backend tries to keep track of what's on the Wasm stack machine at each point in the program. In this example, our model of the stack machine goes wrong and we end up generating invalid Wasm instructions! This is the hardest part of the wasm backend. <span aria-label="sweating" class="emoji emoji-1f975" role="img" title="sweating">:sweating:</span></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
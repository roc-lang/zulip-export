<html>
<head><meta charset="utf-8"><title>✔ Help with my program · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html">✔ Help with my program</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="449487906"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449487906" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449487906">(Jul 06 2024 at 12:43)</a>:</h4>
<p>Hi, sorry to write such a message, but it feels like I'm stuck. I was attempting to write a simple compiler and roc seemed like it would be fun to try in. At some point i started running into compiler bugs, that after many attempts don't seem to  be circumventable. Here's my repo if anyone wishes to reproduce this <a href="https://ass.si/git/Adrian/CompilerV3/src/commit/6cd097a3d58c94197b2a76e1d291545655e69043/main.roc">https://ass.si/git/Adrian/CompilerV3/src/commit/6cd097a3d58c94197b2a76e1d291545655e69043/main.roc</a> .</p>



<a name="449487968"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449487968" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449487968">(Jul 06 2024 at 12:43)</a>:</h4>
<p>Upon running <code>roc build</code> the output is </p>
<div class="codehilite"><pre><span></span><code>thread &#39;&lt;unknown&gt;&#39; has overflowed its stack
fatal runtime error: stack overflow
Aborted (core dumped)
</code></pre></div>



<a name="449488212"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449488212" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449488212">(Jul 06 2024 at 12:44)</a>:</h4>
<p>Thanks to everyone who'd have looked into this in advance :)</p>



<a name="449490150"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449490150" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449490150">(Jul 06 2024 at 12:53)</a>:</h4>
<p>No need to apologize when asking for help @Adrian :)</p>
<p>Is there a specific piece of code that was added and produced the issue?</p>



<a name="449500483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449500483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449500483">(Jul 06 2024 at 14:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/stream/231634-beginners/topic/Help.20with.20my.20program/near/449490150">said</a>:</p>
<blockquote>
<p>No need to apologize when asking for help @Adrian :)</p>
<p>Is there a specific piece of code that was added and produced the issue?</p>
</blockquote>
<p>Not really, I had been preforming a ton of removals and additons and at some point i couldn't get the errors to go away</p>



<a name="449500967"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449500967" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449500967">(Jul 06 2024 at 14:12)</a>:</h4>
<p>Does <code>roc check</code> result in the same issue?</p>



<a name="449501106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449501106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449501106">(Jul 06 2024 at 14:13)</a>:</h4>
<p>The apology is for writing such a demoralizing error report. This isn't really something I'd want to receive and something I'd even less want to debug. Tho this might be on me for not being familiar with the compiler and not compiling the roc myself but getting it from AUR.</p>



<a name="449501128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449501128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449501128">(Jul 06 2024 at 14:13)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/stream/231634-beginners/topic/Help.20with.20my.20program/near/449500967">said</a>:</p>
<blockquote>
<p>Does <code>roc check</code> result in the same issue?</p>
</blockquote>
<p>Nope, it works</p>



<a name="449501291"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449501291" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449501291">(Jul 06 2024 at 14:14)</a>:</h4>
<div class="spoiler-block"><div class="spoiler-header">
</div><div class="spoiler-content" aria-hidden="true">
<p>adrian: ~/compilerV3$ roc check</p>
<p>── UNUSED DEFINITION in main.roc ───────────────────────────────────────────────</p>
<p>parsed is not used anywhere in your code.</p>
<p>40│      parsed = parseUtf8 parser inp<br>
         ^^^^^^</p>
<p>If you didn't intend on using parsed then remove it so future readers<br>
of your code don't wonder why it is there.</p>
<p>── UNUSED DEFINITION in main.roc ───────────────────────────────────────────────</p>
<p>pathOut is not used anywhere in your code.</p>
<p>38│      pathOut = Path.withExtension pathIn "ebs"<br>
         ^^^^^^^</p>
<p>If you didn't intend on using pathOut then remove it so future readers<br>
of your code don't wonder why it is there.</p>
<p>── UNUSED ARGUMENT in main.roc ─────────────────────────────────────────────────</p>
<p>This function doesn't use x.</p>
<p>282│      const \x -&gt; @CexprT {}<br>
                 ^</p>
<p>If you don't need x, then you can just remove it. However, if you<br>
really do need x as an argument of this function, prefix it with an<br>
underscore, like this: "_x". Adding an underscore at the start of a<br>
variable name is a way of saying that the variable is not used.</p>
<p>── UNUSED DEFINITION in main.roc ───────────────────────────────────────────────</p>
<p>ifP is not used anywhere in your code.</p>
<p>239│  ifP =<br>
      ^^^</p>
<p>If you didn't intend on using ifP then remove it so future readers of<br>
your code don't wonder why it is there.</p>
<p>── UNUSED DEFINITION in main.roc ───────────────────────────────────────────────</p>
<p>scopeP is not used anywhere in your code.</p>
<p>253│  scopeP =<br>
      ^^^^^^</p>
<p>If you didn't intend on using scopeP then remove it so future readers<br>
of your code don't wonder why it is there.</p>
<p>── UNUSED IMPORT in main.roc ───────────────────────────────────────────────────</p>
<p>Core.lazy is not used in this module.</p>
<p>25│      lazy,<br>
         ^^^^</p>
<p>Since Core.lazy isn't used, you don't need to import it.</p>
<p>────────────────────────────────────────────────────────────────────────────────</p>
<p>0 errors and 6 warnings found in 82 ms</p>
</div></div>



<a name="449522041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449522041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449522041">(Jul 06 2024 at 16:28)</a>:</h4>
<p>When minimizing the code, I found that changing  <code>oneOf [fnP]</code>to <code>fnP</code> results in a drop of build time from 11918 ms to 232 ms, there is also a ~7 GiB difference in RAM consumption between the two. Do you happen to have seen behavior like this before <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span>?</p>



<a name="449522659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449522659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449522659">(Jul 06 2024 at 16:31)</a>:</h4>
<p>oh wow, definitely need to get a flamegraph of that diff</p>



<a name="449522714"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449522714" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449522714">(Jul 06 2024 at 16:31)</a>:</h4>
<p>Yeah, good idea</p>



<a name="449542851"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449542851" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449542851">(Jul 06 2024 at 18:36)</a>:</h4>
<p>Basically all time is spent in recursive calls of <code>reify_layout_slice</code> and <code>reify_recursive_layout</code><br>
<a href="/user_uploads/22008/LomOQ0wXvfYQPkzL3TLLfzyF/Screenshot_20240706_203114.png">Screenshot_20240706_203114.png</a>.</p>
<div class="message_inline_image"><a href="/user_uploads/22008/LomOQ0wXvfYQPkzL3TLLfzyF/Screenshot_20240706_203114.png" title="Screenshot_20240706_203114.png"><img src="/user_uploads/22008/LomOQ0wXvfYQPkzL3TLLfzyF/Screenshot_20240706_203114.png"></a></div>



<a name="449552250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449552250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449552250">(Jul 06 2024 at 19:59)</a>:</h4>
<p><a href="/user_uploads/22008/KNwvBEbrO9u_14NzRMDAz65k/image.png">image.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/KNwvBEbrO9u_14NzRMDAz65k/image.png" title="image.png"><img src="/user_uploads/22008/KNwvBEbrO9u_14NzRMDAz65k/image.png"></a></div>



<a name="449552321"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449552321" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adrian <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449552321">(Jul 06 2024 at 19:59)</a>:</h4>
<p>I can also reproduce the overflow without <code>fnP</code> (Just for reference). I would guess that the same problem is at play</p>



<a name="449552750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449552750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449552750">(Jul 06 2024 at 20:01)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> that function would be trying to unify lambdaset layouts? Right?</p>



<a name="449573461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449573461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449573461">(Jul 06 2024 at 23:14)</a>:</h4>
<p>it builds the runtime representation of the lambda set, so no unification</p>



<a name="449579028"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449579028" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449579028">(Jul 07 2024 at 00:06)</a>:</h4>
<p>Ah ok</p>



<a name="449887806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449887806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449887806">(Jul 08 2024 at 14:39)</a>:</h4>
<blockquote>
<p>I can also reproduce the overflow without <code>fnP</code> (Just for reference). I would guess that the same problem is at play</p>
</blockquote>
<p>Thanks <span class="user-mention" data-user-id="695871">@Adrian</span>, that allowed me to do a lot of minimization:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">app</span><span class="w"> </span><span class="p">[</span><span class="n">main</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">pf</span><span class="kt">:</span><span class="w"> </span><span class="n">platform</span><span class="w"> </span><span class="s">"https://github.com/roc-lang/basic-cli/releases/download/0.10.0/vNe6s9hWzoTZtFmNkvEICPErI9ptji_ySjicO6CkucY.tar.br"</span><span class="p">,</span>
<span class="w">    </span><span class="n">parser</span><span class="kt">:</span><span class="w"> </span><span class="s">"https://github.com/lukewilliamboswell/roc-parser/releases/download/0.7.1/MvLlME9RxOBjl0QCxyn3LIaoG9pSlaNxCa-t3BfbPNc.tar.br"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kr">import</span><span class="w"> </span><span class="nn">pf.Task</span>

<span class="kr">import</span><span class="w"> </span><span class="nn">parser.Core</span><span class="w"> </span><span class="n">exposing</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="kt">Parser</span><span class="p">,</span>
<span class="w">    </span><span class="n">const</span><span class="p">,</span>
<span class="w">    </span><span class="n">keep</span><span class="p">,</span>
<span class="w">    </span><span class="n">oneOf</span><span class="p">,</span>
<span class="w">    </span><span class="n">skip</span><span class="p">,</span>
<span class="p">]</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">parser.String</span><span class="w"> </span><span class="n">exposing</span><span class="w"> </span><span class="p">[</span><span class="kt">Utf8</span><span class="p">,</span><span class="w"> </span><span class="n">parseUtf8</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">]</span>

<span class="nf">main</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="n">input</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">U8</span>
<span class="w">    </span><span class="n">input</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">[]</span>

<span class="w">    </span><span class="n">parsed</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">parseUtf8</span><span class="w"> </span><span class="n">parser</span><span class="w"> </span><span class="n">input</span>

<span class="w">    </span><span class="kt">Task</span><span class="o">.</span><span class="n">ok</span><span class="w"> </span><span class="p">{}</span>

<span class="nf">parser</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="n">oneOf</span><span class="w"> </span><span class="p">[</span><span class="n">includeP</span><span class="p">,</span><span class="w"> </span><span class="n">whiteP</span><span class="p">]</span>

<span class="nf">includeP</span><span class="w"> </span><span class="ow">=</span>
<span class="w">    </span><span class="n">const</span><span class="w"> </span><span class="nf">\</span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Include</span><span class="w"> </span><span class="n">x</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="s">"blabla"</span><span class="p">)</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="n">whiteP</span><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">comment</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">prevent</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">overflow</span>

<span class="nf">whitesp</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="n">x</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s"> </span><span class="se">\r\t</span><span class="s">"</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="o">.</span><span class="n">toUtf8</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="o">.</span><span class="n">contains</span><span class="w"> </span><span class="n">x</span>
<span class="nf">whiteP</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Parser</span><span class="w"> </span><span class="kt">Utf8</span><span class="w"> </span><span class="p">[</span><span class="kt">Wsp</span><span class="p">]</span><span class="kr">_</span>
<span class="nf">whiteP</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="kt">Wsp</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">skip</span><span class="w"> </span><span class="p">(</span><span class="kt">Core</span><span class="o">.</span><span class="n">chompWhile</span><span class="w"> </span><span class="n">whitesp</span><span class="p">)</span>
</code></pre></div>



<a name="449888880"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449888880" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449888880">(Jul 08 2024 at 14:42)</a>:</h4>
<p>When I look at the call stack with gdb I see this endlessly repeated:</p>
<div class="codehilite"><pre><span></span><code>roc_mono::layout::layout_from_flat_type
roc_mono::layout::Layout::from_var
roc_mono::layout::Layout::from_var
roc_mono::layout::LambdaSet::from_var
roc_mono::layout::layout_from_flat_type
roc_mono::layout::Layout::from_var
roc_mono::layout::Layout::from_var
roc_mono::layout::LambdaSet::from_var
roc_mono::layout::layout_from_flat_type
</code></pre></div>



<a name="449890328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449890328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449890328">(Jul 08 2024 at 14:46)</a>:</h4>
<p>Also found related (closed) issues: <a href="https://github.com/roc-lang/roc/issues/3444">#3444</a> and <a href="https://github.com/roc-lang/roc/issues/3449">#3449</a></p>



<a name="449916084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449916084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449916084">(Jul 08 2024 at 16:08)</a>:</h4>
<p>I made <a href="https://github.com/roc-lang/roc/issues/6890">#6890</a> for this issue.</p>



<a name="449916893"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449916893" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449916893">(Jul 08 2024 at 16:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="695871">Adrian</span> has marked this topic as resolved.</p>



<a name="449919158"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/449919158" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#449919158">(Jul 08 2024 at 16:20)</a>:</h4>
<p>I also made <a href="https://github.com/roc-lang/roc/issues/6891">#6891</a> for the other issue I encountered with slow compilation and high RAM usage.</p>



<a name="451250010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451250010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451250010">(Jul 14 2024 at 02:26)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program/near/449522041">said</a>:</p>
<blockquote>
<p>When minimizing the code, I found that changing  <code>oneOf [fnP]</code>to <code>fnP</code> results in a drop of build time from 11918 ms to 232 ms, there is also a ~7 GiB difference in RAM consumption between the two. Do you happen to have seen behavior like this before <span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span>?</p>
</blockquote>
<p>In case it is helpful, on my M1 mac <a href="https://github.com/isaacvando/rtl">RTL</a> takes about 30s to build with --optimize and about 900ms without. I'd be happy to generate a flamegraph but not sure how.</p>



<a name="451250131"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451250131" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451250131">(Jul 14 2024 at 02:28)</a>:</h4>
<p><code>cargo install flamegraph</code><br>
<code>flamegraph --root -- ....</code></p>



<a name="451250133"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451250133" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451250133">(Jul 14 2024 at 02:29)</a>:</h4>
<p>On mac</p>



<a name="451250603"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451250603" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451250603">(Jul 14 2024 at 02:37)</a>:</h4>
<p><a href="/user_uploads/22008/rzsF2QbpMm3ky39Tbab-spp6/roc_build_flamegraph.svg">roc_build_flamegraph.svg</a><br>
<a href="/user_uploads/22008/VBS4Dy4vhlrmD7D4atSTBr6c/roc_build_optimize_flamegraph.svg">roc_build_optimize_flamegraph.svg</a></p>



<a name="451251199"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451251199" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451251199">(Jul 14 2024 at 02:48)</a>:</h4>
<p>Do you build roc from source? Can you build it with <code>--profile release-with-debug</code>? That will make the flamegraph a lot more meaningful</p>



<a name="451251600"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451251600" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451251600">(Jul 14 2024 at 02:55)</a>:</h4>
<p>Also, just ran it locally:</p>
<p>73% of time spent in morphic. Most of rest spent in llvm.</p>
<p>Very very deep stack trace:<br>
analyze_func -&gt; analyze_graph -&gt; analyze_block_scc -&gt; analyze_block -&gt; analyze_value -&gt; get_analysis -&gt; analyze_func</p>



<a name="451251664"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451251664" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451251664">(Jul 14 2024 at 02:56)</a>:</h4>
<p>cc <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> just in case he has any thoughts. I have never really dug into morphic.</p>
<p>Would be good to file a bug.</p>



<a name="451251805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451251805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451251805">(Jul 14 2024 at 02:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program/near/451251199">said</a>:</p>
<blockquote>
<p>Do you build roc from source? Can you build it with <code>--profile release-with-debug</code>? That will make the flamegraph a lot more meaningful</p>
</blockquote>
<p>Good to know, I can build it from source if the need arises again</p>



<a name="451252558"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451252558" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451252558">(Jul 14 2024 at 03:10)</a>:</h4>
<p>Though masked in practically infinite recursion (which might be the bug, not sure), it looks like the execution time actually breaks down to a lot of time spent in primitives (all the hash set operations).</p>



<a name="451252682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451252682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451252682">(Jul 14 2024 at 03:12)</a>:</h4>
<p>about 7/8ths of the time spent in morphic is spent in hashbrown. About half the time spent in morphic is specifically spent in <code>HashSet::insert</code></p>



<a name="451252728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451252728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451252728">(Jul 14 2024 at 03:13)</a>:</h4>
<p>Not sure if any of this is actionable or just a fact of how morphic works though. Just giving the breakdown I see.</p>



<a name="451252904"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451252904" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451252904">(Jul 14 2024 at 03:16)</a>:</h4>
<p><span class="user-mention" data-user-id="611722">@Isaac Van Doren</span> RTL is a super recursive parser, right?</p>



<a name="451252955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451252955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451252955">(Jul 14 2024 at 03:17)</a>:</h4>
<p>Yes it is very recursive</p>



<a name="451254023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451254023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451254023">(Jul 14 2024 at 03:36)</a>:</h4>
<p>As for morphic functions that are calling into hashbrown that are eating up all the time:</p>
<ol>
<li><code>ForwardState::merge_slots</code> -&gt; <code>ForwardState::copy_data</code> -&gt; <code>ForwardState::copy_aliases</code> -&gt; <code>ForwardState::add_alias</code> -&gt; <code>HashSet::insert</code></li>
<li><code>ForwardState::scc_summarize</code> -&gt; <code>Iterator::collect</code></li>
<li><code>ForwardState::merge_slots</code> -&gt; <code>HashSet::insert</code>/<code>HashSet::remove</code> directly</li>
</ol>



<a name="451255945"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451255945" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451255945">(Jul 14 2024 at 04:07)</a>:</h4>
<p>Not that I have any concrete idea for size, but I think that a solid bit of time could be recovered if we start optimizing the starting size of hashsets and hashmaps. Resizing them is extra expensive cause everything has to be rehashed (if they are small enough, might be worth trying normal sets/maps without hashing or btrees).</p>
<p>So probably need to profile how large contains get in morphic and get better default sizes.</p>



<a name="451281414"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451281414" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451281414">(Jul 14 2024 at 04:29)</a>:</h4>
<p>Oh also, I wonder if we can parallelize some of this morphic work for perf gains? I think it basically spends the entire time maxing a single core.</p>



<a name="451332060"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Help%20with%20my%20program/near/451332060" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Help.20with.20my.20program.html#451332060">(Jul 14 2024 at 08:01)</a>:</h4>
<p>After tons of stack collapsing, this is where the time is actually spent:</p>
<p><a href="/user_uploads/22008/zq1kZMhbpHhqTd6ugFJoD6js/Screenshot-2024-07-14-at-1.00.19AM.png">Screenshot-2024-07-14-at-1.00.19AM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/zq1kZMhbpHhqTd6ugFJoD6js/Screenshot-2024-07-14-at-1.00.19AM.png" title="Screenshot-2024-07-14-at-1.00.19AM.png"><img src="/user_uploads/22008/zq1kZMhbpHhqTd6ugFJoD6js/Screenshot-2024-07-14-at-1.00.19AM.png"></a></div>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
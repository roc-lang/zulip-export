<html>
<head><meta charset="utf-8"><title>How to WASM Â· beginners Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html">How to WASM</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="351991039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/351991039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#351991039">(Apr 23 2023 at 04:11)</a>:</h4>
<p>I'm trying to get Roc to generate a <code>.wasm</code> file. I've been following the instructions in <code>examples/platform-switching/web-assembly-platform/README.md</code> but I can't seem to get anything to work. I'm not really sure where I'm going wrong. </p>
<p>I would love to be able to generate a valid WASM file, and potentially even something that could be used with WASI. I appreciate that there probably aren't many platforms yet, and we don't have RocGlue for it, but I'm interested in working on this. </p>
<p>I've thought it might be fun to try and make something work for <a href="https://wasmer.io/posts/announcing-wcgi">WCGI</a>. But don't have much experience, and I'm thinking it may be too big a project for me but worth giving it a go.</p>
<div class="codehilite"><pre><span></span><code>$ cargo run -- build --target wasm32 examples/platform-switching/rocLovesWebAssembly.roc
   Compiling palette v0.6.1
   Compiling signal-hook v0.3.15
   Compiling pulldown-cmark v0.9.2
   Compiling roc_cli v0.0.1 (/Users/luke/Documents/GitHub/roc/crates/cli)
   Compiling roc_repl_expect v0.0.1 (/Users/luke/Documents/GitHub/roc/crates/repl_expect)
   Compiling roc_code_markup v0.0.1 (/Users/luke/Documents/GitHub/roc/crates/code_markup)
   Compiling roc_docs v0.0.1 (/Users/luke/Documents/GitHub/roc/crates/docs)
    Finished dev [unoptimized + debuginfo] target(s) in 8.27s
     Running `target/debug/roc build --target wasm32 examples/platform-switching/rocLovesWebAssembly.roc`
ðŸ”¨ Rebuilding platform...
An internal compiler expectation was broken.
This is definitely a compiler bug.
Please file an issue here: https://github.com/roc-lang/roc/issues/new/choose
thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;Error:
    Failed to rebuild host.zig:
        The executed command was:
            zig build-obj examples/platform-switching/web-assembly-platform/host.zig -femit-llvm-ir=examples/platform-switching/web-assembly-platform/main.bc --pkg-begin str crates/compiler/builtins/bitcode/src/str.zig --pkg-end --library c -target i386-linux-musl -fPIC --strip
        stderr of that command:
            ./examples/platform-switching/web-assembly-platform/host.zig:7:9: error: This platform is for WebAssembly only. You need to pass `--target wasm32` to the Roc compiler.
        @compileError(&quot;This platform is for WebAssembly only. You need to pass `--target wasm32` to the Roc compiler.&quot;);
        ^
&#39;, crates/compiler/build/src/link.rs:1493:21
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
thread &#39;main&#39; panicked at &#39;Failed to (re)build platform.: Any { .. }&#39;, crates/compiler/build/src/program.rs:941:46
</code></pre></div>



<a name="351993251"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/351993251" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#351993251">(Apr 23 2023 at 04:41)</a>:</h4>
<p><del>I think I might be using the wrong version of zig. Just going to build 0.9.1 from source and see if that helps.</del> didn't help</p>



<a name="352005797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352005797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352005797">(Apr 23 2023 at 06:56)</a>:</h4>
<p>It seems to think the target is <code>i386-linux-musl</code>. Using <code>--target wasm32</code> doesn't seem to do anything. Indeed when I hardcode it to <code>Target::Wasm32</code> in <code>crates/cli/src/main.rs</code> this doesn't change the arguments to zig build.</p>
<p>So I searched for where that might be and have found this in <code>crates/compiler/build/src/link.rs</code> which I can hardcode to <code>wasm32-wasi</code> but then I get a successful build with a series of errors like below when it tries to link with <code>ld-temp.o</code>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">zig_target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="fm">matches!</span><span class="p">(</span><span class="n">opt_level</span><span class="p">,</span><span class="w"> </span><span class="n">OptLevel</span>::<span class="n">Development</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">"wasm32-wasi"</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// For LLVM backend wasm we are emitting a .bc file anyway so this target is OK</span>
<span class="w">    </span><span class="s">"i386-linux-musl"</span>
<span class="w">    </span><span class="c1">// ^^^^^^^^^^^^^ If I change this to "wasm32-wasi" I get a sucessful build the below errors.</span>
<span class="p">};</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>wasm-ld: warning: Linking two modules of different target triples: &#39;/Users/luke/
Documents/GitHub/roc/target/debug/build/wasi_libc_sys-5e2583e767e30111/out/wasi-
libc.a/Users/luke/Documents/GitHub/roc/target/debug/build/wasi_libc_sys-5e2583e7
67e30111/out/zig-cache/o/4811dec3fd38e36f9330ff74e399d7a1/memset.o&#39; is
&#39;wasm32-unknown-wasi-musl&#39; whereas &#39;ld-temp.o&#39; is &#39;wasm32-unknown-unknown-unknown&#39;
</code></pre></div>



<a name="352012726"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352012726" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352012726">(Apr 23 2023 at 07:57)</a>:</h4>
<p>Ok, so I've realised that I have this working now. They are just compiler warnings that I have above. Only realised after manually compiling the host using zig. I had to fix a minor bug in <code>host.zig</code> to get it to compile. Modified some things... and now I have a roc platform that runs with wasmer. </p>
<div class="codehilite"><pre><span></span><code>% wasmer run examples/platform-switching/rocLovesWebAssembly.wasm
Hello, from Zig!
</code></pre></div>



<a name="352014366"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352014366" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352014366">(Apr 23 2023 at 08:11)</a>:</h4>
<p>Is it possible to target <code>wasm</code> using a Rust platform at the moment?</p>



<a name="352016536"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352016536" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352016536">(Apr 23 2023 at 08:26)</a>:</h4>
<p>I'm not sure of the current status. I do remember at some point in the past the compiler's build system only supported Zig platforms. That goes back to our first Wasm examples with llvm. I'm not sure if that restriction has been lifted since then. I did a lot of the Wasm support but not this part. <span class="user-mention" data-user-id="281543">@Folkert de Vries</span>  might know more about it.</p>



<a name="352017435"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352017435" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352017435">(Apr 23 2023 at 08:32)</a>:</h4>
<p>We'd need a specific Rust platform to work on. I don't think one exists right now.</p>



<a name="352018330"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352018330" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352018330">(Apr 23 2023 at 08:39)</a>:</h4>
<p>Also note that Roc glue exists at the language level (Rust/Zig), not the instruction set level (x86_64/Wasm).</p>



<a name="352018363"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352018363" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352018363">(Apr 23 2023 at 08:39)</a>:</h4>
<p>Rust glue does support the Wasm target as far as I know</p>



<a name="352027155"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352027155" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352027155">(Apr 23 2023 at 09:38)</a>:</h4>
<p>Super. Looking forward to building a rust platform for wasm with glue. I might need a minimal example and then I should be good to add more features. I think Brendan is working on an example using glue, not sure if he's thinking wasm though.</p>



<a name="352054743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352054743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352054743">(Apr 23 2023 at 12:23)</a>:</h4>
<p>we do try to generate glue for wasm, see </p>
<div class="codehilite"><pre><span></span><code>#[cfg(target_arch = &quot;arm&quot;)]
mod arm;
#[cfg(target_arch = &quot;arm&quot;)]
pub use arm::*;
#[cfg(target_arch = &quot;aarch64&quot;)]
mod aarch64;
#[cfg(target_arch = &quot;aarch64&quot;)]
pub use aarch64::*;
#[cfg(target_arch = &quot;wasm32&quot;)]
mod wasm32;
#[cfg(target_arch = &quot;wasm32&quot;)]
pub use wasm32::*;
#[cfg(target_arch = &quot;x86&quot;)]
mod x86;
#[cfg(target_arch = &quot;x86&quot;)]
pub use x86::*;
#[cfg(target_arch = &quot;x86_64&quot;)]
mod x86_64;
#[cfg(target_arch = &quot;x86_64&quot;)]
pub use x86_64::*;
</code></pre></div>
<p>but I don't think that's been tested in any way so far</p>



<a name="352422658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352422658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352422658">(Apr 25 2023 at 04:11)</a>:</h4>
<p><strong>Status: Blocked - I think I need assistance, still trying to figure it out.</strong></p>
<h2>Goal - Compile Minimal Rust platform to WASM</h2>
<p>Get a minimal example that compiles a Roc platform/app to a WASM file for e.g. a Netlify serverless function. Basically I just want to use STDIO and STDOUT for request/response, and make an Echo example.</p>
<p>Basic concept is something like <code>mainForHost : List U8 -&gt; Str</code> or similar, with a platform <code>lib.rs</code> maybe something like this. </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">Read</span><span class="p">};</span>

<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">  </span><span class="n">io</span>::<span class="n">stdin</span><span class="p">().</span><span class="n">read_to_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">roc_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocStr</span>::<span class="n">from_slice_unchecked</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
<span class="w">  </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">roc_main</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">roc_str</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="n">io</span>::<span class="n">stdout</span><span class="p">().</span><span class="n">write_all</span><span class="p">(</span><span class="n">roc_str</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">  </span><span class="n">io</span>::<span class="n">stdout</span><span class="p">().</span><span class="n">flush</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h2>Step 1 - Compile library (SUCCESS)</h2>
<p>Using <code>examples/platform-switching/rust-platform</code> as a starting point I get.</p>
<div class="codehilite"><pre><span></span><code>% roc build --target wasm32 --no-link rocLovesRust.roc
0 errors and 0 warnings found in 36 ms while successfully building:

    rocLovesRust.o
</code></pre></div>
<h2>Step 2 - Link WASM file (SUCCESS)</h2>
<div class="codehilite"><pre><span></span><code>% wasm-ld --no-entry --export-dynamic --allow-undefined -o rocLovesRust.wasm rocLovesRust.o
</code></pre></div>
<h2>Step 3 - Run WASM file (FAIL) :sadface:</h2>
<div class="codehilite"><pre><span></span><code>% wasmer rocLovesRust.wasm
error: failed to run `rocLovesRust.wasm`
â•°â”€â–¶ 1: Error while importing &quot;env&quot;.&quot;__udivti3&quot;: unknown import. Expected Function(FunctionType { params: [I32, I64, I64, I64, I64], results: [] })
</code></pre></div>
<p>When I ask ChatGPT how to fix it I get this.</p>
<blockquote>
<p>The error you're encountering indicates that the WebAssembly module you generated is trying to import a function named __udivti3 from the "env" namespace, but it can't find it. The __udivti3 function is a compiler-generated helper function for 128-bit unsigned integer division. It is part of the compiler-rt library, which provides runtime support for various compiler-generated functions. To resolve this issue, you need to link your Rust code with the appropriate wasm32 version of the compiler-rt library. </p>
</blockquote>
<p>And this is where I get stuck. </p>
<p>Any ideas on how to get rust to link compiler-rt library in would be most appreciated.</p>



<a name="352432310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352432310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352432310">(Apr 25 2023 at 05:35)</a>:</h4>
<p>I tried another method and created a rust project for the sole purpose of compiling the missing functions into <code>.o</code> files against the <code>wasm32-unknown-unknown</code> target, and then tried linking them using <code>wasm-ld</code>, but it still doesn't seem to work. I really don't have much experience here, so this is probably a crazy idea. Sharing in case this helps.</p>
<div class="codehilite"><pre><span></span><code>% wasm-ld --no-entry --export-dynamic -o rocLovesRust.wasm rocLovesRust.o ./udivmodti4.o ./udivti3.o ./libcompiler-rt.a
wasm-ld: error: lto.tmp: undefined symbol: __udivti3
wasm-ld: error: lto.tmp: undefined symbol: __udivti3
wasm-ld: error: lto.tmp: undefined symbol: __multi3
</code></pre></div>



<a name="352472933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352472933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352472933">(Apr 25 2023 at 09:03)</a>:</h4>
<p>I've pivoted to just use the Zig platform. It works really well. I hope to polish it a little and hopefully have a working example for the next meetup. Just a few (maybe just one) compiler issues to fix so this can be used by anyone using a nightly release and a URL platform. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="352506096"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352506096" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352506096">(Apr 25 2023 at 11:17)</a>:</h4>
<p>The following builds WASM ok with <code>roc build --target wasm32 examples/echo.roc</code>, and also runs well using <code>% wasmer run examples/echo.wasm</code>, except it prints out <code>hello, world!%</code> instead of what I expect it to which is <code>Goodbye!%</code>. I'm pretty confident it is a combination of my lack of Zig, and not quite understanding how we call the exposed Roc functions.</p>
<p>Looking for any pointers to get Roc to take the list of bytes in and return the modified list back.</p>
<div class="codehilite"><pre><span></span><code>platform &quot;serverless&quot;
    requires {} { main : List U8 -&gt; List U8 }
    exposes []
    packages {}
    imports []
    provides [mainForHost]

mainForHost : List U8 -&gt; List U8
mainForHost = main
</code></pre></div>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="c1">// &lt;-- other Roc related definitions above here removed for brevity --&gt;</span>

<span class="kr">pub</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="n">ret</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">RocList</span><span class="p">)</span><span class="w"> </span><span class="kt">void</span><span class="p">;</span>

<span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="o">!</span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">getStdOut</span><span class="p">().</span><span class="n">writer</span><span class="p">();</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">helloStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"hello, world!"</span><span class="p">;</span>
<span class="w">    </span><span class="kr">var</span><span class="w"> </span><span class="n">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RocList</span><span class="p">.</span><span class="n">fromSlice</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">helloStr</span><span class="p">[</span><span class="mi">0</span><span class="p">..]);</span>

<span class="w">    </span><span class="n">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">);</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">maybeBytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str</span><span class="p">.</span><span class="n">elements</span><span class="p">(</span><span class="kt">u8</span><span class="p">);</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maybeBytes</span><span class="w"> </span><span class="k">orelse</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">debug</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Error getting elements</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="p">.{});</span>
<span class="w">        </span><span class="n">std</span><span class="p">.</span><span class="n">process</span><span class="p">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">array_len</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">byteSlice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">array_len</span><span class="p">];</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="n">stdout</span><span class="p">.</span><span class="n">writeAll</span><span class="p">(</span><span class="n">byteSlice</span><span class="p">);</span><span class="w"> </span><span class="c1">// Write the slice to stdout</span>

<span class="p">}</span>
</code></pre></div>
<div class="codehilite"><pre><span></span><code>app &quot;echo&quot;
    packages { pf: &quot;../platform/main.roc&quot; }
    imports []
    provides [main] to pf

main = \_ -&gt;
    Str.toUtf8 &quot;Goodbye!\n&quot;
</code></pre></div>



<a name="352506378"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352506378" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352506378">(Apr 25 2023 at 11:18)</a>:</h4>
<p>the signature of <code>pub extern fn roc__mainForHost_1_exposed_generic(ret: *RocList) void;</code> needs two arguments</p>



<a name="352506438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352506438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352506438">(Apr 25 2023 at 11:18)</a>:</h4>
<p>first the input string, and then a pointer to store the output into</p>



<a name="352508339"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352508339" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352508339">(Apr 25 2023 at 11:27)</a>:</h4>
<p>Thank you.  I thought that might be the case, but then I get the following error which I have trouble understanding or debugging. There is only one place were I define <code>roc__mainForHost_1_exposed_generic</code> so I don't think that is causing it. </p>
<div class="codehilite"><pre><span></span><code>wasm-ld: warning: function signature mismatch: roc__mainForHost_1_exposed_generic
&gt;&gt;&gt; defined as (i32, i32) -&gt; void in /var/folders/48/39th9k0n0wdcj18k3yhm_g5c0000gn/T/roc_appNrHux0.o
&gt;&gt;&gt; defined as (i32) -&gt; void in lto.tmp

0 errors and 0 warnings found in 427 ms while successfully building:

    examples/echo.wasm
luke@192-168-1-104 roc-serverless % wasmer run examples/echo.wasm
error: failed to run `examples/echo.wasm`
â”‚   1: RuntimeError: unreachable
â•°â”€â–¶ 2: unreachable
</code></pre></div>
<div class="codehilite"><pre><span></span><code>pub extern fn roc__mainForHost_1_exposed_generic(arg: *RocList, ret: *RocList) void;

pub fn main() !void {

    const stdout = std.io.getStdOut().writer();

    const helloStr = &quot;hello, world!&quot;;
    var arg = RocList.fromSlice(u8, helloStr[0..]);
    var ret = RocList.empty();

    roc__mainForHost_1_exposed_generic(&amp;arg, &amp;ret);

    const maybeBytes = ret.elements(u8);
    const bytes = maybeBytes orelse {
        std.debug.print(&quot;Error getting elements\n&quot;, .{});
        std.process.exit(1);
    };

    const array_len: usize = ret.len();
    const byteSlice = bytes[0..array_len];

    try stdout.writeAll(byteSlice); // Write the slice to stdout

}
</code></pre></div>



<a name="352508696"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352508696" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352508696">(Apr 25 2023 at 11:29)</a>:</h4>
<p>Specifically, any idea where the <code>defined as (i32) -&gt; void in lto.tmp</code> might be referring to?</p>



<a name="352514758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352514758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352514758">(Apr 25 2023 at 11:56)</a>:</h4>
<p>ah, ok</p>



<a name="352515238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352515238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352515238">(Apr 25 2023 at 11:58)</a>:</h4>
<p>that signature is just wrong then. i'm not sure how the wasm backend generates them</p>



<a name="352515343"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352515343" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352515343">(Apr 25 2023 at 11:58)</a>:</h4>
<p>you might have more luck if you try to build the roc app with <code>--optimize</code>. that ll use the llvm wasm backend</p>



<a name="352515387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352515387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352515387">(Apr 25 2023 at 11:58)</a>:</h4>
<p>just to figure out if that is the issue</p>



<a name="352635285"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352635285" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352635285">(Apr 25 2023 at 20:36)</a>:</h4>
<p>Unfortunately, that didn't change anything. I still get the same error with <code>--optimize</code> <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="352640128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352640128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352640128">(Apr 25 2023 at 21:07)</a>:</h4>
<p>Is your code pushed to a branch or repo somewhere? Would be nice to be able to look at and play with it.</p>



<a name="352645398"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352645398" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352645398">(Apr 25 2023 at 21:51)</a>:</h4>
<p>Ok, I'll do that. Just out for a few minutes.</p>



<a name="352650957"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352650957" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352650957">(Apr 25 2023 at 22:39)</a>:</h4>
<p>Here is the platform <a href="https://github.com/lukewilliamboswell/roc-serverless">roc-serverless</a>, <del>it doesn't build as is due to the zig builtins issue we've been talking about. I have it working with a local modification in my roc cli so that it knows where to find the builtins.</del> I pushed an update with the builtins locally, so it does build and reproduce the WASM error above.</p>



<a name="352651352"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352651352" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352651352">(Apr 25 2023 at 22:42)</a>:</h4>
<p>To me this is using the LLVM backend. That is the default, you don't have to specify <code>--optimize</code>. Rather, you need <code>--dev</code> to get the dev one. And the dev backend does not use <code>wasm-ld</code>, it has its own built-in linker.</p>



<a name="352651438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352651438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352651438">(Apr 25 2023 at 22:43)</a>:</h4>
<p>At a guess, lto.tmp sounds like a temporary file used for link time optimization by wasm-ld. Again, I'm guessing!</p>



<a name="352651496"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352651496" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352651496">(Apr 25 2023 at 22:43)</a>:</h4>
<p>No idea how it would have two different signatures though</p>



<a name="352651975"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352651975" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352651975">(Apr 25 2023 at 22:47)</a>:</h4>
<p>Maybe try it with <code>--dev</code> and see what happens!</p>



<a name="352652548"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352652548" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352652548">(Apr 25 2023 at 22:51)</a>:</h4>
<p>I forgot I had another change I had to make in the compiler to get this to run. Added to README.</p>



<a name="352652732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352652732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352652732">(Apr 25 2023 at 22:53)</a>:</h4>
<p>I tried with <code>--dev</code> but that still gives the the same function type mismatch. Btw this was using <code>% cargo run -- build --target wasm32 --dev ../roc-serverless/examples/echo.roc</code> to build it. It gives </p>
<div class="codehilite"><pre><span></span><code>&lt;-- other warnings removed --&gt;

wasm-ld: warning: Linking two modules of different target triples: &#39;/Users/luke/Documents/GitHub/roc/target/debug/build/wasi_libc_sys-5e2583e767e30111/out/wasi-libc.a/Users/luke/Documents/GitHub/roc/target/debug/build/wasi_libc_sys-5e2583e767e30111/out/zig-cache/o/ea7f435e8379892b4b98d80660f9fbc9/memset.o&#39; is &#39;wasm32-unknown-wasi-musl&#39; whereas &#39;ld-temp.o&#39; is &#39;wasm32-unknown-unknown-unknown&#39;


wasm-ld: warning: function signature mismatch: roc__mainForHost_1_exposed_generic
&gt;&gt;&gt; defined as (i32, i32) -&gt; void in /var/folders/48/39th9k0n0wdcj18k3yhm_g5c0000gn/T/roc_appf32a4I.o
&gt;&gt;&gt; defined as (i32) -&gt; void in lto.tmp
</code></pre></div>



<a name="352653209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352653209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352653209">(Apr 25 2023 at 22:57)</a>:</h4>
<p>Btw the other change is </p>
<blockquote>
<p>First, change <code>"i386-linux-musl"</code> to <code>"wasm32-wasi"</code> on line 373 in <code>crates/compiler/build/src/link.rs</code></p>
</blockquote>
<p>Which leads me to wonder if there is an issue in cli where it doesn't recognise <code>--dev</code> when we have <code>--target wasm32</code></p>



<a name="352655617"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352655617" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352655617">(Apr 25 2023 at 23:18)</a>:</h4>
<p>How can I confirm if it is using the dev backend and not LLVM?</p>



<a name="352663981"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352663981" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352663981">(Apr 26 2023 at 00:39)</a>:</h4>
<p>Based on the <a href="https://github.com/roc-lang/roc/blob/ffe30af2167385ad75cb89c073608166df18b0e7/crates/cli/src/lib.rs#L619-L635">source code here</a>, it looks like wasm does ignore the <code>--dev</code> flag.</p>



<a name="352664087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352664087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352664087">(Apr 26 2023 at 00:40)</a>:</h4>
<p>Though it also looks like it would always use the dev wasm and never llvm</p>



<a name="352664111"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352664111" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352664111">(Apr 26 2023 at 00:40)</a>:</h4>
<p>So definitely a bit confused by that</p>



<a name="352666075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352666075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352666075">(Apr 26 2023 at 00:59)</a>:</h4>
<p>I think I found it, if I change <code>BuildConfig::BuildAndRunIfNoErrors</code> to <code>BuildConfig::BuildOnly</code> in <a href="https://github.com/roc-lang/roc/blob/ffe30af2167385ad75cb89c073608166df18b0e7/crates/cli/src/lib.rs#L603">cli/src/lib.rs</a> then it builds correctly using the dev backend, and not wasm-ld</p>



<a name="352666842"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352666842" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352666842">(Apr 26 2023 at 01:06)</a>:</h4>
<p>Actually, I think that just changes the linking_strategy from <code>LinkingStrategy::Legacy</code> to <code>LinkingStrategy::Additive</code> which builds without errors, but then there is an issue running the wasm, which I think may because it doesn't actually add the app into it or something.</p>



<a name="352666885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352666885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352666885">(Apr 26 2023 at 01:07)</a>:</h4>
<p>Interesting. I think this is the issue. We always call llvm when the backend is set to wasm: <a href="https://github.com/roc-lang/roc/blob/ffe30af2167385ad75cb89c073608166df18b0e7/crates/compiler/build/src/program.rs#L116-L124">https://github.com/roc-lang/roc/blob/ffe30af2167385ad75cb89c073608166df18b0e7/crates/compiler/build/src/program.rs#L116-L124</a></p>



<a name="352667278"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667278" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667278">(Apr 26 2023 at 01:11)</a>:</h4>
<p>Changing it to works;</p>
<div class="codehilite"><pre><span></span><code>CodeGenBackend::Wasm =&gt; {
            gen_from_mono_module_dev_wasm32(arena, loaded, preprocessed_host_path, wasm_dev_stack_bytes)
        }
</code></pre></div>



<a name="352667607"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667607" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667607">(Apr 26 2023 at 01:14)</a>:</h4>
<p>Yeah, that actually makes sense, cause other stuff is not expecting the development backend and is using the wrong file becuase it is matching what the llvm backend wants for files.</p>



<a name="352667655"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667655" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667655">(Apr 26 2023 at 01:15)</a>:</h4>
<p>You also need to update this, which is another bug/discrepency: <a href="https://github.com/roc-lang/roc/blob/ffe30af2167385ad75cb89c073608166df18b0e7/crates/cli/src/lib.rs#L606-L616">https://github.com/roc-lang/roc/blob/ffe30af2167385ad75cb89c073608166df18b0e7/crates/cli/src/lib.rs#L606-L616</a></p>



<a name="352667675"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667675" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667675">(Apr 26 2023 at 01:15)</a>:</h4>
<p>to:</p>
<div class="codehilite"><pre><span></span><code>        match (
            matches.is_present(FLAG_OPTIMIZE),
            matches.is_present(FLAG_OPT_SIZE),
            matches.is_present(FLAG_DEV),
        ) {
            (true, false, false) =&gt; OptLevel::Optimize,
            (false, true, false) =&gt; OptLevel::Size,
            (false, false, true) =&gt; OptLevel::Development,
            (false, false, false) =&gt; OptLevel::Normal,
            _ =&gt; user_error!(&quot;build can be only one of `--dev`, `--optimize`, or `--opt-size`&quot;),
        }
</code></pre></div>



<a name="352667687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667687">(Apr 26 2023 at 01:15)</a>:</h4>
<p>Then with <code>--dev</code>, it seems to compile fine.</p>



<a name="352667694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667694">(Apr 26 2023 at 01:15)</a>:</h4>
<p>Not sure if it works though</p>



<a name="352667806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667806">(Apr 26 2023 at 01:16)</a>:</h4>
<p>So yeah, some of the wasm pipelining seems to have been messed up over time.</p>



<a name="352667818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667818">(Apr 26 2023 at 01:16)</a>:</h4>
<p>Not sure what is breaking with the llvm backend though. That is a separate issue.</p>



<a name="352667858"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352667858" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352667858">(Apr 26 2023 at 01:17)</a>:</h4>
<p>So that gives me a <code>.o</code> file instead of a <code>.wasm</code> file now.</p>



<a name="352668153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352668153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352668153">(Apr 26 2023 at 01:20)</a>:</h4>
<div class="codehilite"><pre><span></span><code>% cargo run -- build --target wasm32 --dev ../roc-serverless/examples/echo.roc
 ðŸ”¨ Rebuilding platform...
0 errors and 0 warnings found in 394 ms while successfully building:

    ../roc-serverless/examples/echo.o
</code></pre></div>



<a name="352668169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352668169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352668169">(Apr 26 2023 at 01:20)</a>:</h4>
<p>I'm not really sure, but fundamentally, we need to rework these pipelines.</p>



<a name="352668207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352668207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352668207">(Apr 26 2023 at 01:21)</a>:</h4>
<p>Also, I think we need to make two different targets for <code>wasm32</code>, one for browser, and one for wasi.</p>



<a name="352668332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352668332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352668332">(Apr 26 2023 at 01:22)</a>:</h4>
<p>Also, <code>echo.o</code> may just be a misnaming of <code>echo.wasm</code>. Assuming the wasm dev backend generated correctly, I think it was just filling in whatever file name it was given.</p>



<a name="352668529"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352668529" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352668529">(Apr 26 2023 at 01:25)</a>:</h4>
<p>Yeah, unfortunately that doesn't seem to be the case. </p>
<div class="codehilite"><pre><span></span><code>% wasmer validate examples/echo.o
error: failed to validate `examples/echo.o`
â•°â”€â–¶ 1: Validation error: unexpected end-of-file (at offset 0x0)
</code></pre></div>



<a name="352668660"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352668660" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352668660">(Apr 26 2023 at 01:26)</a>:</h4>
<p>haha. ok</p>



<a name="352669142"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352669142" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352669142">(Apr 26 2023 at 01:32)</a>:</h4>
<p>So if I comment out the <code>wasm_module.eliminate_dead_code(env.arena, called_fns);</code> in <code>build_app_binary</code> in <code>crates/compiler/gen_wasm/src/lib.rs</code> is does generate a valid wasm filed, named <code>echo.o</code>.  But then I have this issue;</p>
<div class="codehilite"><pre><span></span><code>% wasmer validate examples/echo.o
Validation passed for `examples/echo.o`.
% wasmer run examples/echo.o
error: failed to run `examples/echo.o`
â”‚   1: failed to instantiate WASI module
â”‚   2: Instantiation failed
â•°â”€â–¶ 3: Error while importing &quot;env&quot;.&quot;roc_panic&quot;: unknown import. Expected Function(FunctionType { params: [I32, I32], results: [] })
</code></pre></div>



<a name="352669376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352669376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352669376">(Apr 26 2023 at 01:35)</a>:</h4>
<p>So I think I'm almost there, it looks good in the wasm module. I just don't have a zig implementation for <code>roc_panic</code> I think.  I'll see if I can figure that out.</p>



<a name="352670583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352670583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352670583">(Apr 26 2023 at 01:49)</a>:</h4>
<p>Adding <code>roc_panic</code> like this, and now I have a different issue.</p>
<div class="codehilite"><pre><span></span><code>export fn roc_panic(_: *anyopaque, _: *anyopaque) void {
    // do something?
}
</code></pre></div>
<div class="codehilite"><pre><span></span><code>% wasmer run examples/echo.o
error: failed to run `examples/echo.o`
â”‚   1: failed to instantiate WASI module
â”‚   2: Instantiation failed
â•°â”€â–¶ 3: Error while importing &quot;env&quot;.&quot;roc__mainForHost_1_exposed_generic&quot;: unknown import. Expected Function(FunctionType { params: [I32, I32], results: [] })
</code></pre></div>



<a name="352671206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352671206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352671206">(Apr 26 2023 at 01:57)</a>:</h4>
<p>Can you switch away from the generic version of the function and to the concrete one</p>



<a name="352671261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352671261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352671261">(Apr 26 2023 at 01:57)</a>:</h4>
<p>Fundamentally should be something like <code>roc__mainForHost_1_exposed(arg: *RocList) *RocList</code></p>



<a name="352671313"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352671313" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352671313">(Apr 26 2023 at 01:58)</a>:</h4>
<p>Maybe dev wasm doesn't generate the generic version...not sure though</p>



<a name="352671808"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352671808" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352671808">(Apr 26 2023 at 02:03)</a>:</h4>
<p>Hmmm, not sure about that. </p>
<div class="codehilite"><pre><span></span><code>...
pub extern fn roc__mainForHost_1_exposed(arg: *RocList) *RocList;

pub fn main() !void {
    ...
    var arg = RocList.fromSlice(u8, helloStr[0..]);
    var ret: *RocList = roc__mainForHost_1_exposed(&amp;arg);
</code></pre></div>
<div class="codehilite"><pre><span></span><code>% wasmer run examples/echo.o
error: failed to run `examples/echo.o`
â•°â”€â–¶ 1: RuntimeError: Parameters of type [] did not match signature [F64, I64, I64] -&gt; [F64]
</code></pre></div>



<a name="352671979"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352671979" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352671979">(Apr 26 2023 at 02:05)</a>:</h4>
<p>It might have worked actually, the issue now might be my main.</p>
<div class="codehilite"><pre><span></span><code>Exports:
  Functions:
    &quot;_start&quot;: [F64, I64, I64] -&gt; [F64]
</code></pre></div>



<a name="352672099"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352672099" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352672099">(Apr 26 2023 at 02:07)</a>:</h4>
<p>Awesome! Though i have no ideas for that error.</p>



<a name="352673336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352673336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352673336">(Apr 26 2023 at 02:23)</a>:</h4>
<p>Yeah, trying to figure this one out is tricky. I think we've got the right code for working with Roc, and my issue is purely WASI specific now. Start should be <code>"_start": [] -&gt; []</code></p>



<a name="352690635"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352690635" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352690635">(Apr 26 2023 at 05:32)</a>:</h4>
<p>Oh that's right I never implemented that for the generic main. Never had an example of it.</p>



<a name="352705999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352705999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352705999">(Apr 26 2023 at 06:59)</a>:</h4>
<p>Ok, I think I've exhausted up to the limit of my knowledge for now. </p>
<p>I've reverted back to the simpler <code>main : Str </code> for the platform (as in the rocLovesWasm example) and want to focus on integrating with a cloud. I've uncovered a some issues here, and I'm not confident enough to say which of these need to be fixed or investigated further. I'm happy to log issues for anything I've mentioned above we want to keep track of, just need a pointer here and there. </p>
<p>For Rust Host -&gt; WASM it seems the main issue is that we only support generating WASM when we have a <code>host.zig</code> host. All the Rust examples have a <code>host.c</code> host. I have an example Rust platform that I've added a <code>host.zig</code> to. I'm reasonably confident it should work, <code>cargo check</code> is happy etc, and it generates valid wasm, however it doesn't seem to build and then link in any of the Rust (and by extension the Roc) functions into the end file.</p>
<p>For Zig Host -&gt; WASM there are a few issues in the build tooling which I've discussed above. If these issues are worked around with manual compiler patches, we end up with <code>_start</code> not being generated correctly which is the standard entry for WASI. Brendan suggested we need a separate target for WASI; I feel like a Roc app will always have a main so we can always support WASI without issues.</p>



<a name="352706687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352706687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352706687">(Apr 26 2023 at 07:02)</a>:</h4>
<p>I've pushed the latest I have to <a href="https://github.com/lukewilliamboswell/roc-serverless">github</a> and updated README to work using current main, in case anyone would like to see.</p>



<a name="352764130"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352764130" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352764130">(Apr 26 2023 at 11:11)</a>:</h4>
<p>I'll make a few comments that some people might know already but others might not.<br>
The <code>_start</code> function is not unique to WASI or Wasm, native binaries have the same thing. When you write a C program with a <code>int main(int argc, char** argv)</code>, the C compiler inserts code to call <code>main</code> from a <code>_start</code> function that is usually written in assembly and provided by <code>libc</code>. It sets up the stack and the values of <code>argc</code> and <code>argv</code> and then calls <code>main</code>.<br>
<a href="https://embeddedartistry.com/blog/2019/04/08/a-general-overview-of-what-happens-before-main/">https://embeddedartistry.com/blog/2019/04/08/a-general-overview-of-what-happens-before-main/</a><br>
The Roc entry point <code>main</code> is of course not the overall entry point for the whole binary. The <em>real</em> <code>main</code> is in Zig or Rust or whatever, and that is the one that should be called from <code>_start</code>. <code>_start</code> normally has no arguments. I can't remember if it returns an exit code as i32, or if it returns void.<br>
In the virtual DOM platform that I started work on a while ago (and is now on hold) the client side Zig platform has no <code>main</code> or <code>_start</code>  because we are running in a browser, not an OS, and there are no command line arguments etc.<br>
Similarly if Roc is being used to generate a plugin for a game engine or something, we will compile to an object file or dynamic library rather than an executable, and it will have no <code>main</code>.</p>



<a name="352794563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352794563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352794563">(Apr 26 2023 at 13:06)</a>:</h4>
<p>do we actually need <code>wasm-ld</code> anymore?</p>



<a name="352794616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352794616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352794616">(Apr 26 2023 at 13:06)</a>:</h4>
<p>now that we have a surgical linking implementation</p>



<a name="352845400"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352845400" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352845400">(Apr 26 2023 at 15:27)</a>:</h4>
<p>Looking at the current code, <code>wasm-ld</code> is used in a few places, all driven by zig. It is used for compiling the host, preprocessing the host, and linking if not using the additive linker.</p>



<a name="352937601"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352937601" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352937601">(Apr 26 2023 at 20:08)</a>:</h4>
<p>gotcha - but if we switched to always use the additive linker for compiling Roc application code, then it would only be used on the host and that's it?</p>



<a name="352946361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/352946361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#352946361">(Apr 26 2023 at 21:01)</a>:</h4>
<p>Yeah, I think so. Would only need it for building and preprocessing the host. That said, no idea how it works and what it would take to use with the llvm backend. No idea if any part of it is special.</p>



<a name="354063871"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354063871" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354063871">(Apr 28 2023 at 22:13)</a>:</h4>
<p>Not sure what you mean by special, but can't think of anything unusual about it.</p>
<p>But as I mentioned in another thread recently, the surgical / additive linking is quite specific to the Dev Wasm backend. It is not a general purpose linker like wasm-ld is. It could be developed into something more but why? Wasm ld does what we need.</p>



<a name="354064106"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354064106" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354064106">(Apr 28 2023 at 22:13)</a>:</h4>
<p>We need it to create a preprocessed host</p>



<a name="354065741"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354065741" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354065741">(Apr 28 2023 at 22:18)</a>:</h4>
<p>Also my linking code will not work for llvm</p>



<a name="354082390"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354082390" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354082390">(Apr 28 2023 at 23:11)</a>:</h4>
<p>well ultimately the goal in general (not just for wasm, but all backends) is that:</p>
<ul>
<li>linking always starts from a preprocessed host (e.g. that was downloaded from a URL)</li>
<li>we always do linking ourselves rather than relying on a third-party linker (both so <code>roc</code> is the only thing you need to download to use Roc, which is a goal, and also so we can complete linking as fast as possible, which is also a goal!)</li>
</ul>



<a name="354186059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354186059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354186059">(Apr 29 2023 at 05:11)</a>:</h4>
<p>Ok so if we always start from a preprocessed host then a platform author needs wasm-ld to create that.</p>



<a name="354199364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354199364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354199364">(Apr 29 2023 at 05:56)</a>:</h4>
<p>oh yeah platform authors will totally need third-party tools to create preprocessed hosts <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="354199630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354199630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354199630">(Apr 29 2023 at 05:56)</a>:</h4>
<p>but that's already unavoidable because they need some other language besides Roc to create the host anyway</p>



<a name="354199752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354199752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354199752">(Apr 29 2023 at 05:57)</a>:</h4>
<p>so really I should have said application authors shouldn't need anything other than <code>roc</code> to use it</p>



<a name="354216580"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354216580" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354216580">(Apr 29 2023 at 06:48)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/231634-beginners/topic/How.20to.20WASM/near/352794563">said</a>:</p>
<blockquote>
<p>do we actually need <code>wasm-ld</code> anymore?</p>
</blockquote>
<p>Ok so back to this question, the answer is that the llvm backend needs it because our surgical linking doesn't work with that.<br>
And we also need it to build any of our official platforms or example platforms.</p>



<a name="354604914"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354604914" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354604914">(Apr 30 2023 at 04:02)</a>:</h4>
<p>I got an example working on NodeJS via wasm - <a href="https://github.com/roc-lang/roc/pull/5346">https://github.com/roc-lang/roc/pull/5346</a> - but I got stuck trying to figure out how to pass a NodeJS string into wasm <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="354604951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354604951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354604951">(Apr 30 2023 at 04:03)</a>:</h4>
<p>anyone with wasm knowledge know how to go about doing that? I basically want to have <code>main.roc</code> give a <code>Str -&gt; Str</code> function instead of a <code>Str</code>, and then call that from JS passing a JS string converted to a wasm representation that Roc can use</p>



<a name="354605271"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605271" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605271">(Apr 30 2023 at 04:09)</a>:</h4>
<p>Just a note, I know Luke was running into some generation issue with the LLVM backend. For <code>List U8 -&gt; List U8</code> i think it broke and generated the wrong signature.</p>



<a name="354605273"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605273" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605273">(Apr 30 2023 at 04:09)</a>:</h4>
<p>I've had trouble making that change as well. I think it is my understanding of the <code>pub extern fn roc__mainForHost_1_exposed_generic(_: *RocStr, _: *RocStr) void;</code> function which has me stumped. I keep getting stuck on a Zig <code>unreachable</code> error when I try and run the wasm file that gets generated. I was hoping to copy your implementation.</p>



<a name="354605289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605289">(Apr 30 2023 at 04:09)</a>:</h4>
<p>I really don't know how to figure out what the function types should be for the Roc exposed stuff</p>



<a name="354605367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605367">(Apr 30 2023 at 04:11)</a>:</h4>
<p>I feel like I'm reaching in the dark here. I had the idea of generating the types for Rust using glue, which works well. But then I think my Zig lets me down when I try and fault find. So haven't made much progress.</p>



<a name="354605876"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605876" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605876">(Apr 30 2023 at 04:21)</a>:</h4>
<p>Basically I keep playing around with the signature of <code>roc__mainForHost</code> and I am getting different errors like,</p>
<div class="codehilite"><pre><span></span><code>wasm-ld: warning: function signature mismatch: roc__mainForHost_1_exposed_generic
&gt;&gt;&gt; defined as (i32, i64, i32) -&gt; void in lto.tmp
&gt;&gt;&gt; defined as (i32) -&gt; void in ../roc-serverless/examples/../platform/zig-cache/o/60f380eba017104c3db40f606e31875f/roc_app145t9T.o
</code></pre></div>
<p>I am reasonably sure it should be something like <code>pub extern fn roc__mainForHost_1_exposed_generic(_: *RocStr, _: RocStr) void;</code>; but I am not sure.</p>



<a name="354605885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605885">(Apr 30 2023 at 04:21)</a>:</h4>
<p>well one hurdle that has to be overcome is that it relies on <code>pub fn main()</code> in <code>host.zig</code></p>



<a name="354605939"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605939" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605939">(Apr 30 2023 at 04:22)</a>:</h4>
<p>and <code>main</code> isn't allowed to accept arguments directly</p>



<a name="354605955"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605955" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605955">(Apr 30 2023 at 04:22)</a>:</h4>
<p>it would need to be some other function than <code>main</code> and then exported differently, but I haven't been able to figure out how to get that to work</p>



<a name="354605958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354605958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354605958">(Apr 30 2023 at 04:22)</a>:</h4>
<p>This is what I have currently. My plan is to use STDIO, you can bind to that from JS</p>
<div class="codehilite"><pre><span></span><code>pub extern fn roc__mainForHost_1_exposed_generic(_: *RocStr, _: RocStr) void;

pub fn main() u8 {

    // Call Roc and get the Str
    var arg : RocStr = RocStr.empty();
    var ret : *RocStr = &amp;RocStr.empty();

    roc__mainForHost_1_exposed_generic(ret, arg);

    // Print to stdio
    const stdout = std.io.getStdOut().writer();
    stdout.print(&quot;Printing...&quot;, .{}) catch unreachable;
    stdout.print(&quot;{s}&quot;, .{ret.asSlice()}) catch unreachable;

    // value.decref();

    return 0;
}
</code></pre></div>



<a name="354606038"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354606038" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354606038">(Apr 30 2023 at 04:24)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> shouldn't it be similar to a browser example where it is controlled by a <a href="https://github.com/roc-lang/roc/blob/main/examples/platform-switching/web-assembly-platform/host.js">host.js file</a>? Then you would setup zig the same way as that example.</p>



<a name="354606306"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354606306" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354606306">(Apr 30 2023 at 04:26)</a>:</h4>
<p>I have an example here somewhere, I'll dig it out. It shows the WASM and the JS for using stdio/stdout</p>



<a name="354606310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354606310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354606310">(Apr 30 2023 at 04:26)</a>:</h4>
<p>unfortunately that example is using <code>main()</code> with no arguments - <a href="https://github.com/roc-lang/roc/blob/e520eaddccd4042432efb1cc4cf0389845efbb00/examples/platform-switching/web-assembly-platform/host.js#L48">https://github.com/roc-lang/roc/blob/e520eaddccd4042432efb1cc4cf0389845efbb00/examples/platform-switching/web-assembly-platform/host.js#L48</a> (which compiles to <code>_start</code>)</p>



<a name="354606315"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354606315" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354606315">(Apr 30 2023 at 04:26)</a>:</h4>
<p>Or <a href="https://github.com/bhansconnect/functional-mos6502-web-performance/blob/master/implementations/roc-effectful/platform/host.js">like this</a>. Zig still has a main, but other functions can be called/shared with wasm module</p>



<a name="354606462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354606462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354606462">(Apr 30 2023 at 04:28)</a>:</h4>
<p>how though? in examples like that I've done <code>console.log</code> on <a href="https://github.com/bhansconnect/functional-mos6502-web-performance/blob/c0033c4bf22f690320b7b56f7e7ede3a7dc44f32/implementations/roc-effectful/platform/host.js#L45"><code>wasm.instance.exports</code></a> and all it has is <code>_start</code></p>



<a name="354606470"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354606470" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354606470">(Apr 30 2023 at 04:28)</a>:</h4>
<p>including if I define another <code>pub</code>  function just like <code>main</code> (except not named <code>main</code>)</p>



<a name="354606677"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354606677" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354606677">(Apr 30 2023 at 04:32)</a>:</h4>
<p>This <a href="https://blog.cloudflare.com/announcing-wasi-on-workers/">announcing-wasi-on-workers</a> is the example I was thinking of, unfortunately it uses a library from cloudfare. I thought it was vanilla JS.</p>



<a name="354613959"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354613959" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354613959">(Apr 30 2023 at 06:07)</a>:</h4>
<p>A good mental model here is that the wasm program is a dynamic library, not an executable. You don't want a <code>main</code> because the <code>main</code> is in the browser or node. That runs the event loop which enters JS, which calls Wasm. So Wasm is not really an entry point.</p>



<a name="354614075"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354614075" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354614075">(Apr 30 2023 at 06:08)</a>:</h4>
<p>So if you have a zig host then export some functions from it</p>



<a name="354614232"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354614232" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354614232">(Apr 30 2023 at 06:09)</a>:</h4>
<p>Then when you instantiate your Wasm module pass it an object of the functions it needs to "link" to</p>



<a name="354614345"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354614345" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354614345">(Apr 30 2023 at 06:10)</a>:</h4>
<p>And the exported functions will appear in <code>exports</code></p>



<a name="354614443"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354614443" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354614443">(Apr 30 2023 at 06:11)</a>:</h4>
<p>We have a hello world example and a virtual dom example, they both do this. Did you try copying those?</p>



<a name="354614826"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354614826" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354614826">(Apr 30 2023 at 06:15)</a>:</h4>
<p><code>pub</code> is not enough, you need to export it. That's the same technique we use for our built-ins. Those are also built into a library for external foreign code to use. This is no different.</p>



<a name="354616056"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354616056" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354616056">(Apr 30 2023 at 06:23)</a>:</h4>
<p>It's confusing because Zig automatically exports a function called main but no other names</p>



<a name="354616926"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354616926" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354616926">(Apr 30 2023 at 06:30)</a>:</h4>
<p>For npm you should look at browser examples only, and ignore all WASI examples. WASI does the opposite of what you want, as it usually focuses on executables. But for node or browser you never want that. There is only a way for Wasm to be called from JS. There's no way for it to be <code>main</code>.</p>



<a name="354618122"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354618122" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354618122">(Apr 30 2023 at 06:42)</a>:</h4>
<p>OK I have some time today and tomorrow. Richard and Luke, if you like, I can spend an hour or so with each of you separately on Zoom and try to unblock you. DM me to arrange. It would be good to spread familiarity of this stuff around a bit more! If we succeed then we can post back here to let people what worked.</p>



<a name="354717725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354717725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354717725">(Apr 30 2023 at 16:25)</a>:</h4>
<p>The chats with Luke and Richard both concluded that we have some bugs in our build system for Wasm targets.<br>
I came across <a href="https://github.com/roc-lang/roc/compare/main...fix-wasm-build#diff-a0fa218e1d84f824e03760d3ba315c429533dd1e5e8546c99c0c365a957c8edfR776">one place in particular</a> where we are assigning a variable <code>preprocessed_host_path</code> to <code>host.zig</code><br>
But that can't be right because "preprocessed" implies "compiled" but this is a source code file. We are then passing it to <code>wasm-ld</code> which doesn't make sense.<br>
I think we need to spend some time debugging that build process and create a test for it that runs in CI to keep it working, such as the Node.js integration example.</p>



<a name="354730681"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354730681" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354730681">(Apr 30 2023 at 18:00)</a>:</h4>
<p>This may be correct, but only because our llvm wasm build currently is heavily tied to zig. It actually tosses out the preprocessed host and use <code>host.zig</code>. The final command it runs is a command to compile <code>host.zig</code> and <code>roc_app.bc</code> into a wasm file. I think it was a hack to make the build process simple and get it to work for llvm wasm.</p>
<p>That all said, no matter what, that needs to change in the long term to separate llvm wasm from zig.</p>



<a name="354730889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354730889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354730889">(Apr 30 2023 at 18:02)</a>:</h4>
<p>In other words, currently, llvm wasm throws away all prepocessing and instead lets zig completely control the build.</p>



<a name="354731148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354731148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354731148">(Apr 30 2023 at 18:05)</a>:</h4>
<p>gotcha - what would it take to change that?</p>



<a name="354732185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354732185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354732185">(Apr 30 2023 at 18:13)</a>:</h4>
<p>I don't actually know. I just happened to learn about the weird dependencies when working on my recent wasm related PR.</p>



<a name="354801018"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354801018" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354801018">(May 01 2023 at 06:29)</a>:</h4>
<p>As far as I could tell, host.zig is passed _directly_ as an argument to wasm-ld. But wasm-ld is not a Zig compiler.</p>



<a name="354801336"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354801336" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354801336">(May 01 2023 at 06:31)</a>:</h4>
<p>oh, rereading your comment, maybe I was getting fooled by a variable name</p>



<a name="354801473"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/354801473" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#354801473">(May 01 2023 at 06:32)</a>:</h4>
<p>either way we need to change this, if only to refactor the existing behaviour to make it clear what's happening!</p>



<a name="447290900"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447290900" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447290900">(Jun 26 2024 at 18:03)</a>:</h4>
<p>Heya, sorry to necro this topic, but most of the context for this conversation is here. I am very interested in platform building and specifically standalone wasm platforms for roc.</p>
<p>I got my first taste trying to use the nightly package to compile some of the wasm examples. I hit a few issues, dug in, and got my <a href="https://github.com/roc-lang/roc/pull/6834">first PR</a> in fixing the issues with the nightly release. I tried to get a feel for where things were though the process of opening that PR, reading the <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/compiler/build/src/link.rs#L4">two</a> <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/linker/src/lib.rs">linkers</a>, and reading through some of the conversations here.</p>
<p>It <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/linker/src/lib.rs#L444">appears</a> that there is still some work to be done in the surgical linker to support my goals. I browsed through the elf linker to get an idea what the work would be and this is obviously a much larger task than the one I took on previously. Before I begin I just had a couple questions.</p>
<ol>
<li>Does this work align with the project's near term goals? It <a href="https://github.com/roc-lang/roc/issues/6037">seems</a> <a href="https://github.com/roc-lang/roc/issues/6414">like</a> it?</li>
<li>Am I stepping on any toes? It looks like <span class="user-mention" data-user-id="431893">@Brian Carroll</span> and <span class="user-mention" data-user-id="281543">@Folkert de Vries</span> have done most of the work around the current linker.</li>
<li>I believe the final outcome of this is building a wasm platform would more or less mirror the process for the <a href="https://www.roc-lang.org/examples/GoPlatform/README.html">go platform</a>. It this the desired end state? Am I incorrect that because of the <code>preprocess-host</code> step building a platform will still depend on some final target roc app?</li>
<li>The current surgical linker implementation is entirely dependent on the <code>object</code> crate. That library does not support wasm. It also does not have any sort of public trait to implement its API for a wasm target we define. From the elf code it looks like we predominantly rely on the <code>.sections()</code> and <code>.relocations()</code> iterators / items. Would you want to just duck-type their api? Implement our own trait wrapping <code>object</code>'s functionality, then implement that for wasm? Try to push such an implementation back upstream before we take this on?</li>
<li>Any tips before I begin? Any landmines I have not uncovered yet?</li>
</ol>
<p>Sorry for the barrage of questions. I hoped I could give the best idea of what I want to implement by packaging some of the broad directional strokes alongside some of the implementation details. Thanks for taking the time to read this far!</p>



<a name="447291160"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447291160" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447291160">(Jun 26 2024 at 18:04)</a>:</h4>
<p>re toe stepping, definitely not.</p>



<a name="447304817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447304817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447304817">(Jun 26 2024 at 19:01)</a>:</h4>
<p>I think there is a misconception here. The surgical linker is only for native targets.</p>



<a name="447304861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447304861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447304861">(Jun 26 2024 at 19:01)</a>:</h4>
<p>So it is is not needed for any wasm work</p>



<a name="447305088"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447305088" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447305088">(Jun 26 2024 at 19:02)</a>:</h4>
<p>We have a separate custom wasm linker that <span class="user-mention" data-user-id="431893">@Brian Carroll</span> wrote and it should be mostly good to just use. Otherwise, can always fallback to the legacy wasm linker</p>



<a name="447305230"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447305230" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447305230">(Jun 26 2024 at 19:03)</a>:</h4>
<p>That said, I know some of our wasm building and linking was tied into zig for simplicity. Depending on your platform goals, that may need to be unwound.</p>



<a name="447306214"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447306214" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447306214">(Jun 26 2024 at 19:06)</a>:</h4>
<p>If anything, I assume this work would be built on top of the additive linker (assuming it is missing the features needed)....</p>
<p>Actually I think I already know what is missing. If I understand correctly, the additive linker only works with the wasm dev backend and not the wasm llvm backend. Something probably needs to be done for the llvm backend and wasm backend to both link in the same way.</p>



<a name="447307229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447307229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447307229">(Jun 26 2024 at 19:10)</a>:</h4>
<p>Totally not stepping on toes. Any assistance would be most appreciated. I'll try and explaing my understanding of the current situation. I'm not an expert on these things, and have mostly just stumbled into these things while trying to make a change. Sorry for the long post.</p>



<a name="447307261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447307261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447307261">(Jun 26 2024 at 19:10)</a>:</h4>
<p>I've been trying to work towards removing the platform rebuilding from the cli so its not a dependency from the compiler on the platform hosts. This will remove complexity from the compiler and make it easier to maintain and to support more host languages, by shifting the responsibility for (pre)building binaries to the platform hosts, who can use thier own tooling etc. Roc is then only responsible for linking the host and the app together.</p>



<a name="447307281"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447307281" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447307281">(Jun 26 2024 at 19:10)</a>:</h4>
<p>It turns out, what I thought would be a relatively minor change is a rather large yak that requires shaving. There seems to be a lot of different things that are interrelated and need to happen first.</p>



<a name="447307300"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447307300" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447307300">(Jun 26 2024 at 19:10)</a>:</h4>
<p>In short the current status is that I am stuck on <a href="https://github.com/roc-lang/roc/pull/6808">https://github.com/roc-lang/roc/pull/6808</a>, specifically I don't have a great setup on linux so it's been slow to fix this, and I've gotten distracted by other things I can make progress on. This change fixes the preprocess host subcommand, which means we can make prebuilt binaries for the platform hosts that are suitable for the surgical linker. That will enable us to land <a href="https://github.com/roc-lang/basic-webserver/pull/54">this basic-webserver</a> and <a href="https://github.com/roc-lang/basic-cli/pull/194">this basic-cli</a> PRs which refactor the host out into crates and add a build script. Without the pre-process host subcommand working, we can't build the prebuilt binaries to support the surgical linker.</p>



<a name="447307325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447307325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447307325">(Jun 26 2024 at 19:10)</a>:</h4>
<p>For WASM specifically, I have been stuck on at least one issue. I started <a href="https://github.com/lukewilliamboswell/roc-platform-template-wasi">the roc-platform-template-wasi</a> platform to try and find the correct way to build WASM platforms. The current roc cli rebuilds a WASM host using some workarounds by compiling to llvm bytcode and then using zig to build the final <code>.wasm</code> file. I think this is a limitation in zig <code>0.11.0</code> that is resolved in zig <code>0.12.0</code> and later versions. If we upgrade our zig version (<a href="#narrow/stream/395097-compiler-development/topic/Zig.200.2E12.2E0/near/444208611">which looks doable now</a> then I think we can use zig to link two  <code>.wasm</code> files just using <code>zig build-exe</code> or <code>zig build-lib</code>. I discovered this while working on <a href="https://github.com/lukewilliamboswell/roc-glue-code-gen/pull/3">upgrading the glue for zig platforms</a>. So ideally, we can have the host (pre)built into a <code>.wasm</code> file and then all the roc cli needs to do is link that with the app <code>.wasm</code> file to make the final binary. We may be able to use the WASM linker that we already have for the dev backend, I haven't looked into that yet. I haven't been able to build and link everything correctly manually yet.</p>



<a name="447307349"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447307349" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447307349">(Jun 26 2024 at 19:10)</a>:</h4>
<p>After unlocking the preprocess-host subcommand, and updating the platforms to support surgical linking, we can then return to the cli and switch off platform rebuilding. But doing this breaks all of the cli platform tests in the compiler as they now need a second step to build the platform. All of those changes are mostly done and ready to go in <a href="https://github.com/roc-lang/roc/pull/6696">#6696</a>. We also want to move most of the examples from <code>roc-lang/roc/examples</code> and into the examples repository at <code>roc-lang/examples</code>, and the cli test that are there into <code>roc-lang/roc/crates/cli/tests/...</code>. We have cli tests for CI to ensure we don't break basic-cli etc, but these examples aren't the best experience for newcomers wanting to checkout roc, that is why we have the examples repository.</p>



<a name="447307791"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447307791" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447307791">(Jun 26 2024 at 19:12)</a>:</h4>
<p>Ok, yes I think there is some misconception on the surgical linker then. I tried to build the wasm platform in rust instead of zig. I was looking to build wasm plugins for a host (not roc host) rust program. To do that it was helpful to share data structures and logic between the host program and the roc platform code. So I tried to do a "standalone" wasm build, adapting the nodejs interop example to the instructions found in the go platform tutorial. I got all the way to step 4 with <code>roc preprocess-host main.roc --target wasm32</code> and it failed with <code>thread 'main' panicked at crates/linker/src/lib.rs:335:14: not yet implemented: surgical linker does not support target Wasm32</code>. At that point I dove into the surgical linker since that was where that error came from.</p>



<a name="447311579"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447311579" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447311579">(Jun 26 2024 at 19:26)</a>:</h4>
<p>Is this the "seperate custom linker" you were referring to?<br>
<a href="https://github.com/roc-lang/roc/blame/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/compiler/build/src/link.rs#L1196">https://github.com/roc-lang/roc/blame/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/compiler/build/src/link.rs#L1196</a></p>



<a name="447312580"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447312580" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447312580">(Jun 26 2024 at 19:32)</a>:</h4>
<blockquote>
<p>Something probably needs to be done for the llvm backend and wasm backend to both link in the same way.</p>
</blockquote>
<p>There's a common misunderstanding to watch out for. "The additive linker" is not really thing. It's not a separate entity from the wasm dev back end. Rather, that backend is designed to not really need any linking.</p>
<p>The backend has some internal state where it keeps track of the "instructions generated so far". To initialise that state, I "cheat" by loading it up with the instructions from the host instead. So the backend "thinks" it generated the host. It then "appends" the instructions for the Roc app to the instructions for the host.</p>
<p>There is not really any linking because you never have two separate things to link.</p>



<a name="447312777"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447312777" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447312777">(Jun 26 2024 at 19:33)</a>:</h4>
<p>When Brendan mentioned "seperate custom linker" this is what he was referring to.</p>



<a name="447313524"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447313524" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447313524">(Jun 26 2024 at 19:36)</a>:</h4>
<p>Here is the type signature of <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/compiler/gen_wasm/src/lib.rs#L88-L94"><code>build_app_module</code></a>.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">build_app_module</span><span class="o">&lt;'</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">r</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">env</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">r</span><span class="w"> </span><span class="nc">Env</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">layout_interner</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">r</span><span class="w"> </span><span class="nc">mut</span><span class="w"> </span><span class="n">STLayoutInterner</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">interns</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">'</span><span class="na">r</span><span class="w"> </span><span class="nc">mut</span><span class="w"> </span><span class="n">Interns</span><span class="p">,</span>
<span class="w">    </span><span class="n">host_module</span><span class="p">:</span><span class="w"> </span><span class="nc">WasmModule</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">procedures</span><span class="p">:</span><span class="w"> </span><span class="nc">MutMap</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Symbol</span><span class="p">,</span><span class="w"> </span><span class="n">ProcLayout</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">),</span><span class="w"> </span><span class="n">Proc</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">WasmModule</span><span class="o">&lt;'</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">BitVec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span>
</code></pre></div>
<p>You can see one of the arguments is <code>host_module: WasmModule&lt;'a&gt;</code> and the return value is another, larger <code>WasmModule&lt;'a&gt;</code>.</p>



<a name="447313809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447313809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447313809">(Jun 26 2024 at 19:37)</a>:</h4>
<p>So it takes the host and adds the app to it.</p>



<a name="447314291"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447314291" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447314291">(Jun 26 2024 at 19:38)</a>:</h4>
<p>Now I oversimplified a little when I said there is "no" linking to do. There is no linking needed for app-to-host calls. But we do need to do some linker type work for host-to-app calls. In other words, the <code>mainForHost</code> call.</p>



<a name="447314317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447314317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447314317">(Jun 26 2024 at 19:38)</a>:</h4>
<p>So there is some linking functionality there</p>



<a name="447315194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447315194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447315194">(Jun 26 2024 at 19:42)</a>:</h4>
<p>And if someone wanted to make a separate linker for Wasm then there is plenty of relevant code there you could start from. In particular the <a href="https://github.com/roc-lang/roc/tree/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/wasm_module"><code>wasm_module</code></a> crate. It knows how to parse a binary file into that <code>WasmModule</code> data structure. We have Rust code for parsing and traversing the linking data in a Wasm file.</p>



<a name="447316171"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447316171" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447316171">(Jun 26 2024 at 19:46)</a>:</h4>
<p>Thanks for the pointer <span class="user-mention" data-user-id="431893">@Brian Carroll</span> ! I am going to have to take a hot second to digest what you wrote here. I have not been through the <code>gen_wasm</code> compiler module yet.</p>



<a name="447317670"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447317670" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447317670">(Jun 26 2024 at 19:52)</a>:</h4>
<p>OK cool. I'll throw some more links at you for the bits that do linking stuff.</p>
<ul>
<li>Here's where we <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/wasm_module/src/lib.rs#L118">preload</a> the host bytes and parsing them into a WasmModule</li>
<li>Here's where we <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/wasm_module/src/lib.rs#L80">serialize</a> the WasmModule back out again</li>
<li>Here are the data structures for the <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/wasm_module/src/linking.rs">linking section</a> of the Wasm module</li>
<li>Here's where we <a href="https://github.com/roc-lang/roc/blob/f8c6786502bc253ab202a55e2bccdcc693e549c8/crates/wasm_module/src/lib.rs#L524"><code>link_host_to_app_calls</code></a></li>
</ul>



<a name="447318209"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447318209" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447318209">(Jun 26 2024 at 19:54)</a>:</h4>
<p>Nearly all the linking related stuff is in wasm_module rather than gen_wasm. So if someone wanted to build a separate surgical linker to use with the LLVM backend, they would import stuff from wasm_module and not gen_wasm.</p>



<a name="447318481"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447318481" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447318481">(Jun 26 2024 at 19:55)</a>:</h4>
<p>Might be worth looking at the README files as well.</p>



<a name="447318727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447318727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447318727">(Jun 26 2024 at 19:56)</a>:</h4>
<p>And the reason <code>wasm_module</code> is not invoked from the linker today is it does not <del>have</del> produce the appropriate llvm metadata, so cannot be optimized?</p>
<p>The surgical linker is all about getting LLVM to optimize the final output?</p>



<a name="447319030"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447319030" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447319030">(Jun 26 2024 at 19:58)</a>:</h4>
<p>No that's not right.<br>
Optimisation happens before linking.</p>



<a name="447319415"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447319415" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447319415">(Jun 26 2024 at 19:59)</a>:</h4>
<p>Also <a href="http://link.rs">link.rs</a> is not a linker</p>



<a name="447319446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447319446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447319446">(Jun 26 2024 at 19:59)</a>:</h4>
<p>Sorry, just to level set. I am an overly ambitious app developer (with a background mostly in web). Not a compiler dev.</p>



<a name="447319503"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447319503" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447319503">(Jun 26 2024 at 19:59)</a>:</h4>
<p>cool <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="447319668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447319668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447319668">(Jun 26 2024 at 20:00)</a>:</h4>
<p>most of the compiler devs here were overly ambitious app devs not that long ago. 2 years or so in my case.</p>



<a name="447320111"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447320111" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447320111">(Jun 26 2024 at 20:01)</a>:</h4>
<p>Sorry, the short replies there were just cos someone was interrupting me here in the real world!</p>



<a name="447320534"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447320534" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447320534">(Jun 26 2024 at 20:02)</a>:</h4>
<p>No worries! I am greatful for any feedback at all.</p>



<a name="447320726"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447320726" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447320726">(Jun 26 2024 at 20:03)</a>:</h4>
<p>So the <code>link.rs</code> file is part of a kind of ad-hoc build system. It makes shell commands to invoke linkers with various command line options.</p>



<a name="447323859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447323859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447323859">(Jun 26 2024 at 20:13)</a>:</h4>
<p>Ok, so lets take a step back. Under the build instructions <a href="https://www.roc-lang.org/examples/GoPlatform/README.html">here</a> I was confused about the "why" behind some of these things. My naive assumptions -&gt; the things confusing me are:</p>
<ol>
<li>The platform is entirely independent of the app using it. -&gt; This makes it confusing why <code>roc gen-stub-lib</code> and <code>roc build --lib main.roc --output platform/libapp.so</code> exist.</li>
<li>it is possible for the roc compiler to consume an independently built platform -&gt;  Prebuilt platforms require <code>.rh</code> and <code>.rm</code> files, but those require calling <code>roc preprocess-host main.roc</code> on an <code>app</code> module (which in turn references the platform you are trying to build those files for <span aria-label="dizzy" class="emoji emoji-1f635" role="img" title="dizzy">:dizzy:</span> )</li>
<li>host == the language a roc platform is built in, platform == the implementation of the roc platform api in a host language</li>
<li>When compiling an object is built for the roc app then "linked" via either the surgical or legacy linkers to the prebuilt platform</li>
<li>I am getting most of these steps from <a href="https://www.roc-lang.org/examples/GoPlatform/README.html">here</a> then trying to apply them to the couple wasm examples in the roc repo.</li>
</ol>



<a name="447340650"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447340650" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447340650">(Jun 26 2024 at 21:32)</a>:</h4>
<blockquote>
<ol>
<li>The platform is entirely independent of the app using it. -&gt; This makes it confusing whyÂ <code>roc gen-stub-lib</code>Â andÂ <code>roc build --lib main.roc --output platform/libapp.so</code>Â exist.</li>
</ol>
</blockquote>
<p>I think those two commands are creating what <a href="https://github.com/roc-lang/roc/tree/main/crates#building-a-roc-application">this diagram</a> calls the "app library" and "platform library".</p>
<blockquote>
<ol start="2">
<li>it is possible for the roc compiler to consume an independently built platform -&gt; Prebuilt platforms requireÂ <code>.rh</code>Â andÂ <code>.rm</code>Â files, but those require callingÂ <code>roc preprocess-host main.roc</code>Â on anÂ <code>app</code>Â module (which in turn references the platform you are trying to build those files forÂ <span aria-label="dizzy" class="emoji emoji-1f635" role="img" title="dizzy">:dizzy:</span>Â )</li>
</ol>
</blockquote>
<p>I think what's happening here is that you are building the platform with a dummy app that will later gets replaced with a real one. Definitely a bit roundabout, and that's because we are dealing with existing toolchains for other languages that we didn't create. They don't have command line arguments for the exact thing Roc wants to do, so we end up doing tricks like this. Most Roc app developers just download the prebuilt platform and never have to think about this weird stuff.</p>
<blockquote>
<ol start="3">
<li>host == the language a roc platform is built in, platform == the implementation of the roc platform api in a host language</li>
</ol>
</blockquote>
<p>platform = host + some Roc code on top to present a nice API to apps<br>
So no the platform is not just in a host language, it is a combination of host language and Roc.</p>
<blockquote>
<ol start="4">
<li>When compiling an object is built for the roc app then "linked" via either the surgical or legacy linkers to the prebuilt platform</li>
</ol>
</blockquote>
<p>Yep </p>
<blockquote>
<ol start="5">
<li>I am getting most of these steps fromÂ <a href="https://www.roc-lang.org/examples/GoPlatform/README.html">here</a>Â then trying to apply them to the couple wasm examples in the roc repo.</li>
</ol>
</blockquote>
<p>OK</p>



<a name="447340756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447340756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447340756">(Jun 26 2024 at 21:33)</a>:</h4>
<blockquote>
<p>The platform is entirely independent of the app using it. -&gt; This makes it confusing why roc gen-stub-lib and roc build --lib main.roc --output platform/libapp.so exist.</p>
</blockquote>
<p>We don't need gen-stub-lib anymore you can use <code>roc build --lib main.roc --output platform/libapp.so</code> instead, the plan is to remove it. See <a href="https://github.com/roc-lang/roc/pull/6696">#6696</a>. There is currently a bug in pre-process host that overwrites the dylib, and we want to change that API.</p>



<a name="447340945"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447340945" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447340945">(Jun 26 2024 at 21:34)</a>:</h4>
<p>I put together some slides to try and give an overview of platform development, you can find the thread <a href="#narrow/stream/303057-gatherings/topic/Roc.20Online.20Meetup.20May.202024/near/440575947">https://roc.zulipchat.com/#narrow/stream/303057-gatherings/topic/Roc.20Online.20Meetup.20May.202024/near/440575947</a></p>



<a name="447340987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447340987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447340987">(Jun 26 2024 at 21:35)</a>:</h4>
<p>WASM is a little special in some ways though.</p>



<a name="447341405"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447341405" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447341405">(Jun 26 2024 at 21:38)</a>:</h4>
<p>That <a href="https://www.roc-lang.org/examples/GoPlatform/README.html">https://www.roc-lang.org/examples/GoPlatform/README.html</a> example only shows how to build for surgical linking, which is not applicable for WASM -- and coupled closely with the current cli which we plan to change.</p>



<a name="447341437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447341437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447341437">(Jun 26 2024 at 21:38)</a>:</h4>
<p>So it is not going to be a helpful guide for what you are trying to do</p>



<a name="447341528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447341528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447341528">(Jun 26 2024 at 21:39)</a>:</h4>
<p>I would recommend you look at another platform like <a href="https://github.com/lukewilliamboswell/roc-platform-template-zig">https://github.com/lukewilliamboswell/roc-platform-template-zig</a> or <a href="https://github.com/lukewilliamboswell/roc-platform-template-wasi">https://github.com/lukewilliamboswell/roc-platform-template-wasi</a> or <a href="https://github.com/lukewilliamboswell/roc-platform-template-go">https://github.com/lukewilliamboswell/roc-platform-template-go</a></p>



<a name="447353087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447353087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447353087">(Jun 26 2024 at 23:12)</a>:</h4>
<p>Thank you both. Your comments have already been very helpful, and I still have a lot more reading to do! I get that it is still early in the project, and there are some hacks in place to use existing toolchains, but I think the work you all are doing here is really stellar. I would love to continue contributing. I will hapily take guidance If you have a good next issue for me to chew on given what we talked about today while I digest what you both have shared with me.</p>



<a name="447356758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447356758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ryan Barth <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447356758">(Jun 26 2024 at 23:33)</a>:</h4>
<p>Just saw you moved messages <span class="user-mention" data-user-id="515757">@Luke Boswell</span> </p>
<blockquote>
<p>In short the current status is that I am stuck on <a href="https://github.com/roc-lang/roc/pull/6808">https://github.com/roc-lang/roc/pull/6808</a>, specifically I don't have a great setup on linux so it's been slow to fix this, and I've gotten distracted by other things I can make progress on.</p>
</blockquote>
<p>My linux environment is all setup and ready to go, so this could be a good fit working towards enabling more independent platforms.</p>



<a name="447364685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20WASM/near/447364685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20WASM.html#447364685">(Jun 27 2024 at 00:52)</a>:</h4>
<p>Sounds great. I've been using that PR for refactor host in basic-cli to test it. They're kind of paired, so when the PRs are ready we can do a new release of both and not block anyone. If you can look into that I would appreciate it, let me know if you have any questions. <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> has provided a lot of guidance with that API change too. <span class="user-mention" data-user-id="361169">@Anton</span> has also done some investigation, but I haven't looked into that yet.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
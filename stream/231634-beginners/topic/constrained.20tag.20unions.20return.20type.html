<html>
<head><meta charset="utf-8"><title>constrained tag unions return type · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html">constrained tag unions return type</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="298121694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298121694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298121694">(Sep 10 2022 at 11:20)</a>:</h4>
<p>The tutorial (<a href="https://github.com/roc-lang/roc/blob/main/TUTORIAL.md#type-variables-in-tag-unions">https://github.com/roc-lang/roc/blob/main/TUTORIAL.md#type-variables-in-tag-unions</a>)  <br>
states that the compiler infers</p>
<div class="codehilite"><pre><span></span><code>example : [Foo Str, Bar Bool]a -&gt; [Foo Str, Bar Bool]a
</code></pre></div>
<p>from</p>
<div class="codehilite"><pre><span></span><code>example = \tag -&gt;
    when tag is
        Foo str -&gt; Bar (Str.isEmpty str)
        Bar _ -&gt; Bar False
        other -&gt; other
</code></pre></div>
<p>because</p>
<blockquote>
<p>The reason it has this type is the other -&gt; other branch. Take a look at that branch, and ask this question: "What is the type of other?" There has to be exactly one answer! It can't be the case that other has one type before the -&gt; and another type after it; whenever you see a named value in Roc, it is guaranteed to have the same type everywhere it appears in that scope.<br>
For this reason, any time you see a function that only runs a when on its only argument, and that when includes a branch like x -&gt; x or other -&gt; other, the function's argument type and return type must necessarily be equivalent.</p>
</blockquote>
<p>which does not make sense to me. I get that the type variables <code>a</code> need to have the same type because of the <code>other -&gt; other</code>.  But can't <code>other</code> be anything except <code>[Foo Str, Bar Bool]</code> (as those cases are matched already anyway)? Resulting in parts before the <code>a</code> not having to be the same and ultimately inferring <code>[Foo Str, Bar *]a -&gt; [Bar Bool]a</code> which coincides with the actual possible values as well?</p>



<a name="298143074"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298143074" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298143074">(Sep 10 2022 at 14:24)</a>:</h4>
<p>I think you are correct and that is a typo or mixed up example</p>



<a name="298143093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298143093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298143093">(Sep 10 2022 at 14:25)</a>:</h4>
<p>But i am not an expert on the type unification</p>



<a name="298143171"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298143171" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298143171">(Sep 10 2022 at 14:25)</a>:</h4>
<p>Though it may be the case that unions share the same namespace, thus those two unify giving the same input and output type.</p>



<a name="298145992"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298145992" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298145992">(Sep 10 2022 at 14:49)</a>:</h4>
<p>You are correct in a sense, but the model of unification that Roc uses doesn't permit the minimal inferred type you suggest. One perspective of types, which Roc uses heavily, is that they determine the layout in memory of a value, and that's what's causing the inferred <code>[Foo Str, Bar Bool]a -&gt; [Foo Str, Bar Bool]a</code> here. Let's say I pass another tag into this function, say <code>C</code>. Then on the left-hand side, when matching, we have that the value of C needs the memory layout of <code>[Foo Str, Bar Bool, C]</code>. Since <code>C</code> will enter the default <code>other -&gt; other</code> branch, and undergoes no transformation, it must have type (and corresponding layout) <code>[Foo Str, Bar Bool, C]</code> on the right-hand side as well. So that is why the unification rules force the right-hand type to include <code>Foo</code>, even when in principle it doesn't look like it needs to.</p>
<p>Now, it is possible to reduce the type here to get the minimal one you suggest. But that requires flow typing and implicit conversions (i.e. you will need to modify the value of <code>other</code>, you can't return it as-is). Those ideas haven't been considered</p>



<a name="298158665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298158665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298158665">(Sep 10 2022 at 16:51)</a>:</h4>
<p>If I were to have the following function with a user provided type like so:</p>
<div class="codehilite"><pre><span></span><code>paintRedBlue: [Red, Blue] -&gt; [Blue]
paintRedBlue= \paint -&gt; when paint is
    Red -&gt; Blue
    other -&gt; other
</code></pre></div>
<p>The argument of course <em>could</em> be any additional type, but let's stick to <code>[Red, Blue]</code> for the sake of argument.<br>
If this function is called with <code>Blue</code>, it will go into the <code>other</code> arm just like the example above. Will this be a runtime memory issue as well (as the memory layout includes <code>Red</code>), or does the problem purely come from the compiler generated type?</p>



<a name="298159585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298159585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298159585">(Sep 10 2022 at 17:02)</a>:</h4>
<div class="codehilite"><pre><span></span><code>── TYPE MISMATCH ───────────────────────────────────────────────────────────────

Something is off with the body of the paintRedBlue definition:

4│       paintRedBlue: [Red, Blue] -&gt; [Blue]
5│       paintRedBlue= \paint -&gt;
6│&gt;          when paint is
7│&gt;              Red -&gt; Blue
8│&gt;              other -&gt; other

This when expression produces:

    [Blue, Red]

But the type annotation on paintRedBlue says it should be:

    [Blue]

Tip: Looks like a closed tag union does not have the Red tag.

Tip: Closed tag unions can&#39;t grow, because that might change the size
in memory. Can you use an open tag union?
</code></pre></div>



<a name="298159616"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298159616" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298159616">(Sep 10 2022 at 17:02)</a>:</h4>
<p>That is the current error, just for reference.</p>



<a name="298159649"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298159649" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298159649">(Sep 10 2022 at 17:03)</a>:</h4>
<p>Works fine without the type annotation of course.</p>



<a name="298159768"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298159768" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298159768">(Sep 10 2022 at 17:04)</a>:</h4>
<p>This does work, interestingly:</p>
<div class="codehilite"><pre><span></span><code>» paintRedBlue: [Red, Blue] -&gt; [Blue]
… paintRedBlue= \paint -&gt;
…     when paint is
…         Red -&gt; Blue
…         Blue -&gt; Blue
…
… paintRedBlue Red

Blue : [Blue]
</code></pre></div>



<a name="298159817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298159817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298159817">(Sep 10 2022 at 17:05)</a>:</h4>
<p>I guess it splits the types into two different unification with relayout, but when using a variable the types must be linked.</p>



<a name="298160312"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298160312" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298160312">(Sep 10 2022 at 17:10)</a>:</h4>
<p>I guess with the first example, we would have to deal with removing types from unions as they match to make it unify correctly. <code>other</code> is of type <code>[Red, Blue]</code>. Thus the output must be of type <code>[Red, Blue]</code>. Technically speaking, we could recognize that <code>Red</code> was already covered and view <code>other</code> as just <code>[Blue]</code>.</p>
<p>This is similar to gradual typing in Typescript, where if you check for null, the possibility of null will be removed from a type and you can then use it as if null is not part of the type.</p>



<a name="298160358"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298160358" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298160358">(Sep 10 2022 at 17:10)</a>:</h4>
<p>That would then unify to the working function.</p>



<a name="298160492"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298160492" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298160492">(Sep 10 2022 at 17:12)</a>:</h4>
<p>But if we view <code>other</code> as just <code>[Blue]</code>, we would assume the wrong layout for it and would definitely need to explicitly codify the relayout that happens when converting from <code>[Red,Blue]</code> to <code>[Blue]</code></p>



<a name="298163049"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298163049" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298163049">(Sep 10 2022 at 17:39)</a>:</h4>
<p>From my point of view such gradual typing makes a lot of sense. I assume it would work the same way for constrained type unions, relieving the restriction that the result and return type have to be the same when it can be seen they won't be the same. Implicit conversion on the other hand seems like a "dirty" way of modifying what is essentially an identity function to update the types.</p>



<a name="298163697"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298163697" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298163697">(Sep 10 2022 at 17:47)</a>:</h4>
<p>Also, the implicit conversion is a cost. Not sure how bad it could get, but it might involve copying around a decent bit of data in a complex tag with data stored inside of it instead of just being an enumeration.</p>



<a name="298167282"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298167282" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298167282">(Sep 10 2022 at 18:29)</a>:</h4>
<p>Yeah, the implicit conversion would be an implicit runtime conversion. That cost might be zero, but it might not be zero - and in general we should not assume it will be free. In the examples where you have a closed tag union, everything works out okay because the values you build up on the right hand side are not the values you've built up on the left hand sides of your <code>when</code> cases.</p>



<a name="298167459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298167459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298167459">(Sep 10 2022 at 18:31)</a>:</h4>
<p>That also means though if you do something like</p>
<div class="codehilite"><pre><span></span><code>paintRedBlue: [Red, Blue] -&gt; _
paintRedBlue= \paint -&gt;
    when paint is
        Red -&gt; paint
        Blue -&gt; Red
</code></pre></div>
<p>the inferred type here is <code>[Red, Blue] -&gt; [Red, Blue]</code> even though we "know" that only <code>[Red]</code> will ever be returned - and for the same reason, because if we inferred <code>[Red]</code>, we would have to do an implicit conversion at runtime for the value of <code>paint</code> returned in <code>Red -&gt; paint</code>. And in that case, the runtime conversion would not be zero-cost!</p>



<a name="298168043"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298168043" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298168043">(Sep 10 2022 at 18:38)</a>:</h4>
<p>Nice example, I think it would be acceptable in such a scenario for the user to "convince" the compiler of <code>paint</code> being red in the upper arm by simply replacing <code>paint</code> with <code>Red</code>. But perhaps there is a scenario where there is no way for the user to convince the compiler of a narrower type, but using <code>when ... is</code> I cannot think of one.</p>



<a name="298171093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298171093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298171093">(Sep 10 2022 at 19:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="454654">Ayaz Hafiz</span> <a href="#narrow/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type/near/298145992">said</a>:</p>
<blockquote>
<p>Now, it is possible to reduce the type here to get the minimal one you suggest. But that requires flow typing</p>
</blockquote>
<p>flow typing (that is, where a type can be different inside the branches of a conditional than it was outside the conditional - such as a type losing its nullability inside an <code>if (x != null) { ... }</code> branch in TypeScript) also increases compile times</p>



<a name="298171268"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298171268" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298171268">(Sep 10 2022 at 19:20)</a>:</h4>
<p>so far we haven't seen any concrete use cases where this would be a significant benefit to real-world programs (although I can vaguely imagine it being useful if you want to partially handle some errors in a tag union of different errors...but, critically, I haven't seen any real Roc programs that want to try to do that yet), and I don't think it would be a great tradeoff to make the compiler slower for every Roc program essentially to make a certain niche of types less surprising but not significantly more useful</p>



<a name="298171324"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298171324" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298171324">(Sep 10 2022 at 19:21)</a>:</h4>
<p>then again, a counterpoint I'm open to is that some of the ways type inference of tag unions work is among the most surprising aspects of the language, so maybe if the compilation time cost can be made small enough, it might be worth it anyway!</p>



<a name="298171756"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298171756" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298171756">(Sep 10 2022 at 19:27)</a>:</h4>
<p>(to be fair, type inference and checking for arbitrary union types, including tag unions in the style of flow typing, can be made very fast, ie linear or near-linear with certain techniques like binary decision trees)</p>



<a name="298171923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298171923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298171923">(Sep 10 2022 at 19:29)</a>:</h4>
<p>there was a previous ideas thread about this kind of thing at <a href="#narrow/stream/304641-ideas/topic/Narrowing.20types.20in.20when.20expressions">https://roc.zulipchat.com/#narrow/stream/304641-ideas/topic/Narrowing.20types.20in.20when.20expressions</a> but it didn’t go anywhere</p>



<a name="298172234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298172234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298172234">(Sep 10 2022 at 19:33)</a>:</h4>
<p>oh yeah, I forgot about that!</p>



<a name="298172309"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298172309" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298172309">(Sep 10 2022 at 19:34)</a>:</h4>
<p>yeah if the impact on type-checking time would be insignificant in practice, I could definitely see it being worth it <span aria-label="thumbs up" class="emoji emoji-1f44d" role="img" title="thumbs up">:thumbs_up:</span></p>



<a name="298172361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298172361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298172361">(Sep 10 2022 at 19:35)</a>:</h4>
<p>the impact on runtime could not be insignificant, in some cases, due to the required conversions, so that’s a consideration too!</p>



<a name="298172428"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298172428" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298172428">(Sep 10 2022 at 19:36)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type/near/298171268">said</a>:</p>
<p>Perhaps this is an example for the partial error handling you mentioned:</p>
<div class="codehilite"><pre><span></span><code>removeNoncritical : List([LintingError, CompileError, FormattingError]) -&gt; List([CompileError])
removeNoncritical = \errors -&gt; List.walk errors [] \state, error -&gt;
    when error is
        LintingError | FormattingError -&gt; state
        criticalError -&gt; List.append state criticalError
</code></pre></div>



<a name="298198206"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298198206" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298198206">(Sep 11 2022 at 03:12)</a>:</h4>
<p>Could this alternative implementation of that example also receive such a minimal inferred return type of <code>List [CompileError]</code>?</p>
<div class="codehilite"><pre><span></span><code>removeNoncritical = \errors -&gt; List.keepIf errors \error -&gt;
    when error is
        LintingError | FormattingError -&gt; False
        _ -&gt; True
</code></pre></div>
<p>Or would app developers sometimes need to write with flow typing in mind (verbosely hold the compiler's hand) to reap the full benefits of a flow typing system?</p>



<a name="298208315"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/298208315" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> J.Teeuwissen <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#298208315">(Sep 11 2022 at 06:15)</a>:</h4>
<p>At least in Haskell such an example would not work. Take <code>catMaybes</code> for example:</p>
<div class="codehilite"><pre><span></span><code>catMaybes :: [Maybe a] -&gt; [a]
catMaybes = mapMaybe id

mapMaybe          :: (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
mapMaybe _ []     = []
mapMaybe f (x:xs) =
 let rs = mapMaybe f xs in
 case f x of
  Nothing -&gt; rs
  Just r  -&gt; r:rs
</code></pre></div>
<p>The only reason <code>catMaybes</code> works is because mapMaybe actually determines what items will go in the list. A different implementation (like yours) using e.g. a filter function wouldn't tell the compiler enough due to losing gained type information when inside the filter function after returning the boolean.</p>



<a name="403581737"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403581737" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403581737">(Nov 22 2023 at 12:24)</a>:</h4>
<p>I suspect I'm hitting some similar confusion. For me, this code has no error:</p>
<div class="codehilite"><pre><span></span><code>colorToRgb : Color a -&gt; Result [Rgb (Point3 a)] [KeyNotFound]
colorToRgb = \color -&gt;
    when color is
        Rgb rgb -&gt; Ok (Rgb rgb)
        Hsv hsv -&gt; Ok (Rgb (hsvToRgb hsv))
        NamedColor name -&gt; Dict.get namedColors name
</code></pre></div>
<p>But this code fails:</p>
<div class="codehilite"><pre><span></span><code>colorToRgb : Color a -&gt; Result [Rgb (Point3 a)] [KeyNotFound]
colorToRgb = \color -&gt;
    when color is
        Rgb rgb -&gt; Ok (Rgb rgb)
        Hsv hsv -&gt; Ok (Rgb (hsvToRgb hsv))
        _ -&gt; KeyNotFound
</code></pre></div>
<p>With this error:</p>
<div class="codehilite"><pre><span></span><code>This when expression produces:

    [
        KeyNotFound,
        Ok [Rgb (Point3 a)],
    ]

But the type annotation on colorToRgb says it should be:

    Result [Rgb (Point3 a)] [KeyNotFound]a
</code></pre></div>
<p>I actually want the former code, but I was trying to diagnose a similar issue elsewhere in the code when I hit this, and this one seems easier to explain. I really don't understand what the issue is. The type annotation <em>doesn't</em> say <code>[KeyNotFound]a</code></p>



<a name="403582274"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403582274" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403582274">(Nov 22 2023 at 12:28)</a>:</h4>
<p>I think <code>_ -&gt; KeyNotFound</code> needs to be <code>_ -&gt; Err KeyNotFound</code>.</p>



<a name="403582325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403582325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403582325">(Nov 22 2023 at 12:28)</a>:</h4>
<p>To return a Result instead of just KeyNotFound</p>



<a name="403582346"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403582346" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403582346">(Nov 22 2023 at 12:28)</a>:</h4>
<p>I can see how the <code>a</code> can be distracting though</p>



<a name="403582705"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403582705" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403582705">(Nov 22 2023 at 12:30)</a>:</h4>
<p>The type definition of Result may also help clear things up:</p>
<div class="codehilite"><pre><span></span><code>Result ok err : [Ok ok, Err err]
</code></pre></div>



<a name="403616994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403616994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403616994">(Nov 22 2023 at 15:35)</a>:</h4>
<p>Thanks for the pointer! Yeah, I understand how result works. I was just overlooking the missing Err, and yeah, the error message was misleading in this case.</p>



<a name="403618546"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403618546" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403618546">(Nov 22 2023 at 15:43)</a>:</h4>
<p>I guess I haven't resolved my deeper error, though, and I wonder if I'm just overlooking things again. Here's some of the code:</p>
<div class="codehilite"><pre><span></span><code>Point3 a : (Frac a, Frac a, Frac a)

Color a : [
    Hsv (Point3 a),
    Rgb (Point3 a),
    NamedColor Str,
]

# namedColors : Dict Str [Rgb (Point3 a)]
namedColors =
    Dict.empty {}
    |&gt; Dict.insert &quot;red&quot; (Rgb (1, 0, 0))
    |&gt; Dict.insert &quot;yellow&quot; (Rgb (1, 1, 0))
    |&gt; Dict.insert &quot;blue&quot; (Rgb (0, 0, 1))

colorToRgb : Color a -&gt; Result [Rgb (Point3 a)] [KeyNotFound]
colorToRgb = \color -&gt;
    when color is
        Rgb rgb -&gt; Ok (Rgb rgb)
        Hsv hsv -&gt; Ok (Rgb (hsvToRgb hsv))
        NamedColor name -&gt; Dict.get namedColors name
</code></pre></div>
<p>No errors here, but if I uncomment <code># namedColors : Dict Str [Rgb (Point3 a)]</code>, I get this error:</p>
<div class="codehilite"><pre><span></span><code>Something is off with the 3rd branch of this when expression:

37│   colorToRgb : Color a -&gt; Result [Rgb (Point3 a)] [KeyNotFound]
38│   colorToRgb = \color -&gt;
39│&gt;      when color is
40│&gt;          Rgb rgb -&gt; Ok (Rgb rgb)
41│&gt;          Hsv hsv -&gt; Ok (Rgb (hsvToRgb hsv))
42│&gt;          NamedColor name -&gt; Dict.get namedColors name

This get call produces:

    Result [Rgb (
        Frac a,
        Frac a,
        Frac a,
    )b] [KeyNotFound]

But the type annotation on colorToRgb says it should be:

    [
        Err [KeyNotFound],
        Ok [Rgb (Point3 a)],
    ]
</code></pre></div>
<p>I thought it was the trailing <code>b</code>, but now I suspect that's misleading.</p>



<a name="403624591"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403624591" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403624591">(Nov 22 2023 at 16:13)</a>:</h4>
<p>Try this</p>
<div class="codehilite"><pre><span></span><code>namedColors : {} -&gt; Dict Str [Rgb (Point3 a)]
namedColors = \{} -&gt;
    Dict.empty {}
    |&gt; Dict.insert &quot;red&quot; (Rgb (1, 0, 0))
    |&gt; Dict.insert &quot;yellow&quot; (Rgb (1, 1, 0))
    |&gt; Dict.insert &quot;blue&quot; (Rgb (0, 0, 1))

colorToRgb : Color a -&gt; Result [Rgb (Point3 a)] [KeyNotFound]
colorToRgb = \color -&gt;
    when color is
        Rgb rgb -&gt; Ok (Rgb rgb)
        Hsv hsv -&gt; Ok (Rgb (hsvToRgb hsv))
        NamedColor name -&gt; Dict.get (namedColors {}) name
</code></pre></div>



<a name="403624735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403624735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403624735">(Nov 22 2023 at 16:14)</a>:</h4>
<p>I think if you want <code>namedColors</code> to be a constant value then you need to concretize the types, you can't leave it as <code>Point3 a</code></p>



<a name="403624976"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403624976" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403624976">(Nov 22 2023 at 16:16)</a>:</h4>
<p>I think the trailing <code>b</code> is to indicate that within the structural typing system roc uses we can't know if the <code>Point3 a</code> returned by <code>namedColors</code> is the same <code>Point3 a</code> returned by <code>colorToRgb</code></p>



<a name="403625137"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403625137" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403625137">(Nov 22 2023 at 16:17)</a>:</h4>
<p>This is also why <code>Dict.empty</code> is a function and not a constant, I think</p>



<a name="403625508"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403625508" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403625508">(Nov 22 2023 at 16:19)</a>:</h4>
<p>yeah this is a limitation today, but <span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span>  has an idea of how to make it Just Work in certain cases (including this one)</p>



<a name="403639818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403639818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403639818">(Nov 22 2023 at 17:50)</a>:</h4>
<p>Thanks, y'all! Typing works with those changes. Some questions:</p>
<ul>
<li>I don't suppose it memoizes namedColors when it's a function?</li>
<li>How would I figure out the inferred type for something in source? I know how to do that in the repl, but multiline things don't seem to work in the repl.</li>
<li>How would I "concretize the types"?</li>
</ul>
<p>Meanwhile, my apologies if there are things in docs that I've missed.</p>



<a name="403644544"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403644544" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403644544">(Nov 22 2023 at 18:24)</a>:</h4>
<p>Memoize -&gt; not currently, we want to in the future.</p>



<a name="403644681"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403644681" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403644681">(Nov 22 2023 at 18:26)</a>:</h4>
<p>Language server might be able to help with getting the type of something. Otherwise you should be able to do <code>x : _</code> and roc should tell you the type of <code>_</code> if I recall correctly. I guess you could also just specify a wrong type and see what type roc says.</p>



<a name="403644843"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403644843" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403644843">(Nov 22 2023 at 18:26)</a>:</h4>
<p>Not sure exactly what the last question is asking, maybe someone else can help.</p>



<a name="403645087"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403645087" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403645087">(Nov 22 2023 at 18:28)</a>:</h4>
<p>by concretize I meant use a concrete type instead of a type variable. So <code>namedColors : Dict Str [Rgb (Point3 Dec)]</code></p>



<a name="403645252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403645252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403645252">(Nov 22 2023 at 18:29)</a>:</h4>
<p>Now you're locked in to a decimal representation of <code>Point3</code>, which will need to bubble up to <code>colorToRgb : Color Dec -&gt; Result [Rgb (Point3 Dec)] [KeyNotFound]</code> as well</p>



<a name="403645597"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403645597" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Elias Mulhall <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403645597">(Nov 22 2023 at 18:31)</a>:</h4>
<p>At that pint you might as well just define <code>Point3</code> with <code>Dec</code>, which might be an ok simplification</p>



<a name="403647619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403647619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403647619">(Nov 22 2023 at 18:46)</a>:</h4>
<p>Thanks for all the replies, y'all! I haven't tried out the langserver. I guess I need to dig up how to do that. Saying just <code>_</code> doesn't turn up the answer for me, or maybe I'm just doing a bad job reading output. And I had been a bit fuzzy on some of the number details. Thanks for clarifying the concretize thing. That does seem to fix the issue as an alternative to making namedColors a function.</p>



<a name="403647922"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403647922" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403647922">(Nov 22 2023 at 18:49)</a>:</h4>
<p>Beyond that, my code still fails <a href="https://github.com/roc-lang/roc/issues/3513">because Num functions aren't finished</a>, but not much I can do with that for now. (No time to dig up contributing that at the moment.) Thanks for all the help, y'all! And looking forward to some kind of memoization and also just the typing improvement in the future!</p>



<a name="403648458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403648458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403648458">(Nov 22 2023 at 18:52)</a>:</h4>
<p>That shouldn't be a problem for <code>roc ...</code> that doesn't use the dev backend.</p>



<a name="403648506"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403648506" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403648506">(Nov 22 2023 at 18:53)</a>:</h4>
<p>only the <code>repl</code> uses the dev backend currently or run with <code>--dev</code></p>



<a name="403655505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403655505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403655505">(Nov 22 2023 at 19:43)</a>:</h4>
<div class="codehilite"><pre><span></span><code>$ roc run hsv.roc
...
thread &#39;main&#39; panicked at &#39;Undefined Symbol in relocation, (+762, Relocation { kind: PltRelative, encoding: Generic, size: +20, target: Symbol(SymbolIndex(+ae)), addend: +fffffffffffffffc, implicit_addend: false }): Ok(Symbol { name: &quot;floorf&quot;, address: +0, size: +0, kind: Label, section: Undefined, scope: Unknown, weak: false, flags: Elf { st_info: +10, st_other: +0 } })&#39;, crates/linker/src/elf.rs:1486:25
...
</code></pre></div>
<p>I guess this must be a different problem than the issue then.</p>



<a name="403655882"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403655882" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403655882">(Nov 22 2023 at 19:46)</a>:</h4>
<p>And that's for F32. With Dec, I get this:</p>
<div class="codehilite"><pre><span></span><code>...
thread &#39;main&#39; panicked at &#39;internal error: entered unreachable code: Unrecognized dec unary operation: NumFloor&#39;, crates/compiler/gen_llvm/src/llvm/lowlevel.rs:2318:13
...
</code></pre></div>



<a name="403660463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403660463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403660463">(Nov 22 2023 at 20:23)</a>:</h4>
<p>Ugh...how did I miss that.</p>
<p>So Dec, probably is actually just missing the op. For float, that symbol should be embedded in the builtins but I missed it. Try the first sample with <code>--linker=legacy</code></p>



<a name="403670279"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/constrained%20tag%20unions%20return%20type/near/403670279" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/constrained.20tag.20unions.20return.20type.html#403670279">(Nov 22 2023 at 21:52)</a>:</h4>
<p>It compiles for F32 with <code>--linker=legacy</code>. Thanks!</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
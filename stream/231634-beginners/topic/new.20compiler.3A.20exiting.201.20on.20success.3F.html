<html>
<head><meta charset="utf-8"><title>new compiler: exiting 1 on success? ¬∑ beginners ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html">new compiler: exiting 1 on success?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="571175016"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571175016" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rick Hull <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571175016">(Jan 31 2026 at 08:14)</a>:</h4>
<p>This one is odd; I am working on the Sexp2 module and noticed this behavior, only in this specific case, after whittling down to minimal test case:</p>
<div class="codehilite"><pre><span></span><code>rwh@ht seatzero (master *)$ roc spike/test_sexp2.roc; echo $?
dbg: [&lt;tag_union variant=3&gt;, &lt;tag_union variant=2&gt;, &lt;tag_union variant=2&gt;, &lt;tag_union variant=2&gt;, &lt;tag_union variant=1&gt;]
dbg: [&quot;(&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;)&quot;]
Sexp2 runtime harness reached
1
rwh@ht seatzero (master *)$ cat spike/test_sexp2.roc
app [main!] { pf: platform &quot;../../basic-cli/platform/main.roc&quot; }

import pf.Stdout
import Sexp2

main! = |_args| {
    tokens = Sexp2.tokenize(&quot;(1 2 3)&quot;)
    dbg tokens
    names = Sexp2.token_names(tokens)
    dbg names

    expect Bool.True

    Stdout.line!(&quot;Sexp2 runtime harness reached&quot;)
    Ok({})
}
</code></pre></div>



<a name="571175703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571175703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571175703">(Jan 31 2026 at 08:26)</a>:</h4>
<p><del>What if your use <code>Str.inspect</code> on the tokens?</del> nvm I'm pretty sure it's using that under the hood</p>



<a name="571175802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571175802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571175802">(Jan 31 2026 at 08:27)</a>:</h4>
<p><del>If you implement a <code>to_str : Secp2 -&gt; Str</code> method does that change anything?</del> it's called <code>to_inspect</code></p>



<a name="571175839"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571175839" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571175839">(Jan 31 2026 at 08:28)</a>:</h4>
<p>I vaguely recall an idea that inspect basically desugars to that method under the hood, but I can't remember</p>



<a name="571176006"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571176006" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rick Hull <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571176006">(Jan 31 2026 at 08:30)</a>:</h4>
<p>note, this is Sexp (as in s-expression).  let me investigate that, though i've moved on from this curiousity</p>



<a name="571176175"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571176175" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rick Hull <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571176175">(Jan 31 2026 at 08:32)</a>:</h4>
<p>In the meantime, not related to this curiosity, i have:</p>
<blockquote>
<p>The stack overflow you saw when running roc test --verbose spike/Sexp3.roc (after the<br>
  added equality-based expect cases) wasn‚Äôt caused by a logic mistake in the Sexp parser<br>
  itself‚Äîit was the Roc compiler hitting a stack overflow while evaluating those expect<br>
  expressions. The crash message explicitly says the compiler overflowed its stack, which<br>
  matches the behavior we observed when we defined is_eq methods and tried to compare<br>
  Token/Value instances with ==. Removing those comparisons (and instead comparing the<br>
  formatted string or the token names) lets roc test complete successfully, so the parser<br>
  never ‚Äúran away‚Äù at runtime. In short: the compiler‚Äôs expect evaluation blew up when<br>
  trying to derive equality for those custom types, so it‚Äôs a compiler bug triggered by<br>
  that pattern, not a user error.</p>
</blockquote>



<a name="571176226"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571176226" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rick Hull <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571176226">(Jan 31 2026 at 08:33)</a>:</h4>
<p>i can pause on this and try to make a minimal repro, but I want to try your to_str trick first</p>



<a name="571176521"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571176521" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571176521">(Jan 31 2026 at 08:36)</a>:</h4>
<h2>test/fx/inspect_custom_test.roc</h2>
<div class="codehilite"><pre><span></span><code>app [main!] { pf: platform &quot;./platform/main.roc&quot; }

import pf.Stdout

# Define an opaque type with a custom to_inspect method
Color := [Red, Green, Blue].{
    to_inspect : Color -&gt; Str
    to_inspect = |color| match color {
        Red =&gt; &quot;Color::Red&quot;
        Green =&gt; &quot;Color::Green&quot;
        Blue =&gt; &quot;Color::Blue&quot;
    }
}

main! = || {
    red : Color
    red = Red

    # Test Str.inspect with custom to_inspect method
    result = Str.inspect(red)
    Stdout.line!(result)

    # Compare with what the default would be
    Stdout.line!(&quot;Expected: Color::Red&quot;)
}
</code></pre></div>



<a name="571176688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571176688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571176688">(Jan 31 2026 at 08:38)</a>:</h4>
<p>Yeah -- consider <code>roc test</code> somewhat broken... if it works <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span>  but it clearly needs some love</p>



<a name="571177198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571177198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rick Hull <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571177198">(Jan 31 2026 at 08:45)</a>:</h4>
<p>here is the strace for exiting 1 on success: <a href="https://gist.github.com/rickhull/4247a1dddbc40069ad7f853a47bcb552">https://gist.github.com/rickhull/4247a1dddbc40069ad7f853a47bcb552</a></p>



<a name="571177348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571177348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Rick Hull <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571177348">(Jan 31 2026 at 08:47)</a>:</h4>
<p>it's too late for me now, but I'm not sure about your inspect test; in this case, I am executing with <code>roc</code> and not <code>roc test</code>, and in the strace gist, this is after <code>roc build</code></p>
<p>gpt-codex-mini says:</p>
<blockquote>
<p>The strace capture settles it: the binary prints all the dbg/Stdout lines you care about<br>
  and then ends with exit_group(1) ‚Äî there‚Äôs no panic, crash, or expect failure at<br>
  runtime, so it‚Äôs literally choosing to return status 1. That‚Äôs exactly what roc does for<br>
  these little test harnesses when you run them with roc spike/... instead of roc test<br>
  spike/...: the compiler builds a dedicated test binary and the runtime intentionally<br>
  exits 1 (even on success) because it wasn‚Äôt invoked through the roc test driver that<br>
  reports expect results. In short, the harness is behaving as designed ‚Äî it‚Äôs not a logic<br>
  bug in your code, it‚Äôs the way Roc signals ‚Äúdon‚Äôt treat this as a normal runnable app;<br>
  use roc test so the expect blocks run and report success.‚Äù</p>
</blockquote>



<a name="571179056"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571179056" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571179056">(Jan 31 2026 at 09:08)</a>:</h4>
<p>Ah yeah, by default a program with a <code>dbg</code> in it returns a non-zero exit code</p>



<a name="571179787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571179787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571179787">(Jan 31 2026 at 09:17)</a>:</h4>
<p>Actually I might be getting confused there... </p>
<p>Here's an older discussion <a class="message-link" href="/#narrow/channel/304902-show-and-tell/topic/draft.20blog.20post.20about.20purity.20inference/near/492619780">#show and tell &gt; draft blog post about purity inference @ üí¨</a> -- Richard proposed adding a <code>--release</code> flag that would throw a non-zero code if there were any <code>dbg</code>'s</p>



<a name="571179836"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/new%20compiler%3A%20exiting%201%20on%20success%3F/near/571179836" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/new.20compiler.3A.20exiting.201.20on.20success.3F.html#571179836">(Jan 31 2026 at 09:17)</a>:</h4>
<p>Need to look into that and document it somewhere I guess</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
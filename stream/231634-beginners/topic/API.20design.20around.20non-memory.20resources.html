<html>
<head><meta charset="utf-8"><title>API design around non-memory resources · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html">API design around non-memory resources</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="406002284"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406002284" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Asier Elorz (he/him) <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406002284">(Dec 05 2023 at 08:31)</a>:</h4>
<p>Let's say I'm designing an API for a platform, and my platform offers access to the file system. Most commonly, we would have two functions:</p>
<div class="codehilite"><pre><span></span><code>readFile : Path -&gt; Task (List U8) FileError
writeFile : Path, List U8 -&gt; Task {} FileError
</code></pre></div>
<p>This is great. It is safe, easy and enough for many users.</p>
<p>However, there are use cases when it is not enough. A file may be too big to fit into memory. Or it may be a zip or other kind of archive, and I just want to read the index and maybe parts of the content depending on what the index says, or I may want to patch a few bytes from a very big file without having to load it all to memory, write to it in memory and then write back everything again, which would be very wasteful.</p>
<p>These sort of things are usually achieved through APIs like <code>fopen</code> in the C standard library, where you get a file handle, you work on that file handle and then you free it (<code>fclose</code>) when you are done. This lets the programmer do much more granular operations on a file than a path based API, but also poses a new problem: the file handle needs to be freed when it is not used anymore.</p>
<p>Languages like C++ and Rust solve this by encapsulating the resource in a class with a destructor or <code>Drop</code> trait that will automatically run cleanup code when the object goes out of scope. Roc manages memory automatically, but as far as I know (please do correct me if I am wrong) doesn't let the user write arbitrary cleanup procedures.</p>
<p>Which takes me back to the original question. What would be the idiomatic way of designing an API in Roc for such a task? I would very strongly prefer if manual <code>fclose</code> was not the answer, because it is very error prone, and because statically ensuring no leaks is a solved problem since Bjarne Stroustrup made C with classes in 1980, so Roc should be able to be at least as good.</p>
<p>The best I can think for now is a function that takes another function as a parameter, and this inner function is the only one that will ever have access to the file handle. This way we can open the file, call the user function, close the file, and the handle is never risked to be leaked. This is a common pattern in some Rust APIs, such as <code>std::thread::scope</code>, where the thread scope object is only exposed within the user's callback function and never leaks outside.</p>
<p>So the signature would be something like:</p>
<div class="codehilite"><pre><span></span><code>openFile : Path, (FileHandle -&gt; Task a e) -&gt; Task a e
</code></pre></div>
<p>This would sort of work, I think, but I am not sure that this is the ideal solution.</p>
<p>I am very interested in what you all think about how you would design such an API.</p>



<a name="406010787"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406010787" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406010787">(Dec 05 2023 at 09:21)</a>:</h4>
<p>I feel like I've seen a proposal somewhere that has streams in it as an example for a platform agnostic low level API. The idea being package authors can build on top on stream operations as the primitive. I'll dig and see what I can find.</p>



<a name="406011846"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406011846" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406011846">(Dec 05 2023 at 09:26)</a>:</h4>
<p>There is an example in <a href="https://docs.google.com/document/d/110MwQi7Dpo1Y69ECFXyyvDWzF4OYv1BLojIm08qDTvg/edit?usp=drivesdk">Module Params proposal</a> that includes something similar in the Sandboxing and polyfill section.</p>



<a name="406012475"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406012475" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406012475">(Dec 05 2023 at 09:30)</a>:</h4>
<p>I think the <a href="https://github.com/WebAssembly/wasi-filesystem/blob/main/wit/types.wit">WASI filesystem</a> design is very similar API and could be implemented in Roc without any issues.</p>



<a name="406013002"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406013002" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406013002">(Dec 05 2023 at 09:33)</a>:</h4>
<p>The file descriptor can be an Opaque type, and I guess the platform could handle automatically cleaning things up.</p>



<a name="406016645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406016645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406016645">(Dec 05 2023 at 09:53)</a>:</h4>
<p>I guess another key aspect to this is the effect inerpreter. My lay man's understanding is the host builds a runtime that executes the task or effect descriptions from Roc. This part of the platforms host would be responsible for managing the resources like file descriptors, which I imagine could be represented by an index into a list of handles in the host, and in Roc application is just an Opaque type, so the app never accesses the raw file descriptor. Instead the app creates a Task passes the descriptor back to the platform which in turn unwraps the index and returns that to the host. You could provide a Task to close a file which would destroy a handle, and I imagine any future Tasks like read or write would fail. </p>
<p>My apologies if I've butchered this description.</p>



<a name="406040585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406040585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> joshi <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406040585">(Dec 05 2023 at 11:58)</a>:</h4>
<p>I like <code>openFile : Str, (Handle -&gt; Task a b) -&gt; Task  a b</code> as a design, and I think it might fit roc quite well, since you could use backpassing:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="n">fd</span> <span class="o">&lt;-</span> <span class="n">openFile</span> <span class="s2">"archive.zip"</span>
<span class="n">entries</span> <span class="o">&lt;-</span> <span class="n">readZipDictionary</span> <span class="n">fd</span> <span class="o">|&gt;</span> <span class="n">Task</span><span class="o">.</span><span class="k">await</span>
<span class="c1"># ...</span>
<span class="c1"># file automatically closed at the end of this scope</span>
</code></pre></div>
<p>The platform can automatically close the file when the callback returns, and check that its refcount at that point is 0, so the user didn't try to make the <code>fd</code> escape. Ocaml has (proposed) uniqueness annotations for those kinds of things, but I think roc can do that without any type-level magic! I don't know how hard it is to keep track of those things inside of the Tasks though, especially if <code>Task</code> becomes a built-in type</p>



<a name="406044207"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406044207" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> joshi <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406044207">(Dec 05 2023 at 12:19)</a>:</h4>
<blockquote>
<p>but I think roc can do that without any type-level magic</p>
</blockquote>
<p>On the other hand, doesn't the compiler already keep track of that information somehow on order to be able to remove refcount increments/decrements? unique ~~ an argument whose refcount is guaranteed to be decremented by the function?</p>



<a name="406057044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406057044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> timotree <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406057044">(Dec 05 2023 at 13:31)</a>:</h4>
<p>Maybe this is what Luke was saying, but the callback approach looks the same as a direct task approach <code>openFile : Path -&gt; Task FileHandle e</code> composed with <code>Task.await</code>. Is there a way to put the cleanup logic in <code>Task.await</code> instead so you can have a more uniform API?</p>



<a name="406058017"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406058017" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406058017">(Dec 05 2023 at 13:36)</a>:</h4>
<p>I think of <code>Str, (Handle -&gt; Task a FileErr) -&gt; Task  a FileErr</code> compared to <code>Str -&gt; Task  Handle FileErr</code> as sort of "inlining the <code>await</code>" if that makes sense - it means you don't have to <code>|&gt; Task.await</code> that call because the <code>await</code> is baked into the original call</p>



<a name="406058713"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406058713" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406058713">(Dec 05 2023 at 13:40)</a>:</h4>
<p>I thought about using this in a couple of places, but I decided against it because:</p>
<ul>
<li>The type is more complicated, so it makes the docs a bit harder to understand</li>
<li>It kinda hurts the muscle memory/instant recognition around the typical "every <code>&lt;-</code> should end with a <code>|&gt;</code>" (to <code>Task.await</code> most common, but also sometimes things like <code>Result.try</code>) because now some lines need to end that way but other lines need to <em>not</em> end that way, so lines that are missing it don't jump out as much anymore</li>
<li>It's convenient in the (common, of course) case where you want to <code>await</code>, but in the future we'll have other ways to combine tasks concurrently (e.g. "run these two tasks, and then once they have both finished - in any order - then continue"), and inlining <code>await</code> means that by default you're missing out on those performance benefits, and you actually have to pass in <code>Task.ok</code> to "cancel out" the inlined <code>await</code> and then do the more concurrent thing</li>
</ul>



<a name="406058954"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406058954" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406058954">(Dec 05 2023 at 13:42)</a>:</h4>
<p><span class="user-mention silent" data-user-id="479448">Asier Elorz (he/him)</span> <a href="#narrow/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources/near/406002284">said</a>:</p>
<blockquote>
<p>Languages like C++ and Rust solve this by encapsulating the resource in a class with a destructor or <code>Drop</code> trait that will automatically run cleanup code when the object goes out of scope. Roc manages memory automatically, but as far as I know (please do correct me if I am wrong) doesn't let the user write arbitrary cleanup procedures.</p>
</blockquote>
<p>so it turns out that an equivalent of <code>Drop</code> can be done in the host today through clever use of <code>roc_alloc</code> and <code>roc_dealloc</code></p>



<a name="406059446"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406059446" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406059446">(Dec 05 2023 at 13:44)</a>:</h4>
<p>the basic design is that you have some <code>Task</code> that opens a file handle/descriptor/stream (whatever you decide to call it! I'll just call it "fd" here because it's shortest, although it's probably not the best name for a real Roc API) and that fd has a Roc type of <code>Box I32</code> - meaning, it's the underlying OS file descriptor (the <code>I32</code>) but, importantly, it's boxed on the heap</p>



<a name="406059538"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406059538" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406059538">(Dec 05 2023 at 13:44)</a>:</h4>
<p>in the host, it doesn't get allocated on the normal heap though. Instead, it gets allocated into a separate region of memory that's dedicated to storing only file descriptors</p>



<a name="406059606"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406059606" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406059606">(Dec 05 2023 at 13:45)</a>:</h4>
<p>so because it's a <code>Box</code>, Roc will automatically reference count it, and then when the reference count gets to 0, it calls <code>roc_dealloc</code> on it as normal</p>



<a name="406059739"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406059739" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406059739">(Dec 05 2023 at 13:45)</a>:</h4>
<p>then the host's <code>roc_dealloc</code> function looks at the address it was told to deallocate. If that address is in the range of the special file descriptor range, then it knows "aha, this is a file descriptor <code>Box</code> we have here" and it can go and <code>fclose</code> the integer before freeing up the slot in memory</p>



<a name="406059987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406059987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406059987">(Dec 05 2023 at 13:47)</a>:</h4>
<p>so it's not a first-class <code>Drop</code> language feature, but it's a way that you can get the behavior of "file descriptors always get closed as soon as they are no longer referenced anywhere," which is what <code>Drop</code> gets you in that context anyway</p>



<a name="406060235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406060235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Asier Elorz (he/him) <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406060235">(Dec 05 2023 at 13:48)</a>:</h4>
<p>This makes a lot of sense. I hadn't thought about that way of implementing destructors at the platform level. It's quite clever. Thanks for the detailed answer!</p>



<a name="406060516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406060516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406060516">(Dec 05 2023 at 13:50)</a>:</h4>
<p>absolutely, thanks for diving into this! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="406072070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406072070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406072070">(Dec 05 2023 at 14:48)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> Could <code>roc_dealloc</code> run some Roc code before freeing the resource? This could be useful for protocols implemented in pure Roc (such as Postgres). <br>
The platform only exposes a TCP effect so it knows how to close it, but it doesn't know the protocol-specific graceful termination procedure. <br>
This would work great, if I can give a "cleanup" callback to the initial connect function that allows me to send some messages before shutting it down for real.</p>



<a name="406072331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406072331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406072331">(Dec 05 2023 at 14:49)</a>:</h4>
<p>My guess is that <code>roc_dealloc</code> is supposed to be sync, so maybe it couldn't just run a <code>Task</code>, but maybe it can add it to some sort of queue?</p>



<a name="406108723"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406108723" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406108723">(Dec 05 2023 at 17:16)</a>:</h4>
<p>I would feel exceptionally uncomfortable if <code>roc_dealloc</code> could touch tasks at all</p>



<a name="406108775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406108775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406108775">(Dec 05 2023 at 17:16)</a>:</h4>
<p>It means that tasks could run randomly in pure sections of code cause they drop a value</p>



<a name="406108895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406108895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406108895">(Dec 05 2023 at 17:17)</a>:</h4>
<p>Maybe that would be hidden and ok, but it kinda allows tasks anywhere and feels like it could be abused.</p>



<a name="406143383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406143383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406143383">(Dec 05 2023 at 19:16)</a>:</h4>
<p>That shouldn’t affect running pure functions since their input is already established</p>



<a name="406143949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406143949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406143949">(Dec 05 2023 at 19:20)</a>:</h4>
<p>I do see your point, though. If misused this could make it hard to track down why an effect is occurring</p>



<a name="406144093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406144093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406144093">(Dec 05 2023 at 19:21)</a>:</h4>
<p>That said, closing a file or a connection also is an effect, and with the suggested approach, it would indeed run in pure sections of code cause they drop a value</p>



<a name="406144675"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406144675" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406144675">(Dec 05 2023 at 19:25)</a>:</h4>
<p>If we are ok with one, shouldn’t we be ok with the other?</p>



<a name="406145076"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406145076" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406145076">(Dec 05 2023 at 19:28)</a>:</h4>
<p>I am ok with that happen in the platform side. Fundamentally the platform can do anything.</p>
<p>But I don't like is someone could write</p>
<div class="codehilite"><pre><span></span><code>ConsumeLine := {} implements [
    Drop {dropTask}
]

dropTask = Stdin.line |&gt; Task.await \_ -&gt; {}



SomePureFunc : OtherData, ConsumeLine -&gt; Maybe ConsumeLine
SomePureFunc = \data, cl -&gt;
    if NeedsLineCleared data then
        None
    else
        Some cl
</code></pre></div>



<a name="406145680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406145680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406145680">(Dec 05 2023 at 19:32)</a>:</h4>
<p>Do we even need language support for something like this? I’m just thinking you’d give the platform a Roc callback and it would just choose to call it as part of it being able to do anything</p>



<a name="406145806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406145806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406145806">(Dec 05 2023 at 19:33)</a>:</h4>
<p>Oh, when you open a tcp stream, you also pass a graceful closure callback (or at some point you call something to add a graceful closure callback)?</p>



<a name="406146529"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406146529" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406146529">(Dec 05 2023 at 19:38)</a>:</h4>
<p>Yeah, exactly. As part of the original task that opens it.</p>



<a name="406147012"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406147012" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406147012">(Dec 05 2023 at 19:41)</a>:</h4>
<p>Yeah, I would be totally for that.</p>
<p>I guess I just misunderstood your original prompt.</p>



<a name="406147100"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406147100" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406147100">(Dec 05 2023 at 19:42)</a>:</h4>
<p>Though I guess you need to be careful of closure capture keeping something alive and stopping it from every being deallocated</p>



<a name="406147761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406147761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406147761">(Dec 05 2023 at 19:47)</a>:</h4>
<p>Would that work with postgres? do you need to capture anything? assuming the tcp connection that is about to be cleared is passed into the lambda</p>



<a name="406148023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406148023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406148023">(Dec 05 2023 at 19:49)</a>:</h4>
<p>I need to send a <code>Terminate</code> message. I need the connection to do that, so the platforms needs to delay closing until my task is resolved.</p>



<a name="406148120"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406148120" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406148120">(Dec 05 2023 at 19:50)</a>:</h4>
<p>I wouldn’t be capturing the connection, I guess I would get it as an argument</p>



<a name="406148361"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406148361" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406148361">(Dec 05 2023 at 19:51)</a>:</h4>
<p>I couldn’t even capture it because I would be defining this function before the connection is returned from the “open” task</p>



<a name="406148714"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406148714" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406148714">(Dec 05 2023 at 19:54)</a>:</h4>
<p>In the case of Postgres, the termination message doesn’t need to provide any information that was established during the lifetime of the connection. It’s always the same.</p>



<a name="406148945"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406148945" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406148945">(Dec 05 2023 at 19:56)</a>:</h4>
<p>Yeah, that last point is my biggest concern, but not sure how common it is.</p>



<a name="406149057"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406149057" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406149057">(Dec 05 2023 at 19:56)</a>:</h4>
<p>Also, I guess there would be a weird case were you never connect but still send a termination message, but that probably doesn't really matter.</p>



<a name="406149229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406149229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406149229">(Dec 05 2023 at 19:58)</a>:</h4>
<p>I guess if you really need state, eventually we will have <code>Stored</code> and you can give the platform a <code>Task</code> instead of a closure. That task can called <code>Stored</code>, load some state, and then generate a message as needed from that.</p>



<a name="406149261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406149261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406149261">(Dec 05 2023 at 19:58)</a>:</h4>
<p>Couldn’t the platform just skip calling the function in that case? Presumably it wouldn’t even store the pointer to it if it fails to connect</p>



<a name="406149408"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406149408" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406149408">(Dec 05 2023 at 19:59)</a>:</h4>
<p>Yeah, <code>Stored</code> would work. Or any other stateful effect that the platform might provide.</p>



<a name="406149489"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406149489" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406149489">(Dec 05 2023 at 19:59)</a>:</h4>
<blockquote>
<p>Couldn’t the platform just skip calling the function in that case? Presumably it wouldn’t even store the pointer to it if it fails to connect</p>
</blockquote>
<p>Not sure this truly applies to postgres, I mean some sort of state where you have a working tcp connection but haven't communicated with postgres at all. Then for some reason you drop the connection and the function runs. So from the postgres server side, it would see a tcp connection opening, a termination message, and a tcp connection closing.</p>



<a name="406149613"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406149613" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406149613">(Dec 05 2023 at 20:00)</a>:</h4>
<p>Ah, I see. Yeah, that could happen.</p>



<a name="406149822"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/406149822" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Agus Zubiaga <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#406149822">(Dec 05 2023 at 20:01)</a>:</h4>
<p>I think in the case of Postgres that’s totally valid. You are just terminating before authenticating, but yeah, you’d need some sort of state if you had to avoid that.</p>



<a name="407286898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/407286898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#407286898">(Dec 11 2023 at 17:24)</a>:</h4>
<p>I think this is possible in an effect interpreters world</p>



<a name="407286933"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/407286933" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#407286933">(Dec 11 2023 at 17:24)</a>:</h4>
<p>wouldn't need any special language features</p>



<a name="407286976"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/407286976" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#407286976">(Dec 11 2023 at 17:25)</a>:</h4>
<p>the basic idea would be to start with the "host runs some code when a particular thing gets dropped" technique (mentioned earlier)</p>



<a name="407287077"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/407287077" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#407287077">(Dec 11 2023 at 17:25)</a>:</h4>
<p>and then assume this API:</p>
<p><span class="user-mention silent" data-user-id="489294">Agus Zubiaga</span> <a href="#narrow/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources/near/406145680">said</a>:</p>
<blockquote>
<p>I’m just thinking you’d give the platform a Roc callback and it would just choose to call it as part of it being able to do anything</p>
</blockquote>
<p>so in the platform's API for opening the TCP connection, you specify a <code>Task</code> to run when it's going to get closed</p>



<a name="407287535"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/407287535" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#407287535">(Dec 11 2023 at 17:28)</a>:</h4>
<p>the platform holds onto that task, and then when it goes to close the tcp connection, it can run that task - possibly synchronously (as in, go interpret that state machine entry right away, and don't go back to interpreting the <code>main</code> state machine until it's all done), or possibly by having an async pool of things that can run concurrently (presumably desirable for <code>map2</code> concurrency anyway) and just add it to that</p>



<a name="407288923"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/API%20design%20around%20non-memory%20resources/near/407288923" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/API.20design.20around.20non-memory.20resources.html#407288923">(Dec 11 2023 at 17:35)</a>:</h4>
<p>Yeah, and with <code>Stored</code> the drop could load extra state if it is needed.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Code review? ¬∑ beginners ¬∑ Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html">Code review?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="417525470"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417525470" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417525470">(Jan 23 2024 at 20:46)</a>:</h4>
<p>So I'm currently working on putting together an ISO date/time parsing <a href="https://github.com/imclerran/Roc-IsoDate">Roc package</a>, and just hit a major milestone: full date support (no time or date/time yet). Big ask, but just wondering if anyone would be interested in giving me a code review for the work so far?</p>



<a name="417565083"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417565083" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417565083">(Jan 24 2024 at 02:38)</a>:</h4>
<p>Awesome!</p>



<a name="417565213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417565213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417565213">(Jan 24 2024 at 02:40)</a>:</h4>
<p>In parseCalendarDateBasic I would recommend pattern matching on the strs. Then you can express that it should be 3 elements and bring all of those elements into scope at the same time. That way you can avoid having to get each element and unwrapping</p>



<a name="417568251"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417568251" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417568251">(Jan 24 2024 at 03:17)</a>:</h4>
<p>For example: </p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">parseCalendarDateBasic</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">Utc</span><span class="w"> </span><span class="p">[</span><span class="kt">InvalidDateFormat</span><span class="p">]</span>
<span class="nv">parseCalendarDateBasic</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">str</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">when</span><span class="w"> </span><span class="nv">splitStrAtIndices</span><span class="w"> </span><span class="nv">str</span><span class="w"> </span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="nv">is</span>
<span class="w">        </span><span class="p">[</span><span class="nv">year</span><span class="p">,</span><span class="w"> </span><span class="nv">month</span><span class="p">,</span><span class="w"> </span><span class="nv">day</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">doStuff</span><span class="w"> </span><span class="nv">year</span><span class="w"> </span><span class="nv">month</span><span class="w"> </span><span class="nv">day</span>
<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Err</span><span class="w"> </span><span class="kt">InvalidDateFormat</span>
</code></pre></div>



<a name="417568640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417568640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Isaac Van Doren <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417568640">(Jan 24 2024 at 03:22)</a>:</h4>
<p>If a function takes a lambda as the last argument you don't need to wrap it in parens. I'd say that's even the idiomatic way to write.</p>
<p>So you can do things like this and they look visually cleaner</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="nv">myList</span><span class="w"> </span><span class="nf">\</span><span class="nv">elem</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">elem</span><span class="w"> </span><span class="nf">*</span><span class="w"> </span><span class="mi">2</span>
</code></pre></div>



<a name="417574690"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417574690" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417574690">(Jan 24 2024 at 04:39)</a>:</h4>
<p>for the tests, you can avoid all the <code>unwrap</code>s by comparing to <code>Ok</code>, e.g.</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nx">expect</span><span class="w"> </span><span class="nx">unwrap</span><span class="w"> </span><span class="p">(</span><span class="nx">parseDate</span><span class="w"> </span><span class="s">"2024-01-23"</span><span class="p">)</span><span class="w"> </span><span class="s">"Could not parse!"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">@Utc</span><span class="w"> </span><span class="p">(</span><span class="nx">Num</span><span class="p">.</span><span class="nx">toU128</span><span class="w"> </span><span class="p">((</span><span class="mi">19</span><span class="nx">_723</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">secondsPerDay</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">nanosPerSecond</span><span class="p">))</span>
</code></pre></div>
<p>...becomes</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nx">expect</span><span class="w"> </span><span class="nx">parseDate</span><span class="w"> </span><span class="s">"2024-01-23"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">Ok</span><span class="w"> </span><span class="p">(</span><span class="nx">@Utc</span><span class="w"> </span><span class="p">(</span><span class="nx">Num</span><span class="p">.</span><span class="nx">toU128</span><span class="w"> </span><span class="p">((</span><span class="mi">19</span><span class="nx">_723</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">secondsPerDay</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">nanosPerSecond</span><span class="p">)))</span>
</code></pre></div>
<p>or, alternatively:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nx">expect</span><span class="w"> </span><span class="nx">parseDate</span><span class="w"> </span><span class="s">"2024-01-23"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">((</span><span class="mi">19</span><span class="nx">_723</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">22</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">secondsPerDay</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">nanosPerSecond</span><span class="p">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Num</span><span class="p">.</span><span class="nx">toU127</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">@Utc</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Ok</span>
</code></pre></div>



<a name="417574991"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417574991" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417574991">(Jan 24 2024 at 04:44)</a>:</h4>
<p>also, pattern matching on tuples can be used instead of <code>if allOk [...] then</code> followed by <code>unwrap</code>, e.g.</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">when</span><span class="w"> </span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="p">)</span><span class="w"> </span><span class="n">is</span>
<span class="w">    </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">        </span><span class="n">numDaysSinceEpoch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">year</span><span class="kt">:</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="kt">:</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="kt">:</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">daysToNanos</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="o">@</span><span class="kt">Utc</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="kt">Ok</span>

<span class="w">    </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Err</span><span class="w"> </span><span class="kt">InvalidDateFormat</span>
</code></pre></div>



<a name="417575027"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417575027" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417575027">(Jan 24 2024 at 04:45)</a>:</h4>
<p>that's a performance win because <code>List</code> requires a heap allocation, but tuples don't! <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="417575157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417575157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417575157">(Jan 24 2024 at 04:47)</a>:</h4>
<p>btw thanks for making this! At work we already know of a future use case where we're going to want to be able to parse ISO-8601 datetime strings in Roc, so this is very nice to see <span aria-label="heart eyes cat" class="emoji emoji-1f63b" role="img" title="heart eyes cat">:heart_eyes_cat:</span></p>



<a name="417575172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417575172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417575172">(Jan 24 2024 at 04:47)</a>:</h4>
<p>I started to work on one at some point but did not get as far as you have already!</p>



<a name="417575410"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417575410" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417575410">(Jan 24 2024 at 04:51)</a>:</h4>
<p>oh! Also, I think <a href="https://www.roc-lang.org/builtins/Str#split"><code>Str.split</code></a> can be used in place of <code>splitStrAtDelimiter</code> if I'm not mistaken</p>



<a name="417579548"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417579548" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417579548">(Jan 24 2024 at 05:47)</a>:</h4>
<p>A few minor suggestions:</p>
<ol>
<li>In general, I would advise removing <code>unwrap</code> from your library overall. For a library, there is almost always a better choice for how to handle/propagate errors.</li>
<li>change <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/Const.roc#L44-L57">monthDaysNonLeap</a> to a function, it will be a lot faster. That or just a flat array and search it linearly.</li>
<li>Use <code>List.all results Result.isOk</code> <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/Utils.roc#L36-L40">here</a></li>
<li>For <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/Utils.roc#L69-L84">strSplitAtIndices</a>, I would convert to a <code>List U8</code>, split with <code>List.sublist/takeFirst/dropFirst</code> then convert back to a string. It will lead to simpler code.</li>
<li>My rewrite <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/Utils.roc#L89-L98">isLeapYear</a> using boolean and (<code>&amp;&amp;</code>) instead of if conditions and explicitly returning <code>Bool.true/false</code></li>
<li>In <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/Utils.roc#L103-L104">numLeapYearsSinceEpoch</a>, <code>List.range</code> will materialize the entire list, probably fine, but may be slow/wasteful for large number of years.</li>
<li>Why make both <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/Utils.roc#L113-L114">numDaysSinceEpoch</a> and <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/Utils.roc#L127-L132">numDaysSinceEpochToYMD</a>. Given the optional record params, they really have the same api.</li>
<li>Avoid <a href="https://github.com/imclerran/iso-roc-date/blob/1936fa7293539a651cb79923c7241b0b495c9207/src/IsoToUtc.roc#L77-L80">checking the length of something and then unwrapping all of the <code>List.get</code> functions</a>. It is not good style. Instead, use list pattern matching with <code>when ... is</code>.</li>
</ol>



<a name="417579707"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417579707" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417579707">(Jan 24 2024 at 05:49)</a>:</h4>
<ol start="9">
<li>I would generally recommend against using <code>Nat</code>. It is actually slotted for removal in the language. I believe for this package, <code>U16</code> should be good, but <code>U32</code> or <code>U64</code> would be fine if wanted.</li>
</ol>



<a name="417659005"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417659005" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417659005">(Jan 24 2024 at 14:40)</a>:</h4>
<p>Wow, thank you all for the code reviews. Can't say enough how much I appreciate everyone's time to look through my code and provide feedback. This is all awesome feedback. <span aria-label="star struck" class="emoji emoji-1f929" role="img" title="star struck">:star_struck:</span></p>
<p>Isaac and Richard, the tips on pattern matching multiple elements here are a huge help. Both of these will lead to much cleaner code and better error handling than my solution, and if we can get more performant with a tuple, awesome!! </p>
<p>Brendan, thanks for the in depth list of improvements. All of these are great tips. I'll be diving into making all these improvements later today! <span aria-label="working on it" class="emoji emoji-1f6e0" role="img" title="working on it">:working_on_it:</span></p>



<a name="417660554"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417660554" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417660554">(Jan 24 2024 at 14:48)</a>:</h4>
<p>Btw Richard, great to hear this is something that could be useful at your work! I noticed there didn't seem to be any ISO date/time packages out there, and thought it could be a useful addition to ecosystem. Awesome to hear this could be filling a needed gap!</p>



<a name="417661103"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417661103" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417661103">(Jan 24 2024 at 14:51)</a>:</h4>
<p>Also... Not sure how I missed <code>Str.split</code> in the API... <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>  I think I started out looking for a <code>splitStrAtIndex</code> equivalent, and when I didn't find that, it just went into my brain that there wan't a split function for Str.  Derp!</p>



<a name="417977621"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417977621" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417977621">(Jan 24 2024 at 22:52)</a>:</h4>
<p>Okay, all recommendations have been implemented! Thanks again for the review everyone!</p>
<p>While removing unwrap, I also removed all crash keyword usages in general. There is one instance in <a href="https://github.com/imclerran/Roc-IsoDate/blob/59ee5331c1b96d5e353fde472ea77ea0eb474280/src/Utils.roc#L28C1-L41C23">splitStrAtIndicesRecur</a> where I think a crash may actually be the best failure mode, but I'm curious what others think. For now it will simply ignore the failure (which should never occur) and try to continue.</p>
<p>Latest code is in the <a href="https://github.com/imclerran/iso-roc-date/tree/master">repo</a> <span aria-label="octopus" class="emoji emoji-1f419" role="img" title="octopus">:octopus:</span></p>



<a name="417986046"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417986046" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417986046">(Jan 25 2024 at 00:16)</a>:</h4>
<p>If it truly should never occur. Thus, it would be a bug against the library if it occurs, crash is probably the right choice.</p>



<a name="417986471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417986471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417986471">(Jan 25 2024 at 00:21)</a>:</h4>
<p>That said, in this case, you do have a bug:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">expect</span>
<span class="w">    </span><span class="nv">res</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">splitStrAtIndex</span><span class="w"> </span><span class="s">"üî•üî•"</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="nv">res</span><span class="w"> </span><span class="nf">==</span><span class="w"> </span><span class="p">[</span><span class="s">"üî•"</span><span class="p">,</span><span class="w"> </span><span class="s">"üî•"</span><span class="p">]</span>
</code></pre></div>



<a name="417986499"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417986499" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417986499">(Jan 25 2024 at 00:22)</a>:</h4>
<p>If the case was a crash, it would be hit here.</p>



<a name="417986575"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417986575" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417986575">(Jan 25 2024 at 00:22)</a>:</h4>
<p>And this is actually exactly why we don't have <code>Str.splitAtIndex</code> in the standard library.</p>



<a name="417986631"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417986631" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417986631">(Jan 25 2024 at 00:23)</a>:</h4>
<p>Not sure if that can be hit through the public api of your package, but that is the concern.</p>



<a name="417987786"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417987786" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417987786">(Jan 25 2024 at 00:35)</a>:</h4>
<p>if you're up for it, I think an approach worth trying is to start by immediately converting to <code>List U8</code> as the very first thing, and then doing all parsing in terms of that</p>



<a name="417987905"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417987905" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417987905">(Jan 25 2024 at 00:37)</a>:</h4>
<p>that has the benefit of also working on raw byte streams, which is what <code>Decode</code> uses</p>



<a name="417987928"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417987928" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417987928">(Jan 25 2024 at 00:37)</a>:</h4>
<p>so you could support parsing them from both <code>Str</code> as well as from <code>List U8</code></p>



<a name="417988219"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417988219" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417988219">(Jan 25 2024 at 00:40)</a>:</h4>
<p>to do that you'd convert things like <code>"-"</code> to <code>'-'</code> because single quote literals just compile directly to numbers (specifically a unicode code point)</p>



<a name="417988281"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/417988281" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#417988281">(Jan 25 2024 at 00:41)</a>:</h4>
<p>I think we should probably start recommending parsing <code>List U8</code> as a best practice, even if the input is a string! <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="418087816"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418087816" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418087816">(Jan 25 2024 at 14:12)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Code.20review.3F/near/417986631">said</a>:</p>
<blockquote>
<p>Not sure if that can be hit through the public api of your package, but that is the concern.</p>
</blockquote>
<p>Good call here - It was possible previously to  hit this by putting a multibyte character in one of the character positions where a digit would have been expected in the date string. I have now added validation to ensure the date string contains no multi-byte characters.</p>



<a name="418095728"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418095728" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418095728">(Jan 25 2024 at 14:49)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span>  Yeah, I'm totally up for it. I'm beginning work on making those adaptations now. Looks like it might be in my best interest to figure out Decoders. Any pointers on where I can go for a code sample of custom decoders in use?</p>



<a name="418095943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418095943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418095943">(Jan 25 2024 at 14:50)</a>:</h4>
<p>that's a good question! I forget if we have any material on that - maybe <span class="user-mention" data-user-id="515757">@Luke Boswell</span> or <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> might know?</p>



<a name="418101587"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418101587" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418101587">(Jan 25 2024 at 15:16)</a>:</h4>
<p>Doesn‚Äôt even need to be learning material, if there is any ‚Äúproduction‚Äù code that uses decoders, I can start parsing through that‚Ä¶</p>



<a name="418101647"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418101647" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418101647">(Jan 25 2024 at 15:16)</a>:</h4>
<p>I don't think a decoder would work here? They are more meant for decoding to/from a generic format like json or protobif.</p>



<a name="418101761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418101761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418101761">(Jan 25 2024 at 15:17)</a>:</h4>
<p>Also, look up TotallyNotJson in the repo.</p>



<a name="418102449"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418102449" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418102449">(Jan 25 2024 at 15:20)</a>:</h4>
<p>you could do something like make an opaque <code>Timestamp</code> type which implements <code>Decoding</code> for strings</p>



<a name="418102688"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418102688" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418102688">(Jan 25 2024 at 15:21)</a>:</h4>
<p>that would give someone a way to decode a record from JSON while also decoding some of the fields as ISO-8601 timestamps</p>



<a name="418102775"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418102775" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418102775">(Jan 25 2024 at 15:21)</a>:</h4>
<p>I'm not sure if that's actually the best design, but it's a thought!</p>



<a name="418104292"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418104292" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418104292">(Jan 25 2024 at 15:27)</a>:</h4>
<p>Yeah, definitely can do that. Then a timestamp can be decoded from a string in any generic data format. Useful for end users, not useful for making the parsing nicer in this library.</p>
<p>This has come up a few times with Decode... I wonder if It is named poorly. I wonder if the serde folks regularly get the same question.</p>



<a name="418105126"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418105126" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418105126">(Jan 25 2024 at 15:31)</a>:</h4>
<p>Thanks Brendon. I‚Äôll take a look at it. From a brief scan at the Decode docs page, I thought there might be a more generic application with the custom decoders. </p>
<p>Richard, that is an interesting idea. Sounds like it could make for a pretty streamlined API for a common use case of ISO strings. Just to clarify, would timestamp be an opaque type which replaces the Utc opaque I‚Äôm currently using?</p>



<a name="418105354"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418105354" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418105354">(Jan 25 2024 at 15:32)</a>:</h4>
<p>it's a good question, I'm not sure what would be more ergonomic for end users <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="418105371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418105371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418105371">(Jan 25 2024 at 15:32)</a>:</h4>
<p>I think so, yeah</p>



<a name="418105416"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418105416" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418105416">(Jan 25 2024 at 15:32)</a>:</h4>
<p>like <code>Timestamp := Utc implements [Decoding { ...etc }]</code></p>



<a name="418106308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418106308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418106308">(Jan 25 2024 at 15:36)</a>:</h4>
<p>Is there any reason I could not (or should not) simply define <code>Utc := U128 implements [Decoding { ‚Ä¶etc }]</code>?</p>



<a name="418106433"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418106433" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418106433">(Jan 25 2024 at 15:37)</a>:</h4>
<p>you can, but the trick is that you have to pick 1 way to decode it</p>



<a name="418106516"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418106516" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418106516">(Jan 25 2024 at 15:38)</a>:</h4>
<p>so if you do it that way, you're saying <code>Utc</code> only decodes from an ISO-8601 timestamp as opposed to an integer</p>



<a name="418106650"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418106650" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418106650">(Jan 25 2024 at 15:38)</a>:</h4>
<p>which maybe is what you want, but personally a thing I like about UTC is that I can treat it as an ordinary integer <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="418106721"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418106721" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418106721">(Jan 25 2024 at 15:38)</a>:</h4>
<p>Gotcha. Yeah, that doesn‚Äôt make a lot of sense to do‚Ä¶ <span aria-label="rolling eyes" class="emoji emoji-1f644" role="img" title="rolling eyes">:rolling_eyes:</span></p>



<a name="418107490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418107490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418107490">(Jan 25 2024 at 15:43)</a>:</h4>
<p>Just out of curiosity, why was Utc implemented as unsigned? Seems like a date pre-epoch could be useful to store. But maybe in terms of typical comparable dates, recent dates are almost exclusively to be expected, and older dates likely only need a textual representation‚Ä¶</p>



<a name="418117415"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418117415" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418117415">(Jan 25 2024 at 16:28)</a>:</h4>
<p>yeah actually I can see an argument for signed! <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="418120540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418120540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418120540">(Jan 25 2024 at 16:44)</a>:</h4>
<p>Hmm well I just plan to stick with U128 for compatibility. Keeps things simpler for me too.</p>



<a name="418124387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418124387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418124387">(Jan 25 2024 at 17:02)</a>:</h4>
<p>Feel free to push a PR to the roc projects to change UTC to signed</p>



<a name="418156574"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418156574" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418156574">(Jan 25 2024 at 20:08)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> Anywhere I should make PRs besides roc-lang/basic-cli and roc-lang/basic-webserver?</p>



<a name="418162793"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418162793" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418162793">(Jan 25 2024 at 20:52)</a>:</h4>
<p>I think just those two</p>



<a name="418683413"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418683413" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418683413">(Jan 29 2024 at 17:13)</a>:</h4>
<p>So while working to migrate the basic-webserver to use <code>I128</code> instead of <code>U128</code> for Utc, I discovered a bug in <code>InternalDateTime.epochMillisToDateTimeHelp</code> which causes it to fail to correctly convert millis to DateTime for the last day of a month or year.</p>
<p>I opened an <a href="https://github.com/roc-lang/basic-webserver/issues/24">issue</a> on the repo, and submitted a corresponding <a href="https://github.com/roc-lang/basic-webserver/pull/25">PR</a>.</p>



<a name="418889912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418889912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418889912">(Jan 30 2024 at 17:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Code.20review.3F/near/418124387">said</a>:</p>
<blockquote>
<p>Feel free to push a PR to the roc projects to change UTC to signed</p>
</blockquote>
<p>I've opened a <a href="https://github.com/roc-lang/basic-cli/pull/167">PR</a> for the issue on the basic-cli repo. Changes to the webserver are more involved, but should be ready for a PR soon(TM).</p>



<a name="418903963"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/418903963" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#418903963">(Jan 30 2024 at 19:15)</a>:</h4>
<p>Okay, a matching <a href="https://github.com/roc-lang/basic-webserver/pull/31">PR</a> for the webserver is up.</p>



<a name="419008444"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419008444" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419008444">(Jan 31 2024 at 10:23)</a>:</h4>
<p>We're looking for some additional input on a change in this PR where the type of <code>Utc</code> was changed from <code>U128</code> to <code>I128</code>.</p>
<p><code>deltaAsNanos</code> calculates the absolute difference between two Utc timestamps. The signature of <code>deltaAsNanos</code> was changed from <code>Utc, Utc -&gt; U128</code> to <code>Utc, Utc -&gt; I128</code>. This is because <code>Num.absDiff</code> returns the same type as its arguments (<code>Num a, Num a -&gt; Num a</code>).</p>
<p><code>absDiff</code> will never actually return a negative number. I'd like to make this behavior clear in the signature of <code>deltaAsNanos</code> and cast the result of <code>absDiff</code> with <code>Num.toU128</code>. I believe this prevents confusion cause someone may otherwise see the I128 and wonder how this delta can be negative. It may also lead to wrong assumptions about how this function works. In general I also think it's good practice to avoid overly broad types.</p>
<p>On the other hand, the cast is not strictly necessary and it is kind of nice to use U128 everywhere and never need to cast for calculations.</p>
<p>Thoughts?</p>



<a name="419068283"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419068283" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419068283">(Jan 31 2024 at 15:44)</a>:</h4>
<p>Yeah, I wish the roc type system had a bit more power so you could specify a same bit width number but signed or unsigned.</p>



<a name="419068902"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419068902" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419068902">(Jan 31 2024 at 15:46)</a>:</h4>
<p>Personally, I would probably force them both into U128 even if they are negative and then run abs diff.</p>
<p>Should get the same abs diff, avoid the chance of abs overflowing, and get a more accurate type overall.</p>



<a name="419070426"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419070426" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419070426">(Jan 31 2024 at 15:52)</a>:</h4>
<p>If only one is negative the abs diff would be different though</p>



<a name="419071798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419071798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419071798">(Jan 31 2024 at 15:58)</a>:</h4>
<p>...ah yeah, you have to do some extra handling cause the negative number are put above the positive ones. (Would have to double check, but I think it may just be converting then flipping the first bit)</p>



<a name="419073039"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419073039" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419073039">(Jan 31 2024 at 16:03)</a>:</h4>
<p>Cause imagining in I8/U8...</p>
<p>I8 inputs</p>
<div class="codehilite"><pre><span></span><code>-7 -&gt; 11111001
12 -&gt; 00001100
</code></pre></div>
<p>As U8 with same bit pattern</p>
<div class="codehilite"><pre><span></span><code>249
12
</code></pre></div>
<p>Flip first bit to put positives above negatives</p>
<div class="codehilite"><pre><span></span><code>121 -&gt; 01111001
140 -&gt; 10001100
</code></pre></div>
<p>Get abs diff:<br>
19</p>



<a name="419073375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419073375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419073375">(Jan 31 2024 at 16:04)</a>:</h4>
<p>Yeah, so I would do that</p>



<a name="419077023"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419077023" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419077023">(Jan 31 2024 at 16:21)</a>:</h4>
<p>Is it really worth the increase in complexity to reduce the probability of overflow, given that we're dealing with timestamps? With an I128 we're still very comfortable to represent the age of the universe in nanoseconds.</p>



<a name="419077886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419077886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419077886">(Jan 31 2024 at 16:25)</a>:</h4>
<p>Guess I didn't realize the scale of an I128.</p>



<a name="419078303"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419078303" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419078303">(Jan 31 2024 at 16:27)</a>:</h4>
<p>That said, I really don't think it is that complex:</p>
<div class="codehilite"><pre><span></span><code>aCast = Num.bitwiseXor (Num.toU128 a) (Num.shiftLeftBy 1 127)
bCast = Num.bitwiseXor (Num.toU128 b) (Num.shiftLeftBy 1 127)
Num.absDiff aCast bCast
</code></pre></div>



<a name="419078491"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419078491" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419078491">(Jan 31 2024 at 16:28)</a>:</h4>
<p>Personally though, I would really love if this could be done in <code>Num.absDiff</code> internally and it could automatically return the unsized type to ensure that it will never panic.</p>



<a name="419130852"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419130852" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419130852">(Jan 31 2024 at 22:01)</a>:</h4>
<p>Thanks for the input here guys. Brendan, I'll take your solution for handling oposing signs in the delta functions, and update both my PRs accordingly.</p>



<a name="419132540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419132540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ian McLerran <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419132540">(Jan 31 2024 at 22:12)</a>:</h4>
<p>Changes are up, just waiting on CI.</p>



<a name="419728684"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419728684" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anne Archibald <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419728684">(Feb 04 2024 at 20:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="361169">Anton</span> <a href="#narrow/stream/231634-beginners/topic/Code.20review.3F/near/419008444">said</a>:</p>
<blockquote>
<p>We're looking for some additional input on a change in this PR where the type of <code>Utc</code> was changed from <code>U128</code> to <code>I128</code>.</p>
<p><code>deltaAsNanos</code> calculates the absolute difference between two Utc timestamps. The signature of <code>deltaAsNanos</code> was changed from <code>Utc, Utc -&gt; U128</code> to <code>Utc, Utc -&gt; I128</code>. This is because <code>Num.absDiff</code> returns the same type as its arguments (<code>Num a, Num a -&gt; Num a</code>).</p>
<p><code>absDiff</code> will never actually return a negative number. I'd like to make this behavior clear in the signature of <code>deltaAsNanos</code> and cast the result of <code>absDiff</code> with <code>Num.toU128</code>. I believe this prevents confusion cause someone may otherwise see the I128 and wonder how this delta can be negative. It may also lead to wrong assumptions about how this function works. In general I also think it's good practice to avoid overly broad types.</p>
<p>On the other hand, the cast is not strictly necessary and it is kind of nice to use U128 everywhere and never need to cast for calculations.</p>
<p>Thoughts?</p>
</blockquote>
<p>Maybe I have an unusual perspective on time, having been a pulsar astronomer and having worked on Astropy's Time objects (which use a pair of double-precision numbers to provide sufficient precision), but are times before the UNIX epoch not of interest? Wouldn't a signed number of nanoseconds actually be useful in it's own right?</p>
<p>I realise that date formatting gets complicated for the distant past, but honestly no more so than the present era with our leap seconds. And how long before someone tries to parse the date of the Moon landing or the "shot heard round the world"?</p>



<a name="419730931"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Code%20review%3F/near/419730931" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Code.20review.3F.html#419730931">(Feb 04 2024 at 21:04)</a>:</h4>
<p>Yeah, we just changed it to signed.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
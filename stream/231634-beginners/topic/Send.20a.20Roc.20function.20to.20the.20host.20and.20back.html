<html>
<head><meta charset="utf-8"><title>Send a Roc function to the host and back · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html">Send a Roc function to the host and back</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="518930907"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518930907" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518930907">(May 18 2025 at 15:19)</a>:</h4>
<p>Is it possible to box an arbitrary Roc function, pass it to a Rust host, and have the host pass it back to Roc, then unbox it and call it in Roc?</p>
<p>The purpose is to be able to have a kind of callback from async host functions. I don't want the Rust host to have to know or care about what arguments the function takes or what it returns, that'd strictly be a Roc concern.</p>



<a name="518932619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518932619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518932619">(May 18 2025 at 15:41)</a>:</h4>
<p>I don't think so.... but I would have to test to verify</p>



<a name="518932687"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518932687" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518932687">(May 18 2025 at 15:42)</a>:</h4>
<p>The issue is that we handle every function that is passed to the host in a special way to make it callable by the host and I don't think we actually support proper boxing of functions today....</p>



<a name="518932703"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518932703" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518932703">(May 18 2025 at 15:42)</a>:</h4>
<p>Should be possible to make work, but not sure anyone has tried...so probably won't work</p>



<a name="518932753"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518932753" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518932753">(May 18 2025 at 15:43)</a>:</h4>
<p>Would there be any difference if I settled for passing a tag that takes a single argument?</p>



<a name="518932986"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518932986" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518932986">(May 18 2025 at 15:46)</a>:</h4>
<p>Like a command?</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="o">[</span><span class="w"> </span><span class="no">CallFn1</span><span class="w"> </span><span class="no">ArgType</span><span class="p">,</span><span class="w"> </span><span class="no">CallFn2</span><span class="w"> </span><span class="no">ArgType</span><span class="p">,</span><span class="w"> </span><span class="n">etc</span><span class="o">]</span>
</code></pre></div>



<a name="518932991"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518932991" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518932991">(May 18 2025 at 15:46)</a>:</h4>
<p>Or do you mean something different?</p>



<a name="518933563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518933563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518933563">(May 18 2025 at 15:53)</a>:</h4>
<p>Yes, but for the return value, so like a <code>Msg</code> in TEA</p>



<a name="518933665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518933665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518933665">(May 18 2025 at 15:55)</a>:</h4>
<p>The Rust host function would take a <code>(a -&gt; Msg)</code>, perform some effect, and return <code>a, (a -&gt; Msg)</code> so that Roc could put those two together to produce a <code>Msg</code> and trigger that. I'm not writing exactly TEA, but that's a more clear example.</p>



<a name="518933804"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518933804" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518933804">(May 18 2025 at 15:57)</a>:</h4>
<p>Sorry, not "return" as it's an async function. It would call some Roc host function with <code>a, (a -&gt; Msg)</code>. In the TEA example that'd be e.g. <code>call_update(a, a -&gt; Msg)</code> which would put them together and call the app function <code>update(Msg)</code>. I guess TEA has a <code>Model</code> too, but that's not relevant to the example.</p>



<a name="518934057"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518934057" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518934057">(May 18 2025 at 16:00)</a>:</h4>
<p>Why do you need the extra indirection?</p>
<p>Why not just have the host directly call update?</p>



<a name="518934383"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518934383" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518934383">(May 18 2025 at 16:04)</a>:</h4>
<p>Because I don't know how to make the Rust glue generic over <code>a</code></p>



<a name="518934634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518934634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518934634">(May 18 2025 at 16:07)</a>:</h4>
<p>(and <code>Msg</code>, since <code>Msg</code> is defined in app-code)</p>



<a name="518934994"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518934994" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518934994">(May 18 2025 at 16:12)</a>:</h4>
<p>So I just thought boxing the function and its argument would make it easier. That'd allow me to skip wrangling Rust glue (which I don't know much about) and just pass _anything_ back and forth.</p>



<a name="518935061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518935061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518935061">(May 18 2025 at 16:14)</a>:</h4>
<p>I would just avoid the closure, but otherwise, this should be doable without too much hassle.</p>
<p>For things like basic webserver, we already make rust take an opaque model. It gets the model from init and passes it to update repeatedly</p>



<a name="518935142"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518935142" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518935142">(May 18 2025 at 16:14)</a>:</h4>
<p>In your case, is <code>Msg</code> truly opaque to the platform? It is always generated in roc and consumed in roc?</p>



<a name="518935153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518935153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518935153">(May 18 2025 at 16:15)</a>:</h4>
<p>Yeah</p>



<a name="518935160"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518935160" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518935160">(May 18 2025 at 16:15)</a>:</h4>
<p>Ok.</p>



<a name="518935173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518935173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518935173">(May 18 2025 at 16:15)</a>:</h4>
<p>Then just like model is boxed and rust only handles a pointer, you could box msg and have rust only handle a pointer to it.</p>



<a name="518935188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518935188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518935188">(May 18 2025 at 16:15)</a>:</h4>
<p>Then have rust call update directly passing those two pointers</p>



<a name="518936761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518936761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518936761">(May 18 2025 at 16:36)</a>:</h4>
<p>I'm not following completely... When you say "you could box msg" do you mean boxing the constructor <code>(a -&gt; Msg)</code>? I can't construct the <code>Msg</code> on the Roc-side without first getting whatever value it should contain from the Rust-side. Let's say I have this Roc host function:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="nf">http_get</span><span class="o">!</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Url</span><span class="p">,</span><span class="w"> </span><span class="kt">Box</span><span class="w"> </span><span class="p">(</span><span class="kt">Result</span><span class="w"> </span><span class="kt">Response</span><span class="w"> </span><span class="kt">HttpErr</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Msg</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="nf">http_get</span><span class="o">!</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="o">|</span><span class="n">url</span><span class="p">,</span><span class="w"> </span><span class="n">msg_constructor</span><span class="o">|</span><span class="w"> </span><span class="o">...</span>
</code></pre></div>
<p>The Rust implementation of that would make the HTTP request, build the <code>RocResult</code> and then it's stuck between two worlds: it has the boxed constructor and it has <code>a</code>, but it can't put them together (that would require specific glue for each type of of effect to say what the return value is).</p>
<p>That's why I thought I'd keep it generic and just box it all up, send it over to Roc, and let Roc apply it.</p>
<p>I feel like I'm missing something?</p>



<a name="518949371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518949371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518949371">(May 18 2025 at 19:23)</a>:</h4>
<p>There is definitely something about your architecture plan I am not understanding.</p>



<a name="518949810"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518949810" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518949810">(May 18 2025 at 19:28)</a>:</h4>
<p>Why isn't <code>http_get!</code> simply</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">http_get!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">Url</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="no">Response</span><span class="w"> </span><span class="no">HttpErr</span>
</code></pre></div>
<hr>
<p>Or if you explicitly want a command and message system, I would expect something like this:</p>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="ss">update</span><span class="p">:</span><span class="w"> </span><span class="no">Box</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="no">Msg</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="no">Box</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="no">List</span><span class="w"> </span><span class="no">Cmd</span><span class="p">)</span>
</code></pre></div>
<p>Where <code>Msg</code> is a wrapper around any possible output the platform could alert the app of (like recieving an http response) and <code>Cmd</code> is anything the app can request the platform do (like make an http request).</p>



<a name="518957718"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518957718" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518957718">(May 18 2025 at 20:55)</a>:</h4>
<blockquote>
<p>Why isn't <code>http_get!</code> simply</p>
</blockquote>
<p>Because I do want some kind of command and message system like you showed.</p>
<blockquote>
<p>Where <code>Msg</code> is a wrapper around any possible output the platform could alert the app of</p>
</blockquote>
<p>I'm stuck because <code>Msg</code> is app-defined, so the platform doesn't know how to construct one. Here's roughly what you'd write in Elm:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="kt">Possible</span><span class="w"> </span><span class="kt">Msgs</span>
<span class="kt">Msg</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="kt">MyHttpRequest</span><span class="w"> </span><span class="p">(</span><span class="kt">Result</span><span class="w"> </span><span class="kt">Response</span><span class="w"> </span><span class="kt">HttpErr</span><span class="p">),</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">]</span>

<span class="o">#</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="n">constructs</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">cause</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kt">MyHttpRequest</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">fired</span>
<span class="nf">init</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"> </span><span class="kt">Msg</span><span class="p">)</span>
<span class="nf">init</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="o">|</span><span class="kr">_</span><span class="o">|</span><span class="w"> </span><span class="p">({},</span><span class="w"> </span><span class="kt">Http</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">"https://www.example.com"</span><span class="p">,</span><span class="w"> </span><span class="kt">MyHttpRequest</span><span class="p">))</span>
</code></pre></div>
<p>I then execute that <code>Cmd</code> on the Rust-side of the platform, and end up with a result that I want to pass back in the form of a <code>Msg</code> to the app-code. How do I construct that <code>MyHttpRequest (Result Response HttpErr)</code> in Rust?</p>
<p>My idea was to box everything. I box the message constructor when I pass it over to the Rust-side, I box the result of the effect on the Rust-side, and I pass both of those boxed things back to the Roc-side of the platform. Then Roc can unbox them and apply the function to the resulting argument. I just have to be responsible and make sure the type of the constructor and the argument lines up. If they do, Rust shouldn't have to know what <code>Msg</code> it was asked to produce.</p>
<p>This should result in very little Rust glue code per effect.</p>
<p>Do you think this is possible?</p>



<a name="518959159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518959159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518959159">(May 18 2025 at 21:14)</a>:</h4>
<p>i've been working on something similar for awhile.  your overall design is pretty on point but orthogonal to effectful-ness in Roc.  i would instead model the interface to these effects using a generic mechanism like a Cmd type that the platform controls .  just like Elm's runtime</p>



<a name="518959229"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/518959229" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#518959229">(May 18 2025 at 21:15)</a>:</h4>
<p>but you are basically opting into a turn-based or actor-style programming model(nothing wrong with that - that's what i'm doing - but it's a different model than all other Roc platforms.</p>



<a name="519042659"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/519042659" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#519042659">(May 19 2025 at 09:02)</a>:</h4>
<p>IIUC I would still run into the same issue with <code>Cmd</code>, no? IIUC a <code>Cmd</code> is instruction to the runtime to perform an effect and to send a <code>Msg</code> back with the result of the effect as the <code>Msg</code>s payload. The user passes in a constructor for the <code>Msg</code> that they want to receive back.</p>
<p>The Rust-side of the platform would have to be able to apply the constructor given by the user to the result of the effect. That means it would have to know the types involved, which means you would have to write glue code for every effect that you expose (please correct me if I'm wrong, I don't know much about Roc/Rust interop).</p>
<p>My idea was to skip the glue code by boxing the constructor and its argument and doing the application in Roc. Then you'd have minimal glue. I just don't know enough to figure out how to box a function, pass it to Rust, pass it back to Roc, unbox it, and apply it to a value.</p>



<a name="519064904"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/519064904" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#519064904">(May 19 2025 at 10:31)</a>:</h4>
<p>It definitely wouldn't need to know the types, if the Roc platform code handles calling the hosted functions. so you would do a when on the Cmd type, calling the appropriate hosted function for each and then calling the passed in lambda in the Roc code with the value returned from the hosted function and then return that result</p>



<a name="519071800"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/519071800" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#519071800">(May 19 2025 at 11:00)</a>:</h4>
<p>Indeed, but isn't that limited to synchronous effects?</p>



<a name="519076501"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/519076501" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#519076501">(May 19 2025 at 11:19)</a>:</h4>
<p>not if your runtime is asynchronous</p>



<a name="519175450"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/519175450" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> sasiki <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#519175450">(May 19 2025 at 17:20)</a>:</h4>
<p>I'm in the browser with WASM, so I believe I'm quite restricted when it comes to async. I can't block at all, so to make an HTTP request for example I'd need to use <code>wasm_bindgen_futures::spawn_local</code> which returns unit immediately and runs the async block you give it in the background. To get the result of the HTTP request I'd need to call another function within the async block (i.e. a callback). Here's an example from Yew:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasm_bindgen_futures</span><span class="p">::</span><span class="n">spawn_local</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="kd">let</span><span class="w"> </span><span class="n">fetched_videos</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Video</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Request</span><span class="p">::</span><span class="n">get</span><span class="p">(</span><span class="s">"https://yew.rs/tutorial/data.json"</span><span class="p">)</span>
<span class="w">       </span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="w">       </span><span class="p">.</span><span class="k">await</span>
<span class="w">       </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">       </span><span class="p">.</span><span class="n">json</span><span class="p">()</span>
<span class="w">       </span><span class="p">.</span><span class="k">await</span>
<span class="w">       </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">   </span><span class="n">videos</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">fetched_videos</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>So IIUC the Rust host function wouldn't be able to return the HTTP result directly. It would have to call another Roc host function with the result, but it would also have to pass along the <code>Msg</code> constructor so that the Roc host function can apply the constructor to the result of the HTTP request. Am I making sense?</p>



<a name="519179676"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/519179676" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anthony Bullard <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#519179676">(May 19 2025 at 17:38)</a>:</h4>
<p>oh sorry i didn't catch the WASM context. i don't really think i could help there</p>



<a name="520196448"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520196448" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520196448">(May 24 2025 at 13:13)</a>:</h4>
<p>I have had this need as well of passing a function to a rust host and calling it again</p>
<p>Here's a minimal repo where I attempt to isolate the simplest possible example of this: <a href="https://github.com/kamenchunathan/platform_tests">https://github.com/kamenchunathan/platform_tests</a></p>



<a name="520204267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520204267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520204267">(May 24 2025 at 14:53)</a>:</h4>
<p>Maybe there's a way around it but I do not see a way to design around these specific limitations without being able to box functions or type constructors which I assume to be the same implementation-wise</p>



<a name="520204497"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520204497" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520204497">(May 24 2025 at 14:56)</a>:</h4>
<p>This platform is a simple platform that isolates passing a function through the boundary<br>
Looking at the llvm IR for the compilation of the following user application code, </p>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>app [
    store,
    use!,
    Store,
] { pf: platform "../platform/main.roc" }

import pf.Effects exposing [print!]

Store : I32 -&gt; I32

store : Store
store = |_| 42069

use! : Store =&gt; {}
use! = |fs|
    print! (Inspect.to_str (fs 89787))
    {}
</code></pre></div>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc__store_for_host_1_exposed_generic</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">)</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!9</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%call</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@"_store_for_host!_99e2ebbd98e8a2a4c7ed9bd71d205d9f7b5d7e7a9ddb68dab65f2ad1c2198b"</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!10</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%call</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!10</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!10</span>
<span class="p">}</span>

<span class="k">define</span><span class="w"> </span><span class="k">internal</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@"_store_for_host!_99e2ebbd98e8a2a4c7ed9bd71d205d9f7b5d7e7a9ddb68dab65f2ad1c2198b"</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%"4"</span><span class="p">)</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!3</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%call</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="vg">@Box_box_f03bf86f79d121cbfd774dec4a65912e99f5f17c33852bbc45e81916e62b53b</span><span class="p">({}</span><span class="w"> </span><span class="k">zeroinitializer</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!7</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv">%call</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!7</span>
<span class="p">}</span>
</code></pre></div>
<p>roc seems to box a default zeroinitialized value and then create a separate function </p>
<div class="codehilite" data-code-language="LLVM"><pre><span></span><code><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@roc__use_for_host_0_caller</span><span class="p">(</span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nl">entry:</span>
<span class="w">  </span><span class="nv">%load_param</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">load</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%0</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!51</span>
<span class="w">  </span><span class="nv">%call</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="k">fastcc</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@_10_4e123451c288c52798d3df0fc84811d2d957f324242982575c70dfd6d338df</span><span class="p">(</span><span class="kt">i32</span><span class="w"> </span><span class="nv">%load_param</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%1</span><span class="p">),</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!51</span>
<span class="w">  </span><span class="k">store</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%call</span><span class="p">,</span><span class="w"> </span><span class="kt">ptr</span><span class="w"> </span><span class="nv nv-Anonymous">%2</span><span class="p">,</span><span class="w"> </span><span class="k">align</span><span class="w"> </span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!51</span>
<span class="w">  </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span><span class="p">,</span><span class="w"> </span><span class="nv">!dbg</span><span class="w"> </span><span class="nv nv-Anonymous">!51</span>
<span class="p">}</span>
</code></pre></div>
<p>If I understood <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> what you were saying is that this function is meant to be callable by the host, but wouldn't this require compile time linkage?</p>
<p>I'm also not too experienced in reading llvm IR so if I've made any wrong assumptions I'd appreciate being corrected</p>



<a name="520213334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520213334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520213334">(May 24 2025 at 16:56)</a>:</h4>
<p>Yeah, so that function is callable from the host.</p>



<a name="520213357"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520213357" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520213357">(May 24 2025 at 16:56)</a>:</h4>
<p>We expose a static function. The function takes all of the closure captures along with the standard arguments</p>



<a name="520213402"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520213402" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520213402">(May 24 2025 at 16:57)</a>:</h4>
<p>The captures are the default zeroinitialized value you are seeing. Cause this case has not captures.</p>



<a name="520367288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520367288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520367288">(May 26 2025 at 06:24)</a>:</h4>
<p>Updated the code in the repo to have the following control flow<br>
the platform passes a callback to the rust host, the rust host calls the callback with the appropriate arguments and gets the <code>Msg</code> type from the callbacks return, the calls the roc platform code again with this <code>Msg</code> type.</p>
<p>Here's the relevant code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Captures</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_data</span><span class="p">:</span><span class="w"> </span><span class="p">(),</span>
<span class="w">    </span><span class="n">_marker</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">marker</span><span class="p">::</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">marker</span><span class="p">::</span><span class="n">PhantomPinned</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[repr(C)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">_data</span><span class="p">:</span><span class="w"> </span><span class="p">(),</span>
<span class="w">    </span><span class="n">_marker</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">marker</span><span class="p">::</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="p">(</span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">marker</span><span class="p">::</span><span class="n">PhantomPinned</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_roc_setup_callback</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Captures</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__setup_callback_for_host_1_exposed_generic"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">caller</span><span class="p">(</span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Captures</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">);</span>

<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__setup_callback_for_host_1_exposed_size"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">size</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">captures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roc_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Captures</span><span class="p">;</span>
<span class="w">        </span><span class="n">caller</span><span class="p">(</span><span class="n">captures</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="n">captures</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Captures</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_roc_callback</span><span class="p">(</span><span class="n">captures</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Captures</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__setup_callback_for_host_0_caller"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">caller</span><span class="p">(</span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Captures</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Msg</span><span class="p">);</span>

<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__setup_callback_for_host_0_result_size"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">size</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">isize</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">();</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"msg size: {msg_size}"</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">msg_size</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="p">::</span><span class="n">ptr</span><span class="p">::</span><span class="n">NonNull</span><span class="p">::</span><span class="n">dangling</span><span class="p">().</span><span class="n">as_ptr</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">roc_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="n">Msg</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="n">caller</span><span class="p">(</span><span class="o">&amp;</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">captures</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">);</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"wow"</span><span class="p">);</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Msg</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_roc_handle_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cp">#[link_name = </span><span class="s">"roc__handle_callback_for_host_1_exposed"</span><span class="cp">]</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">caller</span><span class="p">(</span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">Msg</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">caller</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">rust_main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">captures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roc</span><span class="p">::</span><span class="n">call_roc_setup_callback</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">roc</span><span class="p">::</span><span class="n">call_roc_callback</span><span class="p">(</span><span class="n">captures</span><span class="p">);</span>
<span class="w">    </span><span class="n">roc</span><span class="p">::</span><span class="n">call_roc_handle_callback</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>

<span class="w">    </span><span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="roc"><pre><span></span><code>platform "wow" requires { Msg } {
        on_event : Event -&gt; Msg,
        handle! : Msg =&gt; {},
    }
    exposes [Effects, Event]
    packages {
    }
    imports []
    provides [
        setup_callback_for_host!,
        handle_callback_for_host!,
    ]

import Event exposing [Event]

setup_callback_for_host! : I32 =&gt; (Event -&gt; Box Msg)
setup_callback_for_host! = |_|
    wrapped = |e| Box.box (on_event e)
    wrapped

handle_callback_for_host! : Box Msg =&gt; {}
handle_callback_for_host! = |boxed_msg|
    msg = Box.unbox boxed_msg
    handle! msg
</code></pre></div>



<a name="520368073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520368073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520368073">(May 26 2025 at 06:31)</a>:</h4>
<p>This code however has issues in passing the Boxed result to and fro the host and platform, <br>
the <code>roc__setup_callback_for_host_0_caller</code> seems to only be able to take a pointer to the result,  what's the recommended way of creating a <code>RocBox&lt;T&gt;</code> in host code</p>



<a name="520473420"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520473420" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520473420">(May 26 2025 at 14:54)</a>:</h4>
<p>I think you can make the function take a <code>*mut *mut void</code>. Then call it while passing in a reference to a <code>*mut void</code> on the stack as a local variable. That should get you the boxes pointer. Sine rust is just passing the box back into roc, no need to have the host even know it is a box. Just passing that into the other roc function.</p>



<a name="520473702"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520473702" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520473702">(May 26 2025 at 14:56)</a>:</h4>
<p>I believe that is how boxes with at least in the generic caller functions, but would need to double check</p>



<a name="520487213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520487213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520487213">(May 26 2025 at 16:01)</a>:</h4>
<p>This works for types that do not allocate, but roc string, and lists seem to go to the default value when they are passed back to the roc platform code from the host<br>
What could be the cause of this</p>



<a name="520491129"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520491129" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520491129">(May 26 2025 at 16:23)</a>:</h4>
<p>When in a message that is based and sent to the host or when directly passed to the host?</p>



<a name="520491184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520491184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520491184">(May 26 2025 at 16:23)</a>:</h4>
<p>And is the host only passing it back once or many times?</p>



<a name="520625682"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Send%20a%20Roc%20function%20to%20the%20host%20and%20back/near/520625682" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathan Kamenchu <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Send.20a.20Roc.20function.20to.20the.20host.20and.20back.html#520625682">(May 27 2025 at 09:46)</a>:</h4>
<p>Was actually an FFI issue where I didn't dereference the pointer to the box hence it was passing in garbage memory to the callback. <br>
I don't know how I didn't notice the value types constantly changin</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>✔ Memory layout for tags &amp; records · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html">✔ Memory layout for tags &amp; records</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="486617833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486617833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486617833">(Dec 07 2024 at 01:05)</a>:</h4>
<p>Do we have anything written down about how Roc stores tags and records in memory? I'm debugging some Rust platform structs, unions, and enums, and I'm starting to get lost in a guess-and-check approach to which bytes store what. I could post snippets and errors, but I want to start by making sure I've read everything I need to know.</p>



<a name="486618264"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618264" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618264">(Dec 07 2024 at 01:11)</a>:</h4>
<p>For example, I'm refactoring some code I copied from someone else that does a lot of</p>
<div class="codehilite"><pre><span></span><code>unsafe {
    let bytes = core::mem::transmute::&lt;&amp;Self, &amp;[u8; core::mem::size_of::&lt;Self&gt;()]&gt;(self);
    core::mem::transmute::&lt;u8, FooTagRepresentationDiscriminant&gt;(*bytes.as_ptr().add(2));
}
</code></pre></div>
<p>and my <code>main</code>'s return value is sometimes filled with random bits (seemingly leftover from other programs), sometimes requesting exabytes of storage.</p>



<a name="486618391"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618391" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618391">(Dec 07 2024 at 01:13)</a>:</h4>
<p>I'm also curious if it's considered best practice to represent a Roc tag with a Rust struct+union instead of a Rust enum, since enum seems simpler if I could find a way to map the memory properly.</p>



<a name="486618671"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618671" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618671">(Dec 07 2024 at 01:17)</a>:</h4>
<p>I highly recommend using <code>RustGlue.roc</code> and generating any glue you need to interface with roc</p>



<a name="486618761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618761">(Dec 07 2024 at 01:18)</a>:</h4>
<p>Ooh, what's that and how do I use it?</p>



<a name="486618797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618797">(Dec 07 2024 at 01:19)</a>:</h4>
<p>So far I've been refactoring that copied Rust code by hand.</p>



<a name="486618886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618886">(Dec 07 2024 at 01:20)</a>:</h4>
<p>If you run </p>
<div class="codehilite"><pre><span></span><code>$ roc glue ../roc/crates/glue/src/RustGlue.roc generated platform/main.roc
</code></pre></div>
<p>In the roc-on-simple repo you will see it generates all the glue rust code for the platform in the <code>generated/</code> folder</p>



<a name="486618935"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618935" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618935">(Dec 07 2024 at 01:20)</a>:</h4>
<p>I used that, and copy pasted bits and then cleaned it up by hand (for aesthetic reasons mostly and removing unneeded stuff) for the example</p>



<a name="486618941"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618941" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618941">(Dec 07 2024 at 01:21)</a>:</h4>
<p>Ah, so it's a script that lives in the roc-lang/roc repo?</p>



<a name="486618959"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486618959" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486618959">(Dec 07 2024 at 01:21)</a>:</h4>
<p>I've never run the <code>roc glue</code> subcommand before - I'll read the docs for that too.</p>



<a name="486619042"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619042" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619042">(Dec 07 2024 at 01:22)</a>:</h4>
<p>Yeah, a plugin that the roc compiler uses to generate code. You give the script to the subcommand <code>roc glue</code>, the compiler will parse the platform and provide the types to the script which it then uses to generate the rust code. </p>
<p>In future we'll have a script that generated C, Zig, Go etc... but they are being worked on in various states of development</p>



<a name="486619062"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619062" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619062">(Dec 07 2024 at 01:22)</a>:</h4>
<p>Is this considered a key toolkit for platform developers? Where in the docs should this recommendation live? Control+F yields no results for "glue" in the tutorial or platform dev doc webpages.</p>



<a name="486619095"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619095" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619095">(Dec 07 2024 at 01:23)</a>:</h4>
<p>It should probably live here I think <a href="https://www.roc-lang.org/docs#language-reference">https://www.roc-lang.org/docs#language-reference</a> in some kind of guide</p>



<a name="486619153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619153">(Dec 07 2024 at 01:24)</a>:</h4>
<p>But, the platform dev stuff is still heavily in flux, so it's not something we have prioritised</p>



<a name="486619183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619183">(Dec 07 2024 at 01:24)</a>:</h4>
<p>Sweet, I'll open an issue to document it, if that issue doesn't already exist.</p>



<a name="486619311"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619311" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619311">(Dec 07 2024 at 01:26)</a>:</h4>
<p>I created <a href="https://github.com/roc-lang/roc/issues/7315">https://github.com/roc-lang/roc/issues/7315</a></p>



<a name="486619327"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619327" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619327">(Dec 07 2024 at 01:26)</a>:</h4>
<p>Some important things off the top of my head </p>
<ol>
<li>modernise <code>expect</code> to use a host provided function</li>
<li>remove shared memory infrastructure</li>
<li>passed in allocators</li>
<li>keep <code>dbg</code>'s and <code>expect</code>'s in with <code>build --no-link</code></li>
<li>effect interpreters</li>
<li>reliable RustGlue.roc generation for entrypoints</li>
</ol>



<a name="486619371"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619371" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619371">(Dec 07 2024 at 01:27)</a>:</h4>
<p>These are higher priorities? Or things I should add to the issue? Or steps I should follow?</p>



<a name="486619387"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619387" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619387">(Dec 07 2024 at 01:27)</a>:</h4>
<p>I think the next big upgrade will be landing the LLVM / Zig upgrade.</p>



<a name="486619441"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619441" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619441">(Dec 07 2024 at 01:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/486619371">said</a>:</p>
<blockquote>
<p>These are higher priorities? Or things I should add to the issue? Or steps I should follow?</p>
</blockquote>
<p>Just things in the pipeline, on the road to having a sensible platform development experience</p>



<a name="486619463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619463">(Dec 07 2024 at 01:28)</a>:</h4>
<p>At the moment platform authors have to do some strange things to workaround these issues.</p>



<a name="486619559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619559">(Dec 07 2024 at 01:30)</a>:</h4>
<p>I'm hoping that once I get one complex nested return value working, I can live in .roc land again.</p>



<a name="486619568"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619568" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619568">(Dec 07 2024 at 01:30)</a>:</h4>
<p>I wouldn't encourage people to build platforms at the moment unless they are comfortable working with things that are WIP and in flux</p>



<a name="486619750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486619750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486619750">(Dec 07 2024 at 01:32)</a>:</h4>
<p>If I don't want to do more than day or two of development around memory management, would you recommend pivoting from a "nested return value" approach to a ".json files on disk are my Roc-Rust communication protocol" approach?</p>



<a name="486620632"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486620632" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486620632">(Dec 07 2024 at 01:42)</a>:</h4>
<p>First thought after running <code>roc glue</code> ohhh I wonder if I've been refactoring code that was generated for a different system architecture than my laptop...</p>



<a name="486620969"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486620969" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486620969">(Dec 07 2024 at 01:46)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/stream/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/486619327">said</a>:</p>
<blockquote>
<ol start="5">
<li>effect interpreters</li>
</ol>
</blockquote>
<p>I'd say this one is off the priority list and on the "open design question as to whether we should still do it" list <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="486622181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622181">(Dec 07 2024 at 02:04)</a>:</h4>
<p>Okay. Since I'm okay with flux but still a Rustling, does that mean y'all do recommend I use JSON files as my Roc-Rust interface?</p>



<a name="486622227"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622227" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622227">(Dec 07 2024 at 02:05)</a>:</h4>
<p>Btw <code>roc glue</code> seems to be working well so far - now debugging why <code>const _SIZE_CHECK_union_Timing: () = assert!(core::mem::size_of::&lt;union_Timing&gt;() == 4);</code> is erroring.</p>



<a name="486622375"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622375" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622375">(Dec 07 2024 at 02:07)</a>:</h4>
<p>I feel like my primary obstacle at the point is not knowing what I don't know, for which I don't see a clear unblocker that doesn't include calling for help in Zulip every day :/</p>



<a name="486622379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622379">(Dec 07 2024 at 02:07)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/486622227">said</a>:</p>
<blockquote>
<p>Btw <code>roc glue</code> seems to be working well so far - now debugging why <code>const _SIZE_CHECK_union_Timing: () = assert!(core::mem::size_of::&lt;union_Timing&gt;() == 4);</code> is erroring.</p>
</blockquote>
<p>This is a known issue. The generated code is just wrong. See <a href="https://github.com/roc-lang/roc/issues/6012">https://github.com/roc-lang/roc/issues/6012</a></p>



<a name="486622596"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622596" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622596">(Dec 07 2024 at 02:10)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/486622181">said</a>:</p>
<blockquote>
<p>Okay. Since I'm okay with flux but still a Rustling, does that mean y'all do recommend I use JSON files as my Roc-Rust interface?</p>
</blockquote>
<p>To be clear, I'm asking this question earnestly - it seems like a sad but viable alternate path.</p>



<a name="486622634"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622634" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622634">(Dec 07 2024 at 02:11)</a>:</h4>
<p>Is the roc-on simple not what you needed?</p>



<a name="486622645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622645">(Dec 07 2024 at 02:11)</a>:</h4>
<p>I wouldn't recommend JSON, we have nice things. I'm happy to help you get the API right</p>



<a name="486622717"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622717" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622717">(Dec 07 2024 at 02:12)</a>:</h4>
<p>It looks like exactly what I need, I'm just getting what seems like random memory access lol</p>



<a name="486622722"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622722" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622722">(Dec 07 2024 at 02:12)</a>:</h4>
<p>Once we have the glue and entrypoints sorted, that's all the messy unsafe and FFI stuff out of the way and Rust is pretty nice and high level to work with</p>



<a name="486622760"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622760" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622760">(Dec 07 2024 at 02:13)</a>:</h4>
<p>Sweet, want me to DM you for a synchronous session?</p>



<a name="486622761"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622761" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622761">(Dec 07 2024 at 02:13)</a>:</h4>
<blockquote>
<p>I'm just getting what seems like random memory access </p>
</blockquote>
<p>Can you share a commit?</p>



<a name="486622766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622766">(Dec 07 2024 at 02:13)</a>:</h4>
<p>Happily!</p>



<a name="486622796"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622796" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622796">(Dec 07 2024 at 02:13)</a>:</h4>
<p>Also, was that glue code you sent me arch-agnostic?</p>



<a name="486622996"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486622996" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486622996">(Dec 07 2024 at 02:16)</a>:</h4>
<p>With this script <a href="https://gitlab.com/JanCVanB/roc-on/-/blob/5ee69ed8b24b7ef2311bdd3519fa7dbb042ab140/examples/memory_testing.roc">https://gitlab.com/JanCVanB/roc-on/-/blob/5ee69ed8b24b7ef2311bdd3519fa7dbb042ab140/examples/memory_testing.roc</a><br>
and some injected <code>println</code>s, I get inconsistent output like this</p>
<div class="codehilite"><pre><span></span><code>[jan@framey roc-on]$ roc examples/memory_testing.roc
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
roc  format = Format::SingleTrack
Timing size_of = 4
Timing bytes   = [243, 56, 123, 85]
Timing as_ptr  = 243
Timing as_ptr  = 243
Timing .add(2) = 123
TimingDiscrimi = discriminant_Timing::Timecode
roc  t d    = discriminant_Timing::Timecode
roc  t pl m = 21883
roc  t pl t = TimingTimecode { f0: upgradeupgrade-i, f1: 85 }
rust format = Parallel
rust timing = Timecode(Selec, 86)
[jan@framey roc-on]$
[jan@framey roc-on]$
[jan@framey roc-on]$
[jan@framey roc-on]$ roc examples/memory_testing.roc
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
roc  format = Format::SingleTrack
Timing size_of = 4
Timing bytes   = [35, 125, 183, 85]
Timing as_ptr  = 35
Timing as_ptr  = 35
Timing .add(2) = 183
TimingDiscrimi = discriminant_Timing::Timecode
roc  t d    = discriminant_Timing::Timecode
roc  t pl m = 21943
roc  t pl t = TimingTimecode { f0: SelectedDifferen, f1: 85 }
rust format = Parallel
rust timing = Timecode(Unkno, 85)
[jan@framey roc-on]$
</code></pre></div>
<p>In particular, I'm looking at the mis-mapping of</p>
<div class="codehilite"><pre><span></span><code>roc  format = Format::SingleTrack
...
rust format = Parallel
</code></pre></div>
<p>and the flakiness of</p>
<div class="codehilite"><pre><span></span><code>rust timing = Timecode(Selec, 86)
rust timing = Timecode(Unkno, 85)
</code></pre></div>



<a name="486623153"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623153" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623153">(Dec 07 2024 at 02:18)</a>:</h4>
<p>My refactoring included renaming things, reordering struct field order, and other housekeeping things like that. I'm happy to revert any of that, if the glue code really doesn't like being touched.</p>



<a name="486623172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623172">(Dec 07 2024 at 02:18)</a>:</h4>
<p>Even with original struct field order, though, it seemed to have random noise.</p>



<a name="486623200"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623200" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623200">(Dec 07 2024 at 02:19)</a>:</h4>
<p>At a higher level, though, I'm still curious why we use struct+union instead of enum to represent a tag - enum seems safer.</p>



<a name="486623302"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623302" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623302">(Dec 07 2024 at 02:20)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/486622796">said</a>:</p>
<blockquote>
<p>Also, was that glue code you sent me arch-agnostic?</p>
</blockquote>
<p>Should be I think</p>



<a name="486623334"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623334" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623334">(Dec 07 2024 at 02:21)</a>:</h4>
<p>Maybe not WASM ... <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span></p>



<a name="486623417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623417">(Dec 07 2024 at 02:22)</a>:</h4>
<blockquote>
<p>reordering struct field order</p>
</blockquote>
<p>You can't change the structs like this as the ordering has to match what Roc uses</p>



<a name="486623429"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623429" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623429">(Dec 07 2024 at 02:22)</a>:</h4>
<p>If it would make it easier to keep up with glue pattern updates, I'm happy to have a script generate (and patch with grep/sed) the glue code and just leave it as-is.</p>



<a name="486623444"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623444" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623444">(Dec 07 2024 at 02:22)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/486623417">said</a>:</p>
<blockquote>
<blockquote>
<p>reordering struct field order</p>
</blockquote>
<p>You can't change the structs like this as the ordering has to match what Roc uses</p>
</blockquote>
<p>Heard. Is Roc's ordering written down somewhere?</p>



<a name="486623461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623461">(Dec 07 2024 at 02:23)</a>:</h4>
<p>It's alignment, then alphabetical.</p>



<a name="486623471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623471">(Dec 07 2024 at 02:23)</a>:</h4>
<p>Best just to use RustGlue and not change the order or size of things</p>



<a name="486623540"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623540" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623540">(Dec 07 2024 at 02:24)</a>:</h4>
<p><code>alpha_sort("alignment") &lt; alpha_sort("alphabetical") == true</code> <span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span></p>



<a name="486623575"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623575" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623575">(Dec 07 2024 at 02:25)</a>:</h4>
<p>Sweet. I'll continue down the path of regenerating all of this with <code>roc glue ...</code> and hopefully finding sed-based fixes for every error that pops up.</p>



<a name="486623595"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623595" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623595">(Dec 07 2024 at 02:25)</a>:</h4>
<p>for hashtag declarative programming</p>



<a name="486623605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623605">(Dec 07 2024 at 02:25)</a>:</h4>
<p>I don't understand why you're not just using roc-on-simple?</p>



<a name="486623612"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623612" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623612">(Dec 07 2024 at 02:25)</a>:</h4>
<p>That was a working foundation, and then you can extend it</p>



<a name="486623658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623658">(Dec 07 2024 at 02:26)</a>:</h4>
<p>Adding effects as you need them etc</p>



<a name="486623661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623661">(Dec 07 2024 at 02:26)</a>:</h4>
<p>In what way, like subrepo? Copy/paste/donttouch?</p>



<a name="486623666"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623666" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623666">(Dec 07 2024 at 02:26)</a>:</h4>
<p>Copy-paste the whole thing</p>



<a name="486623685"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623685" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623685">(Dec 07 2024 at 02:26)</a>:</h4>
<p>I have to minimally adapt it for non-PI</p>



<a name="486623691"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623691" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623691">(Dec 07 2024 at 02:26)</a>:</h4>
<p>for compatibility with basic-cli foundation</p>



<a name="486623708"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623708" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623708">(Dec 07 2024 at 02:27)</a>:</h4>
<p>but I don't have to refactor as much as my first instinct was to</p>



<a name="486623729"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623729" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623729">(Dec 07 2024 at 02:27)</a>:</h4>
<p>I'll see if it works with only PI removal</p>



<a name="486623750"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623750" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623750">(Dec 07 2024 at 02:27)</a>:</h4>
<p>What do you need from basic-cli?</p>



<a name="486623832"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623832" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623832">(Dec 07 2024 at 02:28)</a>:</h4>
<p>It would be much easier to add that into roc-on-simple than to add the midi glue types into basic-cli. I specifically set up roc-on-simple in a way that avoids a lot of unneeded complexity around building the host. -- and gives you Windows, WASI support out of the box etc</p>



<a name="486623833"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623833" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623833">(Dec 07 2024 at 02:28)</a>:</h4>
<p>File IO, soon HTTP</p>



<a name="486623934"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623934" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623934">(Dec 07 2024 at 02:30)</a>:</h4>
<p>Ohhh I didn't realize you offered that code as a rebase target</p>



<a name="486623936"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623936" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623936">(Dec 07 2024 at 02:30)</a>:</h4>
<p>Ahk... I'll add a file <code>read!</code> and HTTP <code>send!</code> effect in for you as an example.</p>



<a name="486623961"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486623961" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486623961">(Dec 07 2024 at 02:30)</a>:</h4>
<p>Hmmm I'd rather base on something community-maintained</p>



<a name="486624121"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624121" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624121">(Dec 07 2024 at 02:32)</a>:</h4>
<p>I'm not sure what you mean about community maintained. Are you concerned about rust http library or reading files? That's mostly rust std library stuff</p>



<a name="486624268"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624268" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624268">(Dec 07 2024 at 02:34)</a>:</h4>
<p>I basically just want to use basic-cli but also pass a complex value from Roc to Rust, so it doesn't make sense to me to start from scratch.</p>



<a name="486624304"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624304" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624304">(Dec 07 2024 at 02:35)</a>:</h4>
<p>If basic-cli supported an arbitrary return value, I'd never have thought to make my own platform in the first place.</p>



<a name="486624488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624488">(Dec 07 2024 at 02:37)</a>:</h4>
<p>Well, maybe not true - I might've still decided to extend basic-cli to use the return value for the next steps.</p>



<a name="486624586"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624586" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624586">(Dec 07 2024 at 02:39)</a>:</h4>
<p>Regardless, I see platforms as large and complex, and it'd be nice to only have to edit my own little corner of one, while merging in features from the upstream foundation.</p>



<a name="486624630"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624630" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624630">(Dec 07 2024 at 02:39)</a>:</h4>
<p>I guess the challenge here is that basic-cli start up, calls into roc which runs through to completion and then exits.</p>



<a name="486624692"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624692" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624692">(Dec 07 2024 at 02:40)</a>:</h4>
<p>Roc does various effects along the way.</p>



<a name="486624723"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624723" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624723">(Dec 07 2024 at 02:40)</a>:</h4>
<p>Is that the same pattern you want for this? what API are you thinking of? </p>
<div class="codehilite"><pre><span></span><code>main : Task Smf [SomeErrors]

# with PI
main! : {} =&gt; Result Smf [SomeErrors]
</code></pre></div>
<p>or similar?</p>



<a name="486624771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624771">(Dec 07 2024 at 02:41)</a>:</h4>
<p>Yeah, for now pretty much!</p>



<a name="486624818"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624818" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624818">(Dec 07 2024 at 02:42)</a>:</h4>
<p>Or maybe, you are thinking of adding a new custom effect to basic-cli, like <code>MIDI.send : Smf -&gt; Task {} {}</code>?</p>



<a name="486624848"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624848" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624848">(Dec 07 2024 at 02:42)</a>:</h4>
<p>In the future, I hope for something long-running and interacting, receiving input streams and processing them into output streams</p>



<a name="486624849"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624849" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624849">(Dec 07 2024 at 02:42)</a>:</h4>
<p>What happens with the <code>Smf</code> thing once rust gets it?</p>



<a name="486624874"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624874" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624874">(Dec 07 2024 at 02:43)</a>:</h4>
<p>but for now just Roc writes a MIDI file in memory, Rust receives that and both performs it and writes it to disk</p>



<a name="486624983"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486624983" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486624983">(Dec 07 2024 at 02:45)</a>:</h4>
<blockquote>
<p>for now just Roc writes a MIDI file in memory, Rust receives that and both performs it and writes it to disk</p>
</blockquote>
<p>For this, I'd just fork basic-cli make a branch and add a single effect like <code>MIDI.doThing : Smf -&gt; Task {} {}</code>.</p>
<blockquote>
<p>In the future, I hope for something long-running and interacting, receiving input streams and processing them into output streams</p>
</blockquote>
<p>For this, you will want a custom platform like roc-on-simple</p>



<a name="486625101"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625101" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625101">(Dec 07 2024 at 02:46)</a>:</h4>
<p>Oh, are you saying that it's easier to pass a complex data type in memory from Roc to Rust during an effect instead of at return time?</p>



<a name="486625235"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625235" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625235">(Dec 07 2024 at 02:48)</a>:</h4>
<p>Yes it's much easier. Your just writing a single function in rust <code>roc__fx_doThing(...)</code> instead of messing around with entrypoints and all that</p>



<a name="486625280"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625280" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625280">(Dec 07 2024 at 02:48)</a>:</h4>
<p>The rust glue we wrote for <code>Smf</code> in roc-on-simple can be copied and pasted across and everything should just work <span aria-label="fingers crossed" class="emoji emoji-1f91e" role="img" title="fingers crossed">:fingers_crossed:</span></p>



<a name="486625319"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625319" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625319">(Dec 07 2024 at 02:49)</a>:</h4>
<p>1sec I'll make a branch for you</p>



<a name="486625557"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625557" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625557">(Dec 07 2024 at 02:52)</a>:</h4>
<p>Working on it right now, wait one min :)</p>



<a name="486625563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625563">(Dec 07 2024 at 02:52)</a>:</h4>
<p>I've been alt tabbing for the last ten min</p>



<a name="486625583"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625583" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625583">(Dec 07 2024 at 02:53)</a>:</h4>
<p>Oh wait, nvm, for a return value copy/paste, not an effect</p>



<a name="486625592"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625592" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625592">(Dec 07 2024 at 02:53)</a>:</h4>
<p><span class="user-mention silent" data-user-id="515757">Luke Boswell</span> <a href="#narrow/channel/231634-beginners/topic/Memory.20layout.20for.20tags.20.26.20records/near/486625235">said</a>:</p>
<blockquote>
<p>Yes it's much easier. Your just writing a single function in rust <code>roc__fx_doThing(...)</code> instead of messing around with entrypoints and all that</p>
</blockquote>
<p>This is surprising and wonderful news!!!</p>



<a name="486625648"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625648" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625648">(Dec 07 2024 at 02:54)</a>:</h4>
<p>I expect the memory errors will be the same situation, though, so I shouldn't touch glue code.</p>



<a name="486625980"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486625980" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486625980">(Dec 07 2024 at 02:59)</a>:</h4>
<p>Alright, here's my minimal repro of some kinda memory bug:<br>
<a href="https://gitlab.com/JanCVanB/roc-on/-/tree/return_smf_2">https://gitlab.com/JanCVanB/roc-on/-/tree/return_smf_2</a></p>
<div class="codehilite"><pre><span></span><code>app [main] { rocOn: platform &quot;../platform/main.roc&quot; }

main =
    Task.ok {
        format: Parallel,
        timing: Metrical 10,
    }
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[jan@framey roc-on]$ ./run_memory_test.sh
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
INFO: Checking provided roc; executing `roc version`:
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
roc nightly pre-release, built from commit d782542 on Mi 04 Dez 2024 09:02:14 UTC
INFO: Getting the native operating system and architecture ...
INFO: Building stubbed app shared library ...
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
0 errors and 0 warnings found in 258 ms
 while successfully building:

    platform/libapp.so
INFO: Building rust host ...
warning: skipping duplicate package `host` found at `/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/cli/false-interpreter/platform`
warning: skipping duplicate package `host` found at `/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/glue/rust-platform`
warning: skipping duplicate package `host` found at `/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/platform-switching/rust-platform`
    Finished `release` profile [optimized] target(s) in 0.08s
INFO: Failed to get env var CARGO_BUILD_TARGET with error VarNotFound. Assuming default CARGO_BUILD_TARGET (native)...
INFO: Moving the prebuilt binary from target/release/libhost.a to platform/linux-x64.a ...
INFO: Preprocessing surgical host ...
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
INFO: Successfully built platform files!



roc: /lib64/libtinfo.so.6: no version information available (required by roc)
roc  format   = Format::SingleTrack
roc  timing m = 35456
roc  timing t = TimingTimecode { f0: www-authenticate, f1: 138 }
rust format   = Parallel
rust timing   = Metrical(u15(2688))
[jan@framey roc-on]$
</code></pre></div>



<a name="486626002"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626002" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626002">(Dec 07 2024 at 02:59)</a>:</h4>
<p>This shouldn't have any refactoring nonsense in it, just minimal integration of roc-on-simple with roc-on. I'll double check that's correct...</p>



<a name="486626141"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626141" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626141">(Dec 07 2024 at 03:01)</a>:</h4>
<p>Confirmed - no struct field reordering or anything that seems memory-messy</p>



<a name="486626159"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626159" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626159">(Dec 07 2024 at 03:01)</a>:</h4>
<p><code>www-authenticate</code> seems like random memory access</p>



<a name="486626243"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626243" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626243">(Dec 07 2024 at 03:02)</a>:</h4>
<p>(though I've seen it appear many times, so maybe it's a consistently-adjacent piece of memory)</p>



<a name="486626288"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626288" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626288">(Dec 07 2024 at 03:02)</a>:</h4>
<p>I can return to the new work of generating my own glue instead of copying it from roc-on-simple, though</p>



<a name="486626412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626412">(Dec 07 2024 at 03:04)</a>:</h4>
<p>If you're working on an example of adding an effect being easier than adding a return value, I'm very interested.</p>



<a name="486626712"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626712" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626712">(Dec 07 2024 at 03:08)</a>:</h4>
<p>Here you go <a href="https://github.com/lukewilliamboswell/basic-cli/tree/roc-on">https://github.com/lukewilliamboswell/basic-cli/tree/roc-on</a></p>



<a name="486626886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486626886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486626886">(Dec 07 2024 at 03:09)</a>:</h4>
<p>You should be able to check that out then, </p>
<div class="codehilite"><pre><span></span><code>$ roc build.roc # to build the host
$ roc examples/midi.roc
</code></pre></div>



<a name="486627066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486627066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486627066">(Dec 07 2024 at 03:11)</a>:</h4>
<p>It's not fully working for me either... so we've got a bug somewhere in the glue, which is what you were pointing out above I think. </p>
<div class="codehilite"><pre><span></span><code>$ roc examples/midi.roc
[crates/roc_host/src/lib.rs:1407:5] smf = Smf {
    tracks: [
        [],
        [],
        [
            TrackEvent {
                kind: TrackEventKind {
                    payload: UnionTrackEventKind,
                    discriminant: %                                                                                    14:10:36 ~/Documents/GitHub/basic-cli roc-on $
</code></pre></div>



<a name="486627164"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486627164" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486627164">(Dec 07 2024 at 03:12)</a>:</h4>
<p>The challenge here is that <code>Smf</code> is a really large struct with nested things... so we might want to modify the effect to take the smaller parts and test them one by one, working up to the aggregate <code>Smf</code> type</p>



<a name="486627282"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486627282" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486627282">(Dec 07 2024 at 03:14)</a>:</h4>
<p>That's what I've done in my example above, just using <code>Header</code> - does that also bug out for you?</p>



<a name="486627289"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486627289" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486627289">(Dec 07 2024 at 03:14)</a>:</h4>
<p>The other options to find the issue here are probably running in a debugger like <code>lldb</code>, running with valgrind on linux, generating the LLVM IR from the app and then inspecting that.</p>



<a name="486627323"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486627323" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486627323">(Dec 07 2024 at 03:15)</a>:</h4>
<p>It seems to be something about struct+union/discriminant, because <code>Format</code> and I think <code>Timecode</code> worked fine for me</p>



<a name="486627348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486627348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486627348">(Dec 07 2024 at 03:16)</a>:</h4>
<p>I'm so so relieved to hear you say there may be a glue bug, cause I've been inferring that I've been holding it wrong lol (and I have, but that's not the full story)</p>



<a name="486627406"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486627406" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486627406">(Dec 07 2024 at 03:16)</a>:</h4>
<p>Yeah, it dies for just a header... I'll dig a little</p>



<a name="486628044"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628044" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628044">(Dec 07 2024 at 03:25)</a>:</h4>
<p>Ooh fun</p>
<div class="codehilite"><pre><span></span><code>[jan@framey basic-cli]$ git status
On branch roc-on
Your branch is up to date with &#39;lukewilliamboswell/roc-on&#39;.

Changes to be committed:
  (use &quot;git restore --staged &lt;file&gt;...&quot; to unstage)
        renamed:    platform/InternalMIDI.roc -&gt; platform/InternalMidi.roc
        modified:   platform/PlatformTasks.roc

[jan@framey basic-cli]$ roc examples/midi.roc
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
An internal compiler expectation was broken.
This is definitely a compiler bug.
Please file an issue here: &lt;https://github.com/roc-lang/roc/issues/new/choose&gt;
Undefined Symbol in relocation, (+8107, Relocation { kind: PltRelative, encoding: Generic, size: +20, target: Symbol(SymbolIndex(+87)), addend: +fffffffffffffffc, implicit_addend: false }): Ok(Symbol { name: &quot;roc_fx_sendMidi&quot;, address: +0, size: +0, kind: Unknown, section: Undefined, scope: Unknown, weak: false, flags: Elf { st_info: +10, st_other: +0 } })
Location: crates/linker/src/elf.rs:1452:25
[jan@framey basic-cli]$
</code></pre></div>



<a name="486628234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628234">(Dec 07 2024 at 03:28)</a>:</h4>
<p>I remember in 2022 my standard operating procedure for any time I saw <code>This is definitely a compiler bug. Please file an issue here:</code> was to ping Brendan and sometimes create the issue. <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> what's the latest SOP for seeing that message?<br>
Note: This message went away when using the legacy linker, but I'm still curious what the SOP in general is.</p>



<a name="486628250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628250">(Dec 07 2024 at 03:28)</a>:</h4>
<p>You need to build the platform first <code>roc build.roc</code></p>



<a name="486628267"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628267" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628267">(Dec 07 2024 at 03:29)</a>:</h4>
<div class="spoiler-block"><div class="spoiler-header">
<p>resolved</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>[jan@framey basic-cli]$ roc build.roc<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
INFO: Checking provided roc; executing <code>roc version</code>:<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
roc nightly pre-release, built from commit d782542 on Mi 04 Dez 2024 09:02:14 UTC<br>
INFO: Getting the native operating system and architecture ...<br>
INFO: Building stubbed app shared library ...<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
0 errors and 0 warnings found in 252 ms<br>
 while successfully building:</p>
<div class="codehilite"><pre><span></span><code>platform/libapp.so
</code></pre></div>

<p>INFO: Building rust host ...<br>
warning: skipping duplicate package <code>host</code> found at <code>/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/cli/false-interpreter/platform</code><br>
warning: skipping duplicate package <code>host</code> found at <code>/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/glue/rust-platform</code><br>
warning: skipping duplicate package <code>host</code> found at <code>/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/platform-switching/rust-platform</code><br>
    Finished <code>release</code> profile [optimized] target(s) in 0.07s<br>
INFO: Failed to get env var CARGO_BUILD_TARGET with error VarNotFound. Assuming default CARGO_BUILD_TARGET (native)...<br>
INFO: Moving the prebuilt binary from target/release/libhost.a to platform/linux-x64.a ...<br>
INFO: Preprocessing surgical host ...<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
INFO: Successfully built platform files!<br>
[jan@framey basic-cli]$ roc examples/midi.roc <br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
An internal compiler expectation was broken.<br>
This is definitely a compiler bug.<br>
Please file an issue here: &lt;<a href="https://github.com/roc-lang/roc/issues/new/choose">https://github.com/roc-lang/roc/issues/new/choose</a>&gt;<br>
Undefined Symbol in relocation, (+8107, Relocation { kind: PltRelative, encoding: Generic, size: +20, target: Symbol(SymbolIndex(+87)), addend: +fffffffffffffffc, implicit_addend: false }): Ok(Symbol { name: "roc_fx_sendMidi", address: +0, size: +0, kind: Unknown, section: Undefined, scope: Unknown, weak: false, flags: Elf { st_info: +10, st_other: +0 } })<br>
Location: crates/linker/src/elf.rs:1452:25<br>
[jan@framey basic-cli]$ </p>
</div></div>



<a name="486628286"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628286" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628286">(Dec 07 2024 at 03:29)</a>:</h4>
<p>You also need to use the legacy linker <code>--linker legacy</code></p>



<a name="486628308"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628308" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628308">(Dec 07 2024 at 03:29)</a>:</h4>
<p>I think... what does <code>ls platform/</code> say?</p>



<a name="486628380"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628380" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628380">(Dec 07 2024 at 03:30)</a>:</h4>
<div class="spoiler-block"><div class="spoiler-header">
<p>resolved</p>
</div><div class="spoiler-content" aria-hidden="true">
<p>[jan@framey basic-cli]$ roc build.roc --linker=legacy<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
INFO: Checking provided roc; executing <code>roc version</code>:<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
roc nightly pre-release, built from commit d782542 on Mi 04 Dez 2024 09:02:14 UTC<br>
INFO: Getting the native operating system and architecture ...<br>
INFO: Building stubbed app shared library ...<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
0 errors and 0 warnings found in 249 ms<br>
 while successfully building:</p>
<div class="codehilite"><pre><span></span><code>platform/libapp.so
</code></pre></div>

<p>INFO: Building rust host ...<br>
warning: skipping duplicate package <code>host</code> found at <code>/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/cli/false-interpreter/platform</code><br>
warning: skipping duplicate package <code>host</code> found at <code>/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/glue/rust-platform</code><br>
warning: skipping duplicate package <code>host</code> found at <code>/home/jan/.cargo/git/checkouts/roc-f2007fde281427d6/8c73786/examples/platform-switching/rust-platform</code><br>
    Finished <code>release</code> profile [optimized] target(s) in 0.06s<br>
INFO: Failed to get env var CARGO_BUILD_TARGET with error VarNotFound. Assuming default CARGO_BUILD_TARGET (native)...<br>
INFO: Moving the prebuilt binary from target/release/libhost.a to platform/linux-x64.a ...<br>
INFO: Preprocessing surgical host ...<br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
INFO: Successfully built platform files!<br>
[jan@framey basic-cli]$ roc examples/midi.roc <br>
roc: /lib64/libtinfo.so.6: no version information available (required by roc)<br>
An internal compiler expectation was broken.<br>
This is definitely a compiler bug.<br>
Please file an issue here: &lt;<a href="https://github.com/roc-lang/roc/issues/new/choose">https://github.com/roc-lang/roc/issues/new/choose</a>&gt;<br>
Undefined Symbol in relocation, (+8107, Relocation { kind: PltRelative, encoding: Generic, size: +20, target: Symbol(SymbolIndex(+87)), addend: +fffffffffffffffc, implicit_addend: false }): Ok(Symbol { name: "roc_fx_sendMidi", address: +0, size: +0, kind: Unknown, section: Undefined, scope: Unknown, weak: false, flags: Elf { st_info: +10, st_other: +0 } })<br>
Location: crates/linker/src/elf.rs:1452:25<br>
[jan@framey basic-cli]$ ls platform/<br>
Arg      Dir.roc          FileMetadata.roc  Http.roc             InternalHttp.roc  libapp.roc  linux-x64.a   main.roc               Path.roc           Stderr.roc  Tcp.roc  Utc.roc<br>
Arg.roc  EnvDecoding.roc  File.roc          InternalCommand.roc  InternalMidi.roc  <a href="http://libapp.so">libapp.so</a>   linux-x64.rh  metadata_linux-x64.rm  PlatformTasks.roc  Stdin.roc   Tty.roc<br>
Cmd.roc  Env.roc          glue.roc          InternalFile.roc     InternalPath.roc  libhost.a   Locale.roc    MIDI.roc               Sleep.roc          Stdout.roc  Url.roc<br>
[jan@framey basic-cli]$ </p>
</div></div>
<p>I mean these large snippets with no sassy tone, btw - just info dumping</p>



<a name="486628393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628393">(Dec 07 2024 at 03:30)</a>:</h4>
<p>Yeah, I never landed that <a href="https://github.com/roc-lang/roc/pull/7282">PR to fallback to legacy linker</a> <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="486628417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628417">(Dec 07 2024 at 03:31)</a>:</h4>
<p>It's all good. </p>
<p>I meant this step <code>$ roc --linker legacy examples/midi.roc</code></p>



<a name="486628442"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628442" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628442">(Dec 07 2024 at 03:31)</a>:</h4>
<p>ayyy now that's the bug I wanna see</p>
<div class="codehilite"><pre><span></span><code>[jan@framey basic-cli]$ roc --linker legacy examples/midi.roc
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
[crates/roc_host/src/lib.rs:1407:5] smf = Smf {
    tracks: [
        [],
        [
            TrackEvent {
                kind: TrackEventKind {
                    payload: UnionTrackEventKind,
                    discriminant: [jan@framey basic-cli]$
</code></pre></div>



<a name="486628790"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628790" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628790">(Dec 07 2024 at 03:37)</a>:</h4>
<p>Fixed the segfault on smf dbg impl</p>



<a name="486628805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628805">(Dec 07 2024 at 03:37)</a>:</h4>
<p>Just pushed a commit <code>6ee50a005</code></p>



<a name="486628984"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628984" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628984">(Dec 07 2024 at 03:40)</a>:</h4>
<p>I wonder if our <code>InternalMidi.roc</code> vs. <code>InternalMIDI.roc</code> conflict is due to OS - lemme guess, you're on Mac?</p>



<a name="486628997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486628997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486628997">(Dec 07 2024 at 03:40)</a>:</h4>
<p>Yes I'm on a mac</p>



<a name="486629121"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629121" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629121">(Dec 07 2024 at 03:42)</a>:</h4>
<p>Okay we're aligned:</p>
<div class="codehilite"><pre><span></span><code>[jan@framey basic-cli]$ git rev-parse --short HEAD
6ee50a0
[jan@framey basic-cli]$ git status
On branch roc-on
Your branch is up to date with &#39;lukewilliamboswell/roc-on&#39;.

Changes to be committed:
  (use &quot;git restore --staged &lt;file&gt;...&quot; to unstage)
        renamed:    platform/InternalMIDI.roc -&gt; platform/InternalMidi.roc
        modified:   platform/PlatformTasks.roc

[jan@framey basic-cli]$ roc --linker legacy examples/midi.roc
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
[crates/roc_host/src/lib.rs:1407:5] smf = Smf {
    header: Header {
        timing: Timing {
            payload: UnionTiming,
            discriminant: discriminant_Timing::Timecode,
        },
        format: Format::Parallel,
    },
    track_count: 3,
}
Hello, World!
[jan@framey basic-cli]$
</code></pre></div>



<a name="486629185"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629185" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629185">(Dec 07 2024 at 03:43)</a>:</h4>
<p>We're not quite out of the woods yet, this is breaking...</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_sendMidi</span><span class="p">(</span><span class="n">smf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">roc_on</span><span class="p">::</span><span class="n">smf</span><span class="p">::</span><span class="n">Smf</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smf</span><span class="p">);</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"converting to Midly"</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">midi</span><span class="p">:</span><span class="w"> </span><span class="nc">midly</span><span class="p">::</span><span class="n">Smf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">smf</span><span class="p">.</span><span class="n">into</span><span class="p">();</span>

<span class="w">    </span><span class="fm">dbg!</span><span class="p">(</span><span class="n">midi</span><span class="p">);</span>

<span class="w">    </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>Looks like another segfault</p>
<div class="codehilite"><pre><span></span><code>$ roc examples/midi.roc
[crates/roc_host/src/lib.rs:1407:5] &amp;smf = Smf {
    header: Header {
        timing: Timing {
            payload: UnionTiming,
            discriminant: discriminant_Timing::Metrical,
        },
        format: Format::Parallel,
    },
    track_count: 3,
}
converting to Midly
</code></pre></div>



<a name="486629233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629233">(Dec 07 2024 at 03:44)</a>:</h4>
<p>I swear I had this working over in roc-on-simple... <span aria-label="sad" class="emoji emoji-2639" role="img" title="sad">:sad:</span></p>



<a name="486629294"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629294" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629294">(Dec 07 2024 at 03:45)</a>:</h4>
<p>Ok, it's something in the tracks...</p>



<a name="486629307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629307">(Dec 07 2024 at 03:45)</a>:</h4>
<p>Is your previous hypothesis of a bug in RustGlue.roc still active?</p>



<a name="486629412"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629412" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629412">(Dec 07 2024 at 03:47)</a>:</h4>
<p>This is huge news already, that Header is working... my instinct is to diff this against my minimal repro above to see why this memory is behaving.</p>



<a name="486629422"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629422" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629422">(Dec 07 2024 at 03:47)</a>:</h4>
<p>Not in RustGlue.roc per se (it may have originated there), but definitely in our handcrafted glue for <code>Smf</code> and friends</p>



<a name="486629498"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486629498" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486629498">(Dec 07 2024 at 03:48)</a>:</h4>
<p>If Header is already working and Tracks aren't, I wonder if this is a second bug beyond what I was hitting.</p>



<a name="486630222"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630222" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630222">(Dec 07 2024 at 04:00)</a>:</h4>
<p>I've pushed some more debugging stuff... I'm guessing the sensible thing to do is go through each of the Smf types, one by one and test them end to end, getting from roc, converting into midly, using with midly. And building up to an <code>Smf</code>, figure out what/where the glue issue is, and also make nice <code>Debug</code> and <code>Display</code> impls along the way.</p>



<a name="486630323"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630323" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630323">(Dec 07 2024 at 04:01)</a>:</h4>
<p>I kind of slapped it together... and I I'm not sure that was the best approach because now we're in this situation. But at least we have an 80% solution... and hopefully there's only 1 or two issues in here.</p>



<a name="486630490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630490">(Dec 07 2024 at 04:04)</a>:</h4>
<p>I found that hard coding the <code>let tracks = Vec::new();</code> the issue went away... so we can probably isolate it to the code that converts the RocList of tracks into midly types.</p>



<a name="486630555"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630555" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630555">(Dec 07 2024 at 04:04)</a>:</h4>
<p>I'm going to take a break from this for now. <span aria-label="smiley" class="emoji emoji-1f603" role="img" title="smiley">:smiley:</span></p>



<a name="486630646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630646">(Dec 07 2024 at 04:06)</a>:</h4>
<p>Thank you very much!</p>



<a name="486630658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630658">(Dec 07 2024 at 04:06)</a>:</h4>
<p>Sounds good. I'll start poking through.</p>



<a name="486630661"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630661" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630661">(Dec 07 2024 at 04:06)</a>:</h4>
<p>While you were doing that, I also...</p>



<a name="486630757"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630757" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630757">(Dec 07 2024 at 04:07)</a>:</h4>
<p>adapted your basic-cli/roc-on branch into my roc-on repo: <a href="https://gitlab.com/JanCVanB/roc-on/-/tree/return_smf_3">https://gitlab.com/JanCVanB/roc-on/-/tree/return_smf_3</a><br>
with this result</p>
<div class="codehilite"><pre><span></span><code>#[no_mangle]
pub extern &quot;C&quot; fn roc_fx_sendMidi(header: &amp;thanks_luke::header::Header) -&gt; RocResult&lt;(), RocStr&gt; {
    dbg!(&quot;party time&quot;);
    let midly_header : midly::Header = (*header).into();
    dbg!(&quot;party over&quot;);
    dbg!(&quot;midly::Header = {:?}&quot;, midly_header);
    RocResult::ok(())
}
</code></pre></div>
<div class="codehilite"><pre><span></span><code>[jan@framey roc-on]$ roc examples/memory_test_2.roc --linker=legacy
roc: /lib64/libtinfo.so.6: no version information available (required by roc)
[crates/roc_host/src/lib.rs:1419:5] &quot;party time&quot; = &quot;party time&quot;
[jan@framey roc-on]$
</code></pre></div>



<a name="486630832"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630832" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630832">(Dec 07 2024 at 04:08)</a>:</h4>
<p>I expect it's something trivial that you figured out and I haven't adapted from your later commits yet (this was just based on your first commit)</p>



<a name="486630853"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630853" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630853">(Dec 07 2024 at 04:09)</a>:</h4>
<p>but I'll keep exploring the question of how you got Header working and it has always crashed for me</p>



<a name="486630860"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630860" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630860">(Dec 07 2024 at 04:09)</a>:</h4>
<p>well, in the past not crashed, just never had the right values</p>



<a name="486630951"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630951" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630951">(Dec 07 2024 at 04:10)</a>:</h4>
<p>Before you go, any tips for how to Debug these struct+union types? From what I read online, it seems unions can't be debugged</p>



<a name="486630966"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486630966" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486630966">(Dec 07 2024 at 04:10)</a>:</h4>
<p>(if that's in your recent commits, nvm)</p>



<a name="486631192"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631192" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631192">(Dec 07 2024 at 04:14)</a>:</h4>
<p>For <code>header::Header</code>specifically, it will be passed by value not reference, so adding the <code>&amp;</code> here is what is causing this issue.</p>



<a name="486631240"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631240" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631240">(Dec 07 2024 at 04:15)</a>:</h4>
<p>So you would be trying to dereference a header value instead of a pointer to a header value</p>



<a name="486631242"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631242" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631242">(Dec 07 2024 at 04:15)</a>:</h4>
<p>Confirmed. <span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span> </p>
<div class="codehilite"><pre><span></span><code>[crates/roc_host/src/lib.rs:1419:5] &quot;party time&quot; = &quot;party time&quot;
[crates/roc_host/src/lib.rs:1421:5] &quot;party over&quot; = &quot;party over&quot;
[crates/roc_host/src/lib.rs:1422:5] &quot;midly::Header = {:?}&quot; = &quot;midly::Header = {:?}&quot;
[crates/roc_host/src/lib.rs:1422:5] midly_header = Header {
    format: Parallel,
    timing: Metrical(
        u15(
            10,
        ),
    ),
}
It worked?!
[jan@framey roc-on]$
</code></pre></div>



<a name="486631270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631270">(Dec 07 2024 at 04:15)</a>:</h4>
<p>Now you're cooking</p>



<a name="486631323"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631323" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631323">(Dec 07 2024 at 04:16)</a>:</h4>
<p>Thanks! Any tips on that debug union question above?</p>



<a name="486631372"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631372" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631372">(Dec 07 2024 at 04:17)</a>:</h4>
<blockquote>
<p>Before you go, any tips for how to Debug these struct+union types? From what I read online, it seems unions can't be debugged</p>
</blockquote>
<p>generating the LLVM and sharing with Claude is really helpful <span aria-label="smile" class="emoji emoji-1f642" role="img" title="smile">:smile:</span></p>



<a name="486631460"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631460" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631460">(Dec 07 2024 at 04:18)</a>:</h4>
<p>Aside from that... and <code>lldb</code> and <code>valgrind</code> I'm not sure what else there is</p>



<a name="486631472"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631472" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631472">(Dec 07 2024 at 04:18)</a>:</h4>
<p>OOF okie dokie, just get em into Midly then</p>



<a name="486631505"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631505" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631505">(Dec 07 2024 at 04:19)</a>:</h4>
<p><span aria-label="salute" class="emoji emoji-1fae1" role="img" title="salute">:salute:</span> goodnight friend</p>



<a name="486631584"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631584" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631584">(Dec 07 2024 at 04:20)</a>:</h4>
<p>We're operating beyond the envelope here... in the future, when people walk this path, they'll just generate the glue using <code>RustGlue.roc</code> and never even think about LLVM IR, FFI or C ABIs</p>



<a name="486631713"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631713" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631713">(Dec 07 2024 at 04:21)</a>:</h4>
<p>For anyone in the future, it seems way more well-defined to pass a value from Roc to Rust via an effect than via a return value!</p>



<a name="486631763"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486631763" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486631763">(Dec 07 2024 at 04:21)</a>:</h4>
<p>I'm glad to learn that my mental model of platform extension was flawed.</p>



<a name="486639463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486639463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486639463">(Dec 07 2024 at 06:11)</a>:</h4>
<p>Not sure it is still relevant, but your error above probably is technically a platform issue rather than a compiler bug. The platform is probably garbage collecting a function that roc needs. So the surgical linker can't find it.</p>



<a name="486641066"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/486641066" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#486641066">(Dec 07 2024 at 06:37)</a>:</h4>
<p>Ooh... Ok I'll keep an eye out for that if it reappears without linker mis-selection. Thanks!</p>



<a name="488157897"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488157897" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488157897">(Dec 11 2024 at 18:10)</a>:</h4>
<p><span class="user-mention" data-user-id="515757">@Luke Boswell</span> Today I started creating a bug reproduction within basic-cli for a memory weirdness I'm seeing in roc-on, but as I started creating it I noticed that yesterday you merged purity inference into basic-cli@main! Congrats! Since I'm grappling with glue/memory/active issues, would I have an easier time debugging and contributing to the ecosystem by updating my platform to rebase onto basic-cli@main and start using PI?</p>



<a name="488158054"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488158054" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488158054">(Dec 11 2024 at 18:11)</a>:</h4>
<p><span class="user-mention" data-user-id="361169">@Anton</span> <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> Since AoC is still going strong with <a href="mailto:basic-cli@0.17">basic-cli@0.17</a>, do you see much value in me continuing to grapple with these glue/memory issues in the pre-PI world?</p>



<a name="488158436"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488158436" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488158436">(Dec 11 2024 at 18:13)</a>:</h4>
<p>Context: I'm setting up a platform for music production that's basically a fork of basic-cli, and my added effect that contains MIDI message payloads is having trouble getting the right bits to Rust.</p>



<a name="488158987"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488158987" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488158987">(Dec 11 2024 at 18:16)</a>:</h4>
<p>I would switch to PI</p>



<a name="488164140"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488164140" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488164140">(Dec 11 2024 at 18:47)</a>:</h4>
<p><a href="/user_uploads/22008/rLEbNN_nX1zHBDUxyQ1Qh2Rm/is_it_time.gif">is_it_time.gif</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/rLEbNN_nX1zHBDUxyQ1Qh2Rm/is_it_time.gif" title="is_it_time.gif"><img data-animated="true" data-original-dimensions="498x229" src="/user_uploads/thumbnail/22008/rLEbNN_nX1zHBDUxyQ1Qh2Rm/is_it_time.gif/840x560-anim.webp"></a></div>



<a name="488164463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488164463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488164463">(Dec 11 2024 at 18:49)</a>:</h4>
<p>We definitely fixed a few bugs with the upgrade to purity inference</p>



<a name="488164563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488164563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488164563">(Dec 11 2024 at 18:50)</a>:</h4>
<p>(may have introduced some to, but we don't know about those yet, so I'm not counting them)</p>



<a name="488165695"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488165695" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488165695">(Dec 11 2024 at 18:56)</a>:</h4>
<p>Here I goooooo!</p>



<a name="488774885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488774885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488774885">(Dec 13 2024 at 06:36)</a>:</h4>
<p>Woohoooooo! PI was super smooth yesterday. Today I refactored to <a href="https://gitlab.com/JanCVanB/roc-on/-/blob/send_midi/scripts/regenerate_glue.sh">fully automate glue code generation</a> (including the adding of things like <code>derive(Copy)</code> and <code>pub field:</code>) and extended my test script to have Rust echo the custom structs back to Roc (powered by simply adding mirrored <code>From</code> implementations). Tomorrow I'll revisit the memory zeroing bug (barely shown below with the SingleTrack--&gt;Parallel mis-mapping at the Roc-to-Rust interface), but for now, glory: <a href="https://gitlab.com/JanCVanB/roc-on/-/blob/send_midi/examples/echo_midi.test.roc?ref_type=heads">https://gitlab.com/JanCVanB/roc-on/-/blob/send_midi/examples/echo_midi.test.roc?ref_type=heads</a><br>
CC <span class="user-mention" data-user-id="515757">@Luke Boswell</span> </p>
<div class="codehilite"><pre><span></span><code>jan@framey:~/_code/JanCVanB/roc-on$ roc --linker=legacy examples/echo_midi.test.roc
🦀😶 Rust is running Roc...

🦅😶 Roc is running...

🦅😶 main is sending custom MIDI: SingleTrack
🦀😶 roc_fx_echoMidiSmall received custom MIDI: Format::SingleTrack
🦀😊 roc_fx_echoMidiSmall casted that to Midly: SingleTrack
🦀😊 roc_fx_echoMidiSmall casted that back too: Format::SingleTrack
🦅😶 main received an echo back: SingleTrack
🦅😊 main sees no difference!

🦅😶 main is sending custom MIDI: {format: SingleTrack, timing: (Metrical 100)}
🦀😶 roc_fx_echoMidiSmallish received custom MIDI: Header { timing: Timing::Metrical(100), format: Format::Parallel }
🦀😊 roc_fx_echoMidiSmallish casted that to Midly: Header { format: Parallel, timing: Metrical(u15(100)) }
🦀😊 roc_fx_echoMidiSmallish casted that back too: Header { timing: Timing::Metrical(100), format: Format::Parallel }
🦅😶 main received an echo back: {format: Parallel, timing: (Metrical 100)}
🦅😡 main sees a difference!

🦅😞 main can&#39;t yet call Midi.echoMidiFull! without a Segmentation fault...

🦅🥳 Roc finished testing MIDI echoes.

🦀🥳 Rust finished running Roc.
jan@framey:~/_code/JanCVanB/roc-on$
</code></pre></div>



<a name="488776073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488776073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488776073">(Dec 13 2024 at 06:48)</a>:</h4>
<p>So awesome!!! <span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span> <span aria-label="juggling" class="emoji emoji-1f939" role="img" title="juggling">:juggling:</span> <span aria-label="musical notes" class="emoji emoji-1f3b6" role="img" title="musical notes">:musical_notes:</span></p>



<a name="488911912"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488911912" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488911912">(Dec 13 2024 at 20:04)</a>:</h4>
<p>Bug thread created: <a class="stream-topic" data-stream-id="463736" href="/#narrow/channel/463736-bugs/topic/Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust">#bugs &gt; Struct memory partially zeroed between Roc and Rust</a></p>



<a name="488927886"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488927886" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488927886">(Dec 13 2024 at 22:00)</a>:</h4>
<p>LET'S</p>
<p>GOOOOOOOOOOOOOOOOOO</p>
<div class="codehilite"><pre><span></span><code>🦅😶 main is sending custom MIDI: {format: SingleTrack, timing: (Metrical 100 0 0 0 0)}
🦀😶 roc_fx_echoMidiSmallish received custom MIDI: Header { timing: Timing::Metrical(Timing_Metrical { f1: 0, f2: 0, f3: 0, f4: 0, f0: 100 }), format: Format::SingleTrack }
🦀😊 roc_fx_echoMidiSmallish casted that to Midly: Header { format: SingleTrack, timing: Metrical(u15(100)) }
🦀😊 roc_fx_echoMidiSmallish casted that back too: Header { timing: Timing::Metrical(Timing_Metrical { f1: 0, f2: 0, f3: 0, f4: 0, f0: 100 }), format: Format::SingleTrack }
🦅😶 main received an echo back: {format: SingleTrack, timing: (Metrical 100 0 0 0 0)}
🦅😊 main sees no difference!
</code></pre></div>



<a name="488929501"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/488929501" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#488929501">(Dec 13 2024 at 22:13)</a>:</h4>
<p>Tomorrow I'll see if fluffing every tag and record prevents those full-midi-file segfaults (I doubt it, but it can't hurt).</p>



<a name="489038532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/489038532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#489038532">(Dec 15 2024 at 00:26)</a>:</h4>
<p>Do we intend to support using tag unions as effect parameters? (The top-level data container, where structs already work.)</p>



<a name="489039184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/489039184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#489039184">(Dec 15 2024 at 00:38)</a>:</h4>
<p>See new bug thread: <a class="stream-topic" data-stream-id="463736" href="/#narrow/channel/463736-bugs/topic/Fluffing.20doesn.27t.20naively.20work.20for.20tags">#bugs &gt; Fluffing doesn't naively work for tags</a></p>



<a name="489039768"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/489039768" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#489039768">(Dec 15 2024 at 00:48)</a>:</h4>
<blockquote>
<p>Do we intend to support using tag unions as effect parameters?</p>
</blockquote>
<p>yes</p>



<a name="489357170"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/489357170" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#489357170">(Dec 16 2024 at 22:25)</a>:</h4>
<p><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span></p>
<div class="codehilite"><pre><span></span><code>🦀😶 Rust is running Roc...

🦅😶 Roc is running...

🦅😶 main is sending custom MIDI: SingleTrack
🦀😶 roc_fx_echoMidiSmall received custom MIDI: Format::SingleTrack
🦀😊 roc_fx_echoMidiSmall casted that to Midly: SingleTrack
🦀😊 roc_fx_echoMidiSmall casted that back too: Format::SingleTrack
🦅😶 main received an echo back: SingleTrack
🦅😊 main sees no difference!

🦅😶 main is sending custom MIDI: {format: SingleTrack, o: {a: 0, b: 0, c: 0, d: 0}, timing: (Metrical 100)}
🦀😶 roc_fx_echoMidiSmallish received custom MIDI: Header { o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, timing: Timing::Metrical(100), format: Format::SingleTrack }
🦀😊 roc_fx_echoMidiSmallish casted that to Midly: Header { format: SingleTrack, timing: Metrical(u15(100)) }
🦀😊 roc_fx_echoMidiSmallish casted that back too: Header { o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, timing: Timing::Metrical(100), format: Format::SingleTrack }
🦅😶 main received an echo back: {format: SingleTrack, o: {a: 0, b: 0, c: 0, d: 0}, timing: (Metrical 100)}
🦅😊 main sees no difference!

🦅😶 main is sending custom MIDI: {delta: 2, kind: (Midi {channel: 1, message: (NoteOn {key: 1, vel: 2})}), o: {a: 0, b: 0, c: 0, d: 0}}
🦀😶 roc_fx_echoMidiMedium received custom MIDI: TrackEvent { kind: TrackEventKind::Midi(TrackEventKindMidi { message: MidiMessage::NoteOn(R1 { key: 1, vel: 2 }), channel: 1 }), o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, delta: 2 }
🦀😊 roc_fx_echoMidiMedium casted that to Midly: TrackEvent { delta: u28(2), kind: Midi { channel: u4(1), message: NoteOn { key: u7(1), vel: u7(2) } } }
🦀😊 roc_fx_echoMidiMedium casted that back too: TrackEvent { kind: TrackEventKind::Midi(TrackEventKindMidi { message: MidiMessage::NoteOn(R1 { key: 1, vel: 2 }), channel: 1 }), o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, delta: 2 }
🦅😶 main received an echo back: {delta: 2, kind: (Midi {channel: 1, message: (NoteOn {key: 1, vel: 2})}), o: {a: 0, b: 0, c: 0, d: 0}}
🦅😊 main sees no difference!

🦅😶 main is sending custom MIDI: {header: {format: SingleTrack, o: {a: 0, b: 0, c: 0, d: 0}, timing: (Metrical 100)}, tracks: [[{delta: 1, kind: (Escape []), o: {a: 0, b: 0, c: 0, d: 0}}, {delta: 2, kind: (Midi {channel: 1, message: (NoteOn {key: 1, vel: 2})}), o: {a: 0, b: 0, c: 0, d: 0}}, {delta: 3, kind: (Meta EndOfTrack), o: {a: 0, b: 0, c: 0, d: 0}}]]}
🦀😶 roc_fx_echoMidiFull received custom MIDI: Smf { header: Header { o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, timing: Timing::Metrical(100), format: Format::SingleTrack }, tracks: [[TrackEvent { kind: TrackEventKind::Escape([]), o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, delta: 1 }, TrackEvent { kind: TrackEventKind::Midi(TrackEventKindMidi { message: MidiMessage::NoteOn(R1 { key: 1, vel: 2 }), channel: 1 }), o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, delta: 2 }, TrackEvent { kind: TrackEventKind::Meta(MetaMessage::EndOfTrack(())), o: FluffZeroes { a: 0, b: 0, c: 0, d: 0 }, delta: 3 }]] }
🦀😊 roc_fx_echoMidiFull casted that to Midly: Smf { header: Header { format: SingleTrack, timing: Metrical(u15(100)) }, tracks: [[TrackEvent { delta: u28(1), kind: Escape([]) }, TrackEvent { delta: u28(2), kind: Midi { channel: u4(1), message: NoteOn { key: u7(1), vel: u7(2) } } }, TrackEvent { delta: u28(3), kind: Meta(EndOfTrack) }]] }
🦅😶 main received an echo back: {header: {format: SingleTrack, o: {a: 0, b: 0, c: 0, d: 0}, timing: (Metrical 100)}, tracks: [[{delta: 1, kind: (Escape []), o: {a: 0, b: 0, c: 0, d: 0}}, {delta: 2, kind: (Midi {channel: 1, message: (NoteOn {key: 1, vel: 2})}), o: {a: 0, b: 0, c: 0, d: 0}}, {delta: 3, kind: (Meta EndOfTrack), o: {a: 0, b: 0, c: 0, d: 0}}]]}
🦅😊 main sees no difference!

🦅🥳 Roc finished testing MIDI echoes.

🦀🥳 Rust finished running Roc.
</code></pre></div>
<p><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><span aria-label="partying face" class="emoji emoji-1f973" role="img" title="partying face">:partying_face:</span><br>
I just noticed I forgot to restore the "I casted that back too" println! for Full, but it did do that here.</p>



<a name="489357331"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/489357331" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#489357331">(Dec 16 2024 at 22:26)</a>:</h4>
<p>TODO: See how much fluffing I can remove without breaking the effects I want in the medium term.</p>



<a name="489360506"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/489360506" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#489360506">(Dec 16 2024 at 22:45)</a>:</h4>
<p>Hopefully in the medium term I can fix this in general</p>



<a name="490022528"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/490022528" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#490022528">(Dec 19 2024 at 18:08)</a>:</h4>
<p>Yay, I removed so much fluffing and isolated it from any business logic.<br>
<a href="https://gitlab.com/JanCVanB/roc-on/-/merge_requests/5/diffs">https://gitlab.com/JanCVanB/roc-on/-/merge_requests/5/diffs</a></p>
<h1>platform/PlatformTasksFluff.roc</h1>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="n">module</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="no">Zeroes</span><span class="p">,</span>
<span class="o">]</span>

<span class="c1"># This is to help avoid hitting a known C ABI bug</span>
<span class="c1"># by ensuring small values are passed by pointer.</span>
<span class="c1"># See https://roc.zulipchat.com/#narrow/channel/463736-bugs/topic/Struct.20memory.20partially.20zeroed.20between.20Roc.20and.20Rust/near/488928494</span>
<span class="no">Zeroes</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">U64</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">U64</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">U64</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">U64</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<h1>platform/PlatformTasks.roc</h1>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="o">...</span>
<span class="n">receiveMidiFile!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">FluffedFileContent</span><span class="w"> </span><span class="no">Str</span>
<span class="n">receiveMidiMessage!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">FluffedMidiMessage</span><span class="w"> </span><span class="no">Str</span>
<span class="n">sendMidiFile!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">FluffedFileContent</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="no">Str</span>
<span class="n">sendMidiMessage!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">FluffedMidiMessage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="no">Str</span>
</code></pre></div>
<h1>platform/InternalMidi.roc</h1>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="o">...</span>
<span class="no">FluffedFileContent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">FileContent</span><span class="p">,</span>
<span class="w">    </span><span class="n">o</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">PlatformTasksFluff</span><span class="o">.</span><span class="n">Zeroes</span><span class="p">,</span>
<span class="p">}</span>
<span class="no">FluffedMidiMessage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">message</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">MidiMessage</span><span class="p">,</span>
<span class="w">    </span><span class="n">o</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">PlatformTasksFluff</span><span class="o">.</span><span class="n">Zeroes</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<h1>platform/Midi.roc</h1>
<div class="codehilite" data-code-language="Ruby"><pre><span></span><code><span class="o">...</span>

<span class="n">o</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">PlatformTasksFluff</span><span class="o">.</span><span class="n">Zeroes</span>
<span class="n">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="ss">a</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">c</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">d</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span>

<span class="n">receiveMidiFile!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">FileContent</span><span class="w"> </span><span class="o">[</span><span class="no">MidiErr</span><span class="w"> </span><span class="no">Str</span><span class="o">]</span>
<span class="n">receiveMidiFile!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">\{}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="no">PlatformTasks</span><span class="o">.</span><span class="n">receiveMidiFile!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="no">Result</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="o">.</span><span class="n">file</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="no">Result</span><span class="o">.</span><span class="n">mapErr</span><span class="w"> </span><span class="no">MidiErr</span>

<span class="n">receiveMidiMessage!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">MidiMessage</span><span class="w"> </span><span class="o">[</span><span class="no">MidiErr</span><span class="w"> </span><span class="no">Str</span><span class="o">]</span>
<span class="n">receiveMidiMessage!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">\{}</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="no">PlatformTasks</span><span class="o">.</span><span class="n">receiveMidiMessage!</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="no">Result</span><span class="o">.</span><span class="n">map</span><span class="w"> </span><span class="o">.</span><span class="n">message</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="no">Result</span><span class="o">.</span><span class="n">mapErr</span><span class="w"> </span><span class="no">MidiErr</span>

<span class="n">sendMidiFile!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">FileContent</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">[</span><span class="no">MidiErr</span><span class="w"> </span><span class="no">Str</span><span class="o">]</span>
<span class="n">sendMidiFile!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">\</span><span class="n">file</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="no">PlatformTasks</span><span class="o">.</span><span class="n">sendMidiFile!</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="no">Result</span><span class="o">.</span><span class="n">mapErr</span><span class="w"> </span><span class="no">MidiErr</span>

<span class="n">sendMidiMessage!</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">InternalMidi</span><span class="o">.</span><span class="n">MidiMessage</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Result</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="o">[</span><span class="no">MidiErr</span><span class="w"> </span><span class="no">Str</span><span class="o">]</span>
<span class="n">sendMidiMessage!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">\</span><span class="n">message</span><span class="w"> </span><span class="o">-&gt;</span>
<span class="w">    </span><span class="no">PlatformTasks</span><span class="o">.</span><span class="n">sendMidiMessage!</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">o</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="no">Result</span><span class="o">.</span><span class="n">mapErr</span><span class="w"> </span><span class="no">MidiErr</span>
</code></pre></div>
<h1>crates/roc_host/src/midi_effects.rs</h1>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">..</span><span class="p">.</span>

<span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="n">glue</span><span class="p">::</span><span class="n">midi_generated</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="n">O</span><span class="p">:</span><span class="w"> </span><span class="nc">Zeroes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Zeroes</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">a</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">c</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">d</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_receiveMidiFile</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="n">FluffedFileContent</span><span class="p">,</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO: Read MIDI files from disk!</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">hardcoded_midi_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">midly</span><span class="p">::</span><span class="n">Smf</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(</span><span class="n">FluffedFileContent</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">file</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">hardcoded_midi_file</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">        </span><span class="n">o</span><span class="p">:</span><span class="w"> </span><span class="nc">O</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_receiveMidiMessage</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="n">FluffedMidiMessage</span><span class="p">,</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// TODO: Stream MIDI messages from devices!</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">hardcoded_midi_message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">midly</span><span class="p">::</span><span class="n">MidiMessage</span><span class="p">::</span><span class="n">NoteOn</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(</span><span class="n">FluffedMidiMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">hardcoded_midi_message</span><span class="p">).</span><span class="n">into</span><span class="p">(),</span>
<span class="w">        </span><span class="n">o</span><span class="p">:</span><span class="w"> </span><span class="nc">O</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_sendMidiFile</span><span class="p">(</span>
<span class="w">    </span><span class="n">FluffedFileContent</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">FluffedFileContent</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">validated_midi_file</span><span class="p">:</span><span class="w"> </span><span class="nc">midly</span><span class="p">::</span><span class="n">Smf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// TODO: Write MIDI file to disk.</span>
<span class="w">    </span><span class="n">fundsp_sequence_example</span><span class="p">::</span><span class="n">perform</span><span class="p">(</span><span class="n">validated_midi_file</span><span class="p">);</span>
<span class="w">    </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="cp">#[no_mangle]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">roc_fx_sendMidiMessage</span><span class="p">(</span>
<span class="w">    </span><span class="n">FluffedMidiMessage</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">FluffedMidiMessage</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">RocResult</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">RocStr</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">_validated_midi_message</span><span class="p">:</span><span class="w"> </span><span class="nc">midly</span><span class="p">::</span><span class="n">MidiMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">message</span><span class="p">).</span><span class="n">into</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// TODO: Stream MIDI messages to devices!</span>
<span class="w">    </span><span class="n">RocResult</span><span class="p">::</span><span class="n">ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p><span aria-label="smiling face with hearts" class="emoji emoji-1f970" role="img" title="smiling face with hearts">:smiling_face_with_hearts:</span></p>



<a name="490022547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/490022547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#490022547">(Dec 19 2024 at 18:09)</a>:</h4>
<p><span class="user-mention silent" data-user-id="462053">JanCVanB</span> has marked this topic as resolved.</p>



<a name="490066777"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/%E2%9C%94%20Memory%20layout%20for%20tags%20%26%20records/near/490066777" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> jan kili <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/.E2.9C.94.20Memory.20layout.20for.20tags.20.26.20records.html#490066777">(Dec 19 2024 at 23:37)</a>:</h4>
<p>Epilogue: I simplified+isolated it further by just absorbing PlatformTasksFluff.roc (and <code>o = ...</code>) into PlatformTasks.roc</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>pattern matching bug · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html">pattern matching bug</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="341519724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341519724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341519724">(Mar 13 2023 at 17:00)</a>:</h4>
<p>Shouldn't this work?</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nv">scanFinal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">Integer</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">Float</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">Ident</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">Slash</span><span class="p">,</span><span class="w"> </span><span class="nx">Comment</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">Not</span><span class="p">,</span><span class="w"> </span><span class="nx">Eq</span><span class="p">,</span><span class="w"> </span><span class="nx">Lt</span><span class="p">,</span><span class="w"> </span><span class="nx">Gt</span><span class="p">,</span><span class="w"> </span><span class="nx">Start</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="nb">Number</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">Ident</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">Slash</span><span class="p">,</span><span class="w"> </span><span class="nx">Comment</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="nx">Str</span><span class="p">,</span><span class="w"> </span><span class="nx">Not</span><span class="p">,</span><span class="w"> </span><span class="nx">Eq</span><span class="p">,</span><span class="w"> </span><span class="nx">Lt</span><span class="p">,</span><span class="w"> </span><span class="nx">Gt</span><span class="p">,</span><span class="w"> </span><span class="nx">Start</span><span class="p">]</span>
<span class="nv">scanFinal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">state</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">is</span>
<span class="w">        </span><span class="nx">Start</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Newline</span>
<span class="w">        </span><span class="nx">Integer</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Float</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nb">Number</span><span class="w"> </span><span class="nx">n</span>
<span class="w">        </span><span class="nx">Ident</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Ident</span><span class="w"> </span><span class="nx">a</span>
<span class="w">        </span><span class="nx">Slash</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Slash</span>
<span class="w">        </span><span class="nx">Comment</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Comment</span><span class="w"> </span><span class="nx">c</span>
<span class="w">        </span><span class="nb">String</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="nx">s</span>
<span class="w">        </span><span class="nx">Not</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Not</span>
<span class="w">        </span><span class="nx">Eq</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Eq</span>
<span class="w">        </span><span class="nx">Lt</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">Lt</span>
<span class="w">        </span><span class="nx">other</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">other</span>
</code></pre></div>
<p>If I simply change <code>other -&gt; other</code> to <code>Gt -&gt; Gt</code> then it works. The error I'm getting is:</p>
<div class="codehilite"><pre><span></span><code>This other value is a:

    [Comment Str, Eq, Float Str, Gt, Ident Str, Integer Str, Lt, Not,
    Slash, Start, String Str]

But the type annotation on scanFinal says it should be:

    [Comment Str, Eq, Ident Str, Lt, Newline, Not, Number Str, Slash,
    String Str]
</code></pre></div>



<a name="341520258"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341520258" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341520258">(Mar 13 2023 at 17:02)</a>:</h4>
<p>if you look at the types, then no, it should not work</p>



<a name="341520430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341520430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341520430">(Mar 13 2023 at 17:03)</a>:</h4>
<p>Can you help me understand then? It seems like changing <code>other -&gt; other</code> to <code>Gt -&gt; Gt</code> should be equivalent here, no?</p>



<a name="341520451"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341520451" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341520451">(Mar 13 2023 at 17:03)</a>:</h4>
<p>because of how tag unions are represented, it is very likely that the memory representation changes by this function</p>



<a name="341520805"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341520805" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341520805">(Mar 13 2023 at 17:04)</a>:</h4>
<p>I'm just trying to avoid having to have all the ones that are the same on the left and right side of the <code>-&gt;</code> and it seems like <code>other -&gt; other</code> should cover all those</p>



<a name="341521466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341521466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341521466">(Mar 13 2023 at 17:07)</a>:</h4>
<p>intuitively, yes. </p>
<p>But the <code>Gt</code> tag can look very differently on either side of the arrow, in practice. Consider</p>
<div class="codehilite"><pre><span></span><code>foo : [ Gt, Lit Str ] -&gt; [ Gt, Lit U8 ]
foo = \input -&gt;
    when input is
        Lit str -&gt; Lit (Num.intCast (Str.countBytes str))
        Gt -&gt; Gt
</code></pre></div>

<p>The <code>[ Gt, Lit Str ]</code> value requires <code>24 + 1 = 25</code> bytes of storage (which is rounded up to 32 because of alignment. In contrast <code>[ Gt, Lit U8 ]</code> requires just 2 bytes of storage. That means the value from the left-hand side cannot just be copied to be used on the right-hand side.</p>



<a name="341522683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341522683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341522683">(Mar 13 2023 at 17:13)</a>:</h4>
<p>That's only if <code>other -&gt; other</code> means to blindly copy the value from left side to right side. It seems like <code>other</code> should be equivalent to "whatever tags in the union we haven't matched yet". I can see how this wouldn't work if the input was an open tag union, but for a closed tag union it seems like this could be made to work</p>



<a name="341535802"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341535802" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341535802">(Mar 13 2023 at 17:54)</a>:</h4>
<p>It definitely is an interesting question which should be the default. currently <code>other -&gt; other</code> links the input and output type. Which make sense given it is an identity function. I think we need to add some sort of helper to allow explicit conversion in cases like this.</p>



<a name="341536041"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341536041" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341536041">(Mar 13 2023 at 17:55)</a>:</h4>
<p>If we make it implicit, it means that we could have tons of data movement and copying for something that should be free. Would be a very odd performance bug to nail down for end users.</p>



<a name="341536197"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341536197" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341536197">(Mar 13 2023 at 17:56)</a>:</h4>
<p>I think zig's <code>inline switch</code> does something like this</p>



<a name="341536298"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341536298" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341536298">(Mar 13 2023 at 17:57)</a>:</h4>
<p>where you can do <code>x -&gt; x</code> but really what it does is inline all of the actual things that <code>x</code> could be</p>



<a name="341538507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341538507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341538507">(Mar 13 2023 at 18:07)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> has an issue (I can't find it at the moment) discussing how we could make <code>other -&gt; other</code> Just Work - and yeah it would have an unavoidable runtime performance cost because it would have to create a new one from scratch based on the old one</p>



<a name="341538565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341538565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341538565">(Mar 13 2023 at 18:07)</a>:</h4>
<p>I think that would be a reasonable default</p>



<a name="341538825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341538825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341538825">(Mar 13 2023 at 18:08)</a>:</h4>
<p>it seems like it would be an extremely extremely rare performance case where not only was changing this significant, but there was actually room for performance improvement in practice!</p>



<a name="341538938"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341538938" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341538938">(Mar 13 2023 at 18:08)</a>:</h4>
<p>like the number of scenarios where you write <code>other -&gt; other</code> and there's a significantly more performant way to have your code do what it needs to do seems extremely small <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="341539051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341539051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341539051">(Mar 13 2023 at 18:09)</a>:</h4>
<p>and if you can't meaningfully improve it anyway, it may not be all that beneficial knowing what it's doing from a perf perspective to begin with</p>



<a name="341539875"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341539875" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341539875">(Mar 13 2023 at 18:13)</a>:</h4>
<p>Tags live on the stack by default, right?</p>



<a name="341540088"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341540088" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341540088">(Mar 13 2023 at 18:14)</a>:</h4>
<p>yeah</p>



<a name="341541355"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/pattern%20matching%20bug/near/341541355" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/pattern.20matching.20bug.html#341541355">(Mar 13 2023 at 18:20)</a>:</h4>
<p>i don’t know if i have an issue for it, but i do have a blog post about how to do this and the trade offs: <a href="https://ayazhafiz.com/articles/22/simple-flow-refinement-of-anonymous-sum-types">https://ayazhafiz.com/articles/22/simple-flow-refinement-of-anonymous-sum-types</a></p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>How to check LLVM optimizations? · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html">How to check LLVM optimizations?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="289880360"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289880360" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289880360">(Jul 17 2022 at 11:55)</a>:</h4>
<p>I want to experiment a little with how the LLVM IR which is generated by the Roc compiler is optimized further by LLVM. (To e.g. see if different ways of writing the same program might be treated differently by the compiler passes).</p>
<p>How to set this up?</p>



<a name="289880599"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289880599" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289880599">(Jul 17 2022 at 12:00)</a>:</h4>
<p>you can print the llvm to a file earlier in the process</p>



<a name="289880877"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289880877" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289880877">(Jul 17 2022 at 12:07)</a>:</h4>
<p>Is the LLVM which is exported using <code>--debug</code> usable? Or is that a bad idea?</p>



<a name="289882393"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289882393" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289882393">(Jul 17 2022 at 12:40)</a>:</h4>
<p>yes it's fine to use</p>



<a name="289883738"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289883738" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289883738">(Jul 17 2022 at 13:09)</a>:</h4>
<p>Fun! LLVM is able to compile the following down (on the hello-world platform in this case):</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="kr">main </span><span class="nf">=</span><span class="w"></span>
<span class="w">  </span><span class="nv">outcome</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="mi">123456789</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">Err</span><span class="w"> </span><span class="kt">Nothing</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nv">when</span><span class="w"> </span><span class="nv">outcome</span><span class="w"> </span><span class="nv">is</span><span class="w"></span>
<span class="w">    </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">val</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"></span>
<span class="w">      </span><span class="nv">valStr</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">toStr</span><span class="w"> </span><span class="nv">val</span><span class="w"></span>
<span class="w">      </span><span class="s">"The result of the addition was successful and is \(valStr)"</span><span class="w"></span>
<span class="w">    </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"></span>
<span class="w">      </span><span class="s">"Calculating the result of addition has failed</span><span class="se">\n</span><span class="s">"</span><span class="w"></span>

<span class="nv">example</span><span class="w"> </span><span class="nf">:</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">I64</span><span class="w"> </span><span class="p">[</span><span class="kt">Nothing</span><span class="p">],</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">I64</span><span class="w"> </span><span class="p">[</span><span class="kt">Nothing</span><span class="p">]</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="w"> </span><span class="kt">I64</span><span class="w"> </span><span class="p">[</span><span class="kt">Nothing</span><span class="p">]</span><span class="w"></span>
<span class="nv">example</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">lhs</span><span class="p">,</span><span class="w"> </span><span class="nv">rhs</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"></span>
<span class="w">  </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">x</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nf">\</span><span class="nv">y</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="nf">|&gt;</span><span class="w"> </span><span class="nv">apply</span><span class="w"> </span><span class="nv">lhs</span><span class="w"></span>
<span class="w">  </span><span class="nf">|&gt;</span><span class="w"> </span><span class="nv">apply</span><span class="w"> </span><span class="nv">rhs</span><span class="w"></span>

<span class="nv">apply</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">funRes</span><span class="p">,</span><span class="w"> </span><span class="nv">valRes</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"></span>
<span class="w">  </span><span class="nv">when</span><span class="w"> </span><span class="nv">funRes</span><span class="w"> </span><span class="nv">is</span><span class="w"></span>
<span class="w">    </span><span class="kt">Err</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Err</span><span class="w"> </span><span class="nv">e</span><span class="w"></span>
<span class="w">    </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">fun</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"></span>
<span class="w">      </span><span class="nv">when</span><span class="w"> </span><span class="nv">valRes</span><span class="w"> </span><span class="nv">is</span><span class="w"></span>
<span class="w">        </span><span class="kt">Err</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Err</span><span class="w"> </span><span class="nv">e</span><span class="w"></span>
<span class="w">        </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">val</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="nv">fun</span><span class="w"> </span><span class="nv">val</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>to</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">roc__mainForHost_1_exposed_generic:</span><span class="w">     </span><span class="c1"># @roc__mainForHost_1_exposed_generic</span>
<span class="w">        </span><span class="nf">lea</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="no">rip</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">.L_str_literal_13338901839589407859</span><span class="err">+</span><span class="mi">8</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">],</span><span class="w"> </span><span class="no">rax</span><span class="w"></span>
<span class="w">        </span><span class="nf">vmovaps</span><span class="w"> </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmmword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rip</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="no">.LCPI1_0</span><span class="p">]</span><span class="w"> </span><span class="c1"># xmm0 = [46,46]</span>
<span class="w">        </span><span class="nf">vmovups</span><span class="w"> </span><span class="no">xmmword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="no">xmm0</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
<span class="nl">roc__mainForHost_1_exposed:</span><span class="w">             </span><span class="c1"># @roc__mainForHost_1_exposed</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rdi</span><span class="w"></span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="mi">46</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
<span class="nl">roc__mainForHost_size:</span><span class="w">                  </span><span class="c1"># @roc__mainForHost_size</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">eax</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"></span>
<span class="w">        </span><span class="nf">ret</span><span class="w"></span>
<span class="nl">.L_str_literal_13338901839589407859:</span><span class="w"></span>
<span class="w">        </span><span class="na">.ascii</span><span class="w">  </span><span class="s">"\000\000\000\000\000\000\000\000Calculating the result of addition has failed\n"</span><span class="w"></span>
</code></pre></div>
<p>i.e. all function calls are optimized away. LLVM sees that we pass an <code>Err Nothing</code> and so the only thing that is left in assembly is copying the string literal to pass back to the hello-world platform.</p>



<a name="289883861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289883861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289883861">(Jul 17 2022 at 13:11)</a>:</h4>
<p>For some reason, there also is a definition of <code>__muloti4</code> included in the resulting assembly. (This is software support for "multiplying two 128-bit signed integers with overflow checking") although to my knowledge 128bit numbers are not used anywhere in the code.</p>



<a name="289883872"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289883872" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289883872">(Jul 17 2022 at 13:11)</a>:</h4>
<p>c.f. <a href="https://llvm.godbolt.org/z/qsWfPrGxP">Compiler Explorer</a></p>



<a name="289884031"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289884031" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289884031">(Jul 17 2022 at 13:13)</a>:</h4>
<p>Not that big of a deal of course, since when linking it together with the platform code, superfluous symbols will disappear from the resulting binary.</p>



<a name="289884110"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289884110" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289884110">(Jul 17 2022 at 13:14)</a>:</h4>
<p>we link that in explicitly for reasons I have forgotten</p>



<a name="289884117"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289884117" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289884117">(Jul 17 2022 at 13:14)</a>:</h4>
<p>but it is required</p>



<a name="289884403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289884403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289884403">(Jul 17 2022 at 13:19)</a>:</h4>
<p>Curious!</p>



<a name="289884727"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/How%20to%20check%20LLVM%20optimizations%3F/near/289884727" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Qqwy / Marten <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/How.20to.20check.20LLVM.20optimizations.3F.html#289884727">(Jul 17 2022 at 13:24)</a>:</h4>
<p>If you replace the line </p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">outcome</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="mi">123456789</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">Err</span><span class="w"> </span><span class="kt">Nothing</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>with e.g. </p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">outcome</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="mi">123456789</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>then the assembly is more involved. <br>
 Maybe that is allocation + refcounting ceremony because the resulting strings are too large to allocate on the stack(?) (c.f. <a href="https://llvm.godbolt.org/z/s7edaEqvW">Compiler Explorer</a>, go to the definition of <code>_mainForHost_67abdd721024f0ff4eb3f4c2fc13bc5bad42db7851d456d88d203d15aaa450</code>)</p>
<p>But the more important point is that there is no difference in resulting assembly between </p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">outcome</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">example</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="mi">123456789</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">Ok</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>and </p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">outcome</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Ok</span><span class="w"> </span><span class="p">(</span><span class="mi">123456789</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="mi">42</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>. The whole calculation is inlined and constant-folded away! <span aria-label="happy" class="emoji emoji-1f600" role="img" title="happy">:happy:</span></p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
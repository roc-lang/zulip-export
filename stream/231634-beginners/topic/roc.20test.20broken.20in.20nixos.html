<html>
<head><meta charset="utf-8"><title>roc test broken in nixos · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html">roc test broken in nixos</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="329299483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329299483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> dank <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329299483">(Feb 21 2023 at 21:53)</a>:</h4>
<p>there seems to be a nixos issue when testing code in a path that differs from the roc compiler directory<br>
<a href="https://gist.githubusercontent.com/dankeyy/6497117f3f1550df6340733ed5de74d0/raw/39678d9d8133e11ce149fec6cc005bd93d6b545b/patherr.txt">https://gist.githubusercontent.com/dankeyy/6497117f3f1550df6340733ed5de74d0/raw/39678d9d8133e11ce149fec6cc005bd93d6b545b/patherr.txt</a></p>
<p>I guess this is more of a nixos error than roc error? but still perhaps we could come to a solution for it</p>



<a name="329356316"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329356316" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> dank <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329356316">(Feb 22 2023 at 07:31)</a>:</h4>
<p>is it planned for the roc compiler itself to ever statically link with musl?<br>
that would be so convenient</p>



<a name="329365702"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329365702" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329365702">(Feb 22 2023 at 08:32)</a>:</h4>
<p>I think we've talked about it before but I don't remember what we concluded.</p>



<a name="329367837"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329367837" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329367837">(Feb 22 2023 at 08:45)</a>:</h4>
<p><span class="user-mention silent" data-user-id="583319">dank</span> <a href="#narrow/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos/near/329299483">said</a>:</p>
<blockquote>
<p>there seems to be a nixos issue when testing code in a path that differs from the roc compiler directory<br>
<a href="https://gist.githubusercontent.com/dankeyy/6497117f3f1550df6340733ed5de74d0/raw/39678d9d8133e11ce149fec6cc005bd93d6b545b/patherr.txt">https://gist.githubusercontent.com/dankeyy/6497117f3f1550df6340733ed5de74d0/raw/39678d9d8133e11ce149fec6cc005bd93d6b545b/patherr.txt</a></p>
<p>I guess this is more of a nixos error than roc error? but still perhaps we could come to a solution for it</p>
</blockquote>
<p>Can you make an issue for this to improve the error message?<br>
For now I think we should recommend using nix-build (using the default.nix). For a nicer long-term fix I expect we can patch the binary with the path we set in NIX_GLIBC_PATH but that may not be straightforward.</p>



<a name="329368476"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329368476" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> dank <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329368476">(Feb 22 2023 at 08:49)</a>:</h4>
<p>sure</p>



<a name="329469471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329469471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329469471">(Feb 22 2023 at 16:15)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> is there any reason we shouldn't statically link it with musl?</p>



<a name="329469549"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329469549" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329469549">(Feb 22 2023 at 16:15)</a>:</h4>
<p>my immediate thought is "yeah let's do it!" but maybe there's a reason not to which I'm missing <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="329469859"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329469859" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329469859">(Feb 22 2023 at 16:16)</a>:</h4>
<p>we should consider a different default allocator then. and probably measure the perf</p>



<a name="329471385"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329471385" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329471385">(Feb 22 2023 at 16:22)</a>:</h4>
<p>I thought we already switched to a nonstandard one awhile ago</p>



<a name="329471403"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329471403" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329471403">(Feb 22 2023 at 16:22)</a>:</h4>
<p>could be misremembering</p>



<a name="329485053"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329485053" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329485053">(Feb 22 2023 at 17:18)</a>:</h4>
<p>We use mimalloc currently</p>



<a name="329485104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329485104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329485104">(Feb 22 2023 at 17:18)</a>:</h4>
<p>Also tested tcmalloc and jemalloc.</p>



<a name="329485188"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329485188" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329485188">(Feb 22 2023 at 17:18)</a>:</h4>
<p>Tcmalloc was the fastest for me, but Linux only and more of a pain to get working, so mimalloc was chosen in the end.</p>



<a name="329492797"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329492797" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329492797">(Feb 22 2023 at 17:50)</a>:</h4>
<p>nice! So is there any reason we shouldn't switch to musl on Linux?</p>



<a name="329500734"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329500734" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329500734">(Feb 22 2023 at 18:29)</a>:</h4>
<p>not that I know of.</p>



<a name="329506982"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329506982" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> dank <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329506982">(Feb 22 2023 at 19:01)</a>:</h4>
<p>I was actually excited about <a href="https://github.com/thiagokokada/nix-alien">https://github.com/thiagokokada/nix-alien</a><br>
but it doesn't seem to work on the Roc binary (fails with an exception that originates from ldd's corrupted output)</p>
<p>maybe the roc binary depends on some stuff other than libgcc/glibc (for example who provides __snprintf_chk? one would've guessed glibc, but I have it installed..), I do not know</p>



<a name="329701146"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329701146" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> dank <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329701146">(Feb 23 2023 at 12:09)</a>:</h4>
<p>could be useful to just write up somewhere the total roc dependencies</p>
<p>right now it's kinda confusing at least to me which are  roc compiler (as in building roc) dependencies and which are roc binary (dynamic) dependencies</p>



<a name="329701619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329701619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> dank <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329701619">(Feb 23 2023 at 12:11)</a>:</h4>
<p>it would also help avoiding issues like the <code>rodio</code>/ <code>alsa</code> dep in the future</p>



<a name="329721364"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/329721364" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#329721364">(Feb 23 2023 at 13:39)</a>:</h4>
<p><span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> I wonder if we could have CI run <code>ldd</code> on the executable and then if the output isn't exactly what we expect, fail the test - so that you couldn't accidentally introduce a new dynamic dep, you'd have to explicitly change that test</p>



<a name="336419251"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/roc%20test%20broken%20in%20nixos/near/336419251" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/roc.20test.20broken.20in.20nixos.html#336419251">(Feb 24 2023 at 08:24)</a>:</h4>
<p>I've made <a href="https://github.com/roc-lang/roc/issues/5067">#5067</a> for this</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
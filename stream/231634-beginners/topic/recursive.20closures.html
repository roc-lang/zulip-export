<html>
<head><meta charset="utf-8"><title>recursive closures Â· beginners Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html">recursive closures</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="344558462"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344558462" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344558462">(Mar 25 2023 at 21:57)</a>:</h4>
<p>Is there anyway around this or am I just out of luck for now?<br>
<a href="/user_uploads/22008/X3iAsZ1kTwvA9RtCY8MktBDj/Screenshot-2023-03-25-at-3.56.03-PM.png">recursive closures</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/X3iAsZ1kTwvA9RtCY8MktBDj/Screenshot-2023-03-25-at-3.56.03-PM.png" title="recursive closures"><img src="/user_uploads/22008/X3iAsZ1kTwvA9RtCY8MktBDj/Screenshot-2023-03-25-at-3.56.03-PM.png"></a></div>



<a name="344558526"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344558526" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344558526">(Mar 25 2023 at 21:58)</a>:</h4>
<p>Can you avoid having a recursive closure and instead just have a recursive function?</p>



<a name="344558798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344558798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344558798">(Mar 25 2023 at 22:01)</a>:</h4>
<p>I'm not sure if there's an easy way to do that. I'm messing with some parser combinator stuff</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="c1"># Will parse any number of '-' followed by a single '+'</span>
<span class="nv">recurTest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">plus</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">map</span><span class="w"> </span><span class="nx">List</span><span class="p">.</span><span class="nx">single</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">orElse</span><span class="w"> </span><span class="p">(</span><span class="nx">prepend</span><span class="w"> </span><span class="nx">minus</span><span class="w"> </span><span class="nx">recurTest</span><span class="p">)</span>
</code></pre></div>



<a name="344559062"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344559062" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344559062">(Mar 25 2023 at 22:05)</a>:</h4>
<p>Ah, since <code>recurTest</code> is passed to the <code>prepend</code> function, it has to be a closure and can't be a normal recursive function.</p>



<a name="344559183"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344559183" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344559183">(Mar 25 2023 at 22:06)</a>:</h4>
<p>I would guess there would be a way to rewrite such that just for this function it doesn't follow parser combinators but more directly parses, but I'm not sure if that would mix with the rest of your parser stuff.</p>



<a name="344559224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344559224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344559224">(Mar 25 2023 at 22:07)</a>:</h4>
<p>But yeah, you may be out of luck with this error. Not completely sure though.</p>



<a name="344559461"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344559461" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344559461">(Mar 25 2023 at 22:10)</a>:</h4>
<p>do you have a small reproduction?</p>



<a name="344559484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344559484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344559484">(Mar 25 2023 at 22:10)</a>:</h4>
<p>this should have been fixed a while ago. I can try to patch it now</p>



<a name="344559655"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344559655" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344559655">(Mar 25 2023 at 22:13)</a>:</h4>
<p>Ya sure! One sec and I'll push it</p>



<a name="344560007"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344560007" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344560007">(Mar 25 2023 at 22:16)</a>:</h4>
<p>Here's where I'm getting the error. It's not exactly small though <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> I'll try and minimize it<br>
<a href="https://github.com/Billzabob/roc-lox/tree/466b693816e0121034bf2bb9ea67bafcecf72cc4">https://github.com/Billzabob/roc-lox/tree/466b693816e0121034bf2bb9ea67bafcecf72cc4</a></p>



<a name="344560061"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344560061" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344560061">(Mar 25 2023 at 22:17)</a>:</h4>
<p>If this useful. It will also hit the issue and is pretty minimal:</p>
<div class="codehilite" data-code-language="CoffeeScript"><pre><span></span><code><span class="nx">app</span><span class="w"> </span><span class="s">"helloWorld"</span>
<span class="w">    </span><span class="nx">packages</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">pf</span><span class="o">:</span><span class="w"> </span><span class="s">"https://github.com/roc-lang/basic-cli/releases/download/0.3/5CcipdhTTAtISf4FwlBNHmyu1unYAV8b0MKRwYiEHys.tar.br"</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nx">imports</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="nx">pf</span><span class="p">.</span><span class="nx">Stdout</span><span class="w"> </span><span class="p">]</span>
<span class="w">    </span><span class="nx">provides</span><span class="w"> </span><span class="p">[</span><span class="nx">main</span><span class="p">]</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">pf</span>


<span class="nv">factCPS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">cont</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nx">cont</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nx">factCPS</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">\</span><span class="nx">value</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">cont</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span>

<span class="nv">main</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="nx">factCPS</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="err">\</span><span class="nx">x</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nx">x</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Num</span><span class="p">.</span><span class="nx">toStr</span>
<span class="w">    </span><span class="o">|&gt;</span><span class="w"> </span><span class="nx">Stdout</span><span class="p">.</span><span class="nx">line</span>
</code></pre></div>



<a name="344560494"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344560494" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344560494">(Mar 25 2023 at 22:21)</a>:</h4>
<p>Here's my minified example, although I'm sure Brendan's is much more useful<br>
<a href="https://github.com/Billzabob/roc-lox/tree/1a4612126b31cccd09f917665e867e5bc69b42b5">https://github.com/Billzabob/roc-lox/tree/1a4612126b31cccd09f917665e867e5bc69b42b5</a></p>



<a name="344567417"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344567417" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344567417">(Mar 25 2023 at 23:40)</a>:</h4>
<p>wow, this is a fun bug! Im out of time for today but I'll make a patch tomorrow or Monday; in the meantime the branch <code>fix-non-nullable-unwrapped-recursive-lset</code> should unblock you.</p>



<a name="344567645"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344567645" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344567645">(Mar 25 2023 at 23:43)</a>:</h4>
<p>Iâ€™ll give it a try! Thank you so much Ayaz! Youâ€™re always coming in clutch ðŸ’ª</p>



<a name="344751585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344751585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344751585">(Mar 27 2023 at 03:34)</a>:</h4>
<p>Finally got to trying this Ayaz. It gave me a massive error:<br>
<a href="/user_uploads/22008/5g0Z3_WD8F6Qgdsz6OQfxZX0/Screenshot-2023-03-26-at-9.33.28-PM.png">Screenshot-2023-03-26-at-9.33.28-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/5g0Z3_WD8F6Qgdsz6OQfxZX0/Screenshot-2023-03-26-at-9.33.28-PM.png" title="Screenshot-2023-03-26-at-9.33.28-PM.png"><img src="/user_uploads/22008/5g0Z3_WD8F6Qgdsz6OQfxZX0/Screenshot-2023-03-26-at-9.33.28-PM.png"></a></div>



<a name="344751732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344751732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344751732">(Mar 27 2023 at 03:36)</a>:</h4>
<p>You can try it on the code in my minimal example link to reproduce it.</p>



<a name="344751902"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344751902" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344751902">(Mar 27 2023 at 03:38)</a>:</h4>
<p>I actually still get errors even if I remove the recursive stuff</p>



<a name="344752817"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344752817" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344752817">(Mar 27 2023 at 03:48)</a>:</h4>
<p>I think that is a debug print that ayaz added. Actual error would be farther down</p>



<a name="344753119"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344753119" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344753119">(Mar 27 2023 at 03:51)</a>:</h4>
<p>Oh shoot I just assumed it was an error <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>  I think my environment is messed up now somehow because now I'm constantly getting this even with the latest nightly of roc. Any idea what's wrong here?<br>
<a href="/user_uploads/22008/uwINFlRopJKmD1S1WQ8EkzV4/Screenshot-2023-03-26-at-9.50.03-PM.png">Screenshot-2023-03-26-at-9.50.03-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/uwINFlRopJKmD1S1WQ8EkzV4/Screenshot-2023-03-26-at-9.50.03-PM.png" title="Screenshot-2023-03-26-at-9.50.03-PM.png"><img src="/user_uploads/22008/uwINFlRopJKmD1S1WQ8EkzV4/Screenshot-2023-03-26-at-9.50.03-PM.png"></a></div>



<a name="344753725"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344753725" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344753725">(Mar 27 2023 at 03:57)</a>:</h4>
<p>Oh, this only happens with the nightly. My older version of the roc compiler works.</p>



<a name="344754223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344754223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344754223">(Mar 27 2023 at 04:02)</a>:</h4>
<p>Anyways, went back to the bugfix branch and ran it again. This is the error at the bottom of all the debug print:<br>
<a href="/user_uploads/22008/6OdlQoIJkpEdbP-FjdWrZ6lj/Screenshot-2023-03-26-at-10.01.18-PM.png">Screenshot-2023-03-26-at-10.01.18-PM.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/22008/6OdlQoIJkpEdbP-FjdWrZ6lj/Screenshot-2023-03-26-at-10.01.18-PM.png" title="Screenshot-2023-03-26-at-10.01.18-PM.png"><img src="/user_uploads/22008/6OdlQoIJkpEdbP-FjdWrZ6lj/Screenshot-2023-03-26-at-10.01.18-PM.png"></a></div>



<a name="344756248"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344756248" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344756248">(Mar 27 2023 at 04:19)</a>:</h4>
<p>Cool, yeah that's the real error.</p>



<a name="344756384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344756384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344756384">(Mar 27 2023 at 04:21)</a>:</h4>
<p>Also, for your other issue. A recently merged commit slightly changed the name of roc functions that get exposed to the platform. So when you update to latest nightly you will have to update the linked function names as well. If you look at an example in the repo, you should be able to see the new names.</p>



<a name="344761723"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344761723" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344761723">(Mar 27 2023 at 05:16)</a>:</h4>
<p>So that would mean I just need to update my version of the CLI platform then? Assuming itâ€™s been updated for that nightly change that is</p>



<a name="344762420"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344762420" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344762420">(Mar 27 2023 at 05:22)</a>:</h4>
<p>Yeah</p>



<a name="344895426"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344895426" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344895426">(Mar 27 2023 at 15:16)</a>:</h4>
<p><span class="user-mention" data-user-id="580063">@Nick Hallstrom</span> could you try again with <a href="https://github.com/roc-lang/roc/pull/5215">https://github.com/roc-lang/roc/pull/5215</a>? I made some other fixes in there. If you get the panic, could you print the backtrace given when you run with <code>RUST_BACKTRACE=1</code> set?</p>



<a name="344925063"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344925063" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344925063">(Mar 27 2023 at 17:17)</a>:</h4>
<p>Haha just got this error:</p>
<div class="codehilite"><pre><span></span><code>I thought a non-nullable-unwrapped variant for a lambda set was impossible: how could such a lambda set be created without a base case?
</code></pre></div>



<a name="344925173"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344925173" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344925173">(Mar 27 2023 at 17:17)</a>:</h4>
<p>Here it is with the backtrace:</p>
<div class="codehilite"><pre><span></span><code>An internal compiler expectation was broken.
This is definitely a compiler bug.
Please file an issue here: https://github.com/roc-lang/roc/issues/new/choose
thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;I thought a non-nullable-unwrapped variant for a lambda set was impossible: how could such a lambda set be created without a base case?&#39;, crates/compiler/mono/src/layout.rs:1644:61
stack backtrace:
   0: rust_begin_unwind
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/std/src/panicking.rs:584:5
   1: core::panicking::panic_fmt
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/core/src/panicking.rs:142:14
   2: roc_mono::layout::LambdaSet::layout_for_member
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/layout.rs:1644:61
   3: roc_mono::layout::LambdaSet::layout_for_member_with_lambda_name
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/layout.rs:1494:9
   4: roc_mono::ir::specialize_proc_help
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3495:27
   5: roc_mono::ir::specialize_variable
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3904:9
   6: roc_mono::ir::Procs::insert_anonymous
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:1204:35
   7: roc_mono::ir::with_hole
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:5091:36
   8: roc_mono::ir::from_can
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:6844:13
   9: roc_mono::ir::specialize_proc_help
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3428:32
  10: roc_mono::ir::specialize_variable
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3904:9
  11: roc_mono::ir::call_by_name_help
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:8435:31
  12: roc_mono::ir::call_by_name
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:8177:17
  13: roc_mono::ir::with_hole
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:5144:21
  14: roc_mono::ir::from_can
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:6844:13
  15: roc_mono::ir::specialize_proc_help
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3428:32
  16: roc_mono::ir::specialize_variable
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3904:9
  17: roc_mono::ir::Procs::insert_passed_by_name
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:1296:23
  18: roc_mono::ir::specialize_symbol
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:7899:25
  19: roc_mono::ir::assign_to_symbol
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:7977:13
  20: roc_mono::ir::assign_to_symbols
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:8011:18
  21: roc_mono::ir::call_specialized_proc
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:8758:17
  22: roc_mono::ir::call_by_name_help
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:8454:33
  23: roc_mono::ir::call_by_name
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:8177:17
  24: roc_mono::ir::with_hole
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:5144:21
  25: roc_mono::ir::from_can
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:6844:13
  26: roc_mono::ir::specialize_proc_help
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3428:32
  27: roc_mono::ir::specialize_variable
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3904:9
  28: roc_mono::ir::specialize_external_help
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3035:9
  29: roc_mono::ir::specialize_external_specializations
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:3015:13
  30: roc_mono::ir::specialize_all
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/mono/src/ir.rs:2947:9
  31: roc_load_internal::file::make_specializations
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/load_internal/src/file.rs:5714:13
  32: roc_load_internal::file::run_task
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/load_internal/src/file.rs:6456:17
  33: roc_load_internal::file::worker_task
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/load_internal/src/file.rs:2254:34
  34: roc_load_internal::file::load_multi_threaded::{{closure}}::{{closure}}
             at /Users/nickhallstrom/Dev/Home/roc/crates/compiler/load_internal/src/file.rs:2054:25
  35: crossbeam_utils::thread::ScopedThreadBuilder::spawn::{{closure}}
             at /Users/nickhallstrom/.cargo/registry/src/github.com-1ecc6299db9ec823/crossbeam-utils-0.8.15/src/thread.rs:440:31
  36: core::ops::function::FnOnce::call_once{{vtable.shim}}
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/core/src/ops/function.rs:248:5
  37: &lt;alloc::boxed::Box&lt;F,A&gt; as core::ops::function::FnOnce&lt;Args&gt;&gt;::call_once
             at /rustc/897e37553bba8b42751c67658967889d11ecd120/library/alloc/src/boxed.rs:1940:9
note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
</code></pre></div>



<a name="344925657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344925657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344925657">(Mar 27 2023 at 17:19)</a>:</h4>
<p>lol nice <span aria-label="laughter tears" class="emoji emoji-1f602" role="img" title="laughter tears">:laughter_tears:</span> do you have a diff or something that you know causes this issue?</p>



<a name="344926084"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344926084" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344926084">(Mar 27 2023 at 17:21)</a>:</h4>
<p>No not really. I haven't been able to get it to compile at all unless I just remove the recursion.</p>



<a name="344931045"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344931045" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344931045">(Mar 27 2023 at 17:46)</a>:</h4>
<p>can you show me what the recursion looks like?</p>



<a name="344969766"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344969766" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344969766">(Mar 27 2023 at 21:18)</a>:</h4>
<p>It's right here:<br>
<a href="https://github.com/Billzabob/roc-lox/blob/1a4612126b31cccd09f917665e867e5bc69b42b5/parser.roc#L11-L12">https://github.com/Billzabob/roc-lox/blob/1a4612126b31cccd09f917665e867e5bc69b42b5/parser.roc#L11-L12</a><br>
I'm trying to get parser combinators working. It's a recursive parser that's failing.</p>



<a name="344984958"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344984958" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344984958">(Mar 27 2023 at 23:16)</a>:</h4>
<p>Nick, could you workaround recursively calling <code>recurTest</code> somehow here? For example, maybe</p>
<div class="codehilite"><pre><span></span><code># Will parse any number of &#39;-&#39; followed by a single &#39;+&#39;
recurTest = oneOrMore minus |&gt; andThen plus
</code></pre></div>
<p>(I can give the definitions of <code>oneOrMore</code> and <code>andThen</code> if it's helpful)</p>
<p>I have a fix for the immediate issue here, but there is a larger, more subtle issue that will probably take us some time to solve with the current pattern (otherwise, with how Roc currently compiles the <code>recurTest</code>, it will result in a stack overflow with no easy fix to avoid it)</p>



<a name="344985640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344985640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344985640">(Mar 27 2023 at 23:22)</a>:</h4>
<p>Well the problem isnâ€™t actually with <code>recurTest</code>, that was me just trying to reproduce it with a simpler example. I need a recursive parser because in the Lox compiler that Iâ€™m trying to build, and expression can be recursive. But itâ€™s not really blocking me so itâ€™s no big deal for now! Thanks a bunch for looking into it!</p>



<a name="344986589"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/344986589" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#344986589">(Mar 27 2023 at 23:31)</a>:</h4>
<p>Okay cool. Let us know if the same panic comes up again, we can try to find workarounds on a case-by-case basis. <br>
(also, pumped to see the Lox compiler!)</p>



<a name="345017116"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345017116" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345017116">(Mar 28 2023 at 03:40)</a>:</h4>
<p>Maybe I need to wait for the Roc compiler to mature a bit more before I'll be able to do this parser combinator stuff <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span> Two more errors that I've encountered:</p>
<div class="codehilite"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;extension variable is another tag union, but I expected it to be either open or closed!&#39;, crates/compiler/types/src/types.rs:4618:21
</code></pre></div>
<p>and</p>
<div class="codehilite"><pre><span></span><code>thread &#39;&lt;unnamed&gt;&#39; panicked at &#39;assertion failed: _old_full_layout.is_none()&#39;, crates/compiler/mono/src/layout/intern.rs:662:9
</code></pre></div>



<a name="345017700"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345017700" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345017700">(Mar 28 2023 at 03:47)</a>:</h4>
<p>Here's a commit that has the former error:<br>
<a href="https://github.com/Billzabob/roc-lox/tree/32cdf0fe646a551063ed4ffacd8a9a325ad3ea46">https://github.com/Billzabob/roc-lox/tree/32cdf0fe646a551063ed4ffacd8a9a325ad3ea46</a><br>
And here's a commit that has the latter error:<br>
<a href="https://github.com/Billzabob/roc-lox/tree/3076c13380f43533bd46bd440fac6992874bb480">https://github.com/Billzabob/roc-lox/tree/3076c13380f43533bd46bd440fac6992874bb480</a></p>



<a name="345228884"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345228884" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345228884">(Mar 28 2023 at 19:51)</a>:</h4>
<p>Thanks! I think both of them will be dealt with in <a href="https://github.com/roc-lang/roc/pull/5221">https://github.com/roc-lang/roc/pull/5221</a> :D</p>



<a name="345279310"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345279310" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345279310">(Mar 29 2023 at 02:22)</a>:</h4>
<p>Ayaz seriously I canâ€™t express how impressive it is that you always squash all these bugs so dang fast! Iâ€™ll try this out right now!</p>



<a name="345279510"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345279510" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nick Hallstrom <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345279510">(Mar 29 2023 at 02:25)</a>:</h4>
<p>Woohoo! Yep that fixed them both! Thank you so so much <span aria-label="pray" class="emoji emoji-1f64f" role="img" title="pray">:pray:</span></p>



<a name="345427857"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345427857" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345427857">(Mar 29 2023 at 14:50)</a>:</h4>
<p>Thanks for continuing to help us surface all these issues!!</p>



<a name="345469680"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345469680" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Balhoff <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345469680">(Mar 29 2023 at 17:23)</a>:</h4>
<p><span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> I'm not sure if it was the same issue, but you may have also fixed my problem here: <a href="https://github.com/roc-lang/roc/issues/5212">https://github.com/roc-lang/roc/issues/5212</a> It works now with the latest build</p>



<a name="345474332"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345474332" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345474332">(Mar 29 2023 at 17:42)</a>:</h4>
<p><span aria-label="heart eyes" class="emoji emoji-1f60d" role="img" title="heart eyes">:heart_eyes:</span> nice! Thanks for the update.</p>



<a name="345475040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345475040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Balhoff <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345475040">(Mar 29 2023 at 17:45)</a>:</h4>
<p>Thank you! This one on the other hand is still a problem (I was hoping they were connected): <a href="https://github.com/roc-lang/roc/issues/5189">https://github.com/roc-lang/roc/issues/5189</a></p>



<a name="345478732"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345478732" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345478732">(Mar 29 2023 at 18:00)</a>:</h4>
<p>Cool, will make sure to take a look - thanks for the ping.</p>



<a name="345532889"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345532889" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ayaz Hafiz <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345532889">(Mar 29 2023 at 23:39)</a>:</h4>
<p><span class="user-mention" data-user-id="588429">@Jim Balhoff</span> I know what the bug here is, I'll try to fix it tomorrow or Friday.</p>



<a name="345534984"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/recursive%20closures/near/345534984" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jim Balhoff <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/recursive.20closures.html#345534984">(Mar 30 2023 at 00:03)</a>:</h4>
<p>That's great, thank you.</p>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Learning questions with 1brc: no args with legacy linker? · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html">Learning questions with 1brc: no args with legacy linker?</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="444781253"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444781253" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444781253">(Jun 14 2024 at 20:15)</a>:</h4>
<p>Hi! I'm new here, and I'm learning Roc by rewriting some coding puzzles I've done previously in Haskell in Roc. I'm currently doing the One Billion Row Challenge (which is basically just parsing a list of cities with temperatures and returning the min/mean/max temperature for each city).</p>
<p>I've gotten thusfar, working from the CLI args example:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">app</span><span class="w"> </span><span class="p">[</span><span class="nv">main</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">pf</span><span class="nf">:</span><span class="w"> </span><span class="nv">platform</span><span class="w"> </span><span class="s">"https://github.com/roc-lang/basic-cli/releases/download/0.10.0/vNe6s9hWzoTZtFmNkvEICPErI9ptji_ySjicO6CkucY.tar.br"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Stdout</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.File</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Task</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Arg</span>

<span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">finalTask</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">pathArg</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">readFirstArgT</span><span class="err">!</span>
<span class="w">        </span><span class="nv">readFileToStr</span><span class="w"> </span><span class="p">(</span><span class="kt">Path</span><span class="nf">.</span><span class="nv">fromStr</span><span class="w"> </span><span class="nv">pathArg</span><span class="p">)</span>

<span class="w">    </span><span class="nv">finalResult</span><span class="w"> </span><span class="nf">&lt;-</span><span class="w"> </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">attempt</span><span class="w"> </span><span class="nv">finalTask</span>

<span class="w">    </span><span class="nv">when</span><span class="w"> </span><span class="nv">finalResult</span><span class="w"> </span><span class="nv">is</span>
<span class="w">        </span><span class="kt">Err</span><span class="w"> </span><span class="kt">ZeroArgsGiven</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">err</span><span class="w"> </span><span class="p">(</span><span class="kt">Exit</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">"Error ZeroArgsGiven"</span><span class="p">)</span>

<span class="w">        </span><span class="kt">Err</span><span class="w"> </span><span class="p">(</span><span class="kt">ReadFileErr</span><span class="w"> </span><span class="nv">errMsg</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">err</span><span class="w"> </span><span class="p">(</span><span class="kt">Exit</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">"Error ReadFileErr:</span><span class="se">\n</span><span class="s">$(errMsg)"</span><span class="p">)</span>

<span class="w">        </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">fileContentStr</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">fileContentStr</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="nv">parse</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span>


<span class="nv">readFirstArgT</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">args</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Arg</span><span class="nf">.</span><span class="nv">list</span><span class="err">!</span>
<span class="w">    </span><span class="nv">dbg</span><span class="w"> </span><span class="nv">args</span>
<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">args</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">mapErr</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">ZeroArgsGiven</span><span class="p">)</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">fromResult</span>


<span class="nv">readFileToStr</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">path</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">path</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">File</span><span class="nf">.</span><span class="nv">readUtf8</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">mapErr</span><span class="w"> </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">ReadFileErr</span><span class="w"> </span><span class="s">"Failed to read file: $(Path.display path)"</span>


<span class="nv">parse</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">contents</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">citiesList</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">split</span><span class="w"> </span><span class="nv">contents</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span>

<span class="w">    </span><span class="nv">results</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">walk</span><span class="w"> </span><span class="nv">citiesList</span><span class="w"> </span><span class="p">(</span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">empty</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="nf">\</span><span class="nv">state</span><span class="p">,</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">cityWithTemp</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">split</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="s">";"</span>
<span class="w">        </span><span class="nv">city</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">when</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">cityWithTemp</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">v</span>
<span class="w">                </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">crash</span><span class="w"> </span><span class="s">"err"</span>

<span class="w">        </span><span class="nv">temp</span><span class="w"> </span><span class="nf">=</span>
<span class="w">            </span><span class="nv">when</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">cityWithTemp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toF64</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                            </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">w</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">w</span>
<span class="w">                            </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">crash</span><span class="w"> </span><span class="s">"err"</span>
<span class="w">                </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">crash</span><span class="w"> </span><span class="s">"err"</span>

<span class="w">        </span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">update</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="nv">city</span><span class="w"> </span><span class="nf">\</span><span class="nv">value</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">when</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                </span><span class="kt">Missing</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="p">,</span><span class="w"> </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="p">,</span><span class="w"> </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMin</span><span class="p">,</span><span class="w"> </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMean</span><span class="p">,</span><span class="w"> </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMax</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kt">Present</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                            </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">min</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="nv">oldMin</span><span class="p">,</span>
<span class="w">                            </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="p">(</span><span class="nv">temp</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">oldMean</span><span class="p">)</span><span class="w"> </span><span class="nf">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                            </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">max</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="nv">oldMax</span><span class="p">,</span>
<span class="w">                        </span><span class="p">}</span>

<span class="w">    </span><span class="nv">results</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">toList</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">map</span><span class="w"> </span><span class="nf">\</span><span class="p">(</span><span class="nv">city</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nv">min</span><span class="p">,</span><span class="w"> </span><span class="nv">mean</span><span class="p">,</span><span class="w"> </span><span class="nv">max</span><span class="p">})</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="s">"$(city): $(Num.toStr min), $(Num.toStr mean), $(Num.toStr max)"</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">joinWith</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span>
</code></pre></div>
<p><code>roc dev</code> tells me "The surgical linker currently has issue <a href="https://github.com/roc-lang/roc/issues/3609">#3609</a> and would fail linking your app. Please use <code>--linker=legacy</code> to avoid the issue for now." I'm not sure which change made it so the surgical linker wouldn't work anymore, but I think it was inbetween when I realised I can't <code>Stdout.line</code> a Dict and have to manually create the string to print. When I run it with the legacy linker (<code>roc dev --linker=legacy -- measurements.txt</code>), it always results in <code>ZeroArgsGiven</code>, and <code>dbg args</code> gives <code>[ ]</code>. If I remember correctly, this wasn't so before I introduced whatever caused the problem with the linker. Could this be, or is it a coincidence? If so, what mistake am I making in my code?</p>
<p>I also wanted to know if there is a way to print, e.g., dicts. I'm used to elements having <code>show</code> in Haskell, so I can do <code>print</code> on basically any structure. Having to do that last <code>results |&gt; Dict.toList |&gt; List.map ... |&gt; Str.joinWith "\n"</code> bit is a bit tedious tbh.</p>
<p>Then, I'm still working on my understanding of error handling, but I'm pretty sure this  is sub-optimal:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">when</span><span class="w"> </span><span class="kt">List</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">cityWithTemp</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">when</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toF64</span><span class="w"> </span><span class="nv">v</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                            </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">w</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">w</span>
<span class="w">                            </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">crash</span><span class="w"> </span><span class="s">"err"</span>
<span class="w">                </span><span class="kt">Err</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">crash</span><span class="w"> </span><span class="s">"err"</span>
</code></pre></div>
<p>Is there something simple I'm missing? Or something more fundamental?</p>
<p>Thanks!</p>



<a name="444790433"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444790433" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444790433">(Jun 14 2024 at 21:09)</a>:</h4>
<p><code>Inspect.toStr</code> should help you</p>



<a name="444790466"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444790466" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444790466">(Jun 14 2024 at 21:09)</a>:</h4>
<p>For printing a dict</p>



<a name="444790694"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444790694" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444790694">(Jun 14 2024 at 21:11)</a>:</h4>
<p>Oh yes! I forgot about <code>Inspect</code>. Thanks.</p>



<a name="444861245"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444861245" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444861245">(Jun 15 2024 at 12:59)</a>:</h4>
<p>I'll do a new basic-cli release soon that should improve the args parsing.<br>
If you want you can use <a href="https://www.roc-lang.org/examples/IngestFiles/README.html">this</a> to simplify the file reading a lot.</p>



<a name="444863658"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444863658" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444863658">(Jun 15 2024 at 13:30)</a>:</h4>
<p>I'm already "watching" the basic-cli repo :) looking forward to it &lt;3<br>
About the <code>import file</code> syntax, does that compile the file into the binary? Because the one billion row file is 14GB haha. Also, I think I'd prefer to keep the file dynamic, so I can benchmark performance on different sizes without recompiling.</p>



<a name="444864421"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444864421" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444864421">(Jun 15 2024 at 13:40)</a>:</h4>
<p>I've rerun the <a href="https://www.roc-lang.org/examples/CommandLineArgs/README.html">CLI args example</a> as is, and it doesn't see the args when using the legacy linker, so it seems the problem is with using the legacy linker. Legacy linker means using shared system libraries and such, right? In which case maybe the problem is because I'm running NixOS. Does anyone know what in my code above prevents the surgical linker from working? I didn't see anything on the issue that seemed relevant.</p>



<a name="444864439"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444864439" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444864439">(Jun 15 2024 at 13:40)</a>:</h4>
<blockquote>
<p>About the <code>import file</code> syntax, does that compile the file into the binary?</p>
</blockquote>
<p>Yes indeed.</p>
<blockquote>
<p>Also, I think I'd prefer to keep the file dynamic, so I can benchmark performance on different sizes without recompiling.</p>
</blockquote>
<p>Makes sense :)</p>



<a name="444864513"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444864513" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444864513">(Jun 15 2024 at 13:41)</a>:</h4>
<blockquote>
<p>In which case maybe the problem is because I'm running NixOS.</p>
</blockquote>
<p>I'm on NixOS as well, I'll see if it is any different on my ubuntu laptop.</p>



<a name="444864885"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444864885" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444864885">(Jun 15 2024 at 13:47)</a>:</h4>
<p>Now that I think of it; for the benchmark later, make sure to use:</p>
<div class="codehilite"><pre><span></span><code>$ roc build yourApp.roc --optimize
</code></pre></div>
<p>And then time the execution of <code>./yourApp cities.csv</code></p>



<a name="444864999"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444864999" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444864999">(Jun 15 2024 at 13:49)</a>:</h4>
<p>Oh yeah, I've been intending to do that but haven't gotten it to build yet in the first place haha <span aria-label="smiling" class="emoji emoji-1f972" role="img" title="smiling">:smiling:</span> but thanks tho</p>



<a name="444865093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444865093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444865093">(Jun 15 2024 at 13:50)</a>:</h4>
<p>I've been following the meta conversation about Roc development, all Richard's talks and podcasts and such, so I know a lot about the way things work, I just haven't actually sat down and written code until now hahaha</p>



<a name="444865840"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444865840" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444865840">(Jun 15 2024 at 14:00)</a>:</h4>
<p>Yeah the behavior is the same on Ubuntu, the tracking issue for this is <a href="https://github.com/roc-lang/basic-cli/issues/82">here</a>.</p>



<a name="444865895"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444865895" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444865895">(Jun 15 2024 at 14:00)</a>:</h4>
<p>Oh huh thanks for confirming</p>



<a name="444867213"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444867213" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444867213">(Jun 15 2024 at 14:15)</a>:</h4>
<p>The <code>Str.toF64</code> is what requires the legacy linker, <code>Str.toU64</code> does work (if I change cities.csv to natural numbers).</p>



<a name="444867576"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444867576" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444867576">(Jun 15 2024 at 14:20)</a>:</h4>
<p>Hm I tried <code>Str.toDec</code> and it segfaulted <span aria-label="skull" class="emoji emoji-1f480" role="img" title="skull">:skull:</span></p>



<a name="444867621"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444867621" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444867621">(Jun 15 2024 at 14:20)</a>:</h4>
<p>Yeah, I tried that too <span aria-label="smiling face with tear" class="emoji emoji-1f972" role="img" title="smiling face with tear">:smiling_face_with_tear:</span></p>



<a name="444867665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444867665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444867665">(Jun 15 2024 at 14:21)</a>:</h4>
<p>I'll see if we have an issue for that</p>



<a name="444868242"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444868242" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444868242">(Jun 15 2024 at 14:29)</a>:</h4>
<p>No issue, it doesn't happen every time when using Str.toDec (in other code), I'll minimize and make an issue.</p>



<a name="444881407"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444881407" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Musab Nazir <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444881407">(Jun 15 2024 at 16:31)</a>:</h4>
<p>I was doing the same challenge (1brc) few weeks ago and ran into what I understand is a refcount performance issue. And I think we also have an open issue to load a large file in chunks which is probably required for the full 1 billion row file<br>
<a href="#narrow/stream/231634-beginners/topic/Profiling.20an.20AoC.20app/near/440118892">https://roc.zulipchat.com/#narrow/stream/231634-beginners/topic/Profiling.20an.20AoC.20app/near/440118892</a></p>
<p>These were some of my numbers for a super naive implementation that stopped after parsing and creating the dict</p>
<div class="codehilite"><pre><span></span><code>1M row file
roc reference: 103271ms
gleam reference: 2251ms
gleam (arrays): 2901ms
go reference: 140ms
</code></pre></div>



<a name="444882887"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444882887" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444882887">(Jun 15 2024 at 16:47)</a>:</h4>
<p>btw this is the issue for reading in chunks: <a href="http://github.com/roc-lang/basic-cli/issues/205">github.com/roc-lang/basic-cli/issues/205</a></p>



<a name="444884198"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444884198" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444884198">(Jun 15 2024 at 16:59)</a>:</h4>
<blockquote>
<p>I'll minimize and make an issue.</p>
</blockquote>
<p><a href="https://github.com/roc-lang/roc/issues/6813">#6813</a></p>



<a name="444891821"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444891821" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444891821">(Jun 15 2024 at 18:08)</a>:</h4>
<p>I've investigated the empty args issue further and also found a <a href="https://github.com/roc-lang/basic-cli/issues/82#issuecomment-2170459561">temporary workaround</a> :)</p>



<a name="444917965"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444917965" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444917965">(Jun 15 2024 at 22:34)</a>:</h4>
<p>Oh I implented that <br>
<a href="https://github.com/roc-lang/basic-cli/pull/206">https://github.com/roc-lang/basic-cli/pull/206</a></p>
<p>Just forgot to add a test script and make it ready for review</p>



<a name="444917981"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444917981" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444917981">(Jun 15 2024 at 22:35)</a>:</h4>
<p>I forgot I had that sitting there</p>



<a name="444983742"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444983742" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444983742">(Jun 16 2024 at 15:10)</a>:</h4>
<p>Ok for completion's sake, I managed to get things working!</p>
<p>Code and results:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">app</span><span class="w"> </span><span class="p">[</span><span class="nv">main</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nv">pf</span><span class="nf">:</span><span class="w"> </span><span class="nv">platform</span><span class="w"> </span><span class="s">"./basic-cli/platform/main.roc"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Stdout</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.File</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Task</span>
<span class="kn">import</span><span class="w"> </span><span class="nc">pf.Arg</span>

<span class="kr">main </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">finalTask</span><span class="w"> </span><span class="nf">=</span>
<span class="w">        </span><span class="nv">pathArg</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">readFirstArgT</span><span class="err">!</span>
<span class="w">        </span><span class="nv">readFileToStr</span><span class="w"> </span><span class="nv">pathArg</span>

<span class="w">    </span><span class="nv">finalResult</span><span class="w"> </span><span class="nf">&lt;-</span><span class="w"> </span><span class="nv">finalTask</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">attempt</span>

<span class="w">    </span><span class="nv">when</span><span class="w"> </span><span class="nv">finalResult</span><span class="w"> </span><span class="nv">is</span>
<span class="w">        </span><span class="kt">Err</span><span class="w"> </span><span class="kt">ZeroArgsGiven</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">err</span><span class="w"> </span><span class="p">(</span><span class="kt">Exit</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">"Error ZeroArgsGiven"</span><span class="p">)</span>
<span class="w">        </span><span class="kt">Err</span><span class="w"> </span><span class="p">(</span><span class="kt">ReadFileErr</span><span class="w"> </span><span class="nv">errMsg</span><span class="p">)</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">err</span><span class="w"> </span><span class="p">(</span><span class="kt">Exit</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">"Error ReadFileErr:</span><span class="se">\n</span><span class="s">$(errMsg)"</span><span class="p">)</span>
<span class="w">        </span><span class="kt">Ok</span><span class="w"> </span><span class="nv">fileContentStr</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">fileContentStr</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="nv">parse</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Inspect</span><span class="nf">.</span><span class="nv">toStr</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Stdout</span><span class="nf">.</span><span class="nv">line</span><span class="err">!</span>
<span class="w">        </span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">err</span><span class="w"> </span><span class="p">(</span><span class="kt">Exit</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="s">"Unknown error"</span><span class="p">)</span>

<span class="nv">readFirstArgT</span><span class="w"> </span><span class="nf">=</span>
<span class="w">    </span><span class="nv">args</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Arg</span><span class="nf">.</span><span class="nv">list</span><span class="err">!</span>
<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">get</span><span class="w"> </span><span class="nv">args</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">mapErr</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">ZeroArgsGiven</span><span class="p">)</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">fromResult</span>

<span class="nv">readFileToStr</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">path</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">path</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">File</span><span class="nf">.</span><span class="nv">readUtf8</span>
<span class="w">    </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Task</span><span class="nf">.</span><span class="nv">mapErr</span><span class="w"> </span><span class="nf">\</span><span class="nv">_</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">ReadFileErr</span><span class="w"> </span><span class="s">"Failed to read file: $(path)"</span>

<span class="nv">parse</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">contents</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">citiesList</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">split</span><span class="w"> </span><span class="nv">contents</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span>

<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">walk</span><span class="w"> </span><span class="nv">citiesList</span><span class="w"> </span><span class="p">(</span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">empty</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="nf">\</span><span class="nv">state</span><span class="p">,</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">cityWithTemp</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">split</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="s">";"</span>
<span class="w">        </span><span class="p">[</span><span class="nv">city</span><span class="p">,</span><span class="w"> </span><span class="nv">t</span><span class="p">]</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">cityWithTemp</span>
<span class="w">        </span><span class="nv">temp</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">withDefault</span><span class="w"> </span><span class="p">(</span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toF32</span><span class="w"> </span><span class="nv">t</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span>

<span class="w">        </span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">update</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="nv">city</span><span class="w"> </span><span class="nf">\</span><span class="nv">value</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">            </span><span class="nv">when</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                </span><span class="kt">Missing</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="p">,</span><span class="w"> </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="p">,</span><span class="w"> </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="p">}</span>
<span class="w">                </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMin</span><span class="p">,</span><span class="w"> </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMean</span><span class="p">,</span><span class="w"> </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMax</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">min</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="nv">oldMin</span><span class="p">,</span>
<span class="w">                        </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="p">(</span><span class="nv">temp</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">oldMean</span><span class="p">)</span><span class="w"> </span><span class="nf">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                        </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">max</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="nv">oldMax</span><span class="p">,</span>
<span class="w">                    </span><span class="p">}</span>
</code></pre></div>
<p><code>hyperfine --warmup 1 -L num 1_000,10_000,100_000,1_000_000 "./main measurements_{num}.txt"</code></p>
<div class="codehilite"><pre><span></span><code>Benchmark 1: ./main ../1brc-hs/measurements_1_000.txt
  Time (mean ± σ):       6.9 ms ±   0.3 ms    [User: 5.8 ms, System: 1.1 ms]
  Range (min … max):     6.2 ms …   8.4 ms    261 runs

Benchmark 2: ./main ../1brc-hs/measurements_10_000.txt
  Time (mean ± σ):      67.6 ms ±   1.2 ms    [User: 65.2 ms, System: 2.0 ms]
  Range (min … max):    65.4 ms …  71.3 ms    42 runs

Benchmark 3: ./main ../1brc-hs/measurements_100_000.txt
  Time (mean ± σ):     661.0 ms ±   5.8 ms    [User: 654.7 ms, System: 3.9 ms]
  Range (min … max):   653.8 ms … 671.7 ms    10 runs

Benchmark 4: ./main ../1brc-hs/measurements_1_000_000.txt
  Time (mean ± σ):      6.557 s ±  0.041 s    [User: 6.510 s, System: 0.025 s]
  Range (min … max):    6.501 s …  6.621 s    10 runs
</code></pre></div>
<p>Which is faster than I got my Haskell code, in a few cases at least! Which was:</p>
<div class="codehilite" data-code-language="Haskell"><pre><span></span><code><span class="cm">{-# LANGUAGE OverloadedStrings #-}</span>
<span class="cm">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span>

<span class="kr">module</span><span class="w"> </span><span class="nn">Main</span><span class="w"> </span><span class="kr">where</span>

<span class="kr">import</span><span class="w"> </span><span class="nn">System.Environment</span><span class="w"> </span><span class="p">(</span><span class="nf">getArgs</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Foldable</span><span class="w"> </span><span class="p">(</span><span class="nf">foldl'</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="k">qualified</span><span class="w"> </span><span class="nn">Data.Map.Strict</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">M</span>
<span class="kr">import</span><span class="w"> </span><span class="k">qualified</span><span class="w"> </span><span class="nn">Data.Text</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span>

<span class="kr">type</span><span class="w"> </span><span class="kt">Results</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">M</span><span class="o">.</span><span class="kt">Map</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="kt">Text</span><span class="w"> </span><span class="p">(</span><span class="kt">Float</span><span class="p">,</span><span class="w"> </span><span class="kt">Float</span><span class="p">,</span><span class="w"> </span><span class="kt">Float</span><span class="p">)</span>

<span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="p">[</span><span class="n">path</span><span class="p">]</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">getArgs</span>
<span class="w">  </span><span class="n">txt</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">readFile</span><span class="w"> </span><span class="n">path</span>
<span class="w">  </span><span class="n">print</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">M</span><span class="o">.</span><span class="n">toList</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">foldl'</span><span class="w"> </span><span class="n">addCity</span><span class="w"> </span><span class="kt">M</span><span class="o">.</span><span class="n">empty</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">lines</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">pack</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">txt</span>

<span class="nf">addCity</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Results</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="kt">Text</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Results</span>
<span class="nf">addCity</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kr">let</span><span class="w"> </span><span class="p">(</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">parseLine</span><span class="w"> </span><span class="n">line</span>
<span class="w">  </span><span class="kr">in</span><span class="w"> </span><span class="kt">M</span><span class="o">.</span><span class="n">insertWith</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="n">city</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span><span class="w"> </span><span class="n">results</span>
<span class="w">      </span><span class="kr">where</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">oldMin</span><span class="p">,</span><span class="w"> </span><span class="n">oldMean</span><span class="p">,</span><span class="w"> </span><span class="n">oldMax</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">              </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">oldMin</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">oldMean</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">max</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="n">oldMax</span><span class="p">)</span>

<span class="nf">parseLine</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="kt">Text</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="kt">Text</span><span class="p">,</span><span class="w"> </span><span class="kt">Float</span><span class="p">)</span>
<span class="nf">parseLine</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Float</span><span class="p">)</span>
<span class="w">    </span><span class="kr">where</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">splitOn</span><span class="w"> </span><span class="s">";"</span><span class="w"> </span><span class="n">line</span>
</code></pre></div>
<p>Which resulted in:</p>
<div class="codehilite" data-code-language="Markdown"><pre><span></span><code>|       rows | runs | result (ms) |       ± |
|-----------:|-----:|------------:|--------:|
|      1 000 |  164 |        13.4 |     0.9 |
|     10 000 |   50 |        52.9 |     3.8 |
|    100 000 |   10 |       386.2 |    10.7 |
|  1 000 000 |   10 |     4 107.0 |    28.0 |
| 10 000 000 |   10 |    47 138.0 | 1 736.0 |
</code></pre></div>
<p>For some reason, the Haskell is faster from 100 000 rows. Since Roc starts out faster, maybe this is a file reading thing? Not sure. (I did compile with <code>--optimize</code>).</p>
<p>I do like the Haskell for being more concise, but then again it doesn't do any error handling.</p>



<a name="444995552"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/444995552" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#444995552">(Jun 16 2024 at 17:01)</a>:</h4>
<p>Just a note, we have a bug that effects dict containing strings and would be killing your perf</p>



<a name="445001048"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445001048" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445001048">(Jun 16 2024 at 17:58)</a>:</h4>
<p>Also, I'm really surprised that this works. It is probably a bug: <code>[city, t] = cityWithTemp</code>. Cause there is no guarantee the list is length 2.</p>



<a name="445006598"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445006598" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445006598">(Jun 16 2024 at 18:49)</a>:</h4>
<p>So, I wrote <a href="https://gist.github.com/bhansconnect/088655a9c821184b9c4bba04204ffc79">a terrible function</a> to instead of using strings, use tuples of 32 U8s. The longest string was 26 bytes, so everything fits in these tuples, but they are way less efficient for hashing than a string. This should actually be a slower solution, but it work around a current refcounting bug.</p>
<p>Your code on my machine (so using <code>Dict Str</code>):</p>
<div class="codehilite"><pre><span></span><code>|       rows | runs | result (ms) |       ± |
|-----------:|-----:|------------:|--------:|
|      1 000 |  294 |         6.8 |     0.4 |
|     10 000 |   55 |        54.9 |     6.5 |
|    100 000 |   10 |       531.8 |    72.8 |
|  1 000 000 |   10 |     5 434.0 |   737.0 |
| 10 000 000 |   10 |    51 639.0 | 6 809.0 |
</code></pre></div>
<p>My slightly modified code to use tuples (so using <code>Dict (U8, ..., U8)</code>):</p>
<div class="codehilite"><pre><span></span><code>|       rows | runs | result (ms) |       ± |
|-----------:|-----:|------------:|--------:|
|      1 000 |  248 |         4.1 |     0.4 |
|     10 000 |  300 |         6.3 |     0.2 |
|    100 000 |   96 |        27.6 |     2.7 |
|  1 000 000 |   12 |       233.2 |     1.1 |
| 10 000 000 |   10 |     2 291.0 |    15.0 |
</code></pre></div>
<p>The <code>Dict Str</code> version should actually be faster than this second version with the tuples, but we have a refcounting bug to finish fixing. So the roc version should be about 20x faster for large inputs.</p>



<a name="445015272"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445015272" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445015272">(Jun 16 2024 at 20:15)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F/near/445001048">said</a>:</p>
<blockquote>
<p>I'm really surprised that this works. It is probably a bug: <code>[city, t] = cityWithTemp</code>. Cause there is no guarantee the list is length 2.</p>
</blockquote>
<p>Oh huh, I think I wrote that with the intention of afterwards chasing down the type errors to do error handling, and then when the checker didn't complain I just forgot about it!</p>



<a name="445015522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445015522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445015522">(Jun 16 2024 at 20:17)</a>:</h4>
<blockquote>
<p>I wrote <a href="https://gist.github.com/bhansconnect/088655a9c821184b9c4bba04204ffc79">a terrible function</a></p>
</blockquote>
<p>thank you, this is beautiful</p>



<a name="445016517"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445016517" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445016517">(Jun 16 2024 at 20:26)</a>:</h4>
<p>It's so exciting to write functional/high-level code — and a pretty naive implementation also — that is just really fast!!</p>



<a name="445019281"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445019281" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445019281">(Jun 16 2024 at 20:54)</a>:</h4>
<p>I tried to investigate the destructuring thing a bit, and tried this input:</p>
<div class="codehilite"><pre><span></span><code>Seoul;8.7
Minneapolis;3.5
El Paso;22.0
Helsinki;9.1
Foo
Reggane;15.4
Gaborone;25.3
Benghazi;31.6
Bridgetown;38.0
Algiers;26.8
Chihuahua;12.9
</code></pre></div>
<p>which resulted in</p>
<div class="codehilite"><pre><span></span><code>{
  &quot;Seoul&quot;: {max: 8.699999809265137, mean: 8.699999809265137, min: 8.699999809265137 },
  &quot;Minneapolis&quot;: {max: 3.5, mean: 3.5, min: 3.5 },
  &quot;El Paso&quot;: {max: 22, mean: 22, min: 22 },
  &quot;Helsinki&quot;: {max: 9.100000381469727, mean: 9.100000381469727, min: 9.100000381469727 },
  &quot;Foo&quot;: {max: 9.100000381469727, mean: 9.100000381469727, min: 9.100000381469727 },
  &quot;Reggane&quot;: {max: 15.399999618530273, mean: 15.399999618530273, min: 15.399999618530273 },
  &quot;Gaborone&quot;: {max: 25.299999237060547, mean: 25.299999237060547, min: 25.299999237060547 },
  &quot;Benghazi&quot;: {max: 31.600000381469727, mean: 31.600000381469727, min: 31.600000381469727 },
  &quot;Bridgetown&quot;: {max: 38, mean: 38, min: 38 },
  &quot;Algiers&quot;: {max: 26.799999237060547, mean: 26.799999237060547, min: 26.799999237060547 },
  &quot;Chihuahua&quot;: {max: 12.899999618530273, mean: 12.899999618530273, min: 12.899999618530273 },
  &quot;&quot;: {max: 12.899999618530273, mean: 12.899999618530273, min: 12.899999618530273 }
}
</code></pre></div>
<p>So, it carried over the previous value for <code>t</code> during the walk.</p>
<p>I also noticed that it added a blank string at the bottom, which is because splitting the input on <code>"\n"</code> results in a blank string at the end (or rather, the file string ends on a <code>\n</code>):</p>
<div class="codehilite"><pre><span></span><code>» Str.split &quot;Seoul;8.7\nMinneapolis;3.5\n&quot; &quot;\n&quot;
[&quot;Seoul;8.7&quot;, &quot;Minneapolis;3.5&quot;, &quot;&quot;] : List Str
</code></pre></div>
<p>Anyway, when I insert <code>dbg cityWithTemp</code> above <code>[city, t] = cityWithTemp</code>, compilation fails with</p>
<div class="codehilite"><pre><span></span><code>This looks like an operator, but it&#39;s not one I recognize!

45│          dbg cityWithTemp
46│          [city, t] = cityWithTemp
                       ^

I have no specific suggestion for this operator, see TODO for the full
list of operators in Roc.
</code></pre></div>
<p>I remember trying <code>[city, t] = Str.split elem ";"</code>, which, trying again, results in the same "looks like an operator" error. I originally thought this was maybe because <code>split</code> can fail, but I realise now it can't, so it must be something else.</p>
<p>Adding <code>dbg</code> after the line works. This:</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="w"> </span><span class="nf">...</span>
<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">walk</span><span class="w"> </span><span class="nv">citiesList</span><span class="w"> </span><span class="p">(</span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">empty</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="nf">\</span><span class="nv">state</span><span class="p">,</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">cityWithTemp</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">split</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="s">";"</span>
<span class="w">        </span><span class="p">[</span><span class="nv">city</span><span class="p">,</span><span class="w"> </span><span class="nv">t</span><span class="p">]</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">cityWithTemp</span>
<span class="w">        </span><span class="nv">dbg</span><span class="w"> </span><span class="nv">cityWithTemp</span>
<span class="w">        </span><span class="nv">dbg</span><span class="w"> </span><span class="nv">t</span>
<span class="w">        </span><span class="nv">temp</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">withDefault</span><span class="w"> </span><span class="p">(</span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toF32</span><span class="w"> </span><span class="nv">t</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="nv">dbg</span><span class="w"> </span><span class="nv">temp</span>

<span class="w">        </span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">update</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="nv">city</span><span class="w"> </span><span class="nf">\</span><span class="nv">value</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nf">...</span>
</code></pre></div>
<p>gives</p>
<div class="codehilite"><pre><span></span><code>...
[main.roc:46] cityWithTemp = [&quot;Helsinki&quot;, &quot;9.1&quot;]
[main.roc:47] t = &quot;9.1&quot;
[main.roc:49] temp = 9.100000381469727

[main.roc:46] cityWithTemp = [&quot;Foo&quot;]
[main.roc:47] t = &quot;9.1&quot;
[main.roc:49] temp = 9.100000381469727

[main.roc:46] cityWithTemp = [&quot;Reggane&quot;, &quot;15.4&quot;]
[main.roc:47] t = &quot;15.4&quot;
[main.roc:49] temp = 15.399999618530273
...
</code></pre></div>



<a name="445021619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445021619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445021619">(Jun 16 2024 at 21:24)</a>:</h4>
<p>Can you try Str.splitFirst there instead of split?</p>



<a name="445021693"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445021693" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445021693">(Jun 16 2024 at 21:25)</a>:</h4>
<p>I think it should be faster and give you a record that can be matched inline like that. As I mentioned earlier, I don't think<code>[city, t] = ...</code> is actually expected to work in general. So it may confuse the compiler.</p>



<a name="445021932"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445021932" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445021932">(Jun 16 2024 at 21:29)</a>:</h4>
<p>Also, the value carry over is definitely a bug. If you could file an issue on GitHub, that would be great.</p>



<a name="445135223"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445135223" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445135223">(Jun 17 2024 at 13:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F/near/445021619">said</a>:</p>
<blockquote>
<p>Can you try Str.splitFirst there instead of split?</p>
</blockquote>
<p>I tried this (not sure if the nested <code>when</code>s is best way to express this <span aria-label="thinking" class="emoji emoji-1f914" role="img" title="thinking">:thinking:</span> )</p>
<div class="codehilite" data-code-language="Elm"><pre><span></span><code><span class="nv">parse</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nf">\</span><span class="nv">contents</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">    </span><span class="nv">citiesList</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">contents</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">split</span><span class="w"> </span><span class="s">"</span><span class="se">\n</span><span class="s">"</span>

<span class="w">    </span><span class="kt">List</span><span class="nf">.</span><span class="nv">walk</span><span class="w"> </span><span class="nv">citiesList</span><span class="w"> </span><span class="p">(</span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">empty</span><span class="w"> </span><span class="p">{})</span><span class="w"> </span><span class="nf">\</span><span class="nv">state</span><span class="p">,</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">        </span><span class="nv">when</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">splitFirst</span><span class="w"> </span><span class="nv">elem</span><span class="w"> </span><span class="s">";"</span><span class="w"> </span><span class="nv">is</span>
<span class="w">            </span><span class="kt">Ok</span><span class="w"> </span><span class="p">{</span><span class="nv">before</span><span class="nf">:</span><span class="w"> </span><span class="nv">city</span><span class="p">,</span><span class="w"> </span><span class="nv">after</span><span class="p">}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                </span><span class="nv">temp</span><span class="w"> </span><span class="nf">=</span><span class="w"> </span><span class="nv">after</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Str</span><span class="nf">.</span><span class="nv">toF32</span><span class="w"> </span><span class="nf">|&gt;</span><span class="w"> </span><span class="kt">Result</span><span class="nf">.</span><span class="nv">withDefault</span><span class="w"> </span><span class="mi">0</span>

<span class="w">                </span><span class="kt">Dict</span><span class="nf">.</span><span class="nv">update</span><span class="w"> </span><span class="nv">state</span><span class="w"> </span><span class="nv">city</span><span class="w"> </span><span class="nf">\</span><span class="nv">value</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                    </span><span class="nv">when</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">is</span>
<span class="w">                        </span><span class="kt">Missing</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="p">,</span><span class="w"> </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="p">,</span><span class="w"> </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="p">}</span>
<span class="w">                        </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMin</span><span class="p">,</span><span class="w"> </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMean</span><span class="p">,</span><span class="w"> </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="nv">oldMax</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="nf">-&gt;</span>
<span class="w">                            </span><span class="kt">Present</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="nv">min</span><span class="nf">:</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">min</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="nv">oldMin</span><span class="p">,</span>
<span class="w">                                </span><span class="nv">mean</span><span class="nf">:</span><span class="w"> </span><span class="p">(</span><span class="nv">temp</span><span class="w"> </span><span class="nf">+</span><span class="w"> </span><span class="nv">oldMean</span><span class="p">)</span><span class="w"> </span><span class="nf">/</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                                </span><span class="nv">max</span><span class="nf">:</span><span class="w"> </span><span class="kt">Num</span><span class="nf">.</span><span class="nv">max</span><span class="w"> </span><span class="nv">temp</span><span class="w"> </span><span class="nv">oldMax</span><span class="p">,</span>
<span class="w">                            </span><span class="p">}</span>

<span class="w">            </span><span class="kt">Err</span><span class="w"> </span><span class="kt">NotFound</span><span class="w"> </span><span class="nf">-&gt;</span><span class="w"> </span><span class="nv">state</span>
</code></pre></div>
<p>and it's actually a tiny bit slower. But by like 1ms in the 1000 line case and 200ms in the 1m line case, so could be insignificant.</p>
<blockquote>
<p>I don't think<code>[city, t] = ...</code> is actually expected to work in general</p>
</blockquote>
<p>oohhh I misunderstood earlier, sorry.</p>
<blockquote>
<p>If you could file an issue on GitHub, that would be great.</p>
</blockquote>
<p>Will do! <span aria-label="salute" class="emoji emoji-1fae1" role="img" title="salute">:salute:</span></p>



<a name="445159345"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445159345" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445159345">(Jun 17 2024 at 15:21)</a>:</h4>
<blockquote>
<p>and it's actually a tiny bit slower</p>
</blockquote>
<p>This intuitively makes some sense to me. I'm pretty sure that <code>[city, t] = ...</code> has no error handling. So it runs faster due to having a bug that is hit if the list isn't exactly (at least?) 2 elements.</p>
<p>Also, does it help if you change the error case to:<br>
<code>Err NotFound -&gt; crash "impossible"</code></p>
<p>Sometimes crashing leads to better optimizations by the compiler</p>



<a name="445161010"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445161010" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445161010">(Jun 17 2024 at 15:27)</a>:</h4>
<p><a href="https://github.com/roc-lang/roc/issues/6816">Issue #6816: Destructuring like <code>[a, b] = ["foo"]</code> should fail, but value for <code>b</code> is held over from previous walk element</a></p>



<a name="445165898"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445165898" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445165898">(Jun 17 2024 at 15:49)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F/near/445159345">said</a>:</p>
<blockquote>
<p>Also, does it help if you change the error case to:<br>
<code>Err NotFound -&gt; crash "impossible"</code></p>
</blockquote>
<p>Problem is, the error case is reached because of the newline at the end of the file and <code>Str.split</code>adds blank strings, e.g., <code>Str.split "foo" "o"</code> =&gt; <code>["f", "", ""]</code>.<br>
I think this is expected behaviour since Haskell's <a href="https://hackage.haskell.org/package/split-0.2.5/docs/Data-List-Split.html#v:splitOn"><code>splitOn</code></a> also does this. I was actually looking for an equivalent of <a href="https://hackage.haskell.org/package/ghc-internal-9.1001.0/docs/src/GHC.Internal.Data.OldList.html#lines"><code>lines</code></a>.</p>



<a name="445167394"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445167394" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445167394">(Jun 17 2024 at 15:55)</a>:</h4>
<p>I see there's <code>Str.trim</code>, will try that in a moment.</p>



<a name="445169751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445169751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Musab Nazir <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445169751">(Jun 17 2024 at 16:06)</a>:</h4>
<p>An interesting observation:<br>
You guys were getting 5-6s for the 1M files and even though my implementation (Dict Str) was virtually identical my M1 mac would finish consistently around 100-110s. After looking into it a lot, it came down to my input generation script. The one I was using, would create the correct number of rows, but it had waaay more unique cities. When I swapped the script to <a href="https://github.com/ifnesi/1brc#submitting">one linked</a> on the official 1brc site I started getting ~5s. This input script only has 413 unique cities whereas my old one could go up to 44k which exacerbates the Dict issue I think</p>



<a name="445169924"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445169924" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445169924">(Jun 17 2024 at 16:07)</a>:</h4>
<p>Trimming the newline at the end before splitting, and using crash on the nofound error:</p>
<div class="codehilite"><pre><span></span><code>Benchmark 1: ./main ../1brc-hs/measurements_1_000.txt
  Time (mean ± σ):       7.1 ms ±   0.3 ms    [User: 5.7 ms, System: 1.3 ms]
  Range (min … max):     6.4 ms …   8.4 ms    267 runs

Benchmark 2: ./main ../1brc-hs/measurements_10_000.txt
  Time (mean ± σ):      69.2 ms ±   0.7 ms    [User: 67.0 ms, System: 1.7 ms]
  Range (min … max):    68.0 ms …  71.8 ms    41 runs

Benchmark 3: ./main ../1brc-hs/measurements_100_000.txt
  Time (mean ± σ):     677.7 ms ±   4.1 ms    [User: 670.1 ms, System: 5.0 ms]
  Range (min … max):   672.5 ms … 686.2 ms    10 runs

Benchmark 4: ./main ../1brc-hs/measurements_1_000_000.txt
  Time (mean ± σ):      6.839 s ±  0.060 s    [User: 6.777 s, System: 0.029 s]
  Range (min … max):    6.755 s …  6.920 s    10 runs
</code></pre></div>
<p>I think this is within the margin of error of the prevous version.</p>



<a name="445170379"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445170379" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Paul Joubert <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445170379">(Jun 17 2024 at 16:09)</a>:</h4>
<p><span class="user-mention" data-user-id="588760">@Musab Nazir</span> oh interesting, and yeah, my test files were generated by the "official" python script.</p>



<a name="445202389"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445202389" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445202389">(Jun 17 2024 at 18:53)</a>:</h4>
<blockquote>
<p>This input script only has 413 unique cities whereas my old one could go up to 44k which exacerbates the Dict issue I think</p>
</blockquote>
<p>Yeah, the issue is linear with the size of the dict</p>



<a name="445202430"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/445202430" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#445202430">(Jun 17 2024 at 18:53)</a>:</h4>
<p>Basically, it is recursively updating all of the refcounts of the stored string keys</p>



<a name="452257270"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452257270" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452257270">(Jul 18 2024 at 06:19)</a>:</h4>
<p>This is a basic impl of 1brc using the latest roc (including <a href="https://github.com/roc-lang/roc/issues/6911">#6911</a>) and basic-cli: <a href="https://github.com/bhansconnect/roc-1brc/blob/main/1brc.roc">https://github.com/bhansconnect/roc-1brc/blob/main/1brc.roc</a></p>
<p>It's only single threaded, so obviously the performance can't be that good. I'm sure it also has tons of room for improvement (probably a lot within roc itself).</p>
<p>Perf result on the full 1 billion rows:</p>
<p>M1 mac 8GB ram: 145s</p>
<p>Linux machine 32GB ram: 272s</p>
<hr>
<p>Assuming perfect parallelism over the 8 cores the test uses, we would expect something in the range of:<br>
M1: 18s<br>
Linux: 34s</p>
<p>For context, good results for the expanded key version of the test start at about 20s and go down as low as 3s. That said, good results also do a lot more tricks than we do (like swar for finding the semicolons).</p>
<hr>
<p>Note: I used the python generator, which actually leads to slower results cause it uses 8,921 weather station names instead of just the 413 of the java generator.</p>



<a name="452257481"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452257481" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452257481">(Jul 18 2024 at 06:20)</a>:</h4>
<p>Comparing to <a href="https://benhoyt.com/writings/go-1brc/">https://benhoyt.com/writings/go-1brc/</a></p>
<p>I am doing something roughly similar to <code>r4</code>. Which took 51s in golang.</p>



<a name="452259305"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452259305" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452259305">(Jul 18 2024 at 06:33)</a>:</h4>
<p>To get a bit more of a direct comparison. This is the timing of <code>r4</code> on my machines with my same input data:<br>
M1: 66s<br>
Linux: 73s</p>
<p>So roughly 2.2x slower currently on M1 and 3.7x slower on linux.</p>



<a name="452260003"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452260003" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452260003">(Jul 18 2024 at 06:35)</a>:</h4>
<p>Perf of the roc code is split as such:<br>
25% list.splitFirst<br>
25% parsing the rest of row (probably the pattern match)<br>
50% Dict.update</p>



<a name="452328181"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452328181" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452328181">(Jul 18 2024 at 12:12)</a>:</h4>
<p>I wonder how much of that is algorithmic differences</p>



<a name="452328236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452328236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452328236">(Jul 18 2024 at 12:12)</a>:</h4>
<p>not sure how splitFirst could be made significantly faster! <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="452376386"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452376386" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452376386">(Jul 18 2024 at 15:34)</a>:</h4>
<p>What do you mean by algorithmic?</p>



<a name="452377814"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452377814" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452377814">(Jul 18 2024 at 15:41)</a>:</h4>
<p>Aside from using an mmap instead of buffered io, the two implementations are almost identical algorithmically. With the caveat that I use pattern matching while go uses manual but roughly equivalent code.</p>



<a name="452381507"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452381507" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452381507">(Jul 18 2024 at 16:00)</a>:</h4>
<p>Also, at a minimum for split, it is doing a ton of redundant checks by calling <code>List.sublist</code> twice. But I would guess that iterating in roc with refcount, tags, and list checks probably costs a solid amount then a quick loop in zig.</p>
<p>Also, for bytes specifically, you can use simd or swar to find much faster.</p>



<a name="452388484"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452388484" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452388484">(Jul 18 2024 at 16:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F/near/452381507">said</a>:</p>
<blockquote>
<p>Also, at a minimum for split, it is doing a ton of redundant checks by calling <code>List.sublist</code> twice. But I would guess that iterating in roc with refcount, tags, and list checks probably costs a solid amount then a quick loop in zig.</p>
</blockquote>
<p>oh interesting! do you think it would be viable to move more of that to zig to avoid redundant checks?</p>



<a name="452394751"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452394751" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452394751">(Jul 18 2024 at 17:06)</a>:</h4>
<p>Yeah, I think we could get a decent gain from moving it into zig.</p>
<p>Also, in this specific case, a bytes specific version could use simd or swar. Which would be even faster, but I don't think the go version does that.</p>



<a name="452409640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452409640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452409640">(Jul 18 2024 at 18:13)</a>:</h4>
<p>I also like the idea of doing that!</p>



<a name="452409724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452409724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452409724">(Jul 18 2024 at 18:14)</a>:</h4>
<p>working with bytes is super common</p>



<a name="452409845"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452409845" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452409845">(Jul 18 2024 at 18:14)</a>:</h4>
<p>and having builtins just automatically run faster for common cases like that seems great</p>



<a name="452409943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452409943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452409943">(Jul 18 2024 at 18:14)</a>:</h4>
<p>it's a good use of builtins <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="452433104"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452433104" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452433104">(Jul 18 2024 at 20:20)</a>:</h4>
<p>Yeah, one note related to that, would also be great if we allowed for special ability specialization for lists of bytes. For example, hashing has <code>addBytes</code>, but you have to wrap a <code>List U8</code> in an opaque type to use it. So <code>List U8</code> hashing is slow by default.</p>
<p>I should actually double check and verify this</p>



<a name="452438172"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452438172" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452438172">(Jul 18 2024 at 20:49)</a>:</h4>
<p>Yeah, doubled checked, <code>List U8</code> hashing is on the slow path by default. It hashes each element individually.</p>



<a name="452439480"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452439480" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452439480">(Jul 18 2024 at 20:55)</a>:</h4>
<p>oh yeah we should totally do that one too</p>



<a name="452439563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452439563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452439563">(Jul 18 2024 at 20:56)</a>:</h4>
<p>same with equality checks for sure</p>



<a name="452439735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452439735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452439735">(Jul 18 2024 at 20:57)</a>:</h4>
<p>yeah, and with equality checks, we can use treat any list of types without pointers (or opaques) as a big list of bytes and just blit over them instead of caring about padding.</p>



<a name="452439929"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452439929" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452439929">(Jul 18 2024 at 20:59)</a>:</h4>
<p>Actually, i guess we could do that with hashing as well...maybe....depends if we want hashing <code>a</code> <code>b</code> and <code>c</code> to be equivalent to hashing <code>[a,b,c]</code>. Where <code>a/b/c</code> are variables of some random type alias.</p>



<a name="452440086"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452440086" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452440086">(Jul 18 2024 at 21:00)</a>:</h4>
<p>Oh wait, list hashing is already different than just hashing the elements...so yeah, any type that can be seen as a bag of bits (memcpy safe in the llvm backend) could use way faster list hashing.</p>



<a name="452440191"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452440191" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452440191">(Jul 18 2024 at 21:00)</a>:</h4>
<p>That said, I do think there is a problem here with ordering of passes. Abilities are generated when we don't know concrete types. These optimizations require knowing the concrete final type.</p>



<a name="452440665"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452440665" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452440665">(Jul 18 2024 at 21:04)</a>:</h4>
<p>concrete as in monomorphized?</p>



<a name="452440795"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452440795" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452440795">(Jul 18 2024 at 21:05)</a>:</h4>
<p>I'd be surprised if there wasn't some way to get that to work without restructuring things, although <span class="user-mention" data-user-id="454654">@Ayaz Hafiz</span> would know better</p>



<a name="452441252"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452441252" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452441252">(Jul 18 2024 at 21:09)</a>:</h4>
<p>Oh, I bet we could just make hashList a low level. So the ability dispatches to hashList. Then the low level should know the concrete type and be able to dispatch farther.</p>



<a name="452441333"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452441333" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452441333">(Jul 18 2024 at 21:10)</a>:</h4>
<p>Or at least something roughly like that. So kinda two steps.</p>



<a name="452441943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452441943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452441943">(Jul 18 2024 at 21:14)</a>:</h4>
<p>Also, as much as I would love to keep dict in roc (and think it should long term be possible to make efficient in roc), we probably could get some large perf gains by moving dict to zig. (oh, and making sure we enable borrow inference for dict and set the same as list and str).</p>
<p>That said, it would be a pretty large project to move dict and may not be worth it for now.</p>



<a name="452443970"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452443970" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452443970">(Jul 18 2024 at 21:32)</a>:</h4>
<p>Do we have a location in the compiler pipeline after/during specialization that we can pick a lowlevel we generate? Thinking about trying to specialize before we get to the backends instead of needing to deal with the specialization in each of the backends. So backends would still just dispatch a function call to zig without any special wiring. I'm assuming this would just be a pass on mono ir. I assume there is already a location in the compiler to add something like this.</p>



<a name="452447875"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452447875" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452447875">(Jul 18 2024 at 22:07)</a>:</h4>
<p>I believe so, although I'm not sure offhand where it is</p>



<a name="452447943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452447943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452447943">(Jul 18 2024 at 22:08)</a>:</h4>
<p>actually I think the lowlevels all do that</p>



<a name="452447995"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452447995" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452447995">(Jul 18 2024 at 22:08)</a>:</h4>
<p>so if you search for pattern matches on lowlevels you might find it (I'm on mobile right now)</p>



<a name="452465752"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452465752" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452465752">(Jul 19 2024 at 01:00)</a>:</h4>
<p>Also, ran this through the <code>poop</code> and definitely some heavy memory issues (I need to test with a large bufreader instead of an mmap). That may be a large part of the perf, but memory issues might be from something else (like mmap loading pages may be label as a cache miss but not actually be that expensive, not sure):</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span>poop<span class="w"> </span>-d<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="s2">"./r4 data/measurements_1_000_000_000.txt"</span><span class="w"> </span><span class="s2">"./1brc data/measurements_1_000_000_000.txt"</span>
<span class="go">Benchmark 1 (3 runs): ./r4 data/measurements_1_000_000_000.txt</span>
<span class="go">  measurement          mean ± σ            min … max           outliers         delta</span>
<span class="go">  wall_time          87.3s  ± 3.30s     83.5s  … 89.5s           0 ( 0%)        0%</span>
<span class="go">  peak_rss           4.15MB ±  227KB    3.89MB … 4.28MB          0 ( 0%)        0%</span>
<span class="go">  cpu_cycles          276G  ±  958M      275G  …  277G           0 ( 0%)        0%</span>
<span class="go">  instructions        471G  ±  175M      471G  …  471G           0 ( 0%)        0%</span>
<span class="go">  cache_references   16.3G  ±  265M     16.0G  … 16.6G           0 ( 0%)        0%</span>
<span class="go">  cache_misses       1.06M  ±  224K      870K  … 1.31M           0 ( 0%)        0%</span>
<span class="go">  branch_misses      2.75G  ± 21.6M     2.74G  … 2.77G           0 ( 0%)        0%</span>
<span class="go">Benchmark 2 (3 runs): ./1brc data/measurements_1_000_000_000.txt</span>
<span class="go">  measurement          mean ± σ            min … max           outliers         delta</span>
<span class="go">  wall_time           169s  ± 10.1s      159s  …  180s           0 ( 0%)        💩+ 94.1% ± 19.6%</span>
<span class="go">  peak_rss           16.0GB ± 74.5KB    16.0GB … 16.0GB          0 ( 0%)        💩+385274.2% ±  9.2%</span>
<span class="go">  cpu_cycles          640G  ± 2.13G      638G  …  642G           0 ( 0%)        💩+131.9% ±  1.4%</span>
<span class="go">  instructions       1.40T  ± 1.59G     1.40T  … 1.40T           0 ( 0%)        💩+197.5% ±  0.5%</span>
<span class="go">  cache_references   10.9G  ±  133M     10.8G  … 11.0G           0 ( 0%)        ⚡- 33.0% ±  2.9%</span>
<span class="go">  cache_misses        462M  ± 1.43M      460M  …  463M           0 ( 0%)        💩+43454.8% ± 218.7%</span>
<span class="go">  branch_misses      2.95G  ± 30.2M     2.92G  … 2.97G           0 ( 0%)        💩+  7.4% ±  2.2%</span>
</code></pre></div>
<p>Highlights ~45x as many cache misses and ~3x as many instructions.</p>



<a name="452465794"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452465794" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452465794">(Jul 19 2024 at 01:01)</a>:</h4>
<p>Also, totally possible all the cache misses are from our dictionary being in two different allocation along with the memory pressure from the giant mmap.</p>



<a name="452465910"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452465910" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452465910">(Jul 19 2024 at 01:02)</a>:</h4>
<p>Also, note, these times are way faster than the times above due to not clearing the page cache between runs. So the file was already in ram more or less.</p>



<a name="452499058"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Learning%20questions%20with%201brc%3A%20no%20args%20with%20legacy%20linker%3F/near/452499058" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Learning.20questions.20with.201brc.3A.20no.20args.20with.20legacy.20linker.3F.html#452499058">(Jul 19 2024 at 06:39)</a>:</h4>
<p>So with a better version of readline, perf is even worse than with the mmap. This version of readline actually accumulates to a RocList directly instead of a Vec (which helped a lot, but not enough):</p>
<div class="codehilite"><pre><span></span><code>Benchmark 1 (3 runs): ./r4 data/measurements_1_000_000_000.txt
  wall_time          77.6s  ± 4.87s     74.5s  … 83.2s           0 ( 0%)        0%
Benchmark 2 (3 runs): ./1brc-mmap data/measurements_1_000_000_000.txt
  wall_time           177s  ± 7.44s      168s  …  182s           0 ( 0%)        💩+127.7% ± 18.4%
Benchmark 3 (3 runs): ./1brc-readlines data/measurements_1_000_000_000.txt
  wall_time           255s  ± 2.91s      252s  …  258s           0 ( 0%)        💩+228.0% ± 11.7%
</code></pre></div>



<hr><p>Last updated: Mar 01 2026 at 12:20 UTC</p>
</html>
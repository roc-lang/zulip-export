<html>
<head><meta charset="utf-8"><title>Export functions in wasm-platforms · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html">Export functions in wasm-platforms</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="423245016"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423245016" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423245016">(Feb 25 2024 at 08:45)</a>:</h4>
<p>Before the update to zig 0.11 is was possible, to export functions in zig to wasm. Since then, only the function <code>_start</code> is exported.</p>
<p>So in the past, it was possible to write something like this in zig:</p>
<div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">export</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">foobar</span><span class="p">(</span><span class="n">some</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">[...]</span>
<span class="w">  </span><span class="n">roc__mainForHost_1_exposed_generic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argument</span><span class="p">);</span>
<span class="w"> </span><span class="p">[...]</span>
<span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">result_ptr</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Now, you can only use <code>_start</code>, which does not accepts any arguments.</p>
<p>The reason is, that zig does not automatically exports functions to wasm since 0.11: <a href="https://ziglang.org/download/0.11.0/release-notes.html#WebAssembly">https://ziglang.org/download/0.11.0/release-notes.html#WebAssembly</a></p>
<p>To solve this, the line <code>"-rdynamic",</code> has to be added here: <a href="https://github.com/roc-lang/roc/blob/2681d81de7b5aeb2e56b15efe9a89dc12dbf7a59/crates/compiler/build/src/link.rs#L1234">https://github.com/roc-lang/roc/blob/2681d81de7b5aeb2e56b15efe9a89dc12dbf7a59/crates/compiler/build/src/link.rs#L1234</a></p>
<p>Would you accept a PR that adds this line? Without it, I don't know how to use roc in a wasm context.</p>



<a name="423273783"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423273783" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423273783">(Feb 25 2024 at 16:09)</a>:</h4>
<p>Won't <code>-rdynamic</code> export everything breaking all dead code elimination?</p>



<a name="423276547"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423276547" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423276547">(Feb 25 2024 at 16:54)</a>:</h4>
<p>I don't know. The real solution will be the platform build script. But until this works, I don't see an alternative to rdynamic</p>



<a name="423280345"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423280345" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423280345">(Feb 25 2024 at 17:57)</a>:</h4>
<p>Sounds like it is equivalent to what they used to do. Even though it blocks dce, it fixes other issues for now... So go for it</p>



<a name="423410445"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423410445" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423410445">(Feb 26 2024 at 14:43)</a>:</h4>
<p>Thank you. Here is the PR: <a href="https://github.com/roc-lang/roc/pull/6542">https://github.com/roc-lang/roc/pull/6542</a></p>



<a name="423760870"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423760870" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423760870">(Feb 28 2024 at 07:30)</a>:</h4>
<p>I see this differently. I don't think this breaks anything,<code>-rdynamic</code> only prevents DCE on things that are exported, which is desired behaviour. It don't think it will "export everything", just the stuff that the platform deliberately chose to export. Is that wrong?</p>



<a name="423762623"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423762623" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423762623">(Feb 28 2024 at 07:47)</a>:</h4>
<p>Is this referring to things exported from the builtins?</p>



<a name="423762880"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423762880" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423762880">(Feb 28 2024 at 07:50)</a>:</h4>
<p>All Wasm modules are dynamic libraries. There isn't really a concept of an executable because you always dynamically link to a host and you can only do IO by calling imported functions. There is no way to do a "syscall" without anybody knowing, like in a native binary. So <code>-rdynamic</code> makes sense for it.</p>



<a name="423763758"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423763758" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423763758">(Feb 28 2024 at 07:57)</a>:</h4>
<p>Our Wasm dev backend does not have a problem with DCE in this situation because it knows the Roc concept of host and app. So it can just expose the things the host wants to expose and doesn't keep any builtins it doesn't need. It's trickier to express that to <code>wasm-ld</code> though. I think you have to give it a list of the things you want to expose. So the platform build script solves it.</p>



<a name="423766438"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423766438" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423766438">(Feb 28 2024 at 08:16)</a>:</h4>
<p>I am currently not on my development pc, so I can not tell you the exact list of exported symbols, but there are more, then needed. You can see it, by calling <code>console.log(wasm.instance.exports)</code>.  For example, it contains all the <code>roc__mainForHost_1_exposed</code>, <code>roc__mainForHost_1_exposed_generic</code> and all other roc_functions, that should only be visible to zig and not to the wasm-host.</p>
<p>This can be solved by the platform build scripts, as soon, as they are possible.</p>



<a name="423768307"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423768307" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423768307">(Feb 28 2024 at 08:29)</a>:</h4>
<p>Another thing, that is currently not nice is, that the wasm-host has to export some wasi-functions. For example, the <a href="https://github.com/roc-lang/roc/blob/main/examples/platform-switching/web-assembly-platform">wasm-platform-switching</a> example does currently not work, because javascript has to provide the function <code>random_get</code>. This seems not necessary. It works, if you provide a dummy function, that does nothing (<code>random_get: () =&gt; {}</code>).</p>
<p>It would be nice, if it would be possible to build a wasm module, that does not require the wasi(nterface). <a href="#narrow/stream/304641-ideas/topic/wasm.20without.20main">We discussed this before without a solution</a>. I don't think, this will change until the platform build scripts are supported.</p>



<a name="423789040"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423789040" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423789040">(Feb 28 2024 at 10:31)</a>:</h4>
<p>Right I see, thanks.<br>
Have you tried using the <code>--dev</code> option with Roc?<br>
It will give you unoptimised code but should solve this linking problem I think.</p>



<a name="423789930"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423789930" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423789930">(Feb 28 2024 at 10:36)</a>:</h4>
<p>Since the PR <a href="https://github.com/roc-lang/roc/issues/6542">#6542</a> is merged, there is no linking problem any more. I have not tested the <code>--dev</code> option. I did not think, that this would have made a difference. I can test this, when I am back home.</p>



<a name="423793261"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423793261" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423793261">(Feb 28 2024 at 10:55)</a>:</h4>
<p>Great, please let me know if it works.<br>
It uses a custom linker that I wrote, that knows about Roc concepts. So it should expose the right things I hope.</p>



<a name="423823660"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423823660" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423823660">(Feb 28 2024 at 13:58)</a>:</h4>
<p><span class="user-mention" data-user-id="431893">@Brian Carroll</span> it does not work. It creates a <code>.wasm</code> file, but if I try to run it in the browser, I get the error message <code>CompileError: wasm validation error: at offset 58727: expected number of function body bytes</code>.</p>
<p>If I call <code>wasm2wat main.wasm</code>, I get the error message: <code>000e567: error: unable to read u32 leb128: function body size</code>.</p>
<p>This happens on my wasm-project, but also on the <a href="https://github.com/roc-lang/roc/tree/main/examples/platform-switching">platform-switching-example</a></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>example/platform-switching
$<span class="w"> </span>roc<span class="w"> </span>build<span class="w"> </span>--target<span class="o">=</span>wasm32<span class="w"> </span>--dev<span class="w"> </span>rocLovesWebAssembly.roc
🔨<span class="w"> </span>Rebuilding<span class="w"> </span>platform...
<span class="m">0</span><span class="w"> </span>errors<span class="w"> </span>and<span class="w"> </span><span class="m">0</span><span class="w"> </span>warnings<span class="w"> </span>found<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1018</span><span class="w"> </span>ms<span class="w"> </span><span class="k">while</span><span class="w"> </span>successfully<span class="w"> </span>building:

<span class="w">    </span>rocLovesWebAssembly.wasm
$<span class="w"> </span>wasm2wat<span class="w"> </span>rocLovesWebAssembly.wasm
000bd24:<span class="w"> </span>error:<span class="w"> </span>unable<span class="w"> </span>to<span class="w"> </span><span class="nb">read</span><span class="w"> </span>u32<span class="w"> </span>leb128:<span class="w"> </span><span class="k">function</span><span class="w"> </span>body<span class="w"> </span>size
</code></pre></div>



<a name="423826585"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423826585" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423826585">(Feb 28 2024 at 14:12)</a>:</h4>
<p>Do you know, when it worked? I am trying to bisec it, but it also fails for version before the zig 0.11 update. Maybe I am doing something wrong?</p>



<a name="423845152"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/423845152" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hristo <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#423845152">(Feb 28 2024 at 15:37)</a>:</h4>
<p>Yeah, this has been tricky for me too to narrow down when exactly the <code>rocLovesWebAssembly.roc</code> example used to be working most recently.</p>
<p>It doesn't seem to cater nicely to a <code>git bisect</code> search, and I tried a linear search (across the entire git history) in steps of 100 commits. What makes it non-trivial it seems is the fact that the examples have been moved around, renamed etc (which isn't an issue in itself, of course).</p>
<p>I think the authors of the example would be able to much more easily pinpoint where the discrepancy might've occurred (if it's indeed an actual discrepancy, and not a misunderstanding of mine how the platform rebuilding should be run; I have been successfully able to rebuild other platforms - just mentioning for completeness).</p>



<a name="424667724"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424667724" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hristo <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424667724">(Mar 04 2024 at 14:30)</a>:</h4>
<p>For completeness, I'd like to confirm that I've been able to successfully (re)build the Wasm32 platform.</p>
<p>I wasn't able to get it to work with the release version of Roc, however. I suppose with a little bit of further digging around the codebase, it should be possible to correctly indicate where the Wasi library lives and run int this way. My attempts involved specifying <code>WASI_LIBC_PATH</code> to the build command, but that didn't quite cut it.</p>
<p>Up until this point, I was getting:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>%<span class="w"> </span>roc<span class="w"> </span>build<span class="w"> </span>--target<span class="o">=</span>wasm32<span class="w"> </span>examples/platform-switching/rocLovesWebAssembly.roc
🔨<span class="w"> </span>Rebuilding<span class="w"> </span>platform...
An<span class="w"> </span>internal<span class="w"> </span>compiler<span class="w"> </span>expectation<span class="w"> </span>was<span class="w"> </span>broken.
This<span class="w"> </span>is<span class="w"> </span>definitely<span class="w"> </span>a<span class="w"> </span>compiler<span class="w"> </span>bug.
Please<span class="w"> </span>file<span class="w"> </span>an<span class="w"> </span>issue<span class="w"> </span>here:<span class="w"> </span>https://github.com/roc-lang/roc/issues/new/choose
thread<span class="w"> </span><span class="s1">'main'</span><span class="w"> </span>panicked<span class="w"> </span>at<span class="w"> </span><span class="s1">'cannot find `wasi-libc.a`'</span>,<span class="w"> </span>crates/compiler/build/src/link.rs:134:5
note:<span class="w"> </span>run<span class="w"> </span>with<span class="w"> </span><span class="sb">`</span><span class="nv">RUST_BACKTRACE</span><span class="o">=</span><span class="m">1</span><span class="sb">`</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>to<span class="w"> </span>display<span class="w"> </span>a<span class="w"> </span>backtrace
</code></pre></div>
<p>Then I realised I could attempt via the locally built version of Roc (following the <a href="https://github.com/roc-lang/roc/blob/main/BUILDING_FROM_SOURCE.md">instructions</a> from the official repo), and this actually solved the issue because the building process had generated <code>./target/release/build/wasi_libc_sys-.../out/wasi-libc.a</code>.</p>
<p>The successful platform (re)build run looks like as follows now (please, note that <code>./target/release/roc</code> isn't the same executable as <code>roc</code>):</p>
<div class="codehilite"><pre><span></span><code>% ./target/release/roc build --target=wasm32 examples/platform-switching/rocLovesWebAssembly.roc
🔨 Rebuilding platform...
0 errors and 0 warnings found in 2000 ms
 while successfully building:

    examples/platform-switching/rocLovesWebAssembly.wasm
</code></pre></div>
<p>The <code>--dev</code> option also works analogously.</p>
<p>Hopefully, this could help someone else as well. Again, with a little bit of spare time for investigation (regarding how the WASI_LIBC_PATH should be set), it probably shouldn't be necessary to build Roc locally from source, in order to get this functionality working.</p>



<a name="424668565"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424668565" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hristo <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424668565">(Mar 04 2024 at 14:33)</a>:</h4>
<p><span class="user-mention" data-user-id="496321">@Oskar Hahn</span>, perhaps you could double-check if a locally built-from-source Roc could solve your Wasm/Wasi issue (unless you're already using a locally built one). The latter might have to do with your local environment, and if the local <code>roc</code> works, this experiment would be a confirmation that it's the Wasm/Wasi environment that's the culprit in this particular context.</p>
<p>My apologies if I've misunderstood the context/use-case, and have been actually providing effectively useless input.</p>



<a name="424682953"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424682953" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424682953">(Mar 04 2024 at 15:32)</a>:</h4>
<p>Quite strange that we need wasi at all. We should look into removing that dependency. Actual roc code should be free of all dependencies except those exposed by the platform</p>



<a name="424684998"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424684998" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hristo <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424684998">(Mar 04 2024 at 15:42)</a>:</h4>
<p><span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span>, I hope I've understood the context correctly here.<br>
In general I do agree with what you've said. However, my understanding is this is in the context of example code, which has to do with platforms, and we can't have a Wasm-platform example code, without this dependency sorted.<br>
Perhaps, it's a matter of better documenting how the example could be run?</p>



<a name="424685943"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424685943" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424685943">(Mar 04 2024 at 15:46)</a>:</h4>
<p>Roc code should never need WASI<br>
Wasm platforms designed for non-browser use cases may use WASI if they want to<br>
Wasm platforms designed for browser-only use cases should not need WASI because WASI is a library for running Wasm in non-browser contexts.<br>
I believe our example is meant to run in the browser so if it is relying on WASI then that is a bug.</p>



<a name="424689312"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424689312" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hristo <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424689312">(Mar 04 2024 at 16:01)</a>:</h4>
<p>Thanks for clarifying <span class="user-mention" data-user-id="431893">@Brian Carroll</span>! I think I understand now better what <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> meant as well!</p>
<p>When I get a chance, I'll try to reproduce the issue in a container for the purpose of confirming whether I consistently get the same error message. <code>crates/compiler/build/src/link.rs</code> is definitely not an examples-only file.</p>
<p>It seems <a href="https://github.com/roc-lang/roc/commit/5fffea969a50a6af6432c652e39f76a56b9a0233">this</a> commit might be relevant.</p>



<a name="424812743"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424812743" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424812743">(Mar 05 2024 at 07:52)</a>:</h4>
<p><span class="user-mention silent" data-user-id="431893">Brian Carroll</span> <a href="#narrow/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms/near/424685943">said</a>:</p>
<blockquote>
<p>Roc code should never need WASI<br>
Wasm platforms designed for non-browser use cases may use WASI if they want to<br>
Wasm platforms designed for browser-only use cases should not need WASI because WASI is a library for running Wasm in non-browser contexts.<br>
I believe our example is meant to run in the browser so if it is relying on WASI then that is a bug.</p>
</blockquote>
<p>Currently, Roc could needs WASI. The roc compiler uses the <code>wasm32-wasi</code> target, to build the binary: <br>
<a href="https://github.com/roc-lang/roc/blob/09e813166720a41af28bcae36b5c978cab6d183c/crates/compiler/build/src/link.rs#L302">https://github.com/roc-lang/roc/blob/09e813166720a41af28bcae36b5c978cab6d183c/crates/compiler/build/src/link.rs#L302</a></p>
<p>and/or</p>
<p><a href="https://github.com/roc-lang/roc/blob/09e813166720a41af28bcae36b5c978cab6d183c/crates/compiler/build/src/link.rs#L1227">https://github.com/roc-lang/roc/blob/09e813166720a41af28bcae36b5c978cab6d183c/crates/compiler/build/src/link.rs#L1227</a></p>
<p>I would really like, if roc would use the <code>wasm32-freestanding</code> target. But this would mean, that it would be impossible to build a wasi module, or that roc would need two different targets (<code>--target=wasm32</code>, <code>--target=wasi</code>).</p>
<p>When zig is compiled with <code>wasm32-wasi</code>, the wasm-module needs some wasi functions to start. For example <code>random_get</code> or <code>_start</code>.</p>



<a name="424813238"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424813238" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424813238">(Mar 05 2024 at 07:57)</a>:</h4>
<p><span class="user-mention silent" data-user-id="693045">Hristo</span> <a href="#narrow/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms/near/424668565">said</a>:</p>
<blockquote>
<p><span class="user-mention silent" data-user-id="496321">Oskar Hahn</span>, perhaps you could double-check if a locally built-from-source Roc could solve your Wasm/Wasi issue (unless you're already using a locally built one). The latter might have to do with your local environment, and if the local <code>roc</code> works, this experiment would be a confirmation that it's the Wasm/Wasi environment that's the culprit in this particular context.</p>
</blockquote>
<p>I also build roc from source. It was possible for me to build the wasm-module with the <code>--dev</code> argument, but the build <code>.wasm</code> file was broken. I was not able to run it in the browser or analyze it with <code>wasm2wat</code>. Without the <code>--dev</code> argument, it works for me. Are you able to run the wasm-module with the <code>--dev</code> flag? <a href="https://github.com/roc-lang/roc/blob/main/examples/platform-switching/web-assembly-platform/README.md">Here is the description who to run it</a></p>



<a name="424821157"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424821157" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hristo <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424821157">(Mar 05 2024 at 08:49)</a>:</h4>
<p>Thanks <span class="user-mention" data-user-id="496321">@Oskar Hahn</span>! Now I'm able to understand the use-case better!</p>
<p>Hmm.. with and without <code>--dev</code>, I'm getting this in the browser console, and no "Hello, World" message rendered on the page:</p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="nx">Uncaught</span><span class="w"> </span><span class="p">(</span><span class="ow">in</span><span class="w"> </span><span class="nx">promise</span><span class="p">)</span><span class="w"> </span><span class="nx">CompileError</span><span class="o">:</span><span class="w"> </span><span class="nx">wasm</span><span class="w"> </span><span class="nx">validation</span><span class="w"> </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="nx">at</span><span class="w"> </span><span class="nx">offset</span><span class="w"> </span><span class="mf">48420</span><span class="o">:</span><span class="w"> </span><span class="nx">expected</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="nx">bytes</span>
<span class="w">    </span><span class="nx">roc_web_platform_run</span><span class="w"> </span><span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:8080/host.js:42</span>
<span class="w">    </span><span class="o">&lt;</span><span class="nx">anonymous</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:8080/:7</span>
</code></pre></div>



<a name="424828290"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424828290" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424828290">(Mar 05 2024 at 09:31)</a>:</h4>
<p>Without --dev, it should work. Make sure to clear the browser cache after recompiling the module. Sometimes it helped for me to restart the python webserver, but not all the time. I have not invested this further.</p>



<a name="424834861"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424834861" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Hristo <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424834861">(Mar 05 2024 at 10:10)</a>:</h4>
<p>Hmm .. I'm getting a different error (without <code>--dev</code>). I somehow think also the calling location matters, but I'll need to perform further tests later on, in order to be able to provide some constructive examples. This happens both in Chrome and Firefox (with a slight difference of the messages) - tried both to confirm that it's not due to browser cache. Also, for the sake of sanity checking (just in case), I've been restarting the server every time, upon recompilation:</p>
<div class="codehilite" data-code-language="JavaScript"><pre><span></span><code><span class="nx">Uncaught</span><span class="w"> </span><span class="p">(</span><span class="ow">in</span><span class="w"> </span><span class="nx">promise</span><span class="p">)</span><span class="w"> </span><span class="nx">LinkError</span><span class="o">:</span><span class="w"> </span><span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">Import</span><span class="w"> </span><span class="err">#</span><span class="mf">2</span><span class="w"> </span><span class="nx">module</span><span class="o">=</span><span class="s2">"wasi_snapshot_preview1"</span><span class="w"> </span><span class="kd">function</span><span class="o">=</span><span class="s2">"random_get"</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="k">import</span><span class="w"> </span><span class="nx">requires</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">callable</span>
</code></pre></div>



<a name="424837949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424837949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424837949">(Mar 05 2024 at 10:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="496321">Oskar Hahn</span> <a href="#narrow/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms/near/423768307">said</a>:</p>
<blockquote>
<p>For example does currently not work, because javascript has to provide the function <code>random_get</code>. This seems not necessary. It works, if you provide a dummy function, that does nothing (<code>random_get: () =&gt; {}</code>).</p>
</blockquote>
<p>You have to add the function <code>random_get</code> to the JavaScript file.</p>
<p>Here is an example: <a href="https://github.com/roc-lang/roc/blob/09e813166720a41af28bcae36b5c978cab6d183c/examples/nodejs-interop/wasm/hello.js#L28">https://github.com/roc-lang/roc/blob/09e813166720a41af28bcae36b5c978cab6d183c/examples/nodejs-interop/wasm/hello.js#L28</a></p>
<p>But I think an empty function does also work.</p>



<a name="424842713"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424842713" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424842713">(Mar 05 2024 at 10:54)</a>:</h4>
<blockquote>
<p>currently Roc could need WASI</p>
</blockquote>
<p>Ok here's my argument.</p>
<p>Roc is a pure functional language that cannot do I/O.</p>
<p>We link to a libc that does all of its I/O through WASI syscalls. But you can't write Roc code that does I/O so it can't possibly use those parts of libc.</p>
<p>Zig is not a pure functional language so it cannot provide these language level guarantees. The only way is to have a separate target for freestanding Wasm.</p>



<a name="424843070"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424843070" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424843070">(Mar 05 2024 at 10:56)</a>:</h4>
<p>I don't understand where the random_get is coming from. I suspect the platform but not sure why it would use it.</p>



<a name="424843325"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424843325" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424843325">(Mar 05 2024 at 10:58)</a>:</h4>
<p>Oh I just noticed something you said that it does come from Zig.</p>



<a name="424843792"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424843792" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424843792">(Mar 05 2024 at 11:01)</a>:</h4>
<p>So the only reason to add a new target to Roc would be to fix this strange Zig behaviour where it does the random_get.</p>



<a name="424844353"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424844353" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424844353">(Mar 05 2024 at 11:04)</a>:</h4>
<p>That doesn't seem like the right move for Roc as a project if it's Zig specific. But I wonder if they're doing this to meet some part of the WASI spec.</p>



<a name="424844457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424844457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424844457">(Mar 05 2024 at 11:05)</a>:</h4>
<p><span class="user-mention silent" data-user-id="431893">Brian Carroll</span> <a href="#narrow/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms/near/424843792">said</a>:</p>
<blockquote>
<p>So the only reason to add a new target to Roc would be to fix this strange Zig behaviour where it does the random_get.</p>
</blockquote>
<p>Yes. And the other functions: <code>proc_exit</code>, <code>fd_write</code> and <code>_start</code>.</p>



<a name="424845348"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424845348" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424845348">(Mar 05 2024 at 11:09)</a>:</h4>
<p>Hmm ok very good point!<br>
Those are more understandable. Any host language will generate proc_exit and _start if you tell it you want WASI. And fd_write is often present for debug printing.<br>
This is a stronger case for adding a freestanding target.</p>



<a name="424846397"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424846397" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424846397">(Mar 05 2024 at 11:15)</a>:</h4>
<p>It would mean changing the Rust enum of targets and fixing up any Rust errors. Then using it to modify the linker commands. Pretty straightforward to implement.</p>



<a name="424847880"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424847880" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424847880">(Mar 05 2024 at 11:25)</a>:</h4>
<p><span class="user-mention" data-user-id="281383">@Richard Feldman</span> I would be interested in your take.</p>
<p>The summary of the above is that any host language build script should have 2 separate targets for browser Wasm and WASI. But currently that build script is inside the Roc compiler and we only have one target (which is implicitly always WASI)</p>
<p>When developing for browser, people have to define dummy JS functions to stub out WASI stuff. It is confusing.</p>
<p>It has been suggested to add a new target, which would only behave differently inside <a href="http://link.rs">link.rs</a>.<br>
In the future if we remove <a href="http://link.rs">link.rs</a> and move host build scripts to the platform developer, we could remove that target from Roc.</p>



<a name="424851640"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424851640" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424851640">(Mar 05 2024 at 11:49)</a>:</h4>
<p>that makes sense, although I'd prefer if we instead made progress on removing <a href="http://link.rs">link.rs</a> if possible <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="424851949"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424851949" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424851949">(Mar 05 2024 at 11:51)</a>:</h4>
<p>Yeah!<br>
What's needed for that? Make a bunch of separate build scripts for each platform we have?</p>



<a name="424852119"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424852119" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424852119">(Mar 05 2024 at 11:52)</a>:</h4>
<p>I guess a good first step would be to extract the existing build commands.</p>



<a name="424852347"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424852347" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424852347">(Mar 05 2024 at 11:53)</a>:</h4>
<p>I added an environment variable recently to dump all the commands. So if you set that flag and compile, it will print out your build commands and you can put them in a bash script or makefile</p>



<a name="424852873"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424852873" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424852873">(Mar 05 2024 at 11:57)</a>:</h4>
<p>nice!</p>



<a name="424853384"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424853384" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424853384">(Mar 05 2024 at 12:00)</a>:</h4>
<p>yeah basically the goal would be that:</p>
<ul>
<li>we always build applications from a precompiled host, so no more <code>"🔨 Rebuilding platform..."</code> message</li>
<li>this means that the individual platform needs to have a script which does the relevant parts of "rebuilding platform" for its host</li>
<li>the goal of the platform build script should be outputting a Roc precompiled host file</li>
</ul>



<a name="424855562"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424855562" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424855562">(Mar 05 2024 at 12:14)</a>:</h4>
<p>OK so we should start recommending that to people who are having build problems.</p>
<ol>
<li>Use <code>ROC_PRINT_BUILD_COMMANDS=1 roc build my-program.roc</code> to see the commands that Roc is using to build your host language code.</li>
<li>Extract those commands into your favourite build system, like a build.zig or a <a href="http://build.rs">build.rs</a> or a makefile.</li>
<li>From then on, use <code>roc build my-program.roc --precompiled-host=&lt;path&gt;</code> and change the commands as you see fit.</li>
</ol>



<a name="424855860"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424855860" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424855860">(Mar 05 2024 at 12:15)</a>:</h4>
<p>And if anyone feels like doing this for the existing examples and basic-cli then that would be a very welcome contribution!</p>



<a name="424856050"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424856050" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424856050">(Mar 05 2024 at 12:16)</a>:</h4>
<p>Oh I should mention that <code>ROC_PRINT_BUILD_COMMANDS=1</code> will only work with a development build of the Roc compiler.</p>



<a name="424913500"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424913500" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424913500">(Mar 05 2024 at 16:47)</a>:</h4>
<p>This sounds amazing, but I was not able to build a non-wasi wasm object with that.</p>
<p>There were different problems. One of them might be this zig issue: <a href="https://github.com/ziglang/zig/issues/15005">https://github.com/ziglang/zig/issues/15005</a> It seems, that when zig 0.11 builds C-code to wasm, it always adds the <code>"wasi_snapshot_preview1" "random_get"</code>.  Roc-code probably counts as C-code. So until this is fixed in zig (and the milestone is set to zig 0.14), it will not be possible to build a wasm-file with roc, that does not need <code>wasi_snapshot_preview1</code>.</p>
<p>When I changed <code>wasm32-wasi</code> to <code>wasm32-freestanding</code> in <code>link.rs</code>, then I was able to build a wasm module, that did not require <code>proc_exit</code>, <code>fd_write</code> or <code>_start</code> (only <code>random_get</code>).</p>
<p>I was not able to get the same result with <code>ROC_PRINT_BUILD_COMMANDS</code> and <code>--precompiled-platform</code> (you write <code>--precompiled-host=&lt;path&gt;</code>, but you probably mean <code>--precompiled-platform</code>).</p>
<p>The reason is, that you not only have to change the "build"-target, but also the "link"-target. See the difference in line 268 and line 1209 in <a href="https://github.com/roc-lang/roc/blob/main/crates/compiler/build/src/link.rs">link.rs</a>.</p>
<p>After I change <a href="https://github.com/roc-lang/roc/blob/d232a843e44ee0f93ea63b5ad4ec7eae17067956/crates/compiler/build/src/link.rs#L1225">line 1225 in link.rs</a>  from <code>build-exe</code> to <code>build-lib</code>  and <a href="https://github.com/roc-lang/roc/blob/d232a843e44ee0f93ea63b5ad4ec7eae17067956/crates/compiler/build/src/link.rs#L1234">line 1234 </a> to <code>wasm32-freestanding-musl</code> and also added the argument <code>-dynamic</code>, I got a wasm-module, that only depends on <code>random_get</code>.</p>
<p>Another problem with <code>ROC_PRINT_BUILD_COMMANDS</code> is, that the build command contains a local path to <code>glue.zig</code>. In my case <code>--mod glue::/home/ossi/src/roc/crates/compiler/builtins/bitcode/src/glue.zig</code>. So it is not possible to add this in a <a href="http://build.rs">build.rs</a> in a git-repo.</p>
<p>In conclusion, I don't think, that the <code>ROC_PRINT_BUILD_COMMANDS</code> is a solution for a freestanding wasm-module.</p>



<a name="424926194"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424926194" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424926194">(Mar 05 2024 at 17:53)</a>:</h4>
<p>What solution could ever possibly exist that does not have this problem?</p>



<a name="424926837"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424926837" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424926837">(Mar 05 2024 at 17:57)</a>:</h4>
<p>This seems to be an input into the build so I suppose it has to be configured somehow.</p>



<a name="424927217"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424927217" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424927217">(Mar 05 2024 at 17:59)</a>:</h4>
<p>That flag was not meant to be a finished solution, it was a starting point to modify.</p>



<a name="424931997"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424931997" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anton <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424931997">(Mar 05 2024 at 18:26)</a>:</h4>
<p>We do include crates/compiler/builtins/bitcode/src/glue.zig in our nightly releases, so the build script could retrieve it from there.</p>



<a name="424961259"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424961259" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Oskar Hahn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424961259">(Mar 05 2024 at 21:36)</a>:</h4>
<p>I am sorry, if my last comment sounded negative. My English is not so good and it is hard for me to express myself. I really liked to look at the build command from <code>ROC_PRINT_BUILD_COMMANDS</code>. I played around with it for more then an hour. I learned so much.</p>



<a name="424966657"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424966657" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brian Carroll <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424966657">(Mar 05 2024 at 22:11)</a>:</h4>
<p>No problem! Glad you found it useful.</p>



<a name="424973522"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424973522" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424973522">(Mar 05 2024 at 23:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="281383">Richard Feldman</span> <a href="#narrow/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms/near/424853384">said</a>:</p>
<blockquote>
<p>yeah basically the goal would be that:</p>
<ul>
<li>we always build applications from a precompiled host, so no more <code>"🔨 Rebuilding platform..."</code> message</li>
<li>this means that the individual platform needs to have a script which does the relevant parts of "rebuilding platform" for its host</li>
<li>the goal of the platform build script should be outputting a Roc precompiled host file</li>
</ul>
</blockquote>
<p>We have an issue for tracking this <a href="https://github.com/roc-lang/roc/issues/6414">#6414</a> if anyone is interested.</p>



<a name="424974789"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424974789" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424974789">(Mar 05 2024 at 23:12)</a>:</h4>
<p>Related issue: <a href="https://github.com/roc-lang/roc/issues/6037">#6037</a></p>



<a name="424974806"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/424974806" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#424974806">(Mar 05 2024 at 23:12)</a>:</h4>
<p>Might be duplicates to some extent</p>



<a name="425056233"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Export%20functions%20in%20wasm-platforms/near/425056233" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Luke Boswell <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Export.20functions.20in.20wasm-platforms.html#425056233">(Mar 06 2024 at 10:46)</a>:</h4>
<p>Yeah looks like a duplicate. I dont mind closing, just want to check we have all the things covered. I wont be able to look at it in any detail for a couple of days.</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>
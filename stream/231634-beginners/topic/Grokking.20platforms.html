<html>
<head><meta charset="utf-8"><title>Grokking platforms · beginners · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/index.html">beginners</a></h2>
<h3>Topic: <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html">Grokking platforms</a></h3>

<hr>

<base href="https://roc.zulipchat.com">

<head><link href="https://roc-lang.github.io/zulip-export/style.css" rel="stylesheet"></head>

<a name="264337573"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264337573" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264337573">(Dec 09 2021 at 17:40)</a>:</h4>
<p>Here's a thread to gather my questions as I attempt to write a "platform author starter pack" (<a class="stream-topic" data-stream-id="304641" href="/#narrow/stream/304641-ideas/topic/Platform.20author.20starter.20pack">#ideas &gt; Platform author starter pack</a>). Hopefully it will be helpful to others as well.</p>
<p>To kick things off: is it possible to export a host function from a file other than the main host? It would be nice to have a separation between the necessary low-level functions like <code>roc_alloc</code> and the effects written by platform author.</p>
<p>Right now, I'm trying in Rust, based on the CLI platform: I create an <code>effects.rs</code> module alongside <code>lib.rs</code>, move the <code>roc_fx_getLine</code> and <code>roc_fx_putLine</code> there and add <code>mod effects</code> to <code>lib.rs</code>. The example fails with a <code>ld</code> error:</p>
<div class="codehilite"><pre><span></span><code>ld: /tmp/roc_appDgDJun.o: in function `roc_fx_getLine_fastcc_wrapper&#39;:
builtins-host:(.text+0x1765): undefined reference to `roc_fx_getLine&#39;
</code></pre></div>
<p>I think the functions are exported on the Rust side: if I leave the original functions in <code>lib.rs</code>, the Rust compiler tells me there's a name conflict. However, I inspected the symbols of <code>host.o</code> with <code>readelf</code> and could not find <code>roc_fx_getLine</code> when I moved it into a separate module.</p>
<p>I'm no expert on the Rust build process, so I may be doing something incorrectly there!</p>
<p>The same question would also be interesting for C &amp; Zig hosts</p>



<a name="264337980"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264337980" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264337980">(Dec 09 2021 at 17:43)</a>:</h4>
<p>Sample code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// platform/src/effects.rs</span>
<span class="k">use</span><span class="w"> </span><span class="n">roc_std</span>::<span class="n">RocStr</span><span class="p">;</span><span class="w"></span>

<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">roc_fx_getLine</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">RocStr</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="p">{</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">BufRead</span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">stdin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">io</span>::<span class="n">stdin</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">line1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdin</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">lines</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">RocStr</span>::<span class="n">from_slice</span><span class="p">(</span><span class="n">line1</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// roc_fx_putLine below</span>
</code></pre></div>



<a name="264338582"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264338582" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264338582">(Dec 09 2021 at 17:46)</a>:</h4>
<blockquote>
<p>To kick things off: is it possible to export a host function from a file other than the main host? It would be nice to have a separation between the necessary low-level functions like roc_alloc and the effects written by platform author.</p>
</blockquote>
<p>Yes. They just use cffi. So all that matters is the name. The linker doesn't care where it came from as a long as the name is right. Probably will just need to import them in the main file or something similar to make sure rust/zig/etc properly expose them.</p>



<a name="264338646"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264338646" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264338646">(Dec 09 2021 at 17:47)</a>:</h4>
<p>Need to look into your exact issue to remember what is missing on the rust side to make sure that is exposed.</p>



<a name="264339735"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264339735" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264339735">(Dec 09 2021 at 17:54)</a>:</h4>
<p>Looks to be that rust is dead code eliminating them</p>



<a name="264341186"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264341186" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264341186">(Dec 09 2021 at 18:03)</a>:</h4>
<p>for example, adding this to the main file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">force_import</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">effect</span>::<span class="n">roc_fx_putLine</span><span class="p">(</span><span class="n">effect</span>::<span class="n">roc_fx_getLine</span><span class="p">());</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>will fix it.</p>



<a name="264341236"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264341236" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264341236">(Dec 09 2021 at 18:03)</a>:</h4>
<p>I am not actually sure the correct rust solution....</p>



<a name="264341447"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264341447" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264341447">(Dec 09 2021 at 18:05)</a>:</h4>
<p>Yes, you're right, that works!</p>



<a name="264342297"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264342297" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264342297">(Dec 09 2021 at 18:11)</a>:</h4>
<p>Trying to find a cleaner way to do this: it seems like Rust is eliminating the use of the <code>effect</code> module itself, since <code>no_mangle</code> should otherwise prevent dead code elimination for the functions</p>



<a name="264342490"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264342490" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264342490">(Dec 09 2021 at 18:13)</a>:</h4>
<p>Yes. Looks like you only need to use one of the functions in the module and it will load them all</p>



<a name="264382318"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264382318" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264382318">(Dec 09 2021 at 23:28)</a>:</h4>
<p>Does anyone know more about the build process for platforms? I tried reproducing the issue in a minimal Rust library and the compiler correctly keeps externally exported functions from another module, even if nothing from that module is used in the main code</p>



<a name="264382463"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264382463" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264382463">(Dec 09 2021 at 23:30)</a>:</h4>
<p>So I suspect there must be something within Roc's build process that leads to that problem. Especially since the linker error is triggered from some temporary <code>roc_appXXX.o</code> object file, created during the process</p>



<a name="264390860"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264390860" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264390860">(Dec 10 2021 at 01:09)</a>:</h4>
<p>More questions:</p>
<ol>
<li>
<p>In Rust hosts, any exposed function that takes a <code>RocStr</code> as argument has to call <code>core::mem::forget</code> on it, to "not mess with the ref count". I guess this is to avoid Rust automatically dropping the string and freeing its memory? Will there be a way to avoid doing this?</p>
</li>
<li>
<p>In the False interpreter example,  when the host opens a file, it wants to return a <code>BufReader&lt;File&gt;</code> to Roc code. To do so, the BufReader is boxed and a U64 is returned to Roc code, then passed back to the Rust host to read bytes.<br>
Is this an idiomatic pattern for platform authors: return pointers as opaque U64 handles from the host, and wrap them in a nice abstraction in the platform Roc code?</p>
</li>
<li>
<p>What is the <code>fx</code> keyword in Roc code exactly? Currently, I've seen the use of <code>fx.Effect</code> when defining effects in the host package config, as well as <code>mainForHost : SomeType as Fx</code></p>
</li>
<li>
<p>What does the first pair of braces stand for in the <code>requires</code> line in <code>Package-Config.roc</code>?<br>
In the only example I've found where it's used (benchmarks example), the generated mainForHost has a different name <code>roc__mainForHost_1_exposed_generic</code> - is that related?</p>
</li>
</ol>



<a name="264392664"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264392664" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264392664">(Dec 10 2021 at 01:32)</a>:</h4>
<p>Don't have time to write out a full answer rn, but this link may help. It is where we call cargo:<br>
<a href="https://github.com/rtfeldman/roc/blob/aab601366ec33affc888c6992209cb028b2c52d1/compiler/build/src/link.rs#L446">https://github.com/rtfeldman/roc/blob/aab601366ec33affc888c6992209cb028b2c52d1/compiler/build/src/link.rs#L446</a></p>



<a name="264401250"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264401250" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264401250">(Dec 10 2021 at 04:12)</a>:</h4>
<blockquote>
<p>So I suspect there must be something within Roc's build process that leads to that problem. Especially since the linker error is triggered from some temporary <code>roc_appXXX.o</code> object file, created during the process</p>
</blockquote>
<p>This is totally possible, but the error shouldn't really relate to <code>roc_appXXX.o</code>. Essential rust is building a static lib. We are building an object file that depends on the lib. It is failing when we try to link. That means that the rust static lib is not exporting the symbol we expect to link against.</p>



<a name="264401683"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264401683" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264401683">(Dec 10 2021 at 04:23)</a>:</h4>
<blockquote>
<ol>
<li>In Rust hosts, any exposed function that takes a <code>RocStr</code> as argument has to call <code>core::mem::forget</code> on it, to "not mess with the ref count". I guess this is to avoid Rust automatically dropping the string and freeing its memory? Will there be a way to avoid doing this?</li>
</ol>
</blockquote>
<p>I think that we should be able to modify the drop function and some ownership pieces to fix this, but I am not completely sure. With the current setup, rust thinks that it is taking ownership of the string we past in while roc thinks that it still has ownership. Either we need to increase the refcount before calling a rust function, or we need rust to not think it owns (and needs to free) the data. Should definitely be possible to clean up, but needs to be looked into more. Specifically around ffi and ownership.</p>
<blockquote>
<ol start="2">
<li>In the False interpreter example,  when the host opens a file, it wants to return a <code>BufReader&lt;File&gt;</code> to Roc code. To do so, the BufReader is boxed and a U64 is returned to Roc code, then passed back to the Rust host to read bytes.<br>
Is this an idiomatic pattern for platform authors: return pointers as opaque U64 handles from the host, and wrap them in a nice abstraction in the platform Roc code?</li>
</ol>
</blockquote>
<p>I would guess that this will become an idiomatic pattern. For complex types that Roc will never use directly, it is simply cleaner to just pass a pointer around. It also stops roc from messing with the type at all. That being said, if we wanted Roc to be able to mess with the type. it would likely just be passed as a struct/record. I think it will be use case dependent, but the opaque type is really ergonomic when done right.</p>
<blockquote>
<ol start="3">
<li>What is the <code>fx</code> keyword in Roc code exactly? Currently, I've seen the use of <code>fx.Effect</code> when defining effects in the host package config, as well as <code>mainForHost : SomeType as Fx</code></li>
</ol>
</blockquote>
<p>Not sure I have a good answer. It is our type for managing side effects and purity. Basically it wraps host related interactions to ensure purity in Roc. <span class="user-mention" data-user-id="281383">@Richard Feldman</span> or <span class="user-mention" data-user-id="281543">@Folkert de Vries</span>  might have a vetter technical answer to this.</p>
<blockquote>
<ol start="4">
<li>What does the first pair of braces stand for in the <code>requires</code> line in <code>Package-Config.roc</code>?<br>
In the only example I've found where it's used (benchmarks example), the generated mainForHost has a different name <code>roc__mainForHost_1_exposed_generic</code> - is that related?</li>
</ol>
</blockquote>
<p>Don't know. Again, probably <span class="user-mention" data-user-id="281383">@Richard Feldman</span> or <span class="user-mention" data-user-id="281543">@Folkert de Vries</span>  know.<br>
Thought I think I know a bit about <code>roc__mainForHost_1_exposed_generic</code>, it is related to the types being passed by the function and if it needs to be generic for returning more complex types. In this case specifically, I think it returns a closure that could have dynamic size.</p>



<a name="264401693"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264401693" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264401693">(Dec 10 2021 at 04:23)</a>:</h4>
<p><span class="user-mention silent" data-user-id="460799">Erwin Kuhn</span> <a href="#narrow/stream/231634-beginners/topic/Grokking.20platforms/near/264382318">said</a>:</p>
<blockquote>
<p>Does anyone know more about the build process for platforms? I tried reproducing the issue in a minimal Rust library and the compiler correctly keeps externally exported functions from another module, even if nothing from that module is used in the main code</p>
</blockquote>
<p>Can you share this code so I can double check some things?</p>



<a name="264443399"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264443399" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264443399">(Dec 10 2021 at 13:03)</a>:</h4>
<blockquote>
<p>In Rust hosts, any exposed function that takes a <code>RocStr</code> as argument has to call <code>core::mem::forget</code> on it, to "not mess with the ref count". I guess this is to avoid Rust automatically dropping the string and freeing its memory? Will there be a way to avoid doing this?</p>
</blockquote>
<p>I think we can avoid this by having all <code>extern</code> host functions take a <a href="https://doc.rust-lang.org/std/mem/struct.ManuallyDrop.html#method.take"><code>ManuallyDrop&lt;RocStr&gt;</code></a> (or <code>ManuallyDrop&lt;RocList&lt;Whatever&gt;&gt;</code> etc.) - that will automatically tell Rust not to invoke <code>drop</code> on it.</p>
<p>If we get in the habit of doing that, then hopefully it will look weird to see an <code>extern</code> function in a host that doesn't have <code>ManuallyDrop</code> around all of its (non-<code>Copy</code>) arguments, which would be less error-prone than calling <code>forget</code> I suspect.</p>



<a name="264452148"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264452148" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264452148">(Dec 10 2021 at 14:11)</a>:</h4>
<p>Regarding <code>RocStr</code> etc...: couldn't we build the manual drop into the type, to ensure ref count safety? If I'm not mistaken, once you wrap something into <code>ManuallyDrop</code>, Rust hands it off completely.</p>
<p>Here's a simple example that builds a slice of custom structs, while taking them out of the Rust drop order: <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=ed86e540e0a17e1aa8b78dfe1da076c0">https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2021&amp;gist=ed86e540e0a17e1aa8b78dfe1da076c0</a></p>



<a name="264453474"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264453474" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Folkert de Vries <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264453474">(Dec 10 2021 at 14:21)</a>:</h4>
<p>well the "automatic drop" variant is also nice sometimes, e.g. in our code gen tests</p>



<a name="264454022"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264454022" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264454022">(Dec 10 2021 at 14:24)</a>:</h4>
<p>I think it could be interesting to improve the platform authoring experience in Rust though, as long as it doesn't cause problems elsewhere</p>



<a name="264454051"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264454051" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264454051">(Dec 10 2021 at 14:24)</a>:</h4>
<p>(but I think <code>roc_std</code> is only meant for platform code right?)</p>



<a name="264454471"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264454471" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264454471">(Dec 10 2021 at 14:28)</a>:</h4>
<p><span class="user-mention silent" data-user-id="343810">Brendan Hansknecht</span> <a href="#narrow/stream/231634-beginners/topic/Grokking.20platforms/near/264401693">said</a>:</p>
<blockquote>
<p>Can you share this code so I can double check some things?</p>
</blockquote>
<p>Sure! I'll fork the repo, so that you can plug into the CLI example right away. I'll be able to do that in a few hours</p>



<a name="264456498"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264456498" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264456498">(Dec 10 2021 at 14:44)</a>:</h4>
<p>one thing I'm not sure about is whether platform authors might end up wanting to use <code>roc_std</code> data structures as intermediate values, in which case they'd want <code>Drop</code> to work as normal.</p>



<a name="264456532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264456532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Richard Feldman <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264456532">(Dec 10 2021 at 14:45)</a>:</h4>
<p>it hasn't come up yet, but maybe it will? I'm really not sure!</p>



<a name="264527591"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264527591" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264527591">(Dec 11 2021 at 00:10)</a>:</h4>
<p>Yes, I assumed types like <code>RocStr</code> or <code>RocList</code> were meant purely for interoperability when getting / returning values from Roc -- but that may be only a subset of the goal of <code>roc_std</code>!</p>



<a name="264528093"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528093" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528093">(Dec 11 2021 at 00:17)</a>:</h4>
<p>My thinking was along the lines of: would it be possible for platform authors to not have to think about how Roc talks to their host language (at least not too much)?</p>



<a name="264528169"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528169" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528169">(Dec 11 2021 at 00:18)</a>:</h4>
<p>To be fair, this is mostly a rust problem. Wouldn't be an issue in zig or c/c++</p>



<a name="264528184"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528184" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528184">(Dec 11 2021 at 00:18)</a>:</h4>
<p>Since rust cares about ownership and such.</p>



<a name="264528212"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528212" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528212">(Dec 11 2021 at 00:19)</a>:</h4>
<p>But maybe I am wrong</p>



<a name="264528224"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528224" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528224">(Dec 11 2021 at 00:19)</a>:</h4>
<p>Yes I think that's totally fair!</p>



<a name="264528234"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528234" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528234">(Dec 11 2021 at 00:19)</a>:</h4>
<p>I'm more used to Rust, hence my questions around it</p>



<a name="264528317"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528317" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528317">(Dec 11 2021 at 00:20)</a>:</h4>
<p>Totally fair</p>



<a name="264528367"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528367" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528367">(Dec 11 2021 at 00:21)</a>:</h4>
<p>I think in zig you can just make an extern struct for most of that</p>



<a name="264528437"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528437" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528437">(Dec 11 2021 at 00:22)</a>:</h4>
<p>it seems the platform author definitely needs to be aware of that, it's slightly the point I think. For app authors not at all</p>



<a name="264528524"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528524" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528524">(Dec 11 2021 at 00:23)</a>:</h4>
<p>but I might have misunderstood the question</p>



<a name="264528619"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528619" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528619">(Dec 11 2021 at 00:24)</a>:</h4>
<p>by "that" I meant, the general low-level shape of RocList and RocStr vs. <code>[1, 2, 3]</code> and <code>"some str"</code></p>



<a name="264528624"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528624" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528624">(Dec 11 2021 at 00:24)</a>:</h4>
<p>I think it would be a good general guide (at least for now) to have all of the rust platforms use <code>ManuallyDrop&lt;T&gt;</code> for all of the <code>_fx_</code> functions in order to remove the forgets and such. It would be a reasonable standard that makes the ownership clear.</p>



<a name="264528668"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528668" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528668">(Dec 11 2021 at 00:25)</a>:</h4>
<p>Not sure the case for data passed into roc.</p>



<a name="264528704"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528704" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528704">(Dec 11 2021 at 00:25)</a>:</h4>
<p>do we plan on having like packages for Rust/C/Zig for these data types that platform authors can just import and use?</p>



<a name="264528771"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528771" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528771">(Dec 11 2021 at 00:26)</a>:</h4>
<p>I think that's the goal of <code>roc_std</code> in Rust, right? Mostly due to the trickeries of Rust's ownership model, but still</p>



<a name="264528784"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528784" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528784">(Dec 11 2021 at 00:26)</a>:</h4>
<p>and maybe also like convenient functions for some ops on them</p>



<a name="264528794"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528794" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528794">(Dec 11 2021 at 00:26)</a>:</h4>
<p><code>roc_std</code> was made because the compiler is written in rust</p>



<a name="264528809"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528809" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528809">(Dec 11 2021 at 00:26)</a>:</h4>
<p>Other languages, I think the plan was to not directly support</p>



<a name="264528825"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528825" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528825">(Dec 11 2021 at 00:27)</a>:</h4>
<p>right, I'm imagining a world where the compiler doesn't execute the platforms build command which is where we are heading eventually</p>



<a name="264528867"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528867" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528867">(Dec 11 2021 at 00:27)</a>:</h4>
<p>As in, probably  someone who knows roc really well will maintain the version for c or zig or rust, but they will not be 100% roc official. That plan may change in the future</p>



<a name="264528921"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528921" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528921">(Dec 11 2021 at 00:28)</a>:</h4>
<p>fair enough, too many langs to maintain them all</p>



<a name="264528924"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528924" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528924">(Dec 11 2021 at 00:28)</a>:</h4>
<p>I would guess roc will officially support a small subset and contrib of some sort will support other languages</p>



<a name="264528948"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264528948" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264528948">(Dec 11 2021 at 00:28)</a>:</h4>
<p>but we could have a rust one as a base for people to reference when doing it for other lang platforms</p>



<a name="264529025"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529025" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529025">(Dec 11 2021 at 00:29)</a>:</h4>
<p>it was really cool to see it done in swift and then have it run on iOS a few weeks ago</p>



<a name="264529118"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529118" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529118">(Dec 11 2021 at 00:30)</a>:</h4>
<p>there's Oden, Nim, D, C++ etc. so no way we would have the capacity to maintain all those</p>



<a name="264529144"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529144" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529144">(Dec 11 2021 at 00:31)</a>:</h4>
<p>maybe if there was a spec that we could output to json and then other people could code gen that stuff</p>



<a name="264529457"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529457" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529457">(Dec 11 2021 at 00:35)</a>:</h4>
<p>So question for <span class="user-mention" data-user-id="281383">@Richard Feldman</span> or <span class="user-mention" data-user-id="281543">@Folkert de Vries</span>: Does Roc essentially assume that anything past into an <code>_fx_</code> function will never be freed? Like is it guaranteed that roc will later decrement the refcount for that and free it.</p>



<a name="264529483"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529483" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529483">(Dec 11 2021 at 00:36)</a>:</h4>
<p>I think so</p>



<a name="264529532"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529532" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529532">(Dec 11 2021 at 00:36)</a>:</h4>
<p>oh well actually, would that ruin referential transparency?</p>



<a name="264529559"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529559" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529559">(Dec 11 2021 at 00:37)</a>:</h4>
<p>or at least how does that effect the in-place optimizations</p>



<a name="264529605"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529605" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529605">(Dec 11 2021 at 00:38)</a>:</h4>
<p>wait nvm, I read what you said again, I think my questions don't make sense</p>



<a name="264529715"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529715" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529715">(Dec 11 2021 at 00:39)</a>:</h4>
<p>Mmh, host code can retain a reference to some list, right? I think Roc doesn't increase the ref count when passing the list to host code, so it could end up doing in-place mutations of that list</p>



<a name="264529798"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264529798" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264529798">(Dec 11 2021 at 00:40)</a>:</h4>
<p>that's what I'm wondering, I haven't touched any ref counting code, it's the part I know the least about</p>



<a name="264530073"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264530073" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264530073">(Dec 11 2021 at 00:45)</a>:</h4>
<p>Actually, the problem of <code>ManuallyDrop</code> in Rust is different from ref counting if I understand it correctly (it's about freeing memory), so let me take back that assumption <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span></p>



<a name="264530459"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264530459" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264530459">(Dec 11 2021 at 00:51)</a>:</h4>
<p>yeah, this is a weird set of tradeoffs:</p>
<p>current method (don't touch refcount):</p>
<ul>
<li>Definitely faster. The refcount is in memory and slow to load/update</li>
<li>host can safely retain a copy of a list by update the refcount while running the function</li>
<li>host can just look at the refcount. if 1 do inplace mutations</li>
<li>Some location require <code>ManuallyDrop</code></li>
</ul>
<p>option 2- always increment refcount when passing to host if referenced again in roc:</p>
<ul>
<li>probably safer and likely less bug prone in most host languages. (most languages have some form of scope based lifetimes and drop/destructors/etc)</li>
<li>Requires touching the refcount in more locations, which is slow, but probably not a big deal since most locations will likely touch in memory data anyway.</li>
<li>In place mutation gets more confusing on the host. If the refcount is 2, that is the host and a location in the app. Should be safe. If the refcount is 1, that would mean that the host is expected to mutate in place and then return a new list/str/etc.</li>
</ul>



<a name="264530563"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264530563" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264530563">(Dec 11 2021 at 00:52)</a>:</h4>
<p>Also <code>ManuallyDrop</code> will correctly deal with reference counting/intentionally avoid it. The drop function of RocStr checks the reference count before potentially calling dealloc.</p>



<a name="264531215"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264531215" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264531215">(Dec 11 2021 at 01:01)</a>:</h4>
<p>So currently, the host cannot distinguish between 1) the object still has 1 reference in Roc and 2) the object has no more reference in Roc, after being passed to the host?</p>



<a name="264531296"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264531296" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264531296">(Dec 11 2021 at 01:03)</a>:</h4>
<p>Currently Roc always has 1 or more references.</p>



<a name="264532175"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264532175" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264532175">(Dec 11 2021 at 01:17)</a>:</h4>
<p>In that case, if Roc passes an object to the host, that is never referenced again in Roc afterwards, the reference count will go to 0 at the end of the scope containing the host call and the object will be cleaned up?</p>



<a name="264532458"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264532458" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264532458">(Dec 11 2021 at 01:22)</a>:</h4>
<p>That sounds correct to me.</p>



<a name="264532488"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264532488" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264532488">(Dec 11 2021 at 01:23)</a>:</h4>
<p>It actually will likely be the next statement after the call to the host. That statement will likely be to decrement the refcount(and maybe free)</p>



<a name="264534328"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264534328" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264534328">(Dec 11 2021 at 02:02)</a>:</h4>
<p>OK so the <code>Drop</code> implementation for <code>RocStr</code> is never meant to be run in Rust host code then, since it either decrements the ref count or frees the memory, which messes up with Roc's memory management</p>



<a name="264534404"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264534404" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264534404">(Dec 11 2021 at 02:03)</a>:</h4>
<p>Would it be interesting to have a custom data type for objects passed from Roc to the host, that exposes the ref count to platform authors? Ex: allow incrementing the ref count, to signal to Roc that you're keeping a reference within the host</p>



<a name="264534418"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264534418" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264534418">(Dec 11 2021 at 02:03)</a>:</h4>
<p>That would encode the contract of "we don't increase the ref count when passing something to the host"</p>



<a name="264536059"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264536059" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lucas Rosa <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264536059">(Dec 11 2021 at 02:38)</a>:</h4>
<p>that could be tricky because we can’t necessarily assume a particular language for the platform. Rust isn’t necessarily first class for platform building just the C ABI is</p>



<a name="264536255"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264536255" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264536255">(Dec 11 2021 at 02:42)</a>:</h4>
<p>I think this question would just be for the rust platform, and it is really a question of what the semantics should be for <code>roc_std</code>. So I think it is a valid question and doable. I mean the refcount is already there and being accessed by the current forms of <code>RocStr</code> and etc.</p>



<a name="264552341"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264552341" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264552341">(Dec 11 2021 at 09:29)</a>:</h4>
<p>Putting Rust aside, anyone writing a platform will have to work with the ref count, if they want to keep a reference to some object within the host, or perform in-place mutations for performance, right?</p>



<a name="264552620"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264552620" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264552620">(Dec 11 2021 at 09:35)</a>:</h4>
<p>While in the long-run, Roc aims to be agnostic to the platform language and those types should be part of an external <code>roc_std</code> for each lang, would it be interesting to start providing those for, say, C, Rust and Zig, to start experimenting and see if those abstractions feel right for platform authors?</p>



<a name="264552748"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264552748" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264552748">(Dec 11 2021 at 09:38)</a>:</h4>
<p>It may also be helpful for discussions around the design of platforms, since it's been mentioned that that part of the language will likely evolve a lot</p>



<a name="264555376"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264555376" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264555376">(Dec 11 2021 at 10:42)</a>:</h4>
<p>Maybe the more general question is: how should platform authors think about Roc's reference counting?</p>



<a name="264575711"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264575711" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264575711">(Dec 11 2021 at 18:03)</a>:</h4>
<p><span class="user-mention silent" data-user-id="460799">Erwin Kuhn</span> <a href="#narrow/stream/231634-beginners/topic/Grokking.20platforms/near/264552341">said</a>:</p>
<blockquote>
<p>Putting Rust aside, anyone writing a platform will have to work with the ref count, if they want to keep a reference to some object within the host, or perform in-place mutations for performance, right?</p>
</blockquote>
<p>The entire type is exposed. Exactly what Roc sees internally can be used externally. So I guess I was just trying to point out that this is a per language api question rather than a Roc design question. The design of roc types is pretty concrete at this point. Though we do have a few minor optimization changes to make.</p>
<div class="codehilite"><pre><span></span><code>would it be interesting to start providing those for, say, C, Rust and Zig, to start experimenting and see if those abstractions feel right for platform authors?
</code></pre></div>
<p>100%. Though would probably swap out C for C++ (personal preference and more automatic memory management). I overall think that it won't be too complex of a task to make these apis and make them function ergonomically. I think the rust <code>roc_std</code> is probably most of the way there for the types it exposes, but would be good to make a test platform in multiple languages that heavily exercises interactions with roc types and refcounting.</p>
<div class="codehilite"><pre><span></span><code>how should platform authors think about Roc&#39;s reference counting?
</code></pre></div>
<p>In the current state (to my understanding):</p>
<ul>
<li>All roc interactions run in a single thread, so atomics are not needed. (multi-threading dealt with by the host)</li>
<li>The reference count (though in a weird format) is just a number stored with the memory to be freed.</li>
<li>Assuming the host doesn't change it, the number is the number of locations in roc that could view the data.</li>
<li>Roc will automatically increment and decrement it as needed based on scopes and references.</li>
<li>If Roc sees a refcount of 1, it is allowed to do inplace mutations.</li>
<li>When passing data to the host, the refcount is not changed (this may not be 100% true, it may follow the same rules as roc function calls and scoping).</li>
<li>If the host sees a refcount of 1, it is allowed to do inplace mutations.</li>
<li>If the host wants to keep a reference to the memory, it must increment the refcount (and decrement it later, maybe freeing data).</li>
<li>otherwise, the host should just ignore the refcount</li>
</ul>
<p>I think that is the rough overview of the semantics from a host perspective.</p>



<a name="264753128"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264753128" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erwin Kuhn <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264753128">(Dec 13 2021 at 18:54)</a>:</h4>
<p>Thanks for all the clarifications <span class="user-mention" data-user-id="343810">@Brendan Hansknecht</span> ! This helps a lot.</p>
<p>Based on this + some digging in the compiler, I think I have enough for a small write-up. You also gave me an idea for an alternative API to Roc strings &amp; lists in Rust. I'll start playing around with those this week!</p>
<p>The result will likely be full of mistakes, but hopefully a good basis for further questions <span aria-label="big smile" class="emoji emoji-1f604" role="img" title="big smile">:big_smile:</span></p>



<a name="264755420"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/264755420" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Brendan Hansknecht <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#264755420">(Dec 13 2021 at 19:12)</a>:</h4>
<blockquote>
<p>The result will likely be full of mistakes, but hopefully a good basis for further questions</p>
</blockquote>
<p>Sounds like a good starting point for most projects.</p>



<a name="271361525"></a>
<h4><a href="https://roc.zulipchat.com#narrow/stream/231634-beginners/topic/Grokking%20platforms/near/271361525" class="zl"><img src="https://roc-lang.github.io/zulip-export/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tankor Smash <a href="https://roc-lang.github.io/zulip-export/stream/231634-beginners/topic/Grokking.20platforms.html#271361525">(Feb 09 2022 at 23:08)</a>:</h4>
<p><span class="user-mention" data-user-id="460799">@Erwin Kuhn</span> did you post the writeup somewhere? it'd be fun to read</p>



<hr><p>Last updated: Nov 01 2025 at 12:13 UTC</p>
</html>